<UserControl xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Emdep.Geos.Modules.Crm.Views"
             xmlns:dxe="http://schemas.devexpress.com/winfx/2008/xaml/editors"
             xmlns:dxb="http://schemas.devexpress.com/winfx/2008/xaml/bars"
             xmlns:dxg="http://schemas.devexpress.com/winfx/2008/xaml/grid" 
             xmlns:dxp="http://schemas.devexpress.com/winfx/2008/xaml/printing"
             xmlns:dxet="http://schemas.devexpress.com/winfx/2008/xaml/editors/themekeys"
             xmlns:ViewModels="clr-namespace:Emdep.Geos.Modules.Crm.ViewModels" 
             xmlns:UIHelper="clr-namespace:Emdep.Geos.UI.Helper;assembly=Emdep.Geos.UI.Helper"
             xmlns:i="clr-namespace:System.Windows.Interactivity;assembly=System.Windows.Interactivity"
             xmlns:dxgt="clr-namespace:DevExpress.Xpf.Grid.Themes;assembly=DevExpress.Xpf.Grid.v19.2"
             xmlns:Interactive="clr-namespace:System.Windows.Interactivity;assembly=System.Windows.Interactivity" 
             xmlns:Behaviors="clr-namespace:Emdep.Geos.UI.Behaviors;assembly=Emdep.Geos.UI.Common"
             xmlns:dxmvvm="http://schemas.devexpress.com/winfx/2008/xaml/mvvm"
             xmlns:sysglb="clr-namespace:System.Globalization;assembly=mscorlib"
             xmlns:dx="http://schemas.devexpress.com/winfx/2008/xaml/core"
             xmlns:dxci="http://schemas.devexpress.com/winfx/2008/xaml/core/internal"    
             xmlns:GeosApplication="clr-namespace:Emdep.Geos.UI.Common;assembly=Emdep.Geos.UI.Common"
             x:Class="Emdep.Geos.Modules.Crm.Views.PlantQuotaView"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             mc:Ignorable="d" 
             d:DesignHeight="300" d:DesignWidth="300" 
             Style="{DynamicResource UserControlStyle}">

    <dxmvvm:Interaction.Behaviors>
        <dxmvvm:SaveFileDialogService Title="Save Excel Report" />
    </dxmvvm:Interaction.Behaviors>

    <UserControl.Resources>
        <Style x:Key="PrintColumnHeaderStyle" TargetType="dxe:TextEdit" BasedOn="{StaticResource {dxgt:TableViewThemeKey ResourceKey=DefaultPrintCellStyle}}">
            <Style.Triggers>
                <DataTrigger Binding="{Binding Column.DataContext.IsVertical}" Value="False">
                    <Setter Property="dxp:ExportSettings.TargetType" Value="Image" />
                    <!--<Setter Property="Height" Value="150" />-->
                    <Setter Property="DisplayTemplate">
                        <Setter.Value>
                            <ControlTemplate>
                                <dxe:TextEdit Name="PART_Editor" HorizontalAlignment="Center" VerticalAlignment="Center" Text="{Binding Column.DataContext.HeaderText}" IsPrintingMode="True">
                                    <!--<dxe:TextEdit.LayoutTransform>
                                        <RotateTransform Angle="270" />
                                    </dxe:TextEdit.LayoutTransform>-->
                                </dxe:TextEdit>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <sys:String x:Key="ShortDateFormat">dd/MM/yyyy</sys:String>
        
        <Style TargetType="dxg:GridColumnHeader">
            <Setter Property="Height" Value="Auto" />
        </Style>

        <Style x:Key="ColumnStyle" TargetType="dxg:GridColumn">
            <Style.Triggers>
                <DataTrigger Binding="{Binding Path=IsVertical}" Value="True">
                    <Setter Property="HeaderTemplate">
                        <Setter.Value>
                            <DataTemplate>
                                <ContentControl Content="{Binding}">
                                    <ContentControl.LayoutTransform>
                                        <RotateTransform Angle="0" />
                                    </ContentControl.LayoutTransform>
                                </ContentControl>
                            </DataTemplate>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="FilterEditorHeaderTemplate">
                        <Setter.Value>
                            <DataTemplate>
                                <ContentControl Content="{Binding}">
                                    <ContentControl.LayoutTransform>
                                        <RotateTransform Angle="0" />
                                    </ContentControl.LayoutTransform>
                                </ContentControl>
                            </DataTemplate>
                        </Setter.Value>
                    </Setter>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <DataTemplate x:Key="DefaultColumnTemplate">
            <ContentControl>
                <dxg:GridColumn FieldName="{Binding ColumnFieldName}" 
                                Header="{Binding HeaderText}"
                                Width="{Binding Width}"
                                Visible="{Binding Visible}"
                                AllowCellMerge="False"
                                AllowBestFit="true" 
                                AllowEditing="False" 
                                AllowAutoFilter="False"
                                ShowInColumnChooser="False" 
                                FilterPopupMode="CheckedList">
                    <dxg:GridColumn.HeaderTemplate>
                        <DataTemplate>
                            <StackPanel VerticalAlignment="Center">
                                <TextBlock Text="{Binding}" HorizontalAlignment="Center" VerticalAlignment="Top" />
                            </StackPanel>
                        </DataTemplate>
                    </dxg:GridColumn.HeaderTemplate>
                </dxg:GridColumn>
            </ContentControl>
        </DataTemplate>

        <DataTemplate x:Key="DateColumnTemplate">
            <ContentControl>
                <dxg:GridColumn FieldName="{Binding ColumnFieldName}" 
                                Header="{Binding HeaderText}"
                                Width="{Binding Width}"
                                Visible="{Binding Visible}"
                                Style="{StaticResource ColumnStyle}" 
                                AllowCellMerge="False"
                                AllowBestFit="true" 
                                AllowEditing="False" 
                                AllowAutoFilter="False"
                                ShowInColumnChooser="False"
                                FilterPopupMode="CheckedList"
                                HorizontalHeaderContentAlignment="Right"
                                EditSettings="{dxe:TextSettings Mask={StaticResource ShortDateFormat}, MaskUseAsDisplayFormat=True, MaskType=DateTime,
                                                 HorizontalContentAlignment=Right}">
                </dxg:GridColumn>
            </ContentControl>
        </DataTemplate>
        
        <DataTemplate x:Key="AmountColumnTemplate">
            <ContentControl>
                <dxg:GridColumn FieldName="{Binding ColumnFieldName}"
                                Header="{Binding HeaderText}"
                                Style="{StaticResource ColumnStyle}" 
                                Width="{Binding  Width}"
                                Visible="{Binding Visible}"
                                AllowBestFit="true" 
                                AllowCellMerge="False"
                                AllowMoving="False"
                                AllowAutoFilter="False"
                                ShowInColumnChooser="False" 
                                HorizontalHeaderContentAlignment="Right" 
                                FilterPopupMode="CheckedList" AllowSorting="True">
                    <dxg:GridColumn.EditSettings>
                        <dxe:TextEditSettings DisplayFormat="c"/>
                    </dxg:GridColumn.EditSettings>
                </dxg:GridColumn>
            </ContentControl>
        </DataTemplate>

        <DataTemplate x:Key="AmountColumnTemplateWithoutSymbol">
            <ContentControl>
                <dxg:GridColumn FieldName="{Binding ColumnFieldName}" 
                                Header="{Binding HeaderText}"
                                Style="{StaticResource ColumnStyle}" 
                                Width="{Binding  Width}"
                                Visible="{Binding Visible}"
                                AllowBestFit="true" 
                                AllowCellMerge="False"
                                AllowMoving="False"
                                AllowAutoFilter="False"
                                ShowInColumnChooser="False" 
                                HorizontalHeaderContentAlignment="Right" 
                                FilterPopupMode="CheckedList" AllowSorting="True">
                    <dxg:GridColumn.EditSettings>
                        <dxe:TextEditSettings HorizontalContentAlignment="Right" MaskType="Numeric" Mask="N2" MaskUseAsDisplayFormat="True"/>
                    </dxg:GridColumn.EditSettings>
                </dxg:GridColumn>
            </ContentControl>
        </DataTemplate>

        <DataTemplate x:Key="AmountColumnTemplateForConvertedAmount">
            <ContentControl>
                <dxg:GridColumn FieldName="{Binding ColumnFieldName}" 
                                Header="{Binding HeaderText}"
                                Style="{StaticResource ColumnStyle}" 
                                Width="{Binding  Width}"
                                Visible="{Binding Visible}"
                                AllowBestFit="true" 
                                AllowCellMerge="False"
                                AllowMoving="False"
                                AllowAutoFilter="False"
                                ShowInColumnChooser="False" 
                                HorizontalHeaderContentAlignment="Right"
                                FilterPopupMode="CheckedList" AllowSorting="True" SortFieldName="{Binding Tag}"><!--SortFieldName="{Binding Tag}"-->
                    <dxg:GridColumn.EditSettings>
                        <dxe:TextEditSettings DisplayFormat="c" HorizontalContentAlignment="Right"/>
                    </dxg:GridColumn.EditSettings>
                </dxg:GridColumn>
            </ContentControl>
        </DataTemplate>

        <DataTemplate x:Key="SummaryTemplate">
            <ContentControl>
                <dxg:GridSummaryItem FieldName="{Binding Path=(dxci:DependencyObjectExtensions.DataContext).FieldName, RelativeSource={RelativeSource Self}}"
                                     SummaryType="{Binding Path=(dxci:DependencyObjectExtensions.DataContext).Type, RelativeSource={RelativeSource Self}}"
                                     DisplayFormat="{Binding Path=(dxci:DependencyObjectExtensions.DataContext).DisplayFormat, RelativeSource={RelativeSource Self}}" />
            </ContentControl>
        </DataTemplate>

        <UIHelper:PlantQuotaColumnTemplateSelector x:Key="newColumnTemplateSelector" 
                                                   template1="{StaticResource DefaultColumnTemplate}" 
                                                   template2="{StaticResource AmountColumnTemplate}" 
                                                   template3="{StaticResource DateColumnTemplate}"
                                                   template4="{StaticResource AmountColumnTemplateWithoutSymbol}"
                                                   template5="{StaticResource AmountColumnTemplateForConvertedAmount}"/>

        <!--<DataTemplate x:Key="BandTemplate">
            <ContentControl>
                <dxg:GridControlBand Header="MAIN BAND">
                    <dxg:GridControlBand.Bands>
                        <dxg:GridControlBand Header="dxg:GridControlBand.Bands.Band1">
                            <dxg:GridControlBand.Bands>
                                <dxg:GridControlBand Header="dxg:GridControlBand.Bands.Band1.1">
                                    <dxg:GridColumn Header="Trademark" />
                                    <dxg:GridColumn Header="Model" />
                                </dxg:GridControlBand>
                                <dxg:GridControlBand Header="dxg:GridControlBand.Bands.Band1.2"
                                        ColumnsSource="{Binding Columns}" >
                                </dxg:GridControlBand>
                            </dxg:GridControlBand.Bands>
                        </dxg:GridControlBand>
                        <dxg:GridControlBand Header="dxg:GridControlBand.Bands.Band2">
                            <dxg:GridColumn Header="Trademark" />
                            <dxg:GridColumn Header="Model" />
                        </dxg:GridControlBand>
                    </dxg:GridControlBand.Bands>
                </dxg:GridControlBand>
            </ContentControl>
        </DataTemplate>-->

        <!--BandsSource="{Binding MainBandForYearsBandsSource}"-->

        <DataTemplate x:Key="SubBandForBusinessUnitsDataTemplate">
            <ContentControl>
                <UIHelper:PlantQuotaGridControlBand Header="{Binding BandHeader}" 
                                                    HorizontalHeaderContentAlignment="Center" 
                                                    ColumnsSource="{Binding Columns}" 
                                                    ColumnTemplateSelector="{StaticResource newColumnTemplateSelector}" />
            </ContentControl>
        </DataTemplate>


        <DataTemplate x:Key="RootBandTemplate">
            <ContentControl>
                <UIHelper:ParentBandItem
                    Header="{Binding Header}"
                    AllowBestFit="True"
                    Visible="True"
                    BandsSource="{Binding Bands}"
                    BandTemplate="{StaticResource SubBandForBusinessUnitsDataTemplate}"
                    HorizontalHeaderContentAlignment="Center"
                    >
                    <!--<dxg:GridControlBand.Bands>
                        <dxg:GridControlBand 
                        Header="dxg:GridControlBand.Bands{Binding Header}"
                        MinWidth="200" AllowBestFit="True"
                        BandCellSeparatorColor="AliceBlue"
                        BandSeparatorWidth="10"
                        Visible="True"
                        HorizontalHeaderContentAlignment="Center" />

                        <dxg:GridControlBand 
                        Header="dxg:GridControlBand.Bands{Binding Header}"
                        MinWidth="200" AllowBestFit="True"
                        BandCellSeparatorColor="AliceBlue"
                        BandSeparatorWidth="10"
                        Visible="True"
                        HorizontalHeaderContentAlignment="Center" />
                        -->
                    <!--BandsSource="{Binding Bands}"
                        BandGeneratorTemplate="{StaticResource SubBandForBusinessUnitsDataTemplate}"/>-->
                    <!--
                    </dxg:GridControlBand.Bands>-->
                </UIHelper:ParentBandItem>
            </ContentControl>
        </DataTemplate>



    </UserControl.Resources>

    <DockPanel LastChildFill="True">
        <Grid DockPanel.Dock="Top" Margin="0,10,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="70*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <TextBlock Text="{DynamicResource CrmMainViewModelPlantQuota}" Grid.Column="0" Style="{DynamicResource TextBlock30Style}" FontWeight="Bold" />

            <!-- Period -->
            <StackPanel Grid.Column="3" Orientation="Horizontal">
                <DockPanel Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Image Style="{DynamicResource CalendarImageStyle}" Width="16" Height="16" Margin="7,0,3,0" />
                    <TextBlock Text="{DynamicResource AnnualSalesPerformanceViewPeriod}" FontWeight="Bold" Margin="5,0,0,0" />
                </DockPanel>

                <TextBlock Text="{Binding Source={x:Static GeosApplication:GeosApplication.Instance}, Path=SelectedyearStarDate, StringFormat=d, ConverterCulture={x:Static sysglb:CultureInfo.CurrentCulture}}" HorizontalAlignment="Left" VerticalAlignment="Center" Grid.Column="2" Margin="3,0,0,0" />
                <TextBlock Text=" - " HorizontalAlignment="Center" VerticalAlignment="Center" Grid.Column="3" FontWeight="Bold" />
                <TextBlock Text="{Binding Source={x:Static GeosApplication:GeosApplication.Instance}, Path=SelectedyearEndDate, StringFormat=d, ConverterCulture={x:Static sysglb:CultureInfo.CurrentCulture}}" HorizontalAlignment="Left" VerticalAlignment="Center" Grid.Column="4" Margin="0 0 5 0" />
            </StackPanel>

            <Button Content=" " Height="40" Width="40" Grid.Column="4" Command="{Binding RefreshPlantQuotaViewCommand}" CommandParameter="{Binding ElementName=PlantsTableView}" HorizontalAlignment="Right" Margin="0,0,5,0">
                <Button.ToolTip>
                    <TextBlock Text="{DynamicResource ButtonRefresh}" />
                </Button.ToolTip>
                <Button.ContentTemplate>
                    <DataTemplate>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Image Style="{ DynamicResource RefreshButtonImageStyle}" Grid.Column="0" Height="24" Width="24" Margin="-10" />
                        </Grid>
                    </DataTemplate>
                </Button.ContentTemplate>
            </Button>

            <Button Content=" " Height="40" Width="40" Margin="0,0,5,0"
                    HorizontalAlignment="Right" 
                    Command="{Binding PrintButtonCommand}" 
                    CommandParameter="{Binding ElementName=PlantsTableView}" Grid.Column="5">
                <Button.ToolTip>
                    <TextBlock Text="{DynamicResource ButtonPrint}" />
                </Button.ToolTip>
                <Button.ContentTemplate>
                    <DataTemplate>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Image Style="{DynamicResource PrinterButtonImageStyle}" Grid.Column="0" Height="24" Width="24" Margin="-10" />
                        </Grid>
                    </DataTemplate>
                </Button.ContentTemplate>
            </Button>

            <Button Content=" " Height="40" Width="40" HorizontalAlignment="Right" Grid.Column="6" Margin="0,0,5,0"
                    Command="{Binding ExportButtonCommand}" CommandParameter="{Binding ElementName=PlantsTableView}">
                <Button.ToolTip>
                    <TextBlock Text="{DynamicResource ButtonExportToExcel}" />
                </Button.ToolTip>
                <Button.ContentTemplate>
                    <DataTemplate>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Image Style="{ DynamicResource ExcelExportButtonImageStyle}" Grid.Column="0" Height="24" Width="24" Margin="-10" />
                        </Grid>
                    </DataTemplate>
                </Button.ContentTemplate>
            </Button>
        </Grid>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="200*" />
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition />
            </Grid.ColumnDefinitions>
            <UIHelper:MyGridControl x:Name="grid" DockPanel.Dock="Top" Grid.Row="2" Height="Auto" 
                             AutoGenerateColumns="None"  
                             ScrollViewer.HorizontalScrollBarVisibility="Visible"
                             ItemsSource="{Binding DtPlantQuota}" 
                             BandsSource="{Binding Bands_FirstLevel_Year}" 
                             BandTemplate="{StaticResource RootBandTemplate}"
                             TotalSummarySource="{Binding TotalSummary}"
                             TotalSummaryGeneratorTemplate="{StaticResource SummaryTemplate}"
                             SelectionMode="Row" ImplyNullLikeEmptyStringWhenFiltering="True">
               
                <!--<UIHelper:MyGridControl.Bands>
                    <dxg:GridControlBand Header="Band1">
                        <dxg:GridColumn FieldName="ID" dxg:BandBase.GridColumn="0"/>
                        <dxg:GridColumn FieldName="Name" dxg:BandBase.GridColumn="1"/>
                    </dxg:GridControlBand>
                </UIHelper:MyGridControl.Bands>-->

                <dxmvvm:Interaction.Behaviors>
                    <UIHelper:GridSelectingBehavior />
                </dxmvvm:Interaction.Behaviors>
                <dxg:GridControl.View>
                    <dxg:TableView x:Name="PlantsTableView" 
                                   NavigationStyle="Row"
                                   ShowTotalSummary="True"
                                   ShowHorizontalLines="True"
                                   AllowPerPixelScrolling="False"
                                   AllowGrouping="False" 
                                   ShowGroupPanel="False" 
                                   ShowColumnHeaders="True"
                                   ShowVerticalLines="True" 
                                   ShowIndicator="False"
                                   AutoWidth="False" 
                                   HorizontalScrollbarVisibility="Auto" 
                                   VerticalScrollbarVisibility="Auto"
                                   HorizontalContentAlignment="Center"
                                   ShowAutoFilterRow="False"
                                   RowMinHeight="20"
                                   AllowSorting="True" 
                                   AllowScrollHeaders="False"
                                   AllowEditing="False"
                                   AllowColumnMoving="True"
                                   AutoMoveRowFocus="False"
                                   AllowScrollAnimation="True"
                                   PrintColumnHeaderStyle="{StaticResource PrintColumnHeaderStyle}"
                                   AllowBestFit="True" AllowResizing="True"
                                   AllowConditionalFormattingMenu="True"
                                   SearchPanelHorizontalAlignment="Stretch"
                                   ColumnChooserColumnDisplayMode="ShowHiddenColumnsOnly">

                        <dxmvvm:Interaction.Behaviors>
                            <dxmvvm:EventToCommand Command="{Binding CommandGridDoubleClick}" EventName="MouseDoubleClick">
                                <dxmvvm:EventToCommand.EventArgsConverter>
                                    <dx:EventArgsToDataRowConverter />
                                </dxmvvm:EventToCommand.EventArgsConverter>
                            </dxmvvm:EventToCommand>
                        </dxmvvm:Interaction.Behaviors>

                        <dxg:TableView.Resources>
                            <DataTemplate x:Key="PageHeader">
                                <Grid Width="{Binding UsablePageWidth}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="50" />
                                        <ColumnDefinition Width="130" />
                                    </Grid.ColumnDefinitions>
                                    <dxe:TextEdit Text=" " Width="{Binding UsablePageWidth}" Grid.ColumnSpan="3" IsPrintingMode="True" Background="#333E5E" HorizontalAlignment="Stretch" 
                                                  VerticalAlignment="Stretch" Padding="12" Foreground="#FFFFFFFF" Style="{DynamicResource TextEdit20Style}" FontWeight="Bold" Height="50" />
                                    <dxe:TextEdit Text="Plant Quota Report" IsPrintingMode="True" HorizontalAlignment="Stretch" 
                                                  VerticalAlignment="Stretch" Padding="12" Foreground="#FFFFFFFF" Style="{DynamicResource TextEdit20Style}" FontWeight="Bold" />
                                    <Image Source="/Emdep.Geos.Modules.Crm;component/Assets/Images/GeosReportLogo.png" Height="50" Width="80" dxp:ExportSettings.TargetType="Image" Grid.Column="2" />
                                </Grid>
                            </DataTemplate>
                            <DataTemplate x:Key="PageFooter">
                                <dxe:TextEdit HorizontalContentAlignment="Center" 
                                               Width="{Binding Path=UsablePageWidth, Mode=OneWay}" 
                                               dxp:ExportSettings.TargetType="PageNumber" 
                                               dxp:PageNumberExportSettings.Kind="NumberOfTotal" 
                                               dxp:PageNumberExportSettings.Format="Page {0} of {1}">
                                </dxe:TextEdit>
                            </DataTemplate>
                        </dxg:TableView.Resources>
                    </dxg:TableView>
                </dxg:GridControl.View>
            </UIHelper:MyGridControl>
        </Grid>
    </DockPanel>
</UserControl>
