using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Data;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Web;
using MySql.Data.MySqlClient;
using DevExpress.Spreadsheet;
using DevExpress.XtraPrinting;
using Prism.Logging;
using Emdep.Geos.Data.Common;
using Emdep.Geos.Data.BusinessLogic.Logging;
using Emdep.Geos.Data.Common.TechnicalRestService;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Transactions;
using System.Drawing;
using System.Net.Mail;
using System.Net;
using System.Text;
using DevExpress.Office.NumberConverters;
using iTextSharp.text;
using DevExpress.Pdf;
using Emdep.Geos.CurrencyConvertApi;
using iTextSharp.text.pdf;
using System.Collections.Concurrent;
using System.Security.Policy;
using Emdep.Geos.Data.Common.ERM;

namespace Emdep.Geos.Data.BusinessLogic
{
    public class TechnicalServiceManager
    {
        string _ConnString;
        string _ConnEmdepGeosString;
        private string username;
        static string loginUsername;
        static string Remarks;
        public string WorkflowStatusFrom;
        public string WorkflowStatusTo;
        public static string login;

        public TechnicalServiceManager(string ConnString, string ConnEmdepGeosString)
        {
            this._ConnString = ConnString;
            this._ConnEmdepGeosString = ConnEmdepGeosString;
            //if (Log4NetLogger.Logger == null)
            //{
            //    string ApplicationLogFilePath = System.Web.Hosting.HostingEnvironment.MapPath("/") + "log4net.config";
            //    FileInfo file = new FileInfo(ApplicationLogFilePath);
            //    Log4NetLogger.Logger = LoggerFactory.CreateLogger(LogType.Log4Net, file);
            //}
        }

        public TechnicalServiceManager(string username)
        {
            this.username = username;
            loginUsername = username;
            login = username;
            //if (Log4NetLogger.Logger == null)
            //{
            //    string ApplicationLogFilePath = System.Web.Hosting.HostingEnvironment.MapPath("/") + "log4net.config";
            //    FileInfo file = new FileInfo(ApplicationLogFilePath);
            //    Log4NetLogger.Logger = LoggerFactory.CreateLogger(LogType.Log4Net, file);
            //}
        }
        public bool ExportTechnicalAssistanceReport(string IdTechnicalAssistanceReport, string Plant, string Lang, string TechnicalAssistanceReportTemplatePath, string TechnicalAssistanceReportPath, string WorkingOrdersPath, string Plantwiseconnectionstring)
        {
            List<Languages> Languages = Getlanguages(_ConnEmdepGeosString);
            FileStream stream = null;
            CultureInfo cultureInfo;
            ErrorMessage errormessage = new ErrorMessage();
            Int64 idSite = IsEMDEPSiteExist(Plant, _ConnString);
            //string siteConnectionString = GetSiteConnectionString(idSite, _ConnString, Plantwiseconnectionstring);
            string siteConnectionString = Plantwiseconnectionstring;
            Languages getLanguage = Languages.Where(l => l.TwoLetterISOLanguage.Equals(Lang.ToLower())).FirstOrDefault();
            bool isDone = false;
            TechnicalServiceReportsExport technicalservicereportsexport = new TechnicalServiceReportsExport();
            string createFolderName = null;
            string imagesToPDFConverter = null;
            bool IsFileGenerated = false;
            bool isTRAssigned = false;
            bool isTARAssigned = false;
            bool isNCRAssigned = false;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method ExportTechnicalAssistanceReport()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(siteConnectionString))
                {
                    conn.Open();
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_TechnicalServiceReportsExport_V680", conn);
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_TechnicalServiceReportsExport_V700", conn);//chitra.girigosavi[24/04/2024]APIGEOS-1128 Add some missing information in the TechnicalService Report
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_TechnicalServiceReportsExport_V720", conn); //chitra.girigosavi [25/06/2024] APIGEOS-1177 Display reference of the ot R not others
                    // MySqlCommand command = new MySqlCommand("GEOSAPI_TechnicalServiceReportsExport_V740", conn); //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_TechnicalServiceReportsExport_V760", conn); //[Rahul.Gadhave][APIGEOS-1228][Date:15-10-2024]
                    MySqlCommand command = new MySqlCommand("GEOSAPI_TechnicalServiceReportsExport_V770", conn); //[Rahul.Gadhave][APIGEOS-1228][Date:15-10-2024]
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_IdTechnicalAssistanceReport", IdTechnicalAssistanceReport);
                    command.Parameters.AddWithValue("_IdSite", idSite);
                    command.Parameters.AddWithValue("_Lang", Lang);
                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        #region dr.Read
                        if (dr.Read())
                        {

                            if (dr["OrderCode"] != DBNull.Value)
                            {
                                technicalservicereportsexport._OrderCode = Convert.ToString(dr["OrderCode"]);
                            }
                            if (dr["IdTechnicalAssistanceReport"] != DBNull.Value)
                            {
                                technicalservicereportsexport._IdTechnicalAssistanceReport = Convert.ToString(dr["IdTechnicalAssistanceReport"]);
                            }
                            if (dr["ReportCode"] != DBNull.Value)
                            {
                                technicalservicereportsexport._ReportCode = Convert.ToString(dr["ReportCode"]);
                            }
                            //if (dr["ReportDate"] != DBNull.Value)
                            //{
                            //    technicalservicereportsexport._ReportDate = Convert.ToString(dr["ReportDate"]);
                            //}

                            if (dr["ReportDate"] != DBNull.Value)   //chitra.girigosavi[24/04/2024]APIGEOS-1128 Add some missing information in the TechnicalService Report
                            {
                                technicalservicereportsexport._ReportDate = DateTime.Now.ToString();
                            }
                            if (dr["TechnicianFullName"] != DBNull.Value)
                            {
                                technicalservicereportsexport._TechnicianFullName = Convert.ToString(dr["TechnicianFullName"]);
                            }
                            if (dr["RequesterFullName"] != DBNull.Value)
                            {
                                technicalservicereportsexport._RequesterFullName = Convert.ToString(dr["RequesterFullName"]);
                            }
                            if (dr["ContactFullName"] != DBNull.Value)
                            {
                                technicalservicereportsexport._ContactFullName = Convert.ToString(dr["ContactFullName"]);
                            }
                            if (dr["ContactPhone"] != DBNull.Value)
                            {
                                technicalservicereportsexport._ContactPhone = Convert.ToString(dr["ContactPhone"]);
                            }
                            if (dr["ContactEmail"] != DBNull.Value)
                            {
                                technicalservicereportsexport._ContactEmail = Convert.ToString(dr["ContactEmail"]);
                            }
                            if (dr["CustomerGroup"] != DBNull.Value)
                            {
                                technicalservicereportsexport._CustomerGroup = Convert.ToString(dr["CustomerGroup"]);
                            }
                            if (dr["CustomerPlant"] != DBNull.Value)
                            {
                                technicalservicereportsexport._CustomerPlant = Convert.ToString(dr["CustomerPlant"]);
                            }
                            if (dr["CustomerCountry"] != DBNull.Value)
                            {
                                technicalservicereportsexport._CustomerCountry = Convert.ToString(dr["CustomerCountry"]);
                            }
                            if (dr["Remarks"] != DBNull.Value)
                            {
                                technicalservicereportsexport._Remarks = Convert.ToString(dr["Remarks"]);
                            }
                            if (dr["OfferYear"] != DBNull.Value)
                            {
                                technicalservicereportsexport._Year = Convert.ToString(dr["OfferYear"]);
                            }
                            #region chitra.girigosavi[24/04/2024]APIGEOS-1128 Add some missing information in the TechnicalService Report
                            if (dr["IdProductSubCategory"] != DBNull.Value)
                            {
                                technicalservicereportsexport._IdProductSubCategory = Convert.ToString(dr["IdProductSubCategory"].ToString());
                            }
                            if (dr["Category"] != DBNull.Value)
                                technicalservicereportsexport.Category1 = dr["Category"].ToString();

                            if (dr["Category"] == DBNull.Value)
                            {
                                technicalservicereportsexport.Category1 = dr["ProductSubCategory"].ToString();
                            }
                            else
                            {
                                technicalservicereportsexport.Category2 = dr["ProductSubCategory"].ToString();
                            }

                            if (dr["CarProjectName"] != DBNull.Value)
                            {
                                technicalservicereportsexport.CarProjectName = Convert.ToString(dr["CarProjectName"].ToString());
                            }
                            if (dr["caroems_Name"] != DBNull.Value)
                            {
                                technicalservicereportsexport.caroems_Name = Convert.ToString(dr["caroems_Name"].ToString());
                            }
                            if (dr["OfferCode"] != DBNull.Value)
                            {
                                technicalservicereportsexport.OfferCode = Convert.ToString(dr["OfferCode"].ToString());
                            }
                            int index = 0;
                            if (dr["Reference"] != DBNull.Value)
                            {
                                string referenceValue = dr["Reference"].ToString();

                                technicalservicereportsexport._ServiceType1 = referenceValue;
                                index++;
                            }

                            while (index < 7 && dr.Read())
                            {
                                if (dr["Reference"] != DBNull.Value)
                                {
                                    string referenceValue = dr["Reference"].ToString();

                                    switch (index)
                                    {
                                        case 1:
                                            technicalservicereportsexport._ServiceType2 = referenceValue;
                                            break;
                                        case 2:
                                            technicalservicereportsexport._ServiceType3 = referenceValue;
                                            break;
                                        case 3:
                                            technicalservicereportsexport._ServiceType4 = referenceValue;
                                            break;
                                        case 4:
                                            technicalservicereportsexport._ServiceType5 = referenceValue;
                                            break;
                                        case 5:
                                            technicalservicereportsexport._ServiceType6 = referenceValue;
                                            break;
                                        case 6:
                                            technicalservicereportsexport._ServiceType7 = referenceValue;
                                            break;
                                    }
                                    index++;
                                }
                            }
                            #endregion
                        }
                        #endregion
                        #region Worklog                    
                        if (dr.NextResult())
                        {
                            technicalservicereportsexport._WorklogItemsLst = new List<ExportWorkLogs>();
                            while (dr.Read())
                            {
                                ExportWorkLogs worklog = new ExportWorkLogs();
                                if (dr["IdTechnicalAssistanceReport"] != null)
                                {
                                    //Orders.Where(i => i.Id == Convert.ToInt64(dr["IdWarehousePurchaseOrder"].ToString())).FirstOrDefault();
                                    if (technicalservicereportsexport != null)
                                    {
                                        if (dr["IdTechnicalAssistanceReport"] != DBNull.Value)
                                        {
                                            worklog.IdTechnicalAssistanceReport = Convert.ToInt32(dr["IdTechnicalAssistanceReport"].ToString());
                                        }
                                        if (dr["WorklogDate"] != DBNull.Value)
                                        {
                                            worklog.WorklogDate = Convert.ToString(dr["WorklogDate"].ToString());
                                        }
                                        if (dr["FullName"] != DBNull.Value)
                                        {
                                            worklog.TechnicianName = Convert.ToString(dr["FullName"].ToString());
                                        }
                                        if (dr["StartTime"] != DBNull.Value)
                                        {
                                            worklog.StartTime = Convert.ToString(dr["StartTime"].ToString());
                                        }
                                        if (dr["EndTime"] != DBNull.Value)
                                        {
                                            worklog.EndTime = Convert.ToString(dr["EndTime"].ToString());
                                        }
                                        //if (dr["TotalTime"] != DBNull.Value)
                                        //{
                                        //    worklog.TotalTime = Convert.ToString(dr["TotalTime"].ToString());
                                        //}
                                        string description = string.Empty;
                                        if (dr["Description_en"] != DBNull.Value) //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                                        {
                                            if (Lang == "en" && dr["Description_en"] != DBNull.Value)
                                            {
                                                description = Convert.ToString(dr["Description_en"].ToString());
                                            }
                                            else if (Lang == "es" && dr["Description_es"] != DBNull.Value)
                                            {
                                                description = Convert.ToString(dr["Description_es"].ToString());
                                            }
                                            else if (Lang == "fr" && dr["Description_fr"] != DBNull.Value)
                                            {
                                                description = Convert.ToString(dr["Description_fr"].ToString());
                                            }
                                            else if (Lang == "pt" && dr["Description_pt"] != DBNull.Value)
                                            {
                                                description = Convert.ToString(dr["Description_pt"].ToString());
                                            }
                                            else if (Lang == "ro" && dr["Description_ro"] != DBNull.Value)
                                            {
                                                description = Convert.ToString(dr["Description_ro"].ToString());
                                            }
                                            else if (Lang == "ru" && dr["Description_ru"] != DBNull.Value)
                                            {
                                                description = Convert.ToString(dr["Description_ru"].ToString());
                                            }
                                            else if (Lang == "zh" && dr["Description_zh"] != DBNull.Value)
                                            {
                                                description = Convert.ToString(dr["Description_zh"].ToString());
                                            }
                                        }
                                        // Assign the description to worklog.Type
                                        worklog.Type = description;
                                        technicalservicereportsexport._WorklogItemsLst.Add(worklog);
                                    }
                                }
                            }
                        }
                        #endregion
                        #region Parts  
                        if (dr.NextResult())
                        {
                            technicalservicereportsexport._PartslogItemsLst = new List<ExportParts>();
                            while (dr.Read())
                            {
                                ExportParts Part = new ExportParts();
                                if (dr["IdTechnicalAssistanceReport"] != null)
                                {
                                    //Orders.Where(i => i.Id == Convert.ToInt64(dr["IdWarehousePurchaseOrder"].ToString())).FirstOrDefault();
                                    if (technicalservicereportsexport != null)
                                    {
                                        if (dr["IdTechnicalAssistanceReport"] != DBNull.Value)
                                        {
                                            Part.IdTechnicalAssistanceReport = Convert.ToInt32(dr["IdTechnicalAssistanceReport"].ToString());
                                        }
                                        if (dr["Reference"] != DBNull.Value)
                                        {
                                            Part.Reference = Convert.ToString(dr["Reference"].ToString());
                                        }
                                        if (dr["Description"] != DBNull.Value)
                                        {
                                            Part.Description = Convert.ToString(dr["Description"].ToString());
                                        }
                                        if (dr["Quantity"] != DBNull.Value)
                                        {
                                            Part.Quantity = Convert.ToInt32(dr["Quantity"].ToString());
                                        }
                                        technicalservicereportsexport._PartslogItemsLst.Add(Part);
                                    }
                                }
                            }
                        }
                        #endregion

                        //chitra.girigosavi APIGEOS-1195 [API_TSM] Changes to the report generation service”TechnicalServiceOrdersReportsExport”
                        #region Photos  
                        if (dr.NextResult())
                        {
                            technicalservicereportsexport._PhotoslogItemsLst = new List<ExportAttachments>();
                            while (dr.Read())
                            {
                                ExportAttachments Photos = new ExportAttachments();
                                if (dr["IdTechnicalAssistanceReport"] != null)
                                {
                                    //Orders.Where(i => i.Id == Convert.ToInt64(dr["IdWarehousePurchaseOrder"].ToString())).FirstOrDefault();
                                    if (technicalservicereportsexport != null)
                                    {
                                        if (dr["IdTechnicalAssistanceReport"] != DBNull.Value)
                                        {
                                            Photos.IdTechnicalAssistanceReport = Convert.ToInt32(dr["IdTechnicalAssistanceReport"].ToString());
                                        }
                                        if (dr["AttachedFiles"] != DBNull.Value)
                                        {
                                            Photos.AttachedFiles = Convert.ToString(dr["AttachedFiles"].ToString());
                                        }
                                        if (dr["Year"] != DBNull.Value)
                                        {
                                            Photos.Year = Convert.ToString(dr["Year"].ToString());
                                        }
                                        if (dr["OfferCode"] != DBNull.Value)
                                        {
                                            Photos.OfferCode = Convert.ToString(dr["OfferCode"].ToString());
                                        }
                                        if (dr["QUE_Code"] != DBNull.Value)
                                        {
                                            Photos.QUE_Code = Convert.ToString(dr["QUE_Code"].ToString());
                                        }
                                        try
                                        {
                                            #region workingOrder
                                            // Get the folder path for the "Additional Information" directory
                                            WorkingOrdersPath = string.Empty;
                                            WorkingOrdersPath = "\\\\{0}FS01\\workingOrders$\\{1}\\{2}\\";
                                            string workingOrder = WorkingOrdersPath
                                                                  .Replace("{0}", Plant)
                                                                  .Replace("{1}", Photos.Year)
                                                                  .Replace("{2}", Photos.QUE_Code)
                                                                  + @"Additional Information\";
                                            //string workingOrder = Path.Combine(WorkingOrdersPath, Plant,Photos.Year.ToString(), Photos.QUE_Code, "Additional Information");
                                            if (Directory.Exists(workingOrder))
                                            {
                                                string[] validExtensions = { ".jpg", ".jpeg", ".png", ".gif", ".bmp" };
                                                var allFiles = Directory.GetFiles(workingOrder);
                                                var imageFiles = new List<string>();
                                                string[] attachedFiles = Photos.AttachedFiles.Split(';');
                                                foreach (var filePath in allFiles)
                                                {
                                                    string fileExtension = Path.GetExtension(filePath).ToLower();
                                                    string fileName = Path.GetFileName(filePath);

                                                    // Check if the file has a valid image extension
                                                    if (validExtensions.Contains(fileExtension))
                                                    {
                                                        if (attachedFiles.Any(a => a.Trim().ToLower().Equals(fileName.Trim().ToLower())))
                                                        {
                                                            imageFiles.Add(filePath); // Valid image file, add to the list
                                                        }
                                                    }
                                                    else
                                                    {
                                                        // Invalid file extension, log an error
                                                        errormessage.code = "735";
                                                        errormessage.info = $"Invalid file extension - {fileName}";
                                                        // You might want to continue processing or break out of the loop depending on your requirements.
                                                    }
                                                }

                                                // Store valid image file names in the ImagePaths list
                                                Photos.ImagePaths.AddRange(imageFiles);
                                            }
                                            else
                                            {
                                                errormessage.code = "734";
                                                errormessage.info = $"Directory not found - {workingOrder}";
                                            }
                                            #endregion
                                        }
                                        catch (Exception ex)
                                        {
                                            Log4NetLogger.Logger.Log(string.Format("Error ExportTechnicalAssistanceReport(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                        }
                                        technicalservicereportsexport._PhotoslogItemsLst.Add(Photos);
                                    }
                                }
                            }
                        }
                        #endregion

                        if (dr.NextResult())
                        {
                            while (dr.Read())
                            {
                                if (dr["IdOTItem"] != null)
                                {

                                    technicalservicereportsexport._IdOTItem = dr["IdOTItem"].ToString();
                                    if (dr["Abbreviation_In_OTI_AttachedFiles"] != DBNull.Value)
                                    {
                                        string abbreviation = dr["Abbreviation_In_OTI_AttachedFiles"].ToString();
                                        if (technicalservicereportsexport.Attachment1 == null)
                                        {
                                            technicalservicereportsexport.Attachment1 = abbreviation;
                                        }
                                        else if (technicalservicereportsexport.Attachment2 == null)
                                        {
                                            technicalservicereportsexport.Attachment2 = abbreviation;
                                        }
                                        else if (technicalservicereportsexport.Attachment3 == null)
                                        {
                                            technicalservicereportsexport.Attachment3 = abbreviation;
                                        }
                                        else if (technicalservicereportsexport.Attachment4 == null)
                                        {
                                            technicalservicereportsexport.Attachment4 = abbreviation;
                                        }
                                    }
                                }
                            }
                        }

                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method ExportTechnicalAssistanceReport()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error ExportTechnicalAssistanceReport(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            Workbook workbook = new Workbook();
            #region CultureInfo
            if (technicalservicereportsexport != null)
            {
                string cultureByPlantOwnerAndISO = GetCultureByPlantOwner(Plant, siteConnectionString);
                string CultureByPlantOwner = string.Empty;
                if (!string.IsNullOrEmpty(cultureByPlantOwnerAndISO))
                {
                    CultureByPlantOwner = Lang.ToLower() + "-" + cultureByPlantOwnerAndISO;
                }
                if (!Lang.ToLower().Equals("en"))
                {
                    if (getLanguage != null)
                    {
                        CultureInfo myCIintl = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName, true);
                        workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName);
                    }
                    else
                    {
                        CultureInfo myCIintl = new CultureInfo("en-GB", true);
                        workbook.Options.Culture = new CultureInfo("en-GB");
                    }
                }
                else
                {
                    #region CultureInfo
                    List<CultureInfo> culture = CultureInfo.GetCultures(CultureTypes.AllCultures).Where<CultureInfo>(c => c.Name.EndsWith(CultureByPlantOwner)).ToList();
                    if (culture != null && culture.Count > 0)
                    {
                        workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(CultureByPlantOwner) ? "en-GB" : CultureByPlantOwner);
                    }
                    else
                    {
                        string plantName = cultureByPlantOwnerAndISO;
                        List<CultureInfo> ifCultureNotexist = CultureInfo.GetCultures(CultureTypes.AllCultures).Where<CultureInfo>(c => c.Name.EndsWith(plantName)).ToList();
                        Languages setCulture = null;
                        if (ifCultureNotexist.Count() == 1)
                        {
                            setCulture = new Emdep.Geos.Data.Common.Languages();
                            setCulture.CultureName = ifCultureNotexist[0].Name;
                        }
                        else
                        {
                            foreach (var item in ifCultureNotexist)
                            {
                                setCulture = Languages.Where(s => s.TwoLetterISOLanguage.Equals(item.Parent.Name)).FirstOrDefault();
                                if (setCulture != null)
                                {
                                    setCulture.CultureName = item.Name;
                                    break;
                                }
                            }
                        }

                        if (setCulture != null)
                        {
                            CultureInfo myCIintl = new CultureInfo(string.IsNullOrEmpty(setCulture.CultureName) ? "en-GB" : setCulture.CultureName, true);
                            if (myCIintl != null)
                            {
                                workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(setCulture.CultureName) ? "en-GB" : setCulture.CultureName);
                            }

                        }
                        else
                        {
                            if (getLanguage != null)
                            {
                                CultureInfo myCIintl = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName, true);
                                workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName);
                            }
                            else
                            {
                                CultureInfo myCIintl = new CultureInfo("en-GB", true);
                                workbook.Options.Culture = new CultureInfo("en-GB");
                            }

                        }

                    }
                    #endregion

                }

            }
            #endregion
            byte[] excelTemplateInByte = ExportTechnicalReport(Convert.ToInt32(IdTechnicalAssistanceReport), TechnicalAssistanceReportTemplatePath);
            if (excelTemplateInByte == null)
            {
                throw new FileNotFoundException("File does not exist or File is open - " + TechnicalAssistanceReportTemplatePath);
            }
            workbook.LoadDocument(excelTemplateInByte, DocumentFormat.Xlsx);
            Worksheet wsDl = workbook.Worksheets[3];
            string filenameExcel = null;
            string filenamePDF = null;
            if (!string.IsNullOrEmpty(technicalservicereportsexport._ReportDate))
            {
                DateTime ReportDate = DateTime.Parse(technicalservicereportsexport._ReportDate, CultureInfo.CurrentCulture);
                string ReportDates = string.Concat(ReportDate.Year, ReportDate.Month.ToString().PadLeft(2, '0'), ReportDate.Day.ToString().PadLeft(2, '0'));
            }
            string updatedExcelFilePath = TechnicalAssistanceReportPath.Replace("{0}", Plant);
            updatedExcelFilePath = updatedExcelFilePath.Replace("{YEAR}", technicalservicereportsexport._Year);
            // updatedExcelFilePath = updatedExcelFilePath.Replace("{PO_Number}", technicalservicereportsexport._ReportCode);
            // updatedExcelFilePath = updatedExcelFilePath + @"\";
            updatedExcelFilePath = updatedExcelFilePath + @"\" + technicalservicereportsexport._ReportCode + @"\";
            if (!System.IO.Directory.Exists(updatedExcelFilePath))
            {
                System.IO.Directory.CreateDirectory(updatedExcelFilePath);
            }
            //string search = "TR_" + technicalservicereportsexport._ReportCode + ".*";
            string search = technicalservicereportsexport._ReportCode + ".*";

            FileInfo[] files = new DirectoryInfo(updatedExcelFilePath + "\\")
            .GetFiles(search)
            .OrderBy(f => f.CreationTime)
            .ToArray();
            var allfiles = files.ToList();
            //filenameExcel = "TR_" + technicalservicereportsexport._ReportCode + ".xlsx";
            //filenamePDF = "TR_" + technicalservicereportsexport._ReportCode + ".pdf";
            filenamePDF = technicalservicereportsexport._ReportCode + ".pdf";
            filenameExcel = technicalservicereportsexport._ReportCode + ".xlsx";


            #region getIndexValue
            Int32 Index_OrderCode = 0;
            Int32 Index_ReportCode = 0;
            Int32 Index_ReportDate = 0;
            Int32 Index_TechnicianFullName = 0;
            Int32 Index_RequesterFullName = 0;
            Int32 Index_ContactFullName = 0;
            Int32 Index_ContactPhone = 0;
            Int32 Index_ContactEmail = 0;
            Int32 Index_CustomerGroup = 0;
            Int32 Index_CustomerPlant = 0;
            Int32 Index_CustomerCountry = 0;
            Int32 Index_Remarks = 0;
            Int32 Index_ServiceType1 = 0;
            Int32 Index_ServiceType2 = 0;
            Int32 Index_ServiceType3 = 0;
            Int32 Index_ServiceType4 = 0;
            Int32 Index_ServiceType5 = 0;
            Int32 Index_ServiceType6 = 0;
            Int32 Index_ServiceType7 = 0;
            Int32 Index_Attachment1 = 0;
            Int32 Index_Attachment2 = 0;
            Int32 Index_Attachment3 = 0;
            Int32 Index_Attachment4 = 0;
            #region chitra.girigosavi[24/04/2024]APIGEOS-1128 Add some missing information in the TechnicalService Report
            Int32 Index_Equipment1 = 0;
            string lblEquipment1 = string.Empty;
            #endregion
            Int32 Language = 0;

            #region Worklog
            Int32 WO_count = 0;
            Int32 Index_Jobs_StartRow = 0;
            string Index_Jobs_DateColumn = string.Empty;
            string Index_Jobs_TechnicianColumn = string.Empty;
            string Index_Jobs_StartColumn = string.Empty;
            string Index_Jobs_EndColumn = string.Empty;
            string Index_Jobs_TotalTimeColumn = string.Empty;    //chitra.girigosavi[19/08/2024][APIGEOS-1195]
            string Index_Jobs_TypeColumn = string.Empty; //chitra.girigosavi[19/08/2024][APIGEOS-1195]
            #endregion

            #endregion

            #region Parts
            Int32 PO_count = 0;
            Int32 Index_Parts_StartRow = 0;
            string Index_Parts_ReferenceColumn = string.Empty;
            string IndexParts_DescriptionColumn = string.Empty;
            string Index_Parts_QuantityColumn = string.Empty;

            #endregion

            #region getWorklogItemsValue  
            Int32 WO_counts = 0;
            Int32 Jobs_StartRow = 0;
            string Jobs_DateColumn = string.Empty;
            string Jobs_TechnicianColumn = string.Empty;
            string Jobs_StartColumn = string.Empty;
            string Jobs_EndColumn = string.Empty;
            string Jobs_TotalTimeColumn = string.Empty;
            string Jobs_TypeColumn = string.Empty; //chitra.girigosavi[19/08/2024][APIGEOS-1195]

            string WoJobs_lblColDate = string.Empty;
            string WoJobs_lblColTechnician = string.Empty;
            string WoJobs_lblColStart = string.Empty;
            string WoJobs_lblColEnd = string.Empty;
            string WoJobs_lblColTotalTime = string.Empty;
            string WoJobs_lblColType = string.Empty; //chitra.girigosavi[19/08/2024][APIGEOS-1195]

            #endregion


            #region getPartsValue
            Int32 PO_counts = 0;
            Int32 Parts_StartRow = 0;
            string Parts_ReferenceColumn = string.Empty;
            string Parts_DescriptionColumn = string.Empty;
            string Parts_QuantityColumn = string.Empty;


            string PaParts_lblColReference = string.Empty;
            string PaParts_lblColDescription = string.Empty;
            string PaParts_lblColQuantity = string.Empty;
            #endregion

            //chitra.girigosavi[19/08/2024][APIGEOS-1195]
            #region Photos
            Int32 Photos_count = 0;
            Int32 Index_Photos_StartRow = 0;
            string Index_Photos_AttachmentsColumn = string.Empty;
            #endregion

            #region getPhotosItemsValue  
            Int32 Photos_counts = 0;
            Int32 Photos_StartRow = 0;
            string Photos_AttachmentsColumn = string.Empty;

            #endregion

            Worksheet wsTranslations = workbook.Worksheets[4];
            #region getIndex
            for (int s = 0; s < 400; s++)
            {
                #region Worklog
                if ((wsTranslations.Cells[s, 0].Value.ToString() == "Jobs_lblColDate_" + Lang.ToLower()))
                {
                    WoJobs_lblColDate = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Jobs_lblColTechnician_" + Lang.ToLower()))
                {
                    WoJobs_lblColTechnician = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Jobs_lblColStart_" + Lang.ToLower()))
                {
                    WoJobs_lblColStart = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Jobs_lblColEnd_" + Lang.ToLower()))
                {
                    WoJobs_lblColEnd = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Jobs_lblColTotalTime_" + Lang.ToLower())) //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                {
                    WoJobs_lblColTotalTime = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Jobs_lblColType_" + Lang.ToLower())) //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                {
                    WoJobs_lblColType = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                #endregion

                #region Parts
                if ((wsTranslations.Cells[s, 0].Value.ToString() == "Parts_lblColReference_" + Lang.ToLower()))
                {
                    PaParts_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Parts_lblColDescription_" + Lang.ToLower()))
                {
                    PaParts_lblColDescription = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Parts_lblColQuantity_" + Lang.ToLower()))
                {
                    PaParts_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                #endregion

                #endregion
            #region getIndex Using switch                           
                switch (wsDl.Cells[s, 0].Value.ToString())
                {
                    case "Index_OrderCode":
                        Index_OrderCode = s;
                        break;
                    case "Index_ReportCode":
                        Index_ReportCode = s;
                        break;
                    case "Index_ReportDate":
                        Index_ReportDate = s;
                        break;
                    case "Index_TechnicianFullName":
                        Index_TechnicianFullName = s;
                        break;
                    case "Index_RequesterFullName":
                        Index_RequesterFullName = s;
                        break;
                    case "Index_ContactFullName":
                        Index_ContactFullName = s;
                        break;
                    case "Index_ContactPhone":
                        Index_ContactPhone = s;
                        break;
                    case "Index_ContactEmail":
                        Index_ContactEmail = s;
                        break;
                    case "Index_CustomerGroup":
                        Index_CustomerGroup = s;
                        break;
                    case "Index_CustomerPlant":
                        Index_CustomerPlant = s;
                        break;
                    case "Index_CustomerCountry":
                        Index_CustomerCountry = s;
                        break;
                    case "Index_ServiceType1":
                        Index_ServiceType1 = s;
                        break;
                    case "Index_ServiceType2":
                        Index_ServiceType2 = s;
                        break;
                    case "Index_ServiceType3":
                        Index_ServiceType3 = s;
                        break;
                    case "Index_ServiceType4":
                        Index_ServiceType4 = s;
                        break;
                    case "Index_ServiceType5":
                        Index_ServiceType5 = s;
                        break;
                    case "Index_ServiceType6":
                        Index_ServiceType6 = s;
                        break;
                    case "Index_ServiceType7":
                        Index_ServiceType7 = s;
                        break;
                    case "Index_Attachment1":
                        Index_Attachment1 = s;
                        break;
                    case "Index_Attachment2":
                        Index_Attachment2 = s;
                        break;
                    case "Index_Attachment3":
                        Index_Attachment3 = s;
                        break;
                    case "Index_Attachment4":
                        Index_Attachment4 = s;
                        break;

                    #region Worklogs
                    case "Index_Jobs_StartRow":
                        WO_counts = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        Index_Jobs_StartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        break;

                    case "Index_Jobs_DateColumn":
                        Index_Jobs_DateColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Index_Jobs_TechnicianColumn":
                        Index_Jobs_TechnicianColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Index_Jobs_StartColumn":
                        Index_Jobs_StartColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Index_Jobs_EndColumn":
                        Index_Jobs_EndColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Index_Jobs_TotalTimeColumn":    //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                        Index_Jobs_TotalTimeColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;

                    case "Index_Jobs_TypeColumn":   //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                        Index_Jobs_TypeColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    #endregion

                    #region Parts
                    case "Index_Parts_StartRow":
                        PO_counts = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        Index_Parts_StartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        break;

                    case "Index_Parts_ReferenceColumn":
                        Index_Parts_ReferenceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "IndexParts_DescriptionColumn":
                        IndexParts_DescriptionColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Index_Parts_QuantityColumn":
                        Index_Parts_QuantityColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;

                    #region chitra.girigosavi[24/04/2024]APIGEOS-1128 Add some missing information in the TechnicalService Report
                    case "Index_Equipment1":
                        Index_Equipment1 = s;
                        break;
                    #endregion
                    #endregion


                    case "Language":
                        Language = s;
                        break;
                    case "Index_Remarks":
                        Index_Remarks = s;
                        break;
                    default:
                        break;

                    #region Worklog_Item  
                    case "Jobs_StartRow":                                                       //[001][kshinde][APIGEOS-586][16/08/2022] 
                        WO_counts = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        Jobs_StartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Jobs_DateColumn":
                        Jobs_DateColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Jobs_TechnicianColumn":
                        Jobs_TechnicianColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Jobs_StartColumn":
                        Jobs_StartColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Jobs_EndColumn":
                        Jobs_EndColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Jobs_TotalTimeColumn":
                        Jobs_TotalTimeColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;

                    case "Jobs_TypeColumn": //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                        Jobs_TypeColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    #endregion

                    #region Parts_Item  
                    case "Parts_StartRow":                                                       //[001][kshinde][APIGEOS-586][16/08/2022] 
                        PO_counts = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        Parts_StartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Parts_ReferenceColumn":
                        Parts_ReferenceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Parts_DescriptionColumn":
                        Parts_DescriptionColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Parts_QuantityColumn":
                        Parts_QuantityColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    #endregion
                    #region Photos
                    case "Photos_StartRow":                                                       //[001][kshinde][APIGEOS-586][16/08/2022] 
                        Photos_counts = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        Photos_StartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Photos_AttachmentsColumn":
                        Photos_AttachmentsColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                        #endregion
                }
                #endregion

            }


            using (stream = new FileStream(Path.Combine(updatedExcelFilePath, filenameExcel), FileMode.Create, FileAccess.ReadWrite))
            {
                cultureInfo = new CultureInfo(workbook.Options.Culture.Name);
                #region Set CultureInfo ReportDate
                if (!String.IsNullOrEmpty(technicalservicereportsexport._ReportDate))
                {
                    DateTime dt = DateTime.Parse(technicalservicereportsexport._ReportDate, CultureInfo.CurrentCulture);
                    wsDl.Cells[Index_ReportDate, 1].Value = dt.ToString(cultureInfo.DateTimeFormat.ShortDatePattern, cultureInfo);
                }
                else
                {
                    wsDl.Cells[Index_ReportDate, 1].Value = technicalservicereportsexport._ReportDate;
                }
                #endregion


                #region Set CultureInfo ReportDate
                if (!String.IsNullOrEmpty(technicalservicereportsexport._ReportDate))
                {
                    DateTime dt = DateTime.Parse(technicalservicereportsexport._ReportDate, CultureInfo.CurrentCulture);
                    DateTime dateOnly = dt.Date;
                    wsDl.Cells[Index_ReportDate, 1].Value = dateOnly.ToString(cultureInfo.DateTimeFormat.ShortDatePattern, cultureInfo);
                }
                else
                {
                    wsDl.Cells[Index_ReportDate, 1].Value = technicalservicereportsexport._ReportDate;
                }
                #endregion
                wsDl.Cells[Index_OrderCode, 1].Value = technicalservicereportsexport._OrderCode;
                wsDl.Cells[Index_ReportCode, 1].Value = technicalservicereportsexport._ReportCode;
                wsDl.Cells[Index_TechnicianFullName, 1].Value = technicalservicereportsexport._TechnicianFullName;
                wsDl.Cells[Index_RequesterFullName, 1].Value = technicalservicereportsexport._RequesterFullName;
                wsDl.Cells[Index_ContactFullName, 1].Value = technicalservicereportsexport._ContactFullName;
                wsDl.Cells[Index_ContactPhone, 1].Value = technicalservicereportsexport._ContactPhone;
                wsDl.Cells[Index_ContactEmail, 1].Value = technicalservicereportsexport._ContactEmail;
                wsDl.Cells[Index_CustomerGroup, 1].Value = technicalservicereportsexport._CustomerGroup;
                wsDl.Cells[Index_CustomerPlant, 1].Value = technicalservicereportsexport._CustomerPlant;
                wsDl.Cells[Index_CustomerCountry, 1].Value = technicalservicereportsexport._CustomerCountry;
                wsDl.Cells[Index_Remarks, 1].Value = technicalservicereportsexport._Remarks;
                wsDl.Cells[Index_ServiceType1, 1].Value = technicalservicereportsexport._ServiceType1;
                wsDl.Cells[Index_ServiceType2, 1].Value = technicalservicereportsexport._ServiceType2;
                wsDl.Cells[Index_ServiceType3, 1].Value = technicalservicereportsexport._ServiceType3;

                wsDl.Cells[Index_ServiceType4, 1].Value = technicalservicereportsexport._ServiceType4;
                wsDl.Cells[Index_ServiceType5, 1].Value = technicalservicereportsexport._ServiceType5;
                wsDl.Cells[Index_ServiceType6, 1].Value = technicalservicereportsexport._ServiceType6;
                wsDl.Cells[Index_ServiceType7, 1].Value = technicalservicereportsexport._ServiceType7;
                wsDl.Cells[Index_Attachment1, 1].Value = technicalservicereportsexport.Attachment1;
                wsDl.Cells[Index_Attachment2, 1].Value = technicalservicereportsexport.Attachment2;
                wsDl.Cells[Index_Attachment3, 1].Value = technicalservicereportsexport.Attachment3;
                wsDl.Cells[Index_Attachment4, 1].Value = technicalservicereportsexport.Attachment4;

                #region chitra.girigosavi[24/04/2024]APIGEOS-1128 Add some missing information in the TechnicalService Report
                //wsDl.Cells[Index_Equipment1, 1].Value = technicalservicereportsexport.CarProjectName + "-" + technicalservicereportsexport.caroems_Name + ";" +
                //                    technicalservicereportsexport.OfferCode + ";" + technicalservicereportsexport.Category1 + "-" + technicalservicereportsexport.Category2 + ";";

                string carInfo = string.IsNullOrWhiteSpace(technicalservicereportsexport.CarProjectName) ?
                 "" :
                 technicalservicereportsexport.CarProjectName + "-" + technicalservicereportsexport.caroems_Name;

                string categoryInfo = string.IsNullOrWhiteSpace(technicalservicereportsexport._IdProductSubCategory) ?
                                      "" :
                                      technicalservicereportsexport.Category1 + "-" + technicalservicereportsexport.Category2;

                string valueToSet = carInfo + ";" + technicalservicereportsexport.OfferCode + ";" + categoryInfo + ";";

                wsDl.Cells[Index_Equipment1, 1].Value = valueToSet;
                #endregion

                wsDl.Cells[Language, 1].Value = Lang.ToLower();
                // workbook.Worksheets[2].Visible = false;
                #region ExportExpensesListItems       
                if (technicalservicereportsexport._WorklogItemsLst != null && technicalservicereportsexport._WorklogItemsLst.Count > 0)
                {
                    Int32 Expenses_ItemsHeadingStartRow = Convert.ToInt32(WO_counts) - 1;
                    // Index_Jobs_StartRow = Convert.ToString(WO_counts) - 1;
                    Worksheet wsDlExpensesItems = workbook.Worksheets[1];
                    wsDlExpensesItems.Cells[Jobs_DateColumn + (Jobs_StartRow - 1)].Value = WoJobs_lblColDate;
                    wsDlExpensesItems.Cells[Jobs_TechnicianColumn + (Jobs_StartRow - 1)].Value = WoJobs_lblColTechnician;
                    wsDlExpensesItems.Cells[Jobs_StartColumn + (Jobs_StartRow - 1)].Value = WoJobs_lblColStart;
                    wsDlExpensesItems.Cells[Jobs_EndColumn + (Jobs_StartRow - 1)].Value = WoJobs_lblColEnd;
                    wsDlExpensesItems.Cells[Jobs_TotalTimeColumn + (Jobs_StartRow - 1)].Value = WoJobs_lblColTotalTime;
                    wsDlExpensesItems.Cells[Jobs_TypeColumn + (Jobs_StartRow - 1)].Value = WoJobs_lblColType; //chitra.girigosavi[19/08/2024][APIGEOS-1195]


                    if (technicalservicereportsexport._WorklogItemsLst.Count > 1)
                        wsDlExpensesItems.Rows.Insert(Expenses_ItemsHeadingStartRow + 1, technicalservicereportsexport._WorklogItemsLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                    if (technicalservicereportsexport._WorklogItemsLst != null)
                        foreach (ExportWorkLogs item in technicalservicereportsexport._WorklogItemsLst)
                        {
                            if (item != null)
                            {
                                wsDlExpensesItems.Cells[Jobs_DateColumn + Jobs_StartRow].Value = item.WorklogDate;
                                wsDlExpensesItems.Cells[Jobs_TechnicianColumn + Jobs_StartRow].Value = item.TechnicianName;
                                wsDlExpensesItems.Cells[Jobs_StartColumn + Jobs_StartRow].Value = item.StartTime;
                                wsDlExpensesItems.Cells[Jobs_EndColumn + Jobs_StartRow].Value = item.EndTime;
                                wsDlExpensesItems.Cells[Jobs_TypeColumn + Jobs_StartRow].Value = item.Type; //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                            }
                            Jobs_StartRow = Jobs_StartRow + 1;
                        }
                    wsDlExpensesItems.Cells[Jobs_DateColumn + Jobs_StartRow].Value = null;
                    wsDlExpensesItems.Cells[Jobs_TechnicianColumn + Jobs_StartRow].Value = null;
                    wsDlExpensesItems.Cells[Jobs_StartColumn + Jobs_StartRow].Value = null;
                    wsDlExpensesItems.Cells[Jobs_EndColumn + Jobs_StartRow].Value = null;
                    wsDlExpensesItems.Cells[Jobs_TypeColumn + Jobs_StartRow].Value = null; //chitra.girigosavi[19/08/2024][APIGEOS-1195]

                }
                else
                {
                    workbook.Worksheets[1].Visible = false;
                }
                // Added parts
                if (technicalservicereportsexport._PartslogItemsLst != null && technicalservicereportsexport._PartslogItemsLst.Count > 0)
                {
                    Int32 Expenses_ItemsHeadingStartRow = Convert.ToInt32(PO_counts) - 1;
                    // Index_Jobs_StartRow = Convert.ToString(WO_counts) - 1;
                    Worksheet wsDlExpensesItems = workbook.Worksheets[2];
                    wsDlExpensesItems.Cells[Parts_ReferenceColumn + (Parts_StartRow - 1)].Value = PaParts_lblColReference;
                    wsDlExpensesItems.Cells[Parts_DescriptionColumn + (Parts_StartRow - 1)].Value = PaParts_lblColDescription;
                    wsDlExpensesItems.Cells[Parts_QuantityColumn + (Parts_StartRow - 1)].Value = PaParts_lblColQuantity;

                    if (technicalservicereportsexport._PartslogItemsLst.Count > 1)
                        wsDlExpensesItems.Rows.Insert(Expenses_ItemsHeadingStartRow + 1, technicalservicereportsexport._PartslogItemsLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                    if (technicalservicereportsexport._PartslogItemsLst != null)
                        foreach (ExportParts item in technicalservicereportsexport._PartslogItemsLst)
                        {
                            if (item != null)
                            {
                                wsDlExpensesItems.Cells[Parts_ReferenceColumn + Parts_StartRow].Value = item.Reference;
                                wsDlExpensesItems.Cells[Parts_DescriptionColumn + Parts_StartRow].Value = item.Description;
                                wsDlExpensesItems.Cells[Parts_QuantityColumn + Parts_StartRow].Value = item.Quantity;
                            }
                            Parts_StartRow = Parts_StartRow + 1;
                        }
                    wsDlExpensesItems.Cells[Parts_ReferenceColumn + Parts_StartRow].Value = null;
                    wsDlExpensesItems.Cells[Parts_DescriptionColumn + Parts_StartRow].Value = null;
                    wsDlExpensesItems.Cells[Parts_QuantityColumn + Parts_StartRow].Value = null;

                }
                else
                {
                    workbook.Worksheets[2].Visible = false;
                }
                //End
                #region
                bool iSPhotos = false;
                try
                {
                    #region Photos
                    // Added Photos
                    if (technicalservicereportsexport._PhotoslogItemsLst != null && technicalservicereportsexport._PhotoslogItemsLst.Count > 0)                                                        //[001][kshinde][APIGEOS-586][16/08/2022]
                    {
                        Int32 Expenses_ItemsHeadingStartRow = Convert.ToInt32(Photos_counts) - 1;
                        //Index_Jobs_StartRow = Convert.ToString(WO_counts) - 1;
                        Worksheet wsDlExpensesItems = workbook.Worksheets[5];
                        createFolderName = System.IO.Path.GetTempPath() + @"\TechnicalAssistanceReport\";
                        imagesToPDFConverter = IdTechnicalAssistanceReport + "_" + technicalservicereportsexport._ReportCode + ".pdf";
                        IsFileGenerated = false;
                        try
                        {
                            if (!System.IO.Directory.Exists(createFolderName))
                            {
                                System.IO.Directory.CreateDirectory(createFolderName);
                            }
                        }
                        catch (Exception) { }
                        List<string> ImagePaths = new List<string>();
                        if (technicalservicereportsexport._PhotoslogItemsLst.Count > 1)
                            wsDlExpensesItems.Rows.Insert(Expenses_ItemsHeadingStartRow + 1, technicalservicereportsexport._PhotoslogItemsLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                        if (technicalservicereportsexport._PhotoslogItemsLst != null)
                            foreach (ExportAttachments item in technicalservicereportsexport._PhotoslogItemsLst)
                            {
                                if (item.ImagePaths != null)
                                {
                                    //foreach (string imagePath in item.ImagePaths)
                                    //{
                                    //    ImagePaths.Add(imagePath);
                                    //}
                                    #region item.ImagePaths
                                    foreach (string imagePath in item.ImagePaths)
                                    {
                                        try
                                        {
                                            // Load the image from a file path
                                            System.Drawing.Image img = System.Drawing.Image.FromFile(imagePath);

                                            // Load the image from file
                                            using (FileStream fs = new FileStream(imagePath, FileMode.Open, FileAccess.Read))
                                            {
                                                System.Drawing.Image image = System.Drawing.Image.FromStream(fs);

                                                // Add the picture to the specified cell
                                                //var picture = wsDlExpensesItems.Pictures.AddPicture(image, wsDlExpensesItems.Cells[Photos_AttachmentsColumn + Photos_StartRow]);
                                                //// Set the picture's position and size
                                                //picture.TopLeftCell = wsDlExpensesItems.Cells[Photos_AttachmentsColumn + Photos_StartRow];
                                                //picture.BottomRightCell = wsDlExpensesItems.Cells[Photos_AttachmentsColumn + Photos_StartRow]; // Adjust as needed
                                                var picture = wsDlExpensesItems.Pictures.AddPicture(image, wsDlExpensesItems.Cells[Photos_AttachmentsColumn + Photos_StartRow]);

                                                // Set the picture's position and size with margins
                                                int marginTop = 15;    // Set your desired top margin
                                                int marginBottom = 15; // Set your desired bottom margin
                                                int marginLeft = 15;      // Set your desired left margin
                                                int marginRight = 15;     // Set your desired right margin

                                                // Set the top-left and bottom-right cells for the image
                                                picture.TopLeftCell = wsDlExpensesItems.Cells[Photos_AttachmentsColumn + Photos_StartRow];
                                                picture.Top = picture.Top + marginTop;  // Add top margin

                                                // Adjust the left margin
                                                picture.Left = picture.Left + marginLeft;

                                                // Set the bottom-right cell and adjust bottom margin
                                                picture.BottomRightCell = wsDlExpensesItems.Cells[Photos_AttachmentsColumn + Photos_StartRow];
                                                picture.Height = picture.Height - marginBottom; // Adjust bottom margin
                                                // Optionally, you can adjust the width or horizontal margins if needed.
                                                // Adjust the width for the right margin
                                                picture.Width = picture.Width - marginRight;
                                            }
                                        }
                                        catch (Exception ex)
                                        {

                                        }
                                        // Move to the next row for the next image
                                        Photos_StartRow += 1;
                                        iSPhotos = true;
                                    }
                                    #endregion
                                }
                            }
                    }
                    else
                    {
                        workbook.Worksheets[5].Visible = false;
                    }
                    //End
                    #endregion
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                }
                #endregion
                #endregion
                if (iSPhotos == false)
                {
                    workbook.Worksheets[5].Visible = false;
                }
                workbook.Worksheets[3].Visible = false;
                workbook.Worksheets[4].Visible = false;
                workbook.SaveDocument(stream, DocumentFormat.Xlsx);
                isDone = true;
            }
            string originalPdfFilePath = Path.Combine(updatedExcelFilePath, filenamePDF);
            PdfExportOptions pdfOptions = new PdfExportOptions
            {
                // DocumentOptions = { Title = "Exported Excel to PDF" },
                ConvertImagesToJpeg = true
            };
            try
            {
                workbook = new Workbook();
                string searchPattern = "*.xlsx";
                string fileNameToMatch = technicalservicereportsexport._ReportCode;
                // Get all files matching the search pattern in the folder and its subfolders
                string[] GetFiles = Directory.GetFiles(updatedExcelFilePath, searchPattern, SearchOption.AllDirectories);
                // Get all files matching the search pattern in the folder
                //string[] GetFiles = Directory.GetFiles(updatedExcelFilePath, searchPattern);
                string[] matchingFiles = GetFiles.Where(file => Path.GetFileNameWithoutExtension(file).Equals(fileNameToMatch, StringComparison.OrdinalIgnoreCase)).ToArray();
                workbook.LoadDocument(matchingFiles.FirstOrDefault());
                workbook.ExportToPdf(originalPdfFilePath, pdfOptions);

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
            }
            workbook.Dispose();
            if (stream != null)
            {
                stream.Dispose();
            }
            return isDone;
        }

        //[Rdixit][APIGEOS-484][26-04-2022]
        public List<Languages> Getlanguages(string connstr)
        {
            List<Languages> languagelst = new List<Languages>();
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method Getlanguages()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetLanguages", conn);
                    command.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            Languages Language = new Languages();
                            if (dr["IdLanguage"] != DBNull.Value)
                            {
                                Language.IdLanguage = Convert.ToInt32(dr["IdLanguage"].ToString());
                            }
                            if (dr["TwoLetterISOLanguage"] != DBNull.Value)
                            {
                                Language.TwoLetterISOLanguage = Convert.ToString(dr["TwoLetterISOLanguage"].ToString());
                            }
                            if (dr["Name"] != DBNull.Value)
                            {
                                Language.Name = Convert.ToString(dr["Name"].ToString());
                            }
                            if (dr["CultureName"] != DBNull.Value)
                            {
                                Language.CultureName = Convert.ToString(dr["CultureName"].ToString());
                            }
                            languagelst.Add(Language);
                        }

                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method Getlanguages()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error Getlanguages(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return languagelst;
        }

        public Int64 IsEMDEPSiteExist(string Site, string connstr)
        {
            Int64 idSite = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsEMDEPSiteExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsEMDEPSiteExist", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_ShortName", Site);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdSite"] != DBNull.Value)
                            {
                                idSite = Convert.ToInt64(dr["IdSite"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsEMDEPSiteExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsEMDEPSiteExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idSite;
        }

        public string GetSiteConnectionString(Int64 idSite, string connstr, string Plantwiseconnectionstring)
        {
            string connectionString = null;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetSiteConnectionString()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetEMDEPSiteDetail", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_idSite", idSite);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["DatabaseIP"] != DBNull.Value)
                            {
                                //connectionString = "Data Source = " + dr["DatabaseIP"].ToString() + "; Database = geos; User ID = GeosUsr; Password = GEOS;Convert Zero Datetime=True";
                                // connectionString= Plantwiseconnectionstring.Replace("{0}", dr["DatabaseIP"].ToString() );

                                connectionString = string.Format(Plantwiseconnectionstring, dr["DatabaseIP"].ToString());
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetSiteConnectionString()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetSiteConnectionString(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            return connectionString;
        }
        public string GetSiteConnectionStringOld(Int64 idSite, string connstr, string Plantwiseconnectionstring)
        {
            string connectionString = null;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetSiteConnectionString()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetEMDEPSiteDetail", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_idSite", idSite);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["DatabaseIP"] != DBNull.Value)
                            {
                                connectionString = string.Format(Plantwiseconnectionstring, dr["DatabaseIP"].ToString());
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetSiteConnectionString()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetSiteConnectionString(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return connectionString;
        }

        public byte[] ExportTechnicalReport(Int32 IdTechnicalAssistanceReport, string offerExcelPath)
        {
            byte[] bytes = null;
            string defaultFileName = @"\TAR.xlsx";

            string companyFileName = string.Format("{0}{1}{2}{3}", @"\", IdTechnicalAssistanceReport, "_", "TAR.xlsx");

            try
            {
                if (File.Exists(string.Format("{0}{1}", offerExcelPath, companyFileName)))
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(string.Format("{0}{1}", offerExcelPath, companyFileName), System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;

                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }
                }
                else if (File.Exists(string.Format("{0}{1}", offerExcelPath, defaultFileName)))
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(string.Format("{0}{1}", offerExcelPath, defaultFileName), System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;

                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }
                }


            }
            catch (FileNotFoundException ex)
            {

            }
            catch (DirectoryNotFoundException ex)
            {

            }
            catch (Exception ex)
            {

            }
            return bytes;
        }

        public string GetCultureByPlantOwner(string _ShortName, string connstr)
        {
            string Culture = string.Empty;
            List<Languages> languagelst = new List<Languages>();
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetCultureByPlantOwner()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetCultureByPlantOwner", conn);
                    command.Parameters.AddWithValue("_ShortName", _ShortName);
                    command.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {

                            if (dr["Language"] != DBNull.Value)
                            {
                                Culture = Convert.ToString(dr["Language"].ToString());
                            }

                        }

                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetCultureByPlantOwner()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error Getlanguages(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return Culture;
        }

        //Rahul[rgadhave] APIGEOS-1049 Add a new service TechnicalService->Orders->Reports->Sign to let add signatures into the report
        public bool TechnicalServiceOrderReportsSign(CreateExpenseReportsSign createExpenseReportsSign, string mainserverConnectionString, string LoginContext, string Plantwiseconnectionstring, string IdTechnicalAssistanceReport, string expensesFilePath, string Signatory, String PlantOwner)
        {

            OrderManager OrderManager = new OrderManager(mainserverConnectionString, LoginContext);
            bool result = false;
            string companyAlias = string.Empty;
            string code = string.Empty;
            string currentYear = string.Empty;
            //string parentAlias = string.Empty;
            Int64 idSite = OrderManager.IsEMDEPSiteExist(PlantOwner, mainserverConnectionString);
            string siteConnectionstring = OrderManager.GetSiteConnectionString(idSite, mainserverConnectionString, Plantwiseconnectionstring);
            Int64 IdEmployeeExpenseReport = Convert.ToInt64(IdTechnicalAssistanceReport);
            //    ExportExpenses exportExpenses = new ExportExpenses();
            TechnicalServiceReportsExport technicalservicereportsexport = new TechnicalServiceReportsExport();
            try
            {
                using (MySqlConnection conn = new MySqlConnection(siteConnectionstring))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_TechnicalServiceReportsExportSign_V680", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_IdTechnicalAssistanceReport", IdTechnicalAssistanceReport);
                    command.Parameters.AddWithValue("_idSite", idSite);
                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            #region Get data from MySql
                            if (dr["ReportCode"] != DBNull.Value)
                            {
                                code = Convert.ToString(dr["ReportCode"]).ToString();
                            }
                            if (dr["Year"] != DBNull.Value)
                            {
                                currentYear = Convert.ToString(dr["Year"]).ToString();
                            }
                            if (dr["CreationDate"] != DBNull.Value)
                            {
                                technicalservicereportsexport._ReportDate = Convert.ToString(dr["CreationDate"]).ToString();
                            }
                            companyAlias = PlantOwner;
                            #endregion
                        }
                    }
                }
                if (companyAlias != string.Empty)
                {

                    string receiptsPDF = null;
                    string containstr = "";
                    string MaxRevFileName = "";
                    string expensesFromDate = null;
                    string expensesToDate = null;
                    DateTime fromDate = Convert.ToDateTime(DateTime.Now);
                    DateTime toDate = Convert.ToDateTime(DateTime.Now);
                    if (!string.IsNullOrEmpty(technicalservicereportsexport._ReportDate))
                    {
                        fromDate = DateTime.Parse(technicalservicereportsexport._ReportDate);
                    }
                    expensesFromDate = string.Concat(fromDate.Year, fromDate.Month.ToString().PadLeft(2, '0'), fromDate.Day.ToString().PadLeft(2, '0'));
                    string updatedExcelFilePath = expensesFilePath.Replace("{0}", companyAlias);
                    //  updatedExcelFilePath = updatedExcelFilePath.Replace("{PO_Number}", technicalservicereportsexport._ReportCode);

                    updatedExcelFilePath = updatedExcelFilePath.Replace("{YEAR}", technicalservicereportsexport._Year);
                    updatedExcelFilePath = updatedExcelFilePath + @"\" + code + @"\";
                    //   updatedExcelFilePath = updatedExcelFilePath + @"\";

                    if (!System.IO.Directory.Exists(updatedExcelFilePath))
                    {
                        System.IO.Directory.CreateDirectory(updatedExcelFilePath);
                    }
                    #region ReceiptsFile
                    //string search = @"TR_" + code + '*' + ".pdf";
                    string search = code + '*' + ".pdf"; //chitra.girigosavi [APIGEOS-1176][11/07/2024]
                    FileInfo[] files = new DirectoryInfo(updatedExcelFilePath)
                    .GetFiles(search)
                    .ToArray();
                    List<string> finalpdflist = new List<string>();//[plahange][30-11-22][APIGEOS-615]
                    var allfiles = files.ToList();

                    if (allfiles.Count() > 0)
                    {
                        allfiles.RemoveAll(r => r.Name.Contains("Receipts"));
                        #region getAllFiles
                        List<string> revPDFList = new List<string>();
                        foreach (var itemPDF in allfiles)
                        {
                            string substringitem = itemPDF.ToString().Split('\\').Last();
                            revPDFList.Add(substringitem);
                        }

                        if (revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault() == null)
                        {
                            containstr = code + ".pdf";
                        }
                        else
                        {
                            List<string> maxNumberList = new List<string>();
                            foreach (var maxNumberitem in revPDFList)
                            {
                                int indexofrev = maxNumberitem.IndexOf("rev");
                                string substring = "00";
                                if (indexofrev == -1)
                                {
                                    substring = "00";
                                }
                                else
                                {
                                    substring = maxNumberitem.Substring(indexofrev + 3, 2);
                                }
                                maxNumberList.Add(substring);
                            }
                            string maxNumber = maxNumberList.Max();
                            //code for sign on multiple pdf at a time [plahange][30-11-22][APIGEOS-615]
                            if (maxNumber != "00")
                            {
                                foreach (string mno in revPDFList)
                                {
                                    if (mno.Contains("rev" + maxNumber))
                                    {
                                        finalpdflist.Add(mno);
                                    }
                                }
                            }
                            else
                            {
                                foreach (string mno in revPDFList)
                                {
                                    finalpdflist.Add(mno);
                                }
                            }
                        }
                        foreach (var pdfitem in finalpdflist)
                        {
                            MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, "*" + pdfitem + "*.*", SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                            if (MaxRevFileName == null)
                            {
                                MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, pdfitem, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                            }
                            if (!File.Exists(MaxRevFileName))
                            {
                                MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, pdfitem, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                            }

                            #endregion
                            // }
                            #endregion

                            #region Signature_Box_geos_app_settings
                            string geos_app_settings = string.Empty;
                            using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                            {
                                conn.Open();
                                MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                command.CommandType = CommandType.StoredProcedure;
                                if (Signatory.Trim().ToUpper().Equals("Employee".Trim().ToUpper()))
                                {
                                    command.Parameters.AddWithValue("_IdAppSetting", 69);
                                }
                                else if (Signatory.Trim().ToUpper().Equals("Customer".Trim().ToUpper()))
                                {
                                    command.Parameters.AddWithValue("_IdAppSetting", 71);
                                }


                                using (MySqlDataReader dr = command.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        if (dr["DefaultValue"] != DBNull.Value)
                                        {
                                            geos_app_settings = Convert.ToString(dr["DefaultValue"]);
                                        }
                                    }
                                }

                            }

                            List<string> app_settings = geos_app_settings.Split(';').ToList();
                            List<string> settings = new List<string>();
                            foreach (var item in app_settings)
                            {
                                settings.Add(Regex.Match(item, @"\d+").Value);
                            }
                            #endregion

                            #region FullName_geos_app_settings
                            string geos_app_settingsFullName = string.Empty;
                            using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                            {
                                conn.Open();
                                MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                command.CommandType = CommandType.StoredProcedure;
                                if (Signatory.Trim().ToUpper().Equals("Employee".Trim().ToUpper()))
                                {
                                    command.Parameters.AddWithValue("_IdAppSetting", 72);
                                }
                                else if (Signatory.Trim().ToUpper().Equals("Customer".Trim().ToUpper()))
                                {
                                    command.Parameters.AddWithValue("_IdAppSetting", 74);
                                }

                                using (MySqlDataReader dr = command.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        if (dr["DefaultValue"] != DBNull.Value)
                                        {
                                            geos_app_settingsFullName = Convert.ToString(dr["DefaultValue"]);
                                        }
                                    }
                                }

                            }

                            List<string> Tempapp_settings = geos_app_settingsFullName.Split(';').ToList();
                            List<string> FullNamesettings = new List<string>();
                            foreach (var item in Tempapp_settings)
                            {
                                FullNamesettings.Add(Regex.Match(item, @"\d+").Value);
                            }
                            #endregion
                            #region geos_app_settingsDateTime
                            string geos_app_settingsDateTime = string.Empty;
                            using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                            {
                                conn.Open();
                                MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                command.CommandType = CommandType.StoredProcedure;
                                if (Signatory.Trim().ToUpper().Equals("Employee".Trim().ToUpper()))
                                {
                                    command.Parameters.AddWithValue("_IdAppSetting", 75);
                                }
                                else if (Signatory.Trim().ToUpper().Equals("Customer".Trim().ToUpper()))
                                {
                                    command.Parameters.AddWithValue("_IdAppSetting", 77);
                                }


                                using (MySqlDataReader dr = command.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        if (dr["DefaultValue"] != DBNull.Value)
                                        {
                                            geos_app_settingsDateTime = Convert.ToString(dr["DefaultValue"]);
                                        }
                                    }
                                }

                            }

                            List<string> dateTimeapp_settings = geos_app_settingsDateTime.Split(';').ToList();
                            List<string> DateTimesettings = new List<string>();
                            foreach (var item in dateTimeapp_settings)
                            {
                                DateTimesettings.Add(Regex.Match(item, @"\d+").Value);
                            }
                            #endregion
                            #region Header&Footer   
                            var filePath = Path.Combine(updatedExcelFilePath, pdfitem);//code for sign on multiple pdf at a time [plahange][30-11-22][APIGEOS-615]
                                                                                       // var filePath = Path.Combine(updatedExcelFilePath, containstr);
                            byte[] bytes = System.IO.File.ReadAllBytes(filePath);
                            var pdfReader = new iTextSharp.text.pdf.PdfReader(bytes);
                            using (Stream output = new FileStream(filePath, FileMode.Create, FileAccess.Write, FileShare.None))
                            {
                                using (iTextSharp.text.pdf.PdfStamper pdfStamper = new iTextSharp.text.pdf.PdfStamper(pdfReader, output))
                                {
                                    //for (int pageIndex = 1; pageIndex <= pdfReader.NumberOfPages; pageIndex++)
                                    for (int pageIndex = 1; pageIndex <= 1; pageIndex++)
                                    {
                                        pdfStamper.FormFlattening = false;
                                        iTextSharp.text.Rectangle pageRectangle = pdfReader.GetPageSizeWithRotation(pageIndex);
                                        iTextSharp.text.pdf.PdfContentByte pdfData = pdfStamper.GetOverContent(pageIndex);

                                        pdfData.SetFontAndSize(iTextSharp.text.pdf.BaseFont.CreateFont(iTextSharp.text.pdf.BaseFont.TIMES_BOLD, iTextSharp.text.pdf.BaseFont.CP1252,
                                        iTextSharp.text.pdf.BaseFont.NOT_EMBEDDED), 15);
                                        iTextSharp.text.pdf.PdfGState graphicsState = new iTextSharp.text.pdf.PdfGState
                                        {
                                            FillOpacity = 10F
                                        };
                                        pdfData.SetGState(graphicsState);
                                        //iTextSharp.text.pdf.BaseFont bf = iTextSharp.text.pdf.BaseFont.CreateFont(System.Web.Hosting.HostingEnvironment.MapPath("\\") + "fonts\\calibri.ttf", iTextSharp.text.pdf.BaseFont.CP1252,
                                        //iTextSharp.text.pdf.BaseFont.NOT_EMBEDDED);
                                        iTextSharp.text.pdf.BaseFont bf = iTextSharp.text.pdf.BaseFont.CreateFont(iTextSharp.text.pdf.BaseFont.TIMES_BOLD, iTextSharp.text.pdf.BaseFont.CP1252,
                                        iTextSharp.text.pdf.BaseFont.NOT_EMBEDDED);
                                        pdfData.SetColorFill(iTextSharp.text.BaseColor.BLACK);
                                        iTextSharp.text.Font font = new iTextSharp.text.Font(bf, 15, iTextSharp.text.Font.BOLD);
                                        pdfData.SetFontAndSize(bf, 10);


                                        #region Footer 
                                        pdfData.BeginText();
                                        //float w = (float)Convert.ToDouble(settings[2])-15;
                                        //float h = (float)Convert.ToDouble(settings[3])-15;
                                        //float x = (float)Convert.ToDouble(settings[0])+50;
                                        //float y = (float)Convert.ToDouble(settings[1]);

                                        //float xFullName = (float)Convert.ToDouble(FullNamesettings[0]);
                                        //float yFullName = (float)Convert.ToDouble(FullNamesettings[1]);
                                        //float xDateTime = (float)Convert.ToDouble(DateTimesettings[0]);
                                        //float yDateTime = (float)Convert.ToDouble(DateTimesettings[1]);
                                        if ((Signatory.ToUpper()).Equals("EMPLOYEE".ToUpper()))
                                        {
                                            float w = (float)Convert.ToDouble(settings[2]) - 15;
                                            float h = (float)Convert.ToDouble(settings[3]) - 22;
                                            float x = (float)Convert.ToDouble(settings[0]) + 60;
                                            float y = (float)Convert.ToDouble(settings[1]) - 5; // + for up and - for down 


                                            float xFullName = (float)Convert.ToDouble(FullNamesettings[0]) + 60;
                                            float yFullName = (float)Convert.ToDouble(FullNamesettings[1]) - 30;
                                            float xDateTime = (float)Convert.ToDouble(DateTimesettings[0]) + 50;
                                            float yDateTime = (float)Convert.ToDouble(DateTimesettings[1]);



                                            string pageNumber = 1.ToString();
                                            //pdfData.ShowTextAligned(1, createExpenseReportsSign.FullName, x + 50, y + 85, 0);
                                            //pdfData.ShowTextAligned(1, createExpenseReportsSign.DateTime, x + 50 , y -10, 0);
                                            pdfData.ShowTextAligned(1, createExpenseReportsSign.FullName, xFullName, yFullName, 0);
                                            pdfData.ShowTextAligned(1, createExpenseReportsSign.DateTime, xDateTime, yDateTime, 0);
                                            pdfData.EndText();

                                            #region Add Signature Image 
                                            string base64encodedstring = createExpenseReportsSign.Signature;
                                            var base64bytes = Convert.FromBase64String(base64encodedstring);
                                            iTextSharp.text.Image image = iTextSharp.text.Image.GetInstance(base64bytes);
                                            image.ScaleAbsolute(w, h);
                                            image.SetAbsolutePosition(x, y);
                                            pdfData.AddImage(image);
                                        }
                                        if ((Signatory.ToUpper()).Equals("CUSTOMER".ToUpper()))
                                        {
                                            float w = (float)Convert.ToDouble(settings[2]) - 15;
                                            float h = (float)Convert.ToDouble(settings[3]) - 22;
                                            float x = (float)Convert.ToDouble(settings[0]) - 50;
                                            float y = (float)Convert.ToDouble(settings[1]) - 5;


                                            float xFullName = (float)Convert.ToDouble(FullNamesettings[0]) - 60;
                                            float yFullName = (float)Convert.ToDouble(FullNamesettings[1]) - 30;
                                            float xDateTime = (float)Convert.ToDouble(DateTimesettings[0]) - 60;
                                            float yDateTime = (float)Convert.ToDouble(DateTimesettings[1]);



                                            string pageNumber = 1.ToString();
                                            //pdfData.ShowTextAligned(1, createExpenseReportsSign.FullName, x + 50, y + 85, 0);
                                            //pdfData.ShowTextAligned(1, createExpenseReportsSign.DateTime, x + 50 , y -10, 0);
                                            pdfData.ShowTextAligned(1, createExpenseReportsSign.FullName, xFullName, yFullName, 0);
                                            pdfData.ShowTextAligned(1, createExpenseReportsSign.DateTime, xDateTime, yDateTime, 0);
                                            pdfData.EndText();

                                            #region Add Signature Image 
                                            string base64encodedstring = createExpenseReportsSign.Signature;
                                            var base64bytes = Convert.FromBase64String(base64encodedstring);
                                            iTextSharp.text.Image image = iTextSharp.text.Image.GetInstance(base64bytes);
                                            image.ScaleAbsolute(w, h);
                                            image.SetAbsolutePosition(x, y);
                                            pdfData.AddImage(image);
                                            #endregion
                                        }
                                        #endregion
                                        #endregion
                                    }
                                }
                                output.Close();
                                output.Dispose();
                            }
                        }//multi pdf sign
                        result = true;
                    }
                    #endregion
                    //result = true;
                }


            }
            catch (Exception ex)
            {
                result = false;
                Log4NetLogger.Logger.Log(string.Format("Error UpdateExpenseReports(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            return result;
        }

        public SendEmail SendTechnicalAssistanceReport(SendMailOffer sendMailOffer, string plantOwner, string IdTechnicalAssistanceReport, string ConnectionString, string loginConnectionString, string offerCommericalPath, string mailServerName, string mailServerPort, string mailFrom, string Mailpassword, string MailUser, string Plantwiseconnectionstring)
        {
            SendEmail sendEmail = new SendEmail();
            ErrorMessage errormessage = new ErrorMessage();
            ErrorMessage warningmessage = new ErrorMessage();
            warningmessage = null;
            errormessage = null;
            //sendEmail = null;
            bool isDone = false;
            Int64 idSite = IsEMDEPSiteExist(plantOwner, ConnectionString);
            if (idSite > 0)
            {
                string siteConnectionstring = GetSiteConnectionString(idSite, ConnectionString, Plantwiseconnectionstring);
                TechnicalServiceReportsExport technicalservicereportsexport = new TechnicalServiceReportsExport();
                try
                {
                    Log4NetLogger.Logger.Log(string.Format("Method Send()...."), category: Category.Info, priority: Priority.Low);
                    using (MySqlConnection conn = new MySqlConnection(siteConnectionstring))
                    {
                        conn.Open();
                        MySqlCommand command = new MySqlCommand("GEOSAPI_GetSendTechnicalAssistanceReport_V690", conn);
                        command.CommandType = CommandType.StoredProcedure;
                        command.Parameters.AddWithValue("_IdTechnicalAssistanceReport", IdTechnicalAssistanceReport);

                        using (MySqlDataReader dr = command.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                if (dr["Title"] != DBNull.Value)
                                {
                                    technicalservicereportsexport._OfferTitle = Convert.ToString(dr["Title"]);
                                }
                                if (dr["OfferNumber"] != DBNull.Value)
                                {
                                    technicalservicereportsexport._OrderCode = Convert.ToString(dr["OfferNumber"]);
                                }
                                if (dr["Year"] != DBNull.Value)
                                {
                                    technicalservicereportsexport._Year = Convert.ToString(dr["Year"]);
                                }
                                if (dr["ContactFullName"] != DBNull.Value)
                                {
                                    technicalservicereportsexport._ContactFullName = Convert.ToString(dr["ContactFullName"]);
                                }
                                if (dr["ContactEmail"] != DBNull.Value)
                                {
                                    technicalservicereportsexport._ContactEmail = Convert.ToString(dr["ContactEmail"]);
                                }
                                if (dr["ReportCode"] != DBNull.Value)
                                {
                                    technicalservicereportsexport._ReportCode = Convert.ToString(dr["ReportCode"]);
                                }
                                if (dr["ReportDate"] != DBNull.Value)
                                {
                                    technicalservicereportsexport._ReportDate = Convert.ToString(dr["ReportDate"]);
                                }
                                if (dr["TechnicianFullName"] != DBNull.Value)
                                {
                                    technicalservicereportsexport._TechnicianFullName = Convert.ToString(dr["TechnicianFullName"]);
                                }
                                if (dr["RequesterFullName"] != DBNull.Value)
                                {
                                    technicalservicereportsexport._RequesterFullName = Convert.ToString(dr["RequesterFullName"]);
                                }
                            }

                        }
                    }
                    Log4NetLogger.Logger.Log(string.Format("Method Send()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                }
                catch (Exception ex)
                {

                    Log4NetLogger.Logger.Log(string.Format("Error Send(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw ex;

                }

                try
                {
                    string emailString = string.Empty;
                    using (MySqlConnection conn = new MySqlConnection(loginConnectionString))
                    {
                        conn.Open();
                        MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                        command.CommandType = CommandType.StoredProcedure;
                        command.Parameters.AddWithValue("_IdAppSetting", 44);
                        using (MySqlDataReader dr = command.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                if (dr["DefaultValue"] != DBNull.Value)
                                {
                                    emailString = Convert.ToString(dr["DefaultValue"]);
                                }
                            }
                        }

                    }
                    List<string> SupportEmailList = new List<string>();
                    foreach (var address in emailString.Split(new[] { ",", ";" }, StringSplitOptions.RemoveEmptyEntries))
                    {
                        SupportEmailList.Add(address);
                    }


                    if (technicalservicereportsexport != null)
                    {

                        string filenameExcel = null;
                        string filenamePDF = null;
                        string updatedExcelFilePath = offerCommericalPath.Replace("{0}", plantOwner);
                        updatedExcelFilePath = updatedExcelFilePath + @"\" + technicalservicereportsexport._ReportCode + @"\";

                        #region
                        //if (plantOwner == "EAES" || plantOwner == "ETHQ")
                        //{
                        //    updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCM");
                        //}
                        //else if (plantOwner == "EIBR")
                        //{
                        //    updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMB");
                        //}
                        //else if (plantOwner == "EARO" || plantOwner == "EBRO" || plantOwner == "ENRU")
                        //{
                        //    updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMR");
                        //}
                        //else if (plantOwner == "ETMA" || plantOwner == "ESMA1" || plantOwner == "ESMA2")
                        //{
                        //    updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMM");
                        //}
                        //else if (plantOwner == "ESCN" || plantOwner == "ETCN")
                        //{
                        //    updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMCN");
                        //}
                        //else if (plantOwner == "ETTN")
                        //{
                        //    updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMT");
                        //}
                        //else if (plantOwner == "EPIN")
                        //{
                        //    updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMIN");
                        //}
                        //else if (plantOwner == "EJMX1" || plantOwner == "EJMX2" || plantOwner == "ESMX" || plantOwner == "EAMX")
                        //{
                        //    updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMX");
                        //}
                        //else if (plantOwner == "ESHN")
                        //{
                        //    updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMH");
                        //}
                        //else if (plantOwner == "EEPY")
                        //{
                        //    updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMPY");
                        //}
                        //else if (plantOwner == "EAMX")
                        //{
                        //    updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMMX");
                        //}
                        #endregion

                        Log4NetLogger.Logger.Log(string.Format("Method Send()....OfferYear- {0}", technicalservicereportsexport._Year), category: Category.Info, priority: Priority.Low);
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....OfferNumber.... {0}", technicalservicereportsexport._OrderCode), category: Category.Info, priority: Priority.Low);
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....updatedExcelFilePath.... {0}", updatedExcelFilePath), category: Category.Info, priority: Priority.Low);
                        List<Int32> revNumber = new List<int>();

                        //string search = "TR_" + technicalservicereportsexport._ReportCode + "_rev" + '*' + "_" + '*' + ".pdf";
                        //string search = "TR_" + technicalservicereportsexport._ReportCode + ".pdf";

                        string search = technicalservicereportsexport._ReportCode + ".pdf"; //chitra.girigosavi [APIGEOS-1176][11/07/2024]

                        //string searchpattern =  Order + '*';
                        //string[] allfiles = Directory.GetFiles(updatedExcelFilePath, "*.*", SearchOption.AllDirectories);
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....search.... {0}", search), category: Category.Info, priority: Priority.Low);
                        FileInfo[] files = new DirectoryInfo(updatedExcelFilePath)
                        .GetFiles(search)
                        //.OrderBy(f => f.CreationTime)
                        .ToArray();
                        var allfiles = files;

                        if (allfiles.Count() == 0)
                        {
                            //search = "TR_" + technicalservicereportsexport._ReportCode + ".*";
                            search = technicalservicereportsexport._ReportCode + ".*"; //chitra.girigosavi [APIGEOS-1176][11/07/2024]

                            Log4NetLogger.Logger.Log(string.Format("Method Send()....search2.... {0}", search), category: Category.Info, priority: Priority.Low);
                            FileInfo[] files1 = new DirectoryInfo(updatedExcelFilePath)
                           .GetFiles(search)
                           //.OrderBy(f => f.CreationTime)
                           .ToArray();
                            allfiles = files1;
                        }
                        List<string> revPDFList = new List<string>();
                        foreach (var itemPDF in allfiles)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....itemPDF.... {0}", string.Join(",", itemPDF.ToString())), category: Category.Info, priority: Priority.Low);
                            string substringitem = itemPDF.ToString().Split('\\').Last();
                            //string[] strArray = substringitem.Split('_');
                            //string substringitemsplit = strArray[2];
                            revPDFList.Add(substringitem);
                        }
                        //string filename = revPDFList.OrderByDescending(r => r).ToList().FirstOrDefault();
                        string containstr = "";
                        string MaxRevFileName = "";
                        if (revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault() == null)
                        {
                            containstr = technicalservicereportsexport._OfferTitle + ".pdf";
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....containstr.... {0}", containstr), category: Category.Info, priority: Priority.Low);
                        }
                        else
                        {
                            List<string> maxNumberList = new List<string>();
                            foreach (var maxnumItem in revPDFList)
                            {
                                int indexofrev = maxnumItem.IndexOf("rev");
                                string substring = "00";
                                if (indexofrev == -1)
                                {
                                    substring = "00";
                                }
                                else
                                {
                                    substring = maxnumItem.Substring(indexofrev + 3, 2);
                                }
                                Log4NetLogger.Logger.Log(string.Format("Method Send()....substring.... {0}", substring), category: Category.Info, priority: Priority.Low);
                                maxNumberList.Add(substring);

                            }
                            string maxNumber = maxNumberList.Max();
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....maxNumber.... {0}", maxNumber), category: Category.Info, priority: Priority.Low);
                            //string str = revPDFList.Where(w => w.Contains("TR_" + technicalservicereportsexport._ReportCode + "_" + "rev" + maxNumber)).FirstOrDefault();
                            string str = revPDFList.Where(w => w.Contains(technicalservicereportsexport._ReportCode + "_" + "rev" + maxNumber)).FirstOrDefault(); //chitra.girigosavi [APIGEOS-1176][11/07/2024]

                            Log4NetLogger.Logger.Log(string.Format("Method Send()....str.... {0}", str), category: Category.Info, priority: Priority.Low);
                            //containstr = "TR_" + technicalservicereportsexport._ReportCode + "_" + "rev" + maxNumber + "_" + '*';
                            containstr = technicalservicereportsexport._ReportCode + "_" + "rev" + maxNumber + "_" + '*'; //chitra.girigosavi [APIGEOS-1176][11/07/2024]

                            Log4NetLogger.Logger.Log(string.Format("Method Send()....containstr.... {0}", containstr), category: Category.Info, priority: Priority.Low);
                            // containstr = revPDFList.Last();
                        }
                        //MaxRevFileName = Directory.GetFiles(updatedExcelFilePath).Where(fi => fi.Contains(containstr)).FirstOrDefault();
                        if (containstr != null)
                            MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, containstr, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....MaxRevFileName.... {0}", MaxRevFileName), category: Category.Info, priority: Priority.Low);
                        if (MaxRevFileName == null)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....MaxRevFileName.... {0}", MaxRevFileName), category: Category.Info, priority: Priority.Low);
                            containstr = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault();
                            //MaxRevFileName = Directory.GetFiles(updatedExcelFilePath).Where(fi => fi.Contains(containstr)).FirstOrDefault();
                            if (containstr != null)
                                MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, containstr, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....containstr.... {0}", containstr), category: Category.Info, priority: Priority.Low);
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....MaxRevFileName.... {0}", MaxRevFileName), category: Category.Info, priority: Priority.Low);
                        }
                        if (!File.Exists(MaxRevFileName))
                        {
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....File.Exists(MaxRevFileName)...."), category: Category.Info, priority: Priority.Low);
                            if (revPDFList.Count() > 0)
                            {
                                containstr = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault().ToString().PadLeft(2, '0');
                                if (containstr != null)
                                    MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, containstr, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                                //MaxRevFileName = Directory.GetFiles(updatedExcelFilePath).Where(fi => fi.Contains(containstr)).FirstOrDefault();
                                Log4NetLogger.Logger.Log(string.Format("Method Send()....containstr.... {0}", containstr), category: Category.Info, priority: Priority.Low);
                                Log4NetLogger.Logger.Log(string.Format("Method Send()....MaxRevFileName.... {0}", MaxRevFileName), category: Category.Info, priority: Priority.Low);
                            }

                        }
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....containstr....END.... {0}", containstr), category: Category.Info, priority: Priority.Low);
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....MaxRevFileName....END.... {0}", MaxRevFileName), category: Category.Info, priority: Priority.Low);
                        // string mailecos = "ECOS";
                        string mailecos = string.IsNullOrEmpty(sendMailOffer.Source) ? "ECOS" : sendMailOffer.Source.ToUpper();
                        //  string mailecos =  mailFrom;
                        List<string> FailEmailList = new List<string>();
                        List<string> sendEmailList = new List<string>();
                        List<string> errorEmailList = new List<string>();
                        List<string> sendEmailTOList = new List<string>();
                        Regex regexEmail;
                        //Regex regex = new Regex(@"/^[a-z0-9](\.?[a-z0-9]){3,}@[Gg][Mm][Aa][Ii][Ll]\.com$/");
                        string allowEmailAddress = emailString;
                        allowEmailAddress = emailString.Replace('*', ' ');
                        string result = string.Concat(allowEmailAddress.Where(c => !char.IsWhiteSpace(c)));
                        string emailRegexString = result.Replace(';', '|');
                        //if (emailString.Contains("*@*.com"))
                        if (emailString.Contains("*@*"))
                        {
                            regexEmail = new Regex(@"[A-Z0-9a-z._%+-]+@[A-Za-z0-9-]+\.[A-Za-z]{2,64}");
                        }
                        else
                        {
                            //regexEmail = new Regex(@"\w+([-+.]\w+)*@(emdep|gmail)\.com");
                            regexEmail = new Regex(@"\w+([-+.]\w+)*(" + emailRegexString + ")");

                        }
                        //chitra.girigosavi APIGEOS-1657 07/11/2025
                        if (!string.IsNullOrEmpty(sendMailOffer.CC) || true) // Always enter to include plant-based CCs
                        {
                            // Fetch CC recipients from database based on plant
                            List<string> recipients = null;
                            try
                            {
                                recipients = GetPeopleEmailsByPlant(plantOwner, ConnectionString);
                                Log4NetLogger.Logger.Log($"Fetched {recipients?.Count ?? 0} CC recipients from GetPeopleEmailsByPlant for {plantOwner}.", category: Category.Info, priority: Priority.Low);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log($"Error in GetPeopleEmailsByPlant(): {ex.Message}", category: Category.Exception, priority: Priority.Low);
                                recipients = new List<string>(); // ensure it’s not null
                            }

                            // Merge recipients from sendMailOffer.CC and database
                            List<string> combinedCCList = new List<string>();

                            // Add from sendMailOffer.CC (if provided)
                            if (!string.IsNullOrEmpty(sendMailOffer.CC))
                            {
                                foreach (var address in sendMailOffer.CC.Split(new[] { ",", ";" }, StringSplitOptions.RemoveEmptyEntries))
                                {
                                    combinedCCList.Add(address.Trim());
                                }
                            }

                            // Add from GetPeopleEmailsByPlant()
                            if (recipients != null && recipients.Count > 0)
                            {
                                foreach (var recipient in recipients)
                                {
                                    if (!combinedCCList.Contains(recipient, StringComparer.OrdinalIgnoreCase))
                                        combinedCCList.Add(recipient.Trim());
                                }
                            }

                            // Validate and categorize all CC addresses
                            foreach (var address in combinedCCList)
                            {
                                if (emailString.Equals(string.Empty))
                                {
                                    bool checkcc = IsValidEmail(address);
                                    if (checkcc)
                                        FailEmailList.Add(address);
                                }
                                else
                                {
                                    Match match = regexEmail.Match(address);
                                    if (match.Success)
                                    {
                                        bool checkcc = IsValidEmail(address);
                                        if (checkcc)
                                            sendEmailList.Add(address);
                                    }
                                    else
                                    {
                                        bool checkcc = IsValidEmail(address);
                                        if (checkcc)
                                            FailEmailList.Add(address);
                                        else
                                            errorEmailList.Add(address);
                                    }
                                }
                            }
                        }
                        if (!string.IsNullOrEmpty(sendMailOffer.TO))
                        {
                            string emailTo = sendMailOffer.TO;
                            foreach (var EmailTo in emailTo.Split(new[] { ",", ";" }, StringSplitOptions.RemoveEmptyEntries))
                            {
                                if (emailString.Equals(string.Empty))
                                {
                                    bool checkcc = IsValidEmail(EmailTo);
                                    if (checkcc == true)
                                        FailEmailList.Add(EmailTo);
                                }
                                else if (emailString != string.Empty)
                                {
                                    Match match = regexEmail.Match(EmailTo);
                                    if (match.Success == true)
                                    {
                                        bool checkcc = IsValidEmail(EmailTo);
                                        if (checkcc == true)
                                        {
                                            sendEmailTOList.Add(EmailTo);
                                        }
                                        //mailmessage.CC.Add(address);
                                    }
                                    else if (match.Success == false)
                                    {
                                        bool checkcc = IsValidEmail(EmailTo);
                                        if (checkcc == true)
                                        {
                                            FailEmailList.Add(EmailTo);
                                        }
                                        else
                                        {
                                            errorEmailList.Add(EmailTo);
                                        }

                                    }
                                }
                            }
                        }



                        if (FailEmailList != null)
                        {
                            if (FailEmailList.Count > 0)
                            {
                                string str = String.Join(",", FailEmailList);
                                if (warningmessage == null)
                                {
                                    warningmessage = new ErrorMessage();
                                }
                                if (warningmessage != null)
                                {
                                    warningmessage.code = "721";
                                    if (warningmessage.info == null)
                                        warningmessage.info = "The following email are not supported to send : " + str;
                                    else
                                        warningmessage.info = warningmessage.info + ",";
                                }
                            }
                        }

                        if (errorEmailList != null)
                        {
                            if (errorEmailList.Count > 0)
                            {
                                string errorstr = String.Join(",", errorEmailList);
                                if (errormessage == null)
                                {
                                    errormessage = new ErrorMessage();
                                }
                                if (errormessage != null)
                                {
                                    errormessage.code = "713";
                                    if (errormessage.info == null)
                                        errormessage.info = "The following email (" + errorstr + ") are not correct format:";
                                    else
                                        errormessage.info = errormessage.info + "," + errorstr;
                                }
                            }
                        }
                        StringBuilder emailbodyStr = new StringBuilder();
                        emailbodyStr.Append(string.IsNullOrEmpty(sendMailOffer.Body) ? "" : sendMailOffer.Body.ToString());

                        AlternateView htmlView = AlternateView.CreateAlternateViewFromString(emailbodyStr.ToString(), null, "text/html");
                        System.Net.Mail.Attachment item = null;
                        if (File.Exists(MaxRevFileName))
                        {
                            item = new System.Net.Mail.Attachment(MaxRevFileName);
                        }
                        else if (!File.Exists(MaxRevFileName))
                        {
                            FailEmailList.Add("Attachment not found ");

                            if (FailEmailList != null)
                            {
                                if (FailEmailList.Count > 0)
                                {
                                    string str = String.Join(",", FailEmailList);
                                    if (warningmessage == null)
                                    {
                                        warningmessage = new ErrorMessage();
                                    }
                                    if (warningmessage != null)
                                    {
                                        warningmessage.code = "721";
                                        warningmessage.info = warningmessage.info + " Attachment not found".ToString();
                                    }
                                }
                            }
                        }

                        string MailCredentials = string.Empty;
                        if (Mailpassword != string.Empty)
                        {
                            var base64EncodedBytes = Convert.FromBase64String(Mailpassword);
                            MailCredentials = Encoding.UTF8.GetString(base64EncodedBytes);
                        }

                        string sendEmailToString = String.Join(", ", sendEmailTOList);
                        if (string.IsNullOrEmpty(sendEmailToString))
                        {
                            if (errormessage != null)
                            {
                                sendEmail.error = errormessage;
                            }
                            if (warningmessage != null)
                            {
                                sendEmail.warning = warningmessage;
                            }
                            return sendEmail;
                        }
                        MailAddress emailFrom = new MailAddress(mailFrom, mailecos);
                        MailAddress emailTO = new MailAddress(sendEmailToString, sendEmailToString);
                        List<string> templist = sendEmailToString.Split(',').ToList();
                        using (MailMessage mail = new MailMessage())
                        {
                            mail.From = emailFrom;
                            foreach (var emailTOList in templist)
                            {
                                mail.To.Add(emailTOList);
                            }
                            foreach (var SendEmail in sendEmailList)
                            {
                                mail.CC.Add(SendEmail);
                            }
                            if (File.Exists(MaxRevFileName) && item != null)
                            {
                                mail.Attachments.Add(item);
                                Log4NetLogger.Logger.Log(string.Format("Method Send()....Attachments....END.... {0}", item.Name), category: Category.Info, priority: Priority.Low);
                            }
                            mail.AlternateViews.Add(htmlView);
                            mail.Subject = sendMailOffer.Subject;
                            mail.Body = sendMailOffer.Body;
                            mail.IsBodyHtml = true;
                            mail.IsBodyHtml = sendMailOffer.IsHtmlBody;
                            using (SmtpClient smtp = new SmtpClient(mailServerName, Convert.ToInt32(mailServerPort)))
                            {
                                smtp.UseDefaultCredentials = false;
                                smtp.Credentials = new NetworkCredential(MailUser, MailCredentials);
                                smtp.EnableSsl = false;
                                try
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Method before()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                                    smtp.Send(mail);
                                    try
                                    {
                                        //Shubham[skadam] APIGEOS-1352 We need to send mail other than emdep customer.  30 01 2024
                                        // Combine all emails into a single array
                                        //var allEmails = ProcessEmails(sendMailOffer.TO).Concat(sendMailOffer.CC);

                                        //var allEmails = ProcessEmails(sendMailOffer.TO.Concat(sendMailOffer.CC)); 

                                        var getallEmails = ProcessEmails(sendMailOffer.TO).Concat(ProcessEmails(sendMailOffer.CC)); // Convert to list if needed

                                        // Join all emails into a single string separated by commas
                                        string allEmailsString = string.Join(", ", getallEmails);
                                        //bool isToCustomerEmail = CheckIfCustomerEmail(IdTechnicalAssistanceReport, sendMailOffer.TO, siteConnectionstring);
                                        //bool isCCCustomerEmail = CheckIfCustomerEmail(IdTechnicalAssistanceReport, sendMailOffer.CC, siteConnectionstring);
                                        //if (isToCustomerEmail || isCCCustomerEmail)
                                        if (getallEmails != null && getallEmails.Count() > 0)
                                        {
                                            if (getallEmails.Any(e => !e.EndsWith("@emdep.com", StringComparison.OrdinalIgnoreCase)))
                                            {
                                                bool isStatusUpdated = UpdateReportStatus(IdTechnicalAssistanceReport, 77, siteConnectionstring);
                                                if (isStatusUpdated)
                                                {
                                                    Log4NetLogger.Logger.Log("Report status updated to Submitted (77) based on the 'TO' field.", category: Category.Info, priority: Priority.Low);
                                                }
                                            }
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        Log4NetLogger.Logger.Log($"Error updating report status based on the 'TO' field: {ex.Message}", category: Category.Exception, priority: Priority.High);
                                    }

                                    Log4NetLogger.Logger.Log(string.Format("Method Send call successfully()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                                }

                                catch (SmtpFailedRecipientsException ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Method SmtpFailedRecipientsException()....Executed successfully."), category: Category.Exception, priority: Priority.Low);
                                    if (errormessage == null)
                                    {
                                        errormessage = new ErrorMessage();
                                    }
                                    if (errormessage != null)
                                    {
                                        errormessage.code = "713";
                                        if (errormessage.info == null)
                                            errormessage.info = ex.Message.ToString();
                                        else
                                            errormessage.info = errormessage.info + "," + ex.InnerException.Message.ToString();
                                    }
                                }
                                catch (SmtpFailedRecipientException ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Method SmtpFailedRecipientException()....Executed successfully."), category: Category.Exception, priority: Priority.Low);
                                    if (errormessage == null)
                                    {
                                        errormessage = new ErrorMessage();
                                    }
                                    if (errormessage != null)
                                    {
                                        errormessage.code = "713";
                                        if (errormessage.info == null)
                                            errormessage.info = ex.Message.ToString();
                                        else
                                            errormessage.info = errormessage.info + "," + ex.InnerException.Message.ToString();
                                    }
                                }
                                catch (SmtpException ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Method SmtpException()....Executed successfully."), category: Category.Exception, priority: Priority.Low);
                                    if (errormessage == null)
                                    {
                                        errormessage = new ErrorMessage();
                                    }
                                    if (errormessage != null)
                                    {
                                        errormessage.code = "713";
                                        if (errormessage.info == null)
                                            errormessage.info = ex.Message.ToString();
                                        else
                                            errormessage.info = errormessage.info + "," + ex.InnerException.Message.ToString();
                                    }
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Method Exception()....Executed successfully."), category: Category.Exception, priority: Priority.Low);
                                    if (errormessage == null)
                                    {
                                        errormessage = new ErrorMessage();
                                    }
                                    if (errormessage != null)
                                    {
                                        errormessage.code = "713";
                                        if (errormessage.info == null)
                                            errormessage.info = ex.Message.ToString();
                                        else
                                            errormessage.info = errormessage.info + "," + ex.InnerException.Message.ToString();
                                    }
                                }

                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    throw ex;
                }
            }
            if (errormessage != null)
            {
                Log4NetLogger.Logger.Log(string.Format("Method error message call successfully()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                sendEmail.error = errormessage;
            }
            if (warningmessage != null)
            {
                Log4NetLogger.Logger.Log(string.Format("Method warning message call successfully()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                sendEmail.warning = warningmessage;
            }

            Log4NetLogger.Logger.Log(string.Format("Method  return sendEmail successfully()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            return sendEmail;

        }

        //chitra.girigosavi APIGEOS-1657 07/11/2025
        private List<string> GetPeopleEmailsByPlant(string plant, string siteConnectionString)
        {
            List<string> emails = new List<string>();

            using (MySqlConnection connection = new MySqlConnection(siteConnectionString))
            {
                connection.Open();
                MySqlCommand cmd = new MySqlCommand("GEOSAPI_GetPeopleByPlant_V870", connection);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.AddWithValue("_Plant", plant);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        if (reader["Email"] != DBNull.Value)
                        {
                            string email = Convert.ToString(reader["Email"]).Trim();
                            if (!string.IsNullOrEmpty(email))
                                emails.Add(email);
                        }
                    }
                }
                connection.Close();
            }

            return emails;
        }
        //Shubham[skadam] APIGEOS-1352 We need to send mail other than emdep customer.  30 01 2024
        public static string[] ProcessEmails(string emailString)
        {
            if (string.IsNullOrWhiteSpace(emailString)) return Array.Empty<string>();

            // Split emails by ',' or ';', trim spaces, and ensure each contains '@'
            return emailString
                .Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries)
                .Select(email => email.Trim())
                .Where(email => email.Contains("@")) // Ensure the email contains '@'
                .ToArray();
        }

        //Rahul[rgadhave] [APIGEOS-1229] [14/10/2024]
        public bool UpdateReportStatus(string idTechnicalAssistanceReport, int status, string MainConn)
        {
            bool isUpdated = false;
            try
            {
                Log4NetLogger.Logger.Log("Method UpdateReportStatus()....", category: Category.Info, priority: Priority.Low);

                using (MySqlConnection conn = new MySqlConnection(MainConn))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_UpdateReportStatus_V760", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_IdTechnicalAssistanceReport", idTechnicalAssistanceReport);
                    command.Parameters.AddWithValue("_Status", status);

                    int rowsAffected = command.ExecuteNonQuery();

                    if (rowsAffected > 0)
                    {
                        isUpdated = true;
                    }
                }

                Log4NetLogger.Logger.Log("Method UpdateReportStatus()....Executed successfully.", category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log($"Error UpdateReportStatus(). ErrorMessage- {ex.Message}", category: Category.Exception, priority: Priority.High);
                throw ex;
            }
            return isUpdated;
        }
        bool IsValidEmail(string email)
        {
            try
            {
                var addr = new System.Net.Mail.MailAddress(email);
                //return addr.Address == email;
                return true;
            }
            catch (Exception ex)
            {
                return false;
            }
        }

        //[RGadhave][APIGEOS-982][27-02-2024]
        public bool ExportTechnicalAssistanceReport_V800(string IdTechnicalAssistanceReport, string Plant, string Lang, string TechnicalAssistanceReportTemplatePath, string TechnicalAssistanceReportPath, string WorkingOrdersPath, string Plantwiseconnectionstring)
        {
            List<Languages> Languages = Getlanguages(_ConnEmdepGeosString);
            FileStream stream = null;
            CultureInfo cultureInfo;
            ErrorMessage errormessage = new ErrorMessage();
            Int64 idSite = IsEMDEPSiteExist(Plant, _ConnString);
            string siteConnectionString = GetSiteConnectionString(idSite, _ConnString, Plantwiseconnectionstring);
            Languages getLanguage = Languages.Where(l => l.TwoLetterISOLanguage.Equals(Lang.ToLower())).FirstOrDefault();
            bool isDone = false;
            TechnicalServiceReportsExport technicalservicereportsexport = new TechnicalServiceReportsExport();
            string createFolderName = null;
            string imagesToPDFConverter = null;
            bool IsFileGenerated = false;
            bool isTRAssigned = false;
            bool isTARAssigned = false;
            bool isNCRAssigned = false;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method ExportTechnicalAssistanceReport()...."), category: Category.Info, priority: Priority.Low);

                using (MySqlConnection conn = new MySqlConnection(siteConnectionString))
                {
                    conn.Open();
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_TechnicalServiceReportsExport_V680", conn);
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_TechnicalServiceReportsExport_V700", conn);//chitra.girigosavi[24/04/2024]APIGEOS-1128 Add some missing information in the TechnicalService Report
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_TechnicalServiceReportsExport_V720", conn); //chitra.girigosavi [25/06/2024] APIGEOS-1177 Display reference of the ot R not others
                    // MySqlCommand command = new MySqlCommand("GEOSAPI_TechnicalServiceReportsExport_V740", conn); //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_TechnicalServiceReportsExport_V760", conn); //[Rahul.Gadhave][APIGEOS-1228][Date:15-10-2024]
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_TechnicalServiceReportsExport_V770", conn); //[Rahul.Gadhave][APIGEOS-1228][Date:15-10-2024]
                    MySqlCommand command = new MySqlCommand("GEOSAPI_TechnicalServiceReportsExport_V790", conn);//// soumitra.kulkarni[23/01/2025][APIGEOS-1335]
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_IdTechnicalAssistanceReport", IdTechnicalAssistanceReport);
                    command.Parameters.AddWithValue("_IdSite", idSite);
                    command.Parameters.AddWithValue("_Lang", Lang);
                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        #region dr.Read
                        if (dr.Read())
                        {

                            if (dr["OrderCode"] != DBNull.Value)
                            {
                                technicalservicereportsexport._OrderCode = Convert.ToString(dr["OrderCode"]);
                            }
                            if (dr["RFQ"] != DBNull.Value)
                            {
                                technicalservicereportsexport._RFQ = Convert.ToString(dr["RFQ"]);  // soumitra.kulkarni[23/01/2025][APIGEOS-1335]
                            }
                            else
                            {
                                technicalservicereportsexport._RFQ = null;
                            }
                            if (dr["IdTechnicalAssistanceReport"] != DBNull.Value)
                            {
                                technicalservicereportsexport._IdTechnicalAssistanceReport = Convert.ToString(dr["IdTechnicalAssistanceReport"]);
                            }
                            if (dr["ReportCode"] != DBNull.Value)
                            {
                                technicalservicereportsexport._ReportCode = Convert.ToString(dr["ReportCode"]);
                            }
                            //if (dr["ReportDate"] != DBNull.Value)
                            //{
                            //    technicalservicereportsexport._ReportDate = Convert.ToString(dr["ReportDate"]);
                            //}

                            if (dr["ReportDate"] != DBNull.Value)   //chitra.girigosavi[24/04/2024]APIGEOS-1128 Add some missing information in the TechnicalService Report
                            {
                                technicalservicereportsexport._ReportDate = DateTime.Now.ToString();
                            }
                            if (dr["TechnicianFullName"] != DBNull.Value)
                            {
                                technicalservicereportsexport._TechnicianFullName = Convert.ToString(dr["TechnicianFullName"]);
                            }
                            if (dr["RequesterFullName"] != DBNull.Value)
                            {
                                technicalservicereportsexport._RequesterFullName = Convert.ToString(dr["RequesterFullName"]);
                            }
                            if (dr["ContactFullName"] != DBNull.Value)
                            {
                                technicalservicereportsexport._ContactFullName = Convert.ToString(dr["ContactFullName"]);
                            }
                            if (dr["ContactPhone"] != DBNull.Value)
                            {
                                technicalservicereportsexport._ContactPhone = Convert.ToString(dr["ContactPhone"]);
                            }
                            if (dr["ContactEmail"] != DBNull.Value)
                            {
                                technicalservicereportsexport._ContactEmail = Convert.ToString(dr["ContactEmail"]);
                            }
                            if (dr["CustomerGroup"] != DBNull.Value)
                            {
                                technicalservicereportsexport._CustomerGroup = Convert.ToString(dr["CustomerGroup"]);
                            }
                            if (dr["CustomerPlant"] != DBNull.Value)
                            {
                                technicalservicereportsexport._CustomerPlant = Convert.ToString(dr["CustomerPlant"]);
                            }
                            if (dr["CustomerCountry"] != DBNull.Value)
                            {
                                technicalservicereportsexport._CustomerCountry = Convert.ToString(dr["CustomerCountry"]);
                            }
                            if (dr["Remarks"] != DBNull.Value)
                            {
                                technicalservicereportsexport._Remarks = Convert.ToString(dr["Remarks"]);
                            }
                            if (dr["OfferYear"] != DBNull.Value)
                            {
                                technicalservicereportsexport._Year = Convert.ToString(dr["OfferYear"]);
                            }
                            #region chitra.girigosavi[24/04/2024]APIGEOS-1128 Add some missing information in the TechnicalService Report
                            if (dr["IdProductSubCategory"] != DBNull.Value)
                            {
                                technicalservicereportsexport._IdProductSubCategory = Convert.ToString(dr["IdProductSubCategory"].ToString());
                            }
                            if (dr["Category"] != DBNull.Value)
                                technicalservicereportsexport.Category1 = dr["Category"].ToString();

                            if (dr["Category"] == DBNull.Value)
                            {
                                technicalservicereportsexport.Category1 = dr["ProductSubCategory"].ToString();
                            }
                            else
                            {
                                technicalservicereportsexport.Category2 = dr["ProductSubCategory"].ToString();
                            }

                            if (dr["CarProjectName"] != DBNull.Value)
                            {
                                technicalservicereportsexport.CarProjectName = Convert.ToString(dr["CarProjectName"].ToString());
                            }
                            if (dr["caroems_Name"] != DBNull.Value)
                            {
                                technicalservicereportsexport.caroems_Name = Convert.ToString(dr["caroems_Name"].ToString());
                            }
                            if (dr["OfferCode"] != DBNull.Value)
                            {
                                technicalservicereportsexport.OfferCode = Convert.ToString(dr["OfferCode"].ToString());
                            }
                            int index = 0;
                            if (dr["Reference"] != DBNull.Value)
                            {
                                string referenceValue = dr["Reference"].ToString();

                                technicalservicereportsexport._ServiceType1 = referenceValue;
                                index++;
                            }

                            while (index < 7 && dr.Read())
                            {
                                if (dr["Reference"] != DBNull.Value)
                                {
                                    string referenceValue = dr["Reference"].ToString();

                                    switch (index)
                                    {
                                        case 1:
                                            technicalservicereportsexport._ServiceType2 = referenceValue;
                                            break;
                                        case 2:
                                            technicalservicereportsexport._ServiceType3 = referenceValue;
                                            break;
                                        case 3:
                                            technicalservicereportsexport._ServiceType4 = referenceValue;
                                            break;
                                        case 4:
                                            technicalservicereportsexport._ServiceType5 = referenceValue;
                                            break;
                                        case 5:
                                            technicalservicereportsexport._ServiceType6 = referenceValue;
                                            break;
                                        case 6:
                                            technicalservicereportsexport._ServiceType7 = referenceValue;
                                            break;
                                    }
                                    index++;
                                }
                            }
                            #endregion
                        }
                        #endregion
                        #region Worklog                    
                        if (dr.NextResult())
                        {
                            technicalservicereportsexport._WorklogItemsLst = new List<ExportWorkLogs>();
                            while (dr.Read())
                            {
                                ExportWorkLogs worklog = new ExportWorkLogs();
                                if (dr["IdTechnicalAssistanceReport"] != null)
                                {
                                    //Orders.Where(i => i.Id == Convert.ToInt64(dr["IdWarehousePurchaseOrder"].ToString())).FirstOrDefault();
                                    if (technicalservicereportsexport != null)
                                    {
                                        if (dr["IdTechnicalAssistanceReport"] != DBNull.Value)
                                        {
                                            worklog.IdTechnicalAssistanceReport = Convert.ToInt32(dr["IdTechnicalAssistanceReport"].ToString());
                                        }
                                        if (dr["WorklogDate"] != DBNull.Value)
                                        {
                                            worklog.WorklogDate = Convert.ToString(dr["WorklogDate"].ToString());
                                        }
                                        if (dr["FullName"] != DBNull.Value)
                                        {
                                            worklog.TechnicianName = Convert.ToString(dr["FullName"].ToString());
                                        }
                                        if (dr["StartTime"] != DBNull.Value)
                                        {
                                            worklog.StartTime = Convert.ToString(dr["StartTime"].ToString());
                                        }
                                        if (dr["EndTime"] != DBNull.Value)
                                        {
                                            worklog.EndTime = Convert.ToString(dr["EndTime"].ToString());
                                        }
                                        //if (dr["TotalTime"] != DBNull.Value)
                                        //{
                                        //    worklog.TotalTime = Convert.ToString(dr["TotalTime"].ToString());
                                        //}
                                        string description = string.Empty;
                                        if (dr["Description_en"] != DBNull.Value) //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                                        {
                                            if (Lang == "en" && dr["Description_en"] != DBNull.Value)
                                            {
                                                description = Convert.ToString(dr["Description_en"].ToString());
                                            }
                                            else if (Lang == "es" && dr["Description_es"] != DBNull.Value)
                                            {
                                                description = Convert.ToString(dr["Description_es"].ToString());
                                            }
                                            else if (Lang == "fr" && dr["Description_fr"] != DBNull.Value)
                                            {
                                                description = Convert.ToString(dr["Description_fr"].ToString());
                                            }
                                            else if (Lang == "pt" && dr["Description_pt"] != DBNull.Value)
                                            {
                                                description = Convert.ToString(dr["Description_pt"].ToString());
                                            }
                                            else if (Lang == "ro" && dr["Description_ro"] != DBNull.Value)
                                            {
                                                description = Convert.ToString(dr["Description_ro"].ToString());
                                            }
                                            else if (Lang == "ru" && dr["Description_ru"] != DBNull.Value)
                                            {
                                                description = Convert.ToString(dr["Description_ru"].ToString());
                                            }
                                            else if (Lang == "zh" && dr["Description_zh"] != DBNull.Value)
                                            {
                                                description = Convert.ToString(dr["Description_zh"].ToString());
                                            }
                                        }
                                        // Assign the description to worklog.Type
                                        worklog.Type = description;
                                        technicalservicereportsexport._WorklogItemsLst.Add(worklog);
                                    }
                                }
                            }
                        }
                        #endregion
                        #region Parts  
                        if (dr.NextResult())
                        {
                            technicalservicereportsexport._PartslogItemsLst = new List<ExportParts>();
                            while (dr.Read())
                            {
                                ExportParts Part = new ExportParts();
                                if (dr["IdTechnicalAssistanceReport"] != null)
                                {
                                    //Orders.Where(i => i.Id == Convert.ToInt64(dr["IdWarehousePurchaseOrder"].ToString())).FirstOrDefault();
                                    if (technicalservicereportsexport != null)
                                    {
                                        if (dr["IdTechnicalAssistanceReport"] != DBNull.Value)
                                        {
                                            Part.IdTechnicalAssistanceReport = Convert.ToInt32(dr["IdTechnicalAssistanceReport"].ToString());
                                        }
                                        if (dr["Reference"] != DBNull.Value)
                                        {
                                            Part.Reference = Convert.ToString(dr["Reference"].ToString());
                                        }
                                        if (dr["Description"] != DBNull.Value)
                                        {
                                            Part.Description = Convert.ToString(dr["Description"].ToString());
                                        }
                                        if (dr["Quantity"] != DBNull.Value)
                                        {
                                            Part.Quantity = Convert.ToInt32(dr["Quantity"].ToString());
                                        }
                                        technicalservicereportsexport._PartslogItemsLst.Add(Part);
                                    }
                                }
                            }
                        }
                        #endregion

                        //chitra.girigosavi APIGEOS-1195 [API_TSM] Changes to the report generation service”TechnicalServiceOrdersReportsExport”
                        #region Photos  
                        if (dr.NextResult())
                        {
                            technicalservicereportsexport._PhotoslogItemsLst = new List<ExportAttachments>();
                            while (dr.Read())
                            {
                                ExportAttachments Photos = new ExportAttachments();
                                if (dr["IdTechnicalAssistanceReport"] != null)
                                {
                                    //Orders.Where(i => i.Id == Convert.ToInt64(dr["IdWarehousePurchaseOrder"].ToString())).FirstOrDefault();
                                    if (technicalservicereportsexport != null)
                                    {
                                        if (dr["IdTechnicalAssistanceReport"] != DBNull.Value)
                                        {
                                            Photos.IdTechnicalAssistanceReport = Convert.ToInt32(dr["IdTechnicalAssistanceReport"].ToString());
                                        }
                                        if (dr["AttachedFiles"] != DBNull.Value)
                                        {
                                            Photos.AttachedFiles = Convert.ToString(dr["AttachedFiles"].ToString());
                                        }
                                        if (dr["Year"] != DBNull.Value)
                                        {
                                            Photos.Year = Convert.ToString(dr["Year"].ToString());
                                        }
                                        if (dr["OfferCode"] != DBNull.Value)
                                        {
                                            Photos.OfferCode = Convert.ToString(dr["OfferCode"].ToString());
                                        }
                                        if (dr["QUE_Code"] != DBNull.Value)
                                        {
                                            Photos.QUE_Code = Convert.ToString(dr["QUE_Code"].ToString());
                                        }
                                        try
                                        {
                                            #region workingOrder
                                            // Get the folder path for the "Additional Information" directory
                                            string workingOrder = WorkingOrdersPath
                                                                  .Replace("{0}", Plant)
                                                                  .Replace("{1}", Photos.Year)
                                                                  .Replace("{2}", Photos.QUE_Code)
                                                                  + @"Additional Information\";

                                            if (Directory.Exists(workingOrder))
                                            {
                                                string[] validExtensions = { ".jpg", ".jpeg", ".png", ".gif", ".bmp" };
                                                var allFiles = Directory.GetFiles(workingOrder);
                                                var imageFiles = new List<string>();
                                                string[] attachedFiles = Photos.AttachedFiles.Split(';');
                                                foreach (var filePath in allFiles)
                                                {
                                                    string fileExtension = Path.GetExtension(filePath).ToLower();
                                                    string fileName = Path.GetFileName(filePath);

                                                    // Check if the file has a valid image extension
                                                    if (validExtensions.Contains(fileExtension))
                                                    {
                                                        if (attachedFiles.Any(a => a.Trim().ToLower().Equals(fileName.Trim().ToLower())))
                                                        {
                                                            imageFiles.Add(filePath); // Valid image file, add to the list
                                                        }
                                                    }
                                                    else
                                                    {
                                                        // Invalid file extension, log an error
                                                        errormessage.code = "735";
                                                        errormessage.info = $"Invalid file extension - {fileName}";
                                                        // You might want to continue processing or break out of the loop depending on your requirements.
                                                    }
                                                }

                                                // Store valid image file names in the ImagePaths list
                                                Photos.ImagePaths.AddRange(imageFiles);
                                            }
                                            else
                                            {
                                                errormessage.code = "734";
                                                errormessage.info = $"Directory not found - {workingOrder}";
                                            }
                                            #endregion
                                        }
                                        catch (Exception ex)
                                        {
                                            Log4NetLogger.Logger.Log(string.Format("Error ExportTechnicalAssistanceReport(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                                        }
                                        technicalservicereportsexport._PhotoslogItemsLst.Add(Photos);
                                    }
                                }
                            }
                        }
                        #endregion

                        if (dr.NextResult())
                        {
                            while (dr.Read())
                            {
                                if (dr["IdOTItem"] != null)
                                {

                                    technicalservicereportsexport._IdOTItem = dr["IdOTItem"].ToString();
                                    if (dr["Abbreviation_In_OTI_AttachedFiles"] != DBNull.Value)
                                    {
                                        string abbreviation = dr["Abbreviation_In_OTI_AttachedFiles"].ToString();
                                        if (technicalservicereportsexport.Attachment1 == null)
                                        {
                                            technicalservicereportsexport.Attachment1 = abbreviation;
                                        }
                                        else if (technicalservicereportsexport.Attachment2 == null)
                                        {
                                            technicalservicereportsexport.Attachment2 = abbreviation;
                                        }
                                        else if (technicalservicereportsexport.Attachment3 == null)
                                        {
                                            technicalservicereportsexport.Attachment3 = abbreviation;
                                        }
                                        else if (technicalservicereportsexport.Attachment4 == null)
                                        {
                                            technicalservicereportsexport.Attachment4 = abbreviation;
                                        }
                                    }
                                }
                            }
                        }

                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method ExportTechnicalAssistanceReport()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error ExportTechnicalAssistanceReport(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            Workbook workbook = new Workbook();
            #region CultureInfo
            if (technicalservicereportsexport != null)
            {
                string cultureByPlantOwnerAndISO = GetCultureByPlantOwner(Plant, siteConnectionString);
                string CultureByPlantOwner = string.Empty;
                if (!string.IsNullOrEmpty(cultureByPlantOwnerAndISO))
                {
                    CultureByPlantOwner = Lang.ToLower() + "-" + cultureByPlantOwnerAndISO;
                }
                if (!Lang.ToLower().Equals("en"))
                {
                    if (getLanguage != null)
                    {
                        CultureInfo myCIintl = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName, true);
                        workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName);
                    }
                    else
                    {
                        CultureInfo myCIintl = new CultureInfo("en-GB", true);
                        workbook.Options.Culture = new CultureInfo("en-GB");
                    }
                }
                else
                {
                    #region CultureInfo
                    List<CultureInfo> culture = CultureInfo.GetCultures(CultureTypes.AllCultures).Where<CultureInfo>(c => c.Name.EndsWith(CultureByPlantOwner)).ToList();
                    if (culture != null && culture.Count > 0)
                    {
                        workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(CultureByPlantOwner) ? "en-GB" : CultureByPlantOwner);
                    }
                    else
                    {
                        string plantName = cultureByPlantOwnerAndISO;
                        List<CultureInfo> ifCultureNotexist = CultureInfo.GetCultures(CultureTypes.AllCultures).Where<CultureInfo>(c => c.Name.EndsWith(plantName)).ToList();
                        Languages setCulture = null;
                        if (ifCultureNotexist.Count() == 1)
                        {
                            setCulture = new Emdep.Geos.Data.Common.Languages();
                            setCulture.CultureName = ifCultureNotexist[0].Name;
                        }
                        else
                        {
                            foreach (var item in ifCultureNotexist)
                            {
                                setCulture = Languages.Where(s => s.TwoLetterISOLanguage.Equals(item.Parent.Name)).FirstOrDefault();
                                if (setCulture != null)
                                {
                                    setCulture.CultureName = item.Name;
                                    break;
                                }
                            }
                        }

                        if (setCulture != null)
                        {
                            CultureInfo myCIintl = new CultureInfo(string.IsNullOrEmpty(setCulture.CultureName) ? "en-GB" : setCulture.CultureName, true);
                            if (myCIintl != null)
                            {
                                workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(setCulture.CultureName) ? "en-GB" : setCulture.CultureName);
                            }

                        }
                        else
                        {
                            if (getLanguage != null)
                            {
                                CultureInfo myCIintl = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName, true);
                                workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName);
                            }
                            else
                            {
                                CultureInfo myCIintl = new CultureInfo("en-GB", true);
                                workbook.Options.Culture = new CultureInfo("en-GB");
                            }

                        }

                    }
                    #endregion

                }

            }
            #endregion
            byte[] excelTemplateInByte = ExportTechnicalReport(Convert.ToInt32(IdTechnicalAssistanceReport), TechnicalAssistanceReportTemplatePath);
            if (excelTemplateInByte == null)
            {
                throw new FileNotFoundException("File does not exist or File is open - " + TechnicalAssistanceReportTemplatePath);
            }
            workbook.LoadDocument(excelTemplateInByte, DocumentFormat.Xlsx);
            Worksheet wsDl = workbook.Worksheets[3];
            string filenameExcel = null;
            string filenamePDF = null;
            if (!string.IsNullOrEmpty(technicalservicereportsexport._ReportDate))
            {
                DateTime ReportDate = DateTime.Parse(technicalservicereportsexport._ReportDate, CultureInfo.CurrentCulture);
                string ReportDates = string.Concat(ReportDate.Year, ReportDate.Month.ToString().PadLeft(2, '0'), ReportDate.Day.ToString().PadLeft(2, '0'));
            }
            string updatedExcelFilePath = TechnicalAssistanceReportPath.Replace("{0}", Plant);
            updatedExcelFilePath = updatedExcelFilePath.Replace("{YEAR}", technicalservicereportsexport._Year);
            // updatedExcelFilePath = updatedExcelFilePath.Replace("{PO_Number}", technicalservicereportsexport._ReportCode);
            // updatedExcelFilePath = updatedExcelFilePath + @"\";
            updatedExcelFilePath = updatedExcelFilePath + @"\" + technicalservicereportsexport._ReportCode + @"\";
            if (!System.IO.Directory.Exists(updatedExcelFilePath))
            {
                System.IO.Directory.CreateDirectory(updatedExcelFilePath);
            }
            //string search = "TR_" + technicalservicereportsexport._ReportCode + ".*";
            string search = technicalservicereportsexport._ReportCode + ".*";

            FileInfo[] files = new DirectoryInfo(updatedExcelFilePath + "\\")
            .GetFiles(search)
            .OrderBy(f => f.CreationTime)
            .ToArray();
            var allfiles = files.ToList();
            //filenameExcel = "TR_" + technicalservicereportsexport._ReportCode + ".xlsx";
            //filenamePDF = "TR_" + technicalservicereportsexport._ReportCode + ".pdf";
            filenamePDF = technicalservicereportsexport._ReportCode + ".pdf";
            filenameExcel = technicalservicereportsexport._ReportCode + ".xlsx";


            #region getIndexValue
            Int32 Index_OrderCode = 0;
            Int32 Index_ReportCode = 0;
            Int32 Index_ReportDate = 0;
            Int32 Index_TechnicianFullName = 0;
            Int32 Index_RequesterFullName = 0;
            Int32 Index_ContactFullName = 0;
            Int32 Index_ContactPhone = 0;
            Int32 Index_ContactEmail = 0;
            Int32 Index_CustomerGroup = 0;
            Int32 Index_CustomerPlant = 0;
            Int32 Index_CustomerCountry = 0;
            Int32 Index_Remarks = 0;
            Int32 Index_ServiceType1 = 0;
            Int32 Index_ServiceType2 = 0;
            Int32 Index_ServiceType3 = 0;
            Int32 Index_ServiceType4 = 0;
            Int32 Index_ServiceType5 = 0;
            Int32 Index_ServiceType6 = 0;
            Int32 Index_ServiceType7 = 0;
            Int32 Index_Attachment1 = 0;
            Int32 Index_Attachment2 = 0;
            Int32 Index_Attachment3 = 0;
            Int32 Index_Attachment4 = 0;
            Int32 Index_RFQ = 0; // soumitra.kulkarni[23/01/2025][APIGEOS-1335]

            #region chitra.girigosavi[24/04/2024]APIGEOS-1128 Add some missing information in the TechnicalService Report
            Int32 Index_Equipment1 = 0;
            string lblEquipment1 = string.Empty;
            #endregion
            Int32 Language = 0;

            #region Worklog
            Int32 WO_count = 0;
            Int32 Index_Jobs_StartRow = 0;
            string Index_Jobs_DateColumn = string.Empty;
            string Index_Jobs_TechnicianColumn = string.Empty;
            string Index_Jobs_StartColumn = string.Empty;
            string Index_Jobs_EndColumn = string.Empty;
            string Index_Jobs_TotalTimeColumn = string.Empty;    //chitra.girigosavi[19/08/2024][APIGEOS-1195]
            string Index_Jobs_TypeColumn = string.Empty; //chitra.girigosavi[19/08/2024][APIGEOS-1195]
            #endregion

            #endregion

            #region Parts
            Int32 PO_count = 0;
            Int32 Index_Parts_StartRow = 0;
            string Index_Parts_ReferenceColumn = string.Empty;
            string IndexParts_DescriptionColumn = string.Empty;
            string Index_Parts_QuantityColumn = string.Empty;

            #endregion

            #region getWorklogItemsValue  
            Int32 WO_counts = 0;
            Int32 Jobs_StartRow = 0;
            string Jobs_DateColumn = string.Empty;
            string Jobs_TechnicianColumn = string.Empty;
            string Jobs_StartColumn = string.Empty;
            string Jobs_EndColumn = string.Empty;
            string Jobs_TotalTimeColumn = string.Empty;
            string Jobs_TypeColumn = string.Empty; //chitra.girigosavi[19/08/2024][APIGEOS-1195]

            string WoJobs_lblColDate = string.Empty;
            string WoJobs_lblColTechnician = string.Empty;
            string WoJobs_lblColStart = string.Empty;
            string WoJobs_lblColEnd = string.Empty;
            string WoJobs_lblColTotalTime = string.Empty;
            string WoJobs_lblColType = string.Empty; //chitra.girigosavi[19/08/2024][APIGEOS-1195]

            #endregion


            #region getPartsValue
            Int32 PO_counts = 0;
            Int32 Parts_StartRow = 0;
            string Parts_ReferenceColumn = string.Empty;
            string Parts_DescriptionColumn = string.Empty;
            string Parts_QuantityColumn = string.Empty;


            string PaParts_lblColReference = string.Empty;
            string PaParts_lblColDescription = string.Empty;
            string PaParts_lblColQuantity = string.Empty;
            #endregion

            //chitra.girigosavi[19/08/2024][APIGEOS-1195]
            #region Photos
            Int32 Photos_count = 0;
            Int32 Index_Photos_StartRow = 0;
            string Index_Photos_AttachmentsColumn = string.Empty;
            #endregion

            #region getPhotosItemsValue  
            Int32 Photos_counts = 0;
            Int32 Photos_StartRow = 0;
            string Photos_AttachmentsColumn = string.Empty;

            #endregion

            Worksheet wsTranslations = workbook.Worksheets[4];
            #region getIndex
            for (int s = 0; s < 400; s++)
            {
                #region Worklog
                if ((wsTranslations.Cells[s, 0].Value.ToString() == "Jobs_lblColDate_" + Lang.ToLower()))
                {
                    WoJobs_lblColDate = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Jobs_lblColTechnician_" + Lang.ToLower()))
                {
                    WoJobs_lblColTechnician = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Jobs_lblColStart_" + Lang.ToLower()))
                {
                    WoJobs_lblColStart = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Jobs_lblColEnd_" + Lang.ToLower()))
                {
                    WoJobs_lblColEnd = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Jobs_lblColTotalTime_" + Lang.ToLower())) //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                {
                    WoJobs_lblColTotalTime = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Jobs_lblColType_" + Lang.ToLower())) //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                {
                    WoJobs_lblColType = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                #endregion

                #region Parts
                if ((wsTranslations.Cells[s, 0].Value.ToString() == "Parts_lblColReference_" + Lang.ToLower()))
                {
                    PaParts_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Parts_lblColDescription_" + Lang.ToLower()))
                {
                    PaParts_lblColDescription = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Parts_lblColQuantity_" + Lang.ToLower()))
                {
                    PaParts_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                #endregion

                #endregion
                #region getIndex Using switch                           
                switch (wsDl.Cells[s, 0].Value.ToString())
                {
                    case "Index_OrderCode":
                        Index_OrderCode = s;
                        break;
                    case "Index_RFQ":
                        Index_RFQ = s; // soumitra.kulkarni[23/01/2025][APIGEOS-1335]
                        break;
                    case "Index_ReportCode":
                        Index_ReportCode = s;
                        break;
                    case "Index_ReportDate":
                        Index_ReportDate = s;
                        break;
                    case "Index_TechnicianFullName":
                        Index_TechnicianFullName = s;
                        break;
                    case "Index_RequesterFullName":
                        Index_RequesterFullName = s;
                        break;
                    case "Index_ContactFullName":
                        Index_ContactFullName = s;
                        break;
                    case "Index_ContactPhone":
                        Index_ContactPhone = s;
                        break;
                    case "Index_ContactEmail":
                        Index_ContactEmail = s;
                        break;
                    case "Index_CustomerGroup":
                        Index_CustomerGroup = s;
                        break;
                    case "Index_CustomerPlant":
                        Index_CustomerPlant = s;
                        break;
                    case "Index_CustomerCountry":
                        Index_CustomerCountry = s;
                        break;
                    case "Index_ServiceType1":
                        Index_ServiceType1 = s;
                        break;
                    case "Index_ServiceType2":
                        Index_ServiceType2 = s;
                        break;
                    case "Index_ServiceType3":
                        Index_ServiceType3 = s;
                        break;
                    case "Index_ServiceType4":
                        Index_ServiceType4 = s;
                        break;
                    case "Index_ServiceType5":
                        Index_ServiceType5 = s;
                        break;
                    case "Index_ServiceType6":
                        Index_ServiceType6 = s;
                        break;
                    case "Index_ServiceType7":
                        Index_ServiceType7 = s;
                        break;
                    case "Index_Attachment1":
                        Index_Attachment1 = s;
                        break;
                    case "Index_Attachment2":
                        Index_Attachment2 = s;
                        break;
                    case "Index_Attachment3":
                        Index_Attachment3 = s;
                        break;
                    case "Index_Attachment4":
                        Index_Attachment4 = s;
                        break;

                    #region Worklogs
                    case "Index_Jobs_StartRow":
                        WO_counts = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        Index_Jobs_StartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        break;

                    case "Index_Jobs_DateColumn":
                        Index_Jobs_DateColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Index_Jobs_TechnicianColumn":
                        Index_Jobs_TechnicianColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Index_Jobs_StartColumn":
                        Index_Jobs_StartColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Index_Jobs_EndColumn":
                        Index_Jobs_EndColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Index_Jobs_TotalTimeColumn":    //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                        Index_Jobs_TotalTimeColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;

                    case "Index_Jobs_TypeColumn":   //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                        Index_Jobs_TypeColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    #endregion

                    #region Parts
                    case "Index_Parts_StartRow":
                        PO_counts = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        Index_Parts_StartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        break;

                    case "Index_Parts_ReferenceColumn":
                        Index_Parts_ReferenceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "IndexParts_DescriptionColumn":
                        IndexParts_DescriptionColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Index_Parts_QuantityColumn":
                        Index_Parts_QuantityColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;

                    #region chitra.girigosavi[24/04/2024]APIGEOS-1128 Add some missing information in the TechnicalService Report
                    case "Index_Equipment1":
                        Index_Equipment1 = s;
                        break;
                    #endregion
                    #endregion


                    case "Language":
                        Language = s;
                        break;
                    case "Index_Remarks":
                        Index_Remarks = s;
                        break;
                    default:
                        break;

                    #region Worklog_Item  
                    case "Jobs_StartRow":                                                       //[001][kshinde][APIGEOS-586][16/08/2022] 
                        WO_counts = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        Jobs_StartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Jobs_DateColumn":
                        Jobs_DateColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Jobs_TechnicianColumn":
                        Jobs_TechnicianColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Jobs_StartColumn":
                        Jobs_StartColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Jobs_EndColumn":
                        Jobs_EndColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Jobs_TotalTimeColumn":
                        Jobs_TotalTimeColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;

                    case "Jobs_TypeColumn": //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                        Jobs_TypeColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    #endregion

                    #region Parts_Item  
                    case "Parts_StartRow":                                                       //[001][kshinde][APIGEOS-586][16/08/2022] 
                        PO_counts = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        Parts_StartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Parts_ReferenceColumn":
                        Parts_ReferenceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Parts_DescriptionColumn":
                        Parts_DescriptionColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Parts_QuantityColumn":
                        Parts_QuantityColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    #endregion
                    #region Photos
                    case "Photos_StartRow":                                                       //[001][kshinde][APIGEOS-586][16/08/2022] 
                        Photos_counts = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        Photos_StartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Photos_AttachmentsColumn":
                        Photos_AttachmentsColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                        #endregion
                }
                #endregion

            }


            using (stream = new FileStream(Path.Combine(updatedExcelFilePath, filenameExcel), FileMode.Create, FileAccess.ReadWrite))
            {
                cultureInfo = new CultureInfo(workbook.Options.Culture.Name);
                #region Set CultureInfo ReportDate
                if (!String.IsNullOrEmpty(technicalservicereportsexport._ReportDate))
                {
                    DateTime dt = DateTime.Parse(technicalservicereportsexport._ReportDate, CultureInfo.CurrentCulture);
                    wsDl.Cells[Index_ReportDate, 1].Value = dt.ToString(cultureInfo.DateTimeFormat.ShortDatePattern, cultureInfo);
                }
                else
                {
                    wsDl.Cells[Index_ReportDate, 1].Value = technicalservicereportsexport._ReportDate;
                }
                #endregion


                #region Set CultureInfo ReportDate
                if (!String.IsNullOrEmpty(technicalservicereportsexport._ReportDate))
                {
                    DateTime dt = DateTime.Parse(technicalservicereportsexport._ReportDate, CultureInfo.CurrentCulture);
                    DateTime dateOnly = dt.Date;
                    wsDl.Cells[Index_ReportDate, 1].Value = dateOnly.ToString(cultureInfo.DateTimeFormat.ShortDatePattern, cultureInfo);
                }
                else
                {
                    wsDl.Cells[Index_ReportDate, 1].Value = technicalservicereportsexport._ReportDate;
                }
                #endregion
                wsDl.Cells[Index_OrderCode, 1].Value = technicalservicereportsexport._OrderCode;
                wsDl.Cells[Index_ReportCode, 1].Value = technicalservicereportsexport._ReportCode;
                wsDl.Cells[Index_TechnicianFullName, 1].Value = technicalservicereportsexport._TechnicianFullName;
                wsDl.Cells[Index_RequesterFullName, 1].Value = technicalservicereportsexport._RequesterFullName;
                wsDl.Cells[Index_ContactFullName, 1].Value = technicalservicereportsexport._ContactFullName;
                wsDl.Cells[Index_ContactPhone, 1].Value = technicalservicereportsexport._ContactPhone;
                wsDl.Cells[Index_ContactEmail, 1].Value = technicalservicereportsexport._ContactEmail;
                wsDl.Cells[Index_CustomerGroup, 1].Value = technicalservicereportsexport._CustomerGroup;
                wsDl.Cells[Index_CustomerPlant, 1].Value = technicalservicereportsexport._CustomerPlant;
                wsDl.Cells[Index_CustomerCountry, 1].Value = technicalservicereportsexport._CustomerCountry;
                wsDl.Cells[Index_Remarks, 1].Value = technicalservicereportsexport._Remarks;
                wsDl.Cells[Index_ServiceType1, 1].Value = technicalservicereportsexport._ServiceType1;
                wsDl.Cells[Index_ServiceType2, 1].Value = technicalservicereportsexport._ServiceType2;
                wsDl.Cells[Index_ServiceType3, 1].Value = technicalservicereportsexport._ServiceType3;
                wsDl.Cells[Index_RFQ, 1].Value = technicalservicereportsexport._RFQ; //// soumitra.kulkarni[23/01/2025][APIGEOS-1335]

                wsDl.Cells[Index_ServiceType4, 1].Value = technicalservicereportsexport._ServiceType4;
                wsDl.Cells[Index_ServiceType5, 1].Value = technicalservicereportsexport._ServiceType5;
                wsDl.Cells[Index_ServiceType6, 1].Value = technicalservicereportsexport._ServiceType6;
                wsDl.Cells[Index_ServiceType7, 1].Value = technicalservicereportsexport._ServiceType7;
                wsDl.Cells[Index_Attachment1, 1].Value = technicalservicereportsexport.Attachment1;
                wsDl.Cells[Index_Attachment2, 1].Value = technicalservicereportsexport.Attachment2;
                wsDl.Cells[Index_Attachment3, 1].Value = technicalservicereportsexport.Attachment3;
                wsDl.Cells[Index_Attachment4, 1].Value = technicalservicereportsexport.Attachment4;

                #region chitra.girigosavi[24/04/2024]APIGEOS-1128 Add some missing information in the TechnicalService Report
                //wsDl.Cells[Index_Equipment1, 1].Value = technicalservicereportsexport.CarProjectName + "-" + technicalservicereportsexport.caroems_Name + ";" +
                //                    technicalservicereportsexport.OfferCode + ";" + technicalservicereportsexport.Category1 + "-" + technicalservicereportsexport.Category2 + ";";

                string carInfo = string.IsNullOrWhiteSpace(technicalservicereportsexport.CarProjectName) ?
                 "" :
                 technicalservicereportsexport.CarProjectName + "-" + technicalservicereportsexport.caroems_Name;

                string categoryInfo = string.IsNullOrWhiteSpace(technicalservicereportsexport._IdProductSubCategory) ?
                                      "" :
                                      technicalservicereportsexport.Category1 + "-" + technicalservicereportsexport.Category2;

                string valueToSet = carInfo + ";" + technicalservicereportsexport.OfferCode + ";" + categoryInfo + ";";

                wsDl.Cells[Index_Equipment1, 1].Value = valueToSet;
                #endregion

                wsDl.Cells[Language, 1].Value = Lang.ToLower();
                // workbook.Worksheets[2].Visible = false;
                #region ExportExpensesListItems       
                if (technicalservicereportsexport._WorklogItemsLst != null && technicalservicereportsexport._WorklogItemsLst.Count > 0)
                {
                    Int32 Expenses_ItemsHeadingStartRow = Convert.ToInt32(WO_counts) - 1;
                    // Index_Jobs_StartRow = Convert.ToString(WO_counts) - 1;
                    Worksheet wsDlExpensesItems = workbook.Worksheets[1];
                    wsDlExpensesItems.Cells[Jobs_DateColumn + (Jobs_StartRow - 1)].Value = WoJobs_lblColDate;
                    wsDlExpensesItems.Cells[Jobs_TechnicianColumn + (Jobs_StartRow - 1)].Value = WoJobs_lblColTechnician;
                    wsDlExpensesItems.Cells[Jobs_StartColumn + (Jobs_StartRow - 1)].Value = WoJobs_lblColStart;
                    wsDlExpensesItems.Cells[Jobs_EndColumn + (Jobs_StartRow - 1)].Value = WoJobs_lblColEnd;
                    wsDlExpensesItems.Cells[Jobs_TotalTimeColumn + (Jobs_StartRow - 1)].Value = WoJobs_lblColTotalTime;
                    wsDlExpensesItems.Cells[Jobs_TypeColumn + (Jobs_StartRow - 1)].Value = WoJobs_lblColType; //chitra.girigosavi[19/08/2024][APIGEOS-1195]


                    if (technicalservicereportsexport._WorklogItemsLst.Count > 1)
                        wsDlExpensesItems.Rows.Insert(Expenses_ItemsHeadingStartRow + 1, technicalservicereportsexport._WorklogItemsLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                    if (technicalservicereportsexport._WorklogItemsLst != null)
                        foreach (ExportWorkLogs item in technicalservicereportsexport._WorklogItemsLst)
                        {
                            if (item != null)
                            {
                                wsDlExpensesItems.Cells[Jobs_DateColumn + Jobs_StartRow].Value = item.WorklogDate;
                                wsDlExpensesItems.Cells[Jobs_TechnicianColumn + Jobs_StartRow].Value = item.TechnicianName;
                                wsDlExpensesItems.Cells[Jobs_StartColumn + Jobs_StartRow].Value = item.StartTime;
                                wsDlExpensesItems.Cells[Jobs_EndColumn + Jobs_StartRow].Value = item.EndTime;
                                wsDlExpensesItems.Cells[Jobs_TypeColumn + Jobs_StartRow].Value = item.Type; //chitra.girigosavi[19/08/2024][APIGEOS-1195]
                            }
                            Jobs_StartRow = Jobs_StartRow + 1;
                        }
                    wsDlExpensesItems.Cells[Jobs_DateColumn + Jobs_StartRow].Value = null;
                    wsDlExpensesItems.Cells[Jobs_TechnicianColumn + Jobs_StartRow].Value = null;
                    wsDlExpensesItems.Cells[Jobs_StartColumn + Jobs_StartRow].Value = null;
                    wsDlExpensesItems.Cells[Jobs_EndColumn + Jobs_StartRow].Value = null;
                    wsDlExpensesItems.Cells[Jobs_TypeColumn + Jobs_StartRow].Value = null; //chitra.girigosavi[19/08/2024][APIGEOS-1195]

                }
                else
                {
                    workbook.Worksheets[1].Visible = false;
                }
                // Added parts
                if (technicalservicereportsexport._PartslogItemsLst != null && technicalservicereportsexport._PartslogItemsLst.Count > 0)
                {
                    Int32 Expenses_ItemsHeadingStartRow = Convert.ToInt32(PO_counts) - 1;
                    // Index_Jobs_StartRow = Convert.ToString(WO_counts) - 1;
                    Worksheet wsDlExpensesItems = workbook.Worksheets[2];
                    wsDlExpensesItems.Cells[Parts_ReferenceColumn + (Parts_StartRow - 1)].Value = PaParts_lblColReference;
                    wsDlExpensesItems.Cells[Parts_DescriptionColumn + (Parts_StartRow - 1)].Value = PaParts_lblColDescription;
                    wsDlExpensesItems.Cells[Parts_QuantityColumn + (Parts_StartRow - 1)].Value = PaParts_lblColQuantity;

                    if (technicalservicereportsexport._PartslogItemsLst.Count > 1)
                        wsDlExpensesItems.Rows.Insert(Expenses_ItemsHeadingStartRow + 1, technicalservicereportsexport._PartslogItemsLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                    if (technicalservicereportsexport._PartslogItemsLst != null)
                        foreach (ExportParts item in technicalservicereportsexport._PartslogItemsLst)
                        {
                            if (item != null)
                            {
                                wsDlExpensesItems.Cells[Parts_ReferenceColumn + Parts_StartRow].Value = item.Reference;
                                wsDlExpensesItems.Cells[Parts_DescriptionColumn + Parts_StartRow].Value = item.Description;
                                wsDlExpensesItems.Cells[Parts_QuantityColumn + Parts_StartRow].Value = item.Quantity;
                            }
                            Parts_StartRow = Parts_StartRow + 1;
                        }
                    wsDlExpensesItems.Cells[Parts_ReferenceColumn + Parts_StartRow].Value = null;
                    wsDlExpensesItems.Cells[Parts_DescriptionColumn + Parts_StartRow].Value = null;
                    wsDlExpensesItems.Cells[Parts_QuantityColumn + Parts_StartRow].Value = null;

                }
                else
                {
                    workbook.Worksheets[2].Visible = false;
                }
                //End
                #region
                bool iSPhotos = false;
                try
                {
                    #region Photos
                    // Added Photos
                    if (technicalservicereportsexport._PhotoslogItemsLst != null && technicalservicereportsexport._PhotoslogItemsLst.Count > 0)                                                        //[001][kshinde][APIGEOS-586][16/08/2022]
                    {
                        Int32 Expenses_ItemsHeadingStartRow = Convert.ToInt32(Photos_counts) - 1;
                        //Index_Jobs_StartRow = Convert.ToString(WO_counts) - 1;
                        Worksheet wsDlExpensesItems = workbook.Worksheets[5];
                        createFolderName = System.IO.Path.GetTempPath() + @"\TechnicalAssistanceReport\";
                        imagesToPDFConverter = IdTechnicalAssistanceReport + "_" + technicalservicereportsexport._ReportCode + ".pdf";
                        IsFileGenerated = false;
                        try
                        {
                            if (!System.IO.Directory.Exists(createFolderName))
                            {
                                System.IO.Directory.CreateDirectory(createFolderName);
                            }
                        }
                        catch (Exception) { }
                        List<string> ImagePaths = new List<string>();
                        if (technicalservicereportsexport._PhotoslogItemsLst.Count > 1)
                            wsDlExpensesItems.Rows.Insert(Expenses_ItemsHeadingStartRow + 1, technicalservicereportsexport._PhotoslogItemsLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                        if (technicalservicereportsexport._PhotoslogItemsLst != null)
                            foreach (ExportAttachments item in technicalservicereportsexport._PhotoslogItemsLst)
                            {
                                if (item.ImagePaths != null)
                                {
                                    //foreach (string imagePath in item.ImagePaths)
                                    //{
                                    //    ImagePaths.Add(imagePath);
                                    //}
                                    #region item.ImagePaths
                                    foreach (string imagePath in item.ImagePaths)
                                    {
                                        try
                                        {
                                            // Load the image from a file path
                                            System.Drawing.Image img = System.Drawing.Image.FromFile(imagePath);

                                            // Load the image from file
                                            using (FileStream fs = new FileStream(imagePath, FileMode.Open, FileAccess.Read))
                                            {
                                                System.Drawing.Image image = System.Drawing.Image.FromStream(fs);

                                                // Add the picture to the specified cell
                                                //var picture = wsDlExpensesItems.Pictures.AddPicture(image, wsDlExpensesItems.Cells[Photos_AttachmentsColumn + Photos_StartRow]);
                                                //// Set the picture's position and size
                                                //picture.TopLeftCell = wsDlExpensesItems.Cells[Photos_AttachmentsColumn + Photos_StartRow];
                                                //picture.BottomRightCell = wsDlExpensesItems.Cells[Photos_AttachmentsColumn + Photos_StartRow]; // Adjust as needed
                                                var picture = wsDlExpensesItems.Pictures.AddPicture(image, wsDlExpensesItems.Cells[Photos_AttachmentsColumn + Photos_StartRow]);

                                                // Set the picture's position and size with margins
                                                int marginTop = 15;    // Set your desired top margin
                                                int marginBottom = 15; // Set your desired bottom margin
                                                int marginLeft = 15;      // Set your desired left margin
                                                int marginRight = 15;     // Set your desired right margin

                                                // Set the top-left and bottom-right cells for the image
                                                picture.TopLeftCell = wsDlExpensesItems.Cells[Photos_AttachmentsColumn + Photos_StartRow];
                                                picture.Top = picture.Top + marginTop;  // Add top margin

                                                // Adjust the left margin
                                                picture.Left = picture.Left + marginLeft;

                                                // Set the bottom-right cell and adjust bottom margin
                                                picture.BottomRightCell = wsDlExpensesItems.Cells[Photos_AttachmentsColumn + Photos_StartRow];
                                                picture.Height = picture.Height - marginBottom; // Adjust bottom margin
                                                // Optionally, you can adjust the width or horizontal margins if needed.
                                                // Adjust the width for the right margin
                                                picture.Width = picture.Width - marginRight;
                                            }
                                        }
                                        catch (Exception ex)
                                        {

                                        }
                                        // Move to the next row for the next image
                                        Photos_StartRow += 1;
                                        iSPhotos = true;
                                    }
                                    #endregion
                                }
                            }
                    }
                    else
                    {
                        workbook.Worksheets[5].Visible = false;
                    }
                    //End
                    #endregion
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                }
                #endregion
                #endregion
                if (iSPhotos == false)
                {
                    workbook.Worksheets[5].Visible = false;
                }
                workbook.Worksheets[3].Visible = false;
                workbook.Worksheets[4].Visible = false;
                workbook.SaveDocument(stream, DocumentFormat.Xlsx);
                isDone = true;
            }
            string originalPdfFilePath = Path.Combine(updatedExcelFilePath, filenamePDF);
            PdfExportOptions pdfOptions = new PdfExportOptions
            {
                // DocumentOptions = { Title = "Exported Excel to PDF" },
                ConvertImagesToJpeg = true
            };
            try
            {
                workbook = new Workbook();
                string searchPattern = "*.xlsx";
                string fileNameToMatch = technicalservicereportsexport._ReportCode;
                // Get all files matching the search pattern in the folder and its subfolders
                string[] GetFiles = Directory.GetFiles(updatedExcelFilePath, searchPattern, SearchOption.AllDirectories);
                // Get all files matching the search pattern in the folder
                //string[] GetFiles = Directory.GetFiles(updatedExcelFilePath, searchPattern);
                string[] matchingFiles = GetFiles.Where(file => Path.GetFileNameWithoutExtension(file).Equals(fileNameToMatch, StringComparison.OrdinalIgnoreCase)).ToArray();
                workbook.LoadDocument(matchingFiles.FirstOrDefault());
                workbook.ExportToPdf(originalPdfFilePath, pdfOptions);

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
            }
            workbook.Dispose();
            if (stream != null)
            {
                stream.Dispose();
            }
            return isDone;
        }

    }

    public class OpportunityManager
    {
        string _ConnString;
        private string username;
        public static string Password;
        static string loginUsername;
        public static string login;
        public OpportunityManager(string ConnString)
        {
            this._ConnString = ConnString;
            //if (Log4NetLogger.Logger == null)
            //{
            //    string ApplicationLogFilePath = System.Web.Hosting.HostingEnvironment.MapPath("/") + "log4net.config";
            //    FileInfo file = new FileInfo(ApplicationLogFilePath);
            //    Log4NetLogger.Logger = LoggerFactory.CreateLogger(LogType.Log4Net, file);
            //}
        }
        public OpportunityManager(string username, string password)
        {
            this.username = username;
            loginUsername = username;
            Password = password;
            login = username;
        }
        #region Sales/Opportunities/Create
        public async Task<CreateOfferReturn> AddOffer(string PlantOwner, CreateOpportunityModel offer, string mainserverConnectionString, string LoginContext, string CommercialQuotationsPath, string WorkingOrdersPath, string Plantwiseconnectionstring, byte[] fileData = null, string fileName = null)
        {

            #region chitra.girigosavi[APIGEOS-1254]04/11/2024
            OpportunityManager offerManager = new OpportunityManager(LoginContext);
            string username = offer.login;
            Int64 idUser = offerManager.GetUserId(username, LoginContext);
            #endregion

            CreateOfferReturn CreateOfferReturn = new CreateOfferReturn();
            Int64 offerId = 0;
            Int64 idSite = 0;
            if (offer.type.ToUpper() == "OT")
            {
                offer.IdOfferType = 1;
            }
            else if (offer.type.ToUpper() == "OP")
            {
                offer.IdOfferType = 10;
            }
            offer.idSiteWhereCreated = IsEMDEPSiteExist(PlantOwner, mainserverConnectionString);
            //offer.OfferCode = MakeOfferCode(offer.type.ToUpper(), Convert.ToInt64(offer.idSiteWhereCreated), mainserverConnectionString, Plantwiseconnectionstring);
            //chitra.girigosavi[14/11/2024][APIGEOS-1274]
            //Shubham[skadam] GEOS2-8040 Duplicate offer code in CRM 21 05 2025
            Int64 offerNumber = GetNextNumberOfOfferFromCounters((byte)offer.IdOfferType, mainserverConnectionString);
            offer.OfferCode = MakeOfferCode(offer.type.ToUpper(), Convert.ToInt64(offer.idSiteWhereCreated), mainserverConnectionString, Plantwiseconnectionstring);
            if (offer.type.ToUpper() == "OT")
            {
                offer.IdOfferType = 1;
                UpdateNextOfferNumberToCounters(1, mainserverConnectionString);
            }
            else if (offer.type.ToUpper() == "OP")
            {
                offer.IdOfferType = 10;
                UpdateNextOfferNumberToCounters(10, mainserverConnectionString);
            }
            /*
            //chitra.girigosavi[14/11/2024][APIGEOS-1274]
            Int64 offerNumber = GetNextNumberOfOfferFromCounters((byte)offer.IdOfferType, mainserverConnectionString);
            offer.OfferCode = MakeOfferCode(offer.type.ToUpper(), Convert.ToInt64(offer.idSiteWhereCreated), mainserverConnectionString, Plantwiseconnectionstring);
            */
            string OfferConnectionString = GetSiteConnectionString(Convert.ToInt64(offer.idSiteWhereCreated), mainserverConnectionString, Plantwiseconnectionstring);

            #region Remove_any_illegal_character_in_field_Title
            //https://helpdesk.emdep.com/browse/APIGEOS-410 Remove any illegal character in field Title using the endpoint Opportunities and Orders Create   09 02 2022
            string GetWindows_Forbidden_File_Characters = GetGEOSAppSetting("Windows_Forbidden_File_Characters", LoginContext);
            string GetWindows_Forbidden_File_Names = GetGEOSAppSetting("Windows_Forbidden_File_Names", LoginContext);
            List<string> Windows_Forbidden_File_Names = GetWindows_Forbidden_File_Names.Split(',').ToList();
            List<string> Windows_Forbidden_File_Characters = GetWindows_Forbidden_File_Characters.Split(';').ToList();
            Windows_Forbidden_File_Characters.Add(";");
            if (GetWindows_Forbidden_File_Characters != null && GetWindows_Forbidden_File_Characters != string.Empty)
            {
                foreach (var item in Windows_Forbidden_File_Characters)
                {
                    if (item != string.Empty)
                        offer.title = offer.title.Replace(item, "");
                }
            }
            //offer.title = Regex.Replace(offer.title, GetWindows_Forbidden_File_Characters, "");
            foreach (var item in Windows_Forbidden_File_Names)
            {
                if (item != string.Empty)
                    offer.title = offer.title.Replace(item, "");
            }
            offer.title = Regex.Replace(offer.title, @"\s+", " ");
            offer.title = offer.title.Trim().ToString();
            #endregion

            Int32 idCustomer = IsGroupExist(offer.company_group, mainserverConnectionString);
            SiteDetail SiteDetail = new SiteDetail();
            SiteDetail = IsPlantExist_V220(offer.company_plant, idCustomer, mainserverConnectionString);
            offer.siteDetail = SiteDetail;
            offer.IdCustomer = SiteDetail.IdSite;
            //Int64 offerNumber = GetNextNumberOfOfferFromCounters((byte)offer.IdOfferType, mainserverConnectionString);
            offer.OfferNumber = offerNumber;
            offer.IdCurrency = IsCurrencyExist(offer.amount_currency, OfferConnectionString);
            offer.IdCreatedBy = IsCreatedByExist(offer.created_by, LoginContext);
            offer.idStatus = GetStatusId(offer.status, mainserverConnectionString);
            offer.idSaleOwner = GetSaleOwnerExist(SiteDetail.IdSite, OfferConnectionString);
            offer.Description = offer.title;
            Int32 idBusineesUnit = IsBusinessUnitExist(offer.business_unit, LoginContext);
            Int32 idSource = IsSourceExist(offer.source, LoginContext);
            Int32 idOfferOwner = IsOfferOwnerExist(offer.offer_owner, OfferConnectionString);
            Int64 quotationNumDays = Convert.ToInt64(GetGEOSAppSetting("Quotation_Expiration_Days", LoginContext));
            int idItemOtStatus = GetOffer_Item_StatusByAppSettingName("Offer_Item_Status", LoginContext);
            TransactionScope transactionScope = null;
            using (transactionScope = new System.Transactions.TransactionScope(TransactionScopeOption.Required, TimeSpan.FromMinutes(10)))
            {
                try
                {
                    using (MySqlConnection conoffer = new MySqlConnection(OfferConnectionString))
                    {

                        conoffer.Open();
                        // To Add RFQ changed SP:-offers_Insert_Sprint59 in Sprint59
                        //MySqlCommand conoffercommand = new MySqlCommand("GEOSAPI_AddOffer_V230", conoffer);
                        //MySqlCommand conoffercommand = new MySqlCommand("GEOSAPI_AddOffer_V280", conoffer);
                        //MySqlCommand conoffercommand = new MySqlCommand("GEOSAPI_AddOffer_V290", conoffer);
                        // MySqlCommand conoffercommand = new MySqlCommand("GEOSAPI_AddOffer_V320", conoffer);//   -- Created by shubham[skadam] for APIGEOS-290  endpoint SALES->OPPORTUNITIES->Create service to support Technical service reporter  https://helpdesk.emdep.com/browse/APIGEOS-290   DATE 30 08 2021
                        //MySqlCommand conoffercommand = new MySqlCommand("GEOSAPI_AddOffer_V330", conoffer);//Created by shubham[skadam] for APIGEOS-294 AND APIGEOS-337  endpoint SALES->OPPORTUNITIES->Create AND SALES->ORDERS->Create  DATE 16 06 2021
                        //MySqlCommand conoffercommand = new MySqlCommand("GEOSAPI_AddOffer_V760", conoffer);//chitra.girigosavi[APIGEOS-1254]04/11/2024
                        MySqlCommand conoffercommand = new MySqlCommand("GEOSAPI_AddOffer_V780", conoffer);//updatedby chitra.girigosavi[APIGEOS-1279][26/12/2024]
                        conoffercommand.CommandType = CommandType.StoredProcedure;
                        conoffercommand.Parameters.AddWithValue("_Code", offer.OfferCode);
                        conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                        conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                        conoffercommand.Parameters.AddWithValue("_IdProject", null);
                        conoffercommand.Parameters.AddWithValue("_Title", offer.title);
                        conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                        conoffercommand.Parameters.AddWithValue("_IdStatus", offer.idStatus);
                        conoffercommand.Parameters.AddWithValue("_Amount", offer.amount_value);
                        conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.confidence_level);
                        conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.close_date);
                        conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                        conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                        conoffercommand.Parameters.AddWithValue("_Number", offerNumber);
                        conoffercommand.Parameters.AddWithValue("_CreatedBy", offer.IdCreatedBy);
                        conoffercommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                        conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.IdCreatedBy);
                        conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.close_date);
                        conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", idBusineesUnit);
                        conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.idSaleOwner);
                        conoffercommand.Parameters.AddWithValue("_IdCarOEM", null);
                        conoffercommand.Parameters.AddWithValue("_IdSource", idSource);
                        conoffercommand.Parameters.AddWithValue("_RFQReception", offer.rfq_reception_date);
                        conoffercommand.Parameters.AddWithValue("_SendIn", offer.quote_sent_date);
                        conoffercommand.Parameters.AddWithValue("_IdCarProject", null);
                        conoffercommand.Parameters.AddWithValue("_RFQ", (offer.rfq == null ? string.Empty : offer.rfq));
                        conoffercommand.Parameters.AddWithValue("_OfferedBy", idOfferOwner);
                        conoffercommand.Parameters.AddWithValue("_Comments", offer.comments);
                        conoffercommand.Parameters.AddWithValue("_IdSite", offer.idSiteWhereCreated);
                        conoffercommand.Parameters.AddWithValue("_IdReporterSource", idUser);   //chitra.girigosavi[APIGEOS-1254]04/11/2024
                        conoffercommand.Parameters.AddWithValue("_ValidityWeeks", offer.validity_weeks);    //added by chitra.girigosavi[APIGEOS-1279][26/12/2024]

                        if (offer.Idincoterm > 0)
                        {
                            conoffercommand.Parameters.AddWithValue("_IdIncoterm", offer.Idincoterm);
                        }
                        else
                        {
                            conoffercommand.Parameters.AddWithValue("_IdIncoterm", null);
                        }
                        if (offer.discount > 0)
                        {
                            //string f= offer.discount.ToString("f1");
                            //string value = offer.discount.ToString("#.#");
                            //double result = Math.Round(offer.discount, 1);
                            //string thevalue = String.Format("{0:0.0}", offer.discount);
                            //var no = Math.Round(offer.discount, 1, MidpointRounding.AwayFromZero);
                            //var no1 = Math.Round(offer.discount, 1, MidpointRounding.ToEven);
                            //var no2 = Math.Truncate(offer.discount * 10) / 10;
                            //var no3 = Math.Truncate(offer.discount * 100) / 100;
                            //conoffercommand.Parameters.AddWithValue("_Discount", offer.discount.ToString("f1"));  
                            //conoffercommand.Parameters.AddWithValue("_Discount", Math.Truncate(offer.discount * 10) / 10);
                            conoffercommand.Parameters.AddWithValue("_Discount", offer.discount);
                        }
                        else
                        {
                            conoffercommand.Parameters.AddWithValue("_Discount", 0);
                        }
                        if (offer.IdReporterDepartment > 0)
                        {
                            conoffercommand.Parameters.AddWithValue("_IdReporterDepartment", offer.IdReporterDepartment);
                        }
                        else
                        {
                            conoffercommand.Parameters.AddWithValue("_IdReporterDepartment", null);
                        }
                        if (offer.IdReporterDevice > 0)
                        {
                            conoffercommand.Parameters.AddWithValue("_IdReporterDevice", offer.IdReporterDevice);
                        }
                        else
                        {
                            conoffercommand.Parameters.AddWithValue("_IdReporterDevice", null);
                        }

                        //  conoffercommand.Transaction = trans;
                        offerId = Convert.ToInt64(conoffercommand.ExecuteScalar());
                        conoffer.Close();

                        if (offerId > 0)
                        {
                            offer.IdOffer = offerId;

                            offer = AddQuotations_V2041(offer, OfferConnectionString, quotationNumDays, idItemOtStatus);
                            AddOfferContact(SiteDetail.IdCustomer, offer.offered_to, OfferConnectionString, offerId);

                            LogEntryByOffers contactCommentADD = new LogEntryByOffers()
                            {
                                idOffer = offer.IdOffer,
                                idUser = 164,
                                dateTime = DateTime.Now,
                                comments = "This offer has been created from the Geos API using the user " + username,
                                idLogEntryType = 13
                            };
                            if (offer.LstLogEntryByOffers == null)
                                offer.LstLogEntryByOffers = new List<LogEntryByOffers>();

                            offer.LstLogEntryByOffers.Add(contactCommentADD);

                            if (offer.offered_to != null)
                            {
                                foreach (OfferedToModel SelectedContact in offer.offered_to)
                                {


                                    LogEntryByOffers contactComment = new LogEntryByOffers()
                                    {
                                        idOffer = offer.IdOffer,
                                        idUser = 164,
                                        dateTime = DateTime.Now,
                                        comments = string.Format("{0} has been added as a OfferedTo.", GetOfferedToFullName(offer.siteDetail.IdCustomer, SelectedContact.contact_email, OfferConnectionString)),
                                        idLogEntryType = 13
                                    };
                                    if (offer.LstLogEntryByOffers == null)
                                        offer.LstLogEntryByOffers = new List<LogEntryByOffers>();

                                    offer.LstLogEntryByOffers.Add(contactComment);

                                }

                            }
                            AddLogEntryByOffer_V2040(offer, OfferConnectionString);
                            transactionScope.Complete();

                        }
                    }

                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();


                    throw;
                }
            }
            try
            {
                if (offerId > 0)
                {
                    AddActivityInOffer(offer, LoginContext, mainserverConnectionString);
                    CreateFolderOffer(offer, PlantOwner, OfferConnectionString, CommercialQuotationsPath, LoginContext, WorkingOrdersPath, true);
                    CreateOfferReturn.id = offer.IdOffer;
                    CreateOfferReturn.code = offer.OfferCode;
                }
                else
                {
                    offer.OfferCode = null;
                    CreateOfferReturn = null;
                }
            }
            catch (Exception ex)
            {

                throw;
            }

            return CreateOfferReturn;
        }
        public List<ActivityTemplateTrigger> GetActivityTemplateTriggers(string workbenchConnectionString)
        {
            List<ActivityTemplateTrigger> activityTemplateTriggers = new List<ActivityTemplateTrigger>();

            using (MySqlConnection connActivityTemplateTriggers = new MySqlConnection(workbenchConnectionString))
            {
                connActivityTemplateTriggers.Open();

                MySqlCommand activityTriggersCommand = new MySqlCommand("activities_GetActivityTriggers", connActivityTemplateTriggers);
                activityTriggersCommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader activityTriggersReader = activityTriggersCommand.ExecuteReader())
                {
                    while (activityTriggersReader.Read())
                    {
                        ActivityTemplateTrigger activityTemplateTrigger = null;

                        if (activityTriggersReader["IdActivityTemplateTrigger"] != DBNull.Value)
                        {
                            if (activityTemplateTriggers.Exists(x => x.IdActivityTemplateTrigger == Convert.ToInt16(activityTriggersReader["IdActivityTemplateTrigger"])))
                            {
                                activityTemplateTrigger = activityTemplateTriggers.FirstOrDefault(x => x.IdActivityTemplateTrigger == Convert.ToInt16(activityTriggersReader["IdActivityTemplateTrigger"]));
                            }
                            else
                            {
                                activityTemplateTrigger = new ActivityTemplateTrigger();
                                activityTemplateTrigger.IdActivityTemplateTrigger = Convert.ToInt16(activityTriggersReader["IdActivityTemplateTrigger"].ToString());

                                if (activityTriggersReader["IdLinkedObject"] != DBNull.Value)
                                {
                                    activityTemplateTrigger.IdLinkedObject = Convert.ToInt16(activityTriggersReader["IdLinkedObject"].ToString());

                                    //activityTemplateTrigger.LinkedObject = new LookupValue();
                                    //activityTemplateTrigger.LinkedObject.IdLookupValue = Convert.ToInt16(activityTriggersReader["IdLinkedObject"].ToString());
                                    //activityTemplateTrigger.LinkedObject.Value = Convert.ToString(activityTriggersReader["Value"]);
                                }

                                if (activityTriggersReader["LinkedObjectFieldName"] != DBNull.Value)
                                {
                                    activityTemplateTrigger.LinkedObjectFieldName = Convert.ToString(activityTriggersReader["LinkedObjectFieldName"]);
                                }

                                if (activityTriggersReader["LinkedObjectFieldValue"] != DBNull.Value)
                                {
                                    activityTemplateTrigger.LinkedObjectFieldValue = Convert.ToString(activityTriggersReader["LinkedObjectFieldValue"]);
                                }

                                // Trigger Condition.
                                if (activityTriggersReader["IdActivityTemplateTriggerCondition"] != DBNull.Value)
                                {
                                    ActivityTemplateTriggerCondition activityTemplateTriggerCondition = new ActivityTemplateTriggerCondition();

                                    activityTemplateTriggerCondition.IdActivityTemplateTriggerCondition = Convert.ToInt16(activityTriggersReader["IdActivityTemplateTriggerCondition"]);

                                    if (activityTriggersReader["ConditionFieldName"] != DBNull.Value)
                                    {
                                        activityTemplateTriggerCondition.ConditionFieldName = Convert.ToString(activityTriggersReader["ConditionFieldName"]);
                                    }

                                    if (activityTriggersReader["ConditionOperator"] != DBNull.Value)
                                    {
                                        activityTemplateTriggerCondition.ConditionOperator = Convert.ToString(activityTriggersReader["ConditionOperator"]);
                                    }

                                    if (activityTriggersReader["ConditionFieldValue"] != DBNull.Value)
                                    {
                                        activityTemplateTriggerCondition.ConditionFieldValue = Convert.ToString(activityTriggersReader["ConditionFieldValue"]);
                                    }

                                    if (activityTriggersReader["ConditionFieldType"] != DBNull.Value)
                                    {
                                        activityTemplateTriggerCondition.ConditionFieldType = Convert.ToString(activityTriggersReader["ConditionFieldType"]);
                                    }

                                    if (activityTriggersReader["IsUserConfirmationRequired"] != DBNull.Value)
                                    {
                                        activityTemplateTriggerCondition.IsUserConfirmationRequired = Convert.ToByte(activityTriggersReader["IsUserConfirmationRequired"]);
                                    }

                                    activityTemplateTrigger.ActivityTemplateTriggerCondition = activityTemplateTriggerCondition;
                                }

                                // Activity Templates
                                activityTemplateTrigger.ActivityTemplates = new List<ActivityTemplate>();

                                activityTemplateTriggers.Add(activityTemplateTrigger);
                            }
                        }

                        // Templates based on condition
                        if (activityTriggersReader["IdActivityTemplate"] != DBNull.Value)
                        {
                            if (!activityTemplateTrigger.ActivityTemplates.Any(x => x.IdActivityTemplate == Convert.ToInt16(activityTriggersReader["IdActivityTemplate"])))
                            {
                                ActivityTemplate activityTemplate = new ActivityTemplate();

                                if (activityTriggersReader["IdActivityType"] != DBNull.Value)
                                {
                                    activityTemplate.IdActivityTemplate = Convert.ToInt16(activityTriggersReader["IdActivityTemplate"]);

                                    if (activityTriggersReader["ActivityType"] != DBNull.Value)
                                    {
                                        activityTemplate.IdActivityType = Convert.ToInt16(activityTriggersReader["IdActivityType"]);

                                        //activityTemplate.ActivityType = new LookupValue();
                                        //activityTemplate.ActivityType.IdLookupValue = activityTemplate.IdActivityType;
                                        //activityTemplate.ActivityType.Value = Convert.ToString(activityTriggersReader["ActivityType"]);
                                    }
                                }

                                if (activityTriggersReader["Subject"] != DBNull.Value)
                                {
                                    activityTemplate.Subject = Convert.ToString(activityTriggersReader["Subject"]);
                                }

                                if (activityTriggersReader["Description"] != DBNull.Value)
                                {
                                    activityTemplate.Description = Convert.ToString(activityTriggersReader["Description"]);
                                }

                                if (activityTriggersReader["DueDaysAfterCreation"] != DBNull.Value)
                                {
                                    activityTemplate.DueDaysAfterCreation = Convert.ToInt16(activityTriggersReader["DueDaysAfterCreation"]);
                                }

                                activityTemplateTrigger.ActivityTemplates.Add(activityTemplate);
                            }
                        }
                    }
                }
            }

            return activityTemplateTriggers;
        }
        public Int64 GetStatusId(string statusName, string connectionString)
        {
            Int64 idStatus = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetStatusId()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connectionString))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetStatusId", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_Name", statusName);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {

                            if (dr["IdOfferStatusType"] != DBNull.Value)
                            {
                                idStatus = Convert.ToInt64(dr["IdOfferStatusType"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetStatusId()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetStatusId(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idStatus;
        }
        public IList<OfferCurrency> GetCurrencyByExchangeRate(string connectionstring)
        {
            IList<OfferCurrency> currencies = new List<OfferCurrency>();

            using (MySqlConnection conCurrencyConversion = new MySqlConnection(connectionstring))
            {
                conCurrencyConversion.Open();
                MySqlCommand conCurrencyConversioncommand = new MySqlCommand("GEOSAPI_GetOfferCurrencyActivity", conCurrencyConversion);
                conCurrencyConversioncommand.CommandType = CommandType.StoredProcedure;
                using (MySqlDataReader CurrencyConversionreader = conCurrencyConversioncommand.ExecuteReader())
                {
                    while (CurrencyConversionreader.Read())
                    {
                        OfferCurrency currency = new OfferCurrency();
                        currency.codeN = Convert.ToInt64(CurrencyConversionreader["CodeN"].ToString());
                        currency.description = CurrencyConversionreader["Description"].ToString();
                        currency.symbol = CurrencyConversionreader["Symbol"].ToString();
                        currency.name = CurrencyConversionreader["Name"].ToString();
                        currency.idCurrency = Convert.ToByte(CurrencyConversionreader["IdCurrency"].ToString());
                        currency.currencyConversions = new List<OfferCurrencyConversion>();
                        OfferCurrencyConversion currencyConversion = new OfferCurrencyConversion();
                        currencyConversion.idcurrencyconversion = Convert.ToInt64(CurrencyConversionreader["idcurrencyconversion"].ToString());
                        currencyConversion.idcurrencyfrom = Convert.ToByte(CurrencyConversionreader["idcurrencyfrom"].ToString());
                        currencyConversion.idcurrencyto = Convert.ToByte(CurrencyConversionreader["idcurrencyto"].ToString());
                        currencyConversion.exchangeRate = float.Parse(CurrencyConversionreader["exchangerate"].ToString());
                        currencyConversion.lastUpdate = Convert.ToDateTime(CurrencyConversionreader["lastupdate"].ToString());
                        currency.currencyConversions.Add(currencyConversion);
                        currencies.Add(currency);
                    }
                }
            }

            return currencies;
        }
        public Boolean Operator(string logic, double amount, double ConditionFieldValue)
        {
            switch (logic)
            {
                case ">": return amount > ConditionFieldValue;
                case "<": return amount < ConditionFieldValue;
                case ">=": return amount >= ConditionFieldValue;
                case "<=": return amount <= ConditionFieldValue;
                case "==": return amount == ConditionFieldValue;
                case "!=": return amount != ConditionFieldValue;
                default: return false;
            }
        }

        public void AddActivityInOffer(CreateOpportunityModel offer, string workbenchConnectionString, string connectionstring)
        {
            List<ActivityTemplate> activityTemplateList = new List<ActivityTemplate>();
            string activityMsg = "";
            IList<OfferCurrency> Currencies = GetCurrencyByExchangeRate(connectionstring);

            foreach (var activityTemplateTrigger in GetActivityTemplateTriggers(workbenchConnectionString))
            {
                if (offer.idStatus == 1 &&
                    string.Format(offer.idStatus + "(" + offer.status.ToUpper() + ")") == activityTemplateTrigger.LinkedObjectFieldValue.ToUpper())
                {
                    OfferCurrency selectedcurrency = Currencies.FirstOrDefault(c => c.name == activityTemplateTrigger.ActivityTemplateTriggerCondition.ConditionFieldType);
                    Double amount = Convert.ToDouble(offer.amount_value) * (Currencies.Where(i => i.idCurrency == offer.IdCurrency).FirstOrDefault().currencyConversions.Count > 0 ? Currencies.Where(i => i.idCurrency == offer.IdCurrency).FirstOrDefault().currencyConversions[0].exchangeRate : selectedcurrency.idCurrency);

                    if (Operator(activityTemplateTrigger.ActivityTemplateTriggerCondition.ConditionOperator, amount, Convert.ToDouble(activityTemplateTrigger.ActivityTemplateTriggerCondition.ConditionFieldValue)))
                    {


                        foreach (ActivityTemplate activityTemplate in activityTemplateTrigger.ActivityTemplates)
                        {
                            AddActivity(offer, activityTemplate, workbenchConnectionString, connectionstring);
                        }

                    }
                }


            }
        }
        /// <summary>
        /// Method for add new activity for offer.
        /// </summary>
        private void AddActivity(CreateOpportunityModel offer, ActivityTemplate activityTemplate, string loginContext, string connectionstring)
        {
            try
            {

                OfferActivity NewActivity = new OfferActivity();
                List<OfferActivityLinkedItem> listActivityLinkedItems = new List<OfferActivityLinkedItem>();
                List<OfferLogActivity> logEntriesByActivity = new List<OfferLogActivity>();

                NewActivity.IdActivityType = activityTemplate.IdActivityType;
                NewActivity.Subject = activityTemplate.Subject;             //string.Format(System.Windows.Application.Current.FindResource("LeadsEditViewActivitySubject").ToString());
                NewActivity.Description = activityTemplate.Description;     // string.Format(System.Windows.Application.Current.FindResource("LeadsEditViewActivityDescription").ToString());
                NewActivity.CreatedBy = offer.IdCreatedBy;
                NewActivity.IsCompleted = 0;
                NewActivity.IdOwner = offer.idSaleOwner;               // ActivityOwnerList[SelectedIndexOwner].IdUser;
                //NewActivity.ActivityTags = null;
                NewActivity.IsSentMail = 0;
                NewActivity.FromDate = DateTime.Now.AddDays(activityTemplate.DueDaysAfterCreation);
                NewActivity.ToDate = DateTime.Now.AddDays(activityTemplate.DueDaysAfterCreation);

                NewActivity.Location = offer.siteDetail.address;
                NewActivity.Latitude = offer.siteDetail.latitude;
                NewActivity.Longitude = offer.siteDetail.longitude;
                NewActivity.IsDeleted = 0;

                //Fill Account details.
                OfferActivityLinkedItem _aliAccount = new OfferActivityLinkedItem();
                _aliAccount.idLinkedItemType = 42;
                _aliAccount.idSite = offer.IdCustomer;
                _aliAccount.name = offer.siteDetail.customerName + " - " + offer.siteDetail.siteName;

                listActivityLinkedItems.Add(_aliAccount);

                // For Add Attendies
                List<OfferActivityAttendees> listattendees = new List<OfferActivityAttendees>();
                listattendees.Add(new OfferActivityAttendees() { idUser = offer.idSaleOwner });
                NewActivity.ActivityAttendees = listattendees;

                //_ActivityLinkedItem.Company = new Company();
                //_ActivityLinkedItem.Company.Customers = new List<Customer>();
                //_ActivityLinkedItem.Company = CompanyPlantList[SelectedIndexCompanyPlant];
                //_ActivityLinkedItem.Company.Customers.Add(CompanyGroupList[SelectedIndexCompanyGroup]);
                //_ActivityLinkedItem.LinkedItemType = new LookupValue();
                //_ActivityLinkedItem.LinkedItemType.IdLookupValue = 42;
                //_ActivityLinkedItem.LinkedItemType.Value = System.Windows.Application.Current.FindResource("ActivityAccount").ToString();

                //Fill Opportunity details.
                OfferActivityLinkedItem _aliOpportunity = new OfferActivityLinkedItem();
                _aliOpportunity.idLinkedItemType = 44;
                _aliOpportunity.name = offer.OfferCode;
                _aliOpportunity.idSite = null;
                _aliOpportunity.idOffer = offer.IdOffer;
                _aliOpportunity.idEmdepSite = Convert.ToInt32(offer.idSiteWhereCreated);

                listActivityLinkedItems.Add(_aliOpportunity);

                //_ActivityLinkedItem1 = (ActivityLinkedItem)_ActivityLinkedItem.Clone();
                //_ActivityLinkedItem1.LinkedItemType = new LookupValue();
                //_ActivityLinkedItem1.LinkedItemType.IdLookupValue = 44;
                //_ActivityLinkedItem1.LinkedItemType.Value = System.Windows.Application.Current.FindResource("ActivityOpportunity").ToString();

                foreach (OfferActivityLinkedItem item in listActivityLinkedItems)
                {


                    if (item.idLinkedItemType == 42)        //Account
                    {
                        logEntriesByActivity.Add(new OfferLogActivity() { IdActivity = NewActivity.IdActivity, IdUser = offer.IdCreatedBy, Datetime = DateTime.Now, Comments = string.Format("Account {0} has been added to Linked items.", item.name), IdLogEntryType = 2 });
                    }
                    else if (item.idLinkedItemType == 44)   // Opportunity
                    {
                        logEntriesByActivity.Add(new OfferLogActivity() { IdActivity = NewActivity.IdActivity, IdUser = offer.IdCreatedBy, Datetime = DateTime.Now, Comments = string.Format("Opportunity {0} has been added to Linked items.", item.name), IdLogEntryType = 2 });
                    }
                }

                NewActivity.LogEntriesByActivity = logEntriesByActivity;
                NewActivity.ActivityLinkedItem = listActivityLinkedItems;
                NewActivity = AddActivity(NewActivity, connectionstring);


            }

            catch (Exception ex)
            {
                throw;
            }
        }
        public OfferActivity AddActivity(OfferActivity activity, string mainServerConnectionString)
        {
            TransactionScope transactionScope = null;
            TransactionScope transactionScopeNew = null;

            using (transactionScope = new System.Transactions.TransactionScope())
            {
                try
                {
                    using (MySqlConnection connActivity = new MySqlConnection(mainServerConnectionString))
                    {
                        connActivity.Open();

                        MySqlCommand insertActivityCommand = new MySqlCommand("activities_Insert", connActivity);
                        insertActivityCommand.CommandType = CommandType.StoredProcedure;

                        insertActivityCommand.Parameters.AddWithValue("_ToDate", activity.ToDate);
                        insertActivityCommand.Parameters.AddWithValue("_Subject", activity.Subject);
                        insertActivityCommand.Parameters.AddWithValue("_Location", activity.Location);
                        insertActivityCommand.Parameters.AddWithValue("_IdOwner", activity.IdOwner);
                        insertActivityCommand.Parameters.AddWithValue("_IdActivityType", activity.IdActivityType);
                        insertActivityCommand.Parameters.AddWithValue("_FromDate", activity.FromDate);
                        insertActivityCommand.Parameters.AddWithValue("_Description", activity.Description);
                        insertActivityCommand.Parameters.AddWithValue("_CreatedBy", activity.CreatedBy);
                        insertActivityCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                        insertActivityCommand.Parameters.AddWithValue("_Longitude", activity.Longitude);
                        insertActivityCommand.Parameters.AddWithValue("_Latitude", activity.Latitude);
                        insertActivityCommand.Parameters.AddWithValue("_IdActivityStatus", activity.IdActivityStatus);
                        insertActivityCommand.Parameters.AddWithValue("_IsCompleted", activity.IsCompleted);
                        insertActivityCommand.Parameters.AddWithValue("_IsDeleted", activity.IsDeleted);
                        insertActivityCommand.Parameters.AddWithValue("_ReminderDateTime", activity.ActivityReminderDateTime);
                        insertActivityCommand.Parameters.AddWithValue("_IsSentMail", activity.IsSentMail);
                        insertActivityCommand.Parameters.AddWithValue("_IsInternal", activity.IsInternal);

                        if (activity.IsCompleted == 1)
                        {
                            insertActivityCommand.Parameters.AddWithValue("_CloseDate", DateTime.Now);
                        }
                        else
                        {
                            insertActivityCommand.Parameters.AddWithValue("_CloseDate", DBNull.Value);
                        }

                        //concompanycommand.Transaction = transactionScope;
                        activity.IdActivity = Convert.ToInt32(insertActivityCommand.ExecuteScalar());

                        connActivity.Close();

                        if (activity.IdActivity > 0)
                        {
                            AddActivityAttendees(activity.IdActivity, activity.ActivityAttendees, mainServerConnectionString);


                            AddLogEntriesByActivity(activity.IdActivity, activity.LogEntriesByActivity, mainServerConnectionString);
                            AddLogEntriesByActivity(activity.IdActivity, activity.CommentsByActivity, mainServerConnectionString);
                            AddActivityLinkedItem(activity.IdActivity, activity.ActivityLinkedItem, mainServerConnectionString);



                            //using (transactionScopeNew = new TransactionScope(TransactionScopeOption.RequiresNew))
                            //{
                            //    if (activity.Notification != null)
                            //    {
                            //        Notification notification = AddNotification(activity.Notification, activity.ActivityMail, workbenchConnectionString, MailServerName, MailServerPort, MailFrom, EmailTemplate);
                            //        transactionScopeNew.Complete();

                            //        if (notification.Id > 0)
                            //        {
                            //            ApplicationManager applicationManager = new ApplicationManager();
                            //            if (activity.ActivityMail != null)
                            //                applicationManager.SendActivityMail(activity.ActivityMail, MailServerName, MailServerPort, MailFrom, EmailTemplate);
                            //        }
                            //    }
                            //}

                            transactionScope.Complete();
                        }
                    }
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    if (transactionScopeNew != null)
                        transactionScopeNew.Dispose();

                    throw;
                }
            }


            return activity;
        }
        public SiteDetail IsPlantExist_V220(string plant, Int32 idCustomer, string connstr)
        {
            SiteDetail siteDetail = new SiteDetail();
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsPlantExist_V220()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsPlantExist_V220", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_companyPlant", plant);
                    command.Parameters.AddWithValue("_idCustomer", idCustomer);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdSite"] != DBNull.Value)
                            {
                                siteDetail.IdSite = Convert.ToInt32(dr["IdSite"]);
                            }
                            if (dr["IdCustomer"] != DBNull.Value)
                            {
                                siteDetail.IdCustomer = Convert.ToInt32(dr["IdCustomer"]);
                            }

                            if (dr["IdCountry"] != DBNull.Value)
                            {
                                siteDetail.IdCountry = Convert.ToInt64(dr["IdCountry"]);
                            }

                            if (dr["siteName"] != DBNull.Value)
                            {
                                siteDetail.siteName = Convert.ToString(dr["siteName"]);
                            }

                            if (dr["customerName"] != DBNull.Value)
                            {
                                siteDetail.customerName = Convert.ToString(dr["customerName"]);
                            }

                            if (dr["latitude"] != DBNull.Value)
                            {
                                siteDetail.latitude = Convert.ToDouble(dr["latitude"]);
                            }

                            if (dr["longitude"] != DBNull.Value)
                            {
                                siteDetail.longitude = Convert.ToDouble(dr["longitude"]);
                            }

                            if (dr["address"] != DBNull.Value)
                            {
                                siteDetail.address = Convert.ToString(dr["address"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsPlantExist_V220()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsPlantExist_V220(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return siteDetail;
        }
        public Int32 IsGroupExist(string group, string connstr)
        {
            Int32 idCustomer = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsGroupExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsGroupExist", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_companyGroup", group);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {

                            if (dr["IdCustomer"] != DBNull.Value)
                            {
                                idCustomer = Convert.ToInt32(dr["IdCustomer"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsGroupExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsGroupExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idCustomer;
        }

        public Int32 IsSourceExist(string source, string connstr)
        {
            Int32 idSource = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsSourceExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsSourceExist", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_Source", source);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {

                            if (dr["IdLookupValue"] != DBNull.Value)
                            {
                                idSource = Convert.ToInt32(dr["IdLookupValue"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsSourceExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsSourceExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idSource;
        }

        public Int32 IsOfferOwnerExist(string offerOwner, string connstr)
        {
            Int32 idUser = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsOfferOwnerExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    //   MySqlCommand command = new MySqlCommand("GEOSAPI_IsOfferOwnerExist", conn);
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsOfferOwnerExist_V610", conn);//Added By Rahul[RGadhave] for APIGEOS-872
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_offerOwnerName", offerOwner);
                    //command.Parameters.AddWithValue("_offerOwnerName", System.Text.RegularExpressions.Regex.Unescape(offerOwner));                  
                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {

                            if (dr["IdUser"] != DBNull.Value)
                            {
                                idUser = Convert.ToInt32(dr["IdUser"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsOfferOwnerExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsOfferOwnerExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idUser;
        }
        public Int32 IsIdDepartmentExist(string CreatedBy, string connstr)
        {
            Int32 IdDepartment = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsIdDepartmentExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsIdDepartmentExist", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_CreatedBy", CreatedBy);
                    command.CommandTimeout = 900;
                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {

                            if (dr["IdDepartment"] != DBNull.Value)
                            {
                                IdDepartment = Convert.ToInt32(dr["IdDepartment"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsIdDepartmentExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsIdDepartmentExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return IdDepartment;
        }

        public Int32 IsOfferedToExist(Int32 idCustomer, string contactMailId, string connstr)
        {
            Int32 idPerson = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsOfferedToExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsExistContactMail", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_ContactMail", contactMailId);
                    command.Parameters.AddWithValue("_idCustomer", idCustomer);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {

                            if (dr["IdPerson"] != DBNull.Value)
                            {
                                idPerson = Convert.ToInt32(dr["IdPerson"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsOfferedToExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsOfferedToExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idPerson;
        }


        public string GetOfferedToFullName(Int32 idCustomer, string contactMailId, string connstr)
        {
            string fullName = "";
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetOfferedToFullName()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetOfferedToFullName", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_ContactMail", contactMailId);
                    command.Parameters.AddWithValue("_idCustomer", idCustomer);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {

                            if (dr["FullName"] != DBNull.Value)
                            {
                                fullName = Convert.ToString(dr["FullName"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetOfferedToFullName()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetOfferedToFullName(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return fullName;
        }


        public Int32 GetSaleOwnerExist(Int32 idSite, string connstr)
        {
            Int32 idPerson = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetSaleOwnerExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_GetSaleOwnerExist", conn);
                    MySqlCommand command = new MySqlCommand("GEOSAPI_sites_GetSalesOwnerBySiteId_V580", conn); // Created by chitra[cgirigosavi][APIGEOS-788][17/05/2023]
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_idSite", idSite);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdSalesOwner"] != DBNull.Value)
                                idPerson = Convert.ToInt32(dr["IdSalesOwner"]);
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetSaleOwnerExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetSaleOwnerExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idPerson;
        }

        public Int32 IsCreatedByExist(string createdBy, string connstr)
        {
            Int32 idUser = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsCreatedByExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsPeopleExist", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_CreatedBy", createdBy);
                    //command.Parameters.AddWithValue("_CreatedBy", System.Text.RegularExpressions.Regex.Unescape(createdBy));

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdPerson"] != DBNull.Value)
                                idUser = Convert.ToInt32(dr["IdPerson"]);
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsCreatedByExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsCreatedByExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idUser;
        }

        public Int64 IsOfferOptionExist(string connectionstring, string Name)
        {

            Int64 idOfferOption = 0;
            using (MySqlConnection conofferOptions = new MySqlConnection(connectionstring))
            {
                conofferOptions.Open();
                MySqlCommand conofferOptionscommand = new MySqlCommand("GEOSAPI_IsOfferOptionExist", conofferOptions);
                conofferOptionscommand.CommandType = CommandType.StoredProcedure;
                conofferOptionscommand.Parameters.AddWithValue("_Name", Name);
                using (MySqlDataReader offerOptionsreader = conofferOptionscommand.ExecuteReader())
                {
                    if (offerOptionsreader.Read())
                    {
                        if (offerOptionsreader["idOfferOption"] != DBNull.Value)
                            idOfferOption = Convert.ToInt64(offerOptionsreader["idOfferOption"]);

                    }
                }
            }
            return idOfferOption;
        }

        public Int32 IsBusinessUnitExist(string businessUnit, string connstr)
        {
            Int32 idBusinessUnit = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsBusinessUnitExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsBusinessUnitExist", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_BusinessUnit", businessUnit);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {

                            if (dr["IdLookupValue"] != DBNull.Value)
                            {
                                idBusinessUnit = Convert.ToInt32(dr["IdLookupValue"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsBusinessUnitExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsBusinessUnitExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idBusinessUnit;
        }

        public Byte IsCurrencyExist(string currencyName, string connstr)
        {
            byte idCurrency = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsCurrencyExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsCurrencyExist", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_CurrencyName", currencyName);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {

                            if (dr["IdCurrency"] != DBNull.Value)
                            {
                                idCurrency = Convert.ToByte(dr["IdCurrency"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsCurrencyExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsCurrencyExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idCurrency;
        }

        public Int64 GetNextNumberOfOfferFromCounters(byte idOfferType, string mainserverconnectionString)
        {
            Int64 nextNumber = 1;

            using (MySqlConnection conoffer = new MySqlConnection(mainserverconnectionString))
            {
                conoffer.Open();
                MySqlCommand command = new MySqlCommand("CRM_GetNextNumberFromCounters", conoffer);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idOfferType", idOfferType);
                command.Parameters.AddWithValue("_year", DateTime.Now.Year);
                using (MySqlDataReader offerreader = command.ExecuteReader())
                {
                    if (offerreader.Read())
                        nextNumber = Convert.ToInt32(offerreader["NextNumber"].ToString());
                }
            }

            return nextNumber;
        }

        public void AddOfferContact(Int32 idCustomer, List<OfferedToModel> offerContacts, string connectionstring, Int64 idOffer)
        {
            if (offerContacts != null)
                foreach (OfferedToModel item in offerContacts)
                {

                    try
                    {
                        using (MySqlConnection conlogEntryByOffer = new MySqlConnection(connectionstring))
                        {
                            conlogEntryByOffer.Open();
                            //using (MySqlTransaction trans = conlogEntryByOffer.BeginTransaction())
                            //{
                            try
                            {
                                MySqlCommand conlogEntryByOffercommand = new MySqlCommand("offercontact_Insert", conlogEntryByOffer);
                                conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                                conlogEntryByOffercommand.Parameters.AddWithValue("_IdOffer", idOffer);
                                conlogEntryByOffercommand.Parameters.AddWithValue("_IdContact", IsOfferedToExist(idCustomer, item.contact_email, connectionstring));
                                conlogEntryByOffercommand.Parameters.AddWithValue("_IsPrimaryOfferContact", item.is_primary);
                                //conlogEntryByOffercommand.Transaction = trans;
                                int idOfferContact = Convert.ToInt32(conlogEntryByOffercommand.ExecuteScalar());
                                //trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                // trans.Rollback();
                                throw;
                            }
                            // }
                        }
                    }
                    catch (Exception ex)
                    {
                        throw;
                    }
                }
        }

        public void UpdateNextOfferNumberToCounters(int idOfferType, string connectionstring)
        {
            bool exist = false;
            bool sameYear = false;
            using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
            {
                conoffer.Open();

                MySqlCommand conoffercommand = new MySqlCommand("GEOSAPI_GetCountersDetail", conoffer);
                conoffercommand.CommandType = CommandType.StoredProcedure;
                conoffercommand.Parameters.AddWithValue("_idOfferType", idOfferType);
                conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                {
                    if (offerreader.Read())
                    {
                        exist = true;
                        if (Convert.ToInt32(offerreader["year"]) == DateTime.Now.Year)
                            sameYear = true;
                    }
                }

            }
            //Si no existeix el número o es un nou any li posarem el número 2 ja que el 1 l'acabem de fer servir
            //i el número de la base de dades sempre es el próxim

            if (!exist)
            {
                using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                {
                    conoffer.Open();
                    //using (MySqlTransaction trans = conoffer.BeginTransaction())
                    //{
                    try
                    {
                        MySqlCommand conoffercommand = new MySqlCommand("GEOSAPI_InsertCounters", conoffer);
                        conoffercommand.CommandType = CommandType.StoredProcedure;
                        conoffercommand.Parameters.AddWithValue("_idOfferType", idOfferType);
                        conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                        // conoffercommand.Transaction = trans;
                        conoffercommand.ExecuteNonQuery();
                        // trans.Commit();
                    }
                    catch (Exception ex)
                    {
                        //  trans.Rollback();
                        throw;
                    }
                    // }
                }
            }
            else
            {
                if (sameYear)
                {

                    using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                    {
                        conoffer.Open();
                        //using (MySqlTransaction trans = conoffer.BeginTransaction())
                        //{
                        try
                        {
                            MySqlCommand conoffercommand = new MySqlCommand("GEOSAPI_UpdateCountersSameYear", conoffer);
                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_idOfferType", idOfferType);
                            conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                            //conoffercommand.Transaction = trans;
                            conoffercommand.ExecuteNonQuery();
                            // trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            // trans.Rollback();
                            throw;
                        }
                        // }
                    }
                }
                else
                {
                    using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                    {
                        conoffer.Open();
                        //using (MySqlTransaction trans = conoffer.BeginTransaction())
                        //{
                        try
                        {
                            MySqlCommand conoffercommand = new MySqlCommand("GEOSAPI_UpdateCountersDifferentYear", conoffer);
                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_idOfferType", idOfferType);
                            conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);

                            //  conoffercommand.Transaction = trans;
                            conoffercommand.ExecuteNonQuery();
                            // trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            // trans.Rollback();
                            throw;
                        }
                        //}
                    }
                }
            }

        }
        public string MakeOfferCode(string offerType, Int64 idCustomer, string mainServerConnectionString, string Plantwiseconnectionstring)
        {
            string code = "";
            if (offerType.ToUpper() == "OT")
                code = DateTime.Now.Year.ToString() + GetCodeForSite(idCustomer, mainServerConnectionString) + "-" + GetNextNumberOfOfferFromCounters(1, mainServerConnectionString).ToString().PadLeft(5, '0');
            else if (offerType.ToUpper() == "OP")
                code = "OP" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, mainServerConnectionString) + GetNextNumberOfOfferFromCounters(10, mainServerConnectionString).ToString().PadLeft(5, '0');
            return code;
        }
        private string GetCodeForSite(Int64 idCustomer, string connectionstring)
        {
            string code = "";
            using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
            {
                conoffer.Open();
                MySqlCommand conoffercommand = new MySqlCommand("emdepsites_GetCodeByIdSite", conoffer);
                conoffercommand.CommandType = CommandType.StoredProcedure;
                conoffercommand.Parameters.AddWithValue("_IdSite", idCustomer);

                using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                {
                    if (offerreader.Read())
                        code = offerreader["code"].ToString();
                    else
                        code = string.Empty;
                }
            }
            return code;
        }
        public string GetGEOSAppSetting(string appSettingName, string connstr)
        {
            string DefaultValue = null;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetGEOSAppSetting()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetGeosAppSetting", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_AppSettingName", appSettingName);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["DefaultValue"] != DBNull.Value)
                            {
                                DefaultValue = Convert.ToString(dr["DefaultValue"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetGEOSAppSetting()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetGEOSAppSetting(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return DefaultValue;
        }
        public Int32 GetOffer_Item_StatusByAppSettingName(string AppSettingName, string LoginContext)
        {
            Int32 DefaultValue = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetOffer_Item_StatusByAppSettingName()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(LoginContext))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsByName", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_AppSettingName", AppSettingName);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["DefaultValue"] != DBNull.Value)
                            {
                                DefaultValue = Convert.ToInt32(dr["DefaultValue"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetOffer_Item_StatusByAppSettingName()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetOffer_Item_StatusByAppSettingName(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return DefaultValue;
        }
        public Int32 GetIdLookupValueByAbbreviation(string Abbreviation, string connstr)
        {
            Int32 IdLookupValue = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetIdLookupValueByAbbreviation()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetIdLookupValueByAbbreviation", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_abbreviation", Abbreviation);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdLookupValue"] != DBNull.Value)
                            {
                                IdLookupValue = Convert.ToInt32(dr["IdLookupValue"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetIdLookupValueByAbbreviation()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetIdLookupValueByAbbreviation(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return IdLookupValue;
        }
        public Int32 GetIdLookupValueByValue(string Value, string connstr)
        {
            Int32 IdLookupValue = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetIdLookupValueByValue()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetIdLookupValueByValue", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_Value", Value);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            if (dr["IdLookupValue"] != DBNull.Value)
                            {
                                IdLookupValue = Convert.ToInt32(dr["IdLookupValue"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetIdLookupValueByValue()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetIdLookupValueByValue(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return IdLookupValue;
        }
        public string GetSiteConnectionString(Int64 idSite, string connstr, string Plantwiseconnectionstring)
        {
            string connectionString = null;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetSiteConnectionString()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetEMDEPSiteDetail", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_idSite", idSite);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["DatabaseIP"] != DBNull.Value)
                            {
                                // connectionString = "Data Source = " + dr["DatabaseIP"].ToString() + "; Database = geos; User ID = GeosUsr; Password = GEOS;Convert Zero Datetime=True";
                                // connectionString= Plantwiseconnectionstring.Replace("{0}", dr["DatabaseIP"].ToString());
                                connectionString = string.Format(Plantwiseconnectionstring, dr["DatabaseIP"].ToString());
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetSiteConnectionString()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetSiteConnectionString(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return connectionString;
        }

        public bool IsOfferExist(string idOffer, string connstr)
        {
            bool isExist = false;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsOfferExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsIdOfferExist", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_idOffer", idOffer);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdOffer"] != DBNull.Value)
                            {
                                isExist = true;
                            }
                            else
                            {
                                isExist = false;
                            }
                        }
                        else
                        {
                            isExist = false;
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsOfferExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsOfferExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return isExist;
        }
        public bool IsOfferExistBycode(string Code, string connstr)
        {
            bool isExist = false;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsOfferExistBycode()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsIdOfferExistBycode", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_Code", Code);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdOffer"] != DBNull.Value)
                            {
                                isExist = true;
                            }
                            else
                            {
                                isExist = false;
                            }
                        }
                        else
                        {
                            isExist = false;
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsOfferExistBycode()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsOfferExistBycode(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return isExist;
        }
        public Int64 IsCountryExist(string country, string connstr)
        {
            Int64 idCountry = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsCountryExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsCountryExist", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_companyCountry", country);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdCountry"] != DBNull.Value)
                            {
                                idCountry = Convert.ToInt64(dr["IdCountry"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsCountryExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsCountryExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idCountry;
        }

        public string GetGroupPlantFullName(Int64 idOffer, string connstr)
        {
            string _groupPlantFullName = null;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetGroupPlantFullName()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetGroupPlantFullName", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_idOffer", idOffer);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["GroupPlantFullName"] != DBNull.Value)
                            {
                                _groupPlantFullName = Convert.ToString(dr["GroupPlantFullName"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetGroupPlantFullName()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetGroupPlantFullName(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return _groupPlantFullName;
        }

        public string GetGEOSProviderFileServer(string plantOwner, string connstr)
        {
            string fileServer = null;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetGEOSProviderFileServer()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetGeosProviderFileServer", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_SiteAlias", plantOwner);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["FileServer"] != DBNull.Value)
                            {
                                fileServer = Convert.ToString(dr["FileServer"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetGEOSProviderFileServer()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetGEOSProviderFileServer(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return fileServer;
        }
        public byte[] GetOfferExportChart(string companyAlias, string offerExcelPath)
        {
            byte[] bytes = null;
            string defaultFileName = @"\Offer.xlsx";

            string companyFileName = string.Format("{0}{1}{2}{3}", @"\", companyAlias, "_", "Offer.xlsx");

            try
            {
                if (File.Exists(string.Format("{0}{1}", offerExcelPath, companyFileName)))
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(string.Format("{0}{1}", offerExcelPath, companyFileName), System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;

                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }
                }
                else if (File.Exists(string.Format("{0}{1}", offerExcelPath, defaultFileName)))
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(string.Format("{0}{1}", offerExcelPath, defaultFileName), System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;

                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }
                }

            }
            catch (FileNotFoundException ex)
            {

            }
            catch (DirectoryNotFoundException ex)
            {

            }
            catch (Exception ex)
            {

            }
            return bytes;
        }
        // Created By Rahul Gadhave[rgadhave] For APIGEOS-861 Add a new service in API called “PRODUCTION->MODULES->TRACKINGS->Times
        public Int32 GetUserId(string Username, string connstr)
        {
            Int32 IdUser = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsUsernameExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetUserId", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_Username", Username);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdUser"] != DBNull.Value)
                            {
                                IdUser = Convert.ToInt32(dr["IdUser"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsUsernameExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error IsUsernameExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            return IdUser;
        }
        public Int64 IsEMDEPSiteExist(string Site, string connstr)
        {
            Int64 idSite = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsEMDEPSiteExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsEMDEPSiteExist", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_ShortName", Site);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdSite"] != DBNull.Value)
                            {
                                idSite = Convert.ToInt64(dr["IdSite"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsEMDEPSiteExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsEMDEPSiteExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idSite;
        }

        // Added By Rahul[RGadhave] for APIGEOS-872
        public bool GetErrorcode(string connstr, string offer_owner, out string Email)
        {
            Email = null;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsOfferOwnerExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    //  MySqlCommand command = new MySqlCommand("GEOSAPI_IsOfferOwnerExist", conn);
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetEmail", conn); //Added By Rahul[RGadhave] for APIGEOS-872
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_offer_owner", offer_owner);
                    //command.Parameters.AddWithValue("_offerOwnerName", System.Text.RegularExpressions.Regex.Unescape(offerOwner));                  
                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {

                            if (dr["Email"] != DBNull.Value)
                            {
                                Email = dr["Email"].ToString();
                                return true;
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsOfferOwnerExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                return false;
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error IsOfferOwnerExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

        }



        //chitra.girigosavi[APIGEOS-1322][04/03/2025]
        public string GetCommercialOffersPath(string AppSettingName, string LoginContext)
        {
            string DefaultValue = string.Empty;
            try
            {
                Log4NetLogger.Logger.Log("Method GetCommercialOffersPath()....", category: Category.Info, priority: Priority.Low);

                using (MySqlConnection conn = new MySqlConnection(LoginContext))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetCommercialOffersPath_V800", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_SettingName", AppSettingName);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["SettingValue"] != DBNull.Value)
                            {
                                DefaultValue = dr["SettingValue"].ToString();
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log("Method GetCommercialOffersPath()....Executed successfully.", category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log($"Error GetCommercialOffersPath(). ErrorMessage- {ex.Message}", category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return DefaultValue;
        }

        //chitra.girigosavi[APIGEOS-1322][04/03/2025]
        public string GetFileServerIp(Int64 IdOffer, string LoginContext)
        {
            string fileServerIP = string.Empty;

            try
            {
                Log4NetLogger.Logger.Log("Method GetFileServerIp()....", category: Category.Info, priority: Priority.Low);

                using (MySqlConnection conn = new MySqlConnection(LoginContext))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetFileServerIp_V800", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_IdOffer", IdOffer);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read() && dr["FileServerPath"] != DBNull.Value)
                        {
                            fileServerIP = dr["FileServerPath"].ToString();
                        }
                    }
                }

                Log4NetLogger.Logger.Log("Method GetFileServerIp()....Executed successfully.", category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log($"Error GetFileServerIp(). ErrorMessage- {ex.Message}", category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return fileServerIP;
        }

        //chitra.girigosavi[APIGEOS-1322][04/03/2025]
        public string GetCommercialOffersExportPath(string AppSettingName, string LoginContext)
        {
            string DefaultValue = string.Empty;
            try
            {
                Log4NetLogger.Logger.Log("Method GetCommercialOffersExportPath()....", category: Category.Info, priority: Priority.Low);

                using (MySqlConnection conn = new MySqlConnection(LoginContext))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetCommercialOffersExportPath_V800", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_SettingName", AppSettingName);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["SettingValue"] != DBNull.Value)
                            {
                                DefaultValue = dr["SettingValue"].ToString();
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log("Method GetCommercialOffersExportPath()....Executed successfully.", category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log($"Error GetCommercialOffersExportPath(). ErrorMessage- {ex.Message}", category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return DefaultValue;
        }

        public bool CreateFolderOffer(CreateOpportunityModel offer, string plantOwner, string connectionString, string commericalPath, string workbenchConnectionString, string WorkingOrdersPath, bool? isNewFolderForOffer = null)
        {
            string basepath0 = "";
            string basepath = "";
            string path = string.Empty;
            string year = string.Empty;

            year = DateTime.Now.Year.ToString();

            try
            {
                // EmdepSite site = GetEmdepSiteById(Convert.ToInt32(offerSiteId), connectionString);
                //op -> ot 
                offer.CommercialOffersPath = GetCommercialOffersPath("CommercialOffersPath", connectionString); //chitra.girigosavi[APIGEOS-1322][04/03/2025]
                offer.FileServerIP = GetFileServerIp(offer.IdOffer, connectionString);

                if (offer.IdOfferType == 1)
                {
                    //basepath = commericalPath.Replace("{0}", plantOwner);

                    //chitra.girigosavi[APIGEOS-1322][04/03/2025]
                    commericalPath = offer.CommercialOffersPath;
                    basepath0 = commericalPath.Replace("{0}", offer.FileServerIP);
                    basepath = basepath0.Replace("{1}", plantOwner);

                    //if (plantOwner == "EARO" || plantOwner == "EBRO" || plantOwner == "ENRU")
                    //{
                    //    basepath = basepath.Replace("GCM", "GCMR");
                    //}
                    //if (plantOwner == "ETMA" || plantOwner == "ESMA1" || plantOwner == "ESMA2")
                    //{
                    //    basepath = basepath.Replace("GCM", "GCMM");
                    //}
                    //if (plantOwner == "ESCN")
                    //{
                    //    basepath = basepath.Replace("GCM", "GCMCN");
                    //}
                    //if (plantOwner == "ETTN")
                    //{
                    //    basepath = basepath.Replace("GCM", "GCMT");
                    //}
                    //if (plantOwner == "EPIN")
                    //{
                    //    basepath = basepath.Replace("GCM", "GCMIN");
                    //}
                    if (plantOwner == "EAES" || plantOwner == "ETHQ")
                    {
                        basepath = basepath.Replace("GCM", "GCM");
                    }
                    else if (plantOwner == "EIBR")
                    {
                        basepath = basepath.Replace("GCM", "GCMB");
                    }
                    else if (plantOwner == "EARO" || plantOwner == "EBRO" || plantOwner == "ENRU")
                    {
                        basepath = basepath.Replace("GCM", "GCMR");
                    }
                    else if (plantOwner == "ETMA" || plantOwner == "ESMA1" || plantOwner == "ESMA2")
                    {
                        basepath = basepath.Replace("GCM", "GCMM");
                    }
                    else if (plantOwner == "ESCN" || plantOwner == "ETCN")
                    {
                        basepath = basepath.Replace("GCM", "GCMCN");
                    }
                    else if (plantOwner == "ETTN")
                    {
                        basepath = basepath.Replace("GCM", "GCMT");
                    }
                    else if (plantOwner == "EPIN")
                    {
                        basepath = basepath.Replace("GCM", "GCMIN");
                    }
                    else if (plantOwner == "EJMX1" || plantOwner == "EJMX2" || plantOwner == "ESMX" || plantOwner == "EAMX")
                    {
                        basepath = basepath.Replace("GCM", "GCMX");
                    }
                    else if (plantOwner == "ESHN")
                    {
                        basepath = basepath.Replace("GCM", "GCMH");
                    }
                    else if (plantOwner == "EEPY")
                    {
                        basepath = basepath.Replace("GCM", "GCMPY");
                    }
                    else
                    {
                        basepath = basepath.Replace("GCM", ("GCM" + GetAllPlant(plantOwner.Trim())).Trim());
                    }
                    //else if (plantOwner == "EAMX")
                    //{
                    //    basepath = basepath.Replace("GCM", "GCMMX");
                    //}                  

                    //chitra.girigosavi[APIGEOS-1322][04/03/2025]
                    if (!Directory.Exists(basepath))
                    {
                        Directory.CreateDirectory(basepath);
                    }

                    string newOffersPath = Path.Combine(basepath, year.ToString());

                    if (!Directory.Exists(newOffersPath))
                    {
                        Directory.CreateDirectory(newOffersPath);
                    }
                    basepath = newOffersPath;

                    //if (!ExistsDirectory(basepath + " " + year))
                    //{
                    //    string newOffersPath = basepath + " " + year;
                    //    CreateDirectory(newOffersPath);
                    //}

                    //basepath = basepath + " " + year;

                    string _fullName = GetGroupPlantFullName(offer.IdOffer, connectionString);
                    if (!ExistsDirectory(System.IO.Path.Combine(basepath, _fullName)))
                    {
                        string newCustomerPath = System.IO.Path.Combine(basepath, _fullName);
                        CreateDirectory(newCustomerPath);
                    }
                    basepath = System.IO.Path.Combine(basepath, _fullName);


                    if (!ExistsDirectory(System.IO.Path.Combine(basepath, offer.OfferCode)))
                    {
                        string newOfferPath = System.IO.Path.Combine(basepath, offer.OfferCode);
                        CreateDirectory(newOfferPath);
                    }
                    basepath = basepath + "\\" + offer.OfferCode;

                    if (isNewFolderForOffer.HasValue && isNewFolderForOffer.Value)
                    {
                        GeosAppSettings geosAppSetting = GetGeosAppSettings(6, workbenchConnectionString);

                        if (geosAppSetting != null && !string.IsNullOrEmpty(geosAppSetting.defaultValue))
                        {
                            List<string> folders_offers = geosAppSetting.defaultValue.Split(';').ToList();

                            foreach (string folder in folders_offers)
                            {
                                string docPath = System.IO.Path.Combine(basepath, folder.Trim());

                                if (!ExistsDirectory(docPath))
                                {
                                    CreateDirectory(docPath);
                                }
                            }
                        }


                        //chitra.girigosavi APIGEOS-1190 5/08/2024 Add support for adding attachments in items and orders (1/4)
                        // Save files to the specified path
                        if (offer.file_details != null)
                        {
                            string newFolderPath = Path.Combine(basepath, "01 - QUOTATIONS");

                            foreach (var fileDetail in offer.file_details)
                            {
                                var filePath = Path.Combine(newFolderPath, fileDetail.FileName);
                                if (!Directory.Exists(Path.GetDirectoryName(filePath)))
                                {
                                    Directory.CreateDirectory(Path.GetDirectoryName(filePath));
                                }
                                File.WriteAllBytes(filePath, fileDetail.FileData);
                            }
                        }
                    }
                    else
                    {
                        if (!ExistsDirectory(System.IO.Path.Combine(basepath, "DOC_TECNICA")))
                        {
                            string docPath = System.IO.Path.Combine(basepath, "DOC_TECNICA");
                            CreateDirectory(docPath);
                        }

                        if (!ExistsDirectory(System.IO.Path.Combine(basepath, "OFERTAS")))
                        {
                            string offerPath = System.IO.Path.Combine(basepath, "OFERTAS");
                            CreateDirectory(offerPath);
                        }

                        if (!ExistsDirectory(System.IO.Path.Combine(basepath, "OT")))
                        {
                            string otPath = System.IO.Path.Combine(basepath, "OT");
                            CreateDirectory(otPath);
                        }

                        if (!ExistsDirectory(System.IO.Path.Combine(basepath, "PLANOS")))
                        {
                            string drawingsPath = System.IO.Path.Combine(basepath, "PLANOS");
                            CreateDirectory(drawingsPath);
                        }

                        if (!ExistsDirectory(System.IO.Path.Combine(basepath, "TRACKINGS")))
                        {
                            string trackPath = System.IO.Path.Combine(basepath, "TRACKINGS");
                            CreateDirectory(trackPath);
                        }

                        if (!ExistsDirectory(System.IO.Path.Combine(basepath, "SHIPMENTS")))
                        {
                            string trackPath = System.IO.Path.Combine(basepath, "SHIPMENTS");
                            CreateDirectory(trackPath);
                        }

                        if (!ExistsDirectory(System.IO.Path.Combine(basepath, "PO")))
                        {
                            string trackPath = System.IO.Path.Combine(basepath, "PO");
                            CreateDirectory(trackPath);
                        }
                    }

                    string WorkingOrder = string.Empty;
                    WorkingOrder = WorkingOrdersPath.Replace("{0}", plantOwner);
                    WorkingOrder = WorkingOrder.Replace("{1}", year);
                    WorkingOrder = WorkingOrder.Replace("{2}", offer.OfferCode);
                    //basepath = System.IO.Path.Combine(WorkingOrder, year);
                    basepath = System.IO.Path.Combine(WorkingOrder);
                    if (isNewFolderForOffer.HasValue && isNewFolderForOffer.Value)
                    {
                        GeosAppSettings geosAppSetting = GetGeosAppSettings(45, workbenchConnectionString);

                        if (geosAppSetting != null && !string.IsNullOrEmpty(geosAppSetting.defaultValue))
                        {
                            List<string> folders_offers = geosAppSetting.defaultValue.Split(';').ToList();

                            foreach (string folder in folders_offers)
                            {
                                string docPath = System.IO.Path.Combine(basepath, folder.Trim());

                                if (!ExistsDirectory(docPath))
                                {
                                    CreateDirectory(docPath);
                                }
                            }
                        }

                        //chitra.girigosavi APIGEOS-1190 5/08/2024 Add support for adding attachments in items and orders (1/4)
                        // Save files to the specified path
                        if (offer.quotations != null)
                        {
                            foreach (var quotation in offer.quotations)
                            {
                                if (quotation.revisions != null)
                                {
                                    foreach (var revision in quotation.revisions)
                                    {
                                        if (revision.items != null)
                                        {
                                            foreach (var item in revision.items)
                                            {
                                                if (item.file_details != null)
                                                {

                                                    string quotationsCode = string.Empty;
                                                    quotationsCode = WorkingOrdersPath.Replace("{0}", plantOwner);
                                                    quotationsCode = quotationsCode.Replace("{1}", year);
                                                    quotationsCode = quotationsCode.Replace("{2}", quotation.QuotationCode);
                                                    //basepath = System.IO.Path.Combine(WorkingOrder, year);
                                                    basepath = System.IO.Path.Combine(quotationsCode);
                                                    string itemFolderPath = Path.Combine(basepath, "Additional Information");
                                                    try
                                                    {
                                                        if (!ExistsDirectory(itemFolderPath))
                                                        {
                                                            CreateDirectory(itemFolderPath);
                                                        }
                                                    }
                                                    catch (Exception ex) { }

                                                    foreach (var fileDetail in item.file_details)
                                                    {
                                                        var filePath = Path.Combine(itemFolderPath, fileDetail.FileName);
                                                        if (!Directory.Exists(Path.GetDirectoryName(filePath)))
                                                        {
                                                            Directory.CreateDirectory(Path.GetDirectoryName(filePath));
                                                        }
                                                        File.WriteAllBytes(filePath, fileDetail.FileData);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                #region
                //if (offer.IdOfferType == 1)
                //{
                //string WorkingOrdersPath = @"\\10.0.9.7\{0}FS01\workingOrders${1}\{2}\";


                //}


                //if (!ExistsDirectory(basepath))
                //{
                //    CreateDirectory(basepath);
                //}

                //basepath = System.IO.Path.Combine(basepath, offer.OfferCode);
                //if (!ExistsDirectory(basepath))
                //{
                //    CreateDirectory(basepath);
                //}


                //{
                //    path = System.IO.Path.Combine(basepath, "01 Project Specifications");
                //    if (!ExistsDirectory(path))
                //    {
                //        CreateDirectory(path);
                //    }

                //    path = System.IO.Path.Combine(basepath, "02 Engineering Analysis");
                //    if (!ExistsDirectory(path))
                //    {
                //        CreateDirectory(path);
                //    }

                //    path = System.IO.Path.Combine(basepath, "03 Production Documentation");
                //    if (!ExistsDirectory(path))
                //    {
                //        CreateDirectory(path);
                //    }
                //    path = System.IO.Path.Combine(basepath, "04 Drawings");
                //    if (!ExistsDirectory(path))
                //    {
                //        CreateDirectory(path);
                //    }
                //    path = System.IO.Path.Combine(basepath, "05 Backup");
                //    if (!ExistsDirectory(path))
                //    {
                //        CreateDirectory(path);
                //    }
                //    path = System.IO.Path.Combine(basepath, "06 Pictures");
                //    if (!ExistsDirectory(path))
                //    {
                //        CreateDirectory(path);
                //    }
                //    path = System.IO.Path.Combine(basepath, "07 QA Documents");
                //    if (!ExistsDirectory(path))
                //    {
                //        CreateDirectory(path);
                //    }
                //    path = System.IO.Path.Combine(basepath, "08 Official Documentation");
                //    if (!ExistsDirectory(path))
                //    {
                //        CreateDirectory(path);
                //    }
                //}

                // Engineering Analysis
                //string engAnalysisPath = System.IO.Path.Combine(workingOrdersPath);
                //  CopyAttachmentFolderFiles(offer, offerSiteId, workingOrdersPath);
                #endregion

                return true;
            }
            catch (Exception ex)
            {

                throw;
            }
        }
        public bool CreateFolderOffer_V740(CreateOpportunityModel offer, string plantOwner, string connectionString, string commericalPath, string workbenchConnectionString, string WorkingOrdersPath, bool? isNewFolderForOffer = null)
        {
            string basepath = "";
            string path = string.Empty;
            string year = string.Empty;

            year = DateTime.Now.Year.ToString();

            try
            {
                #region //chitra.girigosavi[APIGEOS-1322][04/03/2025]
                offer.CommercialOffersPath = GetCommercialOffersPath("CommercialOffersPath", connectionString); //chitra.girigosavi[APIGEOS-1322][04/03/2025]
                offer.FileServerIP = GetFileServerIp(offer.IdOffer, connectionString);

                //chitra.girigosavi[APIGEOS-1322][04/03/2025]
                commericalPath = offer.CommercialOffersPath;
                string basepath0 = commericalPath.Replace("{0}", offer.FileServerIP);
                basepath = basepath0.Replace("{1}", plantOwner);

                if (!Directory.Exists(basepath))
                {
                    Directory.CreateDirectory(basepath);
                }

                string newOffersPath = Path.Combine(basepath, year.ToString());

                if (!Directory.Exists(newOffersPath))
                {
                    Directory.CreateDirectory(newOffersPath);
                }

                basepath = newOffersPath;

                #endregion
                //basepath = commericalPath.Replace("{0}", plantOwner);
                //basepath = basepath.Replace("GCM", ("GCM" + GetAllPlant(plantOwner.Trim())).Trim());
                //basepath = basepath + " " + year;

                string _fullName = GetGroupPlantFullName(offer.IdOffer, connectionString);
                if (!ExistsDirectory(System.IO.Path.Combine(basepath, _fullName)))
                {
                    string newCustomerPath = System.IO.Path.Combine(basepath, _fullName);
                    CreateDirectory(newCustomerPath);
                }
                basepath = System.IO.Path.Combine(basepath, _fullName);


                if (!ExistsDirectory(System.IO.Path.Combine(basepath, offer.OfferCode)))
                {
                    string newOfferPath = System.IO.Path.Combine(basepath, offer.OfferCode);
                    CreateDirectory(newOfferPath);
                }
                basepath = basepath + "\\" + offer.OfferCode;
                //chitra.girigosavi APIGEOS-1190 5/08/2024 Add support for adding attachments in items and orders (1/4)
                // Save files to the specified path
                if (offer.file_details != null)
                {
                    string newFolderPath = Path.Combine(basepath, "01 - QUOTATIONS");

                    foreach (var fileDetail in offer.file_details)
                    {
                        var filePath = Path.Combine(newFolderPath, fileDetail.FileName);
                        if (!Directory.Exists(Path.GetDirectoryName(filePath)))
                        {
                            Directory.CreateDirectory(Path.GetDirectoryName(filePath));
                        }
                        File.WriteAllBytes(filePath, fileDetail.FileData);
                    }
                }

                string WorkingOrder = string.Empty;
                WorkingOrder = WorkingOrdersPath.Replace("{0}", plantOwner);
                WorkingOrder = WorkingOrder.Replace("{1}", year);
                //WorkingOrder = WorkingOrder.Replace("{2}", offer.OfferCode);
                //basepath = System.IO.Path.Combine(WorkingOrder);
                //chitra.girigosavi APIGEOS-1190 5/08/2024 Add support for adding attachments in items and orders (1/4)
                // Save files to the specified path
                if (offer.quotations != null)
                {
                    foreach (var quotation in offer.quotations)
                    {
                        if (quotation.revisions != null)
                        {
                            foreach (var revision in quotation.revisions)
                            {
                                if (revision.items != null)
                                {
                                    foreach (var item in revision.items)
                                    {
                                        if (item.file_details != null)
                                        {
                                            string quotationsCode = string.Empty;
                                            quotationsCode = WorkingOrdersPath.Replace("{0}", plantOwner);
                                            quotationsCode = quotationsCode.Replace("{1}", year);
                                            quotationsCode = quotationsCode.Replace("{2}", (quotation.QuotationCode == null ? offer.OfferCode : quotation.QuotationCode));
                                            //basepath = System.IO.Path.Combine(WorkingOrder, year);
                                            basepath = System.IO.Path.Combine(quotationsCode);
                                            string itemFolderPath = Path.Combine(basepath, "Additional Information");
                                            try
                                            {
                                                if (!ExistsDirectory(itemFolderPath))
                                                {
                                                    CreateDirectory(itemFolderPath);
                                                }
                                            }
                                            catch (Exception ex) { }
                                            foreach (var fileDetail in item.file_details)
                                            {
                                                var filePath = Path.Combine(itemFolderPath, fileDetail.FileName);
                                                if (!Directory.Exists(Path.GetDirectoryName(filePath)))
                                                {
                                                    Directory.CreateDirectory(Path.GetDirectoryName(filePath));
                                                }
                                                File.WriteAllBytes(filePath, fileDetail.FileData);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                return true;
            }
            catch (Exception ex)
            {

                throw;
            }
        }

        //Shubham[skadam] APIGEOS-1196 Support for new creation of folder path for offer 31 07 2024
        public string GetAllPlant(string Code)
        {
            string code = string.Empty;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetAllPlant()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(_ConnString))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetEmdepSitesByName", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_Name", Code);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["Code"] != DBNull.Value)
                            {
                                code = Convert.ToString(dr["Code"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetAllPlant()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetAllPlant(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
            }
            return code;
        }
        public GeosAppSettings GetGeosAppSettings(Int16 IdAppSetting, string connectionString)
        {
            GeosAppSettings geosAppSetting = new GeosAppSettings();

            using (MySqlConnection MyConnection = new MySqlConnection(connectionString))
            {
                MyConnection.Open();
                MySqlCommand myCommand = new MySqlCommand("geosappsettings_GetGeosAppSettings", MyConnection);
                myCommand.CommandType = CommandType.StoredProcedure;
                myCommand.Parameters.AddWithValue("_IdAppSetting", IdAppSetting);

                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        geosAppSetting.idAppSetting = IdAppSetting;
                        geosAppSetting.defaultValue = reader["DefaultValue"].ToString();
                        geosAppSetting.appSettingName = reader["AppSettingName"].ToString();
                    }

                    reader.Close();
                }

                myCommand.Dispose();
                MyConnection.Close();
            }

            return geosAppSetting;
        }
        public bool ExistsDirectory(string path)
        {
            return Directory.Exists(path);
        }
        public void CreateDirectory(string path)
        {
            Directory.CreateDirectory(path);
        }
        public Int32 GetCreateArticelId(string reference, string connstr)
        {
            Int32 idArticle = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetCreateArticelId()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetArticleDetailByReference", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_Reference", reference);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["idArticle"] != DBNull.Value)
                            {
                                idArticle = Convert.ToInt32(dr["idArticle"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetCreateArticelId()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetCreateArticelId(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idArticle;
        }
        public Int32 GetCreateCCProductlId(string reference, string connstr)
        {
            Int32 idCProduct = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetCreateCCProductlId()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetCPProductDetailByReference", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_Reference", reference);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdCP"] != DBNull.Value)
                            {
                                idCProduct = Convert.ToInt32(dr["IdCP"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetCreateCCProductlId()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetCreateCCProductlId(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idCProduct;
        }
        public Int32 GetIdCPTypeByIdName(string name, string connstr)
        {
            Int32 IdCPType = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetIdCPTypeByIdName()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetIdCPTypeByIdName", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_Name", name);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdCPType"] != DBNull.Value)
                            {
                                IdCPType = Convert.ToInt32(dr["IdCPType"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetIdCPTypeByIdName()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetIdCPTypeByIdName(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return IdCPType;
        }
        public Int32 GetDetectionIDeByIdName(string name, string connstr)
        {
            Int32 IdDetection = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetDetectionIDeByIdName()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetDetectionIDByIdName", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_Name", name);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdDetection"] != DBNull.Value)
                            {
                                IdDetection = Convert.ToInt32(dr["IdDetection"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetDetectionIDeByIdName()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetDetectionIDeByIdName(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return IdDetection;
        }
        public bool IsIdDrawingExist(string connectionString, Int64? idDrawing)
        {
            bool isExist = false;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsIdDrawingExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsIdDrawingExist", con);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("@_IdDrawing", idDrawing);
                    using (MySqlDataReader reader = command.ExecuteReader())
                    {
                        if (reader.Read())
                        {
                            if (reader["IdDrawing"] != DBNull.Value)
                            {
                                isExist = true;
                            }
                            else
                                isExist = false;
                        }
                        else
                        {
                            isExist = false;
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsIdDrawingExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                isExist = false;
                Log4NetLogger.Logger.Log(string.Format("Error IsIdDrawingExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return isExist;
        }
        public bool IsPurchaseOrdersExist(string Code, string connectionString)
        {
            bool isExist = false;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsPurchaseOrdersExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsPurchaseOrdersExist", con);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_Code", Code);
                    using (MySqlDataReader reader = command.ExecuteReader())
                    {
                        if (reader.Read())
                        {
                            if (reader["idCustomerPurchaseOrders"] != DBNull.Value)
                            {
                                isExist = true;
                            }
                            else
                                isExist = false;
                        }
                        else
                        {
                            isExist = false;
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsPurchaseOrdersExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                isExist = false;
                Log4NetLogger.Logger.Log(string.Format("Error IsPurchaseOrdersExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return isExist;
        }
        // Added By Rahul[RGadhave] for APIGEOS-872
        public CreateOpportunityModel AddQuotations_V2041(CreateOpportunityModel offer, string connectionstring, Int64 quotationNumDays, int idItemOtStatus)
        {
            try
            {

                #region products_list
                //List<int> old = new List<int> { 5, 15, 16, 9};
                List<ProductsList> products_list = new List<ProductsList>();
                List<string> oldproductList = new List<string> { "Material", "Transport", "Technical Assistance", "Component" };
                try
                {
                    foreach (var item in oldproductList)
                    {
                        if (offer.products_list.Any(p => p.product_type.ToLower().Equals(item.ToLower())))
                        {
                            ProductsList products = offer.products_list.Where(w => w.product_type.ToLower().Equals(item.ToLower())).FirstOrDefault();
                            products_list.Add(products);
                        }
                    }

                    foreach (ProductsList product in offer.products_list)
                    {
                        if (!products_list.Any(p => p.product_type.ToLower().Equals(product.product_type.ToLower())))
                        {
                            products_list.Add(product);
                        }
                    }
                    if (products_list.Count == offer.products_list.Count)
                    {
                        offer.products_list = new List<ProductsList>();
                        offer.products_list.AddRange(products_list);
                    }
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error AddQuotations_V2041(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                }
                #endregion

                foreach (ProductsList productList in offer.products_list)
                {
                    if (offer.OptionByOffers == null)
                        offer.OptionByOffers = new List<OptionByOffer>();

                    OptionByOffer optionByOffer = new OptionByOffer();
                    optionByOffer.IdOffer = offer.IdOffer;
                    optionByOffer.IdOption = IsOfferOptionExist(connectionstring, productList.product_type);
                    optionByOffer.Quantity = Convert.ToInt32(productList.product_quantity);
                    offer.OptionByOffers.Add(optionByOffer);
                }
                foreach (OptionByOffer optionsByOffer in offer.OptionByOffers)
                {
                    List<OTItem> itemsJSONDATA = new List<OTItem>();
                    List<Template> selectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);


                    using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                    {
                        conquotation.Open();

                        //using (MySqlTransaction trans = conquotation.BeginTransaction())
                        //{
                        try
                        {
                            MySqlCommand conquotationcommand = new MySqlCommand("optionsbyoffer_Insert", conquotation);
                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                            conquotationcommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                            conquotationcommand.Parameters.AddWithValue("_Quantity", optionsByOffer.Quantity);
                            //   conquotationcommand.Transaction = trans;
                            conquotationcommand.ExecuteNonQuery();

                            //   trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            //trans.Rollback();
                            throw;
                        }
                        //}
                    }

                    foreach (Template quotation in selectedOptionTemplates)
                    {
                        Int64 idQuotation = 0;
                        GEOSAPIQuotation tempquotation = new GEOSAPIQuotation();

                        tempquotation.IdOffer = offer.IdOffer;
                        tempquotation.Year = DateTime.Now.Year;
                        tempquotation.Number = offer.OfferNumber;
                        tempquotation.Code = offer.OfferCode + quotation.Suffix;
                        tempquotation.CreatedIn = DateTime.Now;
                        tempquotation.Template = new Template();
                        tempquotation.Template = quotation;

                        if (quotation.IdTemplate != 0)
                        {
                            string quotationCode = offer.OfferCode + quotation.Suffix;
                            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                            {
                                conquotation.Open();
                                //using (MySqlTransaction trans = conquotation.BeginTransaction())
                                //{
                                try
                                {
                                    MySqlCommand conquotationcommand = new MySqlCommand("quotations_Insert", conquotation);
                                    conquotationcommand.CommandType = CommandType.StoredProcedure;
                                    conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conquotationcommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conquotationcommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conquotationcommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                    conquotationcommand.Parameters.AddWithValue("_Number", offer.OfferNumber);
                                    conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                    conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                    conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                    conquotationcommand.Parameters.AddWithValue("_QuotQuantity", 0);
                                    // conquotationcommand.Transaction = trans;
                                    idQuotation = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                    try
                                    {
                                        CreateQuotation CreateQuotation = offer.quotations.FirstOrDefault(f => f.template.Trim().ToLower().Equals(quotation.Name.Trim().ToLower()));
                                        CreateQuotation.QuotationCode = quotationCode;
                                        CreateQuotation.IdTemplate = quotation.IdTemplate;
                                    }
                                    catch (Exception ex)
                                    {

                                    }
                                    if (idQuotation > 0)
                                    {
                                        tempquotation.IdQuotation = idQuotation;
                                        bool isinsert = false;
                                        MySqlCommand conoffercommand = new MySqlCommand("revisions_GetrevisionsByIdQuotation", conquotation);
                                        conoffercommand.CommandType = CommandType.StoredProcedure;
                                        conoffercommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                        using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                                        {
                                            if (!offerreader.Read())
                                            {
                                                isinsert = true;
                                            }
                                        }

                                        if (isinsert)
                                        {
                                            GEOSAPIRevision r = new GEOSAPIRevision();
                                            r.numRevision = 0;
                                            //[001]
                                            if (offer.IdCreatedBy != null && offer.IdCreatedBy == 164)
                                            {
                                                r.createdBy = 164;
                                                r.reviewedBy = 164;
                                            }
                                            else
                                            {
                                                r.createdBy = offer.IdCreatedBy;
                                                r.reviewedBy = offer.IdCreatedBy;
                                            }
                                            r.createdIn = DateTime.Now;
                                            r.numRevision = 0;
                                            r.discount = 0;
                                            //r.expireDate = Convert.ToDateTime(offer.quote_sent_date.Date).AddDays(quotationNumDays);
                                            r.expireDate = Convert.ToDateTime(offer.quote_sent_date).AddDays(quotationNumDays);
                                            r.comments = offer.Contact + "\r\n" + offer.Description;
                                            //r.Quotation = quotation;
                                            //if (quotation.IdTemplate == 15 || quotation.IdTemplate == 16 || quotation.IdTemplate == 18) //04 06 2021 code for reactivate revisions in Technical Assistance and Transport
                                            if (quotation.IdTemplate == 16 || quotation.IdTemplate == 18)
                                                r.approvedIn = DateTime.Now;
                                            else
                                                r.approvedIn = Convert.ToDateTime("0001-01-01 00:00:00");

                                            conquotationcommand = new MySqlCommand("revisions_Insert", conquotation);
                                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                                            conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                                            conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r.reviewedBy);
                                            conquotationcommand.Parameters.AddWithValue("_NumRevision", r.numRevision);
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.IdCreatedBy);
                                            conquotationcommand.Parameters.AddWithValue("_MadeBy", r.createdBy);
                                            conquotationcommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                            conquotationcommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                            conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r.expireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                                            conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                                            conquotationcommand.Parameters.AddWithValue("_CreationDate", r.createdIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                            conquotationcommand.Parameters.AddWithValue("_Comments", r.comments);
                                            conquotationcommand.Parameters.AddWithValue("_Closed", r.approvedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                            // conquotationcommand.Transaction = trans;
                                            r.id = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                            tempquotation.Revisions = new List<GEOSAPIRevision>();
                                            tempquotation.Revisions.Add(r);
                                            if (quotation.IdTemplate == 5 || quotation.IdTemplate == 15)
                                            {
                                                if (offer.quotations != null)
                                                    foreach (CreateQuotation item in offer.quotations.Where(q => q.template.ToUpper() == quotation.Name.ToUpper()))
                                                    {
                                                        if (item.revisions != null)
                                                            foreach (CreateRevision rev in item.revisions)
                                                            {
                                                                int itemNumber = 0;
                                                                if (rev.items != null)
                                                                    foreach (CreateRevisionItem revitems in rev.items)
                                                                    {
                                                                        itemNumber = itemNumber + 1;
                                                                        Int32 idArticle = GetCreateArticelId(revitems.reference, connectionstring);

                                                                        OTItem oi = new OTItem();
                                                                        oi.revisionItem = new GEOSAPIRevisionItem();
                                                                        oi.revisionItem.warehouseProduct = new GEOSAPIWarehouseProduct();
                                                                        oi.revisionItem.warehouseProduct.article = new WarehouseProductArticle();
                                                                        oi.itemOTStatusType = new GEOSAPIItemOTStatusType();

                                                                        oi.revisionItem.warehouseProduct.article.idArticle = idArticle;
                                                                        oi.revisionItem.warehouseProduct.article.quantity = (double)revitems.quantity;
                                                                        oi.revisionItem.warehouseProduct.article.saleUnitPrice = (double)revitems.sale_unit_price;
                                                                        oi.revisionItem.warehouseProduct.article.description = revitems.name;
                                                                        oi.revisionItem.warehouseProduct.article.description_es = revitems.name;
                                                                        oi.revisionItem.warehouseProduct.article.description_fr = revitems.name;
                                                                        //oi.itemOTStatusType.idItemOtStatus = 1;
                                                                        //oi.itemOTStatusType.idItemOtStatus = GetOffer_Item_StatusByAppSettingName("Offer_Item_Status", LoginContext);
                                                                        oi.itemOTStatusType.idItemOtStatus = idItemOtStatus;
                                                                        oi.revisionItem.warehouseProduct.article.discount = revitems.discount;
                                                                        oi.revisionItem.customerComment = revitems.comments;
                                                                        if (revitems.file_details != null)
                                                                        {
                                                                            if (oi.revisionItem.createRevisionItem == null)
                                                                            {
                                                                                oi.revisionItem.createRevisionItem = new CreateRevisionItem();
                                                                            }
                                                                            oi.revisionItem.createRevisionItem.file_details = revitems.file_details;  //chitra.girigosavi APIGEOS-1190 5/08/2024 Add support for adding attachments in items and orders (1/4)
                                                                        }
                                                                        itemsJSONDATA.Add(oi);
                                                                        #region APIGEOS-633
                                                                        // Created by shubham[skadam] for APIGEOS endpoint SALES->Opportunities->Create  https://helpdesk.emdep.com/browse/APIGEOS-633  DATE 08 11 2022
                                                                        List<OfferAddtionalComponents> AddtionalComponents = GetExistAddtionalComponents(idArticle, offer.siteDetail.IdSite, Convert.ToInt32(offer.IdCurrency), connectionstring);
                                                                        if (AddtionalComponents.Count != 0)
                                                                        {
                                                                            foreach (var addtionalComponentsitem in AddtionalComponents)
                                                                            {
                                                                                OTItem oiForaddtionalComponen = new OTItem();
                                                                                oiForaddtionalComponen.revisionItem = new GEOSAPIRevisionItem();
                                                                                oiForaddtionalComponen.revisionItem.warehouseProduct = new GEOSAPIWarehouseProduct();
                                                                                oiForaddtionalComponen.revisionItem.warehouseProduct.article = new WarehouseProductArticle();
                                                                                oiForaddtionalComponen.itemOTStatusType = new GEOSAPIItemOTStatusType();

                                                                                oiForaddtionalComponen.revisionItem.warehouseProduct.article.idArticle = Convert.ToInt32(addtionalComponentsitem.IdAdditionalArticle);
                                                                                oiForaddtionalComponen.revisionItem.warehouseProduct.article.quantity = (double)addtionalComponentsitem.Quantity;
                                                                                oiForaddtionalComponen.revisionItem.warehouseProduct.article.saleUnitPrice = (double)addtionalComponentsitem.Price;
                                                                                oiForaddtionalComponen.revisionItem.warehouseProduct.article.description = addtionalComponentsitem.Description;
                                                                                oiForaddtionalComponen.revisionItem.warehouseProduct.article.description_es = addtionalComponentsitem.Description;
                                                                                oiForaddtionalComponen.revisionItem.warehouseProduct.article.description_fr = addtionalComponentsitem.Description;
                                                                                oiForaddtionalComponen.itemOTStatusType.idItemOtStatus = idItemOtStatus;
                                                                                oiForaddtionalComponen.revisionItem.warehouseProduct.article.Parent = itemNumber;
                                                                                //oiForaddtionalComponen.revisionItem.warehouseProduct.article.discount = revitems.discount;
                                                                                //oiForaddtionalComponen.revisionItem.customerComment = revitems.comments;
                                                                                itemsJSONDATA.Add(oiForaddtionalComponen);
                                                                            }
                                                                        }
                                                                        #endregion
                                                                    }

                                                            }
                                                    }
                                            }
                                            else if (quotation.IdTemplate == 16)
                                            {
                                                List<Int32> idsArticle = new List<int>();
                                                List<CreateRevisionItem> revitem = new List<CreateRevisionItem>();
                                                List<OTItem> otQuotRevItems = new List<OTItem>();
                                                if (offer.quotations != null)
                                                    foreach (CreateQuotation item in offer.quotations.Where(q => q.template.ToUpper() == quotation.Name.ToUpper()))
                                                    {
                                                        if (item.revisions != null)
                                                            foreach (CreateRevision rev in item.revisions)
                                                            {
                                                                if (rev.items != null)
                                                                {
                                                                    revitem = rev.items;
                                                                    foreach (CreateRevisionItem revitems in rev.items)
                                                                    {
                                                                        Int32 idArticle = GetCreateArticelId(revitems.reference, connectionstring);
                                                                        revitems.idArticle = idArticle;

                                                                        OTItem oi = new OTItem();
                                                                        oi.revisionItem = new GEOSAPIRevisionItem();
                                                                        oi.revisionItem.warehouseProduct = new GEOSAPIWarehouseProduct();
                                                                        oi.revisionItem.warehouseProduct.article = new WarehouseProductArticle();
                                                                        oi.itemOTStatusType = new GEOSAPIItemOTStatusType();

                                                                        oi.revisionItem.warehouseProduct.article.idArticle = idArticle;
                                                                        oi.revisionItem.warehouseProduct.article.quantity = (double)revitems.quantity;
                                                                        oi.revisionItem.warehouseProduct.article.saleUnitPrice = (double)revitems.sale_unit_price;
                                                                        oi.revisionItem.warehouseProduct.article.description = revitems.name;
                                                                        oi.revisionItem.warehouseProduct.article.description_es = revitems.name;
                                                                        oi.revisionItem.warehouseProduct.article.description_fr = revitems.name;
                                                                        oi.itemOTStatusType.idItemOtStatus = 1;
                                                                        oi.revisionItem.warehouseProduct.article.discount = revitems.discount;
                                                                        oi.revisionItem.customerComment = revitems.comments;
                                                                        if (revitems.file_details != null)
                                                                        {
                                                                            if (oi.revisionItem.createRevisionItem == null)
                                                                            {
                                                                                oi.revisionItem.createRevisionItem = new CreateRevisionItem();
                                                                            }
                                                                            oi.revisionItem.createRevisionItem.file_details = revitems.file_details;  //chitra.girigosavi APIGEOS-1190 5/08/2024 Add support for adding attachments in items and orders (1/4)
                                                                        }
                                                                        otQuotRevItems.Add(oi);
                                                                        idsArticle.Add(idArticle);

                                                                    }
                                                                }

                                                            }
                                                    }

                                                List<OTItem> temp = GetDefaultArticlesByOfferOptionAndTemplateRevCheck(offer, optionsByOffer.IdOption, quotation.IdTemplate, connectionstring, revitem);
                                                foreach (Int32 itemIdArticle in idsArticle)
                                                {
                                                    if (otQuotRevItems.Any(o => o.revisionItem.warehouseProduct.article.idArticle == itemIdArticle))
                                                        otQuotRevItems.Remove(otQuotRevItems.Where(o => o.revisionItem.warehouseProduct.article.idArticle == itemIdArticle).FirstOrDefault());
                                                }
                                                if (otQuotRevItems.Count > 0)
                                                    itemsJSONDATA.AddRange(otQuotRevItems);
                                                if (temp.Count > 0)
                                                    CreateQuotationWithItems_V2041(tempquotation, offer, temp, connectionstring);
                                            }
                                            else if (quotation.IdTemplate == 9)
                                            {
                                                List<CreateRevisionItem> createRevisionItem = new List<CreateRevisionItem>();
                                                List<OTItem> ComponentJSONDATA = new List<OTItem>();
                                                if (offer.quotations != null)
                                                    foreach (CreateQuotation item in offer.quotations.Where(q => q.template.ToUpper() == quotation.Name.ToUpper()))
                                                    {
                                                        if (item.revisions != null)
                                                            foreach (CreateRevision rev in item.revisions)
                                                            {
                                                                if (rev.items != null)
                                                                    foreach (CreateRevisionItem revitems in rev.items)
                                                                    {
                                                                        //Int32 idCCProduct = GetCreateCCProductlId(revitems.reference, connectionstring);

                                                                        OTItem oi = new OTItem();
                                                                        List<Createitemsfeatures> featuresList = new List<Createitemsfeatures>();
                                                                        foreach (var featuresitem in revitems.features)
                                                                        {
                                                                            Createitemsfeatures features = new Createitemsfeatures();
                                                                            features.Name = Convert.ToString(featuresitem.Name);
                                                                            features.Quantity = Convert.ToInt32(featuresitem.Quantity);
                                                                            featuresList.Add(features);
                                                                        }
                                                                        //string comments = revitems.comments;
                                                                        //createRevisionItem.IdCP = idCCProduct;
                                                                        CreateRevisionItem revisionItem = new CreateRevisionItem();
                                                                        revisionItem.IdCPType = GetIdCPTypeByIdName(revitems.name, connectionstring);
                                                                        revisionItem.reference = revitems.reference;
                                                                        revisionItem.name = revitems.name;
                                                                        revisionItem.features = featuresList;
                                                                        revisionItem.quantity = revitems.quantity;
                                                                        revisionItem.drawing_ID = revitems.drawing_ID;
                                                                        revisionItem.Ways = revitems.Ways;
                                                                        revisionItem.sale_unit_price = revitems.sale_unit_price;
                                                                        revisionItem.comments = revitems.comments;
                                                                        revisionItem.discount = revitems.discount;
                                                                        //createRevisionItem.Add(revisionItem);
                                                                        oi.revisionItem = new GEOSAPIRevisionItem();
                                                                        //oi.revisionItem.warehouseProduct = new WarehouseProduct();
                                                                        //oi.revisionItem.warehouseProduct.article = new WarehouseProductArticle();
                                                                        oi.itemOTStatusType = new GEOSAPIItemOTStatusType();
                                                                        oi.createRevisionItem = new CreateRevisionItem();
                                                                        //oi.revisionItem.warehouseProduct.article.idArticle = idCCProduct;
                                                                        //oi.revisionItem.warehouseProduct.article.quantity = (double)revitems.quantity;
                                                                        //oi.revisionItem.warehouseProduct.article.saleUnitPrice = (double)revitems.sale_unit_price;
                                                                        //oi.revisionItem.warehouseProduct.article.description = revitems.name;
                                                                        //oi.revisionItem.warehouseProduct.article.description_es = revitems.name;
                                                                        //oi.revisionItem.warehouseProduct.article.description_fr = revitems.name;
                                                                        // oi.itemOTStatusType.idItemOtStatus = 1;
                                                                        //oi.itemOTStatusType.idItemOtStatus = GetOffer_Item_StatusByAppSettingName("Offer_Item_Status", LoginContext);
                                                                        oi.itemOTStatusType.idItemOtStatus = idItemOtStatus;
                                                                        oi.createRevisionItem = revisionItem;
                                                                        if (revitems.file_details != null)
                                                                        {
                                                                            if (oi.revisionItem.createRevisionItem == null)
                                                                            {
                                                                                oi.revisionItem.createRevisionItem = new CreateRevisionItem();
                                                                            }
                                                                            oi.revisionItem.createRevisionItem.file_details = revitems.file_details;  //chitra.girigosavi APIGEOS-1190 5/08/2024 Add support for adding attachments in items and orders (1/4)
                                                                        }                                                                          //itemsJSONDATA.Add(oi);
                                                                        ComponentJSONDATA.Add(oi);


                                                                    }

                                                            }
                                                    }
                                                CreateJSONQuotationWithItemsV207(tempquotation, offer, ComponentJSONDATA, createRevisionItem, connectionstring);
                                            }
                                            //Added By Rahul[rgadhave][APIGEOS-1130][Date:17-05-2024]
                                            if (quotation.IdTemplate == 8 || quotation.IdTemplate == 4 || quotation.IdTemplate == 3 || quotation.IdTemplate == 2 || quotation.IdTemplate == 14 || quotation.IdTemplate == 10 || quotation.IdTemplate == 6 || quotation.IdTemplate == 21)
                                            {
                                                List<CreateRevisionItem> createRevisionItem = new List<CreateRevisionItem>();
                                                List<OTItem> ComponentJSONDATA = new List<OTItem>();
                                                if (offer.quotations != null)
                                                    foreach (CreateQuotation item in offer.quotations.Where(q => q.template.ToUpper() == quotation.Name.ToUpper()))
                                                    {
                                                        if (item.revisions != null)
                                                            foreach (CreateRevision rev in item.revisions)
                                                            {
                                                                if (rev.items != null)
                                                                    foreach (CreateRevisionItem revitems in rev.items)
                                                                    {
                                                                        OTItem oi = new OTItem();
                                                                        List<Createitemsfeatures> featuresList = new List<Createitemsfeatures>();
                                                                        foreach (var featuresitem in revitems.features)
                                                                        {
                                                                            Createitemsfeatures features = new Createitemsfeatures();
                                                                            features.Name = Convert.ToString(featuresitem.Name);
                                                                            features.Quantity = Convert.ToInt32(featuresitem.Quantity);
                                                                            featuresList.Add(features);
                                                                        }

                                                                        CreateRevisionItem revisionItem = new CreateRevisionItem();
                                                                        revisionItem.IdCPType = GetIdCPTypeByIdName(revitems.name, connectionstring);
                                                                        revisionItem.reference = revitems.reference;
                                                                        revisionItem.name = revitems.name;
                                                                        revisionItem.features = featuresList;
                                                                        revisionItem.quantity = revitems.quantity;
                                                                        revisionItem.drawing_ID = revitems.drawing_ID;
                                                                        revisionItem.Ways = revitems.Ways;
                                                                        revisionItem.sale_unit_price = revitems.sale_unit_price;
                                                                        revisionItem.comments = revitems.comments;
                                                                        revisionItem.discount = revitems.discount;
                                                                        oi.revisionItem = new GEOSAPIRevisionItem();
                                                                        oi.itemOTStatusType = new GEOSAPIItemOTStatusType();
                                                                        oi.createRevisionItem = new CreateRevisionItem();
                                                                        oi.itemOTStatusType.idItemOtStatus = idItemOtStatus;
                                                                        oi.createRevisionItem = revisionItem;
                                                                        if (revitems.file_details != null)
                                                                        {
                                                                            if (oi.revisionItem.createRevisionItem == null)
                                                                            {
                                                                                oi.revisionItem.createRevisionItem = new CreateRevisionItem();
                                                                            }
                                                                            oi.revisionItem.createRevisionItem.file_details = revitems.file_details;  //chitra.girigosavi APIGEOS-1190 5/08/2024 Add support for adding attachments in items and orders (1/4)
                                                                        }                                                                          //itemsJSONDATA.Add(oi);
                                                                        ComponentJSONDATA.Add(oi);


                                                                    }

                                                            }
                                                    }
                                                CreateJSONQuotationWithItemsV207(tempquotation, offer, ComponentJSONDATA, createRevisionItem, connectionstring);
                                            }
                                            //Added By Rahul[rgadhave][APIGEOS-1130][Date:17-05-2024]
                                            if (quotation.IdTemplate == 1)
                                            {
                                                List<CreateRevisionItem> createRevisionItem = new List<CreateRevisionItem>();
                                                List<OTItem> ComponentJSONDATA = new List<OTItem>();
                                                if (offer.quotations != null)
                                                    foreach (CreateQuotation item in offer.quotations.Where(q => q.template.ToUpper() == quotation.Name.ToUpper()))
                                                    {
                                                        if (item.revisions != null)
                                                            foreach (CreateRevision rev in item.revisions)
                                                            {
                                                                if (rev.items != null)
                                                                    foreach (CreateRevisionItem revitems in rev.items)
                                                                    {
                                                                        OTItem oi = new OTItem();
                                                                        List<Createitemsfeatures> featuresList = new List<Createitemsfeatures>();
                                                                        foreach (var featuresitem in revitems.features)
                                                                        {
                                                                            Createitemsfeatures features = new Createitemsfeatures();
                                                                            features.Name = Convert.ToString(featuresitem.Name);
                                                                            features.Quantity = Convert.ToInt32(featuresitem.Quantity);
                                                                            featuresList.Add(features);
                                                                        }

                                                                        CreateRevisionItem revisionItem = new CreateRevisionItem();
                                                                        revisionItem.IdCPType = GetIdCPTypeByIdName(revitems.name, connectionstring);
                                                                        revisionItem.reference = revitems.reference;
                                                                        revisionItem.name = revitems.name;
                                                                        revisionItem.features = featuresList;
                                                                        revisionItem.quantity = revitems.quantity;
                                                                        revisionItem.drawing_ID = revitems.drawing_ID;
                                                                        revisionItem.Ways = revitems.Ways;
                                                                        revisionItem.sale_unit_price = revitems.sale_unit_price;
                                                                        revisionItem.comments = revitems.comments;
                                                                        revisionItem.discount = revitems.discount;
                                                                        oi.revisionItem = new GEOSAPIRevisionItem();
                                                                        oi.itemOTStatusType = new GEOSAPIItemOTStatusType();
                                                                        oi.createRevisionItem = new CreateRevisionItem();
                                                                        oi.itemOTStatusType.idItemOtStatus = idItemOtStatus;
                                                                        oi.createRevisionItem = revisionItem;
                                                                        if (revitems.file_details != null)
                                                                        {
                                                                            if (oi.revisionItem.createRevisionItem == null)
                                                                            {
                                                                                oi.revisionItem.createRevisionItem = new CreateRevisionItem();
                                                                            }
                                                                            oi.revisionItem.createRevisionItem.file_details = revitems.file_details;  //chitra.girigosavi APIGEOS-1190 5/08/2024 Add support for adding attachments in items and orders (1/4)
                                                                        }                                                                        //itemsJSONDATA.Add(oi);
                                                                        ComponentJSONDATA.Add(oi);
                                                                    }
                                                            }
                                                    }
                                                CreateJSONQuotationWithItemsV207(tempquotation, offer, ComponentJSONDATA, createRevisionItem, connectionstring);
                                            }
                                        }
                                    }

                                    // trans.Commit();
                                    if (itemsJSONDATA != null && itemsJSONDATA.Count > 0)
                                        CreateJSONQuotationWithItems(tempquotation, offer, itemsJSONDATA, connectionstring);
                                }
                                catch (Exception ex)
                                {
                                    // trans.Rollback();
                                    throw;
                                }
                                //  }
                            }
                        }

                        tempquotation.IdQuotation = idQuotation;

                    }


                }




            }
            catch (Exception ex)
            {
                throw;
            }
            return offer;
        }
        public void AddActivityLinkedItem(Int64 idActivity, List<OfferActivityLinkedItem> activityLinkedItems, string connectionstring)
        {
            if (activityLinkedItems != null)
            {
                foreach (OfferActivityLinkedItem activityLinkedItem in activityLinkedItems)
                {
                    activityLinkedItem.idActivity = idActivity;

                    using (MySqlConnection connLinkedItem = new MySqlConnection(connectionstring))
                    {
                        connLinkedItem.Open();
                        //using (MySqlTransaction trans = concompany.BeginTransaction())
                        //{
                        try
                        {
                            MySqlCommand linkedItemCommand = new MySqlCommand("activityLinkedItems_Insert", connLinkedItem);
                            linkedItemCommand.CommandType = CommandType.StoredProcedure;
                            linkedItemCommand.Parameters.AddWithValue("_IdActivity", activityLinkedItem.idActivity);
                            linkedItemCommand.Parameters.AddWithValue("_IdLinkedItemType", activityLinkedItem.idLinkedItemType);

                            linkedItemCommand.Parameters.AddWithValue("_IdSite", activityLinkedItem.idSite);
                            linkedItemCommand.Parameters.AddWithValue("_IdCarProject", null);
                            linkedItemCommand.Parameters.AddWithValue("_IdPerson", null);

                            linkedItemCommand.Parameters.AddWithValue("_IdOffer", activityLinkedItem.idOffer);
                            linkedItemCommand.Parameters.AddWithValue("_IdEmdepSite", activityLinkedItem.idEmdepSite);
                            linkedItemCommand.Parameters.AddWithValue("_IdCompetitor", null);

                            //concompanycommand.Transaction = trans;
                            activityLinkedItem.idActivityLinkedItem = Convert.ToInt32(linkedItemCommand.ExecuteScalar());
                            //trans.Commit();
                            connLinkedItem.Close();
                        }
                        catch (Exception ex)
                        {
                            //trans.Rollback();
                            throw;
                        }
                        //}
                    }

                }

            }

        }


        public bool AddActivityAttendees(Int64 idActivity, List<OfferActivityAttendees> activityAttendees, string mainServerConnectionString)
        {
            bool isInserted = false;

            if (activityAttendees != null)
            {
                try
                {
                    foreach (OfferActivityAttendees item in activityAttendees)
                    {

                        using (MySqlConnection connAttendees = new MySqlConnection(mainServerConnectionString))
                        {
                            connAttendees.Open();
                            //using (MySqlTransaction trans = concompany.BeginTransaction())
                            //{
                            try
                            {
                                MySqlCommand conAttendeesCommand = new MySqlCommand("activityAttendees_Insert", connAttendees);
                                conAttendeesCommand.CommandType = CommandType.StoredProcedure;
                                conAttendeesCommand.Parameters.AddWithValue("_IdUser", item.idUser);
                                conAttendeesCommand.Parameters.AddWithValue("_IdActivity", idActivity);
                                //concompanycommand.Transaction = trans;
                                item.idActivityAttendees = Convert.ToInt32(conAttendeesCommand.ExecuteScalar());

                                //trans.Commit();

                                if (item.idActivityAttendees > 0)
                                {
                                    isInserted = true;
                                }

                                connAttendees.Close();
                            }
                            catch (Exception ex)
                            {
                                //trans.Rollback();
                                throw;
                            }
                            //}
                        }
                    }



                }
                catch (Exception ex)
                {
                    throw;
                }
            }
            return isInserted;
        }

        public bool AddLogEntriesByActivity(Int64 idActivity, List<OfferLogActivity> logEntriesByActivity, string mainconnectionstring)
        {
            bool isInserted = false;

            if (logEntriesByActivity != null)
            {
                try
                {
                    foreach (OfferLogActivity item in logEntriesByActivity)
                    {
                        using (MySqlConnection connLogEntries = new MySqlConnection(mainconnectionstring))
                        {
                            connLogEntries.Open();

                            try
                            {
                                MySqlCommand logEntriesCommand = new MySqlCommand("logEntriesByActivity_Insert", connLogEntries);
                                logEntriesCommand.CommandType = CommandType.StoredProcedure;
                                logEntriesCommand.Parameters.AddWithValue("_IdUser", item.IdUser);
                                logEntriesCommand.Parameters.AddWithValue("_IdActivity", idActivity);
                                logEntriesCommand.Parameters.AddWithValue("_IdLogEntryType", item.IdLogEntryType);
                                logEntriesCommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                                logEntriesCommand.Parameters.AddWithValue("_Comments", item.Comments);
                                logEntriesCommand.Parameters.AddWithValue("_IsRtfText", item.IsRtfText);

                                item.IdLogEntryByActivity = Convert.ToInt32(logEntriesCommand.ExecuteScalar());

                                connLogEntries.Close();

                                if (item.IdLogEntryByActivity > 0)
                                {
                                    isInserted = true;
                                }
                            }
                            catch (Exception ex)
                            {
                                throw;
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    throw;
                }
            }

            return isInserted;
        }
        public void AddLogEntryByOffer_V2040(CreateOpportunityModel offer, string connectionstring)
        {
            try
            {


                if (offer.LstLogEntryByOffers != null)
                {
                    foreach (LogEntryByOffers logEntryByOffer in offer.LstLogEntryByOffers)
                    {
                        if (logEntryByOffer.isUpdate)
                        {
                            if (logEntryByOffer.idLogEntry > 0)
                            {
                                using (MySqlConnection conlogEntryByOffer = new MySqlConnection(connectionstring))
                                {
                                    conlogEntryByOffer.Open();
                                    //using (MySqlTransaction trans = conlogEntryByOffer.BeginTransaction())
                                    //{
                                    try
                                    {
                                        //string query = "update logentriesbyoffer set comments='" + logEntryByOffer.Comments + "', dateTime='" + DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss") + "'  where idLogEntry=" + logEntryByOffer.IdLogEntry + ";";
                                        MySqlCommand conlogEntryByOffercommand = new MySqlCommand("logEntryByOffer_Update", conlogEntryByOffer);
                                        conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_IdLogEntry", logEntryByOffer.idLogEntry);
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_Comment", logEntryByOffer.comments);
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_logDatetime", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_IsRtfText", logEntryByOffer.isRtfText);
                                        // conlogEntryByOffercommand.Transaction = trans;
                                        conlogEntryByOffercommand.ExecuteNonQuery();
                                        //   trans.Commit();
                                    }
                                    catch (Exception ex)
                                    {
                                        // trans.Rollback();
                                        throw;
                                    }
                                    // }
                                }
                            }
                        }

                        else if (logEntryByOffer.isDeleted)
                        {
                            if (logEntryByOffer.idLogEntry > 0)
                            {
                                using (MySqlConnection conlogEntryByOffer = new MySqlConnection(connectionstring))
                                {
                                    conlogEntryByOffer.Open();
                                    //using (MySqlTransaction trans = conlogEntryByOffer.BeginTransaction())
                                    //{
                                    try
                                    {
                                        // string query = "delete from logentriesbyoffer where idLogEntry=" + logEntryByOffer.IdLogEntry + ";";
                                        MySqlCommand conlogEntryByOffercommand = new MySqlCommand("logEntryByOffer_Delete", conlogEntryByOffer);
                                        conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_IdLogEntry", logEntryByOffer.idLogEntry);
                                        // conlogEntryByOffercommand.Transaction = trans;
                                        conlogEntryByOffercommand.ExecuteNonQuery();
                                        // trans.Commit();
                                    }
                                    catch (Exception ex)
                                    {
                                        //trans.Rollback();
                                        throw;
                                    }
                                    // }
                                }
                            }
                        }
                        else
                        {
                            using (MySqlConnection conlogEntryByOffer = new MySqlConnection(connectionstring))
                            {
                                conlogEntryByOffer.Open();
                                //using (MySqlTransaction trans = conlogEntryByOffer.BeginTransaction())
                                //{
                                try
                                {
                                    MySqlCommand conlogEntryByOffercommand = new MySqlCommand("logEntryByOffer_Insert", conlogEntryByOffer);
                                    conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                                    conlogEntryByOffercommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conlogEntryByOffercommand.Parameters.AddWithValue("_IdUser", logEntryByOffer.idUser);
                                    conlogEntryByOffercommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                                    conlogEntryByOffercommand.Parameters.AddWithValue("_Comments", logEntryByOffer.comments);
                                    conlogEntryByOffercommand.Parameters.AddWithValue("_IdLogEntryType", logEntryByOffer.idLogEntryType);
                                    conlogEntryByOffercommand.Parameters.AddWithValue("_IsRtfText", logEntryByOffer.isRtfText);
                                    //  conlogEntryByOffercommand.Transaction = trans;
                                    conlogEntryByOffercommand.ExecuteNonQuery();
                                    // trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    // trans.Rollback();
                                    throw;
                                }
                                // }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;

            }
        }
        public List<Template> GetTemplatesByIdOfferOption(string connectionstring, Int64 idOfferOption)
        {

            List<Template> templates = new List<Template>();

            using (MySqlConnection con = new MySqlConnection(connectionstring))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("templatesbyofferoption_GetTemplatesByOfferOption", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdOfferOption", idOfferOption);
                using (MySqlDataReader offerreader = concommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Template template = new Template();
                        template.Suffix = offerreader["Suffix"].ToString();
                        template.Name = offerreader["Name"].ToString();
                        template.IdTemplate = Convert.ToByte(offerreader["IdTemplate"].ToString());
                        template.Type = Convert.ToByte(offerreader["Type"].ToString());

                        templates.Add(template);
                    }
                }
            }

            return templates;
        }
        private void CreateJSONQuotationWithItems(GEOSAPIQuotation q, CreateOpportunityModel of, List<OTItem> items, string connectionString)
        {
            List<WarehouseProductComponents> warehouseProductComponentsList = new List<WarehouseProductComponents>();
            List<WarehouseProductComponents> LstAllArticlesByArticle = GetAllArticlesByArticle(connectionString);
            MySqlConnection conrevision;
            conrevision = new MySqlConnection(connectionString);
            string attachedFiles = null;

            conrevision.Open();
            MySqlCommand conquotationcommand = conrevision.CreateCommand();
            // MySqlTransaction MyTransaction = conrevision.BeginTransaction();

            conquotationcommand.Connection = conrevision;
            //conquotationcommand.Transaction = MyTransaction;

            try
            {

                GEOSAPIRevision r = q.Revisions[0];
                r.items = new Dictionary<string, GEOSAPIRevisionItem>();

                int i = 1;
                int flag = 1;
                foreach (OTItem oi in items)
                {
                    bool insert = true;
                    WarehouseProductComponents components = new WarehouseProductComponents();

                    if (insert)
                    {
                        string description = "";

                        description = oi.revisionItem.warehouseProduct.article.description;
                        GEOSAPIWarehouseProduct ap = new GEOSAPIWarehouseProduct();
                        ap.article = oi.revisionItem.warehouseProduct.article;
                        ap.description = description;
                        // Created by shubham[skadam] for APIGEOS endpoint SALES->Opportunities->Create  https://helpdesk.emdep.com/browse/APIGEOS-633  DATE 08 11 2022
                        //ap.parent = 0;
                        ap.parent = Convert.ToInt64(oi.revisionItem.warehouseProduct.article.Parent);

                        conquotationcommand = new MySqlCommand("products_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdProductType", 2);

                        ap.idWarehouseProduct = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                        // Created by shubham[skadam] for APIGEOS endpoint SALES->Opportunities->Create  https://helpdesk.emdep.com/browse/APIGEOS-633  DATE 08 11 2022
                        conquotationcommand = new MySqlCommand("warehouseproduct_Insert_V500", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdWarehouseProduct", ap.idWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_IdArticle", ap.article.idArticle);
                        conquotationcommand.Parameters.AddWithValue("_Description", ap.description);
                        conquotationcommand.Parameters.AddWithValue("_Parent", ap.parent);

                        conquotationcommand.ExecuteNonQuery();
                        components.IdArticle = Convert.ToInt32(ap.article.idArticle);
                        components.IdWarehouseProduct = ap.idWarehouseProduct;
                        components.Quantity = ap.article.quantity;
                        components.Number = flag.ToString();


                        List<WarehouseProductComponents> LstArticlesByArticle = LstAllArticlesByArticle.Where(a => a.IdArticle == Convert.ToInt32(ap.article.idArticle)).ToList();
                        if (LstArticlesByArticle != null && LstArticlesByArticle.Count > 0)
                        {
                            LstArticlesByArticle.ForEach(f => f.IdWarehouseProduct = ap.idWarehouseProduct);
                            GetWarehouseProductComponents(LstArticlesByArticle, LstAllArticlesByArticle, connectionString);
                        }
                        GEOSAPIRevisionItem ri = new GEOSAPIRevisionItem();
                        ri.warehouseProduct = ap;
                        ri.revision = r;
                        ri.numItem = i.ToString();
                        ri.quantity = Convert.ToDecimal(oi.revisionItem.warehouseProduct.article.quantity);
                        ri.unitPrice = Convert.ToDecimal(oi.revisionItem.warehouseProduct.article.saleUnitPrice);
                        ri.discount = Convert.ToDecimal(oi.revisionItem.warehouseProduct.article.discount);
                        //ri.customerComment = "";
                        if (oi.revisionItem.customerComment == null)
                        {
                            ri.customerComment = "";
                        }
                        else
                        {
                            ri.customerComment = oi.revisionItem.customerComment;
                        }

                        //conquotationcommand = new MySqlCommand("revisionitems_Insert_V250", conrevision);
                        //conquotationcommand = new MySqlCommand("GEOSAPI_revisionitems_Insert_V300", conrevision); //change added by shubham[skadam] for APIGEOS endpoint Sales / Opportunities / Create   https://helpdesk.emdep.com/browse/APIGEOS-220            
                        conquotationcommand = new MySqlCommand("GEOSAPI_revisionitems_Insert_V740", conrevision); //chitra.girigosavi APIGEOS-1190 5/08/2024 Add support for adding attachments in items and orders (1/4)
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdRevision", ri.revision.id);
                        conquotationcommand.Parameters.AddWithValue("_NumItem", ri.numItem);
                        conquotationcommand.Parameters.AddWithValue("_IdProduct", ri.warehouseProduct.idWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_Quantity", ri.quantity);
                        conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri.unitPrice);
                        conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                        conquotationcommand.Parameters.AddWithValue("_Validated", false);
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri.customerComment);
                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri.revision.createdBy);
                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri.revision.createdBy);
                        conquotationcommand.Parameters.AddWithValue("_IdRevisionItemStatus", oi.itemOTStatusType.idItemOtStatus);
                        conquotationcommand.Parameters.AddWithValue("_Discount", ri.discount);
                        try
                        {
                            attachedFiles = null;
                            if (oi.revisionItem.createRevisionItem != null)
                            {
                                attachedFiles = oi.revisionItem.createRevisionItem.file_details.Any()
                                               ? string.Join(";", oi.revisionItem.createRevisionItem.file_details.Select(fd => fd.FileName))
                                               : string.Empty;
                                if (!string.IsNullOrEmpty(attachedFiles))
                                    attachedFiles += ";";
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error CreateJSONQuotationWithItemsV207(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                        }
                        conquotationcommand.Parameters.AddWithValue("_AttachedFiles", attachedFiles);
                        ri.idRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());



                        r.items.Add(ri.numItem, ri);


                        i++;
                    }
                }


                // MyTransaction.Commit();
                conrevision.Close();




            }
            catch (Exception ex)
            {
                //if (Transaction.Current != null)
                //    Transaction.Current.Rollback();

                conrevision.Close();

                throw;
            }
        }
        private void CreateJSONQuotationWithItemsV207(GEOSAPIQuotation q, CreateOpportunityModel of, List<OTItem> items, List<CreateRevisionItem> createRevisionItem, string connectionString)
        {
            MySqlConnection conrevision;
            conrevision = new MySqlConnection(connectionString);

            conrevision.Open();
            MySqlCommand conquotationcommand = conrevision.CreateCommand();
            // MySqlTransaction MyTransaction = conrevision.BeginTransaction();

            conquotationcommand.Connection = conrevision;
            string attachedFiles = null;
            //conquotationcommand.Transaction = MyTransaction;
            //if (createRevisionItem !=null)
            //{            
            try
            {

                GEOSAPIRevision r = q.Revisions[0];
                r.items = new Dictionary<string, GEOSAPIRevisionItem>();
                int i = 1;
                foreach (OTItem oi in items)
                //foreach (CreateRevisionItem RevisionItem in createRevisionItem)
                {
                    bool insert = true;


                    if (insert)
                    {
                        string description = "";

                        //description = oi.revisionItem.warehouseProduct.article.description;
                        GEOSAPIWarehouseProduct ap = new GEOSAPIWarehouseProduct();
                        //ap.article = oi.revisionItem.warehouseProduct.article;
                        ap.description = description;
                        ap.parent = 0;
                        conquotationcommand = new MySqlCommand("products_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdProductType", 1);

                        ap.idWarehouseProduct = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                        //conquotationcommand = new MySqlCommand("GEOSAPI_CPproduct_Insert_V290", conrevision);
                        //conquotationcommand = new MySqlCommand("GEOSAPI_CPproduct_Insert_V720", conrevision); //Shubham[skadam] APIGEOS-1178 Ways field is not filled when creating/updating an opportunity   21 06 2024
                        conquotationcommand = new MySqlCommand("GEOSAPI_CPproduct_Insert_V770", conrevision);//chitra.girigosavi APIGEOS-1278 [27/11/2024]
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdCP", ap.idWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_Reference", oi.createRevisionItem.reference);
                        conquotationcommand.Parameters.AddWithValue("_IdCPType", oi.createRevisionItem.IdCPType);
                        conquotationcommand.Parameters.AddWithValue("_IdDrawing", oi.createRevisionItem.drawing_ID);
                        conquotationcommand.Parameters.AddWithValue("_Ways", oi.createRevisionItem.Ways);
                        conquotationcommand.Parameters.AddWithValue("_CreatedBy", r.createdBy);//chitra.girigosavi APIGEOS-1278 [27/11/2024]
                        conquotationcommand.ExecuteNonQuery();

                        GEOSAPIRevisionItem ri = new GEOSAPIRevisionItem();
                        ri.warehouseProduct = ap;
                        ri.revision = r;
                        ri.numItem = i.ToString();
                        //ri.quantity = Convert.ToDecimal(oi.revisionItem.warehouseProduct.article.quantity);
                        //ri.unitPrice = Convert.ToDecimal(oi.revisionItem.warehouseProduct.article.saleUnitPrice);
                        ri.quantity = Convert.ToDecimal(oi.createRevisionItem.quantity);
                        ri.unitPrice = Convert.ToDecimal(oi.createRevisionItem.sale_unit_price);
                        ri.discount = Convert.ToDecimal(oi.createRevisionItem.discount);
                        //ri.customerComment = oi.createRevisionItem.comments;
                        if (oi.createRevisionItem.comments == null)
                        {
                            ri.customerComment = "";
                        }
                        else
                        {
                            ri.customerComment = oi.createRevisionItem.comments;
                        }

                        //conquotationcommand = new MySqlCommand("revisionitems_Insert_V250", conrevision); //17 06 2021
                        conquotationcommand = new MySqlCommand("GEOSAPI_revisionitems_Insert_V740", conrevision); //chitra.girigosavi APIGEOS-1190 5/08/2024 Add support for adding attachments in items and orders (1/4)
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdRevision", ri.revision.id);
                        conquotationcommand.Parameters.AddWithValue("_NumItem", ri.numItem);
                        conquotationcommand.Parameters.AddWithValue("_IdProduct", ri.warehouseProduct.idWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_Quantity", ri.quantity);
                        conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri.unitPrice);
                        conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                        conquotationcommand.Parameters.AddWithValue("_Validated", false);
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri.customerComment);
                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri.revision.createdBy);
                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri.revision.createdBy);
                        conquotationcommand.Parameters.AddWithValue("_IdRevisionItemStatus", oi.itemOTStatusType.idItemOtStatus);
                        //conquotationcommand.Parameters.AddWithValue("_IdRevisionItemStatus",1);
                        conquotationcommand.Parameters.AddWithValue("_Discount", ri.discount);
                        try
                        {
                            attachedFiles = null;
                            if (oi.revisionItem.createRevisionItem != null)
                            {
                                attachedFiles = oi.revisionItem.createRevisionItem.file_details.Any()
                                               ? string.Join(";", oi.revisionItem.createRevisionItem.file_details.Select(fd => fd.FileName))
                                               : string.Empty;
                                if (!string.IsNullOrEmpty(attachedFiles))
                                    attachedFiles += ";";
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error CreateJSONQuotationWithItemsV207(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                        }
                        conquotationcommand.Parameters.AddWithValue("_AttachedFiles", attachedFiles);
                        ri.idRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                        #region //chitra.girigosavi APIGEOS-1278 [27/11/2024]
                        conquotationcommand = new MySqlCommand("GEOSAPI_CPproduct_Insert_Observation_V770", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdRevisionItem", ri.idRevisionItem);
                        conquotationcommand.Parameters.AddWithValue("_CreatedBy", r.createdBy);
                        conquotationcommand.Parameters.AddWithValue("_IdDrawing", oi.createRevisionItem.drawing_ID);
                        conquotationcommand.ExecuteScalar();
                        #endregion

                        //idRevisionItem = Convert.ToInt64(ri.idRevisionItem);
                        r.items.Add(ri.numItem, ri);
                        i++;
                        foreach (var item in oi.createRevisionItem.features)
                        {
                            conquotationcommand = new MySqlCommand("GEOSAPI_CPdetections_Insert", conrevision);
                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                            conquotationcommand.Parameters.AddWithValue("_CPProductID", ap.idWarehouseProduct);
                            //conquotationcommand.Parameters.AddWithValue("_DetectionID", oi.createRevisionItem.IdCPType);
                            conquotationcommand.Parameters.AddWithValue("_DetectionID", GetDetectionIDeByIdName(item.Name, connectionString));
                            conquotationcommand.Parameters.AddWithValue("_NumDetections", item.Quantity);
                            conquotationcommand.Parameters.AddWithValue("_IdRevisionItem", ri.idRevisionItem);
                            conquotationcommand.ExecuteNonQuery();

                        }
                    }
                }

                conrevision.Close();
            }
            catch (Exception ex)
            {
                conrevision.Close();
                throw;
            }

            //}
        }
        private void CreateQuotationWithItems_V2041(GEOSAPIQuotation q, CreateOpportunityModel of, List<OTItem> items, string connectionString)
        {
            //List<WarehouseProductComponents> LstAllArticlesByArticle = GetAllArticlesByArticle(connectionString);
            MySqlConnection conrevision;
            conrevision = new MySqlConnection(connectionString);

            conrevision.Open();
            MySqlCommand conquotationcommand = conrevision.CreateCommand();
            //  MySqlTransaction MyTransaction = conrevision.BeginTransaction();

            conquotationcommand.Connection = conrevision;
            string attachedFiles = null;
            //  conquotationcommand.Transaction = MyTransaction;

            try
            {

                GEOSAPIRevision r = q.Revisions[0];
                r.items = new Dictionary<string, GEOSAPIRevisionItem>();

                ////insertem la revisió 1
                GEOSAPIRevision r1 = new GEOSAPIRevision();
                r1.quotation = q;
                r1.numRevision = 1;
                r1.createdIn = r.createdIn;
                r1.createdBy = r.createdBy;
                r1.reviewedBy = r.reviewedBy;
                r1.createdIn = r.createdIn;
                r1.expireDate = r.expireDate;
                r1.comments = r.comments;
                r1.items = new Dictionary<string, GEOSAPIRevisionItem>();
                r1.approvedIn = Convert.ToDateTime("0001-01-01 00:00:00");


                conquotationcommand = new MySqlCommand("revisions_Insert", conrevision);
                conquotationcommand.CommandType = CommandType.StoredProcedure;
                conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r1.reviewedBy);
                conquotationcommand.Parameters.AddWithValue("_NumRevision", r1.numRevision);
                conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                conquotationcommand.Parameters.AddWithValue("_ModifiedBy", r1.createdBy);
                conquotationcommand.Parameters.AddWithValue("_MadeBy", r1.createdBy);
                conquotationcommand.Parameters.AddWithValue("_IdQuotation", r1.quotation.IdQuotation);
                conquotationcommand.Parameters.AddWithValue("_IdCurrency", of.IdCurrency);
                conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r1.expireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                conquotationcommand.Parameters.AddWithValue("_CreationDate", r1.createdIn);
                conquotationcommand.Parameters.AddWithValue("_Comments", r1.comments);
                conquotationcommand.Parameters.AddWithValue("_Closed", r1.approvedIn);


                r1.id = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                conquotationcommand.Parameters.Clear();
                int i = 1;
                foreach (OTItem oi in items)
                {
                    bool insert = true;


                    if (insert)
                    {
                        string description = "";

                        description = oi.revisionItem.warehouseProduct.article.description;
                        GEOSAPIWarehouseProduct ap = new GEOSAPIWarehouseProduct();
                        ap.article = oi.revisionItem.warehouseProduct.article;
                        ap.description = description;
                        ap.parent = 0;
                        conquotationcommand = new MySqlCommand("products_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdProductType", 2);

                        ap.idWarehouseProduct = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                        conquotationcommand.Parameters.Clear();
                        conquotationcommand = new MySqlCommand("warehouseproduct_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdWarehouseProduct", ap.idWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_IdArticle", ap.article.idArticle);
                        conquotationcommand.Parameters.AddWithValue("_Description", ap.description);
                        conquotationcommand.Parameters.AddWithValue("_Parent", ap.parent);
                        conquotationcommand.ExecuteNonQuery();
                        conquotationcommand.Parameters.Clear();
                        //List<WarehouseProductComponents> LstArticlesByArticle = LstAllArticlesByArticle.Where(a => a.IdArticle == Convert.ToInt32(ap.article.idArticle)).ToList();
                        //if (LstArticlesByArticle != null && LstArticlesByArticle.Count > 0)
                        //{
                        //    LstArticlesByArticle.ForEach(f => f.IdWarehouseProduct = ap.idWarehouseProduct);
                        //    GetWarehouseProductComponents(LstArticlesByArticle, LstAllArticlesByArticle, connectionString);
                        //}
                        GEOSAPIRevisionItem ri = new GEOSAPIRevisionItem();
                        ri.warehouseProduct = ap;
                        ri.revision = r;
                        ri.numItem = i.ToString();
                        ri.quantity = Convert.ToInt64(oi.revisionItem.warehouseProduct.article.quantity);
                        ri.unitPrice = Convert.ToDecimal(oi.revisionItem.warehouseProduct.article.saleUnitPrice);
                        ri.discount = Convert.ToDecimal(oi.revisionItem.warehouseProduct.article.discount);
                        //ri.customerComment = "";
                        if (oi.revisionItem.customerComment == null)
                        {
                            ri.customerComment = "";
                        }
                        else
                        {
                            ri.customerComment = oi.revisionItem.customerComment;
                        }

                        //conquotationcommand = new MySqlCommand("revisionitems_Insert_V250", conrevision);
                        //conquotationcommand = new MySqlCommand("GEOSAPI_revisionitems_Insert_V300", conrevision); //change added by shubham[skadam] for APIGEOS endpoint Sales / Opportunities / Create   https://helpdesk.emdep.com/browse/APIGEOS-220 
                        conquotationcommand = new MySqlCommand("GEOSAPI_revisionitems_Insert_V740", conrevision); //chitra.girigosavi APIGEOS-1190 5/08/2024 Add support for adding attachments in items and orders (1/4)                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.CommandType = CommandType.StoredProcedure; //Shubham[skadam] APIGEOS-1535 Error en GOM creando Transporte a traves de la API 27 06 2025
                        conquotationcommand.Parameters.AddWithValue("_IdRevision", ri.revision.id);
                        conquotationcommand.Parameters.AddWithValue("_NumItem", ri.numItem);
                        conquotationcommand.Parameters.AddWithValue("_IdProduct", ri.warehouseProduct.idWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_Quantity", ri.quantity);
                        conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri.unitPrice);
                        conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                        conquotationcommand.Parameters.AddWithValue("_Validated", false);
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri.customerComment);
                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri.revision.createdBy);
                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri.revision.createdBy);
                        conquotationcommand.Parameters.AddWithValue("_IdRevisionItemStatus", oi.itemOTStatusType.idItemOtStatus);
                        conquotationcommand.Parameters.AddWithValue("_Discount", ri.discount);
                        try
                        {
                            attachedFiles = null;
                            if (oi.revisionItem.createRevisionItem != null)
                            {
                                attachedFiles = oi.revisionItem.createRevisionItem.file_details.Any()
                                               ? string.Join(";", oi.revisionItem.createRevisionItem.file_details.Select(fd => fd.FileName))
                                               : string.Empty;
                                if (!string.IsNullOrEmpty(attachedFiles))
                                    attachedFiles += ";";
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error CreateJSONQuotationWithItemsV207(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                        }
                        conquotationcommand.Parameters.AddWithValue("_AttachedFiles", attachedFiles);
                        ri.idRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                        conquotationcommand.Parameters.Clear();
                        GEOSAPIRevisionItem ri1 = new GEOSAPIRevisionItem();
                        ri1.warehouseProduct = ap;
                        ri1.revision = r1;
                        ri1.createdBy = r1.createdBy;
                        ri1.modifiedBy = r1.createdBy;
                        ri1.numItem = i.ToString();
                        ri1.quantity = Convert.ToUInt32(oi.revisionItem.warehouseProduct.article.quantity);
                        ri1.unitPrice = Convert.ToDecimal(oi.revisionItem.warehouseProduct.article.saleUnitPrice);
                        ri1.discount = Convert.ToDecimal(oi.revisionItem.warehouseProduct.article.discount);
                        //ri1.customerComment = "";
                        if (oi.revisionItem.customerComment == null)
                        {
                            ri1.customerComment = "";
                        }
                        else
                        {
                            ri1.customerComment = oi.revisionItem.customerComment;
                        }

                        //conquotationcommand = new MySqlCommand("revisionitems_Insert_V250", conrevision);
                        //conquotationcommand = new MySqlCommand("GEOSAPI_revisionitems_Insert_V300", conrevision); //change added by shubham[skadam] for APIGEOS endpoint Sales / Opportunities / Create   https://helpdesk.emdep.com/browse/APIGEOS-220 
                        conquotationcommand = new MySqlCommand("GEOSAPI_revisionitems_Insert_V740", conrevision); //chitra.girigosavi APIGEOS-1190 5/08/2024 Add support for adding attachments in items and orders (1/4)
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdRevision", ri1.revision.id);
                        conquotationcommand.Parameters.AddWithValue("_NumItem", ri1.numItem);
                        conquotationcommand.Parameters.AddWithValue("_IdProduct", ri1.warehouseProduct.idWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_Quantity", ri1.quantity);
                        conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri1.unitPrice);
                        conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                        conquotationcommand.Parameters.AddWithValue("_Validated", false);
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri1.customerComment);
                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri1.revision.createdBy);
                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri1.revision.createdBy);
                        conquotationcommand.Parameters.AddWithValue("_IdRevisionItemStatus", oi.itemOTStatusType.idItemOtStatus);
                        conquotationcommand.Parameters.AddWithValue("_Discount", ri1.discount);
                        try
                        {
                            attachedFiles = null;
                            if (oi.revisionItem.createRevisionItem != null)
                            {
                                attachedFiles = oi.revisionItem.createRevisionItem.file_details.Any()
                                               ? string.Join(";", oi.revisionItem.createRevisionItem.file_details.Select(fd => fd.FileName))
                                               : string.Empty;
                                if (!string.IsNullOrEmpty(attachedFiles))
                                    attachedFiles += ";";
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error CreateJSONQuotationWithItemsV207(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                        }
                        conquotationcommand.Parameters.AddWithValue("_AttachedFiles", attachedFiles);
                        ri1.idRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                        conquotationcommand.Parameters.Clear();
                        r.items.Add(ri.numItem, ri);
                        r1.items.Add(ri1.numItem, ri1);

                        i++;
                    }
                }

                q.Revisions.Add(r1);

                //insertem la ot
                GEOSAPIOts o = new GEOSAPIOts();
                o.numOT = 1;
                o.creationDate = r.createdIn;
                o.deliveryDate = r.createdIn.AddDays(15);
                o.createdBy = r.createdBy;
                o.reviewedBy = r.createdBy;
                o.code = GetOTCode(Convert.ToInt32(of.idSiteWhereCreated), q, connectionString);
                o.year = Convert.ToInt32(q.Year);
                o.number = Convert.ToInt32(q.Number);
                o.quotation = q;
                o.items = new Dictionary<string, OTItem>();

                if (o.idShippingAddress != 0)
                    o.idShippingAddress = o.idShippingAddress;
                else if (of.idShippingAddress != 0)
                    o.idShippingAddress = of.idShippingAddress.Value;
                else
                    o.idShippingAddress = null;

                //si els ítems estan enviats tanquem la OT
                if (items[0].idItemOtStatus == 10)
                    o.isClosed = 1;
                else
                    o.isClosed = 0;

                conquotationcommand = new MySqlCommand("ots_Insert", conrevision);
                conquotationcommand.CommandType = CommandType.StoredProcedure;
                conquotationcommand.Parameters.AddWithValue("_NumOT", o.numOT);
                conquotationcommand.Parameters.AddWithValue("_CreationDate", o.creationDate);

                conquotationcommand.Parameters.AddWithValue("_DeliveryDate", o.deliveryDate);

                conquotationcommand.Parameters.AddWithValue("_IdSite", of.idSiteWhereCreated);
                conquotationcommand.Parameters.AddWithValue("_CreatedBy", o.createdBy);
                conquotationcommand.Parameters.AddWithValue("_ReviewedBy", o.reviewedBy);
                conquotationcommand.Parameters.AddWithValue("_Code", o.code);
                conquotationcommand.Parameters.AddWithValue("_Year", o.year);
                conquotationcommand.Parameters.AddWithValue("_Number", o.number);
                conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                conquotationcommand.Parameters.AddWithValue("_ModifiedBy", o.createdBy);
                conquotationcommand.Parameters.AddWithValue("_IdAddress", o.idShippingAddress);
                conquotationcommand.Parameters.AddWithValue("_IsClosed", o.isClosed);
                conquotationcommand.Parameters.AddWithValue("_IdQuotation", o.quotation.IdQuotation);

                o.idOT = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                conquotationcommand.Parameters.Clear();
                //MyTransaction.Commit();
                conrevision.Close();

                //TransactionScope transactionScope = null;

                //using (transactionScope = new TransactionScope())
                //{
                try
                {
                    foreach (KeyValuePair<string, GEOSAPIRevisionItem> ri in o.quotation.Revisions[1].items)
                    {
                        byte idItemOtStatus = 1;
                        foreach (OTItem it in items)
                        {
                            if (it.revisionItem.warehouseProduct.article.idArticle == ri.Value.warehouseProduct.article.idArticle)
                            {
                                idItemOtStatus = Convert.ToByte(it.itemOTStatusType.idItemOtStatus);
                                break;
                            }
                        }

                        OTItem oi = InsertItemInOt_V2041(of, ri.Value, idItemOtStatus, o, q, connectionString);
                        o.items.Add(oi.revisionItem.numItem, oi);
                        InsertPartNumber_V2040(of, oi, connectionString);
                        AssignOtItemToGenericShipment(oi, of, false, connectionString);
                    }

                    //   transactionScope.Complete();
                }
                catch (Exception ex)
                {
                    //if (Transaction.Current != null)
                    //    Transaction.Current.Rollback();

                    //if (transactionScope != null)
                    //    transactionScope.Dispose();

                    throw;
                }
                //}

                q.Ots = new List<GEOSAPIOts>();
                q.Ots.Add(o);
            }
            catch (Exception ex)
            {
                conrevision.Close();
            }
        }

        public List<WarehouseProductComponents> GetAllArticlesByArticle(string connectionstring)
        {
            List<WarehouseProductComponents> articlesByArticleLst = new List<WarehouseProductComponents>();

            using (MySqlConnection con = new MySqlConnection(connectionstring))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("GetAllArticlesByArticle", con);
                concommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        WarehouseProductComponents articlesByArticle = new WarehouseProductComponents();
                        if (reader["idArticle"] != DBNull.Value)
                            articlesByArticle.IdArticle = Convert.ToInt32(reader["idArticle"]);

                        if (reader["idComponent"] != DBNull.Value)
                            articlesByArticle.IdComponent = Convert.ToInt32(reader["idComponent"]);
                        if (reader["Quantity"] != DBNull.Value)
                            articlesByArticle.Quantity = (float)reader["Quantity"];

                        articlesByArticleLst.Add(articlesByArticle);
                    }
                }
            }
            return articlesByArticleLst;
        }
        private Int64 ExistShipmentCode(string code, string connectionString)
        {
            Int64 idShipment = 0;

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();
                MySqlCommand command = new MySqlCommand("GEOSAPI_GetShipmentByCode", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_EmdepCode", code);

                using (MySqlDataReader dr = command.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        if (dr["IdShipment"] != DBNull.Value)
                            idShipment = Convert.ToInt64(dr["IdShipment"]);

                    }
                }
            }

            return idShipment;
        }

        private Int64 getArticleSupplierByIdSite(Int64 idSite, string connectionString)
        {
            Int64 idSupplier = 0;

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();
                MySqlCommand command = new MySqlCommand("GEOSAPI_GetIdArticleSupplierByIdSite", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader dr = command.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        if (dr["idarticleSupplier"] != DBNull.Value)
                            idSupplier = Convert.ToInt64(dr["idarticleSupplier"]);

                    }
                }
            }

            return idSupplier;

        }
        private void AssignOtItemToGenericShipment(OTItem oi, CreateOpportunityModel o, bool close, string connectionString)
        {
            string shipCode = "OI" + DateTime.Now.Year.ToString().Remove(0, 2) + o.OfferNumber.ToString("00000");
            Int64 idshipment = ExistShipmentCode(shipCode, connectionString);
            Int64 idSender = getArticleSupplierByIdSite(o.idSiteWhereCreated.Value, connectionString);

            MySqlConnection conrevision;
            conrevision = new MySqlConnection(connectionString);

            conrevision.Open();
            MySqlCommand conquotationcommand = conrevision.CreateCommand();
            conquotationcommand.Connection = conrevision;
            if (idshipment == 0)
            {
                //  MySqlTransaction MyTransaction = conrevision.BeginTransaction();


                conquotationcommand = new MySqlCommand("GEOSAPI_Shipments_insert", conrevision);
                conquotationcommand.CommandType = CommandType.StoredProcedure;
                conquotationcommand.Parameters.AddWithValue("_deliveryDate", DateTime.Now);
                conquotationcommand.Parameters.AddWithValue("_idTransportAgency", 27);

                conquotationcommand.Parameters.AddWithValue("_shipmentNumber", "*");

                conquotationcommand.Parameters.AddWithValue("_iddeliverynote", 2);
                conquotationcommand.Parameters.AddWithValue("_DeliveryNoteDate", DateTime.Now);
                conquotationcommand.Parameters.AddWithValue("_EmdepCode", shipCode);
                conquotationcommand.Parameters.AddWithValue("_closed", close);
                conquotationcommand.Parameters.AddWithValue("_CreatedBy", o.IdCreatedBy);
                conquotationcommand.Parameters.AddWithValue("_Comments", "");
                if (idSender != 0)
                    conquotationcommand.Parameters.AddWithValue("_IdSender", idSender);
                else
                    conquotationcommand.Parameters.AddWithValue("_IdSender", null);
                if (o.idShippingAddress != 0)
                    conquotationcommand.Parameters.AddWithValue("_IdRecipient", o.idShippingAddress);
                else
                    conquotationcommand.Parameters.AddWithValue("_IdRecipient", null);

                conquotationcommand.Parameters.AddWithValue("_idotitem", oi.idOTItem);
                conquotationcommand.Parameters.AddWithValue("_quantity", 1);

                idshipment = Convert.ToInt32(conquotationcommand.ExecuteScalar());
            }

            conquotationcommand = new MySqlCommand("GEOSAPI_deliveredItems_insert", conrevision);
            conquotationcommand.CommandType = CommandType.StoredProcedure;
            conquotationcommand.Parameters.AddWithValue("_IdShipment", idshipment);
            conquotationcommand.Parameters.AddWithValue("_idotitem", oi.idOTItem);
            conquotationcommand.Parameters.AddWithValue("_quantity", 1);
            conquotationcommand.ExecuteNonQuery();


            conrevision.Close();
        }

        public string GetBarCode(string quotationCode)
        {
            string barCode = String.Empty;

            switch (quotationCode.Substring(0, 1))
            {
                case "C":
                    if (quotationCode.Length == 7)
                    {
                        //Ejemplo: C10001A
                        barCode = quotationCode.Substring(0, quotationCode.Length - 1);
                    }
                    if (quotationCode.Length == 8)
                    {
                        //Ejemplo:  C100001A
                        barCode = quotationCode.Substring(0);
                    }
                    else if (quotationCode.Length == 9)
                    {
                        //Ejemplo: C10MA001A
                        barCode = quotationCode.Substring(0, 3) + quotationCode.Substring(5, 3);
                    }
                    else if (quotationCode.Length == 10)
                    {
                        //Ejemplo:  C10MA0001A
                        barCode = quotationCode.Substring(0, 3) + quotationCode.Substring(5);
                    }
                    break;
                case "T":
                    if (quotationCode.Length == 7 || quotationCode.Length == 8)
                    {
                        //Ejemplo: T10-045, T10-045A
                        if (char.IsDigit(Convert.ToChar(quotationCode.Remove(0, quotationCode.Length - 1))))
                            barCode = quotationCode.Substring(0, 3) + quotationCode.Substring(4);
                        else
                            barCode = quotationCode.Substring(0, 3) + quotationCode.Substring(4, 4).PadLeft(5, '0');
                    }
                    else if (quotationCode.Length == 9 || quotationCode.Length == 10)
                    {
                        //Ejemplo: T10MA-045, T10MA-045A
                        if (char.IsDigit(Convert.ToChar(quotationCode.Remove(0, quotationCode.Length - 1))))
                            barCode = quotationCode.Substring(0, 3) + quotationCode.Substring(6);
                        else
                            barCode = quotationCode.Substring(0, 3) + quotationCode.Substring(6, 4).PadLeft(5, '0');
                    }
                    break;
                case "I":
                    {
                        if (quotationCode.Substring(1, 1) == "C")
                        {
                            if (quotationCode.Length == 8)
                            {
                                //Ejemplo: IC10001A
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 4).PadLeft(5, '0');
                            }
                            if (quotationCode.Length == 9)
                            {
                                //Ejemplo:  IC100001A
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 5);
                            }
                            else if (quotationCode.Length == 10)
                            {
                                //Ejemplo: IC10MA001A
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 4).PadLeft(5, '0');
                            }
                            else if (quotationCode.Length == 11)
                            {
                                //Ejemplo:  IC10MA0001A
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 5);
                            }
                            break;
                        }
                        else if (quotationCode.Substring(1, 1) == "E")
                        {
                            if (quotationCode.Length == 8)
                            {
                                //Ejemplo: IC10001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 4).PadLeft(5, '0');
                            }
                            if (quotationCode.Length == 9)
                            {
                                //Ejemplo:  IC100001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 5);
                            }
                            else if (quotationCode.Length == 10)
                            {
                                //Ejemplo: IC10MA001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 4).PadLeft(5, '0');
                            }
                            else if (quotationCode.Length == 11)
                            {
                                //Ejemplo:  IC10MA0001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 5);
                            }
                            break;
                        }
                        else if (quotationCode.Substring(1, 1) == "T")
                        {
                            if (quotationCode.Length == 8)
                            {
                                //Ejemplo: IC10001A
                                barCode = "H" + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 4).PadLeft(5, '0');
                            }
                            if (quotationCode.Length == 9)
                            {
                                //Ejemplo:  IC100001A
                                barCode = "H" + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 5);
                            }
                            else if (quotationCode.Length == 10)
                            {
                                //Ejemplo: IC10MA001A
                                barCode = "H" + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 4).PadLeft(5, '0');
                            }
                            else if (quotationCode.Length == 11)
                            {
                                //Ejemplo:  IC10MA0001A
                                barCode = "H" + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 5);
                            }
                            break;
                        }
                        else if (quotationCode.Substring(1, 1) == "S")
                        {
                            if (quotationCode.Length == 8)
                            {
                                //Ejemplo: IC10001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 4).PadLeft(5, '0');
                            }
                            if (quotationCode.Length == 9)
                            {
                                //Ejemplo:  IC100001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 5);
                            }
                            else if (quotationCode.Length == 10)
                            {
                                //Ejemplo: IC10MA001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 4).PadLeft(5, '0');
                            }
                            else if (quotationCode.Length == 11)
                            {
                                //Ejemplo:  IC10MA0001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 5);
                            }
                            break;
                        }
                        else if (quotationCode.Substring(1, 1) == "W")
                        {
                            if (quotationCode.Length == 8)
                            {
                                //Ejemplo: IC10001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 4).PadLeft(5, '0');
                            }
                            if (quotationCode.Length == 9)
                            {
                                //Ejemplo:  IC100001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 5);
                            }
                            else if (quotationCode.Length == 10)
                            {
                                //Ejemplo: IC10MA001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 4).PadLeft(5, '0');
                            }
                            else if (quotationCode.Length == 11)
                            {
                                //Ejemplo:  IC10MA0001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 5);
                            }
                            break;
                        }
                        break;
                    }

                case "R":
                    {

                        if (quotationCode.Length == 8 || quotationCode.Length == 9)
                        {
                            //Ejemplo: RD10044, RD10044A
                            if (char.IsDigit(Convert.ToChar(quotationCode.Remove(0, quotationCode.Length - 1))))
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 5);
                            else
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 4).PadLeft(5, '0');
                        }
                        else if (quotationCode.Length == 10 || quotationCode.Length == 11)
                        {
                            //Ejemplo: RD10MA044, RD10MA044A
                            if (char.IsDigit(Convert.ToChar(quotationCode.Remove(0, quotationCode.Length - 1))))
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6);
                            else
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 4).PadLeft(5, '0');
                        }

                        break;
                    }

                default:
                    //Si el codi te 5 digits posarem el sufixe, sinó no
                    string[] splittedCode = quotationCode.Split('-');
                    //No renombrarem els números d'items si el codi de la cotització es major de 5 digits (4 del número mes 1 del sufix)
                    if (splittedCode.Length > 1 && splittedCode[1].Length > 5)
                        barCode = quotationCode.Substring(2, 2) + quotationCode.Substring(quotationCode.IndexOf('-') + 1);
                    else
                        barCode = quotationCode.Substring(2, 2) + quotationCode.Substring(quotationCode.IndexOf('-') + 1, 4);
                    break;
            }

            return barCode;
        }

        private void InsertPartNumber_V2040(CreateOpportunityModel offer, OTItem oi, string connectionString)
        {
            string barCode = GetBarCode(oi.quotation.Code);

            for (int i = 1; i <= oi.revisionItem.quantity; i++)
            {
                string code = barCode + Convert.ToUInt32(oi.revisionItem.numItem).ToString("000") + i.ToString("000");
                uint idPartNumber = 0;

                using (MySqlConnection conrevision = new MySqlConnection(connectionString))
                {
                    conrevision.Open();

                    try
                    {
                        MySqlCommand conquotationcommand = new MySqlCommand("PartNumbers_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_CODE", code);
                        conquotationcommand.Parameters.AddWithValue("_OTITEM", oi.idOTItem);
                        conquotationcommand.Parameters.AddWithValue("_IdPartNumberType", null);
                        conquotationcommand.Parameters.AddWithValue("_IdPackingBox", null);
                        conquotationcommand.Parameters.AddWithValue("_ID", null);

                        idPartNumber = Convert.ToUInt32(conquotationcommand.ExecuteScalar());
                    }
                    catch (Exception ex)
                    {
                        throw;
                    }
                }

                //busquem les etapes de l'article  i per cada etapa creem un tracking
                List<int> stages = new List<int>();

                using (MySqlConnection conrevision = new MySqlConnection(connectionString))
                {
                    conrevision.Open();

                    try
                    {
                        MySqlCommand conStagesArticlecommand = new MySqlCommand("Get_StagesByArticle", conrevision);
                        conStagesArticlecommand.CommandType = CommandType.StoredProcedure;
                        conStagesArticlecommand.Parameters.AddWithValue("_IdArticle", oi.revisionItem.warehouseProduct.article.idArticle);
                        conStagesArticlecommand.Parameters.AddWithValue("_IdSite", Convert.ToInt32(offer.idSiteWhereCreated));
                        conStagesArticlecommand.Parameters.AddWithValue("_IdStage", null);
                        conStagesArticlecommand.Parameters.AddWithValue("_Sequence", null);

                        using (MySqlDataReader reader = conStagesArticlecommand.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                stages.Add(Convert.ToInt32(reader["idStage"]));
                            }
                        }

                        conrevision.Close();
                    }
                    catch (Exception ex)
                    {
                        throw;
                    }
                }

                //si l'etapa es COMERCIAL (1) la creem en l'usuari que hi ha logat, sinó en l'usuari system
                //i sense endDate. l'startDate es modificará quan l'article arribi a cada etapa
                foreach (int stg in stages)
                {
                    using (MySqlConnection conrevision = new MySqlConnection(connectionString))
                    {
                        conrevision.Open();

                        try
                        {
                            MySqlCommand conPNTcommand = new MySqlCommand("PartNumbersTracking_Insert", conrevision);
                            conPNTcommand.CommandType = CommandType.StoredProcedure;
                            conPNTcommand.Parameters.AddWithValue("_IdPartNumber", idPartNumber);
                            conPNTcommand.Parameters.AddWithValue("_IdStage", stg);
                            conPNTcommand.Parameters.AddWithValue("_StartDate", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            conPNTcommand.Parameters.AddWithValue("_CurrentTime", Convert.ToInt32(0));
                            conPNTcommand.Parameters.AddWithValue("_Rework", false);

                            //Unused
                            conPNTcommand.Parameters.AddWithValue("_IdCause", null);
                            conPNTcommand.Parameters.AddWithValue("_Remarks", null);

                            if (stg == 1)
                            {
                                conPNTcommand.Parameters.AddWithValue("_EndDate", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                conPNTcommand.Parameters.AddWithValue("_IdOperator", oi.revisionItem.createdBy);
                                conPNTcommand.Parameters.AddWithValue("_Paused", false);
                            }
                            else if (stg == 23)
                            {
                                conPNTcommand.Parameters.AddWithValue("_EndDate", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                conPNTcommand.Parameters.AddWithValue("_IdOperator", oi.revisionItem.createdBy);
                                conPNTcommand.Parameters.AddWithValue("_Paused", false);
                            }
                            else
                            {
                                conPNTcommand.Parameters.AddWithValue("_EndDate", null);
                                conPNTcommand.Parameters.AddWithValue("_IdOperator", null);
                                conPNTcommand.Parameters.AddWithValue("_Paused", true);
                            }

                            conPNTcommand.ExecuteNonQuery();
                            conrevision.Close();
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }
                    }
                }
            }
        }

        private OTItem InsertItemInOt_V2041(CreateOpportunityModel of, GEOSAPIRevisionItem ri, byte idStatus, GEOSAPIOts o, GEOSAPIQuotation q, string connectionString)
        {
            OTItem oi = new OTItem();
            oi.ot = o;
            oi.quotation = q;
            oi.revisionItem = ri;
            oi.itemOTStatusType = new GEOSAPIItemOTStatusType();
            oi.itemOTStatusType.idItemOtStatus = idStatus;

            oi.customerComment = "";

            using (MySqlConnection conrevision = new MySqlConnection(connectionString))
            {
                conrevision.Open();

                try
                {
                    MySqlCommand conquotationcommand = new MySqlCommand("GEOSAPI_otitemsInsert", conrevision);
                    conquotationcommand.CommandType = CommandType.StoredProcedure;
                    conquotationcommand.Parameters.AddWithValue("_IdOT", oi.ot.idOT);
                    conquotationcommand.Parameters.AddWithValue("_IdRevisionItem", oi.revisionItem.idRevisionItem);
                    conquotationcommand.Parameters.AddWithValue("_IdItemOTStatus", oi.itemOTStatusType.idItemOtStatus);
                    conquotationcommand.Parameters.AddWithValue("_CustomerComment", oi.customerComment);
                    conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                    conquotationcommand.Parameters.AddWithValue("_CreatedBy", oi.revisionItem.createdBy);
                    conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                    conquotationcommand.Parameters.AddWithValue("_ModifiedBy", oi.revisionItem.createdBy);

                    oi.idOTItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                    conrevision.Close();
                }
                catch (Exception ex)
                {
                    throw;
                }

            }
            return oi;
        }

        public List<OTItem> GetDefaultArticlesByOfferOptionAndTemplateRevCheck(CreateOpportunityModel offer, Int64 idOfferOption, byte idTemplate, string connectionstring, List<CreateRevisionItem> revItems)
        {
            List<OTItem> items = new List<OTItem>();

            using (MySqlConnection contemplate = new MySqlConnection(connectionstring))
            {
                contemplate.Open();

                //string templatequery = "SELECT * FROM templates WHERE IdTemplate = 18;";
                MySqlCommand contemplatecommand = new MySqlCommand("GetDefaultArticlesByOfferOptionAndTemplate", contemplate);
                contemplatecommand.CommandType = CommandType.StoredProcedure;
                contemplatecommand.Parameters.AddWithValue("_IdOfferOption", idOfferOption);
                contemplatecommand.Parameters.AddWithValue("_IdTemplate", idTemplate);
                using (MySqlDataReader reader = contemplatecommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        OTItem oi = new OTItem();
                        oi.revisionItem = new GEOSAPIRevisionItem();
                        oi.revisionItem.warehouseProduct = new GEOSAPIWarehouseProduct();
                        oi.revisionItem.warehouseProduct.article = new WarehouseProductArticle();
                        oi.itemOTStatusType = new GEOSAPIItemOTStatusType();

                        oi.revisionItem.warehouseProduct.article.idArticle = Convert.ToInt32(reader["idArticle"]);
                        oi.revisionItem.warehouseProduct.article.quantity = Convert.ToDouble(reader["quantity"]);
                        oi.revisionItem.warehouseProduct.article.description = reader["description"].ToString();
                        oi.revisionItem.warehouseProduct.article.description_es = reader["description_es"].ToString();
                        oi.revisionItem.warehouseProduct.article.description_fr = reader["description_Fr"].ToString();

                        oi.itemOTStatusType.idItemOtStatus = Convert.ToUInt16(reader["idDefaultItemOtStatus"]);
                        items.Add(oi);
                    }
                }
            }

            foreach (OTItem item in items)
            {
                if (revItems.Any(ri => ri.idArticle == item.revisionItem.warehouseProduct.article.idArticle))
                {
                    CreateRevisionItem ri = revItems.Where(rei => rei.idArticle == item.revisionItem.warehouseProduct.article.idArticle).FirstOrDefault();
                    if (ri.quantity != null)
                    {
                        item.revisionItem.warehouseProduct.article.quantity = (double)ri.quantity;
                    }
                    if (ri.quantity != null)
                    {
                        item.revisionItem.warehouseProduct.article.saleUnitPrice = (double)ri.sale_unit_price;
                    }

                    item.revisionItem.warehouseProduct.article.description = ri.name;
                    item.revisionItem.warehouseProduct.article.description_es = ri.name;
                    item.revisionItem.warehouseProduct.article.description_fr = ri.name;
                    if (ri.itemNumber != null)
                    {
                        item.revisionItem.numItem = ri.itemNumber;
                    }
                    if (ri.comments != null)
                    {
                        item.revisionItem.customerComment = ri.comments;
                    }
                    if (ri.discount > 0)
                    {
                        item.revisionItem.warehouseProduct.article.discount = (double)ri.discount;
                    }
                    else
                    {
                        item.revisionItem.warehouseProduct.article.discount = 0;
                    }

                }

            }


            return items;
        }
        private bool IsEngenieeringDepartment(string code)
        {
            Regex exp = new Regex(@"^RD\d{5}$|^RD\d{5}[A-z]$|^RD\d{2}[A-z]{2}\d{3}$|^RD\d{2}[A-z]{2}\d{3}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }
        public string GetOTCode(Int32 IdPlant, GEOSAPIQuotation q, string connectionString)
        {
            string OTCode = q.Code;
            string plantCode = GetPlantCodeByIdSite(IdPlant, connectionString);

            if (IsSupply(OTCode))
            {
                OTCode = q.Code.Substring(0, 4);
                OTCode += plantCode + "-" + q.Code.Substring(q.Code.IndexOf("-") + 1);
            }
            else if (IsComplaint(OTCode))
            {
                OTCode = q.Code.Substring(0, 3);
                if (Char.IsDigit(Convert.ToChar(q.Code.Substring(q.Code.Length - 1))))
                    OTCode += plantCode + q.Code.Substring(q.Code.Length - 3);
                else if (q.Code.Length == 8 || q.Code.Length == 10)
                    OTCode += plantCode + q.Code.Substring(q.Code.Length - 5);
                else
                    OTCode += plantCode + q.Code.Substring(q.Code.Length - 4);
            }
            else if ((IsInternalOrder(OTCode)) || (IsInternalEmdep(OTCode)) || (IsEngenieeringDepartment(OTCode)) || IsITO(OTCode) || IsIS(OTCode))
            {
                OTCode = q.Code.Substring(0, 4);
                if (Char.IsDigit(Convert.ToChar(q.Code.Substring(q.Code.Length - 1))))
                    OTCode += plantCode + q.Code.Substring(q.Code.Length - 3);
                else if (q.Code.Length == 9 || q.Code.Length == 11)
                    OTCode += plantCode + q.Code.Substring(q.Code.Length - 5);
                else
                    OTCode += plantCode + q.Code.Substring(q.Code.Length - 4);
            }
            else if (IsTechnicianMaterials(OTCode))
            {
                OTCode = q.Code.Substring(0, 3);
                OTCode += plantCode + q.Code.Substring(q.Code.IndexOf("-") + 1);
            }

            return OTCode;
        }
        private string GetPlantCodeByIdSite(Int32 idSite, string connectionString)
        {
            string plantCode = string.Empty;


            using (MySqlConnection conrevision = new MySqlConnection(connectionString))
            {
                conrevision.Open();
                try
                {

                    MySqlCommand conquotationcommand = new MySqlCommand("emdepsites_GetEmdepSitesByIdSite", conrevision);
                    conquotationcommand.CommandType = CommandType.StoredProcedure;
                    conquotationcommand.Parameters.AddWithValue("_IdSite", idSite);
                    using (MySqlDataReader sitereader = conquotationcommand.ExecuteReader())
                    {
                        if (sitereader.Read())
                        {
                            plantCode = sitereader["Code"].ToString();
                        }
                    }



                }
                catch (Exception ex)
                {

                    throw;
                }
            }

            return plantCode;
        }
        // Created by shubham[skadam] for APIGEOS endpoint SALES->Opportunities->Create  https://helpdesk.emdep.com/browse/APIGEOS-633  DATE 08 11 2022
        #region APIGEOS-633
        private List<OfferAddtionalComponents> GetExistAddtionalComponents(Int32 idarticle, Int32 idsite, Int32 IdCurrency, string connectionString)
        {
            List<OfferAddtionalComponents> addtionalComponentsList = new List<OfferAddtionalComponents>();
            using (MySqlConnection conrevision = new MySqlConnection(connectionString))
            {
                conrevision.Open();
                try
                {
                    MySqlCommand conquotationcommand = new MySqlCommand("GEOSAPI_IsAddtionalComponentsExist", conrevision);
                    conquotationcommand.CommandType = CommandType.StoredProcedure;
                    conquotationcommand.Parameters.AddWithValue("_idarticle", idarticle);
                    conquotationcommand.Parameters.AddWithValue("_idsite", idsite);
                    conquotationcommand.Parameters.AddWithValue("_IdCurrency", IdCurrency);
                    using (MySqlDataReader reader = conquotationcommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            OfferAddtionalComponents addtionalComponents = new OfferAddtionalComponents();
                            if (reader["IdAdditionalArticle"] != DBNull.Value)
                            {
                                addtionalComponents.IdAdditionalArticle = Convert.ToInt64(reader["IdAdditionalArticle"].ToString());
                            }
                            if (reader["Reference"] != DBNull.Value)
                            {
                                addtionalComponents.Reference = Convert.ToString(reader["Reference"].ToString());
                            }
                            if (reader["Description"] != DBNull.Value)
                            {
                                addtionalComponents.Description = Convert.ToString(reader["Description"].ToString());
                            }
                            if (reader["ImagePath"] != DBNull.Value)
                            {
                                addtionalComponents.ImagePath = Convert.ToString(reader["ImagePath"].ToString());
                            }
                            //if (reader["isConfigurable"] != DBNull.Value)
                            //{
                            //    addtionalComponents.isConfigurable = Convert.ToBoolean(reader["isConfigurable"].ToString());
                            //}
                            //if (reader["isObligatory"] != DBNull.Value)
                            //{
                            //    addtionalComponents.isObligatory = Convert.ToBoolean(reader["isObligatory"].ToString());
                            //}
                            if (reader["Quantity"] != DBNull.Value)
                            {
                                addtionalComponents.Quantity = Convert.ToInt32(reader["Quantity"].ToString());
                            }
                            if (reader["Articlefrom"] != DBNull.Value)
                            {
                                addtionalComponents.Articlefrom = Convert.ToInt32(reader["Articlefrom"].ToString());
                            }
                            if (reader["Articleto"] != DBNull.Value)
                            {
                                addtionalComponents.Articleto = Convert.ToInt32(reader["Articleto"].ToString());
                            }
                            if (reader["Price"] != DBNull.Value)
                            {
                                addtionalComponents.Price = Convert.ToDouble(reader["Price"].ToString());
                            }
                            addtionalComponentsList.Add(addtionalComponents);
                        }
                    }
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error GetExistAddtionalComponents(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                }
            }
            return addtionalComponentsList;
        }
        #endregion

        private bool IsSupply(string code)
        {
            Regex exp = new Regex(@"^\d{4}-\d{4}$|^\d{4}-\d{4}[A-z]$|^\d{4}[A-z]{2}-\d{4}$|^\d{4}[A-z]{2}-\d{4}[A-z]$|^\d{4}-\d{5}$|^\d{4}-\d{5}[A-z]$|^\d{4}[A-z]{2}-\d{5}$|^\d{4}[A-z]{2}-\d{5}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }
        private bool IsComplaint(string code)
        {
            Regex exp = new Regex(@"^C\d{5}$|^C\d{5}[A-z]$|^C\d{2}[A-z]{2}\d{3}$|^C\d{2}[A-z]{2}\d{3}[A-z]$|^C\d{6}[A-z]$|^C\d{2}[A-z]{2}\d{4}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }
        private bool IsInternalOrder(string code)
        {
            Regex exp = new Regex(@"^IC\d{5}$|^IC\d{5}[A-z]$|^IC\d{2}[A-z]{2}\d{3}$|^IC\d{2}[A-z]{2}\d{3}[A-z]$|^IC\d{2}[A-z]{2}\d{4}[A-z]$|^IC\d{6}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }
        private bool IsTechnicianMaterials(string code)
        {
            Regex exp = new Regex(@"^T\d{2}-d{3}$|^T\d{2}-d{3}[A-z]$|^T\d{2}[A-z]{2}-\d{3}$|^T\d{2}[A-z]{2}-\d{3}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }

        private bool IsInternalEmdep(string code)
        {
            Regex exp = new Regex(@"^IE\d{5}$|^IE\d{5}[A-z]$|^IE\d{2}[A-z]{2}\d{3}$|^IE\d{2}[A-z]{2}\d{3}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }

        private bool IsITO(string code)
        {
            Regex exp = new Regex(@"^IT\d{5}$|^IT\d{5}[A-z]$|^IT\d{2}[A-z]{2}\d{3}$|^IT\d{2}[A-z]{2}\d{3}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }

        private bool IsIS(string code)
        {
            Regex exp = new Regex(@"^IS\d{5}$|^IS\d{5}[A-z]$|^IS\d{2}[A-z]{2}\d{3}$|^IS\d{2}[A-z]{2}\d{3}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }
        List<WarehouseProductComponents> warehouseProductComponentsList = new List<WarehouseProductComponents>();
        Int64 IdComponent = 0;
        public void GetWarehouseProductComponents(List<WarehouseProductComponents> LstArticlesByArticle, List<WarehouseProductComponents> LstAllArticlesByArticle, string connectionString)
        {
            try
            {
                Int64 tempIdComponenty = 0;
                Log4NetLogger.Logger.Log(string.Format("Method GetWarehouseProductComponents()...."), category: Category.Info, priority: Priority.Low);
                foreach (WarehouseProductComponents item in LstArticlesByArticle)
                {
                    warehouseProductComponentsList.Add(item);
                    if (item.Parent == 0)
                    {
                        item.Parent = null;
                    }
                    tempIdComponenty = AddWarehouseProductComponents(item, connectionString);

                    if (LstAllArticlesByArticle != null && LstAllArticlesByArticle.Any(a => a.IdArticle == item.IdComponent))
                    {
                        IdComponent = tempIdComponenty;
                        List<WarehouseProductComponents> TempList = LstAllArticlesByArticle.Where(a => a.IdArticle == item.IdComponent).ToList();
                        TempList.ForEach(f => f.IdWarehouseProduct = item.IdWarehouseProduct);
                        TempList.ForEach(f => f.Parent = tempIdComponenty);
                        GetWarehouseProductComponents(TempList, LstAllArticlesByArticle, connectionString);
                        //IdComponent = 0;
                    }
                    else
                    {
                        // return;
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetWarehouseProductComponents()....Executed successfully."), category: Category.Info, priority: Priority.Low);

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetWarehouseProductComponents(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            return;
        }
        public Int64 AddWarehouseProductComponents(WarehouseProductComponents warehouseProductComponents, string connectionString)
        {
            bool result = false;
            Int64 IdComponent = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method AddWarehouseProductComponents()...."), category: Category.Info, priority: Priority.Low);
                if (warehouseProductComponents != null)
                {
                    using (MySqlConnection conn = new MySqlConnection(connectionString))
                    {
                        conn.Open();
                        MySqlCommand command = new MySqlCommand("GEOSAPI_AddWarehouseProductComponents", conn);
                        command.CommandType = CommandType.StoredProcedure;
                        command.Parameters.AddWithValue("_IdWarehouseProduct", warehouseProductComponents.IdWarehouseProduct);
                        command.Parameters.AddWithValue("_IdArticle", warehouseProductComponents.IdComponent);
                        command.Parameters.AddWithValue("_Parent", warehouseProductComponents.Parent);
                        command.Parameters.AddWithValue("_Quantity", warehouseProductComponents.Quantity);
                        IdComponent = Convert.ToInt64(command.ExecuteScalar());
                        // warehouseProductComponents.IdComponent = IdComponent;
                        result = true;
                        conn.Close();

                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method AddWarehouseProductComponents()....Executed successfully."), category: Category.Info, priority: Priority.Low);

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddWarehouseProductComponents(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            return IdComponent;
        }

        //[APIGEOS-237] 20 04 2021 Sprint 35 Lang Parameters added [sk]
        // public bool ExportOffer(string plantOwner, string idOffer, string ConnectionString, string loginConnectionString, string offerExcelPath, string offerCommericalPath)
        public bool ExportOffer(string plantOwner, string idOffer, string ConnectionString, string loginConnectionString, string offerExcelPath, string offerCommericalPath, string Lang, string Plantwiseconnectionstring)
        {
            string GetWindows_Forbidden_File_Characters = GetGEOSAppSetting("Windows_Forbidden_File_Characters", loginConnectionString);
            string GetWindows_Forbidden_File_Names = GetGEOSAppSetting("Windows_Forbidden_File_Names", loginConnectionString);
            List<string> Windows_Forbidden_File_Names = GetWindows_Forbidden_File_Names.Split(',').ToList();
            string cultureByPlantOwnerAndISO = GetCultureByPlantOwner(plantOwner, ConnectionString);
            string CultureByPlantOwner = string.Empty;
            ErrorMessage errormessage = new ErrorMessage();
            ErrorMessage warningmessage = new ErrorMessage();
            if (!string.IsNullOrEmpty(cultureByPlantOwnerAndISO))
            {
                CultureByPlantOwner = Lang.ToLower() + "-" + cultureByPlantOwnerAndISO;
            }
            List<Languages> Languages = Getlanguages(loginConnectionString);
            //Languages getLanguage = Languages.Where(l => l.TwoLetterISOLanguage.Equals(cultureByPlantOwnerAndISO.ToLower())).FirstOrDefault();
            Languages getLanguage = Languages.Where(l => l.TwoLetterISOLanguage.Equals(Lang.ToLower())).FirstOrDefault();
            //var cultures = CultureInfo.GetCultures(CultureTypes.AllCultures).Where<CultureInfo>(c => c.Name.EndsWith(
            //    string.IsNullOrEmpty(getLanguage.CultureName) ? "en-ES" : getLanguage.CultureName
            //    ));
            bool isDone = false;
            Int64 idSite = IsEMDEPSiteExist(plantOwner, ConnectionString);
            if (idSite > 0)
            {
                string siteConnectionstring = GetSiteConnectionString(idSite, ConnectionString, Plantwiseconnectionstring);

                ExportOffer offer = new ExportOffer();
                try
                {
                    Log4NetLogger.Logger.Log(string.Format("Method ExportOffer()...."), category: Category.Info, priority: Priority.Low);

                    using (MySqlConnection conn = new MySqlConnection(siteConnectionstring))
                    {
                        conn.Open();
                        //MySqlCommand command = new MySqlCommand("GEOSAPI_GetOfferExport_V230", conn);
                        //MySqlCommand command = new MySqlCommand("GEOSAPI_GetOfferExport_V250", conn);
                        //MySqlCommand command = new MySqlCommand("GEOSAPI_GetOfferExport_V260", conn);
                        // MySqlCommand command = new MySqlCommand("GEOSAPI_GetOfferExport_V270", conn); //05 04 2021 
                        //MySqlCommand command = new MySqlCommand("GEOSAPI_GetOfferExport_V280", conn);//21 04 2021
                        // MySqlCommand command = new MySqlCommand("GEOSAPI_GetOfferExport_V290", conn);//26 05 2021 https://helpdesk.emdep.com/browse/APIGEOS-258
                        // MySqlCommand command = new MySqlCommand(" GEOSAPI_GetOfferExport_V300", conn);//-- change added by shubham[skadam] for APIGEOS endpoint SALES->OPPORTUNITIES->Export for adding support to items with discount          https://helpdesk.emdep.com/browse/APIGEOS-222   DATE 18 06 2021                       
                        // MySqlCommand command = new MySqlCommand("GEOSAPI_GetOfferExport_V310", conn);//   -- Created by shubham[skadam] for APIGEOS endpoint  [CUSTOM_TARIFF_NUMBER] Modify the SALES->OPPORTUNITIES->Export endpoint in order to include the Tariff numbers   https://helpdesk.emdep.com/browse/APIGEOS-273 DATE 21 07 2021
                        // MySqlCommand command = new MySqlCommand("GEOSAPI_GetOfferExport_V320", conn);//      -- Created by shubham[skadam] for  APIGEOS-325  endpoint SALES->OPPORTUNITIES->Export  https://helpdesk.emdep.com/browse/APIGEOS-325  DATE 26 08 2021
                        // MySqlCommand command = new MySqlCommand("GEOSAPI_GetOfferExport_V340", conn);// Created by shubham[skadam] for APIGEOS endpoint SALES->OPPORTUNITIES->Export   https://helpdesk.emdep.com/browse/APIGEOS-417 DATE 03 02 2022
                        //MySqlCommand command = new MySqlCommand("GEOSAPI_GetOfferExport_V380", conn);
                        //MySqlCommand command = new MySqlCommand("GEOSAPI_GetOfferExport_V430", conn);// Modified by ranjana[rdixit] for APIGEOS endpoint SALES->OPPORTUNITIES->Export  [APIGEOS-496][10.05.2022]Added field [ of.RevisionNumber ]
                        //MySqlCommand command = new MySqlCommand("GEOSAPI_GetOfferExport_V710", conn); //APIGEOS-1132 Add support for creating offers including modules in ECOS(3 / 3)
                        //MySqlCommand command = new MySqlCommand("GEOSAPI_GetOfferExport_V720", conn); //chitra.girigosavi APIGEOS-1171 Changes when generating the offer for Counterpart type items
                        MySqlCommand command = new MySqlCommand("GEOSAPI_GetOfferExport_V770", conn);   //chitra.girigosavi[APIGEOS-1276][18/11/2024]
                        command.CommandType = CommandType.StoredProcedure;
                        command.Parameters.AddWithValue("_IdOffer", idOffer);
                        command.Parameters.AddWithValue("_IdSite", idSite);
                        command.Parameters.AddWithValue("_Lang", Lang);

                        using (MySqlDataReader dr = command.ExecuteReader())
                        {
                            #region dr.Read
                            if (dr.Read())
                            {
                                if (dr["OfferDate"] != DBNull.Value)
                                {
                                    offer._OfferDate = Convert.ToDateTime(dr["OfferDate"]).ToString("dd-MM-yyyy");
                                }
                                if (dr["OfferNumber"] != DBNull.Value)
                                {
                                    offer._OfferNumber = Convert.ToString(dr["OfferNumber"]);
                                }
                                if (dr["Year"] != DBNull.Value)
                                {
                                    offer._OfferYear = Convert.ToString(dr["Year"]);
                                }
                                if (dr["GroupPlant"] != DBNull.Value)
                                {
                                    offer._OfferGroupPlant = Convert.ToString(dr["GroupPlant"]);
                                }
                                if (dr["RevisionNumber"] != DBNull.Value)
                                {
                                    offer._RevNumber = Convert.ToInt32(dr["RevisionNumber"]);
                                }
                                if (dr["Number"] != DBNull.Value)
                                {
                                    offer._OfferNumberFile = Convert.ToString(dr["Number"]);
                                }
                                if (dr["OfferTitle"] != DBNull.Value)
                                {
                                    //offer._OfferTitle = Regex.Replace(Convert.ToString(dr["OfferTitle"]), GetWindows_Forbidden_File_Characters, "");    
                                    offer._OfferTitle = Convert.ToString(dr["OfferTitle"]);
                                    try
                                    {
                                        //offer._OfferTitle = Regex.Replace(offer._OfferTitle, @"[^\u0000-\u007F]+", string.Empty);
                                        //string OfferTitle = Regex.Replace(offer._OfferTitle, @"\\u[0-9A-Fa-f]{4}", string.Empty);
                                        //offer._OfferTitle = Regex.Replace(offer._OfferTitle, @"\\u[0-9A-Fa-f]{4}", string.Empty);
                                        offer._OfferTitle = System.Text.RegularExpressions.Regex.Replace(offer._OfferTitle, @"[^\t\r\n -~]", "");
                                    }
                                    catch (Exception ex)
                                    {
                                    }
                                    List<string> Windows_Forbidden_File_Characters = GetWindows_Forbidden_File_Characters.Split(';').ToList();
                                    Windows_Forbidden_File_Characters.Add(";");
                                    if (GetWindows_Forbidden_File_Characters != null && GetWindows_Forbidden_File_Characters != string.Empty)
                                    {
                                        foreach (var item in Windows_Forbidden_File_Characters)
                                        {
                                            if (item != string.Empty)
                                            {
                                                offer._OfferTitle = offer._OfferTitle.Replace(item, "");
                                            }

                                        }
                                    }

                                    foreach (var item in Windows_Forbidden_File_Names)
                                    {
                                        offer._OfferTitle = offer._OfferTitle.Replace(item, "");
                                    }
                                    offer._OfferTitle = Regex.Replace(offer._OfferTitle, @"\s+", " ");
                                    offer._OfferTitle = offer._OfferTitle.Trim().ToString();
                                }

                                //if (dr["OfferExpiryDate"] != DBNull.Value)
                                //{
                                //    offer._OfferDate = Convert.ToDateTime(dr["OfferExpiryDate"]).ToString("dd-MM-yyyy");
                                //    //offer._OfferExpiryDate = Convert.ToDateTime(dr["OfferExpiryDate"]).AddDays(quotationNumDays).ToString("dd-MM-yyyy");
                                //}

                                if (dr["QuoteExpiryDate"] != DBNull.Value)
                                {
                                    offer._OfferExpiryDate = Convert.ToDateTime(dr["QuoteExpiryDate"]).ToString("dd-MM-yyyy");

                                }
                                if (dr["CloseDate"] != DBNull.Value)
                                {
                                    offer._CloseDate = Convert.ToDateTime(dr["CloseDate"]).ToString("dd-MM-yyyy");

                                }
                                if (dr["CurrencyName"] != DBNull.Value)
                                {
                                    offer._CurrencyName = Convert.ToString(dr["CurrencyName"]);
                                }

                                if (dr["OfferRfqNumber"] != DBNull.Value)
                                {
                                    offer._OfferRfqNumber = Convert.ToString(dr["OfferRfqNumber"]);
                                }
                                if (dr["RfqDate"] != DBNull.Value)
                                {
                                    offer._RfqDate = Convert.ToDateTime(dr["RfqDate"]).ToString("dd-MM-yyyy");
                                }
                                if (dr["OfferBusinessUnit"] != DBNull.Value)
                                {
                                    offer._OfferBusinessUnit = Convert.ToString(dr["OfferBusinessUnit"]);
                                }
                                if (dr["OfferProject"] != DBNull.Value)
                                {
                                    offer._OfferProject = Convert.ToString(dr["OfferProject"]);
                                }
                                if (dr["OfferCarOEM"] != DBNull.Value)
                                {
                                    offer._OfferCarOEM = Convert.ToString(dr["OfferCarOEM"]);
                                }
                                if (dr["IdProductSubCategory"] != DBNull.Value)
                                {
                                    offer._IdProductSubCategory = Convert.ToInt32(dr["IdProductSubCategory"]);
                                }
                                //if (dr["ShippingAddress"] != DBNull.Value)
                                //{
                                //    offer._OfferShippingAddress = Convert.ToString(dr["ShippingAddress"]);
                                //}
                                if (dr["Category"] != DBNull.Value)
                                {
                                    offer._OfferCategory1 = dr["Category"].ToString();
                                }
                                if (dr["Category"] == DBNull.Value)
                                {
                                    offer._OfferCategory1 = dr["ProductSubCategory"].ToString();
                                }
                                else
                                {
                                    offer._OfferCategory2 = dr["ProductSubCategory"].ToString();
                                }
                                if (dr["ShippingName"] != DBNull.Value)
                                {
                                    offer._OfferShippingAddressName = Convert.ToString(dr["ShippingName"]);
                                }
                                if (dr["ShippingFiscalNumber"] != DBNull.Value)
                                {
                                    offer._OfferShippingAddressFiscalNumber = Convert.ToString(dr["ShippingFiscalNumber"]);
                                }
                                if (dr["ShippingAddress"] != DBNull.Value)
                                {
                                    offer._OfferShippingAddressStreet = Convert.ToString(dr["ShippingAddress"]);
                                }
                                if (dr["ShippingZipCode"] != DBNull.Value)
                                {
                                    offer._OfferShippingAddressZipCode = Convert.ToString(dr["ShippingZipCode"]);
                                }
                                if (dr["ShippingCity"] != DBNull.Value)
                                {
                                    offer._OfferShippingAddressCity = Convert.ToString(dr["ShippingCity"]);
                                }
                                if (dr["ShippingState"] != DBNull.Value)
                                {
                                    offer._OfferShippingAddressState = Convert.ToString(dr["ShippingState"]);
                                }
                                if (dr["ShippingCountry"] != DBNull.Value)
                                {
                                    offer._OfferShippingAddressCountry = Convert.ToString(dr["ShippingCountry"]);
                                }
                                //if (dr["ShippingTelephone"] != DBNull.Value)
                                //{
                                //    offer._OfferShippingAddressPhone = Convert.ToString(dr["ShippingTelephone"]);
                                //}


                                if (dr["OfferPaymentConditions"] != DBNull.Value)
                                {
                                    offer._OfferPaymentConditions = Convert.ToString(dr["OfferPaymentConditions"]);
                                }
                                if (dr["OfferOwner"] != DBNull.Value)
                                {
                                    offer._OfferOwnerFullName = Convert.ToString(dr["OfferOwner"]);
                                }
                                if (dr["OfferOwnerGender"] != DBNull.Value)
                                {
                                    offer._OfferOwnerGender = Convert.ToString(dr["OfferOwnerGender"]);
                                }
                                if (dr["OfferOwnerPhone"] != DBNull.Value)
                                {
                                    offer._OfferOwnerPhone = Convert.ToString(dr["OfferOwnerPhone"]);
                                }

                                if (dr["OfferOwnerMobile"] != DBNull.Value)
                                {
                                    offer._OfferOwnerMobile = Convert.ToString(dr["OfferOwnerMobile"]);
                                }

                                if (dr["OfferOwnerEmail"] != DBNull.Value)
                                {
                                    offer._OfferOwnerEmail = Convert.ToString(dr["OfferOwnerEmail"]);
                                }

                                if (dr["OfferOwnerCountryName"] != DBNull.Value)
                                {
                                    offer._OfferOwnerCompanyCountry = Convert.ToString(dr["OfferOwnerCountryName"]);
                                }
                                if (dr["OfferOwnerCompanyName"] != DBNull.Value)
                                {
                                    offer._OfferOwnerCompanyName = Convert.ToString(dr["OfferOwnerCompanyName"]);
                                }
                                if (dr["OfferOwnerZipCode"] != DBNull.Value)
                                {
                                    offer._OfferOwnerCompanyZipCode = Convert.ToString(dr["OfferOwnerZipCode"]);
                                }
                                if (dr["offerOwnerCompanyCity"] != DBNull.Value)
                                {
                                    offer._OfferOwnerCompanyCity = Convert.ToString(dr["offerOwnerCompanyCity"]);
                                }
                                if (dr["OfferOwnerStreet"] != DBNull.Value)
                                {
                                    offer._OfferOwnerCompanyStreet = Convert.ToString(dr["OfferOwnerStreet"]);
                                }
                                if (dr["OfferOwnerCompanyState"] != DBNull.Value)
                                {
                                    offer._OfferOwnerCompanyState = Convert.ToString(dr["OfferOwnerCompanyState"]);
                                }

                                if (dr["OfferOwnerCompanyAlias"] != DBNull.Value)
                                {
                                    offer._OfferOwnerCompanyAlias = Convert.ToString(dr["OfferOwnerCompanyAlias"]);
                                }

                                if (dr["OfferContactName"] != DBNull.Value)
                                {
                                    offer._OfferContactFullName = Convert.ToString(dr["OfferContactName"]);
                                }
                                if (dr["offContactPeopleGender"] != DBNull.Value)
                                {
                                    offer._OfferContactGender = Convert.ToString(dr["offContactPeopleGender"]);
                                }
                                if (dr["OfferContactPhone"] != DBNull.Value)
                                {
                                    offer._OfferContactPhone = Convert.ToString(dr["OfferContactPhone"]);
                                }
                                if (dr["OfferContactEmail"] != DBNull.Value)
                                {
                                    offer._OfferContactEmail = Convert.ToString(dr["OfferContactEmail"]);
                                }
                                if (dr["OfferContactCountryName"] != DBNull.Value)
                                {
                                    offer._OfferContactCompanyCountry = Convert.ToString(dr["OfferContactCountryName"]);
                                }
                                if (dr["OfferContactCompanyName"] != DBNull.Value)
                                {
                                    offer._OfferContactCompanyName = Convert.ToString(dr["OfferContactCompanyName"]);
                                }
                                if (dr["OfferContactZipCode"] != DBNull.Value)
                                {
                                    offer._OfferContactCompanyZipCode = Convert.ToString(dr["OfferContactZipCode"]);
                                }
                                if (dr["OfferContactCompanyCity"] != DBNull.Value)
                                {
                                    offer._OfferContactCompanyCity = Convert.ToString(dr["OfferContactCompanyCity"]);
                                }
                                if (dr["OfferContactStreet"] != DBNull.Value)
                                {
                                    offer._OfferContactCompanyStreet = Convert.ToString(dr["OfferContactStreet"]);
                                }
                                if (dr["OfferContactCompanyState"] != DBNull.Value)
                                {
                                    offer._OfferContactCompanyState = Convert.ToString(dr["OfferContactCompanyState"]);
                                }
                                if (dr["OfferContactCompanyAlias"] != DBNull.Value)
                                {
                                    offer._OfferContactCompanyAlias = Convert.ToString(dr["OfferContactCompanyAlias"]);
                                }
                                if (dr["OfferComments"] != DBNull.Value)
                                {
                                    offer._OfferComments = Convert.ToString(dr["OfferComments"]);
                                }
                                if (dr["OfferSalesOwnerName"] != DBNull.Value)
                                {
                                    offer._OfferSalesOwnerFullName = Convert.ToString(dr["OfferSalesOwnerName"]);
                                }
                                if (dr["OfferSalesOwnerEmail"] != DBNull.Value)
                                {
                                    offer._OfferSalesOwnerEmail = Convert.ToString(dr["OfferSalesOwnerEmail"]);
                                }
                                if (dr["OfferContactCompanyGroup"] != DBNull.Value)
                                {
                                    offer._OfferContactCompanyGroup = Convert.ToString(dr["OfferContactCompanyGroup"]);
                                }
                                if (dr["OfferContactCompanySite"] != DBNull.Value)
                                {
                                    offer._OfferContactCompanySite = Convert.ToString(dr["OfferContactCompanySite"]);
                                }
                                //if (dr["TypeCom"] != DBNull.Value)
                                //{
                                //    offer._OfferIncoTerms = Convert.ToString(dr["TypeCom"]);
                                //}
                                if (dr["Incoterms"] != DBNull.Value)
                                {
                                    offer._OfferIncoTerms = Convert.ToString(dr["Incoterms"]);
                                }
                                //https://helpdesk.emdep.com/browse/APIGEOS-258 
                                if (dr["Discount"] != DBNull.Value)
                                {
                                    string discount = dr["Discount"].ToString();
                                    offer._OfferDiscount = Convert.ToDouble(discount);
                                }
                                if (dr["RevisionNumber"] != DBNull.Value)
                                {
                                    offer._OfferRevisionNumber = Convert.ToInt32(dr["RevisionNumber"]);
                                }
                                if (dr["Source"] != DBNull.Value)   //chitra.girigosavi[APIGEOS-1276][18/11/2024]
                                {
                                    offer._OfferSource = Convert.ToString(dr["Source"]);
                                }
                            }
                            #endregion
                            #region OfferOptionName
                            if (dr.NextResult())
                            {
                                while (dr.Read())
                                {
                                    if (offer._ExportOfferOptionLst == null)
                                        offer._ExportOfferOptionLst = new List<ExportOfferOptions>();

                                    ExportOfferOptions exportOfferOptions = new ExportOfferOptions();
                                    if (dr["OfferOptionName"] != DBNull.Value)
                                    {
                                        exportOfferOptions.Name = Convert.ToString(dr["OfferOptionName"]);
                                    }
                                    offer._ExportOfferOptionLst.Add(exportOfferOptions);
                                }
                            }
                            #endregion

                            #region Template
                            if (dr.NextResult())
                            {
                                while (dr.Read())
                                {
                                    if (dr["TemplateName"] != DBNull.Value)
                                    {
                                        string templateNameString = dr["TemplateName"].ToString().ToUpper();
                                        if (dr["TemplateName"].ToString().ToUpper() == "INVOICE")
                                        {
                                            #region INVOICE

                                            if (offer._ExportOfferInvoiceLst == null)
                                                offer._ExportOfferInvoiceLst = new List<ExportOfferQuotation>();

                                            ExportOfferQuotation exportOfferInvoice = new ExportOfferQuotation();
                                            if (dr["NumItem"] != DBNull.Value)
                                            {
                                                exportOfferInvoice.Item = Convert.ToString(dr["NumItem"]);
                                            }
                                            if (dr["Reference"] != DBNull.Value)
                                            {
                                                exportOfferInvoice.Reference = Convert.ToString(dr["Reference"]);
                                            }
                                            if (dr["Description"] != DBNull.Value)
                                            {
                                                exportOfferInvoice.Description = Convert.ToString(dr["Description"]);
                                            }
                                            //if (dr["UnitPrice"] != DBNull.Value)
                                            //{
                                            //    exportOfferInvoice.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                            //}
                                            if (dr["Quantity"] != DBNull.Value)
                                            {
                                                exportOfferInvoice.Qty = Convert.ToInt64(dr["Quantity"]);
                                            }
                                            if (dr["TotalPrice"] != DBNull.Value)
                                            {
                                                exportOfferInvoice.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                            }
                                            if (dr["CustomerComment"] != DBNull.Value)
                                            {
                                                exportOfferInvoice.Comments = Convert.ToString(dr["CustomerComment"]);
                                            }
                                            if (dr["Discount"] != DBNull.Value)
                                            {
                                                //exportOfferInvoice.Discount = Convert.ToDouble(dr["Discount"]);
                                                string discount = dr["Discount"].ToString();
                                                exportOfferInvoice.Discount = Convert.ToDouble(discount);
                                            }
                                            if (dr["UnitPrice"] != DBNull.Value)
                                            {
                                                if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                {
                                                    exportOfferInvoice.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                }
                                                else
                                                {
                                                    exportOfferInvoice.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                    double temp = Convert.ToDouble(1 - (exportOfferInvoice.Discount / 100));
                                                    exportOfferInvoice.UnitPrice = Math.Round((exportOfferInvoice.UnitPrice / temp), 2);
                                                }
                                                //double discountapply = Math.Round(Convert.ToDouble(100 - exportOfferInvoice.Discount), 2, MidpointRounding.AwayFromZero);
                                                //double discountapplyUnitPrice = Math.Round(Convert.ToDouble(exportOfferInvoice.UnitPrice * 100), 2, MidpointRounding.AwayFromZero);
                                                //// double originalsale_unit_price
                                                //exportOfferInvoice.UnitPrice = Math.Round((discountapplyUnitPrice / discountapply), 2, MidpointRounding.AwayFromZero);
                                            }
                                            offer._ExportOfferInvoiceLst.Add(exportOfferInvoice);
                                            if (exportOfferInvoice.Discount != 0)
                                            {
                                                if (offer._ExportOfferInvoiceLst == null)
                                                    offer._ExportOfferInvoiceLst = new List<ExportOfferQuotation>();
                                                ExportOfferQuotation exportOfferInvoice1 = new ExportOfferQuotation();
                                                if (dr["Description"] != DBNull.Value)
                                                {
                                                    exportOfferInvoice1.Description = "Discount";
                                                }
                                                if (dr["UnitPrice"] != DBNull.Value)
                                                {
                                                    // exportOfferInvoice1.UnitPrice = -((exportOfferInvoice.UnitPrice * exportOfferInvoice.Discount) / 100);
                                                    if (exportOfferInvoice.UnitPrice == 0 && exportOfferInvoice.Discount == 100)
                                                    {
                                                        exportOfferInvoice1.UnitPrice = 0;
                                                    }
                                                    else
                                                    {
                                                        double discount = Math.Round(((exportOfferInvoice.UnitPrice * exportOfferInvoice.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                        exportOfferInvoice1.UnitPrice = Math.Round((discount * exportOfferInvoice.Qty), 2, MidpointRounding.AwayFromZero);
                                                    }

                                                }
                                                if (dr["Quantity"] != DBNull.Value)
                                                {
                                                    exportOfferInvoice1.Qty = -1;
                                                }
                                                if (dr["Discount"] != DBNull.Value)
                                                {
                                                    //exportOfferInvoice1.Discount = Convert.ToDouble(dr["Discount"]);
                                                    string discount = dr["Discount"].ToString();
                                                    exportOfferInvoice1.Discount = Convert.ToDouble(discount);
                                                }
                                                offer._ExportOfferInvoiceLst.Add(exportOfferInvoice1);
                                            }
                                            #endregion
                                        }//Technical Assistance    Technical Assitance
                                        else if (dr["TemplateName"].ToString().ToUpper() == "TECHNICAL ASSISTANCE".ToUpper())
                                        {
                                            #region  Technical_Assitance

                                            if (offer._ExportOfferTechnicalAssistanceLst == null)
                                                offer._ExportOfferTechnicalAssistanceLst = new List<ExportOfferQuotation>();

                                            ExportOfferQuotation exportOfferTechnicalAssistance = new ExportOfferQuotation();
                                            if (dr["NumItem"] != DBNull.Value)
                                            {
                                                exportOfferTechnicalAssistance.Item = Convert.ToString(dr["NumItem"]);
                                            }
                                            if (dr["Reference"] != DBNull.Value)
                                            {
                                                exportOfferTechnicalAssistance.Reference = Convert.ToString(dr["Reference"]);
                                            }
                                            if (dr["Description"] != DBNull.Value)
                                            {
                                                exportOfferTechnicalAssistance.Description = Convert.ToString(dr["Description"]);
                                            }

                                            if (dr["Quantity"] != DBNull.Value)
                                            {
                                                exportOfferTechnicalAssistance.Qty = Convert.ToInt64(dr["Quantity"]);
                                            }
                                            if (dr["TotalPrice"] != DBNull.Value)
                                            {
                                                exportOfferTechnicalAssistance.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                            }
                                            if (dr["CustomerComment"] != DBNull.Value)
                                            {
                                                exportOfferTechnicalAssistance.Comments = Convert.ToString(dr["CustomerComment"]);
                                            }
                                            if (dr["Discount"] != DBNull.Value)
                                            {
                                                //exportOfferTechnicalAssistance.Discount = Convert.ToDouble(dr["Discount"]);
                                                string discount = dr["Discount"].ToString();
                                                exportOfferTechnicalAssistance.Discount = Convert.ToDouble(discount);
                                            }
                                            if (dr["UnitPrice"] != DBNull.Value)
                                            {
                                                if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                {
                                                    exportOfferTechnicalAssistance.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                }
                                                else
                                                {
                                                    exportOfferTechnicalAssistance.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                    double temp = Convert.ToDouble(1 - (exportOfferTechnicalAssistance.Discount / 100));
                                                    exportOfferTechnicalAssistance.UnitPrice = Math.Round((exportOfferTechnicalAssistance.UnitPrice / temp), 2);
                                                }


                                                //double discountapply = Math.Round(Convert.ToDouble(100 - exportOfferTechnicalAssistance.Discount), 2, MidpointRounding.AwayFromZero);
                                                //double discountapplyUnitPrice = Math.Round(Convert.ToDouble(exportOfferTechnicalAssistance.UnitPrice * 100), 2, MidpointRounding.AwayFromZero);
                                                //// double originalsale_unit_price
                                                //exportOfferTechnicalAssistance.UnitPrice = Math.Round((discountapplyUnitPrice / discountapply), 2, MidpointRounding.AwayFromZero);
                                            }
                                            offer._ExportOfferTechnicalAssistanceLst.Add(exportOfferTechnicalAssistance);
                                            if (exportOfferTechnicalAssistance.Discount != 0)
                                            {
                                                if (offer._ExportOfferTechnicalAssistanceLst == null)
                                                    offer._ExportOfferTechnicalAssistanceLst = new List<ExportOfferQuotation>();

                                                ExportOfferQuotation exportOfferTechnicalAssistance1 = new ExportOfferQuotation();
                                                if (dr["Description"] != DBNull.Value)
                                                {
                                                    exportOfferTechnicalAssistance1.Description = "Discount";
                                                }
                                                if (dr["UnitPrice"] != DBNull.Value)
                                                {
                                                    if (exportOfferTechnicalAssistance.UnitPrice == 0 && exportOfferTechnicalAssistance.Discount == 100)
                                                    {
                                                        exportOfferTechnicalAssistance1.UnitPrice = 0;
                                                    }
                                                    else
                                                    {
                                                        double discount = Math.Round(((exportOfferTechnicalAssistance.UnitPrice * exportOfferTechnicalAssistance.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                        exportOfferTechnicalAssistance1.UnitPrice = Math.Round((discount * exportOfferTechnicalAssistance.Qty), 2, MidpointRounding.AwayFromZero);
                                                    }
                                                    //double discountapply = Math.Round(Convert.ToDouble(100- exportOfferTechnicalAssistance.Discount), 2, MidpointRounding.AwayFromZero); 
                                                    //double discountapplyUnitPrice = Math.Round(Convert.ToDouble(exportOfferTechnicalAssistance.UnitPrice * 100), 2, MidpointRounding.AwayFromZero); 
                                                    //double originalsale_unit_price = Math.Round((discountapplyUnitPrice / discountapply), 2, MidpointRounding.AwayFromZero);

                                                }
                                                if (dr["Quantity"] != DBNull.Value)
                                                {
                                                    exportOfferTechnicalAssistance1.Qty = -1;
                                                }
                                                if (dr["Discount"] != DBNull.Value)
                                                {
                                                    //exportOfferTechnicalAssistance1.Discount = Convert.ToDouble(dr["Discount"]);
                                                    string discount = dr["Discount"].ToString();
                                                    exportOfferTechnicalAssistance1.Discount = Convert.ToDouble(discount);
                                                }
                                                offer._ExportOfferTechnicalAssistanceLst.Add(exportOfferTechnicalAssistance1);
                                            }
                                            #endregion
                                        }//Component 
                                        //https://helpdesk.emdep.com/browse/APIGEOS-269
                                        else if (dr["TemplateName"].ToString().ToUpper() == "Component".ToUpper())
                                        {
                                            #region Component

                                            #region oldComponent

                                            //if (offer._ExportOfferComponentLst == null)
                                            //    offer._ExportOfferComponentLst = new List<ExportOfferComponent>();
                                            //ExportOfferComponent component = new ExportOfferComponent();
                                            //if (dr["Reference"] != DBNull.Value)
                                            //{
                                            //    component.Reference = Convert.ToString(dr["Reference"]);
                                            //}
                                            //if (dr["Description"] != DBNull.Value)
                                            //{
                                            //    component.Name = Convert.ToString(dr["Description"]);
                                            //}
                                            //if (dr["UnitPrice"] != DBNull.Value)
                                            //{
                                            //    component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                            //}
                                            //if (dr["Quantity"] != DBNull.Value)
                                            //{
                                            //    component.Qty = Convert.ToInt64(dr["Quantity"]);
                                            //}
                                            //if (dr["TotalPrice"] != DBNull.Value)
                                            //{
                                            //    component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                            //}
                                            //offer._ExportOfferComponentLst.Add(component);
                                            #endregion

                                            if (dr["Reference"] != DBNull.Value)
                                            {
                                                if (offer._ExportOfferComponentLst == null)
                                                    offer._ExportOfferComponentLst = new List<ExportOfferComponent>();
                                                if (offer._ExportOfferComponentLst.Any(spl => spl.Reference.Equals(Convert.ToString(dr["Reference"])) && spl.Item.Equals(dr["NumItem"].ToString())))
                                                {

                                                    ExportOfferComponent OfferComponent = offer._ExportOfferComponentLst.Where(i => i.Reference.Equals(Convert.ToString(dr["Reference"].ToString())) && i.Item.Equals(dr["NumItem"].ToString())).FirstOrDefault();
                                                    if (OfferComponent.Item.Equals(dr["NumItem"].ToString()))
                                                    {
                                                        if (OfferComponent.features == null)
                                                            OfferComponent.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        OfferComponent.features.Add(createitemsfeatures);
                                                    }
                                                    else
                                                    {
                                                        if (offer._ExportOfferComponentLst == null)
                                                            offer._ExportOfferComponentLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component = new ExportOfferComponent();
                                                        if (dr["NumItem"] != DBNull.Value)
                                                        {
                                                            component.Item = Convert.ToString(dr["NumItem"]);
                                                        }
                                                        if (dr["Reference"] != DBNull.Value)
                                                        {
                                                            component.Reference = Convert.ToString(dr["Reference"]);
                                                        }
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component.Name = Convert.ToString(dr["Description"]);
                                                        }
                                                        //if (dr["UnitPrice"] != DBNull.Value)
                                                        //{
                                                        //    component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                        //}
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                        }
                                                        if (dr["TotalPrice"] != DBNull.Value)
                                                        {
                                                            component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                        }
                                                        if (dr["CustomerComment"] != DBNull.Value)
                                                        {
                                                            component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            //component.Discount = Convert.ToDouble(dr["Discount"]);
                                                            string discount = dr["Discount"].ToString();
                                                            component.Discount = Convert.ToDouble(discount);
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            }
                                                            else
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                                double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                                component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);
                                                            }

                                                            //double temp = Math.Round(Convert.ToDouble(1- (exportOfferTechnicalAssistance.Discount/100)), 2, MidpointRounding.AwayFromZero);
                                                            //exportOfferTechnicalAssistance.UnitPrice = Math.Round((exportOfferTechnicalAssistance.UnitPrice / temp), 2, MidpointRounding.AwayFromZero);

                                                            //double discountapply = Math.Round(Convert.ToDouble(100 - component.Discount), 2, MidpointRounding.AwayFromZero);
                                                            //double discountapplyUnitPrice = Math.Round(Convert.ToDouble(component.UnitPrice * 100), 2, MidpointRounding.AwayFromZero);
                                                            //// double originalsale_unit_price
                                                            //component.UnitPrice = Math.Round((discountapplyUnitPrice / discountapply), 2, MidpointRounding.AwayFromZero);
                                                        }
                                                        if (component.features == null)
                                                            component.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        component.features.Add(createitemsfeatures);

                                                        offer._ExportOfferComponentLst.Add(component);

                                                        if (component.Discount != 0)
                                                        {
                                                            if (offer._ExportOfferComponentLst == null)
                                                                offer._ExportOfferComponentLst = new List<ExportOfferComponent>();
                                                            ExportOfferComponent component1 = new ExportOfferComponent();
                                                            if (dr["Description"] != DBNull.Value)
                                                            {
                                                                component1.Name = "Discount";
                                                            }
                                                            if (dr["UnitPrice"] != DBNull.Value)
                                                            {
                                                                //component1.UnitPrice = -((component.UnitPrice * component.Discount) / 100);
                                                                if (component.UnitPrice == 0 && component.Discount == 100)
                                                                {
                                                                    component1.UnitPrice = 0;
                                                                }
                                                                else
                                                                {

                                                                    double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                    component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                                }

                                                            }
                                                            if (dr["Quantity"] != DBNull.Value)
                                                            {
                                                                component1.Qty = -1;
                                                            }
                                                            if (dr["Discount"] != DBNull.Value)
                                                            {
                                                                // component1.Discount = Convert.ToDouble(dr["Discount"]);
                                                                string discount = dr["Discount"].ToString();
                                                                component1.Discount = Convert.ToDouble(discount);
                                                            }
                                                            offer._ExportOfferComponentLst.Add(component1);
                                                        }
                                                    }
                                                    //if (OfferComponent.features == null)
                                                    //    OfferComponent.features = new List<Createitemsfeatures>();
                                                    //Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                    //if (dr["DetectionName"] != DBNull.Value)
                                                    //{
                                                    //    createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                    //}
                                                    //if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                    //{
                                                    //    createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                    //}
                                                    //OfferComponent.features.Add(createitemsfeatures);
                                                }
                                                else
                                                {
                                                    if (offer._ExportOfferComponentLst == null)
                                                        offer._ExportOfferComponentLst = new List<ExportOfferComponent>();
                                                    ExportOfferComponent component = new ExportOfferComponent();
                                                    if (dr["NumItem"] != DBNull.Value)
                                                    {
                                                        component.Item = Convert.ToString(dr["NumItem"]);
                                                    }
                                                    if (dr["Reference"] != DBNull.Value)
                                                    {
                                                        component.Reference = Convert.ToString(dr["Reference"]);
                                                    }
                                                    if (dr["Description"] != DBNull.Value)
                                                    {
                                                        component.Name = Convert.ToString(dr["Description"]);
                                                    }
                                                    //if (dr["UnitPrice"] != DBNull.Value)
                                                    //{
                                                    //    component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                    //}
                                                    if (dr["Quantity"] != DBNull.Value)
                                                    {
                                                        component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                    }
                                                    if (dr["TotalPrice"] != DBNull.Value)
                                                    {
                                                        component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                    }
                                                    if (dr["CustomerComment"] != DBNull.Value)
                                                    {
                                                        component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                    }
                                                    if (dr["Discount"] != DBNull.Value)
                                                    {
                                                        //component.Discount = Convert.ToDouble(dr["Discount"]);
                                                        string discount = dr["Discount"].ToString();
                                                        component.Discount = Convert.ToDouble(discount);
                                                    }
                                                    if (dr["UnitPrice"] != DBNull.Value)
                                                    {
                                                        if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                        }
                                                        else
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                            component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);

                                                        }
                                                        //double discountapply = Math.Round(Convert.ToDouble(100 - component.Discount), 2, MidpointRounding.AwayFromZero);
                                                        //double discountapplyUnitPrice = Math.Round(Convert.ToDouble(component.UnitPrice * 100), 2, MidpointRounding.AwayFromZero);
                                                        //// double originalsale_unit_price
                                                        //component.UnitPrice = Math.Round((discountapplyUnitPrice / discountapply), 2, MidpointRounding.AwayFromZero);
                                                    }
                                                    if (component.features == null)
                                                        component.features = new List<Createitemsfeatures>();
                                                    Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                    if (dr["DetectionName"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                    }
                                                    if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                    }
                                                    component.features.Add(createitemsfeatures);

                                                    offer._ExportOfferComponentLst.Add(component);

                                                    if (component.Discount != 0)
                                                    {
                                                        if (offer._ExportOfferComponentLst == null)
                                                            offer._ExportOfferComponentLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component1 = new ExportOfferComponent();
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component1.Name = "Discount";
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            // component1.UnitPrice = -((component.UnitPrice * component.Discount) / 100);
                                                            if (component.UnitPrice == 0 && component.Discount == 100)
                                                            {
                                                                component1.UnitPrice = 0;
                                                            }
                                                            else
                                                            {
                                                                double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component1.Qty = -1;
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            //component1.Discount = Convert.ToDouble(dr["Discount"]);
                                                            string discount = dr["Discount"].ToString();
                                                            component1.Discount = Convert.ToDouble(discount);
                                                        }
                                                        offer._ExportOfferComponentLst.Add(component1);
                                                    }
                                                }


                                            }
                                            #endregion

                                        }
                                        #region Module
                                        //else if (dr["TemplateName"].ToString().ToUpper() != "Component".ToUpper() &&
                                        //    dr["TemplateName"].ToString().Trim().ToUpper() != "TECHNICAL ASSISTANCE".ToUpper() &&
                                        //    dr["TemplateName"].ToString().Trim().ToUpper() != "INVOICE".ToUpper() &&
                                        //    dr["TemplateName"].ToString().Trim().ToUpper() != "MATERIAL".Trim().ToUpper()
                                        //    )
                                        //{
                                        //    if (offer._ExportOfferModuleLst == null)
                                        //        offer._ExportOfferModuleLst = new List<ExportOfferComponent>();
                                        //    if (offer._ExportOfferModuleLst.Any(spl => spl.Reference.Equals(Convert.ToString(dr["Reference"])) && spl.Item.Equals(dr["NumItem"].ToString())))
                                        //    {

                                        //        ExportOfferComponent OfferComponent = offer._ExportOfferModuleLst.Where(i => i.Reference.Equals(Convert.ToString(dr["Reference"].ToString())) && i.Item.Equals(dr["NumItem"].ToString())).FirstOrDefault();
                                        //        if (OfferComponent.Item.Equals(dr["NumItem"].ToString()))
                                        //        {
                                        //            if (OfferComponent.features == null)
                                        //                OfferComponent.features = new List<Createitemsfeatures>();
                                        //            Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                        //            if (dr["DetectionName"] != DBNull.Value)
                                        //            {
                                        //                createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                        //            }
                                        //            if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                        //            {
                                        //                createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                        //            }
                                        //            OfferComponent.features.Add(createitemsfeatures);
                                        //        }
                                        //        else
                                        //        {
                                        //            if (offer._ExportOfferModuleLst == null)
                                        //                offer._ExportOfferModuleLst = new List<ExportOfferComponent>();
                                        //            ExportOfferComponent module = new ExportOfferComponent();
                                        //            if (dr["TemplateName"] != DBNull.Value)
                                        //            {
                                        //                module.TemplateName = Convert.ToString(dr["TemplateName"]);
                                        //            }
                                        //            if (dr["NumItem"] != DBNull.Value)
                                        //            {
                                        //                module.Item = Convert.ToString(dr["NumItem"]);
                                        //            }
                                        //            if (dr["Reference"] != DBNull.Value)
                                        //            {
                                        //                module.Reference = Convert.ToString(dr["Reference"]);
                                        //            }
                                        //            if (dr["Description"] != DBNull.Value)
                                        //            {
                                        //                module.Name = Convert.ToString(dr["Description"]);
                                        //            }
                                        //            //if (dr["UnitPrice"] != DBNull.Value)
                                        //            //{
                                        //            //    component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                        //            //}
                                        //            if (dr["Quantity"] != DBNull.Value)
                                        //            {
                                        //                module.Qty = Convert.ToInt64(dr["Quantity"]);
                                        //            }
                                        //            if (dr["TotalPrice"] != DBNull.Value)
                                        //            {
                                        //                module.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                        //            }
                                        //            if (dr["CustomerComment"] != DBNull.Value)
                                        //            {
                                        //                module.Comments = Convert.ToString(dr["CustomerComment"]);
                                        //            }
                                        //            if (dr["Discount"] != DBNull.Value)
                                        //            {
                                        //                //component.Discount = Convert.ToDouble(dr["Discount"]);
                                        //                string discount = dr["Discount"].ToString();
                                        //                module.Discount = Convert.ToDouble(discount);
                                        //            }
                                        //            if (dr["UnitPrice"] != DBNull.Value)
                                        //            {
                                        //                if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                        //                {
                                        //                    module.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                        //                }
                                        //                else
                                        //                {
                                        //                    module.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                        //                    double temp = Convert.ToDouble(1 - (module.Discount / 100));
                                        //                    module.UnitPrice = Math.Round((module.UnitPrice / temp), 2);

                                        //                }
                                        //                //double discountapply = Math.Round(Convert.ToDouble(100 - component.Discount), 2, MidpointRounding.AwayFromZero);
                                        //                //double discountapplyUnitPrice = Math.Round(Convert.ToDouble(component.UnitPrice * 100), 2, MidpointRounding.AwayFromZero);
                                        //                //// double originalsale_unit_price
                                        //                //component.UnitPrice = Math.Round((discountapplyUnitPrice / discountapply), 2, MidpointRounding.AwayFromZero);
                                        //            }

                                        //            if (module.features == null)
                                        //            {
                                        //                module.features = new List<Createitemsfeatures>();
                                        //            }

                                        //            for (int i = 1; i <= 3; i++)
                                        //            {
                                        //                // Assuming dr represents your database record
                                        //                if (dr["iddetectiontype"] != DBNull.Value)
                                        //                {
                                        //                    int iddetectiontype = Convert.ToInt32(dr["iddetectiontype"]);

                                        //                    // Check if iddetectiontype matches the current loop counter
                                        //                    if (iddetectiontype == i)
                                        //                    {
                                        //                        // Create a new Createitemsfeatures object inside the loop
                                        //                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();

                                        //                        // Continue with processing the data
                                        //                        if (dr["DetectionName"] != DBNull.Value)
                                        //                        {
                                        //                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);

                                        //                        }
                                        //                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                        //                        {
                                        //                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                        //                        }

                                        //                        // Add the newly created Createitemsfeatures object to the module.features list
                                        //                        module.features.Add(createitemsfeatures);
                                        //                    }
                                        //                }
                                        //            }

                                        //            offer._ExportOfferModuleLst.Add(module);

                                        //            if (module.Discount != 0)
                                        //            {
                                        //                if (offer._ExportOfferModuleLst == null)
                                        //                    offer._ExportOfferModuleLst = new List<ExportOfferComponent>();
                                        //                ExportOfferComponent module1 = new ExportOfferComponent();
                                        //                if (dr["Description"] != DBNull.Value)
                                        //                {
                                        //                    module1.Name = "Discount";
                                        //                }
                                        //                if (dr["UnitPrice"] != DBNull.Value)
                                        //                {
                                        //                    // component1.UnitPrice = -((component.UnitPrice * component.Discount) / 100);
                                        //                    if (module.UnitPrice == 0 && module.Discount == 100)
                                        //                    {
                                        //                        module1.UnitPrice = 0;
                                        //                    }
                                        //                    else
                                        //                    {
                                        //                        double discount = Math.Round(((module.UnitPrice * module.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                        //                        module1.UnitPrice = Math.Round((discount * module.Qty), 2, MidpointRounding.AwayFromZero);
                                        //                    }

                                        //                }
                                        //                if (dr["Quantity"] != DBNull.Value)
                                        //                {
                                        //                    module1.Qty = -1;
                                        //                }
                                        //                if (dr["Discount"] != DBNull.Value)
                                        //                {
                                        //                    //component1.Discount = Convert.ToDouble(dr["Discount"]);
                                        //                    string discount = dr["Discount"].ToString();
                                        //                    module1.Discount = Convert.ToDouble(discount);
                                        //                }
                                        //                offer._ExportOfferModuleLst.Add(module1);
                                        //            }
                                        //        }
                                        //        //if (OfferComponent.features == null)
                                        //        //    OfferComponent.features = new List<Createitemsfeatures>();
                                        //        //Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                        //        //if (dr["DetectionName"] != DBNull.Value)
                                        //        //{
                                        //        //    createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                        //        //}
                                        //        //if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                        //        //{
                                        //        //    createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                        //        //}
                                        //        //OfferComponent.features.Add(createitemsfeatures);
                                        //    }
                                        //    else
                                        //    {
                                        //        if (offer._ExportOfferModuleLst == null)
                                        //            offer._ExportOfferModuleLst = new List<ExportOfferComponent>();
                                        //        ExportOfferComponent module = new ExportOfferComponent();
                                        //        if (dr["TemplateName"] != DBNull.Value)
                                        //        {
                                        //            module.TemplateName = Convert.ToString(dr["TemplateName"]);
                                        //        }
                                        //        if (dr["NumItem"] != DBNull.Value)
                                        //        {
                                        //            module.Item = Convert.ToString(dr["NumItem"]);
                                        //        }
                                        //        if (dr["Reference"] != DBNull.Value)
                                        //        {
                                        //            module.Reference = Convert.ToString(dr["Reference"]);
                                        //        }
                                        //        if (dr["Description"] != DBNull.Value)
                                        //        {
                                        //            module.Name = Convert.ToString(dr["Description"]);
                                        //        }
                                        //        //if (dr["UnitPrice"] != DBNull.Value)
                                        //        //{
                                        //        //    component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                        //        //}
                                        //        if (dr["Quantity"] != DBNull.Value)
                                        //        {
                                        //            module.Qty = Convert.ToInt64(dr["Quantity"]);
                                        //        }
                                        //        if (dr["TotalPrice"] != DBNull.Value)
                                        //        {
                                        //            module.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                        //        }
                                        //        if (dr["CustomerComment"] != DBNull.Value)
                                        //        {
                                        //            module.Comments = Convert.ToString(dr["CustomerComment"]);
                                        //        }
                                        //        if (dr["Discount"] != DBNull.Value)
                                        //        {
                                        //            //component.Discount = Convert.ToDouble(dr["Discount"]);
                                        //            string discount = dr["Discount"].ToString();
                                        //            module.Discount = Convert.ToDouble(discount);
                                        //        }
                                        //        if (dr["UnitPrice"] != DBNull.Value)
                                        //        {
                                        //            if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                        //            {
                                        //                module.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                        //            }
                                        //            else
                                        //            {
                                        //                module.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                        //                double temp = Convert.ToDouble(1 - (module.Discount / 100));
                                        //                module.UnitPrice = Math.Round((module.UnitPrice / temp), 2);

                                        //            }
                                        //            //double discountapply = Math.Round(Convert.ToDouble(100 - component.Discount), 2, MidpointRounding.AwayFromZero);
                                        //            //double discountapplyUnitPrice = Math.Round(Convert.ToDouble(component.UnitPrice * 100), 2, MidpointRounding.AwayFromZero);
                                        //            //// double originalsale_unit_price
                                        //            //component.UnitPrice = Math.Round((discountapplyUnitPrice / discountapply), 2, MidpointRounding.AwayFromZero);
                                        //        }

                                        //        if (module.features == null)
                                        //        {
                                        //            module.features = new List<Createitemsfeatures>();
                                        //        }

                                        //        for (int i = 1; i <= 3; i++)
                                        //        {
                                        //            // Assuming dr represents your database record
                                        //            if (dr["iddetectiontype"] != DBNull.Value)
                                        //            {
                                        //                int iddetectiontype = Convert.ToInt32(dr["iddetectiontype"]);

                                        //                // Check if iddetectiontype matches the current loop counter
                                        //                if (iddetectiontype == i)
                                        //                {
                                        //                    // Create a new Createitemsfeatures object inside the loop
                                        //                    Createitemsfeatures createitemsfeatures = new Createitemsfeatures();

                                        //                    // Continue with processing the data
                                        //                    if (dr["DetectionName"] != DBNull.Value)
                                        //                    {
                                        //                        createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);

                                        //                    }
                                        //                    if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                        //                    {
                                        //                        createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                        //                    }

                                        //                    // Add the newly created Createitemsfeatures object to the module.features list
                                        //                    module.features.Add(createitemsfeatures);
                                        //                }
                                        //            }
                                        //        }

                                        //        offer._ExportOfferModuleLst.Add(module);

                                        //        if (module.Discount != 0)
                                        //        {
                                        //            if (offer._ExportOfferModuleLst == null)
                                        //                offer._ExportOfferModuleLst = new List<ExportOfferComponent>();
                                        //            ExportOfferComponent module1 = new ExportOfferComponent();
                                        //            if (dr["Description"] != DBNull.Value)
                                        //            {
                                        //                module1.Name = "Discount";
                                        //            }
                                        //            if (dr["UnitPrice"] != DBNull.Value)
                                        //            {
                                        //                // component1.UnitPrice = -((component.UnitPrice * component.Discount) / 100);
                                        //                if (module.UnitPrice == 0 && module.Discount == 100)
                                        //                {
                                        //                    module1.UnitPrice = 0;
                                        //                }
                                        //                else
                                        //                {
                                        //                    double discount = Math.Round(((module.UnitPrice * module.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                        //                    module1.UnitPrice = Math.Round((discount * module.Qty), 2, MidpointRounding.AwayFromZero);
                                        //                }

                                        //            }
                                        //            if (dr["Quantity"] != DBNull.Value)
                                        //            {
                                        //                module1.Qty = -1;
                                        //            }
                                        //            if (dr["Discount"] != DBNull.Value)
                                        //            {
                                        //                //component1.Discount = Convert.ToDouble(dr["Discount"]);
                                        //                string discount = dr["Discount"].ToString();
                                        //                module1.Discount = Convert.ToDouble(discount);
                                        //            }
                                        //            offer._ExportOfferModuleLst.Add(module1);
                                        //        }
                                        //    }
                                        //}
                                        #endregion

                                        #region chitra.girigosavi APIGEOS-1171 Changes when generating the offer for Counterpart type items
                                        else if (dr["TemplateName"].ToString().ToUpper() == "Pneumatic".ToUpper())
                                        {
                                            #region Pneumatic

                                            if (dr["Reference"] != DBNull.Value)
                                            {
                                                if (offer._ExportOfferPneumaticLst == null)
                                                    offer._ExportOfferPneumaticLst = new List<ExportOfferComponent>();
                                                if (offer._ExportOfferPneumaticLst.Any(spl => spl.Reference.Equals(Convert.ToString(dr["Reference"])) && spl.Item.Equals(dr["NumItem"].ToString())))
                                                {

                                                    ExportOfferComponent OfferComponent = offer._ExportOfferPneumaticLst.Where(i => i.Reference.Equals(Convert.ToString(dr["Reference"].ToString())) && i.Item.Equals(dr["NumItem"].ToString())).FirstOrDefault();
                                                    if (OfferComponent.Item.Equals(dr["NumItem"].ToString()))
                                                    {
                                                        if (OfferComponent.features == null)
                                                            OfferComponent.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        OfferComponent.features.Add(createitemsfeatures);
                                                    }
                                                    else
                                                    {
                                                        if (offer._ExportOfferPneumaticLst == null)
                                                            offer._ExportOfferPneumaticLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component = new ExportOfferComponent();
                                                        if (dr["NumItem"] != DBNull.Value)
                                                        {
                                                            component.Item = Convert.ToString(dr["NumItem"]);
                                                        }
                                                        if (dr["Reference"] != DBNull.Value)
                                                        {
                                                            component.Reference = Convert.ToString(dr["Reference"]);
                                                        }
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component.Name = Convert.ToString(dr["Description"]);
                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                        }
                                                        if (dr["TotalPrice"] != DBNull.Value)
                                                        {
                                                            component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                        }
                                                        if (dr["CustomerComment"] != DBNull.Value)
                                                        {
                                                            component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component.Discount = Convert.ToDouble(discount);
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            }
                                                            else
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                                double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                                component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);
                                                            }

                                                        }
                                                        if (component.features == null)
                                                            component.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        component.features.Add(createitemsfeatures);

                                                        offer._ExportOfferPneumaticLst.Add(component);

                                                        if (component.Discount != 0)
                                                        {
                                                            if (offer._ExportOfferPneumaticLst == null)
                                                                offer._ExportOfferPneumaticLst = new List<ExportOfferComponent>();
                                                            ExportOfferComponent component1 = new ExportOfferComponent();
                                                            if (dr["Description"] != DBNull.Value)
                                                            {
                                                                component1.Name = "Discount";
                                                            }
                                                            if (dr["UnitPrice"] != DBNull.Value)
                                                            {
                                                                if (component.UnitPrice == 0 && component.Discount == 100)
                                                                {
                                                                    component1.UnitPrice = 0;
                                                                }
                                                                else
                                                                {

                                                                    double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                    component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                                }

                                                            }
                                                            if (dr["Quantity"] != DBNull.Value)
                                                            {
                                                                component1.Qty = -1;
                                                            }
                                                            if (dr["Discount"] != DBNull.Value)
                                                            {
                                                                string discount = dr["Discount"].ToString();
                                                                component1.Discount = Convert.ToDouble(discount);
                                                            }
                                                            offer._ExportOfferPneumaticLst.Add(component1);
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    if (offer._ExportOfferPneumaticLst == null)
                                                        offer._ExportOfferPneumaticLst = new List<ExportOfferComponent>();
                                                    ExportOfferComponent component = new ExportOfferComponent();
                                                    if (dr["NumItem"] != DBNull.Value)
                                                    {
                                                        component.Item = Convert.ToString(dr["NumItem"]);
                                                    }
                                                    if (dr["Reference"] != DBNull.Value)
                                                    {
                                                        component.Reference = Convert.ToString(dr["Reference"]);
                                                    }
                                                    if (dr["Description"] != DBNull.Value)
                                                    {
                                                        component.Name = Convert.ToString(dr["Description"]);
                                                    }
                                                    if (dr["Quantity"] != DBNull.Value)
                                                    {
                                                        component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                    }
                                                    if (dr["TotalPrice"] != DBNull.Value)
                                                    {
                                                        component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                    }
                                                    if (dr["CustomerComment"] != DBNull.Value)
                                                    {
                                                        component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                    }
                                                    if (dr["Discount"] != DBNull.Value)
                                                    {
                                                        string discount = dr["Discount"].ToString();
                                                        component.Discount = Convert.ToDouble(discount);
                                                    }
                                                    if (dr["UnitPrice"] != DBNull.Value)
                                                    {
                                                        if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                        }
                                                        else
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                            component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);

                                                        }
                                                    }
                                                    if (component.features == null)
                                                        component.features = new List<Createitemsfeatures>();
                                                    Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                    if (dr["DetectionName"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                    }
                                                    if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                    }
                                                    if (dr["SortOrder"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                    }
                                                    component.features.Add(createitemsfeatures);

                                                    offer._ExportOfferPneumaticLst.Add(component);

                                                    if (component.Discount != 0)
                                                    {
                                                        if (offer._ExportOfferPneumaticLst == null)
                                                            offer._ExportOfferPneumaticLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component1 = new ExportOfferComponent();
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component1.Name = "Discount";
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (component.UnitPrice == 0 && component.Discount == 100)
                                                            {
                                                                component1.UnitPrice = 0;
                                                            }
                                                            else
                                                            {
                                                                double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component1.Qty = -1;
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component1.Discount = Convert.ToDouble(discount);
                                                        }
                                                        offer._ExportOfferPneumaticLst.Add(component1);
                                                    }
                                                }


                                            }
                                            #endregion
                                        }
                                        else if (dr["TemplateName"].ToString().ToUpper() == "Assembly".ToUpper())
                                        {
                                            #region Assembly

                                            if (dr["Reference"] != DBNull.Value)
                                            {
                                                if (offer._ExportOfferAssemblyLst == null)
                                                    offer._ExportOfferAssemblyLst = new List<ExportOfferComponent>();
                                                if (offer._ExportOfferAssemblyLst.Any(spl => spl.Reference.Equals(Convert.ToString(dr["Reference"])) && spl.Item.Equals(dr["NumItem"].ToString())))
                                                {

                                                    ExportOfferComponent OfferComponent = offer._ExportOfferAssemblyLst.Where(i => i.Reference.Equals(Convert.ToString(dr["Reference"].ToString())) && i.Item.Equals(dr["NumItem"].ToString())).FirstOrDefault();
                                                    if (OfferComponent.Item.Equals(dr["NumItem"].ToString()))
                                                    {
                                                        if (OfferComponent.features == null)
                                                            OfferComponent.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        OfferComponent.features.Add(createitemsfeatures);
                                                    }
                                                    else
                                                    {
                                                        if (offer._ExportOfferAssemblyLst == null)
                                                            offer._ExportOfferAssemblyLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component = new ExportOfferComponent();
                                                        if (dr["NumItem"] != DBNull.Value)
                                                        {
                                                            component.Item = Convert.ToString(dr["NumItem"]);
                                                        }
                                                        if (dr["Reference"] != DBNull.Value)
                                                        {
                                                            component.Reference = Convert.ToString(dr["Reference"]);
                                                        }
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component.Name = Convert.ToString(dr["Description"]);
                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                        }
                                                        if (dr["TotalPrice"] != DBNull.Value)
                                                        {
                                                            component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                        }
                                                        if (dr["CustomerComment"] != DBNull.Value)
                                                        {
                                                            component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component.Discount = Convert.ToDouble(discount);
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            }
                                                            else
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                                double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                                component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);
                                                            }

                                                        }
                                                        if (component.features == null)
                                                            component.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        component.features.Add(createitemsfeatures);

                                                        offer._ExportOfferAssemblyLst.Add(component);

                                                        if (component.Discount != 0)
                                                        {
                                                            if (offer._ExportOfferAssemblyLst == null)
                                                                offer._ExportOfferAssemblyLst = new List<ExportOfferComponent>();
                                                            ExportOfferComponent component1 = new ExportOfferComponent();
                                                            if (dr["Description"] != DBNull.Value)
                                                            {
                                                                component1.Name = "Discount";
                                                            }
                                                            if (dr["UnitPrice"] != DBNull.Value)
                                                            {
                                                                if (component.UnitPrice == 0 && component.Discount == 100)
                                                                {
                                                                    component1.UnitPrice = 0;
                                                                }
                                                                else
                                                                {

                                                                    double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                    component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                                }

                                                            }
                                                            if (dr["Quantity"] != DBNull.Value)
                                                            {
                                                                component1.Qty = -1;
                                                            }
                                                            if (dr["Discount"] != DBNull.Value)
                                                            {
                                                                string discount = dr["Discount"].ToString();
                                                                component1.Discount = Convert.ToDouble(discount);
                                                            }
                                                            offer._ExportOfferAssemblyLst.Add(component1);
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    if (offer._ExportOfferAssemblyLst == null)
                                                        offer._ExportOfferAssemblyLst = new List<ExportOfferComponent>();
                                                    ExportOfferComponent component = new ExportOfferComponent();
                                                    if (dr["NumItem"] != DBNull.Value)
                                                    {
                                                        component.Item = Convert.ToString(dr["NumItem"]);
                                                    }
                                                    if (dr["Reference"] != DBNull.Value)
                                                    {
                                                        component.Reference = Convert.ToString(dr["Reference"]);
                                                    }
                                                    if (dr["Description"] != DBNull.Value)
                                                    {
                                                        component.Name = Convert.ToString(dr["Description"]);
                                                    }
                                                    if (dr["Quantity"] != DBNull.Value)
                                                    {
                                                        component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                    }
                                                    if (dr["TotalPrice"] != DBNull.Value)
                                                    {
                                                        component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                    }
                                                    if (dr["CustomerComment"] != DBNull.Value)
                                                    {
                                                        component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                    }
                                                    if (dr["Discount"] != DBNull.Value)
                                                    {
                                                        string discount = dr["Discount"].ToString();
                                                        component.Discount = Convert.ToDouble(discount);
                                                    }
                                                    if (dr["UnitPrice"] != DBNull.Value)
                                                    {
                                                        if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                        }
                                                        else
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                            component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);

                                                        }
                                                    }
                                                    if (component.features == null)
                                                        component.features = new List<Createitemsfeatures>();
                                                    Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                    if (dr["DetectionName"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                    }
                                                    if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                    }
                                                    if (dr["SortOrder"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                    }
                                                    component.features.Add(createitemsfeatures);

                                                    offer._ExportOfferAssemblyLst.Add(component);

                                                    if (component.Discount != 0)
                                                    {
                                                        if (offer._ExportOfferAssemblyLst == null)
                                                            offer._ExportOfferAssemblyLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component1 = new ExportOfferComponent();
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component1.Name = "Discount";
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (component.UnitPrice == 0 && component.Discount == 100)
                                                            {
                                                                component1.UnitPrice = 0;
                                                            }
                                                            else
                                                            {
                                                                double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component1.Qty = -1;
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component1.Discount = Convert.ToDouble(discount);
                                                        }
                                                        offer._ExportOfferAssemblyLst.Add(component1);
                                                    }
                                                }


                                            }
                                            #endregion
                                        }
                                        else if (dr["TemplateName"].ToString().ToUpper() == "Electric Control".ToUpper())
                                        {
                                            #region Electric Control

                                            if (dr["Reference"] != DBNull.Value)
                                            {
                                                if (offer._ExportOfferElectric_ControlLst == null)
                                                    offer._ExportOfferElectric_ControlLst = new List<ExportOfferComponent>();
                                                if (offer._ExportOfferElectric_ControlLst.Any(spl => spl.Reference.Equals(Convert.ToString(dr["Reference"])) && spl.Item.Equals(dr["NumItem"].ToString())))
                                                {

                                                    ExportOfferComponent OfferComponent = offer._ExportOfferElectric_ControlLst.Where(i => i.Reference.Equals(Convert.ToString(dr["Reference"].ToString())) && i.Item.Equals(dr["NumItem"].ToString())).FirstOrDefault();
                                                    if (OfferComponent.Item.Equals(dr["NumItem"].ToString()))
                                                    {
                                                        if (OfferComponent.features == null)
                                                            OfferComponent.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        OfferComponent.features.Add(createitemsfeatures);
                                                    }
                                                    else
                                                    {
                                                        if (offer._ExportOfferElectric_ControlLst == null)
                                                            offer._ExportOfferElectric_ControlLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component = new ExportOfferComponent();
                                                        if (dr["NumItem"] != DBNull.Value)
                                                        {
                                                            component.Item = Convert.ToString(dr["NumItem"]);
                                                        }
                                                        if (dr["Reference"] != DBNull.Value)
                                                        {
                                                            component.Reference = Convert.ToString(dr["Reference"]);
                                                        }
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component.Name = Convert.ToString(dr["Description"]);
                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                        }
                                                        if (dr["TotalPrice"] != DBNull.Value)
                                                        {
                                                            component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                        }
                                                        if (dr["CustomerComment"] != DBNull.Value)
                                                        {
                                                            component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component.Discount = Convert.ToDouble(discount);
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            }
                                                            else
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                                double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                                component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);
                                                            }

                                                        }
                                                        if (component.features == null)
                                                            component.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        component.features.Add(createitemsfeatures);

                                                        offer._ExportOfferElectric_ControlLst.Add(component);

                                                        if (component.Discount != 0)
                                                        {
                                                            if (offer._ExportOfferElectric_ControlLst == null)
                                                                offer._ExportOfferElectric_ControlLst = new List<ExportOfferComponent>();
                                                            ExportOfferComponent component1 = new ExportOfferComponent();
                                                            if (dr["Description"] != DBNull.Value)
                                                            {
                                                                component1.Name = "Discount";
                                                            }
                                                            if (dr["UnitPrice"] != DBNull.Value)
                                                            {
                                                                if (component.UnitPrice == 0 && component.Discount == 100)
                                                                {
                                                                    component1.UnitPrice = 0;
                                                                }
                                                                else
                                                                {

                                                                    double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                    component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                                }

                                                            }
                                                            if (dr["Quantity"] != DBNull.Value)
                                                            {
                                                                component1.Qty = -1;
                                                            }
                                                            if (dr["Discount"] != DBNull.Value)
                                                            {
                                                                string discount = dr["Discount"].ToString();
                                                                component1.Discount = Convert.ToDouble(discount);
                                                            }
                                                            offer._ExportOfferElectric_ControlLst.Add(component1);
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    if (offer._ExportOfferElectric_ControlLst == null)
                                                        offer._ExportOfferElectric_ControlLst = new List<ExportOfferComponent>();
                                                    ExportOfferComponent component = new ExportOfferComponent();
                                                    if (dr["NumItem"] != DBNull.Value)
                                                    {
                                                        component.Item = Convert.ToString(dr["NumItem"]);
                                                    }
                                                    if (dr["Reference"] != DBNull.Value)
                                                    {
                                                        component.Reference = Convert.ToString(dr["Reference"]);
                                                    }
                                                    if (dr["Description"] != DBNull.Value)
                                                    {
                                                        component.Name = Convert.ToString(dr["Description"]);
                                                    }
                                                    if (dr["Quantity"] != DBNull.Value)
                                                    {
                                                        component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                    }
                                                    if (dr["TotalPrice"] != DBNull.Value)
                                                    {
                                                        component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                    }
                                                    if (dr["CustomerComment"] != DBNull.Value)
                                                    {
                                                        component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                    }
                                                    if (dr["Discount"] != DBNull.Value)
                                                    {
                                                        string discount = dr["Discount"].ToString();
                                                        component.Discount = Convert.ToDouble(discount);
                                                    }
                                                    if (dr["UnitPrice"] != DBNull.Value)
                                                    {
                                                        if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                        }
                                                        else
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                            component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);

                                                        }
                                                    }
                                                    if (component.features == null)
                                                        component.features = new List<Createitemsfeatures>();
                                                    Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                    if (dr["DetectionName"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                    }
                                                    if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                    }
                                                    if (dr["SortOrder"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                    }
                                                    component.features.Add(createitemsfeatures);

                                                    offer._ExportOfferElectric_ControlLst.Add(component);

                                                    if (component.Discount != 0)
                                                    {
                                                        if (offer._ExportOfferElectric_ControlLst == null)
                                                            offer._ExportOfferElectric_ControlLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component1 = new ExportOfferComponent();
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component1.Name = "Discount";
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (component.UnitPrice == 0 && component.Discount == 100)
                                                            {
                                                                component1.UnitPrice = 0;
                                                            }
                                                            else
                                                            {
                                                                double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component1.Qty = -1;
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component1.Discount = Convert.ToDouble(discount);
                                                        }
                                                        offer._ExportOfferElectric_ControlLst.Add(component1);
                                                    }
                                                }
                                            }
                                            #endregion
                                        }
                                        else if (dr["TemplateName"].ToString().ToUpper() == "Hybrid".ToUpper())
                                        {
                                            #region Hybrid

                                            if (dr["Reference"] != DBNull.Value)
                                            {
                                                if (offer._ExportOfferHybridLst == null)
                                                    offer._ExportOfferHybridLst = new List<ExportOfferComponent>();
                                                if (offer._ExportOfferHybridLst.Any(spl => spl.Reference.Equals(Convert.ToString(dr["Reference"])) && spl.Item.Equals(dr["NumItem"].ToString())))
                                                {

                                                    ExportOfferComponent OfferComponent = offer._ExportOfferHybridLst.Where(i => i.Reference.Equals(Convert.ToString(dr["Reference"].ToString())) && i.Item.Equals(dr["NumItem"].ToString())).FirstOrDefault();
                                                    if (OfferComponent.Item.Equals(dr["NumItem"].ToString()))
                                                    {
                                                        if (OfferComponent.features == null)
                                                            OfferComponent.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        OfferComponent.features.Add(createitemsfeatures);
                                                    }
                                                    else
                                                    {
                                                        if (offer._ExportOfferHybridLst == null)
                                                            offer._ExportOfferHybridLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component = new ExportOfferComponent();
                                                        if (dr["NumItem"] != DBNull.Value)
                                                        {
                                                            component.Item = Convert.ToString(dr["NumItem"]);
                                                        }
                                                        if (dr["Reference"] != DBNull.Value)
                                                        {
                                                            component.Reference = Convert.ToString(dr["Reference"]);
                                                        }
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component.Name = Convert.ToString(dr["Description"]);
                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                        }
                                                        if (dr["TotalPrice"] != DBNull.Value)
                                                        {
                                                            component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                        }
                                                        if (dr["CustomerComment"] != DBNull.Value)
                                                        {
                                                            component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component.Discount = Convert.ToDouble(discount);
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            }
                                                            else
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                                double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                                component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);
                                                            }

                                                        }
                                                        if (component.features == null)
                                                            component.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        component.features.Add(createitemsfeatures);

                                                        offer._ExportOfferHybridLst.Add(component);

                                                        if (component.Discount != 0)
                                                        {
                                                            if (offer._ExportOfferHybridLst == null)
                                                                offer._ExportOfferHybridLst = new List<ExportOfferComponent>();
                                                            ExportOfferComponent component1 = new ExportOfferComponent();
                                                            if (dr["Description"] != DBNull.Value)
                                                            {
                                                                component1.Name = "Discount";
                                                            }
                                                            if (dr["UnitPrice"] != DBNull.Value)
                                                            {
                                                                if (component.UnitPrice == 0 && component.Discount == 100)
                                                                {
                                                                    component1.UnitPrice = 0;
                                                                }
                                                                else
                                                                {

                                                                    double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                    component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                                }

                                                            }
                                                            if (dr["Quantity"] != DBNull.Value)
                                                            {
                                                                component1.Qty = -1;
                                                            }
                                                            if (dr["Discount"] != DBNull.Value)
                                                            {
                                                                string discount = dr["Discount"].ToString();
                                                                component1.Discount = Convert.ToDouble(discount);
                                                            }
                                                            offer._ExportOfferHybridLst.Add(component1);
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    if (offer._ExportOfferHybridLst == null)
                                                        offer._ExportOfferHybridLst = new List<ExportOfferComponent>();
                                                    ExportOfferComponent component = new ExportOfferComponent();
                                                    if (dr["NumItem"] != DBNull.Value)
                                                    {
                                                        component.Item = Convert.ToString(dr["NumItem"]);
                                                    }
                                                    if (dr["Reference"] != DBNull.Value)
                                                    {
                                                        component.Reference = Convert.ToString(dr["Reference"]);
                                                    }
                                                    if (dr["Description"] != DBNull.Value)
                                                    {
                                                        component.Name = Convert.ToString(dr["Description"]);
                                                    }
                                                    if (dr["Quantity"] != DBNull.Value)
                                                    {
                                                        component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                    }
                                                    if (dr["TotalPrice"] != DBNull.Value)
                                                    {
                                                        component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                    }
                                                    if (dr["CustomerComment"] != DBNull.Value)
                                                    {
                                                        component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                    }
                                                    if (dr["Discount"] != DBNull.Value)
                                                    {
                                                        string discount = dr["Discount"].ToString();
                                                        component.Discount = Convert.ToDouble(discount);
                                                    }
                                                    if (dr["UnitPrice"] != DBNull.Value)
                                                    {
                                                        if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                        }
                                                        else
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                            component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);

                                                        }
                                                    }
                                                    if (component.features == null)
                                                        component.features = new List<Createitemsfeatures>();
                                                    Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                    if (dr["DetectionName"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                    }
                                                    if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                    }
                                                    if (dr["SortOrder"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                    }
                                                    component.features.Add(createitemsfeatures);

                                                    offer._ExportOfferHybridLst.Add(component);

                                                    if (component.Discount != 0)
                                                    {
                                                        if (offer._ExportOfferHybridLst == null)
                                                            offer._ExportOfferHybridLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component1 = new ExportOfferComponent();
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component1.Name = "Discount";
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (component.UnitPrice == 0 && component.Discount == 100)
                                                            {
                                                                component1.UnitPrice = 0;
                                                            }
                                                            else
                                                            {
                                                                double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component1.Qty = -1;
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component1.Discount = Convert.ToDouble(discount);
                                                        }
                                                        offer._ExportOfferHybridLst.Add(component1);
                                                    }
                                                }
                                            }
                                            #endregion
                                        }
                                        else if (dr["TemplateName"].ToString().ToUpper() == "Japanese".ToUpper())
                                        {
                                            #region Japanese

                                            if (dr["Reference"] != DBNull.Value)
                                            {
                                                if (offer._ExportOfferJapaneseLst == null)
                                                    offer._ExportOfferJapaneseLst = new List<ExportOfferComponent>();
                                                if (offer._ExportOfferJapaneseLst.Any(spl => spl.Reference.Equals(Convert.ToString(dr["Reference"])) && spl.Item.Equals(dr["NumItem"].ToString())))
                                                {

                                                    ExportOfferComponent OfferComponent = offer._ExportOfferJapaneseLst.Where(i => i.Reference.Equals(Convert.ToString(dr["Reference"].ToString())) && i.Item.Equals(dr["NumItem"].ToString())).FirstOrDefault();
                                                    if (OfferComponent.Item.Equals(dr["NumItem"].ToString()))
                                                    {
                                                        if (OfferComponent.features == null)
                                                            OfferComponent.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        OfferComponent.features.Add(createitemsfeatures);
                                                    }
                                                    else
                                                    {
                                                        if (offer._ExportOfferJapaneseLst == null)
                                                            offer._ExportOfferJapaneseLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component = new ExportOfferComponent();
                                                        if (dr["NumItem"] != DBNull.Value)
                                                        {
                                                            component.Item = Convert.ToString(dr["NumItem"]);
                                                        }
                                                        if (dr["Reference"] != DBNull.Value)
                                                        {
                                                            component.Reference = Convert.ToString(dr["Reference"]);
                                                        }
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component.Name = Convert.ToString(dr["Description"]);
                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                        }
                                                        if (dr["TotalPrice"] != DBNull.Value)
                                                        {
                                                            component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                        }
                                                        if (dr["CustomerComment"] != DBNull.Value)
                                                        {
                                                            component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component.Discount = Convert.ToDouble(discount);
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            }
                                                            else
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                                double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                                component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);
                                                            }

                                                        }
                                                        if (component.features == null)
                                                            component.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        component.features.Add(createitemsfeatures);

                                                        offer._ExportOfferJapaneseLst.Add(component);

                                                        if (component.Discount != 0)
                                                        {
                                                            if (offer._ExportOfferJapaneseLst == null)
                                                                offer._ExportOfferJapaneseLst = new List<ExportOfferComponent>();
                                                            ExportOfferComponent component1 = new ExportOfferComponent();
                                                            if (dr["Description"] != DBNull.Value)
                                                            {
                                                                component1.Name = "Discount";
                                                            }
                                                            if (dr["UnitPrice"] != DBNull.Value)
                                                            {
                                                                if (component.UnitPrice == 0 && component.Discount == 100)
                                                                {
                                                                    component1.UnitPrice = 0;
                                                                }
                                                                else
                                                                {

                                                                    double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                    component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                                }

                                                            }
                                                            if (dr["Quantity"] != DBNull.Value)
                                                            {
                                                                component1.Qty = -1;
                                                            }
                                                            if (dr["Discount"] != DBNull.Value)
                                                            {
                                                                string discount = dr["Discount"].ToString();
                                                                component1.Discount = Convert.ToDouble(discount);
                                                            }
                                                            offer._ExportOfferJapaneseLst.Add(component1);
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    if (offer._ExportOfferJapaneseLst == null)
                                                        offer._ExportOfferJapaneseLst = new List<ExportOfferComponent>();
                                                    ExportOfferComponent component = new ExportOfferComponent();
                                                    if (dr["NumItem"] != DBNull.Value)
                                                    {
                                                        component.Item = Convert.ToString(dr["NumItem"]);
                                                    }
                                                    if (dr["Reference"] != DBNull.Value)
                                                    {
                                                        component.Reference = Convert.ToString(dr["Reference"]);
                                                    }
                                                    if (dr["Description"] != DBNull.Value)
                                                    {
                                                        component.Name = Convert.ToString(dr["Description"]);
                                                    }
                                                    if (dr["Quantity"] != DBNull.Value)
                                                    {
                                                        component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                    }
                                                    if (dr["TotalPrice"] != DBNull.Value)
                                                    {
                                                        component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                    }
                                                    if (dr["CustomerComment"] != DBNull.Value)
                                                    {
                                                        component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                    }
                                                    if (dr["Discount"] != DBNull.Value)
                                                    {
                                                        string discount = dr["Discount"].ToString();
                                                        component.Discount = Convert.ToDouble(discount);
                                                    }
                                                    if (dr["UnitPrice"] != DBNull.Value)
                                                    {
                                                        if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                        }
                                                        else
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                            component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);

                                                        }
                                                    }
                                                    if (component.features == null)
                                                        component.features = new List<Createitemsfeatures>();
                                                    Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                    if (dr["DetectionName"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                    }
                                                    if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                    }
                                                    if (dr["SortOrder"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                    }
                                                    component.features.Add(createitemsfeatures);

                                                    offer._ExportOfferJapaneseLst.Add(component);

                                                    if (component.Discount != 0)
                                                    {
                                                        if (offer._ExportOfferJapaneseLst == null)
                                                            offer._ExportOfferJapaneseLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component1 = new ExportOfferComponent();
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component1.Name = "Discount";
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (component.UnitPrice == 0 && component.Discount == 100)
                                                            {
                                                                component1.UnitPrice = 0;
                                                            }
                                                            else
                                                            {
                                                                double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component1.Qty = -1;
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component1.Discount = Convert.ToDouble(discount);
                                                        }
                                                        offer._ExportOfferJapaneseLst.Add(component1);
                                                    }
                                                }
                                            }
                                            #endregion
                                        }
                                        else if (dr["TemplateName"].ToString().ToUpper() == "Pull".ToUpper())
                                        {
                                            #region Pull

                                            if (dr["Reference"] != DBNull.Value)
                                            {
                                                if (offer._ExportOfferPullLst == null)
                                                    offer._ExportOfferPullLst = new List<ExportOfferComponent>();
                                                if (offer._ExportOfferPullLst.Any(spl => spl.Reference.Equals(Convert.ToString(dr["Reference"])) && spl.Item.Equals(dr["NumItem"].ToString())))
                                                {

                                                    ExportOfferComponent OfferComponent = offer._ExportOfferPullLst.Where(i => i.Reference.Equals(Convert.ToString(dr["Reference"].ToString())) && i.Item.Equals(dr["NumItem"].ToString())).FirstOrDefault();
                                                    if (OfferComponent.Item.Equals(dr["NumItem"].ToString()))
                                                    {
                                                        if (OfferComponent.features == null)
                                                            OfferComponent.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        OfferComponent.features.Add(createitemsfeatures);
                                                    }
                                                    else
                                                    {
                                                        if (offer._ExportOfferPullLst == null)
                                                            offer._ExportOfferPullLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component = new ExportOfferComponent();
                                                        if (dr["NumItem"] != DBNull.Value)
                                                        {
                                                            component.Item = Convert.ToString(dr["NumItem"]);
                                                        }
                                                        if (dr["Reference"] != DBNull.Value)
                                                        {
                                                            component.Reference = Convert.ToString(dr["Reference"]);
                                                        }
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component.Name = Convert.ToString(dr["Description"]);
                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                        }
                                                        if (dr["TotalPrice"] != DBNull.Value)
                                                        {
                                                            component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                        }
                                                        if (dr["CustomerComment"] != DBNull.Value)
                                                        {
                                                            component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component.Discount = Convert.ToDouble(discount);
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            }
                                                            else
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                                double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                                component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);
                                                            }

                                                        }
                                                        if (component.features == null)
                                                            component.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        component.features.Add(createitemsfeatures);

                                                        offer._ExportOfferPullLst.Add(component);

                                                        if (component.Discount != 0)
                                                        {
                                                            if (offer._ExportOfferPullLst == null)
                                                                offer._ExportOfferPullLst = new List<ExportOfferComponent>();
                                                            ExportOfferComponent component1 = new ExportOfferComponent();
                                                            if (dr["Description"] != DBNull.Value)
                                                            {
                                                                component1.Name = "Discount";
                                                            }
                                                            if (dr["UnitPrice"] != DBNull.Value)
                                                            {
                                                                if (component.UnitPrice == 0 && component.Discount == 100)
                                                                {
                                                                    component1.UnitPrice = 0;
                                                                }
                                                                else
                                                                {

                                                                    double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                    component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                                }

                                                            }
                                                            if (dr["Quantity"] != DBNull.Value)
                                                            {
                                                                component1.Qty = -1;
                                                            }
                                                            if (dr["Discount"] != DBNull.Value)
                                                            {
                                                                string discount = dr["Discount"].ToString();
                                                                component1.Discount = Convert.ToDouble(discount);
                                                            }
                                                            offer._ExportOfferPullLst.Add(component1);
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    if (offer._ExportOfferPullLst == null)
                                                        offer._ExportOfferPullLst = new List<ExportOfferComponent>();
                                                    ExportOfferComponent component = new ExportOfferComponent();
                                                    if (dr["NumItem"] != DBNull.Value)
                                                    {
                                                        component.Item = Convert.ToString(dr["NumItem"]);
                                                    }
                                                    if (dr["Reference"] != DBNull.Value)
                                                    {
                                                        component.Reference = Convert.ToString(dr["Reference"]);
                                                    }
                                                    if (dr["Description"] != DBNull.Value)
                                                    {
                                                        component.Name = Convert.ToString(dr["Description"]);
                                                    }
                                                    if (dr["Quantity"] != DBNull.Value)
                                                    {
                                                        component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                    }
                                                    if (dr["TotalPrice"] != DBNull.Value)
                                                    {
                                                        component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                    }
                                                    if (dr["CustomerComment"] != DBNull.Value)
                                                    {
                                                        component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                    }
                                                    if (dr["Discount"] != DBNull.Value)
                                                    {
                                                        string discount = dr["Discount"].ToString();
                                                        component.Discount = Convert.ToDouble(discount);
                                                    }
                                                    if (dr["UnitPrice"] != DBNull.Value)
                                                    {
                                                        if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                        }
                                                        else
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                            component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);

                                                        }
                                                    }
                                                    if (component.features == null)
                                                        component.features = new List<Createitemsfeatures>();
                                                    Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                    if (dr["DetectionName"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                    }
                                                    if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                    }
                                                    if (dr["SortOrder"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                    }
                                                    component.features.Add(createitemsfeatures);

                                                    offer._ExportOfferPullLst.Add(component);

                                                    if (component.Discount != 0)
                                                    {
                                                        if (offer._ExportOfferPullLst == null)
                                                            offer._ExportOfferPullLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component1 = new ExportOfferComponent();
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component1.Name = "Discount";
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (component.UnitPrice == 0 && component.Discount == 100)
                                                            {
                                                                component1.UnitPrice = 0;
                                                            }
                                                            else
                                                            {
                                                                double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component1.Qty = -1;
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component1.Discount = Convert.ToDouble(discount);
                                                        }
                                                        offer._ExportOfferPullLst.Add(component1);
                                                    }
                                                }
                                            }
                                            #endregion
                                        }
                                        else if (dr["TemplateName"].ToString().ToUpper() == "Vision".ToUpper())
                                        {
                                            #region Vision

                                            if (dr["Reference"] != DBNull.Value)
                                            {
                                                if (offer._ExportOfferVisionLst == null)
                                                    offer._ExportOfferVisionLst = new List<ExportOfferComponent>();
                                                if (offer._ExportOfferVisionLst.Any(spl => spl.Reference.Equals(Convert.ToString(dr["Reference"])) && spl.Item.Equals(dr["NumItem"].ToString())))
                                                {

                                                    ExportOfferComponent OfferComponent = offer._ExportOfferVisionLst.Where(i => i.Reference.Equals(Convert.ToString(dr["Reference"].ToString())) && i.Item.Equals(dr["NumItem"].ToString())).FirstOrDefault();
                                                    if (OfferComponent.Item.Equals(dr["NumItem"].ToString()))
                                                    {
                                                        if (OfferComponent.features == null)
                                                            OfferComponent.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        OfferComponent.features.Add(createitemsfeatures);
                                                    }
                                                    else
                                                    {
                                                        if (offer._ExportOfferVisionLst == null)
                                                            offer._ExportOfferVisionLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component = new ExportOfferComponent();
                                                        if (dr["NumItem"] != DBNull.Value)
                                                        {
                                                            component.Item = Convert.ToString(dr["NumItem"]);
                                                        }
                                                        if (dr["Reference"] != DBNull.Value)
                                                        {
                                                            component.Reference = Convert.ToString(dr["Reference"]);
                                                        }
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component.Name = Convert.ToString(dr["Description"]);
                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                        }
                                                        if (dr["TotalPrice"] != DBNull.Value)
                                                        {
                                                            component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                        }
                                                        if (dr["CustomerComment"] != DBNull.Value)
                                                        {
                                                            component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component.Discount = Convert.ToDouble(discount);
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            }
                                                            else
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                                double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                                component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);
                                                            }

                                                        }
                                                        if (component.features == null)
                                                            component.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        component.features.Add(createitemsfeatures);

                                                        offer._ExportOfferVisionLst.Add(component);

                                                        if (component.Discount != 0)
                                                        {
                                                            if (offer._ExportOfferVisionLst == null)
                                                                offer._ExportOfferVisionLst = new List<ExportOfferComponent>();
                                                            ExportOfferComponent component1 = new ExportOfferComponent();
                                                            if (dr["Description"] != DBNull.Value)
                                                            {
                                                                component1.Name = "Discount";
                                                            }
                                                            if (dr["UnitPrice"] != DBNull.Value)
                                                            {
                                                                if (component.UnitPrice == 0 && component.Discount == 100)
                                                                {
                                                                    component1.UnitPrice = 0;
                                                                }
                                                                else
                                                                {

                                                                    double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                    component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                                }

                                                            }
                                                            if (dr["Quantity"] != DBNull.Value)
                                                            {
                                                                component1.Qty = -1;
                                                            }
                                                            if (dr["Discount"] != DBNull.Value)
                                                            {
                                                                string discount = dr["Discount"].ToString();
                                                                component1.Discount = Convert.ToDouble(discount);
                                                            }
                                                            offer._ExportOfferVisionLst.Add(component1);
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    if (offer._ExportOfferVisionLst == null)
                                                        offer._ExportOfferVisionLst = new List<ExportOfferComponent>();
                                                    ExportOfferComponent component = new ExportOfferComponent();
                                                    if (dr["NumItem"] != DBNull.Value)
                                                    {
                                                        component.Item = Convert.ToString(dr["NumItem"]);
                                                    }

                                                    if (dr["Reference"] != DBNull.Value)
                                                    {
                                                        component.Reference = Convert.ToString(dr["Reference"]);
                                                    }
                                                    if (dr["Description"] != DBNull.Value)
                                                    {
                                                        component.Name = Convert.ToString(dr["Description"]);
                                                    }
                                                    if (dr["Quantity"] != DBNull.Value)
                                                    {
                                                        component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                    }
                                                    if (dr["TotalPrice"] != DBNull.Value)
                                                    {
                                                        component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                    }
                                                    if (dr["CustomerComment"] != DBNull.Value)
                                                    {
                                                        component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                    }
                                                    if (dr["Discount"] != DBNull.Value)
                                                    {
                                                        string discount = dr["Discount"].ToString();
                                                        component.Discount = Convert.ToDouble(discount);
                                                    }
                                                    if (dr["UnitPrice"] != DBNull.Value)
                                                    {
                                                        if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                        }
                                                        else
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                            component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);

                                                        }
                                                    }
                                                    if (component.features == null)
                                                        component.features = new List<Createitemsfeatures>();
                                                    Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                    if (dr["DetectionName"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                    }
                                                    if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                    }
                                                    if (dr["SortOrder"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                    }
                                                    component.features.Add(createitemsfeatures);

                                                    offer._ExportOfferVisionLst.Add(component);

                                                    if (component.Discount != 0)
                                                    {
                                                        if (offer._ExportOfferVisionLst == null)
                                                            offer._ExportOfferVisionLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component1 = new ExportOfferComponent();
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component1.Name = "Discount";
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (component.UnitPrice == 0 && component.Discount == 100)
                                                            {
                                                                component1.UnitPrice = 0;
                                                            }
                                                            else
                                                            {
                                                                double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component1.Qty = -1;
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component1.Discount = Convert.ToDouble(discount);
                                                        }
                                                        offer._ExportOfferVisionLst.Add(component1);
                                                    }
                                                }
                                            }
                                            #endregion
                                        }
                                        else if (dr["TemplateName"].ToString().ToUpper() == "Wireless".ToUpper())
                                        {
                                            #region Wireless

                                            if (dr["Reference"] != DBNull.Value)
                                            {
                                                if (offer._ExportOfferWirelessLst == null)
                                                    offer._ExportOfferWirelessLst = new List<ExportOfferComponent>();
                                                if (offer._ExportOfferWirelessLst.Any(spl => spl.Reference.Equals(Convert.ToString(dr["Reference"])) && spl.Item.Equals(dr["NumItem"].ToString())))
                                                {

                                                    ExportOfferComponent OfferComponent = offer._ExportOfferWirelessLst.Where(i => i.Reference.Equals(Convert.ToString(dr["Reference"].ToString())) && i.Item.Equals(dr["NumItem"].ToString())).FirstOrDefault();
                                                    if (OfferComponent.Item.Equals(dr["NumItem"].ToString()))
                                                    {
                                                        if (OfferComponent.features == null)
                                                            OfferComponent.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        OfferComponent.features.Add(createitemsfeatures);
                                                    }
                                                    else
                                                    {
                                                        if (offer._ExportOfferWirelessLst == null)
                                                            offer._ExportOfferWirelessLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component = new ExportOfferComponent();
                                                        if (dr["NumItem"] != DBNull.Value)
                                                        {
                                                            component.Item = Convert.ToString(dr["NumItem"]);
                                                        }
                                                        if (dr["Reference"] != DBNull.Value)
                                                        {
                                                            component.Reference = Convert.ToString(dr["Reference"]);
                                                        }
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component.Name = Convert.ToString(dr["Description"]);
                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                        }
                                                        if (dr["TotalPrice"] != DBNull.Value)
                                                        {
                                                            component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                        }
                                                        if (dr["CustomerComment"] != DBNull.Value)
                                                        {
                                                            component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component.Discount = Convert.ToDouble(discount);
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            }
                                                            else
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                                double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                                component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);
                                                            }

                                                        }
                                                        if (component.features == null)
                                                            component.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        component.features.Add(createitemsfeatures);

                                                        offer._ExportOfferWirelessLst.Add(component);

                                                        if (component.Discount != 0)
                                                        {
                                                            if (offer._ExportOfferWirelessLst == null)
                                                                offer._ExportOfferWirelessLst = new List<ExportOfferComponent>();
                                                            ExportOfferComponent component1 = new ExportOfferComponent();
                                                            if (dr["Description"] != DBNull.Value)
                                                            {
                                                                component1.Name = "Discount";
                                                            }
                                                            if (dr["UnitPrice"] != DBNull.Value)
                                                            {
                                                                if (component.UnitPrice == 0 && component.Discount == 100)
                                                                {
                                                                    component1.UnitPrice = 0;
                                                                }
                                                                else
                                                                {

                                                                    double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                    component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                                }

                                                            }
                                                            if (dr["Quantity"] != DBNull.Value)
                                                            {
                                                                component1.Qty = -1;
                                                            }
                                                            if (dr["Discount"] != DBNull.Value)
                                                            {
                                                                string discount = dr["Discount"].ToString();
                                                                component1.Discount = Convert.ToDouble(discount);
                                                            }
                                                            offer._ExportOfferWirelessLst.Add(component1);
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    if (offer._ExportOfferWirelessLst == null)
                                                        offer._ExportOfferWirelessLst = new List<ExportOfferComponent>();
                                                    ExportOfferComponent component = new ExportOfferComponent();
                                                    if (dr["NumItem"] != DBNull.Value)
                                                    {
                                                        component.Item = Convert.ToString(dr["NumItem"]);
                                                    }
                                                    if (dr["Reference"] != DBNull.Value)
                                                    {
                                                        component.Reference = Convert.ToString(dr["Reference"]);
                                                    }
                                                    if (dr["Description"] != DBNull.Value)
                                                    {
                                                        component.Name = Convert.ToString(dr["Description"]);
                                                    }
                                                    if (dr["Quantity"] != DBNull.Value)
                                                    {
                                                        component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                    }
                                                    if (dr["TotalPrice"] != DBNull.Value)
                                                    {
                                                        component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                    }
                                                    if (dr["CustomerComment"] != DBNull.Value)
                                                    {
                                                        component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                    }
                                                    if (dr["Discount"] != DBNull.Value)
                                                    {
                                                        string discount = dr["Discount"].ToString();
                                                        component.Discount = Convert.ToDouble(discount);
                                                    }
                                                    if (dr["UnitPrice"] != DBNull.Value)
                                                    {
                                                        if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                        }
                                                        else
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                            component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);

                                                        }
                                                    }
                                                    if (component.features == null)
                                                        component.features = new List<Createitemsfeatures>();
                                                    Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                    if (dr["DetectionName"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                    }
                                                    if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                    }
                                                    if (dr["SortOrder"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                    }
                                                    component.features.Add(createitemsfeatures);

                                                    offer._ExportOfferWirelessLst.Add(component);

                                                    if (component.Discount != 0)
                                                    {
                                                        if (offer._ExportOfferWirelessLst == null)
                                                            offer._ExportOfferWirelessLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component1 = new ExportOfferComponent();
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component1.Name = "Discount";
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (component.UnitPrice == 0 && component.Discount == 100)
                                                            {
                                                                component1.UnitPrice = 0;
                                                            }
                                                            else
                                                            {
                                                                double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component1.Qty = -1;
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component1.Discount = Convert.ToDouble(discount);
                                                        }
                                                        offer._ExportOfferWirelessLst.Add(component1);
                                                    }
                                                }
                                            }
                                            #endregion
                                        }
                                        else if (dr["TemplateName"].ToString().ToUpper() == "Well Insertion".ToUpper())
                                        {
                                            #region Well Insertion

                                            if (dr["Reference"] != DBNull.Value)
                                            {
                                                if (offer._ExportOfferWell_InsertionLst == null)
                                                    offer._ExportOfferWell_InsertionLst = new List<ExportOfferComponent>();
                                                if (offer._ExportOfferWell_InsertionLst.Any(spl => spl.Reference.Equals(Convert.ToString(dr["Reference"])) && spl.Item.Equals(dr["NumItem"].ToString())))
                                                {

                                                    ExportOfferComponent OfferComponent = offer._ExportOfferWell_InsertionLst.Where(i => i.Reference.Equals(Convert.ToString(dr["Reference"].ToString())) && i.Item.Equals(dr["NumItem"].ToString())).FirstOrDefault();
                                                    if (OfferComponent.Item.Equals(dr["NumItem"].ToString()))
                                                    {
                                                        if (OfferComponent.features == null)
                                                            OfferComponent.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        OfferComponent.features.Add(createitemsfeatures);
                                                    }
                                                    else
                                                    {
                                                        if (offer._ExportOfferWell_InsertionLst == null)
                                                            offer._ExportOfferWell_InsertionLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component = new ExportOfferComponent();
                                                        if (dr["NumItem"] != DBNull.Value)
                                                        {
                                                            component.Item = Convert.ToString(dr["NumItem"]);
                                                        }
                                                        if (dr["Reference"] != DBNull.Value)
                                                        {
                                                            component.Reference = Convert.ToString(dr["Reference"]);
                                                        }
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component.Name = Convert.ToString(dr["Description"]);
                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                        }
                                                        if (dr["TotalPrice"] != DBNull.Value)
                                                        {
                                                            component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                        }
                                                        if (dr["CustomerComment"] != DBNull.Value)
                                                        {
                                                            component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component.Discount = Convert.ToDouble(discount);
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            }
                                                            else
                                                            {
                                                                component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                                double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                                component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);
                                                            }

                                                        }
                                                        if (component.features == null)
                                                            component.features = new List<Createitemsfeatures>();
                                                        Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                        if (dr["DetectionName"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                        }
                                                        if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                        }
                                                        if (dr["SortOrder"] != DBNull.Value)
                                                        {
                                                            createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                        }
                                                        component.features.Add(createitemsfeatures);

                                                        offer._ExportOfferWell_InsertionLst.Add(component);

                                                        if (component.Discount != 0)
                                                        {
                                                            if (offer._ExportOfferWell_InsertionLst == null)
                                                                offer._ExportOfferWell_InsertionLst = new List<ExportOfferComponent>();
                                                            ExportOfferComponent component1 = new ExportOfferComponent();
                                                            if (dr["Description"] != DBNull.Value)
                                                            {
                                                                component1.Name = "Discount";
                                                            }
                                                            if (dr["UnitPrice"] != DBNull.Value)
                                                            {
                                                                if (component.UnitPrice == 0 && component.Discount == 100)
                                                                {
                                                                    component1.UnitPrice = 0;
                                                                }
                                                                else
                                                                {

                                                                    double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                    component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                                }

                                                            }
                                                            if (dr["Quantity"] != DBNull.Value)
                                                            {
                                                                component1.Qty = -1;
                                                            }
                                                            if (dr["Discount"] != DBNull.Value)
                                                            {
                                                                string discount = dr["Discount"].ToString();
                                                                component1.Discount = Convert.ToDouble(discount);
                                                            }
                                                            offer._ExportOfferWell_InsertionLst.Add(component1);
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    if (offer._ExportOfferWell_InsertionLst == null)
                                                        offer._ExportOfferWell_InsertionLst = new List<ExportOfferComponent>();
                                                    ExportOfferComponent component = new ExportOfferComponent();
                                                    if (dr["NumItem"] != DBNull.Value)
                                                    {
                                                        component.Item = Convert.ToString(dr["NumItem"]);
                                                    }
                                                    if (dr["Reference"] != DBNull.Value)
                                                    {
                                                        component.Reference = Convert.ToString(dr["Reference"]);
                                                    }
                                                    if (dr["Description"] != DBNull.Value)
                                                    {
                                                        component.Name = Convert.ToString(dr["Description"]);
                                                    }
                                                    if (dr["Quantity"] != DBNull.Value)
                                                    {
                                                        component.Qty = Convert.ToInt64(dr["Quantity"]);
                                                    }
                                                    if (dr["TotalPrice"] != DBNull.Value)
                                                    {
                                                        component.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                                    }
                                                    if (dr["CustomerComment"] != DBNull.Value)
                                                    {
                                                        component.Comments = Convert.ToString(dr["CustomerComment"]);
                                                    }
                                                    if (dr["Discount"] != DBNull.Value)
                                                    {
                                                        string discount = dr["Discount"].ToString();
                                                        component.Discount = Convert.ToDouble(discount);
                                                    }
                                                    if (dr["UnitPrice"] != DBNull.Value)
                                                    {
                                                        if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                        }
                                                        else
                                                        {
                                                            component.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                            double temp = Convert.ToDouble(1 - (component.Discount / 100));
                                                            component.UnitPrice = Math.Round((component.UnitPrice / temp), 2);

                                                        }
                                                    }
                                                    if (component.features == null)
                                                        component.features = new List<Createitemsfeatures>();
                                                    Createitemsfeatures createitemsfeatures = new Createitemsfeatures();
                                                    if (dr["DetectionName"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Name = Convert.ToString(dr["DetectionName"]);
                                                    }
                                                    if (dr["NumDetectionsQuantity"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.Quantity = Convert.ToInt32(dr["NumDetectionsQuantity"]);
                                                    }
                                                    if (dr["SortOrder"] != DBNull.Value)
                                                    {
                                                        createitemsfeatures.SortOrder = Convert.ToInt32(dr["SortOrder"]);
                                                    }
                                                    component.features.Add(createitemsfeatures);

                                                    offer._ExportOfferWell_InsertionLst.Add(component);

                                                    if (component.Discount != 0)
                                                    {
                                                        if (offer._ExportOfferWell_InsertionLst == null)
                                                            offer._ExportOfferWell_InsertionLst = new List<ExportOfferComponent>();
                                                        ExportOfferComponent component1 = new ExportOfferComponent();
                                                        if (dr["Description"] != DBNull.Value)
                                                        {
                                                            component1.Name = "Discount";
                                                        }
                                                        if (dr["UnitPrice"] != DBNull.Value)
                                                        {
                                                            if (component.UnitPrice == 0 && component.Discount == 100)
                                                            {
                                                                component1.UnitPrice = 0;
                                                            }
                                                            else
                                                            {
                                                                double discount = Math.Round(((component.UnitPrice * component.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                                component1.UnitPrice = Math.Round((discount * component.Qty), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                        }
                                                        if (dr["Quantity"] != DBNull.Value)
                                                        {
                                                            component1.Qty = -1;
                                                        }
                                                        if (dr["Discount"] != DBNull.Value)
                                                        {
                                                            string discount = dr["Discount"].ToString();
                                                            component1.Discount = Convert.ToDouble(discount);
                                                        }
                                                        offer._ExportOfferWell_InsertionLst.Add(component1);
                                                    }
                                                }
                                            }
                                            #endregion
                                        }
                                        #endregion
                                        else
                                        {
                                            #region Material                                          
                                            if (offer._ExportOfferQuotationsLst == null)
                                                offer._ExportOfferQuotationsLst = new List<ExportOfferQuotation>();

                                            ExportOfferQuotation exportOfferQuotation = new ExportOfferQuotation();
                                            if (dr["NumItem"] != DBNull.Value)
                                            {
                                                exportOfferQuotation.Item = Convert.ToString(dr["NumItem"]);
                                            }
                                            if (dr["Reference"] != DBNull.Value)
                                            {
                                                exportOfferQuotation.Reference = Convert.ToString(dr["Reference"]);
                                            }
                                            if (dr["Description"] != DBNull.Value)
                                            {
                                                exportOfferQuotation.Description = Convert.ToString(dr["Description"]);
                                            }
                                            //if (dr["UnitPrice"] != DBNull.Value)
                                            //{
                                            //    exportOfferQuotation.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                            //}
                                            if (dr["Quantity"] != DBNull.Value)
                                            {
                                                exportOfferQuotation.Qty = Convert.ToInt64(dr["Quantity"]);
                                            }
                                            if (dr["TotalPrice"] != DBNull.Value)
                                            {
                                                exportOfferQuotation.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                            }
                                            if (dr["CustomerComment"] != DBNull.Value)
                                            {
                                                exportOfferQuotation.Comments = Convert.ToString(dr["CustomerComment"]);
                                            }
                                            if (dr["Discount"] != DBNull.Value)
                                            {
                                                //exportOfferQuotation.Discount = Convert.ToDouble(dr["Discount"]);
                                                string discount = dr["Discount"].ToString();
                                                exportOfferQuotation.Discount = Convert.ToDouble(discount);
                                            }
                                            if (dr["UnitPrice"] != DBNull.Value)
                                            {
                                                if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["Discount"]) == 100)
                                                {
                                                    exportOfferQuotation.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                }
                                                else
                                                {
                                                    exportOfferQuotation.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                    double temp = Convert.ToDouble(1 - (exportOfferQuotation.Discount / 100));
                                                    exportOfferQuotation.UnitPrice = Math.Round((exportOfferQuotation.UnitPrice / temp), 2);

                                                }
                                                //double discountapply = Math.Round(Convert.ToDouble(100 - exportOfferQuotation.Discount), 2, MidpointRounding.AwayFromZero);
                                                //double discountapplyUnitPrice = Math.Round(Convert.ToDouble(exportOfferQuotation.UnitPrice * 100), 2, MidpointRounding.AwayFromZero);
                                                //// double originalsale_unit_price
                                                //exportOfferQuotation.UnitPrice = Math.Round((discountapplyUnitPrice / discountapply), 2, MidpointRounding.AwayFromZero);
                                            }
                                            offer._ExportOfferQuotationsLst.Add(exportOfferQuotation);
                                            if (exportOfferQuotation.Discount != 0)
                                            {
                                                if (offer._ExportOfferQuotationsLst == null)
                                                    offer._ExportOfferQuotationsLst = new List<ExportOfferQuotation>();
                                                //    Material_ItemsStartRow = Material_ItemsStartRow + 1;
                                                //    wsDlQuotation.Cells[Material_ItemDescriptionColumn + Material_ItemsStartRow].Value = (Index_lblDiscount +" :" + item.Discount +"%");
                                                //    wsDlQuotation.Cells[Material_ItemUnitPriceColumn + Material_ItemsStartRow].Value = -((item.UnitPrice * item.Discount) / 100);
                                                //    wsDlQuotation.Cells[Material_ItemQuantityColumn + Material_ItemsStartRow].Value = 1;
                                                ExportOfferQuotation exportOfferQuotation1 = new ExportOfferQuotation();
                                                if (dr["Description"] != DBNull.Value)
                                                {
                                                    exportOfferQuotation1.Description = "Discount";
                                                }
                                                if (dr["UnitPrice"] != DBNull.Value)
                                                {
                                                    // exportOfferQuotation1.UnitPrice = -((exportOfferQuotation.UnitPrice * exportOfferQuotation.Discount) / 100);
                                                    if (exportOfferQuotation.UnitPrice == 0 && exportOfferQuotation.Discount == 100)
                                                    {
                                                        exportOfferQuotation1.UnitPrice = 0;
                                                    }
                                                    else
                                                    {
                                                        double discount = Math.Round(((exportOfferQuotation.UnitPrice * exportOfferQuotation.Discount) / 100), 2, MidpointRounding.AwayFromZero);
                                                        exportOfferQuotation1.UnitPrice = Math.Round((discount * exportOfferQuotation.Qty), 2, MidpointRounding.AwayFromZero);
                                                    }

                                                }
                                                if (dr["Quantity"] != DBNull.Value)
                                                {
                                                    exportOfferQuotation1.Qty = -1;
                                                }
                                                if (dr["Discount"] != DBNull.Value)
                                                {
                                                    //exportOfferQuotation1.Discount = Convert.ToDouble(dr["Discount"]);
                                                    string discount = dr["Discount"].ToString();
                                                    exportOfferQuotation1.Discount = Convert.ToDouble(discount);
                                                }
                                                offer._ExportOfferQuotationsLst.Add(exportOfferQuotation1);
                                            }
                                            #endregion
                                        }
                                    }
                                }
                                #region oldQuotations

                                //while (dr.Read())
                                //{
                                //    if (offer._ExportOfferQuotationsLst == null)
                                //        offer._ExportOfferQuotationsLst = new List<ExportOfferQuotation>();

                                //    ExportOfferQuotation exportOfferQuotation = new ExportOfferQuotation();
                                //    if (dr["Reference"] != DBNull.Value)
                                //    {
                                //        exportOfferQuotation.Reference = Convert.ToString(dr["Reference"]);
                                //    }
                                //    if (dr["Description"] != DBNull.Value)
                                //    {
                                //        exportOfferQuotation.Description = Convert.ToString(dr["Description"]);
                                //    }
                                //    if (dr["UnitPrice"] != DBNull.Value)
                                //    {
                                //        exportOfferQuotation.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                //    }
                                //    if (dr["Quantity"] != DBNull.Value)
                                //    {
                                //        exportOfferQuotation.Qty = Convert.ToInt64(dr["Quantity"]);
                                //    }
                                //    if (dr["TotalPrice"] != DBNull.Value)
                                //    {
                                //        exportOfferQuotation.TotalPrice = Convert.ToDouble(dr["TotalPrice"]);
                                //    }
                                //    //if (offer._ExportOfferInvoiceLst == null)
                                //    //    offer._ExportOfferInvoiceLst = new List<ExportOfferQuotation>();

                                //    //offer._ExportOfferInvoiceLst.Add(exportOfferQuotation);
                                //    //if (offer._ExportOfferTechnicalAssistanceLst == null)
                                //    //    offer._ExportOfferTechnicalAssistanceLst = new List<ExportOfferQuotation>();

                                //    //offer._ExportOfferTechnicalAssistanceLst.Add(exportOfferQuotation);
                                //    offer._ExportOfferQuotationsLst.Add(exportOfferQuotation);
                                //}
                                #endregion
                            }
                            #endregion
                        }
                    }
                    Log4NetLogger.Logger.Log(string.Format("Method ExportOffer()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                }
                catch (Exception ex)
                {

                    Log4NetLogger.Logger.Log(string.Format("Error ExportOffer(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw ex;

                }
                Log4NetLogger.Logger.Log(string.Format("Method ExportOffer() workbook"), category: Category.Info, priority: Priority.Low);
                Workbook workbook = new Workbook();
                #region CultureInfo
                if (!Lang.ToLower().Equals("en"))
                {
                    if (getLanguage != null)
                    {
                        CultureInfo myCIintl = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName, true);
                        workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName);
                    }
                    else
                    {
                        CultureInfo myCIintl = new CultureInfo("en-GB", true);
                        workbook.Options.Culture = new CultureInfo("en-GB");
                    }
                }
                else
                {
                    #region CultureInfo
                    List<CultureInfo> culture = CultureInfo.GetCultures(CultureTypes.AllCultures).Where<CultureInfo>(c => c.Name.EndsWith(CultureByPlantOwner)).ToList();
                    if (culture != null && culture.Count > 0)
                    {
                        workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(CultureByPlantOwner) ? "en-GB" : CultureByPlantOwner);
                    }
                    else
                    {
                        //string plantName = CultureByPlantOwner.Substring(3, 2);
                        string plantName = cultureByPlantOwnerAndISO;
                        //string plantName = "IN";
                        List<CultureInfo> ifCultureNotexist = CultureInfo.GetCultures(CultureTypes.AllCultures).Where<CultureInfo>(c => c.Name.EndsWith(plantName)).ToList();
                        Languages setCulture = null;
                        if (ifCultureNotexist.Count() == 1)
                        {
                            setCulture = new Languages();
                            setCulture.CultureName = ifCultureNotexist[0].Name;
                        }
                        else
                        {
                            foreach (var item in ifCultureNotexist)
                            {
                                //setCulture = Languages.Where(s => s.CultureName.Equals(item.Name)).FirstOrDefault();
                                setCulture = Languages.Where(s => s.TwoLetterISOLanguage.Equals(item.Parent.Name)).FirstOrDefault();
                                if (setCulture != null)
                                {
                                    setCulture.CultureName = item.Name;
                                    break;
                                }
                            }
                        }

                        //var setCulture = ifCultureNotexist.Where(s => s.Name.Equals(getLanguage.CultureName)).FirstOrDefault();
                        if (setCulture != null)
                        {
                            CultureInfo myCIintl = new CultureInfo(string.IsNullOrEmpty(setCulture.CultureName) ? "en-GB" : setCulture.CultureName, true);
                            if (myCIintl != null)
                            {
                                workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(setCulture.CultureName) ? "en-GB" : setCulture.CultureName);
                            }

                        }
                        else
                        {
                            if (getLanguage != null)
                            {
                                CultureInfo myCIintl = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName, true);
                                workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName);
                            }
                            else
                            {
                                CultureInfo myCIintl = new CultureInfo("en-GB", true);
                                workbook.Options.Culture = new CultureInfo("en-GB");

                            }

                        }

                    }
                    #endregion
                }
                #endregion
                FileStream stream = null;
                try
                {
                    if (offer != null)
                    {
                        byte[] excelTemplateInByte = GetOfferExportChart(plantOwner, offerExcelPath);
                        if (excelTemplateInByte == null)
                        {
                            throw new FileNotFoundException("File does not exist or File is open - " + offerExcelPath);
                        }
                        //byte[] SaleGeneralConditions = GetOfferSaleGeneralConditionsChart(plantOwner, offerExcelPath);
                        workbook.LoadDocument(excelTemplateInByte, DocumentFormat.Xlsx);
                        //Worksheet wsDl = workbook.Worksheets[2];
                        Worksheet wsDl = workbook.Worksheets[14];
                        string filenameExcel = null;
                        string filenamePDF = null;
                        #region Quotation_Folder
                        //  string plantFileServer = GetGEOSProviderFileServer(plantOwner, loginConnectionString);
                        string quotationFolder = GetGEOSAppSetting("Quotation_Folder", loginConnectionString);

                        string updatedExcelFilePath = offerCommericalPath.Replace("{0}", plantOwner);

                        #region //chitra.girigosavi[APIGEOS-1322][04/03/2025]
                        string offerCommericalNewPath = GetCommercialOffersExportPath("CommercialOffersPath", siteConnectionstring);
                        long IdOffer = long.Parse(idOffer);
                        string FileServerIP = GetFileServerIp(IdOffer, siteConnectionstring);
                        string updatedNewExcelFilePath = offerCommericalNewPath.Replace("{0}", FileServerIP);
                        updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("{1}", plantOwner);
                        #endregion

                        if (plantOwner == "EAES" || plantOwner == "ETHQ")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCM");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCM");
                        }
                        else if (plantOwner == "EIBR")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMB");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMB");
                        }
                        else if (plantOwner == "EARO" || plantOwner == "EBRO" || plantOwner == "ENRU")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMR");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMR");
                        }
                        else if (plantOwner == "ETMA" || plantOwner == "ESMA1" || plantOwner == "ESMA2")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMM");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMM");
                        }
                        else if (plantOwner == "ESCN" || plantOwner == "ETCN")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMCN");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMCN");
                        }
                        else if (plantOwner == "ETTN")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMT");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMT");
                        }
                        else if (plantOwner == "EPIN")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMIN");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMIN");
                        }
                        else if (plantOwner == "EJMX1" || plantOwner == "EJMX2" || plantOwner == "ESMX" || plantOwner == "EAMX")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMX");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMX");
                        }
                        else if (plantOwner == "ESHN")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMH");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMH");
                        }
                        else if (plantOwner == "EEPY")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMPY");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMPY");
                        }
                        else
                        {
                            string updatedPlantOwner = "GCM" + GetAllPlant(plantOwner.Trim());
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", updatedPlantOwner.Trim());
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", updatedPlantOwner.Trim());
                        }

                        //else if (plantOwner == "EAMX")
                        //{
                        //    updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMMX");
                        //}
                        updatedExcelFilePath = updatedExcelFilePath.Replace("{1}", offer._OfferYear);
                        updatedExcelFilePath = updatedExcelFilePath.Replace("{2}", offer._OfferGroupPlant);
                        updatedExcelFilePath = updatedExcelFilePath.Replace("{3}", offer._OfferNumber);
                        updatedExcelFilePath = updatedExcelFilePath.Replace("{4}", quotationFolder);
                        //updatedExcelFilePath = updatedExcelFilePath.Replace("\\10.0.9.7", @"C:\Temp");

                        //chitra.girigosavi[APIGEOS-1322][04/03/2025]
                        updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("{2}", offer._OfferYear);
                        updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("{3}", offer._OfferGroupPlant);
                        updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("{4}", offer._OfferNumber);
                        updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("{5}", quotationFolder);

                        #endregion
                        //chitra.girigosavi[APIGEOS-1322][04/03/2025]
                        if (!System.IO.Directory.Exists(updatedExcelFilePath))
                        {
                            if (!System.IO.Directory.Exists(updatedNewExcelFilePath))
                            {
                                System.IO.Directory.CreateDirectory(updatedNewExcelFilePath);
                            }
                            updatedExcelFilePath = updatedNewExcelFilePath;
                        }

                        string search = @"Offer_" + offer._OfferNumber + "_" + '*' + ".pdf";
                        FileInfo[] files = new DirectoryInfo(updatedExcelFilePath)
                        .GetFiles(search)
                        .OrderBy(f => f.CreationTime)
                        .ToArray();
                        var allfiles = files.ToList();
                        if (offer._RevNumber > 0)
                        {
                            string substring = string.Format("{0:00}", offer._RevNumber);
                            filenameExcel = "Offer_" + offer._OfferNumber + "_" + "rev" + substring + "_" + offer._OfferTitle + "_" + Lang.ToUpper() + ".xlsx";
                            filenamePDF = "Offer_" + offer._OfferNumber + "_" + "rev" + substring + "_" + offer._OfferTitle + "_" + Lang.ToUpper() + ".pdf";
                        }
                        else
                        {
                            #region Old method to create the offer files

                            filenameExcel = "Offer_" + offer._OfferNumber + "_" + offer._OfferTitle + "_" + Lang.ToUpper() + ".xlsx";
                            filenamePDF = "Offer_" + offer._OfferNumber + "_" + offer._OfferTitle + "_" + Lang.ToUpper() + ".pdf";
                            #endregion
                        }
                        // https://helpdesk.emdep.com/browse/APIGEOS-211 [Exchange Rate to Quote Matrix] skadam 20 05 2021
                        //string date = DateTime.Now.ToString("yyyy-MM-dd")
                        //string date = "2021-01-05";
                        //List<Currency_conversions> currencyconversionsList = GetCurrency_conversionsList(Convert.ToDateTime(date), loginConnectionString);
                        List<Currency_conversions> currencyconversionsList = GetCurrency_conversionsList(Convert.ToDateTime(DateTime.Now.ToString("yyyy-MM-dd")), loginConnectionString);
                        #region Fields

                        Int32 _OfferDate = 0;
                        Int32 _OfferTitle = 0;
                        Int32 _OfferNumber = 0;
                        Int32 _OfferRevisionNumber = 0;
                        Int32 _OfferExpiryDate = 0;
                        Int32 _OfferIncoTerms = 0;
                        Int32 _OfferPaymentConditions = 0;
                        Int32 _OfferOwnerGender = 0;
                        Int32 _OfferOwnerFullName = 0;
                        Int32 _OfferOwnerPhone = 0;
                        Int32 _OfferOwnerMobile = 0;
                        Int32 _OfferOwnerEmail = 0;
                        Int32 _OfferOwnerCompanyName = 0;
                        Int32 _OfferOwnerCompanyAlias = 0;
                        Int32 _OfferOwnerCompanyStreet = 0;
                        Int32 _OfferOwnerCompanyZipCode = 0;
                        Int32 _OfferOwnerCompanyCity = 0;
                        Int32 _OfferOwnerCompanyState = 0;
                        Int32 _OfferOwnerCompanyCountry = 0;
                        Int32 _OfferContactGender = 0;
                        Int32 _OfferContactFullName = 0;
                        Int32 _OfferContactPhone = 0;
                        Int32 _OfferContactEmail = 0;
                        Int32 _OfferContactCompanyName = 0;
                        Int32 _OfferContactCompanyStreet = 0;
                        Int32 _OfferContactCompanyZipCode = 0;
                        Int32 _OfferContactCompanyCity = 0;
                        Int32 _OfferContactCompanyState = 0;
                        Int32 _OfferContactCompanyCountry = 0;
                        Int32 _OfferComments = 0;
                        Int32 _OfferSalesOwnerFullName = 0;
                        Int32 _OfferSalesOwnerEmail = 0;
                        Int32 _OfferIndex_Item1 = 0;

                        // int rowQuotation = 5;
                        Int32 Material_count = 0;
                        Int32 Material_ItemsStartRow = 0;
                        //Int32 Material_ItemsHeadingStartRow ;
                        string Material_ItemItemColumn = "";
                        string Material_ItemReferenceColumn = "";
                        string Material_ItemDescriptionColumn = "";
                        string Material_ItemUnitPriceColumn = "";
                        string Material_ItemQuantityColumn = "";
                        string Material_ItemTotalPrice = "";
                        //OpportunityManager.ColumnNameToIndex("Material_ItemsStartRow");

                        Int32 Invoice_count = 0;//344
                        Int32 Invoice_ItemsStartRow = 0;
                        string Invoice_ItemItemColumn = "";
                        string Invoice_ItemReferenceColumn = "";//345
                        string Invoice_ItemDescriptionColumn = "";//346
                        string Invoice_ItemUnitPriceColumn = "";//347
                        string Invoice_ItemQuantityColumn = "";//348
                        string Invoice_ItemTotalPrice = "";

                        Int32 Technical_count = 0;//350
                        Int32 Technical_Assistance_ItemsStartRow = 0;
                        string Technical_Assistance_ItemItemColumn = "";
                        //Int32 Technical_Assistance_ItemsHeadingStartRow = Convert.ToInt32(count) - 1;
                        string Technical_Assistance_ItemReferenceColumn = "";//351
                        string Technical_Assistance_ItemDescriptionColumn = "";//352
                        string Technical_Assistance_ItemUnitPriceColumn = "";//353
                        string Technical_Assistance_ItemQuantityColumn = "";//354
                        string Technical_Assistance_ItemTotalPrice = "";

                        Int32 Component_count = 0;//356
                        Int32 Component_ItemsStartRow = 0;
                        string Component_ItemItemColumn = "";
                        //Int32 Component_ItemsHeadingStartRow = Convert.ToInt32(count) - 1;
                        string Component_ItemReferenceColumn = "";//357
                        string Component_ItemNameColumn = "";//358
                        string Component_DetStartColumn = "";//359
                        string Component_DetEndColumn = "";//360
                        string Component_ItemRemarksColumn = "";
                        string Component_ItemUnitPriceColumn = "";//361
                        string Component_ItemQuantityColumn = "";//362
                        string Component_ItemTotalPrice = "";

                        Int32 Index_OfferCurrency = 0;
                        Int32 Index_OfferRfqNumber = 0;
                        Int32 Index_RfqDate = 0;
                        Int32 Index_OfferBusinessUnit = 0;
                        Int32 Index_OfferProject = 0;
                        Int32 Index_OfferCarOEM = 0;
                        Int32 Index_OfferCategory1 = 0;
                        Int32 Index_OfferCategory2 = 0;

                        #region APIGEOS-1132 Add support for creating offers including modules in ECOS(3 / 3)
                        Int32 Module_count = 0;//356
                        Int32 Module_ItemsStartRow = 0;
                        string Module_ItemItemColumn = "";
                        string Module_ItemReferenceColumn = "";//357
                        string Module_ItemNameColumn = "";//358
                        string Module_ItemDetStartColumn = "";//359
                        string Module_ItemUnitPriceColumn = "";//361
                        string Module_ItemQuantityColumn = "";//362
                        string Module_ItemTotalPrice = "";
                        string Module_ItemCommentsColumn = "";
                        #endregion
                        //Int32 Index_OfferShippingAddress = 0;
                        Int32 Language = 0;

                        Int32 _OfferShippingAddressName = 0;
                        Int32 _Index_OfferContactCompanyGroup = 0;
                        Int32 _Index_OfferContactCompanySite = 0;
                        Int32 _OfferShippingAddressFiscalNumber = 0;
                        Int32 _OfferShippingAddressStreet = 0;
                        Int32 _OfferShippingAddressZipCode = 0;
                        Int32 _OfferShippingAddressCity = 0;
                        Int32 _OfferShippingAddressState = 0;
                        Int32 _OfferShippingAddressCountry = 0;
                        Int32 _OfferShippingAddressPhone = 0;
                        Int32 _OfferSource = 0;   //chitra.girigosavi[APIGEOS-1276][18/11/2024]


                        // https://helpdesk.emdep.com/browse/APIGEOS-211 [Exchange Rate to Quote Matrix] skadam 20 05 2021 
                        Int32 _Index_CurrentExchangeRate_EUREUR = 0;
                        Int32 _Index_CurrentExchangeRate_EURRON = 0;
                        Int32 _Index_CurrentExchangeRate_EURUSD = 0;
                        Int32 _Index_CurrentExchangeRate_EURMXN = 0;
                        Int32 _Index_CurrentExchangeRate_EURCNY = 0;
                        Int32 _Index_CurrentExchangeRate_EURHNL = 0;
                        Int32 _Index_CurrentExchangeRate_EURBRL = 0;
                        Int32 _Index_CurrentExchangeRate_EURTND = 0;
                        Int32 _Index_CurrentExchangeRate_EURMAD = 0;
                        Int32 _Index_CurrentExchangeRate_EURPYG = 0;
                        Int32 _Index_CurrentExchangeRate_EURRUB = 0;
                        Int32 _Index_CurrentExchangeRate_EURINR = 0;
                        Int32 _Index_CurrentExchangeRate_RONRON = 0;
                        Int32 _Index_CurrentExchangeRate_RONEUR = 0;
                        Int32 _Index_CurrentExchangeRate_RONUSD = 0;
                        Int32 _Index_CurrentExchangeRate_RONMXN = 0;
                        Int32 _Index_CurrentExchangeRate_RONCNY = 0;
                        Int32 _Index_CurrentExchangeRate_RONHNL = 0;
                        Int32 _Index_CurrentExchangeRate_RONBRL = 0;
                        Int32 _Index_CurrentExchangeRate_RONTND = 0;
                        Int32 _Index_CurrentExchangeRate_RONMAD = 0;
                        Int32 _Index_CurrentExchangeRate_RONPYG = 0;
                        Int32 _Index_CurrentExchangeRate_RONRUB = 0;
                        Int32 _Index_CurrentExchangeRate_RONINR = 0;
                        Int32 _Index_CurrentExchangeRate_USDUSD = 0;
                        Int32 _Index_CurrentExchangeRate_USDEUR = 0;
                        Int32 _Index_CurrentExchangeRate_USDRON = 0;
                        Int32 _Index_CurrentExchangeRate_USDMXN = 0;
                        Int32 _Index_CurrentExchangeRate_USDCNY = 0;
                        Int32 _Index_CurrentExchangeRate_USDHNL = 0;
                        Int32 _Index_CurrentExchangeRate_USDBRL = 0;
                        Int32 _Index_CurrentExchangeRate_USDTND = 0;
                        Int32 _Index_CurrentExchangeRate_USDMAD = 0;
                        Int32 _Index_CurrentExchangeRate_USDPYG = 0;
                        Int32 _Index_CurrentExchangeRate_USDRUB = 0;
                        Int32 _Index_CurrentExchangeRate_USDINR = 0;
                        Int32 _Index_CurrentExchangeRate_MXNMXN = 0;
                        Int32 _Index_CurrentExchangeRate_MXNEUR = 0;
                        Int32 _Index_CurrentExchangeRate_MXNRON = 0;
                        Int32 _Index_CurrentExchangeRate_MXNUSD = 0;
                        Int32 _Index_CurrentExchangeRate_MXNCNY = 0;
                        Int32 _Index_CurrentExchangeRate_MXNHNL = 0;
                        Int32 _Index_CurrentExchangeRate_MXNBRL = 0;
                        Int32 _Index_CurrentExchangeRate_MXNTND = 0;
                        Int32 _Index_CurrentExchangeRate_MXNMAD = 0;
                        Int32 _Index_CurrentExchangeRate_MXNPYG = 0;
                        Int32 _Index_CurrentExchangeRate_MXNRUB = 0;
                        Int32 _Index_CurrentExchangeRate_MXNINR = 0;
                        Int32 _Index_CurrentExchangeRate_CNYCNY = 0;
                        Int32 _Index_CurrentExchangeRate_CNYEUR = 0;
                        Int32 _Index_CurrentExchangeRate_CNYRON = 0;
                        Int32 _Index_CurrentExchangeRate_CNYUSD = 0;
                        Int32 _Index_CurrentExchangeRate_CNYMXN = 0;
                        Int32 _Index_CurrentExchangeRate_CNYHNL = 0;
                        Int32 _Index_CurrentExchangeRate_CNYBRL = 0;
                        Int32 _Index_CurrentExchangeRate_CNYTND = 0;
                        Int32 _Index_CurrentExchangeRate_CNYMAD = 0;
                        Int32 _Index_CurrentExchangeRate_CNYPYG = 0;
                        Int32 _Index_CurrentExchangeRate_CNYRUB = 0;
                        Int32 _Index_CurrentExchangeRate_CNYINR = 0;
                        Int32 _Index_CurrentExchangeRate_HNLHNL = 0;
                        Int32 _Index_CurrentExchangeRate_HNLEUR = 0;
                        Int32 _Index_CurrentExchangeRate_HNLRON = 0;
                        Int32 _Index_CurrentExchangeRate_HNLUSD = 0;
                        Int32 _Index_CurrentExchangeRate_HNLMXN = 0;
                        Int32 _Index_CurrentExchangeRate_HNLCNY = 0;
                        Int32 _Index_CurrentExchangeRate_HNLBRL = 0;
                        Int32 _Index_CurrentExchangeRate_HNLTND = 0;
                        Int32 _Index_CurrentExchangeRate_HNLMAD = 0;
                        Int32 _Index_CurrentExchangeRate_HNLPYG = 0;
                        Int32 _Index_CurrentExchangeRate_HNLRUB = 0;
                        Int32 _Index_CurrentExchangeRate_HNLINR = 0;
                        Int32 _Index_CurrentExchangeRate_BRLBRL = 0;
                        Int32 _Index_CurrentExchangeRate_BRLEUR = 0;
                        Int32 _Index_CurrentExchangeRate_BRLRON = 0;
                        Int32 _Index_CurrentExchangeRate_BRLUSD = 0;
                        Int32 _Index_CurrentExchangeRate_BRLMXN = 0;
                        Int32 _Index_CurrentExchangeRate_BRLCNY = 0;
                        Int32 _Index_CurrentExchangeRate_BRLHNL = 0;
                        Int32 _Index_CurrentExchangeRate_BRLTND = 0;
                        Int32 _Index_CurrentExchangeRate_BRLMAD = 0;
                        Int32 _Index_CurrentExchangeRate_BRLPYG = 0;
                        Int32 _Index_CurrentExchangeRate_BRLRUB = 0;
                        Int32 _Index_CurrentExchangeRate_BRLINR = 0;
                        Int32 _Index_CurrentExchangeRate_TNDTND = 0;
                        Int32 _Index_CurrentExchangeRate_TNDEUR = 0;
                        Int32 _Index_CurrentExchangeRate_TNDRON = 0;
                        Int32 _Index_CurrentExchangeRate_TNDUSD = 0;
                        Int32 _Index_CurrentExchangeRate_TNDMXN = 0;
                        Int32 _Index_CurrentExchangeRate_TNDCNY = 0;
                        Int32 _Index_CurrentExchangeRate_TNDHNL = 0;
                        Int32 _Index_CurrentExchangeRate_TNDBRL = 0;
                        Int32 _Index_CurrentExchangeRate_TNDMAD = 0;
                        Int32 _Index_CurrentExchangeRate_TNDPYG = 0;
                        Int32 _Index_CurrentExchangeRate_TNDRUB = 0;
                        Int32 _Index_CurrentExchangeRate_TNDINR = 0;
                        Int32 _Index_CurrentExchangeRate_MADMAD = 0;
                        Int32 _Index_CurrentExchangeRate_MADEUR = 0;
                        Int32 _Index_CurrentExchangeRate_MADRON = 0;
                        Int32 _Index_CurrentExchangeRate_MADUSD = 0;
                        Int32 _Index_CurrentExchangeRate_MADMXN = 0;
                        Int32 _Index_CurrentExchangeRate_MADCNY = 0;
                        Int32 _Index_CurrentExchangeRate_MADHNL = 0;
                        Int32 _Index_CurrentExchangeRate_MADBRL = 0;
                        Int32 _Index_CurrentExchangeRate_MADTND = 0;
                        Int32 _Index_CurrentExchangeRate_MADPYG = 0;
                        Int32 _Index_CurrentExchangeRate_MADRUB = 0;
                        Int32 _Index_CurrentExchangeRate_MADINR = 0;
                        Int32 _Index_CurrentExchangeRate_PYGPYG = 0;
                        Int32 _Index_CurrentExchangeRate_PYGEUR = 0;
                        Int32 _Index_CurrentExchangeRate_PYGRON = 0;
                        Int32 _Index_CurrentExchangeRate_PYGUSD = 0;
                        Int32 _Index_CurrentExchangeRate_PYGMXN = 0;
                        Int32 _Index_CurrentExchangeRate_PYGCNY = 0;
                        Int32 _Index_CurrentExchangeRate_PYGHNL = 0;
                        Int32 _Index_CurrentExchangeRate_PYGBRL = 0;
                        Int32 _Index_CurrentExchangeRate_PYGTND = 0;
                        Int32 _Index_CurrentExchangeRate_PYGMAD = 0;
                        Int32 _Index_CurrentExchangeRate_PYGRUB = 0;
                        Int32 _Index_CurrentExchangeRate_PYGINR = 0;
                        Int32 _Index_CurrentExchangeRate_RUBRUB = 0;
                        Int32 _Index_CurrentExchangeRate_RUBEUR = 0;
                        Int32 _Index_CurrentExchangeRate_RUBRON = 0;
                        Int32 _Index_CurrentExchangeRate_RUBUSD = 0;
                        Int32 _Index_CurrentExchangeRate_RUBMXN = 0;
                        Int32 _Index_CurrentExchangeRate_RUBCNY = 0;
                        Int32 _Index_CurrentExchangeRate_RUBHNL = 0;
                        Int32 _Index_CurrentExchangeRate_RUBBRL = 0;
                        Int32 _Index_CurrentExchangeRate_RUBTND = 0;
                        Int32 _Index_CurrentExchangeRate_RUBMAD = 0;
                        Int32 _Index_CurrentExchangeRate_RUBPYG = 0;
                        Int32 _Index_CurrentExchangeRate_RUBINR = 0;
                        Int32 _Index_CurrentExchangeRate_INRINR = 0;
                        Int32 _Index_CurrentExchangeRate_INREUR = 0;
                        Int32 _Index_CurrentExchangeRate_INRRON = 0;
                        Int32 _Index_CurrentExchangeRate_INRUSD = 0;
                        Int32 _Index_CurrentExchangeRate_INRMXN = 0;
                        Int32 _Index_CurrentExchangeRate_INRCNY = 0;
                        Int32 _Index_CurrentExchangeRate_INRHNL = 0;
                        Int32 _Index_CurrentExchangeRate_INRBRL = 0;
                        Int32 _Index_CurrentExchangeRate_INRTND = 0;
                        Int32 _Index_CurrentExchangeRate_INRMAD = 0;
                        Int32 _Index_CurrentExchangeRate_INRPYG = 0;
                        Int32 _Index_CurrentExchangeRate_INRRUB = 0;

                        Int32 _Index_LastMonthExchangeRate_EUREUR = 0;
                        Int32 _Index_LastMonthExchangeRate_EURRON = 0;
                        Int32 _Index_LastMonthExchangeRate_EURUSD = 0;
                        Int32 _Index_LastMonthExchangeRate_EURMXN = 0;
                        Int32 _Index_LastMonthExchangeRate_EURCNY = 0;
                        Int32 _Index_LastMonthExchangeRate_EURHNL = 0;
                        Int32 _Index_LastMonthExchangeRate_EURBRL = 0;
                        Int32 _Index_LastMonthExchangeRate_EURTND = 0;
                        Int32 _Index_LastMonthExchangeRate_EURMAD = 0;
                        Int32 _Index_LastMonthExchangeRate_EURPYG = 0;
                        Int32 _Index_LastMonthExchangeRate_EURRUB = 0;
                        Int32 _Index_LastMonthExchangeRate_EURINR = 0;
                        Int32 _Index_LastMonthExchangeRate_RONRON = 0;
                        Int32 _Index_LastMonthExchangeRate_RONEUR = 0;
                        Int32 _Index_LastMonthExchangeRate_RONUSD = 0;
                        Int32 _Index_LastMonthExchangeRate_RONMXN = 0;
                        Int32 _Index_LastMonthExchangeRate_RONCNY = 0;
                        Int32 _Index_LastMonthExchangeRate_RONHNL = 0;
                        Int32 _Index_LastMonthExchangeRate_RONBRL = 0;
                        Int32 _Index_LastMonthExchangeRate_RONTND = 0;
                        Int32 _Index_LastMonthExchangeRate_RONMAD = 0;
                        Int32 _Index_LastMonthExchangeRate_RONPYG = 0;
                        Int32 _Index_LastMonthExchangeRate_RONRUB = 0;
                        Int32 _Index_LastMonthExchangeRate_RONINR = 0;
                        Int32 _Index_LastMonthExchangeRate_USDUSD = 0;
                        Int32 _Index_LastMonthExchangeRate_USDEUR = 0;
                        Int32 _Index_LastMonthExchangeRate_USDRON = 0;
                        Int32 _Index_LastMonthExchangeRate_USDMXN = 0;
                        Int32 _Index_LastMonthExchangeRate_USDCNY = 0;
                        Int32 _Index_LastMonthExchangeRate_USDHNL = 0;
                        Int32 _Index_LastMonthExchangeRate_USDBRL = 0;
                        Int32 _Index_LastMonthExchangeRate_USDTND = 0;
                        Int32 _Index_LastMonthExchangeRate_USDMAD = 0;
                        Int32 _Index_LastMonthExchangeRate_USDPYG = 0;
                        Int32 _Index_LastMonthExchangeRate_USDRUB = 0;
                        Int32 _Index_LastMonthExchangeRate_USDINR = 0;
                        Int32 _Index_LastMonthExchangeRate_MXNMXN = 0;
                        Int32 _Index_LastMonthExchangeRate_MXNEUR = 0;
                        Int32 _Index_LastMonthExchangeRate_MXNRON = 0;
                        Int32 _Index_LastMonthExchangeRate_MXNUSD = 0;
                        Int32 _Index_LastMonthExchangeRate_MXNCNY = 0;
                        Int32 _Index_LastMonthExchangeRate_MXNHNL = 0;
                        Int32 _Index_LastMonthExchangeRate_MXNBRL = 0;
                        Int32 _Index_LastMonthExchangeRate_MXNTND = 0;
                        Int32 _Index_LastMonthExchangeRate_MXNMAD = 0;
                        Int32 _Index_LastMonthExchangeRate_MXNPYG = 0;
                        Int32 _Index_LastMonthExchangeRate_MXNRUB = 0;
                        Int32 _Index_LastMonthExchangeRate_MXNINR = 0;
                        Int32 _Index_LastMonthExchangeRate_CNYCNY = 0;
                        Int32 _Index_LastMonthExchangeRate_CNYEUR = 0;
                        Int32 _Index_LastMonthExchangeRate_CNYRON = 0;
                        Int32 _Index_LastMonthExchangeRate_CNYUSD = 0;
                        Int32 _Index_LastMonthExchangeRate_CNYMXN = 0;
                        Int32 _Index_LastMonthExchangeRate_CNYHNL = 0;
                        Int32 _Index_LastMonthExchangeRate_CNYBRL = 0;
                        Int32 _Index_LastMonthExchangeRate_CNYTND = 0;
                        Int32 _Index_LastMonthExchangeRate_CNYMAD = 0;
                        Int32 _Index_LastMonthExchangeRate_CNYPYG = 0;
                        Int32 _Index_LastMonthExchangeRate_CNYRUB = 0;
                        Int32 _Index_LastMonthExchangeRate_CNYINR = 0;
                        Int32 _Index_LastMonthExchangeRate_HNLHNL = 0;
                        Int32 _Index_LastMonthExchangeRate_HNLEUR = 0;
                        Int32 _Index_LastMonthExchangeRate_HNLRON = 0;
                        Int32 _Index_LastMonthExchangeRate_HNLUSD = 0;
                        Int32 _Index_LastMonthExchangeRate_HNLMXN = 0;
                        Int32 _Index_LastMonthExchangeRate_HNLCNY = 0;
                        Int32 _Index_LastMonthExchangeRate_HNLBRL = 0;
                        Int32 _Index_LastMonthExchangeRate_HNLTND = 0;
                        Int32 _Index_LastMonthExchangeRate_HNLMAD = 0;
                        Int32 _Index_LastMonthExchangeRate_HNLPYG = 0;
                        Int32 _Index_LastMonthExchangeRate_HNLRUB = 0;
                        Int32 _Index_LastMonthExchangeRate_HNLINR = 0;
                        Int32 _Index_LastMonthExchangeRate_BRLBRL = 0;
                        Int32 _Index_LastMonthExchangeRate_BRLEUR = 0;
                        Int32 _Index_LastMonthExchangeRate_BRLRON = 0;
                        Int32 _Index_LastMonthExchangeRate_BRLUSD = 0;
                        Int32 _Index_LastMonthExchangeRate_BRLMXN = 0;
                        Int32 _Index_LastMonthExchangeRate_BRLCNY = 0;
                        Int32 _Index_LastMonthExchangeRate_BRLHNL = 0;
                        Int32 _Index_LastMonthExchangeRate_BRLTND = 0;
                        Int32 _Index_LastMonthExchangeRate_BRLMAD = 0;
                        Int32 _Index_LastMonthExchangeRate_BRLPYG = 0;
                        Int32 _Index_LastMonthExchangeRate_BRLRUB = 0;
                        Int32 _Index_LastMonthExchangeRate_BRLINR = 0;
                        Int32 _Index_LastMonthExchangeRate_TNDTND = 0;
                        Int32 _Index_LastMonthExchangeRate_TNDEUR = 0;
                        Int32 _Index_LastMonthExchangeRate_TNDRON = 0;
                        Int32 _Index_LastMonthExchangeRate_TNDUSD = 0;
                        Int32 _Index_LastMonthExchangeRate_TNDMXN = 0;
                        Int32 _Index_LastMonthExchangeRate_TNDCNY = 0;
                        Int32 _Index_LastMonthExchangeRate_TNDHNL = 0;
                        Int32 _Index_LastMonthExchangeRate_TNDBRL = 0;
                        Int32 _Index_LastMonthExchangeRate_TNDMAD = 0;
                        Int32 _Index_LastMonthExchangeRate_TNDPYG = 0;
                        Int32 _Index_LastMonthExchangeRate_TNDRUB = 0;
                        Int32 _Index_LastMonthExchangeRate_TNDINR = 0;
                        Int32 _Index_LastMonthExchangeRate_MADMAD = 0;
                        Int32 _Index_LastMonthExchangeRate_MADEUR = 0;
                        Int32 _Index_LastMonthExchangeRate_MADRON = 0;
                        Int32 _Index_LastMonthExchangeRate_MADUSD = 0;
                        Int32 _Index_LastMonthExchangeRate_MADMXN = 0;
                        Int32 _Index_LastMonthExchangeRate_MADCNY = 0;
                        Int32 _Index_LastMonthExchangeRate_MADHNL = 0;
                        Int32 _Index_LastMonthExchangeRate_MADBRL = 0;
                        Int32 _Index_LastMonthExchangeRate_MADTND = 0;
                        Int32 _Index_LastMonthExchangeRate_MADPYG = 0;
                        Int32 _Index_LastMonthExchangeRate_MADRUB = 0;
                        Int32 _Index_LastMonthExchangeRate_MADINR = 0;
                        Int32 _Index_LastMonthExchangeRate_PYGPYG = 0;
                        Int32 _Index_LastMonthExchangeRate_PYGEUR = 0;
                        Int32 _Index_LastMonthExchangeRate_PYGRON = 0;
                        Int32 _Index_LastMonthExchangeRate_PYGUSD = 0;
                        Int32 _Index_LastMonthExchangeRate_PYGMXN = 0;
                        Int32 _Index_LastMonthExchangeRate_PYGCNY = 0;
                        Int32 _Index_LastMonthExchangeRate_PYGHNL = 0;
                        Int32 _Index_LastMonthExchangeRate_PYGBRL = 0;
                        Int32 _Index_LastMonthExchangeRate_PYGTND = 0;
                        Int32 _Index_LastMonthExchangeRate_PYGMAD = 0;
                        Int32 _Index_LastMonthExchangeRate_PYGRUB = 0;
                        Int32 _Index_LastMonthExchangeRate_PYGINR = 0;
                        Int32 _Index_LastMonthExchangeRate_RUBRUB = 0;
                        Int32 _Index_LastMonthExchangeRate_RUBEUR = 0;
                        Int32 _Index_LastMonthExchangeRate_RUBRON = 0;
                        Int32 _Index_LastMonthExchangeRate_RUBUSD = 0;
                        Int32 _Index_LastMonthExchangeRate_RUBMXN = 0;
                        Int32 _Index_LastMonthExchangeRate_RUBCNY = 0;
                        Int32 _Index_LastMonthExchangeRate_RUBHNL = 0;
                        Int32 _Index_LastMonthExchangeRate_RUBBRL = 0;
                        Int32 _Index_LastMonthExchangeRate_RUBTND = 0;
                        Int32 _Index_LastMonthExchangeRate_RUBMAD = 0;
                        Int32 _Index_LastMonthExchangeRate_RUBPYG = 0;
                        Int32 _Index_LastMonthExchangeRate_RUBINR = 0;
                        Int32 _Index_LastMonthExchangeRate_INRINR = 0;
                        Int32 _Index_LastMonthExchangeRate_INREUR = 0;
                        Int32 _Index_LastMonthExchangeRate_INRRON = 0;
                        Int32 _Index_LastMonthExchangeRate_INRUSD = 0;
                        Int32 _Index_LastMonthExchangeRate_INRMXN = 0;
                        Int32 _Index_LastMonthExchangeRate_INRCNY = 0;
                        Int32 _Index_LastMonthExchangeRate_INRHNL = 0;
                        Int32 _Index_LastMonthExchangeRate_INRBRL = 0;
                        Int32 _Index_LastMonthExchangeRate_INRTND = 0;
                        Int32 _Index_LastMonthExchangeRate_INRMAD = 0;
                        Int32 _Index_LastMonthExchangeRate_INRPYG = 0;
                        Int32 _Index_LastMonthExchangeRate_INRRUB = 0;
                        #endregion
                        //https://helpdesk.emdep.com/browse/APIGEOS-258
                        Int32 _OfferDiscount = 0;
                        //string lbl= "Index_lblDiscount_"+Lang.ToLower();
                        Worksheet wsTranslations = workbook.Worksheets[15];

                        #region Index

                        string Index_lblDiscount = "";
                        string Material_lblColItem = "";
                        string Material_lblColReference = "";
                        string Material_lblColDescription = "";
                        string Material_lblColUnitPrice = "";
                        string Material_lblColQuantity = "";
                        string Material_lblColTotalPrice = "";
                        string Material_lblSubtotal = "";
                        string Material_lblTotalQuantity = "";


                        string Invoice_lblColItem = "";
                        string Invoice_lblColReference = "";
                        string Invoice_lblColDescription = "";
                        string Invoice_lblColUnitPrice = "";
                        string Invoice_lblColQuantity = "";
                        string Invoice_lblColTotalPrice = "";
                        string Invoice_lblSubtotal = "";
                        string Invoice_lblTotalQuantity = "";

                        string Technical_Assistance_lblColItem = "";
                        string Technical_Assistance_lblColReference = "";
                        string Technical_Assistance_lblColDescription = "";
                        string Technical_Assistance_lblColUnitPrice = "";
                        string Technical_Assistance_lblColQuantity = "";
                        string Technical_Assistance_lblColTotalPrice = "";
                        string Technical_Assistance_lblSubtotal = "";
                        string Technical_Assistance_lblTotalQuantity = "";

                        string Component_lblColItem = "";
                        string Component_lblColReference = "";
                        string Component_lblColName = "";
                        string Component_lblColUnitPrice = "";
                        string Component_lblColQuantity = "";
                        string Component_lblColTotalPrice = "";
                        string Component_lblSubtotal = "";
                        string Component_lblTotalQuantity = "";
                        string Component_Comments = "";

                        #region APIGEOS-1132 Add support for creating offers including modules in ECOS(3 / 3)
                        string Module_lblColItem = "";
                        string Module_lblColReference = "";
                        string Module_lblColName = "";
                        string Module_lblColUnitPrice = "";
                        string Module_lblColQuantity = "";
                        string Module_lblColTotalPrice = "";
                        string Module_lblSubtotal = "";
                        string Module_lblTotalQuantity = "";
                        string Module_lblColRemarks = "";
                        #endregion

                        #region chitra.girigosavi APIGEOS-1171 Changes when generating the offer for Counterpart type items
                        string Pneumatic_lblColItem = "";
                        string Pneumatic_lblColReference = "";
                        string Pneumatic_lblColName = "";
                        string Pneumatic_lblColUnitPrice = "";
                        string Pneumatic_lblColQuantity = "";
                        string Pneumatic_lblColTotalPrice = "";
                        string Pneumatic_lblSubtotal = "";
                        string Pneumatic_lblTotalQuantity = "";
                        string Pneumatic_lblColRemarks = "";

                        string Assembly_lblColItem = "";
                        string Assembly_lblColReference = "";
                        string Assembly_lblColName = "";
                        string Assembly_lblColUnitPrice = "";
                        string Assembly_lblColQuantity = "";
                        string Assembly_lblColTotalPrice = "";
                        string Assembly_lblSubtotal = "";
                        string Assembly_lblTotalQuantity = "";
                        string Assembly_lblColRemarks = "";

                        string ElectricControl_lblColItem = "";
                        string ElectricControl_lblColReference = "";
                        string ElectricControl_lblColName = "";
                        string ElectricControl_lblColUnitPrice = "";
                        string ElectricControl_lblColQuantity = "";
                        string ElectricControl_lblColTotalPrice = "";
                        string ElectricControl_lblSubtotal = "";
                        string ElectricControl_lblTotalQuantity = "";
                        string ElectricControl_lblColRemarks = "";

                        string Hybrid_lblColItem = "";
                        string Hybrid_lblColReference = "";
                        string Hybrid_lblColName = "";
                        string Hybrid_lblColUnitPrice = "";
                        string Hybrid_lblColQuantity = "";
                        string Hybrid_lblColTotalPrice = "";
                        string Hybrid_lblSubtotal = "";
                        string Hybrid_lblTotalQuantity = "";
                        string Hybrid_lblColRemarks = "";

                        string Japanese_lblColItem = "";
                        string Japanese_lblColReference = "";
                        string Japanese_lblColName = "";
                        string Japanese_lblColUnitPrice = "";
                        string Japanese_lblColQuantity = "";
                        string Japanese_lblColTotalPrice = "";
                        string Japanese_lblSubtotal = "";
                        string Japanese_lblTotalQuantity = "";
                        string Japanese_lblColRemarks = "";

                        string Pull_lblColItem = "";
                        string Pull_lblColReference = "";
                        string Pull_lblColName = "";
                        string Pull_lblColUnitPrice = "";
                        string Pull_lblColQuantity = "";
                        string Pull_lblColTotalPrice = "";
                        string Pull_lblSubtotal = "";
                        string Pull_lblTotalQuantity = "";
                        string Pull_lblColRemarks = "";

                        string Vision_lblColItem = "";
                        string Vision_lblColReference = "";
                        string Vision_lblColName = "";
                        string Vision_lblColUnitPrice = "";
                        string Vision_lblColQuantity = "";
                        string Vision_lblColTotalPrice = "";
                        string Vision_lblSubtotal = "";
                        string Vision_lblTotalQuantity = "";
                        string Vision_lblColRemarks = "";

                        string Wireless_lblColItem = "";
                        string Wireless_lblColReference = "";
                        string Wireless_lblColName = "";
                        string Wireless_lblColUnitPrice = "";
                        string Wireless_lblColQuantity = "";
                        string Wireless_lblColTotalPrice = "";
                        string Wireless_lblSubtotal = "";
                        string Wireless_lblTotalQuantity = "";
                        string Wireless_lblColRemarks = "";

                        string WellInsertion_lblColItem = "";
                        string WellInsertion_lblColReference = "";
                        string WellInsertion_lblColName = "";
                        string WellInsertion_lblColUnitPrice = "";
                        string WellInsertion_lblColQuantity = "";
                        string WellInsertion_lblColTotalPrice = "";
                        string WellInsertion_lblSubtotal = "";
                        string WellInsertion_lblTotalQuantity = "";
                        string WellInsertion_lblColRemarks = "";
                        #endregion

                        #endregion
                        #region getIndex

                        for (int s = 0; s < 1550; s++)
                        {
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Index_lblDiscount_" + Lang.ToLower()))
                            {
                                Index_lblDiscount = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }

                            #region Material
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Material_lblColItem_" + Lang.ToLower()))
                            {
                                Material_lblColItem = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Material_lblColReference_" + Lang.ToLower()))
                            {
                                Material_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Material_lblColDescription_" + Lang.ToLower()))
                            {
                                Material_lblColDescription = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Material_lblColUnitPrice_" + Lang.ToLower()))
                            {
                                Material_lblColUnitPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Material_lblColQuantity_" + Lang.ToLower()))
                            {
                                Material_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Material_lblColTotalPrice_" + Lang.ToLower()))
                            {
                                Material_lblColTotalPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Material_lblSubtotal_" + Lang.ToLower()))
                            {
                                Material_lblSubtotal = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Material_lblTotalQuantity_" + Lang.ToLower()))
                            {
                                Material_lblTotalQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            #endregion
                            #region Invoice
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Invoice_lblColItem_" + Lang.ToLower()))
                            {
                                Invoice_lblColItem = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Invoice_lblColReference_" + Lang.ToLower()))
                            {
                                Invoice_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Invoice_lblColDescription_" + Lang.ToLower()))
                            {
                                Invoice_lblColDescription = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Invoice_lblColUnitPrice_" + Lang.ToLower()))
                            {
                                Invoice_lblColUnitPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Invoice_lblColQuantity_" + Lang.ToLower()))
                            {
                                Invoice_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Invoice_lblColTotalPrice_" + Lang.ToLower()))
                            {
                                Invoice_lblColTotalPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Invoice_lblSubtotal_" + Lang.ToLower()))
                            {
                                Invoice_lblSubtotal = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Invoice_lblTotalQuantity_" + Lang.ToLower()))
                            {
                                Invoice_lblTotalQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            #endregion
                            #region Technical Assistance
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Technical Assistance_lblColItem_" + Lang.ToLower()))
                            {
                                Technical_Assistance_lblColItem = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Technical Assistance_lblColReference_" + Lang.ToLower()))
                            {
                                Technical_Assistance_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Technical Assistance_lblColDescription_" + Lang.ToLower()))
                            {
                                Technical_Assistance_lblColDescription = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Technical Assistance_lblColUnitPrice_" + Lang.ToLower()))
                            {
                                Technical_Assistance_lblColUnitPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Technical Assistance_lblColQuantity_" + Lang.ToLower()))
                            {
                                Technical_Assistance_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Technical Assistance_lblColTotalPrice_" + Lang.ToLower()))
                            {
                                Technical_Assistance_lblColTotalPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Technical Assistance_lblSubtotal_" + Lang.ToLower()))
                            {
                                Technical_Assistance_lblSubtotal = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Technical Assistance_lblTotalQuantity_" + Lang.ToLower()))
                            {
                                Technical_Assistance_lblTotalQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            #endregion
                            #region Component
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Component_lblColItem_" + Lang.ToLower()))
                            {
                                Component_lblColItem = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Component_lblColReference_" + Lang.ToLower()))
                            {
                                Component_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Component_lblColName_" + Lang.ToLower()))
                            {
                                Component_lblColName = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Component_lblColUnitPrice_" + Lang.ToLower()))
                            {
                                Component_lblColUnitPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Component_lblColQuantity_" + Lang.ToLower()))
                            {
                                Component_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Component_lblColTotalPrice_" + Lang.ToLower()))
                            {
                                Component_lblColTotalPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Component_lblSubtotal_" + Lang.ToLower()))
                            {
                                Component_lblSubtotal = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Component_lblTotalQuantity_" + Lang.ToLower()))
                            {
                                Component_lblTotalQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Component_lblColRemarks_" + Lang.ToLower()))
                            {
                                Component_Comments = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            #endregion
                            //Module
                            #region APIGEOS-1132 Add support for creating offers including modules in ECOS(3 / 3)
                            //if ((wsTranslations.Cells[s, 0].Value.ToString() == "Module_lblColItem_" + Lang.ToLower()))
                            //{
                            //    Module_lblColItem = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            //}
                            //if ((wsTranslations.Cells[s, 0].Value.ToString() == "Module_lblColReference_" + Lang.ToLower()))
                            //{
                            //    Module_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            //}
                            //if ((wsTranslations.Cells[s, 0].Value.ToString() == "Module_lblColName_" + Lang.ToLower()))
                            //{
                            //    Module_lblColName = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            //}
                            //if ((wsTranslations.Cells[s, 0].Value.ToString() == "Module_lblColUnitPrice_" + Lang.ToLower()))
                            //{
                            //    Module_lblColUnitPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            //}
                            //if ((wsTranslations.Cells[s, 0].Value.ToString() == "Module_lblColQuantity_" + Lang.ToLower()))
                            //{
                            //    Module_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            //}
                            //if ((wsTranslations.Cells[s, 0].Value.ToString() == "Module_lblColTotalPrice_" + Lang.ToLower()))
                            //{
                            //    Module_lblColTotalPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            //}
                            //if ((wsTranslations.Cells[s, 0].Value.ToString() == "Module_lblSubtotal_" + Lang.ToLower()))
                            //{
                            //    Module_lblSubtotal = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            //}
                            //if ((wsTranslations.Cells[s, 0].Value.ToString() == "Module_lblTotalQuantity_" + Lang.ToLower()))
                            //{
                            //    Module_lblTotalQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            //}
                            //if ((wsTranslations.Cells[s, 0].Value.ToString() == "Module_lblColRemarks_" + Lang.ToLower()))
                            //{
                            //    Module_lblColRemarks = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            //}
                            #endregion

                            #region chitra.girigosavi APIGEOS-1171 Changes when generating the offer for Counterpart type items
                            #region Pneumatic
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pneumatic_lblColItem_" + Lang.ToLower()))
                            {
                                Pneumatic_lblColItem = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pneumatic_lblColReference_" + Lang.ToLower()))
                            {
                                Pneumatic_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pneumatic_lblColName_" + Lang.ToLower()))
                            {
                                Pneumatic_lblColName = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pneumatic_lblColUnitPrice_" + Lang.ToLower()))
                            {
                                Pneumatic_lblColUnitPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pneumatic_lblColQuantity_" + Lang.ToLower()))
                            {
                                Pneumatic_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pneumatic_lblColTotalPrice_" + Lang.ToLower()))
                            {
                                Pneumatic_lblColTotalPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pneumatic_lblSubtotal_" + Lang.ToLower()))
                            {
                                Pneumatic_lblSubtotal = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pneumatic_lblTotalQuantity_" + Lang.ToLower()))
                            {
                                Pneumatic_lblTotalQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pneumatic_lblColRemarks_" + Lang.ToLower()))
                            {
                                Pneumatic_lblColRemarks = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            #endregion

                            #region Assembly
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Assembly_lblColItem_" + Lang.ToLower()))
                            {
                                Assembly_lblColItem = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Assembly_lblColReference_" + Lang.ToLower()))
                            {
                                Assembly_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Assembly_lblColName_" + Lang.ToLower()))
                            {
                                Assembly_lblColName = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Assembly_lblColUnitPrice_" + Lang.ToLower()))
                            {
                                Assembly_lblColUnitPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Assembly_lblColQuantity_" + Lang.ToLower()))
                            {
                                Assembly_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Assembly_lblColTotalPrice_" + Lang.ToLower()))
                            {
                                Assembly_lblColTotalPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Assembly_lblSubtotal_" + Lang.ToLower()))
                            {
                                Assembly_lblSubtotal = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Assembly_lblTotalQuantity_" + Lang.ToLower()))
                            {
                                Assembly_lblTotalQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Assembly_lblColRemarks_" + Lang.ToLower()))
                            {
                                Assembly_lblColRemarks = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            #endregion

                            #region Electric Control
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Electric Control_lblColItem_" + Lang.ToLower()))
                            {
                                ElectricControl_lblColItem = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Electric Control_lblColReference_" + Lang.ToLower()))
                            {
                                ElectricControl_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Electric Control_lblColName_" + Lang.ToLower()))
                            {
                                ElectricControl_lblColName = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Electric Control_lblColUnitPrice_" + Lang.ToLower()))
                            {
                                ElectricControl_lblColUnitPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Electric Control_lblColQuantity_" + Lang.ToLower()))
                            {
                                ElectricControl_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Electric Control_lblColTotalPrice_" + Lang.ToLower()))
                            {
                                ElectricControl_lblColTotalPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Electric Control_lblSubtotal_" + Lang.ToLower()))
                            {
                                ElectricControl_lblSubtotal = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Electric Control_lblTotalQuantity_" + Lang.ToLower()))
                            {
                                ElectricControl_lblTotalQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Electric Control_lblColRemarks_" + Lang.ToLower()))
                            {
                                ElectricControl_lblColRemarks = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            #endregion

                            #region Hybrid
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Hybrid_lblColItem_" + Lang.ToLower()))
                            {
                                Hybrid_lblColItem = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Hybrid_lblColReference_" + Lang.ToLower()))
                            {
                                Hybrid_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Hybrid_lblColName_" + Lang.ToLower()))
                            {
                                Hybrid_lblColName = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Hybrid_lblColUnitPrice_" + Lang.ToLower()))
                            {
                                Hybrid_lblColUnitPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Hybrid_lblColQuantity_" + Lang.ToLower()))
                            {
                                Hybrid_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Hybrid_lblColTotalPrice_" + Lang.ToLower()))
                            {
                                Hybrid_lblColTotalPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Hybrid_lblSubtotal_" + Lang.ToLower()))
                            {
                                Hybrid_lblSubtotal = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Hybrid_lblTotalQuantity_" + Lang.ToLower()))
                            {
                                Hybrid_lblTotalQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Hybrid_lblColRemarks_" + Lang.ToLower()))
                            {
                                Hybrid_lblColRemarks = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            #endregion

                            #region Japanese
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Japanese_lblColItem_" + Lang.ToLower()))
                            {
                                Japanese_lblColItem = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Japanese_lblColReference_" + Lang.ToLower()))
                            {
                                Japanese_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Japanese_lblColName_" + Lang.ToLower()))
                            {
                                Japanese_lblColName = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Japanese_lblColUnitPrice_" + Lang.ToLower()))
                            {
                                Japanese_lblColUnitPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Japanese_lblColQuantity_" + Lang.ToLower()))
                            {
                                Japanese_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Japanese_lblColTotalPrice_" + Lang.ToLower()))
                            {
                                Japanese_lblColTotalPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Japanese_lblSubtotal_" + Lang.ToLower()))
                            {
                                Japanese_lblSubtotal = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Japanese_lblTotalQuantity_" + Lang.ToLower()))
                            {
                                Japanese_lblTotalQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Japanese_lblColRemarks_" + Lang.ToLower()))
                            {
                                Japanese_lblColRemarks = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            #endregion

                            #region Pull
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pull_lblColItem_" + Lang.ToLower()))
                            {
                                Pull_lblColItem = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pull_lblColReference_" + Lang.ToLower()))
                            {
                                Pull_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pull_lblColName_" + Lang.ToLower()))
                            {
                                Pull_lblColName = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pull_lblColUnitPrice_" + Lang.ToLower()))
                            {
                                Pull_lblColUnitPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pull_lblColQuantity_" + Lang.ToLower()))
                            {
                                Pull_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pull_lblColTotalPrice_" + Lang.ToLower()))
                            {
                                Pull_lblColTotalPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pull_lblSubtotal_" + Lang.ToLower()))
                            {
                                Pull_lblSubtotal = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pull_lblTotalQuantity_" + Lang.ToLower()))
                            {
                                Pull_lblTotalQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Pull_lblColRemarks_" + Lang.ToLower()))
                            {
                                Pull_lblColRemarks = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            #endregion

                            #region Vision
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Vision_lblColItem_" + Lang.ToLower()))
                            {
                                Vision_lblColItem = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Vision_lblColReference_" + Lang.ToLower()))
                            {
                                Vision_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Vision_lblColName_" + Lang.ToLower()))
                            {
                                Vision_lblColName = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Vision_lblColUnitPrice_" + Lang.ToLower()))
                            {
                                Vision_lblColUnitPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Vision_lblColQuantity_" + Lang.ToLower()))
                            {
                                Vision_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Vision_lblColTotalPrice_" + Lang.ToLower()))
                            {
                                Vision_lblColTotalPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Vision_lblSubtotal_" + Lang.ToLower()))
                            {
                                Vision_lblSubtotal = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Vision_lblTotalQuantity_" + Lang.ToLower()))
                            {
                                Vision_lblTotalQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Vision_lblColRemarks_" + Lang.ToLower()))
                            {
                                Vision_lblColRemarks = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            #endregion

                            #region Wireless
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Wireless_lblColItem_" + Lang.ToLower()))
                            {
                                Wireless_lblColItem = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Wireless_lblColReference_" + Lang.ToLower()))
                            {
                                Wireless_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Wireless_lblColName_" + Lang.ToLower()))
                            {
                                Wireless_lblColName = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Wireless_lblColUnitPrice_" + Lang.ToLower()))
                            {
                                Wireless_lblColUnitPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Wireless_lblColQuantity_" + Lang.ToLower()))
                            {
                                Wireless_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Wireless_lblColTotalPrice_" + Lang.ToLower()))
                            {
                                Wireless_lblColTotalPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Wireless_lblSubtotal_" + Lang.ToLower()))
                            {
                                Wireless_lblSubtotal = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Wireless_lblTotalQuantity_" + Lang.ToLower()))
                            {
                                Wireless_lblTotalQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Wireless_lblColRemarks_" + Lang.ToLower()))
                            {
                                Wireless_lblColRemarks = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            #endregion

                            #region WellInsertion
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Well Insertion_lblColItem_" + Lang.ToLower()))
                            {
                                WellInsertion_lblColItem = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Well Insertion_lblColReference_" + Lang.ToLower()))
                            {
                                WellInsertion_lblColReference = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Well Insertion_lblColName_" + Lang.ToLower()))
                            {
                                WellInsertion_lblColName = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Well Insertion_lblColUnitPrice_" + Lang.ToLower()))
                            {
                                WellInsertion_lblColUnitPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Well Insertion_lblColQuantity_" + Lang.ToLower()))
                            {
                                WellInsertion_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Well Insertion_lblColTotalPrice_" + Lang.ToLower()))
                            {
                                WellInsertion_lblColTotalPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Well Insertion_lblSubtotal_" + Lang.ToLower()))
                            {
                                WellInsertion_lblSubtotal = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Well Insertion_lblTotalQuantity_" + Lang.ToLower()))
                            {
                                WellInsertion_lblTotalQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            if ((wsTranslations.Cells[s, 0].Value.ToString() == "Well Insertion_lblColRemarks_" + Lang.ToLower()))
                            {
                                WellInsertion_lblColRemarks = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                            }
                            #endregion

                            #endregion

                            if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferDate"))
                            {
                                _OfferDate = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferTitle"))
                            {
                                _OfferTitle = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferRevisionNumber"))
                            {
                                _OfferRevisionNumber = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferNumber"))
                            {
                                _OfferNumber = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferExpiryDate"))
                            {
                                _OfferExpiryDate = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferIncoterms"))
                            {
                                _OfferIncoTerms = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferPaymentConditions"))
                            {
                                _OfferPaymentConditions = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferOwnerGender"))
                            {
                                _OfferOwnerGender = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferOwnerFullName"))
                            {
                                _OfferOwnerFullName = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferOwnerPhone"))
                            {
                                _OfferOwnerPhone = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferOwnerMobile"))
                            {
                                _OfferOwnerMobile = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferOwnerEmail"))
                            {
                                _OfferOwnerEmail = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferOwnerCompanyName"))
                            {
                                _OfferOwnerCompanyName = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferOwnerCompanyAlias"))
                            {
                                _OfferOwnerCompanyAlias = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferOwnerCompanyStreet"))
                            {
                                _OfferOwnerCompanyStreet = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferOwnerCompanyZipCode"))
                            {
                                _OfferOwnerCompanyZipCode = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferOwnerCompanyCity"))
                            {
                                _OfferOwnerCompanyCity = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferOwnerCompanyState"))
                            {
                                _OfferOwnerCompanyState = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferOwnerCompanyCountry"))
                            {
                                _OfferOwnerCompanyCountry = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferContactGender"))
                            {
                                _OfferContactGender = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferContactFullName"))
                            {
                                _OfferContactFullName = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferContactPhone"))
                            {
                                _OfferContactPhone = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferContactEmail"))
                            {
                                _OfferContactEmail = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferContactCompanyName"))
                            {
                                _OfferContactCompanyName = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferContactCompanyStreet"))
                            {
                                _OfferContactCompanyStreet = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferContactCompanyZipCode"))
                            {
                                _OfferContactCompanyZipCode = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferContactCompanyCity"))
                            {
                                _OfferContactCompanyCity = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferContactCompanyState"))
                            {
                                _OfferContactCompanyState = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferContactCompanyCountry"))
                            {
                                _OfferContactCompanyCountry = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferComments"))
                            {
                                _OfferComments = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_SalesOwnerFullName"))
                            {
                                _OfferSalesOwnerFullName = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_SalesOwnerEmail"))
                            {
                                _OfferSalesOwnerEmail = s;
                            }
                            //https://helpdesk.emdep.com/browse/APIGEOS-258
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferDiscount"))
                            {
                                _OfferDiscount = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_Item1"))
                            {
                                _OfferIndex_Item1 = s;
                            }

                            #region Material_Items

                            //******************************************************************//
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Material_ItemsStartRow")
                            {
                                Material_count = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                                Material_ItemsStartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());

                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Material_ItemItemColumn")
                            {
                                Material_ItemItemColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Material_ItemReferenceColumn")
                            {
                                Material_ItemReferenceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Material_ItemDescriptionColumn")
                            {
                                Material_ItemDescriptionColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Material_ItemUnitPriceColumn")
                            {
                                Material_ItemUnitPriceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Material_ItemQuantityColumn")
                            {
                                Material_ItemQuantityColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Material_ItemTotalPrice")
                            {
                                Material_ItemTotalPrice = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            /****************************************************************************************/
                            #endregion

                            #region Index_CurrentExchangeRate

                            // https://helpdesk.emdep.com/browse/APIGEOS-211 [Exchange Rate to Quote Matrix] skadam 20 05 2021 
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_EUREUR")
                            {
                                _Index_CurrentExchangeRate_EUREUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_EURRON")
                            {
                                _Index_CurrentExchangeRate_EURRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_EURUSD")
                            {
                                _Index_CurrentExchangeRate_EURUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_EURMXN")
                            {
                                _Index_CurrentExchangeRate_EURMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_EURCNY")
                            {
                                _Index_CurrentExchangeRate_EURCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_EURHNL")
                            {
                                _Index_CurrentExchangeRate_EURHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_EURBRL")
                            {
                                _Index_CurrentExchangeRate_EURBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_EURTND")
                            {
                                _Index_CurrentExchangeRate_EURTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_EURMAD")
                            {
                                _Index_CurrentExchangeRate_EURMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_EURPYG")
                            {
                                _Index_CurrentExchangeRate_EURPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_EURRUB")
                            {
                                _Index_CurrentExchangeRate_EURRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_EURINR")
                            {
                                _Index_CurrentExchangeRate_EURINR = s;
                            }

                            /**********************************  CurrentExchangeRate  RON ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RONRON")
                            {
                                _Index_CurrentExchangeRate_RONRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RONEUR")
                            {
                                _Index_CurrentExchangeRate_RONEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RONUSD")
                            {
                                _Index_CurrentExchangeRate_RONUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RONMXN")
                            {
                                _Index_CurrentExchangeRate_RONMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RONCNY")
                            {
                                _Index_CurrentExchangeRate_RONCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RONHNL")
                            {
                                _Index_CurrentExchangeRate_RONHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RONBRL")
                            {
                                _Index_CurrentExchangeRate_RONBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RONTND")
                            {
                                _Index_CurrentExchangeRate_RONTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RONMAD")
                            {
                                _Index_CurrentExchangeRate_RONMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RONPYG")
                            {
                                _Index_CurrentExchangeRate_RONPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RONRUB")
                            {
                                _Index_CurrentExchangeRate_RONRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RONINR")
                            {
                                _Index_CurrentExchangeRate_RONINR = s;
                            }



                            /**********************************  CurrentExchangeRate  USD ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_USDUSD")
                            {
                                _Index_CurrentExchangeRate_USDUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_USDEUR")
                            {
                                _Index_CurrentExchangeRate_USDEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_USDRON")
                            {
                                _Index_CurrentExchangeRate_USDRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_USDMXN")
                            {
                                _Index_CurrentExchangeRate_USDMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_USDCNY")
                            {
                                _Index_CurrentExchangeRate_USDCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_USDHNL")
                            {
                                _Index_CurrentExchangeRate_USDHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_USDBRL")
                            {
                                _Index_CurrentExchangeRate_USDBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_USDTND")
                            {
                                _Index_CurrentExchangeRate_USDTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_USDMAD")
                            {
                                _Index_CurrentExchangeRate_USDMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_USDPYG")
                            {
                                _Index_CurrentExchangeRate_USDPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_USDRUB")
                            {
                                _Index_CurrentExchangeRate_USDRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_USDINR")
                            {
                                _Index_CurrentExchangeRate_USDINR = s;
                            }

                            /**********************************  CurrentExchangeRate  MXN ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MXNMXN")
                            {
                                _Index_CurrentExchangeRate_MXNMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MXNEUR")
                            {
                                _Index_CurrentExchangeRate_MXNEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MXNRON")
                            {
                                _Index_CurrentExchangeRate_MXNRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MXNUSD")
                            {
                                _Index_CurrentExchangeRate_MXNUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MXNCNY")
                            {
                                _Index_CurrentExchangeRate_MXNCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MXNHNL")
                            {
                                _Index_CurrentExchangeRate_MXNHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MXNBRL")
                            {
                                _Index_CurrentExchangeRate_MXNBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MXNTND")
                            {
                                _Index_CurrentExchangeRate_MXNTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MXNMAD")
                            {
                                _Index_CurrentExchangeRate_MXNMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MXNPYG")
                            {
                                _Index_CurrentExchangeRate_MXNPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MXNRUB")
                            {
                                _Index_CurrentExchangeRate_MXNRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MXNINR")
                            {
                                _Index_CurrentExchangeRate_MXNINR = s;
                            }

                            /**********************************  CurrentExchangeRate  CYN ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_CNYCNY")
                            {
                                _Index_CurrentExchangeRate_CNYCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_CNYEUR")
                            {
                                _Index_CurrentExchangeRate_CNYEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_CNYRON")
                            {
                                _Index_CurrentExchangeRate_CNYRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_CNYUSD")
                            {
                                _Index_CurrentExchangeRate_CNYUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_CNYMXN")
                            {
                                _Index_CurrentExchangeRate_CNYMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_CNYHNL")
                            {
                                _Index_CurrentExchangeRate_CNYHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_CNYBRL")
                            {
                                _Index_CurrentExchangeRate_CNYBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_CNYTND")
                            {
                                _Index_CurrentExchangeRate_CNYTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_CNYMAD")
                            {
                                _Index_CurrentExchangeRate_CNYMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_CNYPYG")
                            {
                                _Index_CurrentExchangeRate_CNYPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_CNYRUB")
                            {
                                _Index_CurrentExchangeRate_CNYRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_CNYINR")
                            {
                                _Index_CurrentExchangeRate_CNYINR = s;
                            }

                            /**********************************  CurrentExchangeRate  HNL ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_HNLHNL")
                            {
                                _Index_CurrentExchangeRate_HNLHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_HNLEUR")
                            {
                                _Index_CurrentExchangeRate_HNLEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_HNLRON")
                            {
                                _Index_CurrentExchangeRate_HNLRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_HNLUSD")
                            {
                                _Index_CurrentExchangeRate_HNLUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_HNLMXN")
                            {
                                _Index_CurrentExchangeRate_HNLMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_HNLCNY")
                            {
                                _Index_CurrentExchangeRate_HNLCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_HNLBRL")
                            {
                                _Index_CurrentExchangeRate_HNLBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_HNLTND")
                            {
                                _Index_CurrentExchangeRate_HNLTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_HNLMAD")
                            {
                                _Index_CurrentExchangeRate_HNLMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_HNLPYG")
                            {
                                _Index_CurrentExchangeRate_HNLPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_HNLRUB")
                            {
                                _Index_CurrentExchangeRate_HNLRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_HNLINR")
                            {
                                _Index_CurrentExchangeRate_HNLINR = s;
                            }
                            /**********************************  CurrentExchangeRate  BRL ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_BRLBRL")
                            {
                                _Index_CurrentExchangeRate_BRLBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_BRLEUR")
                            {
                                _Index_CurrentExchangeRate_BRLEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_BRLRON")
                            {
                                _Index_CurrentExchangeRate_BRLRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_BRLUSD")
                            {
                                _Index_CurrentExchangeRate_BRLUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_BRLMXN")
                            {
                                _Index_CurrentExchangeRate_BRLMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_BRLCNY")
                            {
                                _Index_CurrentExchangeRate_BRLCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_BRLHNL")
                            {
                                _Index_CurrentExchangeRate_BRLHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_BRLTND")
                            {
                                _Index_CurrentExchangeRate_BRLTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_BRLMAD")
                            {
                                _Index_CurrentExchangeRate_BRLMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_BRLPYG")
                            {
                                _Index_CurrentExchangeRate_BRLPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_BRLRUB")
                            {
                                _Index_CurrentExchangeRate_BRLRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_BRLINR")
                            {
                                _Index_CurrentExchangeRate_BRLINR = s;
                            }
                            /**********************************  CurrentExchangeRate  TND ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_TNDTND")
                            {
                                _Index_CurrentExchangeRate_TNDTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_TNDEUR")
                            {
                                _Index_CurrentExchangeRate_TNDEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_TNDRON")
                            {
                                _Index_CurrentExchangeRate_TNDRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_TNDUSD")
                            {
                                _Index_CurrentExchangeRate_TNDUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_TNDMXN")
                            {
                                _Index_CurrentExchangeRate_TNDMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_TNDCNY")
                            {
                                _Index_CurrentExchangeRate_TNDCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_TNDHNL")
                            {
                                _Index_CurrentExchangeRate_TNDHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_TNDBRL")
                            {
                                _Index_CurrentExchangeRate_TNDBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_TNDMAD")
                            {
                                _Index_CurrentExchangeRate_TNDMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_TNDPYG")
                            {
                                _Index_CurrentExchangeRate_TNDPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_TNDRUB")
                            {
                                _Index_CurrentExchangeRate_TNDRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_TNDINR")
                            {
                                _Index_CurrentExchangeRate_TNDINR = s;
                            }
                            /**********************************  CurrentExchangeRate  MAD ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MADMAD")
                            {
                                _Index_CurrentExchangeRate_MADMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MADEUR")
                            {
                                _Index_CurrentExchangeRate_MADEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MADRON")
                            {
                                _Index_CurrentExchangeRate_MADRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MADUSD")
                            {
                                _Index_CurrentExchangeRate_MADUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MADMXN")
                            {
                                _Index_CurrentExchangeRate_MADMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MADCNY")
                            {
                                _Index_CurrentExchangeRate_MADCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MADHNL")
                            {
                                _Index_CurrentExchangeRate_MADHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MADBRL")
                            {
                                _Index_CurrentExchangeRate_MADBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MADTND")
                            {
                                _Index_CurrentExchangeRate_MADTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MADPYG")
                            {
                                _Index_CurrentExchangeRate_MADPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MADRUB")
                            {
                                _Index_CurrentExchangeRate_MADRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_MADINR")
                            {
                                _Index_CurrentExchangeRate_MADINR = s;
                            }
                            /**********************************  CurrentExchangeRate  PYG ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_PYGPYG")
                            {
                                _Index_CurrentExchangeRate_PYGPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_PYGEUR")
                            {
                                _Index_CurrentExchangeRate_PYGEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_PYGRON")
                            {
                                _Index_CurrentExchangeRate_PYGRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_PYGUSD")
                            {
                                _Index_CurrentExchangeRate_PYGUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_PYGMXN")
                            {
                                _Index_CurrentExchangeRate_PYGMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_PYGCNY")
                            {
                                _Index_CurrentExchangeRate_PYGCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_PYGHNL")
                            {
                                _Index_CurrentExchangeRate_PYGHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_PYGBRL")
                            {
                                _Index_CurrentExchangeRate_PYGBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_PYGTND")
                            {
                                _Index_CurrentExchangeRate_PYGTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_PYGMAD")
                            {
                                _Index_CurrentExchangeRate_PYGMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_PYGRUB")
                            {
                                _Index_CurrentExchangeRate_PYGRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_PYGINR")
                            {
                                _Index_CurrentExchangeRate_PYGINR = s;
                            }
                            /**********************************  CurrentExchangeRate  RUB ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RUBRUB")
                            {
                                _Index_CurrentExchangeRate_RUBRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RUBEUR")
                            {
                                _Index_CurrentExchangeRate_RUBEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RUBRON")
                            {
                                _Index_CurrentExchangeRate_RUBRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RUBUSD")
                            {
                                _Index_CurrentExchangeRate_RUBUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RUBMXN")
                            {
                                _Index_CurrentExchangeRate_RUBMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RUBCNY")
                            {
                                _Index_CurrentExchangeRate_RUBCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RUBHNL")
                            {
                                _Index_CurrentExchangeRate_RUBHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RUBBRL")
                            {
                                _Index_CurrentExchangeRate_RUBBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RUBTND")
                            {
                                _Index_CurrentExchangeRate_RUBTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RUBMAD")
                            {
                                _Index_CurrentExchangeRate_RUBMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RUBPYG")
                            {
                                _Index_CurrentExchangeRate_RUBPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_RUBINR")
                            {
                                _Index_CurrentExchangeRate_RUBINR = s;
                            }
                            /**********************************  CurrentExchangeRate  INR ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_INRINR")
                            {
                                _Index_CurrentExchangeRate_INRINR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_INREUR")
                            {
                                _Index_CurrentExchangeRate_INREUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_INRRON")
                            {
                                _Index_CurrentExchangeRate_INRRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_INRUSD")
                            {
                                _Index_CurrentExchangeRate_INRUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_INRMXN")
                            {
                                _Index_CurrentExchangeRate_INRMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_INRCNY")
                            {
                                _Index_CurrentExchangeRate_INRCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_INRHNL")
                            {
                                _Index_CurrentExchangeRate_INRHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_INRBRL")
                            {
                                _Index_CurrentExchangeRate_INRBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_INRTND")
                            {
                                _Index_CurrentExchangeRate_INRTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_INRMAD")
                            {
                                _Index_CurrentExchangeRate_INRMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_INRPYG")
                            {
                                _Index_CurrentExchangeRate_INRPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_CurrentExchangeRate_INRRUB")
                            {
                                _Index_CurrentExchangeRate_INRRUB = s;
                            }
                            #endregion

                            #region LastMonthExchangeRate

                            /**********************************  LastMonthExchangeRate  EUR ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_EUREUR")
                            {
                                _Index_LastMonthExchangeRate_EUREUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_EURRON")
                            {
                                _Index_LastMonthExchangeRate_EURRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_EURUSD")
                            {
                                _Index_LastMonthExchangeRate_EURUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_EURMXN")
                            {
                                _Index_LastMonthExchangeRate_EURMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_EURCNY")
                            {
                                _Index_LastMonthExchangeRate_EURCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_EURHNL")
                            {
                                _Index_LastMonthExchangeRate_EURHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_EURBRL")
                            {
                                _Index_LastMonthExchangeRate_EURBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_EURTND")
                            {
                                _Index_LastMonthExchangeRate_EURTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_EURMAD")
                            {
                                _Index_LastMonthExchangeRate_EURMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_EURPYG")
                            {
                                _Index_LastMonthExchangeRate_EURPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_EURRUB")
                            {
                                _Index_LastMonthExchangeRate_EURRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_EURINR")
                            {
                                _Index_LastMonthExchangeRate_EURINR = s;
                            }

                            /**********************************  LastMonthExchangeRate  RON ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RONRON")
                            {
                                _Index_LastMonthExchangeRate_RONRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RONEUR")
                            {
                                _Index_LastMonthExchangeRate_RONEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RONUSD")
                            {
                                _Index_LastMonthExchangeRate_RONUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RONMXN")
                            {
                                _Index_LastMonthExchangeRate_RONMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RONCNY")
                            {
                                _Index_LastMonthExchangeRate_RONCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RONHNL")
                            {
                                _Index_LastMonthExchangeRate_RONHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RONBRL")
                            {
                                _Index_LastMonthExchangeRate_RONBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RONTND")
                            {
                                _Index_LastMonthExchangeRate_RONTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RONMAD")
                            {
                                _Index_LastMonthExchangeRate_RONMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RONPYG")
                            {
                                _Index_LastMonthExchangeRate_RONPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RONRUB")
                            {
                                _Index_LastMonthExchangeRate_RONRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RONINR")
                            {
                                _Index_LastMonthExchangeRate_RONINR = s;
                            }



                            /**********************************  LastMonthExchangeRate  USD ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_USDUSD")
                            {
                                _Index_LastMonthExchangeRate_USDUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_USDEUR")
                            {
                                _Index_LastMonthExchangeRate_USDEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_USDRON")
                            {
                                _Index_LastMonthExchangeRate_USDRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_USDMXN")
                            {
                                _Index_LastMonthExchangeRate_USDMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_USDCNY")
                            {
                                _Index_LastMonthExchangeRate_USDCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_USDHNL")
                            {
                                _Index_LastMonthExchangeRate_USDHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_USDBRL")
                            {
                                _Index_LastMonthExchangeRate_USDBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_USDTND")
                            {
                                _Index_LastMonthExchangeRate_USDTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_USDMAD")
                            {
                                _Index_LastMonthExchangeRate_USDMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_USDPYG")
                            {
                                _Index_LastMonthExchangeRate_USDPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_USDRUB")
                            {
                                _Index_LastMonthExchangeRate_USDRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_USDINR")
                            {
                                _Index_LastMonthExchangeRate_USDINR = s;
                            }

                            /**********************************  LastMonthExchangeRate  MXN ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MXNMXN")
                            {
                                _Index_LastMonthExchangeRate_MXNMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MXNEUR")
                            {
                                _Index_LastMonthExchangeRate_MXNEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MXNRON")
                            {
                                _Index_LastMonthExchangeRate_MXNRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MXNUSD")
                            {
                                _Index_LastMonthExchangeRate_MXNUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MXNCNY")
                            {
                                _Index_LastMonthExchangeRate_MXNCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MXNHNL")
                            {
                                _Index_LastMonthExchangeRate_MXNHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MXNBRL")
                            {
                                _Index_LastMonthExchangeRate_MXNBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MXNTND")
                            {
                                _Index_LastMonthExchangeRate_MXNTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MXNMAD")
                            {
                                _Index_LastMonthExchangeRate_MXNMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MXNPYG")
                            {
                                _Index_LastMonthExchangeRate_MXNPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MXNRUB")
                            {
                                _Index_LastMonthExchangeRate_MXNRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MXNINR")
                            {
                                _Index_LastMonthExchangeRate_MXNINR = s;
                            }

                            /**********************************  LastMonthExchangeRate  CYN ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_CNYCNY")
                            {
                                _Index_LastMonthExchangeRate_CNYCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_CNYEUR")
                            {
                                _Index_LastMonthExchangeRate_CNYEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_CNYRON")
                            {
                                _Index_LastMonthExchangeRate_CNYRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_CNYUSD")
                            {
                                _Index_LastMonthExchangeRate_CNYUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_CNYMXN")
                            {
                                _Index_LastMonthExchangeRate_CNYMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_CNYHNL")
                            {
                                _Index_LastMonthExchangeRate_CNYHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_CNYBRL")
                            {
                                _Index_LastMonthExchangeRate_CNYBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_CNYTND")
                            {
                                _Index_LastMonthExchangeRate_CNYTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_CNYMAD")
                            {
                                _Index_LastMonthExchangeRate_CNYMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_CNYPYG")
                            {
                                _Index_LastMonthExchangeRate_CNYPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_CNYRUB")
                            {
                                _Index_LastMonthExchangeRate_CNYRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_CNYINR")
                            {
                                _Index_LastMonthExchangeRate_CNYINR = s;
                            }

                            /**********************************  LastMonthExchangeRate  HNL ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_HNLHNL")
                            {
                                _Index_LastMonthExchangeRate_HNLHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_HNLEUR")
                            {
                                _Index_LastMonthExchangeRate_HNLEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_HNLRON")
                            {
                                _Index_LastMonthExchangeRate_HNLRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_HNLUSD")
                            {
                                _Index_LastMonthExchangeRate_HNLUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_HNLMXN")
                            {
                                _Index_LastMonthExchangeRate_HNLMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_HNLCNY")
                            {
                                _Index_LastMonthExchangeRate_HNLCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_HNLBRL")
                            {
                                _Index_LastMonthExchangeRate_HNLBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_HNLTND")
                            {
                                _Index_LastMonthExchangeRate_HNLTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_HNLMAD")
                            {
                                _Index_LastMonthExchangeRate_HNLMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_HNLPYG")
                            {
                                _Index_LastMonthExchangeRate_HNLPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_HNLRUB")
                            {
                                _Index_LastMonthExchangeRate_HNLRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_HNLINR")
                            {
                                _Index_LastMonthExchangeRate_HNLINR = s;
                            }
                            /**********************************  LastMonthExchangeRate  BRL ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_BRLBRL")
                            {
                                _Index_LastMonthExchangeRate_BRLBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_BRLEUR")
                            {
                                _Index_LastMonthExchangeRate_BRLEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_BRLRON")
                            {
                                _Index_LastMonthExchangeRate_BRLRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_BRLUSD")
                            {
                                _Index_LastMonthExchangeRate_BRLUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_BRLMXN")
                            {
                                _Index_LastMonthExchangeRate_BRLMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_BRLCNY")
                            {
                                _Index_LastMonthExchangeRate_BRLCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_BRLHNL")
                            {
                                _Index_LastMonthExchangeRate_BRLHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_BRLTND")
                            {
                                _Index_LastMonthExchangeRate_BRLTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_BRLMAD")
                            {
                                _Index_LastMonthExchangeRate_BRLMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_BRLPYG")
                            {
                                _Index_LastMonthExchangeRate_BRLPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_BRLRUB")
                            {
                                _Index_LastMonthExchangeRate_BRLRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_BRLINR")
                            {
                                _Index_LastMonthExchangeRate_BRLINR = s;
                            }
                            /**********************************  LastMonthExchangeRate  TND ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_TNDTND")
                            {
                                _Index_LastMonthExchangeRate_TNDTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_TNDEUR")
                            {
                                _Index_LastMonthExchangeRate_TNDEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_TNDRON")
                            {
                                _Index_LastMonthExchangeRate_TNDRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_TNDUSD")
                            {
                                _Index_LastMonthExchangeRate_TNDUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_TNDMXN")
                            {
                                _Index_LastMonthExchangeRate_TNDMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_TNDCNY")
                            {
                                _Index_LastMonthExchangeRate_TNDCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_TNDHNL")
                            {
                                _Index_LastMonthExchangeRate_TNDHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_TNDBRL")
                            {
                                _Index_LastMonthExchangeRate_TNDBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_TNDMAD")
                            {
                                _Index_LastMonthExchangeRate_TNDMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_TNDPYG")
                            {
                                _Index_LastMonthExchangeRate_TNDPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_TNDRUB")
                            {
                                _Index_LastMonthExchangeRate_TNDRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_TNDINR")
                            {
                                _Index_LastMonthExchangeRate_TNDINR = s;
                            }
                            /**********************************  LastMonthExchangeRate  MAD ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MADMAD")
                            {
                                _Index_LastMonthExchangeRate_MADMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MADEUR")
                            {
                                _Index_LastMonthExchangeRate_MADEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MADRON")
                            {
                                _Index_LastMonthExchangeRate_MADRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MADUSD")
                            {
                                _Index_LastMonthExchangeRate_MADUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MADMXN")
                            {
                                _Index_LastMonthExchangeRate_MADMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MADCNY")
                            {
                                _Index_LastMonthExchangeRate_MADCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MADHNL")
                            {
                                _Index_LastMonthExchangeRate_MADHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MADBRL")
                            {
                                _Index_LastMonthExchangeRate_MADBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MADTND")
                            {
                                _Index_LastMonthExchangeRate_MADTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MADPYG")
                            {
                                _Index_LastMonthExchangeRate_MADPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MADRUB")
                            {
                                _Index_LastMonthExchangeRate_MADRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_MADINR")
                            {
                                _Index_LastMonthExchangeRate_MADINR = s;
                            }
                            /**********************************  LastMonthExchangeRate  PYG ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_PYGPYG")
                            {
                                _Index_LastMonthExchangeRate_PYGPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_PYGEUR")
                            {
                                _Index_LastMonthExchangeRate_PYGEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_PYGRON")
                            {
                                _Index_LastMonthExchangeRate_PYGRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_PYGUSD")
                            {
                                _Index_LastMonthExchangeRate_PYGUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_PYGMXN")
                            {
                                _Index_LastMonthExchangeRate_PYGMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_PYGCNY")
                            {
                                _Index_LastMonthExchangeRate_PYGCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_PYGHNL")
                            {
                                _Index_LastMonthExchangeRate_PYGHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_PYGBRL")
                            {
                                _Index_LastMonthExchangeRate_PYGBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_PYGTND")
                            {
                                _Index_LastMonthExchangeRate_PYGTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_PYGMAD")
                            {
                                _Index_LastMonthExchangeRate_PYGMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_PYGRUB")
                            {
                                _Index_LastMonthExchangeRate_PYGRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_PYGINR")
                            {
                                _Index_LastMonthExchangeRate_PYGINR = s;
                            }
                            /**********************************  LastMonthExchangeRate  RUB ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RUBRUB")
                            {
                                _Index_LastMonthExchangeRate_RUBRUB = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RUBEUR")
                            {
                                _Index_LastMonthExchangeRate_RUBEUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RUBRON")
                            {
                                _Index_LastMonthExchangeRate_RUBRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RUBUSD")
                            {
                                _Index_LastMonthExchangeRate_RUBUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RUBMXN")
                            {
                                _Index_LastMonthExchangeRate_RUBMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RUBCNY")
                            {
                                _Index_LastMonthExchangeRate_RUBCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RUBHNL")
                            {
                                _Index_LastMonthExchangeRate_RUBHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RUBBRL")
                            {
                                _Index_LastMonthExchangeRate_RUBBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RUBTND")
                            {
                                _Index_LastMonthExchangeRate_RUBTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RUBMAD")
                            {
                                _Index_LastMonthExchangeRate_RUBMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RUBPYG")
                            {
                                _Index_LastMonthExchangeRate_RUBPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_RUBINR")
                            {
                                _Index_LastMonthExchangeRate_RUBINR = s;
                            }
                            /**********************************  LastMonthExchangeRate  INR ******************************************************/
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_INRINR")
                            {
                                _Index_LastMonthExchangeRate_INRINR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_INREUR")
                            {
                                _Index_LastMonthExchangeRate_INREUR = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_INRRON")
                            {
                                _Index_LastMonthExchangeRate_INRRON = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_INRUSD")
                            {
                                _Index_LastMonthExchangeRate_INRUSD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_INRMXN")
                            {
                                _Index_LastMonthExchangeRate_INRMXN = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_INRCNY")
                            {
                                _Index_LastMonthExchangeRate_INRCNY = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_INRHNL")
                            {
                                _Index_LastMonthExchangeRate_INRHNL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_INRBRL")
                            {
                                _Index_LastMonthExchangeRate_INRBRL = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_INRTND")
                            {
                                _Index_LastMonthExchangeRate_INRTND = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_INRMAD")
                            {
                                _Index_LastMonthExchangeRate_INRMAD = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_INRPYG")
                            {
                                _Index_LastMonthExchangeRate_INRPYG = s;
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Index_LastMonthExchangeRate_INRRUB")
                            {
                                _Index_LastMonthExchangeRate_INRRUB = s;
                            }
                            /*

                             */

                            //End 211
                            /****************************************************************************************/
                            #endregion

                            #region Invoice_Item

                            else if (wsDl.Cells[s, 0].Value.ToString() == "Invoice_ItemsStartRow")
                            {
                                Invoice_count = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                                Invoice_ItemsStartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Invoice_ItemItemColumn")
                            {
                                Invoice_ItemItemColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Invoice_ItemReferenceColumn"))
                            {
                                Invoice_ItemReferenceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Invoice_ItemDescriptionColumn"))
                            {
                                Invoice_ItemDescriptionColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Invoice_ItemUnitPriceColumn"))
                            {
                                Invoice_ItemUnitPriceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Invoice_ItemQuantityColumn"))
                            {
                                Invoice_ItemQuantityColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Invoice_ItemTotalPrice"))
                            {
                                Invoice_ItemTotalPrice = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            #endregion
                            #region Technical_Assistance_Items

                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Technical Assistance_ItemsStartRow"))
                            {
                                Technical_count = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                                Technical_Assistance_ItemsStartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if (wsDl.Cells[s, 0].Value.ToString() == "Technical Assistance_ItemItemColumn")
                            {
                                Technical_Assistance_ItemItemColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Technical Assistance_ItemReferenceColumn"))
                            {
                                Technical_Assistance_ItemReferenceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }

                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Technical Assistance_ItemDescriptionColumn"))
                            {
                                Technical_Assistance_ItemDescriptionColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Technical Assistance_ItemUnitPriceColumn"))
                            {
                                Technical_Assistance_ItemUnitPriceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Technical Assistance_ItemQuantityColumn"))
                            {
                                Technical_Assistance_ItemQuantityColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Technical_Assistance_ItemTotalPrice"))
                            {
                                Technical_Assistance_ItemTotalPrice = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            #endregion
                            #region Component_Item

                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Component_ItemsStartRow"))
                            {
                                Component_count = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                                Component_ItemsStartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Component_ItemItemColumn"))
                            {
                                Component_ItemItemColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Component_ItemReferenceColumn"))
                            {
                                Component_ItemReferenceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Component_ItemNameColumn"))
                            {
                                Component_ItemNameColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Component_DetStartColumn"))
                            {
                                Component_DetStartColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Component_DetEndColumn"))
                            {
                                Component_DetEndColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Component_ItemUnitPriceColumn"))
                            {
                                Component_ItemUnitPriceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Component_ItemQuantityColumn"))
                            {
                                Component_ItemQuantityColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Component_ItemCommentsColumn"))
                            {
                                Component_ItemRemarksColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Component_ItemTotalPrice"))
                            {
                                Component_ItemTotalPrice = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            #endregion
                            //APIGEOS - 1132 Add support for creating offers including modules in ECOS(3 / 3)
                            #region Module_Item

                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Module_ItemsStartRow"))
                            {
                                Module_count = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                                Module_ItemsStartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Module_ItemItemColumn"))
                            {
                                Module_ItemItemColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Module_ItemReferenceColumn"))
                            {
                                Module_ItemReferenceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Module_ItemNameColumn"))
                            {
                                Module_ItemNameColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Module_ItemDetStartColumn"))
                            {
                                Module_ItemDetStartColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Module_ItemUnitPriceColumn"))
                            {
                                Module_ItemUnitPriceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Module_ItemQuantityColumn"))
                            {
                                Module_ItemQuantityColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Module_ItemCommentsColumn"))
                            {
                                Module_ItemCommentsColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Module_ItemTotalPrice"))
                            {
                                Module_ItemTotalPrice = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                            }
                            #endregion
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferCurrency"))
                            {
                                Index_OfferCurrency = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferRfqNumber"))
                            {
                                Index_OfferRfqNumber = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_RfqDate"))
                            {
                                Index_RfqDate = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferBusinessUnit"))
                            {
                                Index_OfferBusinessUnit = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferProject"))
                            {
                                Index_OfferProject = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferCarOEM"))
                            {
                                Index_OfferCarOEM = s;
                            }

                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferCategory1"))
                            {
                                Index_OfferCategory1 = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferCategory2"))
                            {
                                Index_OfferCategory2 = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferShippingAddressStreet"))
                            {
                                _OfferShippingAddressStreet = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferShippingAddressName"))
                            {
                                _OfferShippingAddressName = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferContactCompanyGroup"))
                            {
                                _Index_OfferContactCompanyGroup = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferContactCompanySite"))
                            {
                                _Index_OfferContactCompanySite = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferShippingAddressFiscalNumber"))
                            {
                                _OfferShippingAddressFiscalNumber = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferShippingAddressZipCode"))
                            {
                                _OfferShippingAddressZipCode = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferShippingAddressCity"))
                            {
                                _OfferShippingAddressCity = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferShippingAddressState"))
                            {
                                _OfferShippingAddressState = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferShippingAddressCountry"))
                            {
                                _OfferShippingAddressCountry = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferShippingAddressPhone"))
                            {
                                _OfferShippingAddressPhone = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_OfferSource"))
                            {
                                _OfferSource = s;
                            }
                            else if ((wsDl.Cells[s, 0].Value.ToString() == "Language"))
                            {
                                Language = s;
                            }
                        }

                        #endregion

                        using (stream = new FileStream(Path.Combine(updatedExcelFilePath, filenameExcel), FileMode.Create, FileAccess.ReadWrite))
                        {
                            #region CultureInfo
                            //CultureInfo ci = new CultureInfo(workbook.Options.Culture.Name);
                            //string dateCulture= string.Format(ci, offer._OfferDate);

                            CultureInfo cultureInfo = new CultureInfo(workbook.Options.Culture.Name);
                            if (!String.IsNullOrEmpty(offer._OfferDate))
                            {
                                DateTime dt = DateTime.ParseExact(offer._OfferDate, "dd-MM-yyyy", null);
                                //string dateCulture = dt.ToString("d", cultureInfo);
                                //wsDl.Cells[_OfferDate, 1].Value = offer._OfferDate; 
                                wsDl.Cells[_OfferDate, 1].Value = dt.ToString(cultureInfo.DateTimeFormat.ShortDatePattern, cultureInfo);
                            }
                            else
                            {
                                wsDl.Cells[_OfferDate, 1].Value = offer._OfferDate;
                            }
                            wsDl.Cells[_OfferTitle, 1].Value = offer._OfferTitle;
                            wsDl.Cells[_OfferNumber, 1].Value = offer._OfferNumber;
                            wsDl.Cells[_OfferRevisionNumber, 1].Value = offer._OfferRevisionNumber;
                            #region oldcode
                            //if (!String.IsNullOrEmpty(offer._OfferExpiryDate))
                            //{
                            //    DateTime dt = DateTime.ParseExact(offer._OfferExpiryDate, "dd-MM-yyyy", null);
                            //    cultureInfo = new CultureInfo(workbook.Options.Culture.Name);
                            //    //wsDl.Cells[_OfferExpiryDate, 1].Value = offer._OfferExpiryDate;
                            //    wsDl.Cells[_OfferExpiryDate, 1].Value = dt.ToString(cultureInfo.DateTimeFormat.ShortDatePattern, cultureInfo);
                            //}
                            //else
                            //{
                            //    wsDl.Cells[_OfferDate, 1].Value = offer._OfferExpiryDate;
                            //}
                            #endregion
                            if (!String.IsNullOrEmpty(offer._CloseDate))
                            {
                                DateTime dt = DateTime.ParseExact(offer._CloseDate, "dd-MM-yyyy", null);
                                cultureInfo = new CultureInfo(workbook.Options.Culture.Name);
                                //wsDl.Cells[_OfferExpiryDate, 1].Value = offer._OfferExpiryDate;
                                wsDl.Cells[_OfferExpiryDate, 1].Value = dt.ToString(cultureInfo.DateTimeFormat.ShortDatePattern, cultureInfo);
                            }
                            //else
                            //{
                            //    wsDl.Cells[_OfferDate, 1].Value = offer._CloseDate;
                            //}
                            #endregion
                            wsDl.Cells[_OfferIncoTerms, 1].Value = offer._OfferIncoTerms;
                            wsDl.Cells[_OfferPaymentConditions, 1].Value = offer._OfferPaymentConditions;
                            wsDl.Cells[_OfferOwnerGender, 1].Value = offer._OfferOwnerGender;
                            wsDl.Cells[_OfferOwnerFullName, 1].Value = offer._OfferOwnerFullName;
                            wsDl.Cells[_OfferOwnerPhone, 1].Value = offer._OfferOwnerPhone;
                            wsDl.Cells[_OfferOwnerMobile, 1].Value = offer._OfferOwnerMobile;
                            wsDl.Cells[_OfferOwnerEmail, 1].Value = offer._OfferOwnerEmail;
                            wsDl.Cells[_OfferOwnerCompanyName, 1].Value = offer._OfferOwnerCompanyName;
                            wsDl.Cells[_OfferOwnerCompanyAlias, 1].Value = offer._OfferOwnerCompanyAlias;
                            wsDl.Cells[_OfferOwnerCompanyStreet, 1].Value = offer._OfferOwnerCompanyStreet;
                            wsDl.Cells[_OfferOwnerCompanyZipCode, 1].Value = offer._OfferOwnerCompanyZipCode;
                            wsDl.Cells[_OfferOwnerCompanyCity, 1].Value = offer._OfferOwnerCompanyCity;
                            wsDl.Cells[_OfferOwnerCompanyState, 1].Value = offer._OfferOwnerCompanyState;
                            wsDl.Cells[_OfferOwnerCompanyCountry, 1].Value = offer._OfferOwnerCompanyCountry;
                            wsDl.Cells[_OfferContactGender, 1].Value = offer._OfferContactGender;
                            wsDl.Cells[_OfferContactFullName, 1].Value = offer._OfferContactFullName;
                            wsDl.Cells[_OfferContactPhone, 1].Value = offer._OfferContactPhone;
                            wsDl.Cells[_OfferContactEmail, 1].Value = offer._OfferContactEmail;
                            wsDl.Cells[_OfferContactCompanyName, 1].Value = offer._OfferContactCompanyName;
                            wsDl.Cells[_OfferContactCompanyStreet, 1].Value = offer._OfferContactCompanyStreet;
                            wsDl.Cells[_OfferContactCompanyZipCode, 1].Value = offer._OfferContactCompanyZipCode;
                            wsDl.Cells[_OfferContactCompanyCity, 1].Value = offer._OfferContactCompanyCity;
                            wsDl.Cells[_OfferContactCompanyState, 1].Value = offer._OfferContactCompanyState;
                            wsDl.Cells[_OfferContactCompanyCountry, 1].Value = offer._OfferContactCompanyCountry;
                            wsDl.Cells[_OfferComments, 1].Value = offer._OfferComments;
                            wsDl.Cells[_OfferSalesOwnerFullName, 1].Value = offer._OfferSalesOwnerFullName;
                            wsDl.Cells[_OfferSalesOwnerEmail, 1].Value = offer._OfferSalesOwnerEmail;
                            wsDl.Cells[_OfferSource, 1].Value = offer._OfferSource;    //chitra.girigosavi[APIGEOS-1276][18/11/2024]
                            //https://helpdesk.emdep.com/browse/APIGEOS-258
                            wsDl.Cells[_OfferDiscount, 1].Value = offer._OfferDiscount;

                            int i = _OfferIndex_Item1;
                            if (offer._ExportOfferOptionLst != null)
                                foreach (ExportOfferOptions item in offer._ExportOfferOptionLst)
                                {

                                    wsDl.Cells[i, 1].Value = item.Name;
                                    i = i + 1;
                                }
                            //wsDl.Cells[39, 1].Value = 5;
                            //Check current currency
                            //string strcurr = Convert.ToString(wsDl.Cells[342, 1].Value);

                            wsDl.Cells[Index_OfferCurrency, 1].Value = offer._CurrencyName;

                            wsDl.Cells[Index_OfferRfqNumber, 1].Value = offer._OfferRfqNumber;
                            wsDl.Cells[Index_RfqDate, 1].Value = offer._RfqDate;
                            wsDl.Cells[Index_OfferBusinessUnit, 1].Value = offer._OfferBusinessUnit;
                            wsDl.Cells[Index_OfferProject, 1].Value = offer._OfferProject;
                            wsDl.Cells[Index_OfferCarOEM, 1].Value = offer._OfferCarOEM;
                            wsDl.Cells[Index_OfferCategory1, 1].Value = offer._OfferCategory1;
                            wsDl.Cells[Index_OfferCategory2, 1].Value = offer._OfferCategory2;
                            //wsDl.Cells[Index_OfferShippingAddress , 1].Value = offer._OfferShippingAddress;
                            wsDl.Cells[Language, 1].Value = Lang;

                            wsDl.Cells[_OfferShippingAddressStreet, 1].Value = offer._OfferShippingAddressStreet;
                            wsDl.Cells[_OfferShippingAddressName, 1].Value = offer._OfferShippingAddressName;
                            if (_Index_OfferContactCompanyGroup != 0)
                            {
                                wsDl.Cells[_Index_OfferContactCompanyGroup, 1].Value = offer._OfferContactCompanyGroup;
                            }
                            if (_Index_OfferContactCompanySite != 0)
                            {
                                wsDl.Cells[_Index_OfferContactCompanySite, 1].Value = offer._OfferContactCompanySite;
                            }
                            wsDl.Cells[_OfferShippingAddressFiscalNumber, 1].Value = offer._OfferShippingAddressFiscalNumber;
                            wsDl.Cells[_OfferShippingAddressZipCode, 1].Value = offer._OfferShippingAddressZipCode;
                            wsDl.Cells[_OfferShippingAddressCity, 1].Value = offer._OfferShippingAddressCity;
                            wsDl.Cells[_OfferShippingAddressState, 1].Value = offer._OfferShippingAddressState;
                            wsDl.Cells[_OfferShippingAddressCountry, 1].Value = offer._OfferShippingAddressCountry;
                            wsDl.Cells[_OfferShippingAddressCountry, 1].Value = offer._OfferShippingAddressCountry;

                            #region fill_currencyconversions

                            if (currencyconversionsList.Count() > 1)
                            {
                                wsDl.Cells[_Index_CurrentExchangeRate_EUREUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 1).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_EUREUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 1).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_EURRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 2).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_EURRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 2).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_EURUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 3).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_EURUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 3).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_EURMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 4).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_EURMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 4).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_EURCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 5).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_EURCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 5).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_EURHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 6).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_EURHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 6).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_EURBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 7).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_EURBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 7).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_EURTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 8).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_EURTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 8).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_EURMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 9).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_EURMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 9).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_EURPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 10).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_EURPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 10).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_EURRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 11).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_EURRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 11).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_EURINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 12).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_EURINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 1 && c.IdCurrencyConversionTo == 12).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();


                                wsDl.Cells[_Index_CurrentExchangeRate_RONRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 2).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RONRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 2).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RONEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 1).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RONEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 1).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RONUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 3).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RONUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 3).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RONMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 4).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RONMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 4).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RONCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 5).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RONCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 5).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RONHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 6).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RONHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 6).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RONBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 7).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RONBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 7).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RONTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 8).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RONTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 8).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RONMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 9).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RONMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 9).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RONPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 10).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RONPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 10).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RONRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 11).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RONRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 11).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RONINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 12).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RONINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 2 && c.IdCurrencyConversionTo == 12).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();


                                wsDl.Cells[_Index_CurrentExchangeRate_USDUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 3).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_USDUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 3).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_USDEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 1).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_USDEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 1).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_USDRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 2).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_USDRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 2).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_USDMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 4).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_USDMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 4).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_USDCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 5).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_USDCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 5).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_USDHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 6).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_USDHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 6).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_USDBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 7).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_USDBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 7).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_USDTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 8).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_USDTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 8).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_USDMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 9).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_USDMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 9).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_USDPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 10).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_USDPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 10).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_USDRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 11).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_USDRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 11).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_USDINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 12).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_USDINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 3 && c.IdCurrencyConversionTo == 12).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();


                                wsDl.Cells[_Index_CurrentExchangeRate_MXNMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 4).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MXNMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 4).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MXNEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 1).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MXNEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 1).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MXNRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 2).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MXNRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 2).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MXNUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 3).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MXNUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 3).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MXNCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 5).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MXNCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 5).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MXNHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 6).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MXNHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 6).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MXNBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 7).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MXNBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 7).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MXNTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 8).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MXNTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 8).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MXNMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 9).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MXNMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 9).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MXNPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 10).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MXNPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 10).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MXNRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 11).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MXNRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 11).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MXNINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 12).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MXNINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 4 && c.IdCurrencyConversionTo == 12).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();


                                wsDl.Cells[_Index_CurrentExchangeRate_CNYCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 5).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_CNYCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 5).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_CNYEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 1).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_CNYEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 1).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_CNYRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 2).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_CNYRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 2).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_CNYUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 3).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_CNYUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 3).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_CNYMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 4).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_CNYMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 4).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_CNYHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 6).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_CNYHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 6).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_CNYBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 7).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_CNYBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 7).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_CNYTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 8).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_CNYTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 8).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_CNYMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 9).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_CNYMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 9).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_CNYPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 10).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_CNYPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 10).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_CNYRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 11).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_CNYRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 11).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_CNYINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 12).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_CNYINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 5 && c.IdCurrencyConversionTo == 12).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();


                                wsDl.Cells[_Index_CurrentExchangeRate_HNLHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 6).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_HNLHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 6).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_HNLEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 1).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_HNLEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 1).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_HNLRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 2).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_HNLRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 2).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_HNLUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 3).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_HNLUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 3).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_HNLMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 4).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_HNLMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 4).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_HNLCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 5).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_HNLCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 5).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_HNLBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 7).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_HNLBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 7).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_HNLTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 8).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_HNLTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 8).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_HNLMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 9).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_HNLMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 9).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_HNLPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 10).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_HNLPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 10).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_HNLRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 11).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_HNLRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 11).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_HNLINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 12).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_HNLINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 6 && c.IdCurrencyConversionTo == 12).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();


                                wsDl.Cells[_Index_CurrentExchangeRate_BRLBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 7).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_BRLBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 7).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_BRLEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 1).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_BRLEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 1).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_BRLRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 2).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_BRLRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 2).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_BRLUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 3).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_BRLUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 3).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_BRLMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 4).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_BRLMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 4).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_BRLCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 5).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_BRLCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 5).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_BRLHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 6).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_BRLHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 6).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_BRLTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 8).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_BRLTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 8).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_BRLMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 9).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_BRLMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 9).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_BRLPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 10).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_BRLPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 10).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_BRLRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 11).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_BRLRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 11).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_BRLINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 12).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_BRLINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 7 && c.IdCurrencyConversionTo == 12).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();


                                wsDl.Cells[_Index_CurrentExchangeRate_TNDTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 8).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_TNDTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 8).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_TNDEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 1).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_TNDEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 1).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_TNDRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 2).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_TNDRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 2).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_TNDUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 3).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_TNDUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 3).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_TNDMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 4).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_TNDMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 4).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_TNDCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 5).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_TNDCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 5).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_TNDHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 6).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_TNDHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 6).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_TNDBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 7).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_TNDBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 7).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_TNDMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 9).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_TNDMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 9).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_TNDPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 10).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_TNDPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 10).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_TNDRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 11).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_TNDRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 11).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_TNDINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 12).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_TNDINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 8 && c.IdCurrencyConversionTo == 12).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();


                                wsDl.Cells[_Index_CurrentExchangeRate_MADMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 9).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MADMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 9).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MADEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 1).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MADEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 1).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MADRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 2).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MADRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 2).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MADUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 3).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MADUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 3).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MADMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 4).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MADMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 4).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MADCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 5).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MADCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 5).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MADHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 6).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MADHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 6).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MADBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 7).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MADBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 7).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MADTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 8).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MADTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 8).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MADPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 10).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MADPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 10).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MADRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 11).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MADRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 11).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_MADINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 12).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_MADINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 9 && c.IdCurrencyConversionTo == 12).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();


                                wsDl.Cells[_Index_CurrentExchangeRate_PYGPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 10).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_PYGPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 10).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_PYGEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 1).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_PYGEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 1).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_PYGRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 2).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_PYGRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 2).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_PYGUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 3).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_PYGUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 3).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_PYGMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 4).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_PYGMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 4).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_PYGCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 5).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_PYGCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 5).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_PYGHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 6).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_PYGHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 6).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_PYGBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 7).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_PYGBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 7).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_PYGTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 8).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_PYGTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 8).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_PYGMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 9).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_PYGMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 9).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_PYGRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 11).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_PYGRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 11).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_PYGINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 12).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_PYGINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 10 && c.IdCurrencyConversionTo == 12).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();


                                wsDl.Cells[_Index_CurrentExchangeRate_RUBRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 11).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RUBRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 11).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RUBEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 1).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RUBEUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 1).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RUBRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 2).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RUBRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 2).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RUBUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 3).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RUBUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 3).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RUBMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 4).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RUBMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 4).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RUBCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 5).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RUBCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 5).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RUBHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 6).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RUBHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 6).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RUBBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 7).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RUBBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 7).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RUBTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 8).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RUBTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 8).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RUBMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 9).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RUBMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 9).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RUBPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 10).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RUBPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 10).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_RUBINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 12).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_RUBINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 11 && c.IdCurrencyConversionTo == 12).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();


                                wsDl.Cells[_Index_CurrentExchangeRate_INRINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 12).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_INRINR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 12).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_INREUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 1).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_INREUR, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 1).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_INRRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 2).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_INRRON, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 2).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_INRUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 3).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_INRUSD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 3).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_INRMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 4).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_INRMXN, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 4).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_INRCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 5).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_INRCNY, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 5).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_INRHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 6).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_INRHNL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 6).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_INRBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 7).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_INRBRL, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 7).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_INRTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 8).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_INRTND, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 8).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_INRMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 9).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_INRMAD, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 9).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_INRPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 10).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_INRPYG, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 10).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_CurrentExchangeRate_INRRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 11).Select(c => c.CurrencyConversionRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                                wsDl.Cells[_Index_LastMonthExchangeRate_INRRUB, 1].Value = currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == 12 && c.IdCurrencyConversionTo == 11).Select(c => c.LastMonthAVGRate).DefaultIfEmpty(string.Empty).FirstOrDefault();
                            }
                            #endregion


                            #region Material

                            if (offer._ExportOfferQuotationsLst != null)
                            {
                                Int32 Material_ItemsHeadingStartRow = Convert.ToInt32(Material_count) - 1;

                                Worksheet wsDlQuotation = workbook.Worksheets[1];

                                wsDlQuotation.Cells[Material_ItemItemColumn + (Material_ItemsStartRow - 1)].Value = Material_lblColItem;
                                wsDlQuotation.Cells[Material_ItemReferenceColumn + (Material_ItemsStartRow - 1)].Value = Material_lblColReference;
                                wsDlQuotation.Cells[Material_ItemDescriptionColumn + (Material_ItemsStartRow - 1)].Value = Material_lblColDescription;
                                wsDlQuotation.Cells[Material_ItemUnitPriceColumn + (Material_ItemsStartRow - 1)].Value = Material_lblColUnitPrice;
                                wsDlQuotation.Cells[Material_ItemQuantityColumn + (Material_ItemsStartRow - 1)].Value = Material_lblColQuantity;
                                wsDlQuotation.Cells[Material_ItemTotalPrice + (Material_ItemsStartRow - 1)].Value = Material_lblColTotalPrice;

                                if (offer._ExportOfferQuotationsLst.Count() > 1)
                                    wsDlQuotation.Rows.Insert(Material_ItemsHeadingStartRow + 1, offer._ExportOfferQuotationsLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                                //wsDlQuotation.Rows.Insert(Material_ItemsHeadingStartRow +1, offer._ExportOfferQuotationsLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                                if (offer._ExportOfferQuotationsLst != null)
                                    foreach (ExportOfferQuotation item in offer._ExportOfferQuotationsLst)
                                    {
                                        if (item.Description.Equals("Discount"))
                                        {
                                            wsDlQuotation.Cells[Material_ItemItemColumn + Material_ItemsStartRow].Value = item.Item;
                                            wsDlQuotation.Cells[Material_ItemDescriptionColumn + Material_ItemsStartRow].Value = (Index_lblDiscount + " (" + item.Discount + "%)");
                                            wsDlQuotation.Cells[Material_ItemUnitPriceColumn + Material_ItemsStartRow].Value = item.UnitPrice;
                                            wsDlQuotation.Cells[Material_ItemQuantityColumn + Material_ItemsStartRow].Value = item.Qty;
                                            wsDlQuotation.Rows[(Material_ItemsStartRow - 1)].Font.Bold = true;
                                            if (Technical_Assistance_ItemsStartRow / 2 == 0)
                                            {
                                                //wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                //wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                wsDlQuotation.Cells[Material_ItemUnitPriceColumn + Material_ItemsStartRow].Font.Color = Color.White;
                                                wsDlQuotation.Cells[Material_ItemUnitPriceColumn + Material_ItemsStartRow].FillColor = Color.White;
                                                wsDlQuotation.Cells[Material_ItemQuantityColumn + Material_ItemsStartRow].Font.Color = Color.White;
                                                wsDlQuotation.Cells[Material_ItemQuantityColumn + Material_ItemsStartRow].FillColor = Color.White;
                                            }
                                            else
                                            {
                                                wsDlQuotation.Cells[Material_ItemUnitPriceColumn + Material_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                wsDlQuotation.Cells[Material_ItemQuantityColumn + Material_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                            }
                                        }
                                        else //if (!item.Discount.Equals("Discount"))
                                        {
                                            wsDlQuotation.Cells[Material_ItemItemColumn + Material_ItemsStartRow].Value = item.Item;
                                            wsDlQuotation.Cells[Material_ItemReferenceColumn + Material_ItemsStartRow].Value = item.Reference;
                                            #region richTextCustomerCommet
                                            RichTextString richText = new RichTextString();
                                            SpreadsheetFont cellFont = wsDlQuotation.Cells[Material_ItemDescriptionColumn + Material_ItemsStartRow].Font;
                                            #region getRichText
                                            //RichTextString getrichText = wsDlQuotation.Cells[Material_ItemDescriptionColumn + Material_ItemsStartRow].GetRichText();
                                            //RichTextRun getRuns = getrichText.Runs.FirstOrDefault();
                                            //richText.AddTextRun(item.Description, new RichTextRunFont("Calibri Light", 10, System.Drawing.Color.Black));
                                            #endregion
                                            if (item.Description != string.Empty)
                                            {

                                                richText.AddTextRun(item.Description, new RichTextRunFont(cellFont.Name, cellFont.Size, cellFont.Color));
                                            }
                                            if (item.Comments != string.Empty)
                                            {
                                                richText.AddTextRun("\n", new RichTextRunFont(cellFont.Name, cellFont.Size, cellFont.Color));
                                                RichTextRunFont RichText = new RichTextRunFont(cellFont.Name, (cellFont.Size - 1), cellFont.Color);
                                                RichText.Italic = true;
                                                richText.AddTextRun(item.Comments, RichText);
                                            }
                                            wsDlQuotation.Cells[Material_ItemDescriptionColumn + Material_ItemsStartRow].SetRichText(richText);
                                            #endregion
                                            //string customercommet = (item.Description + "\n"+ item.Comments).ToString();
                                            // wsDlQuotation.Cells[Material_ItemDescriptionColumn + Material_ItemsStartRow].Value = customercommet;//item.Description;
                                            wsDlQuotation.Cells[Material_ItemUnitPriceColumn + Material_ItemsStartRow].Value = item.UnitPrice;
                                            //wsDlQuotation.Cells[Material_ItemUnitPriceColumn + Material_ItemsStartRow].NumberFormat = "#,##";
                                            wsDlQuotation.Cells[Material_ItemQuantityColumn + Material_ItemsStartRow].Value = item.Qty;
                                        }
                                        Material_ItemsStartRow = Material_ItemsStartRow + 1;
                                    }
                                wsDlQuotation.Rows.Remove(Material_ItemsStartRow + 3, 1048575 - (Material_ItemsStartRow + 2));
                            }
                            else
                            {
                                workbook.Worksheets[1].Visible = false;
                            }
                            #endregion

                            #region Invoice

                            if (offer._ExportOfferInvoiceLst != null)
                            {

                                Int32 Invoice_ItemsHeadingStartRow = Convert.ToInt32(Invoice_count) - 1;


                                Worksheet wsInvoice = workbook.Worksheets[2];

                                wsInvoice.Cells[Invoice_ItemItemColumn + (Invoice_ItemsStartRow - 1)].Value = Invoice_lblColItem;
                                wsInvoice.Cells[Invoice_ItemReferenceColumn + (Invoice_ItemsStartRow - 1)].Value = Invoice_lblColReference;
                                wsInvoice.Cells[Invoice_ItemDescriptionColumn + (Invoice_ItemsStartRow - 1)].Value = Invoice_lblColDescription;
                                wsInvoice.Cells[Invoice_ItemUnitPriceColumn + (Invoice_ItemsStartRow - 1)].Value = Invoice_lblColUnitPrice;
                                wsInvoice.Cells[Invoice_ItemQuantityColumn + (Invoice_ItemsStartRow - 1)].Value = Invoice_lblColQuantity;
                                wsInvoice.Cells[Invoice_ItemTotalPrice + (Invoice_ItemsStartRow - 1)].Value = Invoice_lblColTotalPrice;


                                if (offer._ExportOfferInvoiceLst.Count() > 1)
                                    wsInvoice.Rows.Insert(Invoice_ItemsHeadingStartRow + 1, offer._ExportOfferInvoiceLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                                if (offer._ExportOfferInvoiceLst != null)
                                    foreach (ExportOfferQuotation item in offer._ExportOfferInvoiceLst)
                                    {
                                        if (item.Description.Equals("Discount"))
                                        {
                                            wsInvoice.Cells[Invoice_ItemItemColumn + Invoice_ItemsStartRow].Value = item.Item;
                                            wsInvoice.Cells[Invoice_ItemDescriptionColumn + Invoice_ItemsStartRow].Value = (Index_lblDiscount + " (" + item.Discount + "%)");
                                            wsInvoice.Cells[Invoice_ItemUnitPriceColumn + Invoice_ItemsStartRow].Value = item.UnitPrice;
                                            wsInvoice.Cells[Invoice_ItemQuantityColumn + Invoice_ItemsStartRow].Value = item.Qty;
                                            wsInvoice.Rows[(Invoice_ItemsStartRow - 1)].Font.Bold = true;

                                            if (Technical_Assistance_ItemsStartRow / 2 == 0)
                                            {
                                                //wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                //wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                wsInvoice.Cells[Invoice_ItemUnitPriceColumn + Invoice_ItemsStartRow].Font.Color = Color.White;
                                                wsInvoice.Cells[Invoice_ItemUnitPriceColumn + Invoice_ItemsStartRow].FillColor = Color.White;
                                                wsInvoice.Cells[Invoice_ItemQuantityColumn + Invoice_ItemsStartRow].Font.Color = Color.White;
                                                wsInvoice.Cells[Invoice_ItemQuantityColumn + Invoice_ItemsStartRow].FillColor = Color.White;
                                            }
                                            else
                                            {
                                                wsInvoice.Cells[Invoice_ItemUnitPriceColumn + Invoice_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                wsInvoice.Cells[Invoice_ItemQuantityColumn + Invoice_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                            }

                                        }
                                        else //if (!item.Discount.Equals("Discount"))
                                        {
                                            wsInvoice.Cells[Invoice_ItemItemColumn + Invoice_ItemsStartRow].Value = item.Item;
                                            wsInvoice.Cells[Invoice_ItemReferenceColumn + Invoice_ItemsStartRow].Value = item.Reference;
                                            // string customercommet = (item.Description + "\n " + "[" + item.Comments + "]").ToString();
                                            //string customercommet = (item.Description + "\n" + item.Comments).ToString();
                                            //wsInvoice.Cells[Invoice_ItemDescriptionColumn + Invoice_ItemsStartRow].Value = customercommet;//item.Description;
                                            #region richTextCustomerCommet
                                            RichTextString richText = new RichTextString();
                                            SpreadsheetFont cellFont = wsInvoice.Cells[Invoice_ItemDescriptionColumn + Invoice_ItemsStartRow].Font;
                                            if (item.Description != string.Empty)
                                            {
                                                richText.AddTextRun(item.Description, new RichTextRunFont(cellFont.Name, cellFont.Size, cellFont.Color));
                                            }
                                            if (item.Comments != string.Empty)
                                            {
                                                richText.AddTextRun("\n", new RichTextRunFont(cellFont.Name, cellFont.Size, cellFont.Color));
                                                RichTextRunFont RichText = new RichTextRunFont(cellFont.Name, (cellFont.Size - 1), cellFont.Color);
                                                RichText.Italic = true;
                                                richText.AddTextRun(item.Comments, RichText);
                                            }
                                            wsInvoice.Cells[Invoice_ItemDescriptionColumn + Invoice_ItemsStartRow].SetRichText(richText);
                                            #endregion
                                            wsInvoice.Cells[Invoice_ItemUnitPriceColumn + Invoice_ItemsStartRow].Value = item.UnitPrice;
                                            wsInvoice.Cells[Invoice_ItemQuantityColumn + Invoice_ItemsStartRow].Value = item.Qty;
                                        }
                                        Invoice_ItemsStartRow = Invoice_ItemsStartRow + 1;
                                    }
                                wsInvoice.Rows.Remove(Invoice_ItemsStartRow + 3, 1048575 - (Invoice_ItemsStartRow + 2));
                                workbook.Worksheets[2].Visible = false;
                            }
                            else
                            {
                                workbook.Worksheets[2].Visible = false;
                            }
                            #endregion

                            #region Technical_Assistance

                            if (offer._ExportOfferTechnicalAssistanceLst != null)
                            {
                                int rowTechnicalAssistance = 5;
                                Int32 Technical_Assistance_ItemsHeadingStartRow = Convert.ToInt32(Technical_count) - 1;

                                Worksheet wsTechnicalAssistance = workbook.Worksheets[3];
                                wsTechnicalAssistance.Cells[Technical_Assistance_ItemItemColumn + (Technical_Assistance_ItemsStartRow - 1)].Value = Technical_Assistance_lblColItem;
                                wsTechnicalAssistance.Cells[Technical_Assistance_ItemReferenceColumn + (Technical_Assistance_ItemsStartRow - 1)].Value = Technical_Assistance_lblColReference;
                                wsTechnicalAssistance.Cells[Technical_Assistance_ItemDescriptionColumn + (Technical_Assistance_ItemsStartRow - 1)].Value = Technical_Assistance_lblColDescription;
                                wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + (Technical_Assistance_ItemsStartRow - 1)].Value = Technical_Assistance_lblColUnitPrice;
                                wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + (Technical_Assistance_ItemsStartRow - 1)].Value = Technical_Assistance_lblColQuantity;
                                wsTechnicalAssistance.Cells[Technical_Assistance_ItemTotalPrice + (Technical_Assistance_ItemsStartRow - 1)].Value = Technical_Assistance_lblColTotalPrice;


                                if (offer._ExportOfferTechnicalAssistanceLst.Count() > 1)
                                    wsTechnicalAssistance.Rows.Insert(Technical_Assistance_ItemsHeadingStartRow + 1, offer._ExportOfferTechnicalAssistanceLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                                if (offer._ExportOfferTechnicalAssistanceLst != null)
                                    foreach (ExportOfferQuotation item in offer._ExportOfferTechnicalAssistanceLst)
                                    {
                                        if (item.Description.Equals("Discount"))
                                        {
                                            wsTechnicalAssistance.Cells[Technical_Assistance_ItemItemColumn + Technical_Assistance_ItemsStartRow].Value = item.Item;
                                            wsTechnicalAssistance.Cells[Technical_Assistance_ItemDescriptionColumn + Technical_Assistance_ItemsStartRow].Value = (Index_lblDiscount + " (" + item.Discount + "%)");
                                            wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Value = item.UnitPrice;
                                            wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Value = item.Qty;
                                            wsTechnicalAssistance.Rows[(Technical_Assistance_ItemsStartRow - 1)].Font.Bold = true;

                                            if (Technical_Assistance_ItemsStartRow / 2 == 0)
                                            {
                                                //wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                //wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.White;
                                                wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].FillColor = Color.White;
                                                wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.White;
                                                wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].FillColor = Color.White;
                                            }
                                            else
                                            {
                                                wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                            }
                                        }
                                        else //if (!item.Discount.Equals("Discount"))
                                        {
                                            wsTechnicalAssistance.Cells[Technical_Assistance_ItemItemColumn + Technical_Assistance_ItemsStartRow].Value = item.Item;
                                            wsTechnicalAssistance.Cells[Technical_Assistance_ItemReferenceColumn + Technical_Assistance_ItemsStartRow].Value = item.Reference;
                                            ////string customercommet = (item.Description + "\n " + "[" +item.Comments + "]").ToString();
                                            //string customercommet = (item.Description + "\n" + item.Comments).ToString();
                                            //wsTechnicalAssistance.Cells[Technical_Assistance_ItemDescriptionColumn + Technical_Assistance_ItemsStartRow].Value = customercommet; //item.Description;
                                            #region richTextCustomerCommet
                                            RichTextString richText = new RichTextString();
                                            SpreadsheetFont cellFont = wsTechnicalAssistance.Cells[Technical_Assistance_ItemDescriptionColumn + Technical_Assistance_ItemsStartRow].Font;
                                            if (item.Description != string.Empty)
                                            {
                                                richText.AddTextRun(item.Description, new RichTextRunFont(cellFont.Name, cellFont.Size, cellFont.Color));
                                            }
                                            if (item.Comments != string.Empty)
                                            {
                                                richText.AddTextRun("\n", new RichTextRunFont(cellFont.Name, cellFont.Size, cellFont.Color));
                                                RichTextRunFont RichText = new RichTextRunFont(cellFont.Name, (cellFont.Size - 1), cellFont.Color);
                                                RichText.Italic = true;
                                                richText.AddTextRun(item.Comments, RichText);
                                            }
                                            wsTechnicalAssistance.Cells[Technical_Assistance_ItemDescriptionColumn + Technical_Assistance_ItemsStartRow].SetRichText(richText);
                                            #endregion
                                            wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Value = item.UnitPrice;
                                            wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Value = item.Qty;
                                        }
                                        rowTechnicalAssistance = rowTechnicalAssistance + 1;
                                        Technical_Assistance_ItemsStartRow = Technical_Assistance_ItemsStartRow + 1;
                                    }
                                wsTechnicalAssistance.Rows.Remove(Technical_Assistance_ItemsStartRow + 3, 1048575 - (Technical_Assistance_ItemsStartRow + 2));
                            }
                            else
                            {
                                workbook.Worksheets[3].Visible = false;
                            }
                            #endregion

                            #region Component                            
                            //https://helpdesk.emdep.com/browse/APIGEOS-269
                            if (offer._ExportOfferComponentLst != null)
                            {
                                Worksheet wsComponent = workbook.Worksheets[4];
                                wsComponent.Cells[Component_ItemItemColumn + (Component_ItemsStartRow - 1)].Value = Component_lblColItem;
                                wsComponent.Cells[Component_ItemReferenceColumn + (Component_ItemsStartRow - 1)].Value = Component_lblColReference;
                                wsComponent.Cells[Component_ItemNameColumn + (Component_ItemsStartRow - 1)].Value = Component_lblColName;
                                wsComponent.Cells[Component_ItemUnitPriceColumn + (Component_ItemsStartRow - 1)].Value = Component_lblColUnitPrice;
                                wsComponent.Cells[Component_ItemQuantityColumn + (Component_ItemsStartRow - 1)].Value = Component_lblColQuantity;
                                wsComponent.Cells[Component_ItemTotalPrice + (Component_ItemsStartRow - 1)].Value = Component_lblColTotalPrice;
                                wsComponent.Cells[Component_ItemRemarksColumn + (Component_ItemsStartRow - 1)].Value = Component_Comments;

                                Int32 Component_ItemsHeadingStartRow = Convert.ToInt32(Component_count) - 1;
                                if (offer._ExportOfferComponentLst.Count() > 1)
                                    wsComponent.Rows.Insert(Component_ItemsHeadingStartRow + 1, offer._ExportOfferComponentLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                                if (offer._ExportOfferComponentLst != null)
                                    foreach (ExportOfferComponent item in offer._ExportOfferComponentLst)
                                    {
                                        if (item.Name.Equals("Discount"))
                                        {
                                            wsComponent.Cells[Component_ItemItemColumn + Component_ItemsStartRow].Value = item.Item;
                                            wsComponent.Cells[Component_ItemNameColumn + Component_ItemsStartRow].Value = (Index_lblDiscount + " (" + item.Discount + "%)");
                                            wsComponent.Cells[Component_ItemUnitPriceColumn + Component_ItemsStartRow].Value = item.UnitPrice;
                                            wsComponent.Cells[Component_ItemQuantityColumn + Component_ItemsStartRow].Value = item.Qty;
                                            wsComponent.Rows[(Component_ItemsStartRow - 1)].Font.Bold = true;
                                            if (Technical_Assistance_ItemsStartRow / 2 == 0)
                                            {
                                                //wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                //wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                wsComponent.Cells[Component_ItemUnitPriceColumn + Component_ItemsStartRow].Font.Color = Color.White;
                                                wsComponent.Cells[Component_ItemUnitPriceColumn + Component_ItemsStartRow].FillColor = Color.White;
                                                wsComponent.Cells[Component_ItemQuantityColumn + Component_ItemsStartRow].Font.Color = Color.White;
                                                wsComponent.Cells[Component_ItemQuantityColumn + Component_ItemsStartRow].FillColor = Color.White;
                                            }
                                            else
                                            {
                                                wsComponent.Cells[Component_ItemUnitPriceColumn + Component_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                wsComponent.Cells[Component_ItemQuantityColumn + Component_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                            }
                                        }
                                        else //if (!item.Discount.Equals("Discount"))
                                        {
                                            wsComponent.Cells[Component_ItemItemColumn + Component_ItemsStartRow].Value = item.Item;
                                            wsComponent.Cells[Component_ItemReferenceColumn + Component_ItemsStartRow].Value = item.Reference;
                                            string listTOStr = string.Join(";", item.features.Select(s => s.Name).DefaultIfEmpty(string.Empty));
                                            wsComponent.Cells[Component_ItemNameColumn + Component_ItemsStartRow].Value = listTOStr;
                                            //wsComponent.Cells[Component_ItemNameColumn + Component_ItemsStartRow].Value = item.Name;
                                            wsComponent.Cells[Component_ItemRemarksColumn + Component_ItemsStartRow].Value = item.Comments;
                                            wsComponent.Cells[Component_ItemUnitPriceColumn + Component_ItemsStartRow].Value = item.UnitPrice;
                                            wsComponent.Cells[Component_ItemQuantityColumn + Component_ItemsStartRow].Value = item.Qty;
                                        }
                                        Component_ItemsStartRow = Component_ItemsStartRow + 1;
                                    }
                                wsComponent.Rows.Remove(Component_ItemsStartRow + 3, 1048575 - (Component_ItemsStartRow + 3));
                            }
                            else
                            {
                                workbook.Worksheets[4].Visible = false;
                            }
                            #endregion

                            #region chitra.girigosavi APIGEOS-1171 Changes when generating the offer for Counterpart type items
                            try
                            {
                                #region pneumatic                          
                                //https://helpdesk.emdep.com/browse/APIGEOS-269
                                if (offer._ExportOfferPneumaticLst != null)
                                {
                                    Worksheet wsModule = workbook.Worksheets[5];

                                    int module_ItemsStartRow = Module_ItemsStartRow;
                                    List<string> distinctFeatures = new List<string>();
                                    Dictionary<string, int> distinctFeaturesAndSortOrder = new Dictionary<string, int>();
                                    Dictionary<int, string> distinctFeaturesWithId = new Dictionary<int, string>();
                                    //List<Tuple<int, string, int>> featuresAndSortOrder = new List<Tuple<int, string, int>>();
                                    List<Tuple<int, string, int, int>> featuresAndSortOrder = new List<Tuple<int, string, int, int>>();
                                    int featureNumber = 1;
                                    foreach (ExportOfferComponent item in offer._ExportOfferPneumaticLst)
                                    {
                                        if (item.TemplateName != "Component")
                                        {

                                            foreach (var feature in item.features)
                                            {
                                                if (!distinctFeatures.Contains(feature.Name))
                                                {
                                                    distinctFeatures.Add(feature.Name);
                                                    distinctFeaturesWithId.Add(featureNumber, feature.Name);
                                                    featuresAndSortOrder.Add(Tuple.Create(featureNumber, feature.Name, feature.SortOrder, Convert.ToInt32(item.Item)));
                                                    featureNumber = featureNumber + 1;
                                                }
                                            }
                                        }
                                    }
                                    // Sort the featuresAndSortOrder list by the SortOrder
                                    featuresAndSortOrder = featuresAndSortOrder.OrderBy(t => t.Item3).ToList();
                                    // Sort by t.Item3 first, then by t.Item2
                                    //featuresAndSortOrder = featuresAndSortOrder.OrderBy(t => t.Item3).ThenBy(t => t.Item2).ThenBy(t => t.Item4).ToList();
                                    // Convert to Dictionary<int, Tuple<string, int>>
                                    Dictionary<int, string> FeaturesWithId = featuresAndSortOrder.ToDictionary(t => t.Item1, t => t.Item2);
                                    distinctFeatures = FeaturesWithId.Values.ToList();
                                    //int columnNumber = 1; 
                                    //foreach (string featureName in distinctFeatures)
                                    //{
                                    //    //wsModule.Cells[1, columnNumber].Value = 
                                    //    wsModule.Cells[Module_ItemDetStartColumn + (Module_ItemsStartRow - 1)].Value= featureName;
                                    //    columnNumber++;
                                    //}
                                    // wsModule.Cells.AutoFitColumns();

                                    wsModule.Cells[Module_ItemItemColumn + (Module_ItemsStartRow - 1)].Value = Pneumatic_lblColItem;
                                    wsModule.Cells[Module_ItemReferenceColumn + (Module_ItemsStartRow - 1)].Value = Pneumatic_lblColReference;
                                    wsModule.Cells[Module_ItemNameColumn + (Module_ItemsStartRow - 1)].Value = Pneumatic_lblColName;
                                    wsModule.Cells[Module_ItemUnitPriceColumn + (Module_ItemsStartRow - 1)].Value = Pneumatic_lblColUnitPrice;
                                    wsModule.Cells[Module_ItemQuantityColumn + (Module_ItemsStartRow - 1)].Value = Pneumatic_lblColQuantity;
                                    wsModule.Cells[Module_ItemTotalPrice + (Module_ItemsStartRow - 1)].Value = Pneumatic_lblColTotalPrice;
                                    wsModule.Cells[Module_ItemCommentsColumn + (Module_ItemsStartRow - 1)].Value = Pneumatic_lblColRemarks;

                                    HashSet<string> processedReferences = new HashSet<string>();
                                    Int32 Module_ItemsHeadingStartRow = Convert.ToInt32(Module_count) - 1;
                                    if (offer._ExportOfferPneumaticLst.Count() > 1)
                                        wsModule.Rows.Insert(Module_ItemsHeadingStartRow + 1, offer._ExportOfferPneumaticLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                                    if (offer._ExportOfferPneumaticLst != null)
                                        foreach (ExportOfferComponent item in offer._ExportOfferPneumaticLst)
                                        {
                                            if (item.Name.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = (Index_lblDiscount + " (" + item.Discount + "%)");
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Rows[(Module_ItemsStartRow - 1)].Font.Bold = true;
                                                if (Module_ItemsStartRow / 2 == 0)
                                                {
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                }
                                                else
                                                {
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                }
                                            }
                                            else
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemReferenceColumn + Module_ItemsStartRow].Value = item.Reference;
                                                //wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.TemplateName + "\n" + item.Name;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.Name;
                                                wsModule.Cells[Module_ItemCommentsColumn + Module_ItemsStartRow].Value = item.Comments;
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Cells[Module_ItemTotalPrice + Module_ItemsStartRow].Value = item.Qty * item.UnitPrice;
                                                string listTOStr = string.Join(";", item.features.Select(s => s.Quantity.HasValue ? s.Quantity.Value.ToString() : " "));

                                                processedReferences.Add(item.Reference);
                                            }
                                            Module_ItemsStartRow = Module_ItemsStartRow + 1;
                                        }
                                    // Calculate and write the subtotal
                                    int lastTotalPriceRow = Module_ItemsStartRow - 1;
                                    int subtotalRow = lastTotalPriceRow + 3; // Two rows below the last total price

                                    // Assuming the total price is in the column specified by Module_ItemTotalPrice
                                    string startCellAddress = $"{Module_ItemTotalPrice}{module_ItemsStartRow}";
                                    string endCellAddress = $"{Module_ItemTotalPrice}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";

                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Calculate();
                                    // 2. Update the formula in the desired cell (if needed)
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";
                                    string startCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{module_ItemsStartRow}";
                                    string endCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Formula = $"SUM({startCellAddressQuantityColumn}:{endCellAddressQuantityColumn})";
                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Calculate();
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Calculate();

                                    wsModule.Rows.Remove(Module_ItemsStartRow + 3, 1048575 - (Module_ItemsStartRow + 3));

                                    Module_ItemsStartRow = module_ItemsStartRow;
                                    if (offer._ExportOfferPneumaticLst != null)
                                    {
                                        int columnNumber = 1;
                                        int columnIndex = Module_ItemsStartRow - 2;
                                        //// Copy the style from the original column (E is index 4, so D is index 3)
                                        //int sourceIndex = Module_ItemsStartRow - 2;
                                        //// Use the CopyFrom method to copy the styles from the source column to the target column
                                        //wsModule.Columns[Module_ItemsStartRow].CopyFrom(wsModule.Columns[sourceIndex], PasteSpecial.Formats);
                                        foreach (string featureName in distinctFeatures)
                                        {
                                            if (columnNumber == 1)
                                            {
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                            else
                                            {
                                                //wsModule.Columns[Module_ItemDetStartColumn + (Module_ItemsStartRow - 1)].Insert();
                                                wsModule.Columns[columnIndex].Insert();
                                                //// Use the CopyFrom method to copy the styles from the source column to the target column
                                                //wsModule.Columns[Module_ItemsStartRow - 2].CopyFrom(wsModule.Columns[columnIndex + 1], PasteSpecial.Formats);
                                                wsModule.Columns[columnIndex].CopyFrom(wsModule.Columns[Module_ItemsStartRow - 2], PasteSpecial.Formats);
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                        }
                                        Int32 itemsStartRow = Module_ItemsStartRow;
                                        foreach (ExportOfferComponent exportOfferModuleLst in offer._ExportOfferPneumaticLst)
                                        {
                                            if (exportOfferModuleLst.features != null)
                                            {
                                                foreach (Createitemsfeatures featureName in exportOfferModuleLst.features)
                                                {
                                                    if (distinctFeaturesWithId.Any(a => a.Value.ToLower().Equals(featureName.Name.ToLower())))
                                                    {
                                                        //var featuresWithId = distinctFeaturesWithId.Where(a => a.Value.ToLower().Equals(featureName.Name.ToLower())).FirstOrDefault().Key;
                                                        int featuresWithId = distinctFeatures.IndexOf(featureName.Name) + 1;
                                                        char ModuleDetStartColumn = Convert.ToChar(Module_ItemDetStartColumn);
                                                        char previews = (char)(((int)ModuleDetStartColumn) - 1);
                                                        char letter = (char)(((int)previews) + featuresWithId);
                                                        //char nextChar = (char)(((int)letter) + featuresWithId);
                                                        //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = featureName.Quantity;
                                                        columnIndex = (Module_ItemsStartRow - 2) + featuresWithId;
                                                        //wsModule.Cells[(Module_ItemsStartRow - 1), columnIndex].Value = featureName.Quantity;
                                                        string Setcell = string.Format("{0}{1}", letter, itemsStartRow);
                                                        wsModule.Cells[Setcell].Value = featureName.Quantity;
                                                    }
                                                }
                                                itemsStartRow = itemsStartRow + 1;
                                            }
                                            //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = listTOStr;
                                        }
                                    }

                                }
                                else
                                {
                                    workbook.Worksheets[5].Visible = false;
                                }
                                #endregion
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error ExportOffer(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            }
                            try
                            {
                                #region Assembly
                                //https://helpdesk.emdep.com/browse/APIGEOS-269
                                if (offer._ExportOfferAssemblyLst != null)
                                {
                                    Worksheet wsModule = workbook.Worksheets[6];

                                    int module_ItemsStartRow = Module_ItemsStartRow;
                                    List<string> distinctFeatures = new List<string>();
                                    Dictionary<int, string> distinctFeaturesWithId = new Dictionary<int, string>();
                                    List<Tuple<int, string, int>> featuresAndSortOrder = new List<Tuple<int, string, int>>();
                                    int featureNumber = 1;
                                    foreach (ExportOfferComponent item in offer._ExportOfferAssemblyLst)
                                    {
                                        if (item.TemplateName != "Component")
                                        {

                                            foreach (var feature in item.features)
                                            {
                                                if (!distinctFeatures.Contains(feature.Name))
                                                {
                                                    distinctFeatures.Add(feature.Name);
                                                    //distinctFeaturesWithId.Add(featureNumber, feature.Name);
                                                    featuresAndSortOrder.Add(Tuple.Create(featureNumber, feature.Name, feature.SortOrder));
                                                    featureNumber = featureNumber + 1;
                                                }
                                            }
                                        }
                                    }
                                    // Sort the featuresAndSortOrder list by the SortOrder
                                    featuresAndSortOrder = featuresAndSortOrder.OrderBy(t => t.Item3).ToList();
                                    // Convert to Dictionary<int, Tuple<string, int>>
                                    distinctFeaturesWithId = featuresAndSortOrder.ToDictionary(t => t.Item1, t => t.Item2);
                                    distinctFeatures = distinctFeaturesWithId.Values.ToList();
                                    //int columnNumber = 1; 
                                    //foreach (string featureName in distinctFeatures)
                                    //{
                                    //    //wsModule.Cells[1, columnNumber].Value = 
                                    //    wsModule.Cells[Module_ItemDetStartColumn + (Module_ItemsStartRow - 1)].Value= featureName;
                                    //    columnNumber++;
                                    //}
                                    //wsModule.Cells.AutoFitColumns();

                                    wsModule.Cells[Module_ItemItemColumn + (Module_ItemsStartRow - 1)].Value = Assembly_lblColItem;
                                    wsModule.Cells[Module_ItemReferenceColumn + (Module_ItemsStartRow - 1)].Value = Assembly_lblColReference;
                                    wsModule.Cells[Module_ItemNameColumn + (Module_ItemsStartRow - 1)].Value = Assembly_lblColName;
                                    wsModule.Cells[Module_ItemUnitPriceColumn + (Module_ItemsStartRow - 1)].Value = Assembly_lblColUnitPrice;
                                    wsModule.Cells[Module_ItemQuantityColumn + (Module_ItemsStartRow - 1)].Value = Assembly_lblColQuantity;
                                    wsModule.Cells[Module_ItemTotalPrice + (Module_ItemsStartRow - 1)].Value = Assembly_lblColTotalPrice;
                                    wsModule.Cells[Module_ItemCommentsColumn + (Module_ItemsStartRow - 1)].Value = Assembly_lblColRemarks;

                                    HashSet<string> processedReferences = new HashSet<string>();
                                    Int32 Module_ItemsHeadingStartRow = Convert.ToInt32(Module_count) - 1;
                                    if (offer._ExportOfferAssemblyLst.Count() > 1)
                                        wsModule.Rows.Insert(Module_ItemsHeadingStartRow + 1, offer._ExportOfferAssemblyLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                                    if (offer._ExportOfferAssemblyLst != null)
                                        foreach (ExportOfferComponent item in offer._ExportOfferAssemblyLst)
                                        {
                                            if (item.Name.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = (Index_lblDiscount + " (" + item.Discount + "%)");
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Rows[(Module_ItemsStartRow - 1)].Font.Bold = true;
                                                if (Module_ItemsStartRow / 2 == 0)
                                                {
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                }
                                                else
                                                {
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                }
                                            }
                                            else //if (!item.Discount.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemReferenceColumn + Module_ItemsStartRow].Value = item.Reference;
                                                //wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.TemplateName + "\n" + item.Name;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.Name;
                                                wsModule.Cells[Module_ItemCommentsColumn + Module_ItemsStartRow].Value = item.Comments;
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Cells[Module_ItemTotalPrice + Module_ItemsStartRow].Value = item.Qty * item.UnitPrice;
                                                string listTOStr = string.Join(";", item.features.Select(s => s.Quantity.HasValue ? s.Quantity.Value.ToString() : " "));

                                                processedReferences.Add(item.Reference);
                                            }
                                            Module_ItemsStartRow = Module_ItemsStartRow + 1;
                                        }
                                    // Calculate and write the subtotal
                                    int lastTotalPriceRow = Module_ItemsStartRow - 1;
                                    int subtotalRow = lastTotalPriceRow + 3; // Two rows below the last total price

                                    // Assuming the total price is in the column specified by Module_ItemTotalPrice
                                    string startCellAddress = $"{Module_ItemTotalPrice}{module_ItemsStartRow}";
                                    string endCellAddress = $"{Module_ItemTotalPrice}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";

                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Calculate();
                                    // 2. Update the formula in the desired cell (if needed)
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";
                                    string startCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{module_ItemsStartRow}";
                                    string endCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Formula = $"SUM({startCellAddressQuantityColumn}:{endCellAddressQuantityColumn})";
                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Calculate();
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Calculate();

                                    wsModule.Rows.Remove(Module_ItemsStartRow + 3, 1048575 - (Module_ItemsStartRow + 3));

                                    Module_ItemsStartRow = module_ItemsStartRow;
                                    if (offer._ExportOfferAssemblyLst != null)
                                    {
                                        int columnNumber = 1;
                                        int columnIndex = Module_ItemsStartRow - 2;
                                        //// Copy the style from the original column (E is index 4, so D is index 3)
                                        //int sourceIndex = Module_ItemsStartRow - 2;
                                        //// Use the CopyFrom method to copy the styles from the source column to the target column
                                        //wsModule.Columns[Module_ItemsStartRow].CopyFrom(wsModule.Columns[sourceIndex], PasteSpecial.Formats);
                                        foreach (string featureName in distinctFeatures)
                                        {
                                            if (columnNumber == 1)
                                            {
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                            else
                                            {
                                                //wsModule.Columns[Module_ItemDetStartColumn + (Module_ItemsStartRow - 1)].Insert();
                                                wsModule.Columns[columnIndex].Insert();
                                                //// Use the CopyFrom method to copy the styles from the source column to the target column
                                                //wsModule.Columns[Module_ItemsStartRow - 2].CopyFrom(wsModule.Columns[columnIndex + 1], PasteSpecial.Formats);
                                                wsModule.Columns[columnIndex].CopyFrom(wsModule.Columns[Module_ItemsStartRow - 2], PasteSpecial.Formats);
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                        }
                                        Int32 itemsStartRow = Module_ItemsStartRow;
                                        foreach (ExportOfferComponent exportOfferModuleLst in offer._ExportOfferAssemblyLst)
                                        {
                                            if (exportOfferModuleLst.features != null)
                                            {
                                                foreach (Createitemsfeatures featureName in exportOfferModuleLst.features)
                                                {
                                                    if (distinctFeaturesWithId.Any(a => a.Value.ToLower().Equals(featureName.Name.ToLower())))
                                                    {
                                                        //var featuresWithId = distinctFeaturesWithId.Where(a => a.Value.ToLower().Equals(featureName.Name.ToLower())).FirstOrDefault().Key;
                                                        int featuresWithId = distinctFeatures.IndexOf(featureName.Name) + 1;
                                                        char ModuleDetStartColumn = Convert.ToChar(Module_ItemDetStartColumn);
                                                        char previews = (char)(((int)ModuleDetStartColumn) - 1);
                                                        char letter = (char)(((int)previews) + featuresWithId);
                                                        //char nextChar = (char)(((int)letter) + featuresWithId);
                                                        //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = featureName.Quantity;
                                                        columnIndex = (Module_ItemsStartRow - 2) + featuresWithId;
                                                        //wsModule.Cells[(Module_ItemsStartRow - 1), columnIndex].Value = featureName.Quantity;
                                                        string Setcell = string.Format("{0}{1}", letter, itemsStartRow);
                                                        wsModule.Cells[Setcell].Value = featureName.Quantity;
                                                    }
                                                }
                                                itemsStartRow = itemsStartRow + 1;
                                            }
                                            //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = listTOStr;
                                        }
                                    }

                                }
                                else
                                {
                                    workbook.Worksheets[6].Visible = false;
                                }
                                #endregion
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error ExportOffer(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            }
                            try
                            {
                                #region ElectricControl
                                //https://helpdesk.emdep.com/browse/APIGEOS-269
                                if (offer._ExportOfferElectric_ControlLst != null)
                                {
                                    Worksheet wsModule = workbook.Worksheets[7];

                                    int module_ItemsStartRow = Module_ItemsStartRow;
                                    List<string> distinctFeatures = new List<string>();
                                    Dictionary<int, string> distinctFeaturesWithId = new Dictionary<int, string>();
                                    List<Tuple<int, string, int>> featuresAndSortOrder = new List<Tuple<int, string, int>>();
                                    int featureNumber = 1;
                                    foreach (ExportOfferComponent item in offer._ExportOfferElectric_ControlLst)
                                    {
                                        if (item.TemplateName != "Component")
                                        {

                                            foreach (var feature in item.features)
                                            {
                                                if (!distinctFeatures.Contains(feature.Name))
                                                {
                                                    distinctFeatures.Add(feature.Name);
                                                    //distinctFeaturesWithId.Add(featureNumber, feature.Name);
                                                    featuresAndSortOrder.Add(Tuple.Create(featureNumber, feature.Name, feature.SortOrder));
                                                    featureNumber = featureNumber + 1;
                                                }
                                            }
                                        }
                                    }
                                    // Sort the featuresAndSortOrder list by the SortOrder
                                    featuresAndSortOrder = featuresAndSortOrder.OrderBy(t => t.Item3).ToList();
                                    // Convert to Dictionary<int, Tuple<string, int>>
                                    distinctFeaturesWithId = featuresAndSortOrder.ToDictionary(t => t.Item1, t => t.Item2);
                                    distinctFeatures = distinctFeaturesWithId.Values.ToList();
                                    //int columnNumber = 1; 
                                    //foreach (string featureName in distinctFeatures)
                                    //{
                                    //    //wsModule.Cells[1, columnNumber].Value = 
                                    //    wsModule.Cells[Module_ItemDetStartColumn + (Module_ItemsStartRow - 1)].Value= featureName;
                                    //    columnNumber++;
                                    //}
                                    //wsModule.Cells.AutoFitColumns();

                                    wsModule.Cells[Module_ItemItemColumn + (Module_ItemsStartRow - 1)].Value = ElectricControl_lblColItem;
                                    wsModule.Cells[Module_ItemReferenceColumn + (Module_ItemsStartRow - 1)].Value = ElectricControl_lblColReference;
                                    wsModule.Cells[Module_ItemNameColumn + (Module_ItemsStartRow - 1)].Value = ElectricControl_lblColName;
                                    wsModule.Cells[Module_ItemUnitPriceColumn + (Module_ItemsStartRow - 1)].Value = ElectricControl_lblColUnitPrice;
                                    wsModule.Cells[Module_ItemQuantityColumn + (Module_ItemsStartRow - 1)].Value = ElectricControl_lblColQuantity;
                                    wsModule.Cells[Module_ItemTotalPrice + (Module_ItemsStartRow - 1)].Value = ElectricControl_lblColTotalPrice;
                                    wsModule.Cells[Module_ItemCommentsColumn + (Module_ItemsStartRow - 1)].Value = ElectricControl_lblColRemarks;

                                    HashSet<string> processedReferences = new HashSet<string>();
                                    Int32 Module_ItemsHeadingStartRow = Convert.ToInt32(Module_count) - 1;
                                    if (offer._ExportOfferElectric_ControlLst.Count() > 1)
                                        wsModule.Rows.Insert(Module_ItemsHeadingStartRow + 1, offer._ExportOfferElectric_ControlLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                                    if (offer._ExportOfferElectric_ControlLst != null)
                                        foreach (ExportOfferComponent item in offer._ExportOfferElectric_ControlLst)
                                        {
                                            if (item.Name.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = (Index_lblDiscount + " (" + item.Discount + "%)");
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Rows[(Module_ItemsStartRow - 1)].Font.Bold = true;
                                                if (Module_ItemsStartRow / 2 == 0)
                                                {
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                }
                                                else
                                                {
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                }
                                            }
                                            else //if (!item.Discount.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemReferenceColumn + Module_ItemsStartRow].Value = item.Reference;
                                                //wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.TemplateName + "\n" + item.Name;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.Name;
                                                wsModule.Cells[Module_ItemCommentsColumn + Module_ItemsStartRow].Value = item.Comments;
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Cells[Module_ItemTotalPrice + Module_ItemsStartRow].Value = item.Qty * item.UnitPrice;
                                                string listTOStr = string.Join(";", item.features.Select(s => s.Quantity.HasValue ? s.Quantity.Value.ToString() : " "));
                                                processedReferences.Add(item.Reference);
                                            }
                                            Module_ItemsStartRow = Module_ItemsStartRow + 1;
                                        }
                                    // Calculate and write the subtotal
                                    int lastTotalPriceRow = Module_ItemsStartRow - 1;
                                    int subtotalRow = lastTotalPriceRow + 3; // Two rows below the last total price

                                    // Assuming the total price is in the column specified by Module_ItemTotalPrice
                                    string startCellAddress = $"{Module_ItemTotalPrice}{module_ItemsStartRow}";
                                    string endCellAddress = $"{Module_ItemTotalPrice}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";

                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Calculate();
                                    // 2. Update the formula in the desired cell (if needed)
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";
                                    string startCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{module_ItemsStartRow}";
                                    string endCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Formula = $"SUM({startCellAddressQuantityColumn}:{endCellAddressQuantityColumn})";
                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Calculate();
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Calculate();

                                    wsModule.Rows.Remove(Module_ItemsStartRow + 3, 1048575 - (Module_ItemsStartRow + 3));

                                    Module_ItemsStartRow = module_ItemsStartRow;
                                    if (offer._ExportOfferElectric_ControlLst != null)
                                    {
                                        int columnNumber = 1;
                                        int columnIndex = Module_ItemsStartRow - 2;
                                        //// Copy the style from the original column (E is index 4, so D is index 3)
                                        //int sourceIndex = Module_ItemsStartRow - 2;
                                        //// Use the CopyFrom method to copy the styles from the source column to the target column
                                        //wsModule.Columns[Module_ItemsStartRow].CopyFrom(wsModule.Columns[sourceIndex], PasteSpecial.Formats);
                                        foreach (string featureName in distinctFeatures)
                                        {
                                            if (columnNumber == 1)
                                            {
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                            else
                                            {
                                                //wsModule.Columns[Module_ItemDetStartColumn + (Module_ItemsStartRow - 1)].Insert();
                                                wsModule.Columns[columnIndex].Insert();
                                                //// Use the CopyFrom method to copy the styles from the source column to the target column
                                                //wsModule.Columns[Module_ItemsStartRow - 2].CopyFrom(wsModule.Columns[columnIndex + 1], PasteSpecial.Formats);
                                                wsModule.Columns[columnIndex].CopyFrom(wsModule.Columns[Module_ItemsStartRow - 2], PasteSpecial.Formats);
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                        }
                                        Int32 itemsStartRow = Module_ItemsStartRow;
                                        foreach (ExportOfferComponent exportOfferModuleLst in offer._ExportOfferElectric_ControlLst)
                                        {
                                            if (exportOfferModuleLst.features != null)
                                            {
                                                foreach (Createitemsfeatures featureName in exportOfferModuleLst.features)
                                                {
                                                    if (distinctFeaturesWithId.Any(a => a.Value.ToLower().Equals(featureName.Name.ToLower())))
                                                    {
                                                        //var featuresWithId = distinctFeaturesWithId.Where(a => a.Value.ToLower().Equals(featureName.Name.ToLower())).FirstOrDefault().Key;
                                                        int featuresWithId = distinctFeatures.IndexOf(featureName.Name) + 1;
                                                        char ModuleDetStartColumn = Convert.ToChar(Module_ItemDetStartColumn);
                                                        char previews = (char)(((int)ModuleDetStartColumn) - 1);
                                                        char letter = (char)(((int)previews) + featuresWithId);
                                                        //char nextChar = (char)(((int)letter) + featuresWithId);
                                                        //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = featureName.Quantity;
                                                        columnIndex = (Module_ItemsStartRow - 2) + featuresWithId;
                                                        //wsModule.Cells[(Module_ItemsStartRow - 1), columnIndex].Value = featureName.Quantity;
                                                        string Setcell = string.Format("{0}{1}", letter, itemsStartRow);
                                                        wsModule.Cells[Setcell].Value = featureName.Quantity;
                                                    }
                                                }
                                                itemsStartRow = itemsStartRow + 1;
                                            }
                                            //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = listTOStr;
                                        }
                                    }

                                }
                                else
                                {
                                    workbook.Worksheets[7].Visible = false;
                                }
                                #endregion
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error ExportOffer(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            }
                            try
                            {
                                #region Hybrid
                                //https://helpdesk.emdep.com/browse/APIGEOS-269
                                if (offer._ExportOfferHybridLst != null)
                                {
                                    Worksheet wsModule = workbook.Worksheets[8];

                                    int module_ItemsStartRow = Module_ItemsStartRow;
                                    List<string> distinctFeatures = new List<string>();
                                    Dictionary<int, string> distinctFeaturesWithId = new Dictionary<int, string>();
                                    List<Tuple<int, string, int>> featuresAndSortOrder = new List<Tuple<int, string, int>>();
                                    int featureNumber = 1;
                                    foreach (ExportOfferComponent item in offer._ExportOfferHybridLst)
                                    {
                                        if (item.TemplateName != "Component")
                                        {

                                            foreach (var feature in item.features)
                                            {
                                                if (!distinctFeatures.Contains(feature.Name))
                                                {
                                                    distinctFeatures.Add(feature.Name);
                                                    //distinctFeaturesWithId.Add(featureNumber, feature.Name);
                                                    featuresAndSortOrder.Add(Tuple.Create(featureNumber, feature.Name, feature.SortOrder));
                                                    featureNumber = featureNumber + 1;
                                                }
                                            }
                                        }
                                    }
                                    // Sort the featuresAndSortOrder list by the SortOrder
                                    featuresAndSortOrder = featuresAndSortOrder.OrderBy(t => t.Item3).ToList();
                                    // Convert to Dictionary<int, Tuple<string, int>>
                                    distinctFeaturesWithId = featuresAndSortOrder.ToDictionary(t => t.Item1, t => t.Item2);
                                    distinctFeatures = distinctFeaturesWithId.Values.ToList();
                                    //wsModule.Cells.AutoFitColumns();

                                    wsModule.Cells[Module_ItemItemColumn + (Module_ItemsStartRow - 1)].Value = Hybrid_lblColItem;
                                    wsModule.Cells[Module_ItemReferenceColumn + (Module_ItemsStartRow - 1)].Value = Hybrid_lblColReference;
                                    wsModule.Cells[Module_ItemNameColumn + (Module_ItemsStartRow - 1)].Value = Hybrid_lblColName;
                                    wsModule.Cells[Module_ItemUnitPriceColumn + (Module_ItemsStartRow - 1)].Value = Hybrid_lblColUnitPrice;
                                    wsModule.Cells[Module_ItemQuantityColumn + (Module_ItemsStartRow - 1)].Value = Hybrid_lblColQuantity;
                                    wsModule.Cells[Module_ItemTotalPrice + (Module_ItemsStartRow - 1)].Value = Hybrid_lblColTotalPrice;
                                    wsModule.Cells[Module_ItemCommentsColumn + (Module_ItemsStartRow - 1)].Value = Hybrid_lblColRemarks;

                                    HashSet<string> processedReferences = new HashSet<string>();
                                    Int32 Module_ItemsHeadingStartRow = Convert.ToInt32(Module_count) - 1;
                                    if (offer._ExportOfferHybridLst.Count() > 1)
                                        wsModule.Rows.Insert(Module_ItemsHeadingStartRow + 1, offer._ExportOfferHybridLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                                    if (offer._ExportOfferHybridLst != null)
                                        foreach (ExportOfferComponent item in offer._ExportOfferHybridLst)
                                        {
                                            if (item.Name.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = (Index_lblDiscount + " (" + item.Discount + "%)");
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Rows[(Module_ItemsStartRow - 1)].Font.Bold = true;
                                                if (Module_ItemsStartRow / 2 == 0)
                                                {
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                }
                                                else
                                                {
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                }
                                            }
                                            else //if (!item.Discount.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemReferenceColumn + Module_ItemsStartRow].Value = item.Reference;
                                                //wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.TemplateName + "\n" + item.Name;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.Name;
                                                wsModule.Cells[Module_ItemCommentsColumn + Module_ItemsStartRow].Value = item.Comments;
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Cells[Module_ItemTotalPrice + Module_ItemsStartRow].Value = item.Qty * item.UnitPrice;
                                                string listTOStr = string.Join(";", item.features.Select(s => s.Quantity.HasValue ? s.Quantity.Value.ToString() : " "));

                                                processedReferences.Add(item.Reference);
                                            }
                                            Module_ItemsStartRow = Module_ItemsStartRow + 1;
                                        }
                                    // Calculate and write the subtotal
                                    int lastTotalPriceRow = Module_ItemsStartRow - 1;
                                    int subtotalRow = lastTotalPriceRow + 3; // Two rows below the last total price

                                    // Assuming the total price is in the column specified by Module_ItemTotalPrice
                                    string startCellAddress = $"{Module_ItemTotalPrice}{module_ItemsStartRow}";
                                    string endCellAddress = $"{Module_ItemTotalPrice}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";

                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Calculate();
                                    // 2. Update the formula in the desired cell (if needed)
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";
                                    string startCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{module_ItemsStartRow}";
                                    string endCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Formula = $"SUM({startCellAddressQuantityColumn}:{endCellAddressQuantityColumn})";
                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Calculate();
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Calculate();

                                    wsModule.Rows.Remove(Module_ItemsStartRow + 3, 1048575 - (Module_ItemsStartRow + 3));

                                    Module_ItemsStartRow = module_ItemsStartRow;
                                    if (offer._ExportOfferHybridLst != null)
                                    {
                                        int columnNumber = 1;
                                        int columnIndex = Module_ItemsStartRow - 2;

                                        foreach (string featureName in distinctFeatures)
                                        {
                                            if (columnNumber == 1)
                                            {
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                            else
                                            {
                                                //wsModule.Columns[Module_ItemDetStartColumn + (Module_ItemsStartRow - 1)].Insert();
                                                wsModule.Columns[columnIndex].Insert();
                                                //// Use the CopyFrom method to copy the styles from the source column to the target column
                                                //wsModule.Columns[Module_ItemsStartRow - 2].CopyFrom(wsModule.Columns[columnIndex + 1], PasteSpecial.Formats);
                                                wsModule.Columns[columnIndex].CopyFrom(wsModule.Columns[Module_ItemsStartRow - 2], PasteSpecial.Formats);
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                        }
                                        Int32 itemsStartRow = Module_ItemsStartRow;
                                        foreach (ExportOfferComponent exportOfferModuleLst in offer._ExportOfferHybridLst)
                                        {
                                            if (exportOfferModuleLst.features != null)
                                            {
                                                foreach (Createitemsfeatures featureName in exportOfferModuleLst.features)
                                                {
                                                    if (distinctFeaturesWithId.Any(a => a.Value.ToLower().Equals(featureName.Name.ToLower())))
                                                    {
                                                        //var featuresWithId = distinctFeaturesWithId.Where(a => a.Value.ToLower().Equals(featureName.Name.ToLower())).FirstOrDefault().Key;
                                                        int featuresWithId = distinctFeatures.IndexOf(featureName.Name) + 1;
                                                        char ModuleDetStartColumn = Convert.ToChar(Module_ItemDetStartColumn);
                                                        char previews = (char)(((int)ModuleDetStartColumn) - 1);
                                                        char letter = (char)(((int)previews) + featuresWithId);
                                                        //char nextChar = (char)(((int)letter) + featuresWithId);
                                                        //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = featureName.Quantity;
                                                        columnIndex = (Module_ItemsStartRow - 2) + featuresWithId;
                                                        //wsModule.Cells[(Module_ItemsStartRow - 1), columnIndex].Value = featureName.Quantity;
                                                        string Setcell = string.Format("{0}{1}", letter, itemsStartRow);
                                                        wsModule.Cells[Setcell].Value = featureName.Quantity;
                                                    }
                                                }
                                                itemsStartRow = itemsStartRow + 1;
                                            }
                                            //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = listTOStr;
                                        }
                                    }

                                }
                                else
                                {
                                    workbook.Worksheets[8].Visible = false;
                                }
                                #endregion
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error ExportOffer(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            }
                            try
                            {
                                #region Japanese
                                //https://helpdesk.emdep.com/browse/APIGEOS-269
                                if (offer._ExportOfferJapaneseLst != null)
                                {
                                    Worksheet wsModule = workbook.Worksheets[9];

                                    int module_ItemsStartRow = Module_ItemsStartRow;
                                    List<string> distinctFeatures = new List<string>();
                                    Dictionary<int, string> distinctFeaturesWithId = new Dictionary<int, string>();
                                    List<Tuple<int, string, int>> featuresAndSortOrder = new List<Tuple<int, string, int>>();
                                    int featureNumber = 1;
                                    foreach (ExportOfferComponent item in offer._ExportOfferJapaneseLst)
                                    {
                                        if (item.TemplateName != "Component")
                                        {

                                            foreach (var feature in item.features)
                                            {
                                                if (!distinctFeatures.Contains(feature.Name))
                                                {
                                                    distinctFeatures.Add(feature.Name);
                                                    //distinctFeaturesWithId.Add(featureNumber, feature.Name);
                                                    featuresAndSortOrder.Add(Tuple.Create(featureNumber, feature.Name, feature.SortOrder));
                                                    featureNumber = featureNumber + 1;
                                                }
                                            }
                                        }
                                    }
                                    // Sort the featuresAndSortOrder list by the SortOrder
                                    featuresAndSortOrder = featuresAndSortOrder.OrderBy(t => t.Item3).ToList();
                                    // Convert to Dictionary<int, Tuple<string, int>>
                                    distinctFeaturesWithId = featuresAndSortOrder.ToDictionary(t => t.Item1, t => t.Item2);
                                    distinctFeatures = distinctFeaturesWithId.Values.ToList();
                                    //wsModule.Cells.AutoFitColumns();

                                    wsModule.Cells[Module_ItemItemColumn + (Module_ItemsStartRow - 1)].Value = Japanese_lblColItem;
                                    wsModule.Cells[Module_ItemReferenceColumn + (Module_ItemsStartRow - 1)].Value = Japanese_lblColReference;
                                    wsModule.Cells[Module_ItemNameColumn + (Module_ItemsStartRow - 1)].Value = Japanese_lblColName;
                                    wsModule.Cells[Module_ItemUnitPriceColumn + (Module_ItemsStartRow - 1)].Value = Japanese_lblColUnitPrice;
                                    wsModule.Cells[Module_ItemQuantityColumn + (Module_ItemsStartRow - 1)].Value = Japanese_lblColQuantity;
                                    wsModule.Cells[Module_ItemTotalPrice + (Module_ItemsStartRow - 1)].Value = Japanese_lblColTotalPrice;
                                    wsModule.Cells[Module_ItemCommentsColumn + (Module_ItemsStartRow - 1)].Value = Japanese_lblColRemarks;

                                    HashSet<string> processedReferences = new HashSet<string>();
                                    Int32 Module_ItemsHeadingStartRow = Convert.ToInt32(Module_count) - 1;
                                    if (offer._ExportOfferJapaneseLst.Count() > 1)
                                        wsModule.Rows.Insert(Module_ItemsHeadingStartRow + 1, offer._ExportOfferJapaneseLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                                    if (offer._ExportOfferJapaneseLst != null)
                                        foreach (ExportOfferComponent item in offer._ExportOfferJapaneseLst)
                                        {
                                            if (item.Name.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = (Index_lblDiscount + " (" + item.Discount + "%)");
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Rows[(Module_ItemsStartRow - 1)].Font.Bold = true;
                                                if (Module_ItemsStartRow / 2 == 0)
                                                {
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                }
                                                else
                                                {
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                }
                                            }
                                            else //if (!item.Discount.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemReferenceColumn + Module_ItemsStartRow].Value = item.Reference;
                                                //wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.TemplateName + "\n" + item.Name;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.Name;
                                                wsModule.Cells[Module_ItemCommentsColumn + Module_ItemsStartRow].Value = item.Comments;
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Cells[Module_ItemTotalPrice + Module_ItemsStartRow].Value = item.Qty * item.UnitPrice;
                                                string listTOStr = string.Join(";", item.features.Select(s => s.Quantity.HasValue ? s.Quantity.Value.ToString() : " "));

                                                processedReferences.Add(item.Reference);
                                            }
                                            Module_ItemsStartRow = Module_ItemsStartRow + 1;
                                        }
                                    // Calculate and write the subtotal
                                    int lastTotalPriceRow = Module_ItemsStartRow - 1;
                                    int subtotalRow = lastTotalPriceRow + 3; // Two rows below the last total price

                                    // Assuming the total price is in the column specified by Module_ItemTotalPrice
                                    string startCellAddress = $"{Module_ItemTotalPrice}{module_ItemsStartRow}";
                                    string endCellAddress = $"{Module_ItemTotalPrice}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";

                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Calculate();
                                    // 2. Update the formula in the desired cell (if needed)
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";
                                    string startCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{module_ItemsStartRow}";
                                    string endCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Formula = $"SUM({startCellAddressQuantityColumn}:{endCellAddressQuantityColumn})";
                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Calculate();
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Calculate();

                                    wsModule.Rows.Remove(Module_ItemsStartRow + 3, 1048575 - (Module_ItemsStartRow + 3));

                                    Module_ItemsStartRow = module_ItemsStartRow;
                                    if (offer._ExportOfferJapaneseLst != null)
                                    {
                                        int columnNumber = 1;
                                        int columnIndex = Module_ItemsStartRow - 2;

                                        foreach (string featureName in distinctFeatures)
                                        {
                                            if (columnNumber == 1)
                                            {
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                            else
                                            {
                                                //wsModule.Columns[Module_ItemDetStartColumn + (Module_ItemsStartRow - 1)].Insert();
                                                wsModule.Columns[columnIndex].Insert();
                                                //// Use the CopyFrom method to copy the styles from the source column to the target column
                                                //wsModule.Columns[Module_ItemsStartRow - 2].CopyFrom(wsModule.Columns[columnIndex + 1], PasteSpecial.Formats);
                                                wsModule.Columns[columnIndex].CopyFrom(wsModule.Columns[Module_ItemsStartRow - 2], PasteSpecial.Formats);
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                        }
                                        Int32 itemsStartRow = Module_ItemsStartRow;
                                        foreach (ExportOfferComponent exportOfferModuleLst in offer._ExportOfferJapaneseLst)
                                        {
                                            if (exportOfferModuleLst.features != null)
                                            {
                                                foreach (Createitemsfeatures featureName in exportOfferModuleLst.features)
                                                {
                                                    if (distinctFeaturesWithId.Any(a => a.Value.ToLower().Equals(featureName.Name.ToLower())))
                                                    {
                                                        //var featuresWithId = distinctFeaturesWithId.Where(a => a.Value.ToLower().Equals(featureName.Name.ToLower())).FirstOrDefault().Key;
                                                        int featuresWithId = distinctFeatures.IndexOf(featureName.Name) + 1;
                                                        char ModuleDetStartColumn = Convert.ToChar(Module_ItemDetStartColumn);
                                                        char previews = (char)(((int)ModuleDetStartColumn) - 1);
                                                        char letter = (char)(((int)previews) + featuresWithId);
                                                        //char nextChar = (char)(((int)letter) + featuresWithId);
                                                        //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = featureName.Quantity;
                                                        columnIndex = (Module_ItemsStartRow - 2) + featuresWithId;
                                                        //wsModule.Cells[(Module_ItemsStartRow - 1), columnIndex].Value = featureName.Quantity;
                                                        string Setcell = string.Format("{0}{1}", letter, itemsStartRow);
                                                        wsModule.Cells[Setcell].Value = featureName.Quantity;
                                                    }
                                                }
                                                itemsStartRow = itemsStartRow + 1;
                                            }
                                            //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = listTOStr;
                                        }
                                    }

                                }
                                else
                                {
                                    workbook.Worksheets[9].Visible = false;
                                }
                                #endregion
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error ExportOffer(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            }
                            try
                            {
                                #region Pull
                                //https://helpdesk.emdep.com/browse/APIGEOS-269
                                if (offer._ExportOfferPullLst != null)
                                {
                                    Worksheet wsModule = workbook.Worksheets[10];

                                    int module_ItemsStartRow = Module_ItemsStartRow;
                                    List<string> distinctFeatures = new List<string>();
                                    Dictionary<int, string> distinctFeaturesWithId = new Dictionary<int, string>();
                                    List<Tuple<int, string, int>> featuresAndSortOrder = new List<Tuple<int, string, int>>();
                                    int featureNumber = 1;
                                    foreach (ExportOfferComponent item in offer._ExportOfferPullLst)
                                    {
                                        if (item.TemplateName != "Component")
                                        {

                                            foreach (var feature in item.features)
                                            {
                                                if (!distinctFeatures.Contains(feature.Name))
                                                {
                                                    distinctFeatures.Add(feature.Name);
                                                    //distinctFeaturesWithId.Add(featureNumber, feature.Name);
                                                    featuresAndSortOrder.Add(Tuple.Create(featureNumber, feature.Name, feature.SortOrder));
                                                    featureNumber = featureNumber + 1;
                                                }
                                            }
                                        }
                                    }
                                    // Sort the featuresAndSortOrder list by the SortOrder
                                    featuresAndSortOrder = featuresAndSortOrder.OrderBy(t => t.Item3).ToList();
                                    // Convert to Dictionary<int, Tuple<string, int>>
                                    distinctFeaturesWithId = featuresAndSortOrder.ToDictionary(t => t.Item1, t => t.Item2);
                                    distinctFeatures = distinctFeaturesWithId.Values.ToList();
                                    // wsModule.Cells.AutoFitColumns();

                                    wsModule.Cells[Module_ItemItemColumn + (Module_ItemsStartRow - 1)].Value = Pull_lblColItem;
                                    wsModule.Cells[Module_ItemReferenceColumn + (Module_ItemsStartRow - 1)].Value = Pull_lblColReference;
                                    wsModule.Cells[Module_ItemNameColumn + (Module_ItemsStartRow - 1)].Value = Pull_lblColName;
                                    wsModule.Cells[Module_ItemUnitPriceColumn + (Module_ItemsStartRow - 1)].Value = Pull_lblColUnitPrice;
                                    wsModule.Cells[Module_ItemQuantityColumn + (Module_ItemsStartRow - 1)].Value = Pull_lblColQuantity;
                                    wsModule.Cells[Module_ItemTotalPrice + (Module_ItemsStartRow - 1)].Value = Pull_lblColTotalPrice;
                                    wsModule.Cells[Module_ItemCommentsColumn + (Module_ItemsStartRow - 1)].Value = Pull_lblColRemarks;

                                    HashSet<string> processedReferences = new HashSet<string>();
                                    Int32 Module_ItemsHeadingStartRow = Convert.ToInt32(Module_count) - 1;
                                    if (offer._ExportOfferPullLst.Count() > 1)
                                        wsModule.Rows.Insert(Module_ItemsHeadingStartRow + 1, offer._ExportOfferPullLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                                    if (offer._ExportOfferPullLst != null)
                                        foreach (ExportOfferComponent item in offer._ExportOfferPullLst)
                                        {
                                            if (item.Name.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = (Index_lblDiscount + " (" + item.Discount + "%)");
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Rows[(Module_ItemsStartRow - 1)].Font.Bold = true;
                                                if (Module_ItemsStartRow / 2 == 0)
                                                {
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                }
                                                else
                                                {
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                }
                                            }
                                            else //if (!item.Discount.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemReferenceColumn + Module_ItemsStartRow].Value = item.Reference;
                                                //wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.TemplateName + "\n" + item.Name;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.Name;
                                                wsModule.Cells[Module_ItemCommentsColumn + Module_ItemsStartRow].Value = item.Comments;
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Cells[Module_ItemTotalPrice + Module_ItemsStartRow].Value = item.Qty * item.UnitPrice;
                                                string listTOStr = string.Join(";", item.features.Select(s => s.Quantity.HasValue ? s.Quantity.Value.ToString() : " "));
                                                processedReferences.Add(item.Reference);
                                            }
                                            Module_ItemsStartRow = Module_ItemsStartRow + 1;
                                        }
                                    // Calculate and write the subtotal
                                    int lastTotalPriceRow = Module_ItemsStartRow - 1;
                                    int subtotalRow = lastTotalPriceRow + 3; // Two rows below the last total price

                                    // Assuming the total price is in the column specified by Module_ItemTotalPrice
                                    string startCellAddress = $"{Module_ItemTotalPrice}{module_ItemsStartRow}";
                                    string endCellAddress = $"{Module_ItemTotalPrice}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";

                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Calculate();
                                    // 2. Update the formula in the desired cell (if needed)
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";
                                    string startCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{module_ItemsStartRow}";
                                    string endCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Formula = $"SUM({startCellAddressQuantityColumn}:{endCellAddressQuantityColumn})";
                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Calculate();
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Calculate();

                                    wsModule.Rows.Remove(Module_ItemsStartRow + 3, 1048575 - (Module_ItemsStartRow + 3));

                                    Module_ItemsStartRow = module_ItemsStartRow;
                                    if (offer._ExportOfferPullLst != null)
                                    {
                                        int columnNumber = 1;
                                        int columnIndex = Module_ItemsStartRow - 2;

                                        foreach (string featureName in distinctFeatures)
                                        {
                                            if (columnNumber == 1)
                                            {
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                            else
                                            {
                                                //wsModule.Columns[Module_ItemDetStartColumn + (Module_ItemsStartRow - 1)].Insert();
                                                wsModule.Columns[columnIndex].Insert();
                                                //// Use the CopyFrom method to copy the styles from the source column to the target column
                                                //wsModule.Columns[Module_ItemsStartRow - 2].CopyFrom(wsModule.Columns[columnIndex + 1], PasteSpecial.Formats);
                                                wsModule.Columns[columnIndex].CopyFrom(wsModule.Columns[Module_ItemsStartRow - 2], PasteSpecial.Formats);
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                        }
                                        Int32 itemsStartRow = Module_ItemsStartRow;
                                        foreach (ExportOfferComponent exportOfferModuleLst in offer._ExportOfferPullLst)
                                        {
                                            if (exportOfferModuleLst.features != null)
                                            {
                                                foreach (Createitemsfeatures featureName in exportOfferModuleLst.features)
                                                {
                                                    if (distinctFeaturesWithId.Any(a => a.Value.ToLower().Equals(featureName.Name.ToLower())))
                                                    {
                                                        //var featuresWithId = distinctFeaturesWithId.Where(a => a.Value.ToLower().Equals(featureName.Name.ToLower())).FirstOrDefault().Key;
                                                        int featuresWithId = distinctFeatures.IndexOf(featureName.Name) + 1;
                                                        char ModuleDetStartColumn = Convert.ToChar(Module_ItemDetStartColumn);
                                                        char previews = (char)(((int)ModuleDetStartColumn) - 1);
                                                        char letter = (char)(((int)previews) + featuresWithId);
                                                        //char nextChar = (char)(((int)letter) + featuresWithId);
                                                        //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = featureName.Quantity;
                                                        columnIndex = (Module_ItemsStartRow - 2) + featuresWithId;
                                                        //wsModule.Cells[(Module_ItemsStartRow - 1), columnIndex].Value = featureName.Quantity;
                                                        string Setcell = string.Format("{0}{1}", letter, itemsStartRow);
                                                        wsModule.Cells[Setcell].Value = featureName.Quantity;
                                                    }
                                                }
                                                itemsStartRow = itemsStartRow + 1;
                                            }
                                            //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = listTOStr;
                                        }
                                    }

                                }
                                else
                                {
                                    workbook.Worksheets[10].Visible = false;
                                }
                                #endregion
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error ExportOffer(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            }
                            try
                            {
                                #region Vision
                                //https://helpdesk.emdep.com/browse/APIGEOS-269
                                if (offer._ExportOfferVisionLst != null)
                                {
                                    Worksheet wsModule = workbook.Worksheets[11];

                                    int module_ItemsStartRow = Module_ItemsStartRow;
                                    List<string> distinctFeatures = new List<string>();
                                    //Dictionary<string, int> distinctFeaturesAndSortOrder = new Dictionary<string, int>();
                                    Dictionary<int, Createitemsfeatures> distinctFeaturesAndSortOrder = new Dictionary<int, Createitemsfeatures>();
                                    Dictionary<int, string> distinctFeaturesWithId = new Dictionary<int, string>();

                                    List<Tuple<int, string, int>> featuresAndSortOrder = new List<Tuple<int, string, int>>();
                                    int featureNumber = 1;
                                    foreach (ExportOfferComponent item in offer._ExportOfferVisionLst)
                                    {
                                        if (item.TemplateName != "Component")
                                        {

                                            foreach (var feature in item.features)
                                            {
                                                if (!distinctFeatures.Contains(feature.Name))
                                                {
                                                    distinctFeatures.Add(feature.Name);
                                                    //distinctFeaturesWithId.Add(featureNumber, feature.Name);
                                                    //distinctFeaturesAndSortOrder.Add(feature.Name, feature.SortOrder);
                                                    //distinctFeaturesAndSortOrder.Add(featureNumber, feature);
                                                    featuresAndSortOrder.Add(Tuple.Create(featureNumber, feature.Name, feature.SortOrder));
                                                    featureNumber = featureNumber + 1;
                                                }
                                            }
                                        }
                                    }
                                    // Sort the dictionary by value and create a new dictionary with int as key and string as value
                                    //distinctFeaturesWithId = distinctFeaturesAndSortOrder.OrderBy(entry => entry.Key).ToDictionary(entry => entry.Key, entry => entry.Value);

                                    // Sort the featuresAndSortOrder list by the SortOrder
                                    featuresAndSortOrder = featuresAndSortOrder.OrderBy(t => t.Item3).ToList();
                                    // Convert to Dictionary<int, Tuple<string, int>>
                                    distinctFeaturesWithId = featuresAndSortOrder.ToDictionary(t => t.Item1, t => t.Item2);
                                    distinctFeatures = distinctFeaturesWithId.Values.ToList();
                                    //wsModule.Cells.AutoFitColumns();

                                    wsModule.Cells[Module_ItemItemColumn + (Module_ItemsStartRow - 1)].Value = Vision_lblColItem;
                                    wsModule.Cells[Module_ItemReferenceColumn + (Module_ItemsStartRow - 1)].Value = Vision_lblColReference;
                                    wsModule.Cells[Module_ItemNameColumn + (Module_ItemsStartRow - 1)].Value = Vision_lblColName;
                                    wsModule.Cells[Module_ItemUnitPriceColumn + (Module_ItemsStartRow - 1)].Value = Vision_lblColUnitPrice;
                                    wsModule.Cells[Module_ItemQuantityColumn + (Module_ItemsStartRow - 1)].Value = Vision_lblColQuantity;
                                    wsModule.Cells[Module_ItemTotalPrice + (Module_ItemsStartRow - 1)].Value = Vision_lblColTotalPrice;
                                    wsModule.Cells[Module_ItemCommentsColumn + (Module_ItemsStartRow - 1)].Value = Vision_lblColRemarks;

                                    HashSet<string> processedReferences = new HashSet<string>();
                                    Int32 Module_ItemsHeadingStartRow = Convert.ToInt32(Module_count) - 1;
                                    if (offer._ExportOfferVisionLst.Count() > 1)
                                        wsModule.Rows.Insert(Module_ItemsHeadingStartRow + 1, offer._ExportOfferVisionLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                                    if (offer._ExportOfferVisionLst != null)
                                        foreach (ExportOfferComponent item in offer._ExportOfferVisionLst)
                                        {
                                            if (item.Name.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = (Index_lblDiscount + " (" + item.Discount + "%)");
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Rows[(Module_ItemsStartRow - 1)].Font.Bold = true;
                                                if (Module_ItemsStartRow / 2 == 0)
                                                {
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                }
                                                else
                                                {
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                }
                                            }
                                            else //if (!item.Discount.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemReferenceColumn + Module_ItemsStartRow].Value = item.Reference;
                                                //wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.TemplateName + "\n" + item.Name;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.Name;
                                                wsModule.Cells[Module_ItemCommentsColumn + Module_ItemsStartRow].Value = item.Comments;
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Cells[Module_ItemTotalPrice + Module_ItemsStartRow].Value = item.Qty * item.UnitPrice;
                                                string listTOStr = string.Join(";", item.features.Select(s => s.Quantity.HasValue ? s.Quantity.Value.ToString() : " "));
                                                processedReferences.Add(item.Reference);
                                            }
                                            Module_ItemsStartRow = Module_ItemsStartRow + 1;
                                        }
                                    // Calculate and write the subtotal
                                    int lastTotalPriceRow = Module_ItemsStartRow - 1;
                                    int subtotalRow = lastTotalPriceRow + 3; // Two rows below the last total price

                                    // Assuming the total price is in the column specified by Module_ItemTotalPrice
                                    string startCellAddress = $"{Module_ItemTotalPrice}{module_ItemsStartRow}";
                                    string endCellAddress = $"{Module_ItemTotalPrice}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";
                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Calculate();
                                    // 2. Update the formula in the desired cell (if needed)
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";
                                    string startCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{module_ItemsStartRow}";
                                    string endCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Formula = $"SUM({startCellAddressQuantityColumn}:{endCellAddressQuantityColumn})";
                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Calculate();
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Calculate();

                                    wsModule.Rows.Remove(Module_ItemsStartRow + 3, 1048575 - (Module_ItemsStartRow + 3));
                                    Module_ItemsStartRow = module_ItemsStartRow;

                                    if (offer._ExportOfferVisionLst != null)
                                    {
                                        int columnNumber = 1;
                                        int columnIndex = Module_ItemsStartRow - 2;

                                        foreach (string featureName in distinctFeatures)
                                        {
                                            if (columnNumber == 1)
                                            {
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                            else
                                            {
                                                //wsModule.Columns[Module_ItemDetStartColumn + (Module_ItemsStartRow - 1)].Insert();
                                                wsModule.Columns[columnIndex].Insert();
                                                //// Use the CopyFrom method to copy the styles from the source column to the target column
                                                //wsModule.Columns[Module_ItemsStartRow - 2].CopyFrom(wsModule.Columns[columnIndex + 1], PasteSpecial.Formats);
                                                wsModule.Columns[columnIndex].CopyFrom(wsModule.Columns[Module_ItemsStartRow - 2], PasteSpecial.Formats);
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                        }
                                        Int32 itemsStartRow = Module_ItemsStartRow;
                                        foreach (ExportOfferComponent exportOfferModuleLst in offer._ExportOfferVisionLst)
                                        {
                                            if (exportOfferModuleLst.features != null)
                                            {
                                                foreach (Createitemsfeatures featureName in exportOfferModuleLst.features)
                                                {
                                                    if (distinctFeaturesWithId.Any(a => a.Value.ToLower().Equals(featureName.Name.ToLower())))
                                                    {
                                                        // var featuresWithId = distinctFeaturesWithId.Where(a => a.Value.ToLower().Equals(featureName.Name.ToLower())).FirstOrDefault().Key;
                                                        int featuresWithId = distinctFeatures.IndexOf(featureName.Name) + 1;
                                                        char ModuleDetStartColumn = Convert.ToChar(Module_ItemDetStartColumn);
                                                        char previews = (char)(((int)ModuleDetStartColumn) - 1);
                                                        char letter = (char)(((int)previews) + featuresWithId);
                                                        //char nextChar = (char)(((int)letter) + featuresWithId);
                                                        //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = featureName.Quantity;
                                                        columnIndex = (Module_ItemsStartRow - 2) + featuresWithId;
                                                        //wsModule.Cells[(Module_ItemsStartRow - 1), columnIndex].Value = featureName.Quantity;
                                                        string Setcell = string.Format("{0}{1}", letter, itemsStartRow);
                                                        wsModule.Cells[Setcell].Value = featureName.Quantity;
                                                    }
                                                }
                                                itemsStartRow = itemsStartRow + 1;
                                            }
                                            //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = listTOStr;
                                        }
                                    }

                                }
                                else
                                {
                                    workbook.Worksheets[11].Visible = false;
                                }
                                #endregion
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error ExportOffer(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            }
                            try
                            {
                                #region Wireless
                                //https://helpdesk.emdep.com/browse/APIGEOS-269
                                if (offer._ExportOfferWirelessLst != null)
                                {
                                    Worksheet wsModule = workbook.Worksheets[12];

                                    int module_ItemsStartRow = Module_ItemsStartRow;
                                    List<string> distinctFeatures = new List<string>();
                                    Dictionary<int, string> distinctFeaturesWithId = new Dictionary<int, string>();
                                    List<Tuple<int, string, int>> featuresAndSortOrder = new List<Tuple<int, string, int>>();
                                    int featureNumber = 1;
                                    foreach (ExportOfferComponent item in offer._ExportOfferWirelessLst)
                                    {
                                        if (item.TemplateName != "Component")
                                        {

                                            foreach (var feature in item.features)
                                            {
                                                if (!distinctFeatures.Contains(feature.Name))
                                                {
                                                    distinctFeatures.Add(feature.Name);
                                                    //distinctFeaturesWithId.Add(featureNumber, feature.Name);
                                                    featuresAndSortOrder.Add(Tuple.Create(featureNumber, feature.Name, feature.SortOrder));
                                                    featureNumber = featureNumber + 1;
                                                }
                                            }
                                        }
                                    }
                                    // Sort the featuresAndSortOrder list by the SortOrder
                                    featuresAndSortOrder = featuresAndSortOrder.OrderBy(t => t.Item3).ToList();
                                    // Convert to Dictionary<int, Tuple<string, int>>
                                    distinctFeaturesWithId = featuresAndSortOrder.ToDictionary(t => t.Item1, t => t.Item2);
                                    distinctFeatures = distinctFeaturesWithId.Values.ToList();
                                    //wsModule.Cells.AutoFitColumns();

                                    wsModule.Cells[Module_ItemItemColumn + (Module_ItemsStartRow - 1)].Value = Wireless_lblColItem;
                                    wsModule.Cells[Module_ItemReferenceColumn + (Module_ItemsStartRow - 1)].Value = Wireless_lblColReference;
                                    wsModule.Cells[Module_ItemNameColumn + (Module_ItemsStartRow - 1)].Value = Wireless_lblColName;
                                    wsModule.Cells[Module_ItemUnitPriceColumn + (Module_ItemsStartRow - 1)].Value = Wireless_lblColUnitPrice;
                                    wsModule.Cells[Module_ItemQuantityColumn + (Module_ItemsStartRow - 1)].Value = Wireless_lblColQuantity;
                                    wsModule.Cells[Module_ItemTotalPrice + (Module_ItemsStartRow - 1)].Value = Wireless_lblColTotalPrice;
                                    wsModule.Cells[Module_ItemCommentsColumn + (Module_ItemsStartRow - 1)].Value = Wireless_lblColRemarks;

                                    HashSet<string> processedReferences = new HashSet<string>();
                                    Int32 Module_ItemsHeadingStartRow = Convert.ToInt32(Module_count) - 1;
                                    if (offer._ExportOfferWirelessLst.Count() > 1)
                                        wsModule.Rows.Insert(Module_ItemsHeadingStartRow + 1, offer._ExportOfferWirelessLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                                    if (offer._ExportOfferWirelessLst != null)
                                        foreach (ExportOfferComponent item in offer._ExportOfferWirelessLst)
                                        {
                                            if (item.Name.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = (Index_lblDiscount + " (" + item.Discount + "%)");
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Rows[(Module_ItemsStartRow - 1)].Font.Bold = true;
                                                if (Module_ItemsStartRow / 2 == 0)
                                                {
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                }
                                                else
                                                {
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                }
                                            }
                                            else //if (!item.Discount.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemReferenceColumn + Module_ItemsStartRow].Value = item.Reference;
                                                //wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.TemplateName + "\n" + item.Name;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.Name;
                                                wsModule.Cells[Module_ItemCommentsColumn + Module_ItemsStartRow].Value = item.Comments;
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Cells[Module_ItemTotalPrice + Module_ItemsStartRow].Value = item.Qty * item.UnitPrice;
                                                string listTOStr = string.Join(";", item.features
                                                    .Select(s => s.Quantity.HasValue ? s.Quantity.Value.ToString() : " "));

                                                processedReferences.Add(item.Reference);
                                            }
                                            Module_ItemsStartRow = Module_ItemsStartRow + 1;
                                        }
                                    // Calculate and write the subtotal
                                    int lastTotalPriceRow = Module_ItemsStartRow - 1;
                                    int subtotalRow = lastTotalPriceRow + 3; // Two rows below the last total price

                                    // Assuming the total price is in the column specified by Module_ItemTotalPrice
                                    string startCellAddress = $"{Module_ItemTotalPrice}{module_ItemsStartRow}";
                                    string endCellAddress = $"{Module_ItemTotalPrice}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";

                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Calculate();
                                    // 2. Update the formula in the desired cell (if needed)
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";
                                    string startCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{module_ItemsStartRow}";
                                    string endCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Formula = $"SUM({startCellAddressQuantityColumn}:{endCellAddressQuantityColumn})";
                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Calculate();
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Calculate();

                                    wsModule.Rows.Remove(Module_ItemsStartRow + 3, 1048575 - (Module_ItemsStartRow + 3));

                                    Module_ItemsStartRow = module_ItemsStartRow;
                                    if (offer._ExportOfferWirelessLst != null)
                                    {
                                        int columnNumber = 1;
                                        int columnIndex = Module_ItemsStartRow - 2;

                                        foreach (string featureName in distinctFeatures)
                                        {
                                            if (columnNumber == 1)
                                            {
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                            else
                                            {
                                                //wsModule.Columns[Module_ItemDetStartColumn + (Module_ItemsStartRow - 1)].Insert();
                                                wsModule.Columns[columnIndex].Insert();
                                                //// Use the CopyFrom method to copy the styles from the source column to the target column
                                                //wsModule.Columns[Module_ItemsStartRow - 2].CopyFrom(wsModule.Columns[columnIndex + 1], PasteSpecial.Formats);
                                                wsModule.Columns[columnIndex].CopyFrom(wsModule.Columns[Module_ItemsStartRow - 2], PasteSpecial.Formats);
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                        }
                                        Int32 itemsStartRow = Module_ItemsStartRow;
                                        foreach (ExportOfferComponent exportOfferModuleLst in offer._ExportOfferWirelessLst)
                                        {
                                            if (exportOfferModuleLst.features != null)
                                            {
                                                foreach (Createitemsfeatures featureName in exportOfferModuleLst.features)
                                                {
                                                    if (distinctFeaturesWithId.Any(a => a.Value.ToLower().Equals(featureName.Name.ToLower())))
                                                    {
                                                        //var featuresWithId = distinctFeaturesWithId.Where(a => a.Value.ToLower().Equals(featureName.Name.ToLower())).FirstOrDefault().Key;
                                                        int featuresWithId = distinctFeatures.IndexOf(featureName.Name) + 1;
                                                        char ModuleDetStartColumn = Convert.ToChar(Module_ItemDetStartColumn);
                                                        char previews = (char)(((int)ModuleDetStartColumn) - 1);
                                                        char letter = (char)(((int)previews) + featuresWithId);
                                                        //char nextChar = (char)(((int)letter) + featuresWithId);
                                                        //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = featureName.Quantity;
                                                        columnIndex = (Module_ItemsStartRow - 2) + featuresWithId;
                                                        //wsModule.Cells[(Module_ItemsStartRow - 1), columnIndex].Value = featureName.Quantity;
                                                        string Setcell = string.Format("{0}{1}", letter, itemsStartRow);
                                                        wsModule.Cells[Setcell].Value = featureName.Quantity;
                                                    }
                                                }
                                                itemsStartRow = itemsStartRow + 1;
                                            }
                                            //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = listTOStr;
                                        }
                                    }

                                }
                                else
                                {
                                    workbook.Worksheets[12].Visible = false;
                                }
                                #endregion
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error ExportOffer(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            }
                            try
                            {
                                #region WellInsertion
                                //https://helpdesk.emdep.com/browse/APIGEOS-269
                                if (offer._ExportOfferWell_InsertionLst != null)
                                {
                                    Worksheet wsModule = workbook.Worksheets[13];

                                    int module_ItemsStartRow = Module_ItemsStartRow;
                                    List<string> distinctFeatures = new List<string>();
                                    Dictionary<int, string> distinctFeaturesWithId = new Dictionary<int, string>();
                                    List<Tuple<int, string, int>> featuresAndSortOrder = new List<Tuple<int, string, int>>();
                                    int featureNumber = 1;
                                    foreach (ExportOfferComponent item in offer._ExportOfferWell_InsertionLst)
                                    {
                                        if (item.TemplateName != "Component")
                                        {

                                            foreach (var feature in item.features)
                                            {
                                                if (!distinctFeatures.Contains(feature.Name))
                                                {
                                                    distinctFeatures.Add(feature.Name);
                                                    //distinctFeaturesWithId.Add(featureNumber, feature.Name);
                                                    featuresAndSortOrder.Add(Tuple.Create(featureNumber, feature.Name, feature.SortOrder));
                                                    featureNumber = featureNumber + 1;
                                                }
                                            }
                                        }
                                    }
                                    // Sort the featuresAndSortOrder list by the SortOrder
                                    featuresAndSortOrder = featuresAndSortOrder.OrderBy(t => t.Item3).ToList();
                                    // Convert to Dictionary<int, Tuple<string, int>>
                                    distinctFeaturesWithId = featuresAndSortOrder.ToDictionary(t => t.Item1, t => t.Item2);
                                    distinctFeatures = distinctFeaturesWithId.Values.ToList();
                                    //wsModule.Cells.AutoFitColumns();

                                    wsModule.Cells[Module_ItemItemColumn + (Module_ItemsStartRow - 1)].Value = WellInsertion_lblColItem;
                                    wsModule.Cells[Module_ItemReferenceColumn + (Module_ItemsStartRow - 1)].Value = WellInsertion_lblColReference;
                                    wsModule.Cells[Module_ItemNameColumn + (Module_ItemsStartRow - 1)].Value = WellInsertion_lblColName;
                                    wsModule.Cells[Module_ItemUnitPriceColumn + (Module_ItemsStartRow - 1)].Value = WellInsertion_lblColUnitPrice;
                                    wsModule.Cells[Module_ItemQuantityColumn + (Module_ItemsStartRow - 1)].Value = WellInsertion_lblColQuantity;
                                    wsModule.Cells[Module_ItemTotalPrice + (Module_ItemsStartRow - 1)].Value = WellInsertion_lblColTotalPrice;
                                    wsModule.Cells[Module_ItemCommentsColumn + (Module_ItemsStartRow - 1)].Value = WellInsertion_lblColRemarks;

                                    HashSet<string> processedReferences = new HashSet<string>();
                                    Int32 Module_ItemsHeadingStartRow = Convert.ToInt32(Module_count) - 1;
                                    if (offer._ExportOfferWell_InsertionLst.Count() > 1)
                                        wsModule.Rows.Insert(Module_ItemsHeadingStartRow + 1, offer._ExportOfferWell_InsertionLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                                    if (offer._ExportOfferWell_InsertionLst != null)
                                        foreach (ExportOfferComponent item in offer._ExportOfferWell_InsertionLst)
                                        {
                                            if (item.Name.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = (Index_lblDiscount + " (" + item.Discount + "%)");
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Rows[(Module_ItemsStartRow - 1)].Font.Bold = true;
                                                if (Module_ItemsStartRow / 2 == 0)
                                                {
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemUnitPriceColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    //wsTechnicalAssistance.Cells[Technical_Assistance_ItemQuantityColumn + Technical_Assistance_ItemsStartRow].Font.Color = Color.FromArgb(255, 255, 255);
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.White;
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].FillColor = Color.White;
                                                }
                                                else
                                                {
                                                    wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                    wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                                }
                                            }
                                            else //if (!item.Discount.Equals("Discount"))
                                            {
                                                wsModule.Cells[Module_ItemItemColumn + Module_ItemsStartRow].Value = item.Item;
                                                wsModule.Cells[Module_ItemReferenceColumn + Module_ItemsStartRow].Value = item.Reference;
                                                //wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.TemplateName + "\n" + item.Name;
                                                wsModule.Cells[Module_ItemNameColumn + Module_ItemsStartRow].Value = item.Name;
                                                wsModule.Cells[Module_ItemCommentsColumn + Module_ItemsStartRow].Value = item.Comments;
                                                wsModule.Cells[Module_ItemUnitPriceColumn + Module_ItemsStartRow].Value = item.UnitPrice;
                                                wsModule.Cells[Module_ItemQuantityColumn + Module_ItemsStartRow].Value = item.Qty;
                                                wsModule.Cells[Module_ItemTotalPrice + Module_ItemsStartRow].Value = item.Qty * item.UnitPrice;
                                                string listTOStr = string.Join(";", item.features.Select(s => s.Quantity.HasValue ? s.Quantity.Value.ToString() : " "));
                                                processedReferences.Add(item.Reference);
                                            }
                                            Module_ItemsStartRow = Module_ItemsStartRow + 1;
                                        }
                                    // Calculate and write the subtotal
                                    int lastTotalPriceRow = Module_ItemsStartRow - 1;
                                    int subtotalRow = lastTotalPriceRow + 3; // Two rows below the last total price

                                    // Assuming the total price is in the column specified by Module_ItemTotalPrice
                                    string startCellAddress = $"{Module_ItemTotalPrice}{module_ItemsStartRow}";
                                    string endCellAddress = $"{Module_ItemTotalPrice}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";

                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemTotalPrice}{subtotalRow}"].Calculate();
                                    // 2. Update the formula in the desired cell (if needed)
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Formula = $"SUM({startCellAddress}:{endCellAddress})";
                                    string startCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{module_ItemsStartRow}";
                                    string endCellAddressQuantityColumn = $"{Module_ItemQuantityColumn}{lastTotalPriceRow}";
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Formula = $"SUM({startCellAddressQuantityColumn}:{endCellAddressQuantityColumn})";
                                    // Refresh the formula
                                    wsModule.Cells[$"{Module_ItemNameColumn}{subtotalRow}"].Calculate();
                                    wsModule.Cells[$"{Module_ItemItemColumn}{subtotalRow}"].Calculate();

                                    wsModule.Rows.Remove(Module_ItemsStartRow + 3, 1048575 - (Module_ItemsStartRow + 3));

                                    Module_ItemsStartRow = module_ItemsStartRow;
                                    if (offer._ExportOfferWell_InsertionLst != null)
                                    {
                                        int columnNumber = 1;
                                        int columnIndex = Module_ItemsStartRow - 2;

                                        foreach (string featureName in distinctFeatures)
                                        {
                                            if (columnNumber == 1)
                                            {
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                            else
                                            {
                                                //wsModule.Columns[Module_ItemDetStartColumn + (Module_ItemsStartRow - 1)].Insert();
                                                wsModule.Columns[columnIndex].Insert();
                                                //// Use the CopyFrom method to copy the styles from the source column to the target column
                                                //wsModule.Columns[Module_ItemsStartRow - 2].CopyFrom(wsModule.Columns[columnIndex + 1], PasteSpecial.Formats);
                                                wsModule.Columns[columnIndex].CopyFrom(wsModule.Columns[Module_ItemsStartRow - 2], PasteSpecial.Formats);
                                                wsModule.Cells[(Module_ItemsStartRow - 2), columnIndex].Value = featureName;
                                                columnNumber++;
                                                columnIndex++;
                                            }
                                        }
                                        Int32 itemsStartRow = Module_ItemsStartRow;
                                        foreach (ExportOfferComponent exportOfferModuleLst in offer._ExportOfferWell_InsertionLst)
                                        {
                                            if (exportOfferModuleLst.features != null)
                                            {
                                                foreach (Createitemsfeatures featureName in exportOfferModuleLst.features)
                                                {
                                                    if (distinctFeaturesWithId.Any(a => a.Value.ToLower().Equals(featureName.Name.ToLower())))
                                                    {
                                                        //var featuresWithId = distinctFeaturesWithId.Where(a => a.Value.ToLower().Equals(featureName.Name.ToLower())).FirstOrDefault().Key;
                                                        int featuresWithId = distinctFeatures.IndexOf(featureName.Name) + 1;
                                                        char ModuleDetStartColumn = Convert.ToChar(Module_ItemDetStartColumn);
                                                        char previews = (char)(((int)ModuleDetStartColumn) - 1);
                                                        char letter = (char)(((int)previews) + featuresWithId);
                                                        //char nextChar = (char)(((int)letter) + featuresWithId);
                                                        //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = featureName.Quantity;
                                                        columnIndex = (Module_ItemsStartRow - 2) + featuresWithId;
                                                        //wsModule.Cells[(Module_ItemsStartRow - 1), columnIndex].Value = featureName.Quantity;
                                                        string Setcell = string.Format("{0}{1}", letter, itemsStartRow);
                                                        wsModule.Cells[Setcell].Value = featureName.Quantity;
                                                    }
                                                }
                                                itemsStartRow = itemsStartRow + 1;
                                            }
                                            //wsModule.Cells[Module_ItemDetStartColumn + Module_ItemsStartRow].Value = listTOStr;
                                        }
                                    }

                                }
                                else
                                {
                                    workbook.Worksheets[13].Visible = false;
                                }


                                #endregion
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error ExportOffer(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            }
                            #endregion

                            workbook.Worksheets[14].Visible = false;
                            workbook.Worksheets[15].Visible = false;
                            #region pageMargins
                            // Select a unit of measure used within the workbook.
                            //workbook.Unit = DevExpress.Office.DocumentUnit.Inch;
                            //Margins pageMargins = workbook.Worksheets[0].ActiveView.Margins;
                            //// Specify page margins.
                            //pageMargins.Left = 0F;
                            //pageMargins.Top = 0F;
                            //pageMargins.Right = 0F;
                            //pageMargins.Bottom = 0F;
                            #endregion
                            workbook.SaveDocument(stream, DocumentFormat.Xlsx);
                            isDone = true;
                        }
                        using (FileStream pdfFileStream = new FileStream(Path.Combine(updatedExcelFilePath, filenamePDF), FileMode.Create))
                        {

                            workbook.ExportToPdf(pdfFileStream);
                        }

                        workbook.Dispose();

                        if (stream != null)
                        {
                            stream.Dispose();
                        }

                        #region MergePDF

                        //string path = Path.Combine(updatedExcelFilePath, filenamePDF);
                        //if (File.Exists(path))
                        //{
                        //    byte[] MergeFirstFile1 = GetFirstFile1(path);
                        //    List<byte[]> byteList = new List<byte[]>();
                        //    byteList.Add(MergeFirstFile1);
                        //    byteList.Add(SaleGeneralConditions);
                        //    MergePDF(byteList, path);
                        //}
                        #endregion
                    }
                }

                catch (Exception ex)
                {
                    workbook.Dispose();

                    if (stream != null)
                    {
                        stream.Dispose();
                    }
                    throw ex;
                }
            }

            return isDone;
        }

        public List<Currency_conversions> GetCurrency_conversionsList(DateTime currentdate, string connstr)
        {
            List<Currency_conversions> currencyConversionsList = new List<Currency_conversions>();
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetCurrency_conversionsList()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetCurrencyConversionDetailsByDate", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_currentdate", currentdate);
                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            Currency_conversions currency = new Currency_conversions();
                            if (dr["IdCurrencyConversionFrom"] != DBNull.Value)
                            {
                                currency.IdCurrencyConversionFrom = Convert.ToInt32(dr["IdCurrencyConversionFrom"].ToString());
                            }
                            if (dr["IdCurrencyConversionTo"] != DBNull.Value)
                            {
                                currency.IdCurrencyConversionTo = Convert.ToInt32(dr["IdCurrencyConversionTo"].ToString());
                            }
                            if (dr["CurrencyConversionRate"] != DBNull.Value)
                            {
                                // currency.CurrencyConversionRate = Convert.ToDouble(dr["CurrencyConversionRate"].ToString());
                                currency.CurrencyConversionRate = Convert.ToString(dr["CurrencyConversionRate"].ToString());
                            }
                            if (dr["LastMonthAVGRate"] != DBNull.Value)
                            {
                                //currency.LastMonthAVGRate = Convert.ToDouble(dr["LastMonthAVGRate"].ToString());
                                currency.LastMonthAVGRate = Convert.ToString(dr["LastMonthAVGRate"].ToString());
                            }
                            currencyConversionsList.Add(currency);
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetCurrency_conversionsList()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetCurrency_conversionsList(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            return currencyConversionsList;
        }
        public List<Languages> Getlanguages(string connstr)
        {
            List<Languages> languagelst = new List<Languages>();
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method Getlanguages()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetLanguages", conn);
                    command.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            Languages Language = new Languages();
                            if (dr["IdLanguage"] != DBNull.Value)
                            {
                                Language.IdLanguage = Convert.ToInt32(dr["IdLanguage"].ToString());
                            }
                            if (dr["TwoLetterISOLanguage"] != DBNull.Value)
                            {
                                Language.TwoLetterISOLanguage = Convert.ToString(dr["TwoLetterISOLanguage"].ToString());
                            }
                            if (dr["Name"] != DBNull.Value)
                            {
                                Language.Name = Convert.ToString(dr["Name"].ToString());
                            }
                            if (dr["CultureName"] != DBNull.Value)
                            {
                                Language.CultureName = Convert.ToString(dr["CultureName"].ToString());
                            }
                            languagelst.Add(Language);
                        }

                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method Getlanguages()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error Getlanguages(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return languagelst;
        }

        public string GetCultureByPlantOwner(string _ShortName, string connstr)
        {
            string Culture = string.Empty;
            List<Languages> languagelst = new List<Languages>();
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetCultureByPlantOwner()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetCultureByPlantOwner", conn);
                    command.Parameters.AddWithValue("_ShortName", _ShortName);
                    command.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {

                            if (dr["Language"] != DBNull.Value)
                            {
                                Culture = Convert.ToString(dr["Language"].ToString());
                            }

                        }

                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetCultureByPlantOwner()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error Getlanguages(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return Culture;
        }

        public SendEmail SendOffer(SendMailOffer sendMailOffer, string plantOwner, string idOffer, string ConnectionString, string loginConnectionString, string offerCommericalPath, string mailServerName, string mailServerPort, string mailFrom, string Mailpassword, string MailUser, string Plantwiseconnectionstring)
        {
            SendEmail sendEmail = new SendEmail();
            ErrorMessage errormessage = new ErrorMessage();
            ErrorMessage warningmessage = new ErrorMessage();
            warningmessage = null;
            errormessage = null;
            //sendEmail = null;
            bool isDone = false;
            Int64 idSite = IsEMDEPSiteExist(plantOwner, ConnectionString);
            if (idSite > 0)
            {
                string siteConnectionstring = GetSiteConnectionString(idSite, ConnectionString, Plantwiseconnectionstring);
                ExportOffer offer = new ExportOffer();
                try
                {
                    Log4NetLogger.Logger.Log(string.Format("Method Send()...."), category: Category.Info, priority: Priority.Low);
                    using (MySqlConnection conn = new MySqlConnection(siteConnectionstring))
                    {
                        conn.Open();
                        MySqlCommand command = new MySqlCommand("GEOSAPI_GetSendOffer_V280", conn);
                        command.CommandType = CommandType.StoredProcedure;
                        command.Parameters.AddWithValue("_IdOffer", idOffer);

                        using (MySqlDataReader dr = command.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                if (dr["Title"] != DBNull.Value)
                                {
                                    offer._OfferTitle = Convert.ToString(dr["Title"]);
                                }
                                if (dr["OfferNumber"] != DBNull.Value)
                                {
                                    offer._OfferNumber = Convert.ToString(dr["OfferNumber"]);
                                }
                                if (dr["Year"] != DBNull.Value)
                                {
                                    offer._OfferYear = Convert.ToString(dr["Year"]);
                                }
                                if (dr["GroupPlant"] != DBNull.Value)
                                {
                                    offer._OfferGroupPlant = Convert.ToString(dr["GroupPlant"]);
                                }

                                if (dr["OfferSalesOwnerName"] != DBNull.Value)
                                {
                                    offer._OfferSalesOwnerFullName = Convert.ToString(dr["OfferSalesOwnerName"]);
                                }
                                if (dr["OfferSalesOwnerEmail"] != DBNull.Value)
                                {
                                    offer._OfferSalesOwnerEmail = Convert.ToString(dr["OfferSalesOwnerEmail"]);
                                }
                            }

                        }
                    }
                    Log4NetLogger.Logger.Log(string.Format("Method Send()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                }
                catch (Exception ex)
                {

                    Log4NetLogger.Logger.Log(string.Format("Error Send(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw ex;

                }

                try
                {
                    string emailString = string.Empty;
                    using (MySqlConnection conn = new MySqlConnection(loginConnectionString))
                    {
                        conn.Open();
                        MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                        command.CommandType = CommandType.StoredProcedure;
                        command.Parameters.AddWithValue("_IdAppSetting", 44);
                        using (MySqlDataReader dr = command.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                if (dr["DefaultValue"] != DBNull.Value)
                                {
                                    emailString = Convert.ToString(dr["DefaultValue"]);
                                }
                            }
                        }

                    }
                    List<string> SupportEmailList = new List<string>();
                    foreach (var address in emailString.Split(new[] { ",", ";" }, StringSplitOptions.RemoveEmptyEntries))
                    {
                        SupportEmailList.Add(address);
                    }


                    if (offer != null)
                    {

                        string filenameExcel = null;
                        string filenamePDF = null;
                        //  string plantFileServer = GetGEOSProviderFileServer(plantOwner, loginConnectionString);
                        string quotationFolder = GetGEOSAppSetting("Quotation_Folder", loginConnectionString);
                        string updatedExcelFilePath = offerCommericalPath.Replace("{0}", plantOwner);
                        #region //chitra.girigosavi[APIGEOS-1322][04/03/2025]
                        string offerCommericalNewPath = GetCommercialOffersExportPath("CommercialOffersPath", siteConnectionstring);
                        long IdOffer = long.Parse(idOffer);
                        string FileServerIP = GetFileServerIp(IdOffer, siteConnectionstring);
                        string updatedNewExcelFilePath = offerCommericalNewPath.Replace("{0}", FileServerIP);
                        updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("{1}", plantOwner);
                        #endregion

                        if (plantOwner == "EAES" || plantOwner == "ETHQ")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCM");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCM");
                        }
                        else if (plantOwner == "EIBR")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMB");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMB");
                        }
                        else if (plantOwner == "EARO" || plantOwner == "EBRO" || plantOwner == "ENRU")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMR");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMR");
                        }
                        else if (plantOwner == "ETMA" || plantOwner == "ESMA1" || plantOwner == "ESMA2")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMM");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMM");
                        }
                        else if (plantOwner == "ESCN" || plantOwner == "ETCN")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMCN");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMCN");
                        }
                        else if (plantOwner == "ETTN")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMT");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMT");
                        }
                        else if (plantOwner == "EPIN")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMIN");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMIN");
                        }
                        else if (plantOwner == "EJMX1" || plantOwner == "EJMX2" || plantOwner == "ESMX" || plantOwner == "EAMX")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMX");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMX");
                        }
                        else if (plantOwner == "ESHN")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMH");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMH");
                        }
                        else if (plantOwner == "EEPY")
                        {
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMPY");
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", "GCMPY");
                        }
                        else
                        {
                            string updatedPlantOwner = "GCM" + GetAllPlant(plantOwner.Trim());
                            updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", updatedPlantOwner.Trim());
                            updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("GCM", updatedPlantOwner.Trim());
                        }

                        //else if (plantOwner == "EAMX")
                        //{
                        //    updatedExcelFilePath = updatedExcelFilePath.Replace("GCM", "GCMMX");
                        //}


                        // updatedExcelFilePath = updatedExcelFilePath.Replace("EAESFS01", @"10.0.9.7\10.0.9.7");
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....OfferYear- {0}", offer._OfferYear), category: Category.Info, priority: Priority.Low);
                        updatedExcelFilePath = updatedExcelFilePath.Replace("{1}", offer._OfferYear);
                        updatedExcelFilePath = updatedExcelFilePath.Replace("{2}", offer._OfferGroupPlant);
                        updatedExcelFilePath = updatedExcelFilePath.Replace("{3}", offer._OfferNumber);
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....OfferNumber.... {0}", offer._OfferNumber), category: Category.Info, priority: Priority.Low);
                        updatedExcelFilePath = updatedExcelFilePath.Replace("{4}", quotationFolder);
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....quotationFolder.... {0}", quotationFolder), category: Category.Info, priority: Priority.Low);
                        //updatedExcelFilePath = updatedExcelFilePath.Replace("\\10.0.9.7", @"C:\Temp");
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....updatedExcelFilePath.... {0}", updatedExcelFilePath), category: Category.Info, priority: Priority.Low);

                        Log4NetLogger.Logger.Log(string.Format("Method Send()....OfferYear- {0}", offer._OfferYear), category: Category.Info, priority: Priority.Low);
                        updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("{2}", offer._OfferYear);
                        updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("{3}", offer._OfferGroupPlant);
                        updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("{4}", offer._OfferNumber);
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....OfferNumber.... {0}", offer._OfferNumber), category: Category.Info, priority: Priority.Low);
                        updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("{5}", quotationFolder);
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....quotationFolder.... {0}", quotationFolder), category: Category.Info, priority: Priority.Low);
                        //updatedNewExcelFilePath = updatedNewExcelFilePath.Replace("\\10.0.9.7", @"C:\Temp");
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....updatedNewExcelFilePath.... {0}", updatedNewExcelFilePath), category: Category.Info, priority: Priority.Low);

                        if (!System.IO.Directory.Exists(updatedExcelFilePath))
                        {
                            // If updatedExcelFilePath does not exist, check for updatedNewExcelFilePath
                            if (System.IO.Directory.Exists(updatedNewExcelFilePath))
                            {
                                // Assign updatedNewExcelFilePath to updatedExcelFilePath
                                updatedExcelFilePath = updatedNewExcelFilePath;
                            }
                        }

                        List<Int32> revNumber = new List<int>();

                        //Offer_2021 - 06771_rev01_demande de devis + 9 materiel
                        string search = "Offer_" + offer._OfferNumber + "_rev" + '*' + "_" + '*' + ".pdf";
                        //string searchpattern =  Order + '*';
                        //string[] allfiles = Directory.GetFiles(updatedExcelFilePath, "*.*", SearchOption.AllDirectories);
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....search.... {0}", search), category: Category.Info, priority: Priority.Low);
                        FileInfo[] files = new DirectoryInfo(updatedExcelFilePath)
                        .GetFiles(search)
                        //.OrderBy(f => f.CreationTime)
                        .ToArray();
                        var allfiles = files;

                        //23 Dec 2021          var allfiles = Directory.GetFiles(updatedExcelFilePath, search, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).ToList();
                        if (allfiles.Count() == 0)
                        {
                            search = "Offer_" + offer._OfferNumber + "_" + '*' + ".pdf";
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....search2.... {0}", search), category: Category.Info, priority: Priority.Low);
                            FileInfo[] files1 = new DirectoryInfo(updatedExcelFilePath)
                           .GetFiles(search)
                           //.OrderBy(f => f.CreationTime)
                           .ToArray();
                            allfiles = files1;
                            //23 Dec 2021          allfiles = Directory.GetFiles(updatedExcelFilePath, search, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).ToList();
                        }
                        List<string> revPDFList = new List<string>();
                        foreach (var itemPDF in allfiles)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....itemPDF.... {0}", string.Join(",", itemPDF.ToString())), category: Category.Info, priority: Priority.Low);
                            string substringitem = itemPDF.ToString().Split('\\').Last();
                            //string[] strArray = substringitem.Split('_');
                            //string substringitemsplit = strArray[2];
                            revPDFList.Add(substringitem);
                        }
                        //string filename = revPDFList.OrderByDescending(r => r).ToList().FirstOrDefault();
                        string containstr = "";
                        string MaxRevFileName = "";
                        if (revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault() == null)
                        {
                            containstr = offer._OfferTitle + ".pdf";
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....containstr.... {0}", containstr), category: Category.Info, priority: Priority.Low);
                        }
                        else
                        {
                            //23 Dec 2021 containstr = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault().ToString().PadLeft(2, '0');//+ "_" + offer._OfferTitle;
                            List<string> maxNumberList = new List<string>();
                            foreach (var maxnumItem in revPDFList)
                            {
                                int indexofrev = maxnumItem.IndexOf("rev");
                                string substring = "00";
                                if (indexofrev == -1)
                                {
                                    substring = "00";
                                }
                                else
                                {
                                    substring = maxnumItem.Substring(indexofrev + 3, 2);
                                }
                                Log4NetLogger.Logger.Log(string.Format("Method Send()....substring.... {0}", substring), category: Category.Info, priority: Priority.Low);
                                maxNumberList.Add(substring);

                            }
                            string maxNumber = maxNumberList.Max();
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....maxNumber.... {0}", maxNumber), category: Category.Info, priority: Priority.Low);
                            string str = revPDFList.Where(w => w.Contains("Offer_" + offer._OfferNumber + "_" + "rev" + maxNumber)).FirstOrDefault();
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....str.... {0}", str), category: Category.Info, priority: Priority.Low);
                            containstr = "Offer_" + offer._OfferNumber + "_" + "rev" + maxNumber + "_" + '*';
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....containstr.... {0}", containstr), category: Category.Info, priority: Priority.Low);
                            // containstr = revPDFList.Last();
                        }
                        //MaxRevFileName = Directory.GetFiles(updatedExcelFilePath).Where(fi => fi.Contains(containstr)).FirstOrDefault();
                        if (containstr != null)
                            MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, containstr, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....MaxRevFileName.... {0}", MaxRevFileName), category: Category.Info, priority: Priority.Low);
                        if (MaxRevFileName == null)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....MaxRevFileName.... {0}", MaxRevFileName), category: Category.Info, priority: Priority.Low);
                            containstr = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault();
                            //MaxRevFileName = Directory.GetFiles(updatedExcelFilePath).Where(fi => fi.Contains(containstr)).FirstOrDefault();
                            if (containstr != null)
                                MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, containstr, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....containstr.... {0}", containstr), category: Category.Info, priority: Priority.Low);
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....MaxRevFileName.... {0}", MaxRevFileName), category: Category.Info, priority: Priority.Low);
                        }
                        if (!File.Exists(MaxRevFileName))
                        {
                            Log4NetLogger.Logger.Log(string.Format("Method Send()....File.Exists(MaxRevFileName)...."), category: Category.Info, priority: Priority.Low);
                            if (revPDFList.Count() > 0)
                            {
                                containstr = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault().ToString().PadLeft(2, '0');// + "_" + offer._OfferTitle;
                                if (containstr != null)
                                    MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, containstr, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                                //MaxRevFileName = Directory.GetFiles(updatedExcelFilePath).Where(fi => fi.Contains(containstr)).FirstOrDefault();
                                Log4NetLogger.Logger.Log(string.Format("Method Send()....containstr.... {0}", containstr), category: Category.Info, priority: Priority.Low);
                                Log4NetLogger.Logger.Log(string.Format("Method Send()....MaxRevFileName.... {0}", MaxRevFileName), category: Category.Info, priority: Priority.Low);
                            }

                        }
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....containstr....END.... {0}", containstr), category: Category.Info, priority: Priority.Low);
                        Log4NetLogger.Logger.Log(string.Format("Method Send()....MaxRevFileName....END.... {0}", MaxRevFileName), category: Category.Info, priority: Priority.Low);
                      
                        // string mailecos = "ECOS";
                        string mailecos = string.IsNullOrEmpty(sendMailOffer.Source) ? "ECOS" : sendMailOffer.Source.ToUpper();
                        //  string mailecos =  mailFrom;
                        List<string> FailEmailList = new List<string>();
                        List<string> sendEmailList = new List<string>();
                        List<string> errorEmailList = new List<string>();
                        List<string> sendEmailTOList = new List<string>();
                        Regex regexEmail;
                        //Regex regex = new Regex(@"/^[a-z0-9](\.?[a-z0-9]){3,}@[Gg][Mm][Aa][Ii][Ll]\.com$/");
                        string allowEmailAddress = emailString;
                        allowEmailAddress = emailString.Replace('*', ' ');
                        string result = string.Concat(allowEmailAddress.Where(c => !char.IsWhiteSpace(c)));
                        string emailRegexString = result.Replace(';', '|');
                        //if (emailString.Contains("*@*.com"))
                        if (emailString.Contains("*@*"))
                        {
                            regexEmail = new Regex(@"[A-Z0-9a-z._%+-]+@[A-Za-z0-9-]+\.[A-Za-z]{2,64}");
                        }
                        else
                        {
                            //regexEmail = new Regex(@"\w+([-+.]\w+)*@(emdep|gmail)\.com");
                            regexEmail = new Regex(@"\w+([-+.]\w+)*(" + emailRegexString + ")");

                        }
                        if (!string.IsNullOrEmpty(sendMailOffer.CC))
                        {
                            //MailAddress copy = new MailAddress(sendMailOffer.CC);
                            //mailmessage.CC.Add(copy);
                            string Emailcc = sendMailOffer.CC;
                            foreach (var address in Emailcc.Split(new[] { ",", ";" }, StringSplitOptions.RemoveEmptyEntries))
                            {
                                if (emailString.Equals(string.Empty))
                                {
                                    bool checkcc = IsValidEmail(address);
                                    if (checkcc == true)
                                        FailEmailList.Add(address);
                                }
                                else if (emailString != string.Empty)
                                {
                                    Match match = regexEmail.Match(address);
                                    if (match.Success == true)
                                    {
                                        bool checkcc = IsValidEmail(address);
                                        if (checkcc == true)
                                        {
                                            sendEmailList.Add(address);
                                        }
                                        //mailmessage.CC.Add(address);
                                    }
                                    else if (match.Success == false)
                                    {
                                        bool checkcc = IsValidEmail(address);
                                        if (checkcc == true)
                                        {
                                            FailEmailList.Add(address);
                                        }
                                        else
                                        {
                                            errorEmailList.Add(address);
                                        }

                                    }
                                }

                            }
                        }


                        if (!string.IsNullOrEmpty(sendMailOffer.TO))
                        {
                            string emailTo = sendMailOffer.TO;
                            foreach (var EmailTo in emailTo.Split(new[] { ",", ";" }, StringSplitOptions.RemoveEmptyEntries))
                            {
                                if (emailString.Equals(string.Empty))
                                {
                                    bool checkcc = IsValidEmail(EmailTo);
                                    if (checkcc == true)
                                        FailEmailList.Add(EmailTo);
                                }
                                else if (emailString != string.Empty)
                                {
                                    Match match = regexEmail.Match(EmailTo);
                                    if (match.Success == true)
                                    {
                                        bool checkcc = IsValidEmail(EmailTo);
                                        if (checkcc == true)
                                        {
                                            sendEmailTOList.Add(EmailTo);
                                        }
                                        //mailmessage.CC.Add(address);
                                    }
                                    else if (match.Success == false)
                                    {
                                        bool checkcc = IsValidEmail(EmailTo);
                                        if (checkcc == true)
                                        {
                                            FailEmailList.Add(EmailTo);
                                        }
                                        else
                                        {
                                            errorEmailList.Add(EmailTo);
                                        }

                                    }
                                }
                            }
                        }



                        if (FailEmailList != null)
                        {
                            if (FailEmailList.Count > 0)
                            {
                                string str = String.Join(",", FailEmailList);
                                if (warningmessage == null)
                                {
                                    warningmessage = new ErrorMessage();
                                }
                                if (warningmessage != null)
                                {
                                    warningmessage.code = "721";
                                    if (warningmessage.info == null)
                                        warningmessage.info = "The following email are not supported to send : " + str;
                                    else
                                        warningmessage.info = warningmessage.info + ",";
                                }
                            }
                        }

                        if (errorEmailList != null)
                        {
                            if (errorEmailList.Count > 0)
                            {
                                string errorstr = String.Join(",", errorEmailList);
                                if (errormessage == null)
                                {
                                    errormessage = new ErrorMessage();
                                }
                                if (errormessage != null)
                                {
                                    errormessage.code = "713";
                                    if (errormessage.info == null)
                                        errormessage.info = "The following email (" + errorstr + ") are not correct format:";
                                    else
                                        errormessage.info = errormessage.info + "," + errorstr;
                                }
                            }
                        }
                        //MailMessage mailmessage = new MailMessage(mailecos, sendMailOffer.TO);
                        //string.IsNullOrEmpty(sendMailOffer.Body.ToString()) ? "ECOS" : sendMailOffer.Body.ToString()
                        StringBuilder emailbodyStr = new StringBuilder();
                        emailbodyStr.Append(string.IsNullOrEmpty(sendMailOffer.Body) ? "" : sendMailOffer.Body.ToString());
                        // emailbodyStr.Append("<p style='font-size: 18px; text-indent: 40px;margin-left:20px;'>" + offer._OfferSalesOwnerFullName + " (" + offer._OfferSalesOwnerEmail + ")</p>");

                        AlternateView htmlView = AlternateView.CreateAlternateViewFromString(emailbodyStr.ToString(), null, "text/html");
                        System.Net.Mail.Attachment item = null;
                        if (File.Exists(MaxRevFileName))
                        {
                            item = new System.Net.Mail.Attachment(MaxRevFileName);
                        }
                        else if (!File.Exists(MaxRevFileName))
                        {
                            FailEmailList.Add("Attachment not found ");

                            if (FailEmailList != null)
                            {
                                if (FailEmailList.Count > 0)
                                {
                                    string str = String.Join(",", FailEmailList);
                                    if (warningmessage == null)
                                    {
                                        warningmessage = new ErrorMessage();
                                    }
                                    if (warningmessage != null)
                                    {
                                        warningmessage.code = "721";
                                        warningmessage.info = warningmessage.info + " Attachment not found".ToString();
                                    }
                                }
                            }
                        }

                        #region oldcode

                        //mailmessage.Attachments.Add(item);
                        ////Add view to the Email Message
                        //mailmessage.AlternateViews.Add(htmlView);
                        ////set the Email subject
                        //mailmessage.Subject = sendMailOffer.Subject;

                        //mailmessage.IsBodyHtml = sendMailOffer.IsHtmlBody;

                        // SmtpClient smtp = new SmtpClient();
                        // smtp.Host = mailServerName;                       
                        // smtp.Port = Convert.ToInt32(mailServerPort);
                        // smtp.UseDefaultCredentials = false;
                        #endregion
                        string MailCredentials = string.Empty;
                        if (Mailpassword != string.Empty)
                        {
                            var base64EncodedBytes = Convert.FromBase64String(Mailpassword);
                            MailCredentials = Encoding.UTF8.GetString(base64EncodedBytes);
                        }
                        //smtp.Credentials = new NetworkCredential(mailFrom, MailCredentials);

                        //smtp.Send(mailmessage);
                        //isDone = true;



                        string sendEmailToString = String.Join(", ", sendEmailTOList);
                        if (string.IsNullOrEmpty(sendEmailToString))
                        {
                            if (errormessage != null)
                            {
                                sendEmail.error = errormessage;
                            }
                            if (warningmessage != null)
                            {
                                sendEmail.warning = warningmessage;
                            }
                            return sendEmail;
                        }
                        // using (MailMessage mail = new MailMessage(mailecos, sendMailOffer.TO))
                        MailAddress emailFrom = new MailAddress(mailFrom, mailecos);
                        MailAddress emailTO = new MailAddress(sendEmailToString, sendEmailToString);
                        List<string> templist = sendEmailToString.Split(',').ToList();
                        //using (MailMessage mail = new MailMessage(emailFrom, emailTO))
                        //using (MailMessage mail = new MailMessage(emailFrom, emailTO))
                        using (MailMessage mail = new MailMessage())
                        {
                            mail.From = emailFrom;
                            foreach (var emailTOList in templist)
                            {
                                mail.To.Add(emailTOList);
                            }
                            foreach (var SendEmail in sendEmailList)
                            {
                                mail.CC.Add(SendEmail);
                            }
                            if (File.Exists(MaxRevFileName) && item != null)
                            {
                                mail.Attachments.Add(item);
                                Log4NetLogger.Logger.Log(string.Format("Method Send()....Attachments....END.... {0}", item.Name), category: Category.Info, priority: Priority.Low);
                            }
                            mail.AlternateViews.Add(htmlView);
                            mail.Subject = sendMailOffer.Subject;
                            mail.Body = sendMailOffer.Body;
                            mail.IsBodyHtml = true;
                            mail.IsBodyHtml = sendMailOffer.IsHtmlBody;
                            //mail.From = emailFrom;
                            using (SmtpClient smtp = new SmtpClient(mailServerName, Convert.ToInt32(mailServerPort)))
                            {
                                //smtp.DeliveryMethod = SmtpDeliveryMethod.Network;
                                smtp.UseDefaultCredentials = false;
                                smtp.Credentials = new NetworkCredential(MailUser, MailCredentials);
                                smtp.EnableSsl = false;
                                try
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Method before()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                                    smtp.Send(mail);
                                    Log4NetLogger.Logger.Log(string.Format("Method Send call successfully()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                                }

                                catch (SmtpFailedRecipientsException ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Method SmtpFailedRecipientsException()....Executed successfully."), category: Category.Exception, priority: Priority.Low);
                                    if (errormessage == null)
                                    {
                                        errormessage = new ErrorMessage();
                                    }
                                    if (errormessage != null)
                                    {
                                        errormessage.code = "713";
                                        if (errormessage.info == null)
                                            errormessage.info = ex.InnerException.Message.ToString();
                                        else
                                            errormessage.info = errormessage.info + "," + ex.InnerException.Message.ToString();
                                    }
                                }
                                catch (SmtpFailedRecipientException ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Method SmtpFailedRecipientException()....Executed successfully."), category: Category.Exception, priority: Priority.Low);
                                    if (errormessage == null)
                                    {
                                        errormessage = new ErrorMessage();
                                    }
                                    if (errormessage != null)
                                    {
                                        errormessage.code = "713";
                                        if (errormessage.info == null)
                                            errormessage.info = ex.InnerException.Message.ToString();
                                        else
                                            errormessage.info = errormessage.info + "," + ex.InnerException.Message.ToString();
                                    }
                                }
                                catch (SmtpException ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Method SmtpException()....Executed successfully."), category: Category.Exception, priority: Priority.Low);
                                    if (errormessage == null)
                                    {
                                        errormessage = new ErrorMessage();
                                    }
                                    if (errormessage != null)
                                    {
                                        errormessage.code = "713";
                                        if (errormessage.info == null)
                                            errormessage.info = ex.InnerException.Message.ToString();
                                        else
                                            errormessage.info = errormessage.info + "," + ex.InnerException.Message.ToString();
                                    }
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Method Exception()....Executed successfully."), category: Category.Exception, priority: Priority.Low);
                                    if (errormessage == null)
                                    {
                                        errormessage = new ErrorMessage();
                                    }
                                    if (errormessage != null)
                                    {
                                        errormessage.code = "713";
                                        if (errormessage.info == null)
                                            errormessage.info = ex.InnerException.Message.ToString();
                                        else
                                            errormessage.info = errormessage.info + "," + ex.InnerException.Message.ToString();
                                    }
                                }

                            }
                        }
                        //sendemail.success = true;


                    }
                }
                catch (Exception ex)
                {
                    throw ex;
                }
            }


            if (errormessage != null)
            {
                Log4NetLogger.Logger.Log(string.Format("Method error message call successfully()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                sendEmail.error = errormessage;
            }
            if (warningmessage != null)
            {
                Log4NetLogger.Logger.Log(string.Format("Method warning message call successfully()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                sendEmail.warning = warningmessage;
            }

            //sendEmail.error = errormessage;
            //sendEmail.warning = warningmessage;
            Log4NetLogger.Logger.Log(string.Format("Method  return sendEmail successfully()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            return sendEmail;

        }
        bool IsValidEmail(string email)
        {
            try
            {
                var addr = new System.Net.Mail.MailAddress(email);
                //return addr.Address == email;
                return true;
            }
            catch (Exception ex)
            {
                return false;
            }
        }


        #endregion
    }
    public class OrderManager
    {
        string _ConnString;
        string _ConnEmdepGeosString;
        private string username;
        static string loginUsername;
        static string Remarks;
        public string WorkflowStatusFrom;
        public string WorkflowStatusTo;
        public static string login;
        public OrderManager(string ConnString, string ConnEmdepGeosString)
        {
            //if (Log4NetLogger.Logger == null)
            //{
            //    string ApplicationLogFilePath = System.Web.Hosting.HostingEnvironment.MapPath("/") + "log4net.config";
            //    FileInfo file = new FileInfo(ApplicationLogFilePath);
            //    Log4NetLogger.Logger = LoggerFactory.CreateLogger(LogType.Log4Net, file);
            //}
            this._ConnString = ConnString;
            this._ConnEmdepGeosString = ConnEmdepGeosString;
        }

        public OrderManager(string username)
        {
            this.username = username;
            loginUsername = username;
            login = username;
        }

        public bool ExportPurchaseOrder(string IdPo, string Plant, string Lang, string POExpenceExcelPath, string POFilePath, string Plantwiseconnectionstring)
        {
            List<Languages> Languages = Getlanguages(_ConnEmdepGeosString);
            FileStream stream = null;
            CultureInfo cultureInfo;

            Int64 idSite = IsEMDEPSiteExist(Plant, _ConnString);
            string siteConnectionString = GetSiteConnectionString(idSite, _ConnString, Plantwiseconnectionstring);
            Languages getLanguage = Languages.Where(l => l.TwoLetterISOLanguage.Equals(Lang.ToLower())).FirstOrDefault();
            bool isDone = false;
            PurchaseOrderExport purchaseOrderExport = new PurchaseOrderExport();
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method ExportPurchaseOrder()...."), category: Category.Info, priority: Priority.Low);

                using (MySqlConnection conn = new MySqlConnection(siteConnectionString))
                {
                    conn.Open();
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_PurchasingOrdersExport_V430", conn);
                    // MySqlCommand command = new MySqlCommand("GEOSAPI_PurchasingOrdersExport_V460", conn);//Modify by kanchan[kshinde][APIGEOS-563] endpoint Purchasing/Orders/Export DATE 14/07/2022
                    //   MySqlCommand command = new MySqlCommand("GEOSAPI_PurchasingOrdersExportPayment_V460", conn);//[002]Modify by kanchan[kshinde][APIGEOS-564] endpoint Purchasing/Orders/Export DATE 15/07/2022,[APIGEOS-564] DATE 18/07/2022,[APIGEOS-574][20/07/2022]
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_PurchasingOrdersExportPayment_V470", conn);//[001][kshinde][16/08/2022][APIGEOS-586]
                    // MySqlCommand command = new MySqlCommand("GEOSAPI_PurchasingOrdersExportPayment_V480", conn);//[001][pjadhav][APIGEOS-603][19/09/2022]
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_PurchasingOrdersExportPayment_V570", conn); 
                    //Shubham[skadam] APIGEOS-790 Need to show 4 decimal digits 09 05 2023
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_PurchasingOrdersExportPayment_V580", conn);//Updated by chitra[cgirigosavi][APIGEOS-788][17/05/2023]
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_PurchasingOrdersExportPayment_V610", conn);  //Created By Rahul[rgadhave]for APIGEOS-907  
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_PurchasingOrdersExportPayment_V630", conn); //chitra.girigosavi[APIGEOS-945][26/10/2023]
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_PurchasingOrdersExportPayment_V680", conn); //chitra.girigosavi[APIGEOS-1051][20/03/2024]

                    //MySqlCommand command = new MySqlCommand("GEOSAPI_PurchasingOrdersExportPayment_V740", conn); //chitra.girigosavi APIGEOS-1194 30/07/2024 MEJORAS EN GEOS2 SRM
                    MySqlCommand command = new MySqlCommand("GEOSAPI_PurchasingOrdersExportPayment_V780", conn);//Shubham[skadam] APIGEOS-1309 Improvement in API/Purchasing/Orders/Export.  03 01 2024
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_IdPo", IdPo);
                    command.Parameters.AddWithValue("_IdSite", idSite);
                    command.Parameters.AddWithValue("_Lang", Lang);//[001][kshinde][APIGEOS-564]
                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        #region dr.Read
                        if (dr.Read())
                        {
                            if (dr["Code"] != DBNull.Value)
                            {
                                purchaseOrderExport._POCode = Convert.ToString(dr["Code"]);
                            }
                            if (dr["PODate"] != DBNull.Value)
                            {
                                purchaseOrderExport._PODate = Convert.ToDateTime(dr["PODate"]).ToString("dd-MM-yyyy");
                            }
                            if (dr["DeliveryDate"] != DBNull.Value)
                            {
                                purchaseOrderExport._PODeliveryDate = Convert.ToDateTime(dr["DeliveryDate"]).ToString("dd-MM-yyyy");
                            }
                            if (dr["Warehouse"] != DBNull.Value)
                            {
                                purchaseOrderExport._DeliveryAddressWarehouseName = Convert.ToString(dr["Warehouse"]);
                            }
                            if (dr["DEAddress"] != DBNull.Value)
                            {
                                purchaseOrderExport._DeliveryAddressStreet = Convert.ToString(dr["DEAddress"]);
                            }
                            if (dr["DEPostCode"] != DBNull.Value)
                            {
                                purchaseOrderExport._DeliveryAddressZipCode = Convert.ToString(dr["DEPostCode"]);
                            }
                            if (dr["DETelephone"] != DBNull.Value)
                            {
                                purchaseOrderExport._DeliveryAddressPhone = Convert.ToString(dr["DETelephone"]);
                            }
                            if (dr["DECity"] != DBNull.Value)
                            {
                                purchaseOrderExport._DeliveryAddressCity = Convert.ToString(dr["DECity"]);
                            }
                            if (dr["DeliveryAddressCountry"] != DBNull.Value)
                            {
                                purchaseOrderExport._DeliveryAddressCountry = Convert.ToString(dr["DeliveryAddressCountry"]);
                            }
                            if (dr["SUPCity"] != DBNull.Value)
                            {
                                purchaseOrderExport._SupplierCity = Convert.ToString(dr["SUPCity"]);
                            }
                            if (dr["SUPPostCode"] != DBNull.Value)
                            {
                                purchaseOrderExport._SupplierZipCode = Convert.ToString(dr["SUPPostCode"]);
                            }
                            if (dr["SUPAddress"] != DBNull.Value)
                            {
                                purchaseOrderExport._SupplierStreet = Convert.ToString(dr["SUPAddress"]);
                            }
                            if (dr["SUPName"] != DBNull.Value)
                            {
                                purchaseOrderExport._SupplierName = Convert.ToString(dr["SUPName"]);
                            }
                            if (dr["SUPPhone"] != DBNull.Value)
                            {
                                purchaseOrderExport._SupplierPhone = Convert.ToString(dr["SUPPhone"]);
                            }
                            if (dr["SUPContactEmail"] != DBNull.Value)
                            {
                                purchaseOrderExport._SupplierContactEmail = Convert.ToString(dr["SUPContactEmail"]);
                            }
                            if (dr["SUPContactMobile"] != DBNull.Value)
                            {
                                purchaseOrderExport._SupplierPhone = Convert.ToString(dr["SUPContactMobile"]);
                            }
                            if (dr["SUPContactPerson"] != DBNull.Value)
                            {
                                purchaseOrderExport._SupplierContactName = Convert.ToString(dr["SUPContactPerson"]);
                            }
                            if (dr["SUPCountry"] != DBNull.Value)
                            {
                                purchaseOrderExport._SupplierCountry = Convert.ToString(dr["SUPCountry"]);
                            }
                            if (dr["PlantCity"] != DBNull.Value)
                            {
                                purchaseOrderExport._PlantCity = Convert.ToString(dr["PlantCity"]);
                            }
                            if (dr["PlantPhone"] != DBNull.Value)
                            {
                                purchaseOrderExport._PlantPhone = Convert.ToString(dr["PlantPhone"]);
                            }
                            //[001][kshinde][APIGEOS-563][14/07/2022]
                            if (dr["PlantRegistrationNumber"] != DBNull.Value)
                            {
                                purchaseOrderExport._PlantRegistrationNumber = Convert.ToString(dr["PlantRegistrationNumber"]);
                            }
                            if (dr["PlantStreet"] != DBNull.Value)
                            {
                                purchaseOrderExport._PlantStreet = Convert.ToString(dr["PlantStreet"]);
                            }
                            if (dr["PlantZipCode"] != DBNull.Value)
                            {
                                purchaseOrderExport._PlantZipCode = Convert.ToString(dr["PlantZipCode"]);
                            }
                            if (dr["year"] != DBNull.Value)
                            {
                                purchaseOrderExport._Year = Convert.ToString(dr["year"]);
                            }
                            if (dr["Incoterms"] != DBNull.Value)
                            {
                                purchaseOrderExport._PoIncoterms = Convert.ToString(dr["Incoterms"]);
                            }

                            if (dr["PaymentTerms"] != DBNull.Value)  //[001][kshinde][APIGEOS-564][15/07/2022]
                            {
                                purchaseOrderExport._PaymentTerms = Convert.ToString(dr["PaymentTerms"]);
                            }
                            if (dr["PlantRegisteredName"] != DBNull.Value)
                            {
                                purchaseOrderExport._PlantRegisteredName = Convert.ToString(dr["PlantRegisteredName"]);
                            }
                            if (dr["PlantState"] != DBNull.Value)
                            {
                                purchaseOrderExport._PlantState = Convert.ToString(dr["PlantState"]);
                            }
                            if (dr["PlantCountry"] != DBNull.Value)
                            {
                                purchaseOrderExport._PlantCountry = Convert.ToString(dr["PlantCountry"]);
                            }
                            if (dr["SupplierState"] != DBNull.Value)
                            {
                                purchaseOrderExport._SupplierState = Convert.ToString(dr["SupplierState"]);
                            }
                            if (dr["DeliveryAddressState"] != DBNull.Value)
                            {
                                purchaseOrderExport._DeliveryAddressState = Convert.ToString(dr["DeliveryAddressState"]);
                            }
                            if (dr["Remarks"] != DBNull.Value)
                            {
                                purchaseOrderExport._Remarks = Convert.ToString(dr["Remarks"]);
                            }
                            if (dr["PurchasingContactName"] != DBNull.Value)
                            {
                                purchaseOrderExport._PurchasingContactName = Convert.ToString(dr["PurchasingContactName"]);
                            }
                            if (dr["PurchasingContactEmail"] != DBNull.Value)
                            {
                                purchaseOrderExport._PurchasingContactEmail = Convert.ToString(dr["PurchasingContactEmail"]);
                            }
                            if (dr["SupplierNotes"] != DBNull.Value)                                                              //[001][kshinde][APIGEOS-565][18/07/2022]//[002]
                            {
                                purchaseOrderExport._SupplierNotes = Convert.ToString(dr["SupplierNotes"]);
                            }
                            if (dr["SUPContactPhone"] != DBNull.Value)                                   //[001][kshinde][APIGEOS - 569][20 / 07 / 2022]
                            {
                                purchaseOrderExport._SupplierContactPhone = Convert.ToString(dr["SUPContactPhone"]);
                            }
                            if (dr["CurrencyName"] != DBNull.Value)                                    //[001][kshinde][APIGEOS-575][22/07/2022]
                            {
                                purchaseOrderExport._PoCurrency = Convert.ToString(dr["CurrencyName"]);
                            }
                            if (dr["Observations"] != DBNull.Value)                                    //chitra[cgirigosavi][APIGEOS-788][17/05/2023]
                            {
                                purchaseOrderExport._Observations = Convert.ToString(dr["Observations"]);
                            }
                        }
                        #endregion
                        #region PurchasingOrdersItems                    
                        if (dr.NextResult())
                        {
                            purchaseOrderExport._ArticleItemsLst = new List<ArticleItems>();
                            while (dr.Read())
                            {
                                ArticleItems articleItems = new ArticleItems();
                                if (dr["IdWarehousePurchaseOrder"] != null)
                                {
                                    //Orders.Where(i => i.Id == Convert.ToInt64(dr["IdWarehousePurchaseOrder"].ToString())).FirstOrDefault();
                                    if (purchaseOrderExport != null)
                                    {
                                        if (dr["idArticle"] != DBNull.Value)//[rdixit][APIGEOS-562][19.07.2022]
                                        {
                                            articleItems.ArticleID = Convert.ToInt32(dr["idArticle"].ToString());
                                        }

                                        if (dr["Reference"] != DBNull.Value)
                                        {
                                            articleItems.ArticleName = Convert.ToString(dr["Reference"]);
                                        }
                                        if (dr["Description"] != DBNull.Value)
                                        {
                                            articleItems.Description = Convert.ToString(dr["Description"]);
                                        }
                                        if (dr["Qty"] != DBNull.Value)
                                        {
                                            articleItems.Qty = Convert.ToInt64(dr["Qty"].ToString());
                                        }
                                        if (dr["DiscountRate"] != DBNull.Value)
                                        {
                                            string discount = dr["DiscountRate"].ToString();
                                            articleItems.Discount = Convert.ToDouble(discount);
                                        }
                                        //if (dr["TotalPrice"] != DBNull.Value)
                                        //{
                                        //    string TotalPrice = dr["TotalPrice"].ToString();
                                        //    articleItems.TotalPrice = Convert.ToDouble(TotalPrice);
                                        //}
                                        if (dr["UnitPrice"] != DBNull.Value)
                                        {
                                            //articleItems.UnitPrice = Convert.ToDouble(dr["UnitPrice"].ToString());
                                            if (Convert.ToDouble(dr["UnitPrice"]) == 0 && Convert.ToDouble(dr["DiscountRate"]) == 100)
                                            {
                                                articleItems.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                            }
                                            else
                                            {
                                                articleItems.UnitPrice = Convert.ToDouble(dr["UnitPrice"]);
                                                #region APIGEOS-866
                                                //Shubham[skadam] APIGEOS-866 Wrong unit price in Exported PDF 14 07 2023
                                                //double temp = Convert.ToDouble(1 - (articleItems.Discount / 100));
                                                //if (temp==0)
                                                //{
                                                //    articleItems.UnitPrice = articleItems.UnitPrice;
                                                //}
                                                //else
                                                //{
                                                //    articleItems.UnitPrice = Math.Round((articleItems.UnitPrice / temp), 4);
                                                //}
                                                #endregion
                                            }
                                        }
                                        if (dr["PackingSize"] != DBNull.Value) //chitra.girigosavi APIGEOS-1194 30 / 07 / 2024 MEJORAS EN GEOS2 SRM
                                        {
                                            articleItems.PackingSize = Convert.ToInt32(dr["PackingSize"].ToString());
                                        }
                                        purchaseOrderExport._ArticleItemsLst.Add(articleItems);
                                        if (articleItems.Discount != 0)
                                        {

                                            if (purchaseOrderExport._ArticleItemsLst == null)
                                                purchaseOrderExport._ArticleItemsLst = new List<ArticleItems>();
                                            ArticleItems articleItems1 = new ArticleItems();
                                            if (dr["Description"] != DBNull.Value)
                                            {
                                                articleItems1.Description = "Discount";
                                            }
                                            if (dr["UnitPrice"] != DBNull.Value)
                                            {
                                                // exportOfferInvoice1.UnitPrice = -((exportOfferInvoice.UnitPrice * exportOfferInvoice.Discount) / 100);
                                                if (articleItems1.UnitPrice == 0 && articleItems1.Discount == 100)
                                                {
                                                    articleItems1.UnitPrice = 0;
                                                }
                                                else
                                                {
                                                    double discount = ((articleItems.UnitPrice * articleItems.Discount) / 100);
                                                    articleItems1.UnitPrice = Math.Round((discount * articleItems.Qty), 4, MidpointRounding.AwayFromZero);
                                                }

                                            }
                                            if (dr["Qty"] != DBNull.Value)
                                            {
                                                articleItems1.Qty = -1;
                                            }
                                            if (dr["DiscountRate"] != DBNull.Value)
                                            {
                                                //exportOfferInvoice1.Discount = Convert.ToDouble(dr["Discount"]);
                                                string discount = dr["DiscountRate"].ToString();
                                                articleItems1.Discount = Convert.ToDouble(discount);
                                            }
                                            if (dr["TotalPrice"] != DBNull.Value)
                                            {
                                                string TotalPrice = dr["TotalPrice"].ToString();
                                                articleItems1.TotalPrice = Convert.ToDouble(TotalPrice);
                                            }
                                            if (dr["PackingSize"] != DBNull.Value) //chitra.girigosavi APIGEOS-1194 30 / 07 / 2024 MEJORAS EN GEOS2 SRM
                                            {
                                                articleItems.PackingSize = Convert.ToInt32(dr["PackingSize"].ToString());
                                            }
                                            purchaseOrderExport._ArticleItemsLst.Add(articleItems1);
                                        }
                                        try
                                        {
                                            if (articleItems.PackingSize > 1)
                                            {
                                                if (purchaseOrderExport._ArticleItemsLst == null)
                                                    purchaseOrderExport._ArticleItemsLst = new List<ArticleItems>();
                                                ArticleItems articleItems2 = new ArticleItems();

                                                articleItems2.Description = "PackingSize";

                                                if (dr["PackingSize"] != DBNull.Value) //chitra.girigosavi APIGEOS-1194 30 / 07 / 2024 MEJORAS EN GEOS2 SRM
                                                {
                                                    articleItems2.PackingSize = Convert.ToInt32(dr["PackingSize"].ToString());
                                                }
                                                purchaseOrderExport._ArticleItemsLst.Add(articleItems2);
                                            }

                                        }
                                        catch (Exception ex)
                                        {
                                            Log4NetLogger.Logger.Log(string.Format("Error ExportPurchaseOrder(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                        }
                                    }
                                }
                                //purchaseOrderExport._ArticleItemsLst.Add(articleItems);
                            }
                            #endregion
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method ExportPurchaseOrder()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error ExportPurchaseOrder(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            Workbook workbook = new Workbook();
            #region CultureInfo
            if (purchaseOrderExport != null)
            {
                string cultureByPlantOwnerAndISO = GetCultureByPlantOwner(Plant, siteConnectionString);
                string CultureByPlantOwner = string.Empty;
                if (!string.IsNullOrEmpty(cultureByPlantOwnerAndISO))
                {
                    CultureByPlantOwner = Lang.ToLower() + "-" + cultureByPlantOwnerAndISO;
                }
                // List<Languages> Languag = Getlanguages(_ConnEmdepGeosString);//[rdixit][APIGEOS-566][25.07.2022]
                // Languages getLanguag = Languag.Where(l => l.TwoLetterISOLanguage.Equals(Lang.ToLower())).FirstOrDefault();
                if (!Lang.ToLower().Equals("en"))
                {
                    if (getLanguage != null)
                    {
                        CultureInfo myCIintl = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName, true);
                        workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName);
                    }
                    else
                    {
                        CultureInfo myCIintl = new CultureInfo("en-GB", true);
                        workbook.Options.Culture = new CultureInfo("en-GB");
                    }
                }
                else
                {
                    #region CultureInfo
                    List<CultureInfo> culture = CultureInfo.GetCultures(CultureTypes.AllCultures).Where<CultureInfo>(c => c.Name.EndsWith(CultureByPlantOwner)).ToList();
                    if (culture != null && culture.Count > 0)
                    {
                        workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(CultureByPlantOwner) ? "en-GB" : CultureByPlantOwner);
                    }
                    else
                    {
                        string plantName = cultureByPlantOwnerAndISO;
                        List<CultureInfo> ifCultureNotexist = CultureInfo.GetCultures(CultureTypes.AllCultures).Where<CultureInfo>(c => c.Name.EndsWith(plantName)).ToList();
                        Languages setCulture = null;
                        if (ifCultureNotexist.Count() == 1)
                        {
                            setCulture = new Languages();
                            setCulture.CultureName = ifCultureNotexist[0].Name;
                        }
                        else
                        {
                            foreach (var item in ifCultureNotexist)
                            {
                                setCulture = Languages.Where(s => s.TwoLetterISOLanguage.Equals(item.Parent.Name)).FirstOrDefault();
                                if (setCulture != null)
                                {
                                    setCulture.CultureName = item.Name;
                                    break;
                                }
                            }
                        }

                        if (setCulture != null)
                        {
                            CultureInfo myCIintl = new CultureInfo(string.IsNullOrEmpty(setCulture.CultureName) ? "en-GB" : setCulture.CultureName, true);
                            if (myCIintl != null)
                            {
                                workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(setCulture.CultureName) ? "en-GB" : setCulture.CultureName);
                            }

                        }
                        else
                        {
                            if (getLanguage != null)
                            {
                                CultureInfo myCIintl = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName, true);
                                workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName);
                            }
                            else
                            {
                                CultureInfo myCIintl = new CultureInfo("en-GB", true);
                                workbook.Options.Culture = new CultureInfo("en-GB");
                            }

                        }

                    }
                    #endregion

                }

            }
            #endregion
            byte[] excelTemplateInByte = GetOfferExportChart(Convert.ToInt32(IdPo), POExpenceExcelPath);
            if (excelTemplateInByte == null)
            {
                throw new FileNotFoundException("File does not exist or File is open - " + POExpenceExcelPath);
            }
            workbook.LoadDocument(excelTemplateInByte, DocumentFormat.Xlsx);
            Worksheet wsDl = workbook.Worksheets[2];
            string filenameExcel = null;
            string filenamePDF = null;
            string PODeliveryDate = null;
            DateTime PODate = Convert.ToDateTime(DateTime.Now);
            if (!string.IsNullOrEmpty(purchaseOrderExport._PODeliveryDate))
            {
                PODate = DateTime.ParseExact(purchaseOrderExport._PODeliveryDate, "dd-MM-yyyy", CultureInfo.InvariantCulture);
            }
            PODeliveryDate = string.Concat(PODate.Year, PODate.Month.ToString().PadLeft(2, '0'), PODate.Day.ToString().PadLeft(2, '0'));
            string updatedExcelFilePath = POFilePath.Replace("{0}", Plant);
            updatedExcelFilePath = updatedExcelFilePath.Replace("{YEAR}", purchaseOrderExport._Year);
            updatedExcelFilePath = updatedExcelFilePath.Replace("{PO_Number}", purchaseOrderExport._POCode);
            updatedExcelFilePath = updatedExcelFilePath + @"\"; /*+ purchaseOrderExport._POCode + @"\";*/
            if (!System.IO.Directory.Exists(updatedExcelFilePath))
            {
                System.IO.Directory.CreateDirectory(updatedExcelFilePath);
            }
            string search = "PO_" + purchaseOrderExport._POCode + ".*";
            FileInfo[] files = new DirectoryInfo(updatedExcelFilePath + "\\")
            .GetFiles(search)
            .OrderBy(f => f.CreationTime)
            .ToArray();
            var allfiles = files.ToList();
            filenameExcel = "PO_" + purchaseOrderExport._POCode + ".xlsx";
            filenamePDF = "PO_" + purchaseOrderExport._POCode + ".pdf";
            
            #region getIndexValue
            Int32 Index_PoCode = 0;
            Int32 Index_PoDate = 0;
            Int32 Index_PoDeliveryDate = 0;
            Int32 Index_PoIncoterms = 0;
            Int32 Index_PaymentTerms = 0; //[001][kshinde][APIGEOS-564][15/07/2022]
            Int32 Index_PlantRegisteredName = 0;
            Int32 Index_PlantStreet = 0;
            Int32 Index_PlantZipCode = 0;
            Int32 Index_PlantCity = 0;
            Int32 Index_PlantState = 0;
            Int32 Index_PlantCountry = 0;
            Int32 Index_PlantPhone = 0;
            Int32 Index_PlantRegistrationNumber = 0; //[001][kshinde][APIGEOS-563][14/07/2022]
            Int32 Index_SupplierName = 0;
            Int32 Index_SupplierStreet = 0;
            Int32 Index_SupplierZipCode = 0;
            Int32 Index_SupplierCity = 0;
            Int32 Index_SupplierState = 0;
            Int32 Index_SupplierCountry = 0;
            Int32 Index_SupplierPhone = 0;
            Int32 Index_SupplierContactName = 0;
            Int32 Index_SupplierContactEmail = 0;
            Int32 Index_SupplierNotes = 0;           //[001][kshinde][APIGEOS-565][18/07/2022]
            Int32 Index_SupplierContactPhone = 0;     //[001][kshinde][APIGEOS-569][20/07/2022]
            Int32 Index_DeliveryAddressWarehouseName = 0;
            Int32 Index_DeliveryAddressStreet = 0;
            Int32 Index_DeliveryAddressZipCode = 0;
            Int32 Index_DeliveryAddressCity = 0;
            Int32 Index_DeliveryAddressState = 0;
            Int32 Index_DeliveryAddressCountry = 0;
            Int32 Index_DeliveryAddressPhone = 0;
            Int32 Index_Remarks = 0;
            Int32 Index_Observations = 0;
            Int32 Index_PurchasingContactName = 0;
            Int32 Index_PurchasingContactEmail = 0;
            Int32 Language = 0;
            Int32 PoCurrency = 0;                   //[001][kshinde][APIGEOS-575][22/07/2022]

            Int32 PO_count = 0;
            Int32 Index_ItemsStartRow = 0;
            string Index_ItemArticleColumn = string.Empty;
            string Index_ItemDescriptionColumn = string.Empty;
            string Index_ItemUnitPriceColumn = string.Empty;
            string Index_ItemQuantityColumn = string.Empty;
            string Index_ItemTotalPriceColumn = string.Empty;
            //string Index_ItemPackingSizeColumn = string.Empty; //chitra.girigosavi APIGEOS-1194 30/07/2024 MEJORAS EN GEOS2 SRM

            string POItem_lblColArticle = string.Empty;
            string POItem_lblColDescription = string.Empty;
            string POItem_lblColUnitPrice = string.Empty;
            string POItem_lblColQuantity = string.Empty;
            string POItem_lblColTotalPrice = string.Empty;
            string POItem_lblDiscount = string.Empty;
            string POItem_lblPackingSize = string.Empty; //chitra.girigosavi APIGEOS-1194 30/07/2024 MEJORAS EN GEOS2 SRM
            #endregion

            #region getItemsValue  
            Int32 PO_counts = 0;
            Int32 Items_ItemsStartRow = 0;                                               //[001][kshinde][APIGEOS-586][10/08/2022]
            string Items_ItemArticleColumn = string.Empty;
            string Items_ItemDescriptionColumn = string.Empty;
            string Items_ItemUnitPriceColumn = string.Empty;
            string Items_ItemQuantityColumn = string.Empty;
            string Items_ItemTotalPriceColumn = string.Empty;

            string POItems_lblColArticle = string.Empty;
            string POItems_lblColDescription = string.Empty;
            string POItems_lblColUnitPrice = string.Empty;
            string POItems_lblColQuantity = string.Empty;
            string POItems_lblColTotalPrice = string.Empty;
            string POItems_lblDiscount = string.Empty;
            string POItems_lblPackingSize = string.Empty; //chitra.girigosavi APIGEOS-1194 30/07/2024 MEJORAS EN GEOS2 SRM
            #endregion

            Worksheet wsTranslations = workbook.Worksheets[4];
            #region getIndex
            for (int s = 0; s < 400; s++)
            {

                #region getValue Using if  
                //[001][kshinde][APIGEOS-586][16/08/2022]
                if ((wsTranslations.Cells[s, 0].Value.ToString() == "Items_lblColArticle_" + Lang.ToLower()))
                {
                    POItems_lblColArticle = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Items_lblColDescription_" + Lang.ToLower()))
                {
                    POItems_lblColDescription = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Items_lblColUnitPrice_" + Lang.ToLower()))
                {
                    POItems_lblColUnitPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Items_lblColQuantity_" + Lang.ToLower()))
                {
                    POItems_lblColQuantity = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Items_lblColTotalPrice_" + Lang.ToLower()))
                {
                    POItems_lblColTotalPrice = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Index_lblDiscount_" + Lang.ToLower()))
                {
                    POItems_lblDiscount = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Items_lblPackingSize_" + Lang.ToLower())) //chitra.girigosavi APIGEOS-1194 30/07/2024 MEJORAS EN GEOS2 SRM
                {
                    POItems_lblPackingSize = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                }
                #endregion

                #region getIndex Using switch                           
                switch (wsDl.Cells[s, 0].Value.ToString())
                {
                    case "Index_PoCode":
                        Index_PoCode = s;
                        break;
                    case "Index_PoDate":
                        Index_PoDate = s;
                        break;
                    case "Index_PoDeliveryDate":
                        Index_PoDeliveryDate = s;
                        break;
                    case "Index_PoIncoterms":
                        Index_PoIncoterms = s;
                        break;
                    case "Index_PaymentTerms": //[001][kshinde][APIGEOS-564][15/07/2022]
                        Index_PaymentTerms = s;
                        break;
                    case "Index_PlantRegisteredName":
                        Index_PlantRegisteredName = s;
                        break;
                    case "Index_PlantStreet":
                        Index_PlantStreet = s;
                        break;
                    case "Index_PlantZipCode":
                        Index_PlantZipCode = s;
                        break;
                    case "Index_PlantCity":
                        Index_PlantCity = s;
                        break;
                    case "Index_PlantState":
                        Index_PlantState = s;
                        break;
                    case "Index_PlantCountry":
                        Index_PlantCountry = s;
                        break;
                    case "Index_PlantPhone":
                        Index_PlantPhone = s;
                        break;
                    case "Index_PlantRegistrationNumber": //[001][kshinde][APIGEOS-563][14/07/2022]
                        Index_PlantRegistrationNumber = s;
                        break;
                    case "Index_SupplierName":
                        Index_SupplierName = s;
                        break;
                    case "Index_SupplierStreet":
                        Index_SupplierStreet = s;
                        break;
                    case "Index_SupplierZipCode":
                        Index_SupplierZipCode = s;
                        break;
                    case "Index_SupplierCity":
                        Index_SupplierCity = s;
                        break;
                    case "Index_SupplierState":
                        Index_SupplierState = s;
                        break;
                    case "Index_SupplierCountry":
                        Index_SupplierCountry = s;
                        break;
                    case "Index_SupplierPhone":
                        Index_SupplierPhone = s;
                        break;
                    case "Index_SupplierContactName":
                        Index_SupplierContactName = s;
                        break;
                    case "Index_SupplierContactEmail":
                        Index_SupplierContactEmail = s;
                        break;
                    case "Index_SupplierNotes":              //[001][kshinde][APIGEOS-565][18/07/2022]
                        Index_SupplierNotes = s;
                        break;
                    case "Index_DeliveryAddressWarehouseName":
                        Index_DeliveryAddressWarehouseName = s;
                        break;
                    case "Index_DeliveryAddressStreet":
                        Index_DeliveryAddressStreet = s;
                        break;
                    case "Index_DeliveryAddressZipCode":
                        Index_DeliveryAddressZipCode = s;
                        break;
                    case "Index_DeliveryAddressCity":
                        Index_DeliveryAddressCity = s;
                        break;
                    case "Index_DeliveryAddressState":
                        Index_DeliveryAddressState = s;
                        break;
                    case "Index_DeliveryAddressCountry":
                        Index_DeliveryAddressCountry = s;
                        break;
                    case "Index_DeliveryAddressPhone":
                        Index_DeliveryAddressPhone = s;
                        break;
                    case "Index_PurchasingContactName":
                        Index_PurchasingContactName = s;
                        break;
                    case "Index_PurchasingContactEmail":
                        Index_PurchasingContactEmail = s;
                        break;
                    case "Index_SupplierContactPhone":        //[001][kshinde][APIGEOS-569][20/07/2022]
                        Index_SupplierContactPhone = s;
                        break;
                    case "PoCurrency":        //[001][kshinde][APIGEOS-575][22/07/2022]
                        PoCurrency = s;
                        break;


                    #region Expenses_Items     
                    case "Index_ItemsStartRow":
                        PO_count = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        Index_ItemsStartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Index_ItemArticleColumn":
                        Index_ItemArticleColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Index_ItemDescriptionColumn":
                        Index_ItemDescriptionColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Index_ItemUnitPriceColumn":
                        Index_ItemUnitPriceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Index_ItemQuantityColumn":
                        Index_ItemQuantityColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Index_ItemTotalPriceColumn":
                        Index_ItemTotalPriceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    #endregion

                    case "Language":
                        Language = s;
                        break;
                    case "Index_Remarks":
                        Index_Remarks = s;
                        break;
                    case "Index_Observations": //chitra[cgirigosavi][APIGEOS - 788]
                        Index_Observations = s;
                        break;
                    default:
                        break;

                    #region Expenses_Items_Items    
                    case "Items_ItemsStartRow":                                                       //[001][kshinde][APIGEOS-586][16/08/2022] 
                        PO_counts = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        Items_ItemsStartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Items_ItemArticleColumn":
                        Items_ItemArticleColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Items_ItemDescriptionColumn":
                        Items_ItemDescriptionColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Items_ItemUnitPriceColumn":
                        Items_ItemUnitPriceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Items_ItemQuantityColumn":
                        Items_ItemQuantityColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                    case "Items_ItemTotalPriceColumn":
                        Items_ItemTotalPriceColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                        break;
                        #endregion


                }
                #endregion

            }
            #endregion

            using (stream = new FileStream(Path.Combine(updatedExcelFilePath, filenameExcel), FileMode.Create, FileAccess.ReadWrite))
            {
                cultureInfo = new CultureInfo(workbook.Options.Culture.Name);
                #region Set CultureInfo DeliveryDate
                if (!String.IsNullOrEmpty(purchaseOrderExport._PODeliveryDate))
                {
                    DateTime dt = DateTime.ParseExact(purchaseOrderExport._PODeliveryDate, "dd-MM-yyyy", null);
                    wsDl.Cells[Index_PoDeliveryDate, 1].Value = dt.ToString(cultureInfo.DateTimeFormat.ShortDatePattern, cultureInfo);
                }
                else
                {
                    wsDl.Cells[Index_PoDeliveryDate, 1].Value = purchaseOrderExport._PODeliveryDate;
                }
                #endregion

                #region Set CultureInfo PoDate
                if (!String.IsNullOrEmpty(purchaseOrderExport._PODate))
                {
                    DateTime dt = DateTime.ParseExact(purchaseOrderExport._PODate, "dd-MM-yyyy", null);
                    wsDl.Cells[Index_PoDate, 1].Value = dt.ToString(cultureInfo.DateTimeFormat.ShortDatePattern, cultureInfo);
                }
                else
                {
                    wsDl.Cells[Index_PoDate, 1].Value = purchaseOrderExport._PODate;
                }
                #endregion

                #region cell entry

                wsDl.Cells[Index_PoCode, 1].Value = purchaseOrderExport._POCode;
                wsDl.Cells[Index_PoIncoterms, 1].Value = purchaseOrderExport._PoIncoterms;
                wsDl.Cells[Index_PaymentTerms, 1].Value = purchaseOrderExport._PaymentTerms; //[001][kshinde][APIGEOS-564][15/07/2022]
                wsDl.Cells[Index_PlantRegisteredName, 1].Value = purchaseOrderExport._PlantRegisteredName;
                wsDl.Cells[Index_PlantStreet, 1].Value = purchaseOrderExport._PlantStreet;
                wsDl.Cells[Index_PlantZipCode, 1].Value = purchaseOrderExport._PlantZipCode;
                wsDl.Cells[Index_PlantCity, 1].Value = purchaseOrderExport._PlantCity;
                wsDl.Cells[Index_PlantState, 1].Value = purchaseOrderExport._PlantState;
                wsDl.Cells[Index_PlantRegisteredName, 1].Value = purchaseOrderExport._PlantRegisteredName;
                wsDl.Cells[Index_PlantCountry, 1].Value = purchaseOrderExport._PlantCountry;
                wsDl.Cells[Index_PlantPhone, 1].Value = purchaseOrderExport._PlantPhone;
                wsDl.Cells[Index_PlantRegistrationNumber, 1].Value = purchaseOrderExport._PlantRegistrationNumber; //[001][kshinde][APIGEOS-563][14/07/2022]
                wsDl.Cells[Index_SupplierName, 1].Value = purchaseOrderExport._SupplierName;
                wsDl.Cells[Index_SupplierStreet, 1].Value = purchaseOrderExport._SupplierStreet;
                wsDl.Cells[Index_SupplierZipCode, 1].Value = purchaseOrderExport._SupplierZipCode;
                wsDl.Cells[Index_SupplierCity, 1].Value = purchaseOrderExport._SupplierCity;
                wsDl.Cells[Index_SupplierState, 1].Value = purchaseOrderExport._SupplierState;
                wsDl.Cells[Index_SupplierCountry, 1].Value = purchaseOrderExport._SupplierCountry;
                wsDl.Cells[Index_SupplierPhone, 1].Value = purchaseOrderExport._SupplierPhone;
                wsDl.Cells[Index_SupplierContactName, 1].Value = purchaseOrderExport._SupplierContactName;
                wsDl.Cells[Index_SupplierContactEmail, 1].Value = purchaseOrderExport._SupplierContactEmail;
                if (!string.IsNullOrEmpty(purchaseOrderExport._SupplierNotes))
                {
                    wsDl.Cells[Index_SupplierNotes, 1].Value = purchaseOrderExport._SupplierNotes;                  //[001][kshinde][APIGEOS-565][18/07/2022]
                }
                wsDl.Cells[Index_SupplierContactPhone, 1].Value = purchaseOrderExport._SupplierContactPhone;   //[001][kshinde][APIGEOS-569][20/07/2022]
                wsDl.Cells[PoCurrency, 1].Value = purchaseOrderExport._PoCurrency;                               //[001][kshinde][APIGEOS-575][22/07/2022]
                wsDl.Cells[Index_DeliveryAddressWarehouseName, 1].Value = purchaseOrderExport._DeliveryAddressWarehouseName;
                wsDl.Cells[Index_DeliveryAddressStreet, 1].Value = purchaseOrderExport._DeliveryAddressStreet;
                wsDl.Cells[Index_DeliveryAddressZipCode, 1].Value = purchaseOrderExport._DeliveryAddressZipCode;
                wsDl.Cells[Index_DeliveryAddressCity, 1].Value = purchaseOrderExport._DeliveryAddressCity;
                wsDl.Cells[Index_DeliveryAddressState, 1].Value = purchaseOrderExport._DeliveryAddressState;
                wsDl.Cells[Index_DeliveryAddressCountry, 1].Value = purchaseOrderExport._DeliveryAddressCountry;
                wsDl.Cells[Index_DeliveryAddressPhone, 1].Value = purchaseOrderExport._DeliveryAddressPhone;
                wsDl.Cells[Index_Remarks, 1].Value = purchaseOrderExport._Remarks;
                if (!string.IsNullOrEmpty(purchaseOrderExport._Observations))
                {
                    wsDl.Cells[Index_Observations, 1].Value = purchaseOrderExport._Observations;
                }
                wsDl.Cells[Index_PurchasingContactName, 1].Value = purchaseOrderExport._PurchasingContactName;
                wsDl.Cells[Index_PurchasingContactEmail, 1].Value = purchaseOrderExport._PurchasingContactEmail;
                wsDl.Cells[Language, 1].Value = Lang.ToLower();
                #endregion

                #region ExportExpensesListItems       
                if (purchaseOrderExport._ArticleItemsLst != null)                                                        //[001][kshinde][APIGEOS-586][16/08/2022]
                {
                    Int32 Expenses_ItemsHeadingStartRow = Convert.ToInt32(PO_counts) - 1;
                    Worksheet wsDlExpensesItems = workbook.Worksheets[1];
                    wsDlExpensesItems.Cells[Items_ItemArticleColumn + (Items_ItemsStartRow - 1)].Value = POItems_lblColArticle;
                    wsDlExpensesItems.Cells[Items_ItemDescriptionColumn + (Items_ItemsStartRow - 1)].Value = POItems_lblColDescription;
                    wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + (Items_ItemsStartRow - 1)].Value = POItems_lblColUnitPrice;
                    wsDlExpensesItems.Cells[Items_ItemQuantityColumn + (Items_ItemsStartRow - 1)].Value = POItems_lblColQuantity;
                    wsDlExpensesItems.Cells[Items_ItemTotalPriceColumn + (Items_ItemsStartRow - 1)].Value = POItems_lblColTotalPrice;

                    if (purchaseOrderExport._ArticleItemsLst.Count > 1)
                        wsDlExpensesItems.Rows.Insert(Expenses_ItemsHeadingStartRow + 1, purchaseOrderExport._ArticleItemsLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                    if (purchaseOrderExport._ArticleItemsLst != null)
                        foreach (ArticleItems item in purchaseOrderExport._ArticleItemsLst)
                        {
                            if (item.Description.Equals("Discount"))
                            {
                                wsDlExpensesItems.Cells[Items_ItemArticleColumn + Items_ItemsStartRow].Value = item.ArticleName;
                                //wsDlExpensesItems.Cells[Items_ItemArticleColumn + Items_ItemsStartRow].FillColor = Color.Black;
                                wsDlExpensesItems.Cells[Items_ItemDescriptionColumn + Items_ItemsStartRow].Value = (POItems_lblDiscount + " (" + item.Discount + "%)");
                                #region
                                //wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + Items_ItemsStartRow].Value = (item.Qty * item.UnitPrice);
                                #endregion
                                wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + Items_ItemsStartRow].Value = item.Qty * item.UnitPrice;
                                if (item.Qty == -1)
                                {
                                    item.Qty = 1;
                                    wsDlExpensesItems.Cells[Items_ItemQuantityColumn + Items_ItemsStartRow].Value = item.Qty;
                                    wsDlExpensesItems.Cells[Items_ItemQuantityColumn + Items_ItemsStartRow].Value = null;
                                }
                                //wsDlExpensesItems.Cells[Items_ItemTotalPriceColumn + (Items_ItemsStartRow)].Value = null;
                                //wsDlExpensesItems.Cells[Items_ItemTotalPriceColumn + (Items_ItemsStartRow - 1)].Value = (item.TotalPrice - item.UnitPrice);
                                //wsDlExpensesItems.Cells[Items_ItemQuantityColumn + Items_ItemsStartRow].Value = item.Qty;
                                wsDlExpensesItems.Rows[(Items_ItemsStartRow - 1)].Font.Bold = true;
                                if (Items_ItemsStartRow / 3 == 0)
                                {
                                    wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + Items_ItemsStartRow].Font.Color = Color.White;
                                    wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + Items_ItemsStartRow].FillColor = Color.White;
                                    wsDlExpensesItems.Cells[Items_ItemQuantityColumn + Items_ItemsStartRow].Font.Color = Color.White;
                                    wsDlExpensesItems.Cells[Items_ItemQuantityColumn + Items_ItemsStartRow].FillColor = Color.White;
                                    wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + (Items_ItemsStartRow - 0)].Font.Color = Color.White;
                                    wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + (Items_ItemsStartRow - 0)].FillColor = Color.White;
                                    wsDlExpensesItems.Cells[Items_ItemTotalPriceColumn + (Items_ItemsStartRow - 1)].Font.Color = Color.White;
                                }
                                else
                                {
                                    wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + Items_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                    wsDlExpensesItems.Cells[Items_ItemQuantityColumn + Items_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                    wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + (Items_ItemsStartRow - 0)].Font.Color = Color.FromArgb(0, 0, 0);
                                    wsDlExpensesItems.Cells[Items_ItemTotalPriceColumn + (Items_ItemsStartRow - 1)].Font.Color = Color.FromArgb(0, 0, 0);
                                    wsDlExpensesItems.Cells[Items_ItemTotalPriceColumn + (Items_ItemsStartRow - 0)].Font.Color = Color.FromArgb(242, 242, 242);

                                }

                            }
                            else if (item.Description.Equals("PackingSize"))
                            {
                                wsDlExpensesItems.Cells[Items_ItemArticleColumn + Items_ItemsStartRow].Value = item.ArticleName;
                                item.Qty = 1;
                                wsDlExpensesItems.Cells[Items_ItemQuantityColumn + Items_ItemsStartRow].Value = item.Qty;
                                wsDlExpensesItems.Cells[Items_ItemQuantityColumn + Items_ItemsStartRow].Value = null;
                                wsDlExpensesItems.Cells[Items_ItemDescriptionColumn + Items_ItemsStartRow].Value = (POItems_lblPackingSize + " (" + item.PackingSize + ")");

                                wsDlExpensesItems.Rows[(Items_ItemsStartRow - 1)].Font.Bold = true;
                                if (Items_ItemsStartRow / 3 == 0)
                                {
                                    wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + Items_ItemsStartRow].Font.Color = Color.White;
                                    wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + Items_ItemsStartRow].FillColor = Color.White;
                                    wsDlExpensesItems.Cells[Items_ItemQuantityColumn + Items_ItemsStartRow].Font.Color = Color.White;
                                    wsDlExpensesItems.Cells[Items_ItemQuantityColumn + Items_ItemsStartRow].FillColor = Color.White;
                                    wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + (Items_ItemsStartRow - 0)].Font.Color = Color.White;
                                    wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + (Items_ItemsStartRow - 0)].FillColor = Color.White;
                                    wsDlExpensesItems.Cells[Items_ItemTotalPriceColumn + (Items_ItemsStartRow - 1)].Font.Color = Color.White;
                                }
                                else
                                {
                                    wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + Items_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                    wsDlExpensesItems.Cells[Items_ItemQuantityColumn + Items_ItemsStartRow].Font.Color = Color.FromArgb(242, 242, 242);
                                    wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + (Items_ItemsStartRow - 0)].Font.Color = Color.FromArgb(0, 0, 0);
                                    wsDlExpensesItems.Cells[Items_ItemTotalPriceColumn + (Items_ItemsStartRow - 1)].Font.Color = Color.FromArgb(0, 0, 0);
                                    wsDlExpensesItems.Cells[Items_ItemTotalPriceColumn + (Items_ItemsStartRow - 0)].Font.Color = Color.FromArgb(242, 242, 242);

                                }
                            }
                            else
                            {
                                if (item.ArticleID == 3252)
                                {
                                    RichTextString richText = new RichTextString();
                                    SpreadsheetFont cellFont = wsDlExpensesItems.Cells[Items_ItemDescriptionColumn + Items_ItemsStartRow].Font;
                                    RichTextRunFont RichTextForSummaryColumn = new RichTextRunFont(cellFont.Name, (cellFont.Size), cellFont.Color);
                                    RichTextRunFont RichText = new RichTextRunFont(cellFont.Name, (cellFont.Size - 3), cellFont.Color);
                                    RichText.Italic = true;
                                    try
                                    {
                                        richText.AddTextRun(item.Description, RichText);
                                        wsDlExpensesItems.Cells[Items_ItemArticleColumn + Items_ItemsStartRow].Value = "";
                                        wsDlExpensesItems.Cells[Items_ItemDescriptionColumn + Items_ItemsStartRow].SetRichText(richText);
                                        // wsDlExpensesItems.Cells[Items_ItemDescriptionColumn + Items_ItemsStartRow].Value = item.Description;
                                        // wsDlExpensesItems.Cells[Items_ItemDescriptionColumn + Items_ItemsStartRow].Font.Italic = true;
                                        // wsDlExpensesItems.Cells[Items_ItemQuantityColumn + Items_ItemsStartRow].Value = null;
                                        //wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + Items_ItemsStartRow].Value = null;
                                        wsDlExpensesItems.Cells[Items_ItemTotalPriceColumn + Items_ItemsStartRow].Value = null;
                                    }
                                    catch (Exception ex)
                                    {
                                    }
                                }
                                else
                                {
                                    wsDlExpensesItems.Cells[Items_ItemArticleColumn + Items_ItemsStartRow].Value = item.ArticleName;
                                    //wsDlExpensesItems.Cells[Items_ItemArticleColumn + Items_ItemsStartRow].Font.Color = Color.Black;
                                    wsDlExpensesItems.Cells[Items_ItemDescriptionColumn + Items_ItemsStartRow].Value = item.Description;
                                    // wsDlExpensesItems.Rows[(Items_ItemsStartRow - 2)].Font.Bold = true;
                                    // wsDlExpensesItems.Cells[Items_ItemDescriptionColumn + Items_ItemsStartRow].Font.Bold = true;

                                    //if (wsDlExpensesItems.Cells[Items_ItemArticleColumn + Items_ItemsStartRow].Value.TextValue=="_DISCOUNT")
                                    //{

                                    if (item.ArticleID == 13339)
                                    {
                                        wsDlExpensesItems.Cells[Items_ItemArticleColumn + Items_ItemsStartRow].Value = null;
                                        wsDlExpensesItems.Cells[Items_ItemDescriptionColumn + Items_ItemsStartRow].Font.Bold = true;
                                        wsDlExpensesItems.Cells[Items_ItemTotalPriceColumn + Items_ItemsStartRow].Font.Bold = true;
                                        wsDlExpensesItems.Cells[Items_ItemQuantityColumn + Items_ItemsStartRow].Font.Color = Color.FromArgb(248, 249, 250);
                                        wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + Items_ItemsStartRow].Font.Color = Color.FromArgb(248, 249, 250);
                                    }
                                    wsDlExpensesItems.Cells[Items_ItemQuantityColumn + Items_ItemsStartRow].Value = item.Qty;
                                    wsDlExpensesItems.Cells[Items_ItemUnitPriceColumn + Items_ItemsStartRow].Value = item.UnitPrice;
                                    //wsDlExpensesItems.Cells[Items_ItemTotalPriceColumn + Items_ItemsStartRow].Value = item.TotalPrice;
                                }
                            }
                            Items_ItemsStartRow = Items_ItemsStartRow + 1;
                        }
                }
                else
                {
                    workbook.Worksheets[0].Visible = false;
                }
                #endregion

                workbook.Worksheets[2].Visible = false;
                //workbook.Worksheets[3].Visible = false;
                workbook.Worksheets[4].Visible = false;
                workbook.SaveDocument(stream, DocumentFormat.Xlsx);
                isDone = true;
            }
            // Added By Rahul[rgadhave][APIGEOS-1038][Date:21-02-2024]
            try
            {
                string originalPdfFilePath = Path.Combine(updatedExcelFilePath, filenamePDF);
                string tempPdfFilePath = Path.Combine(updatedExcelFilePath, "temp_" + filenamePDF);

                // Export workbook to PDF
                using (FileStream pdfFileStream = new FileStream(originalPdfFilePath, FileMode.Create))
                {

                    workbook.ExportToPdf(pdfFileStream);
                }
                string Pocode = purchaseOrderExport._POCode;
                // Now, let's modify the PDF to add the PO code to all pages starting from the second page
                using (var pdfReader = new iTextSharp.text.pdf.PdfReader(originalPdfFilePath))
                {
                    using (var output = new FileStream(tempPdfFilePath, FileMode.Create, FileAccess.Write, FileShare.None))
                    {
                        using (var pdfStamper = new iTextSharp.text.pdf.PdfStamper(pdfReader, output))
                        {
                            // Iterate over all pages in the PDF
                            for (int pageIndex = 1; pageIndex <= pdfReader.NumberOfPages; pageIndex++)
                            {
                                pdfStamper.FormFlattening = false;
                                iTextSharp.text.Rectangle pageRectangle = pdfReader.GetPageSizeWithRotation(pageIndex);
                                iTextSharp.text.pdf.PdfContentByte pdfData = pdfStamper.GetOverContent(pageIndex);

                                // Set font and size
                                System.Drawing.Font calibriLightFont = new System.Drawing.Font("Calibri Light", 8);

                                // Add PO code to the top-right corner
                                float x = pageRectangle.Right - 11; // Adjust as needed
                                float y = pageRectangle.Top - 11; // Adjust as needed

                                pdfData.BeginText();
                                pdfData.SetRGBColorFill(0, 0, 0);
                                var gstate = new iTextSharp.text.pdf.PdfGState
                                {
                                    FillOpacity = 0.61f // Adjust opacity as needed (0.0f for fully transparent, 1.0f for fully opaque)
                                };

                                pdfData.SetGState(gstate);
                                pdfData.SetFontAndSize(iTextSharp.text.pdf.BaseFont.CreateFont(), 8);

                                // Draw text using System.Drawing.Font
                                pdfData.SetTextRenderingMode(iTextSharp.text.pdf.PdfContentByte.TEXT_RENDER_MODE_FILL);
                                pdfData.SetColorFill(new iTextSharp.text.BaseColor(0, 0, 0)); // Use iTextSharp.text.BaseColor
                                pdfData.SetFontAndSize(iTextSharp.text.pdf.BaseFont.CreateFont(), 10);
                                pdfData.ShowTextAlignedKerned(iTextSharp.text.pdf.PdfContentByte.ALIGN_RIGHT, Pocode, x, y, 0);

                                pdfData.EndText();
                            }
                        }
                    }
                }

                // Rename the temporary file to the original filename
                File.Delete(originalPdfFilePath);
                File.Move(tempPdfFilePath, originalPdfFilePath);
            }
            catch (Exception ex)
            {
                // Log or print exception details
                Console.WriteLine("Exception: " + ex.Message);
                Console.WriteLine("StackTrace: " + ex.StackTrace);

                if (ex.InnerException != null)
                {
                    Console.WriteLine("InnerException: " + ex.InnerException.Message);
                    Console.WriteLine("InnerException StackTrace: " + ex.InnerException.StackTrace);
                }
            }
            workbook.Dispose();
            if (stream != null)
            {
                stream.Dispose();
            }
            return isDone;
        }
        //[Rdixit][APIGEOS-484][26-04-2022]
        public List<Languages> Getlanguages(string connstr)
        {
            List<Languages> languagelst = new List<Languages>();
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method Getlanguages()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetLanguages", conn);
                    command.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            Languages Language = new Languages();
                            if (dr["IdLanguage"] != DBNull.Value)
                            {
                                Language.IdLanguage = Convert.ToInt32(dr["IdLanguage"].ToString());
                            }
                            if (dr["TwoLetterISOLanguage"] != DBNull.Value)
                            {
                                Language.TwoLetterISOLanguage = Convert.ToString(dr["TwoLetterISOLanguage"].ToString());
                            }
                            if (dr["Name"] != DBNull.Value)
                            {
                                Language.Name = Convert.ToString(dr["Name"].ToString());
                            }
                            if (dr["CultureName"] != DBNull.Value)
                            {
                                Language.CultureName = Convert.ToString(dr["CultureName"].ToString());
                            }
                            languagelst.Add(Language);
                        }

                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method Getlanguages()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error Getlanguages(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return languagelst;
        }
        public byte[] GetOfferExportChart(Int32 IdPo, string offerExcelPath)
        {
            byte[] bytes = null;
            string defaultFileName = @"\SupplierPO.xlsx";

            string companyFileName = string.Format("{0}{1}{2}{3}", @"\", IdPo, "_", "SupplierPO.xlsx");

            try
            {
                if (File.Exists(string.Format("{0}{1}", offerExcelPath, companyFileName)))
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(string.Format("{0}{1}", offerExcelPath, companyFileName), System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;

                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }
                }
                else if (File.Exists(string.Format("{0}{1}", offerExcelPath, defaultFileName)))
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(string.Format("{0}{1}", offerExcelPath, defaultFileName), System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;

                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }
                }


            }
            catch (FileNotFoundException ex)
            {

            }
            catch (DirectoryNotFoundException ex)
            {

            }
            catch (Exception ex)
            {

            }
            return bytes;
        }
        public string GetCultureByPlantOwner(string _ShortName, string connstr)
        {
            string Culture = string.Empty;
            List<Languages> languagelst = new List<Languages>();
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetCultureByPlantOwner()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetCultureByPlantOwner", conn);
                    command.Parameters.AddWithValue("_ShortName", _ShortName);
                    command.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {

                            if (dr["Language"] != DBNull.Value)
                            {
                                Culture = Convert.ToString(dr["Language"].ToString());
                            }

                        }

                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetCultureByPlantOwner()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error Getlanguages(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return Culture;
        }
        public Int64 IsEMDEPSiteExist(string Site, string connstr)
        {
            Int64 idSite = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsEMDEPSiteExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsEMDEPSiteExist", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_ShortName", Site);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdSite"] != DBNull.Value)
                            {
                                idSite = Convert.ToInt64(dr["IdSite"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsEMDEPSiteExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsEMDEPSiteExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idSite;
        }

        public string GetSiteConnectionString(Int64 idSite, string connstr, string Plantwiseconnectionstring)
        {
            string connectionString = null;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetSiteConnectionString()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetEMDEPSiteDetail", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_idSite", idSite);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["DatabaseIP"] != DBNull.Value)
                            {
                                connectionString = string.Format(Plantwiseconnectionstring, dr["DatabaseIP"].ToString());
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetSiteConnectionString()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetSiteConnectionString(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return connectionString;
        }

        public string error = string.Empty;
        public bool PurchasingOrdersReportsSign(CreateExpenseReportsSign createExpenseReportsSign, string mainserverConnectionString, string LoginContext, string IdPO, string expensesFilePath, string Plant, string Plantwiseconnectionstring)
        {
            bool result = false;
            string companyAlias = string.Empty;
            // Int64 IdIdPOReport = Convert.ToInt64(IdPO);
            string code = string.Empty;
            string currentYear = string.Empty;
            Int64 idSite = IsEMDEPSiteExist(Plant, mainserverConnectionString);
            error = string.Empty;
            //Updated by Rahul[rgadhave] APIGEOS-754  Support for multisign in endpoint PURCHASING->ORDERS->Sign

            string[] IdPOs = IdPO.Split(',');
            foreach (string tempIdPo in IdPOs)
            {
                if (idSite > 0)
                {
                    #region Signed
                    try
                    {
                        string siteConnectionstring = GetSiteConnectionString(idSite, mainserverConnectionString, Plantwiseconnectionstring);
                        if (IsIdPOAlreadySigned(tempIdPo, siteConnectionstring))
                        {
                            #region IsIdPONotSigned
                            if (idSite > 0)
                            {

                                // string siteConnectionstring = GetSiteConnectionString(idSite, mainserverConnectionString, Plantwiseconnectionstring);
                                #region MyRegion
                                using (MySqlConnection conn = new MySqlConnection(siteConnectionstring))
                                {
                                    conn.Open();
                                    MySqlCommand command = new MySqlCommand("GEOSAPI_PurchasingOrdersExport_V430", conn);
                                    command.CommandType = CommandType.StoredProcedure;
                                    command.Parameters.AddWithValue("_IdPO", tempIdPo);
                                    command.Parameters.AddWithValue("_idSite", idSite);
                                    using (MySqlDataReader dr = command.ExecuteReader())
                                    {
                                        while (dr.Read())
                                        {
                                            #region Get data from MySql
                                            if (dr["Code"] != DBNull.Value)
                                            {
                                                code = Convert.ToString(dr["Code"]).ToString();
                                            }
                                            //if (dr["Warehouse"] != DBNull.Value)
                                            //{
                                            //    companyAlias = Convert.ToString(dr["Warehouse"]).ToString();
                                            //}
                                            if (dr["Year"] != DBNull.Value)
                                            {
                                                currentYear = Convert.ToString(dr["Year"]).ToString();
                                            }
                                            companyAlias = Plant;
                                            #endregion
                                        }
                                    }
                                }

                                #endregion
                            }
                            //ExportExpenses exportExpenses = new ExportExpenses();
                            try
                            {
                                if (companyAlias != string.Empty)
                                {
                                    //string receiptsPDF = null;

                                    string containstr = "";
                                    string MaxRevFileName = "";
       
                                    string updatedExcelFilePath = expensesFilePath.Replace("{0}", companyAlias);
                                    updatedExcelFilePath = updatedExcelFilePath.Replace("{PO_Number}", code);
                                    updatedExcelFilePath = updatedExcelFilePath.Replace("{YEAR}", currentYear);
                                    // updatedExcelFilePath = updatedExcelFilePath + code +@"\";
                                    if (!System.IO.Directory.Exists(updatedExcelFilePath))
                                    {
                                        System.IO.Directory.CreateDirectory(updatedExcelFilePath);
                                    }
                                    #region ReceiptsFile
                                    string search = @"PO_" + code + '*' + ".pdf";
                                    FileInfo[] files = new DirectoryInfo(updatedExcelFilePath)
                                    .GetFiles(search)
                                    .ToArray();
                                    var allfiles = files.ToList();

                                    if (allfiles.Count() > 0)
                                    {
                                        //allfiles.RemoveAll(r => r.Name.Contains("Receipts"));
                                        #region getAllFiles
                                        List<string> revPDFList = new List<string>();
                                        foreach (var itemPDF in allfiles)
                                        {
                                            string substringitem = itemPDF.ToString().Split('\\').Last();
                                            revPDFList.Add(substringitem);
                                        }

                                        if (revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault() == null)
                                        {
                                            containstr = code + ".pdf";
                                        }
                                        else
                                        {
                                            List<string> maxNumberList = new List<string>();
                                            foreach (var maxNumberitem in revPDFList)
                                            {
                                                int indexofrev = maxNumberitem.IndexOf("rev");
                                                string substring = "00";
                                                if (indexofrev == -1)
                                                {
                                                    substring = "00";
                                                }
                                                else
                                                {
                                                    substring = maxNumberitem.Substring(indexofrev + 3, 2);
                                                }
                                                maxNumberList.Add(substring);
                                            }
                                            string maxNumber = maxNumberList.Max();
                                            //string str = revPDFList.Where(w => w.Contains(exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + maxNumber)).FirstOrDefault();
                                            //containstr = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + maxNumber + ".pdf";
                                            string str = revPDFList.Where(w => w.Contains(@"PO_" + code + ".pdf")).FirstOrDefault();
                                            containstr = @"PO_" + code + ".pdf";
                                        }
                                        if (containstr != null)
                                            MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, "*" + containstr + "*.*", SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                                        if (MaxRevFileName == null)
                                        {
                                            containstr = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault();
                                            if (containstr != null)
                                                MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, containstr, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                                        }
                                        if (!File.Exists(MaxRevFileName))
                                        {
                                            containstr = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault().ToString().PadLeft(2, '0');
                                            if (containstr != null)
                                                MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, containstr, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                                        }
                                        #endregion
                                    }
                                    #endregion

                                    #region Signature_Box_geos_app_settings
                                    string geos_app_settings = string.Empty;
                                    using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                                    {
                                        conn.Open();
                                        MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                        command.CommandType = CommandType.StoredProcedure;
                                        command.Parameters.AddWithValue("_IdAppSetting", 83);
                                        using (MySqlDataReader dr = command.ExecuteReader())
                                        {
                                            if (dr.Read())
                                            {
                                                if (dr["DefaultValue"] != DBNull.Value)
                                                {
                                                    geos_app_settings = Convert.ToString(dr["DefaultValue"]);
                                                }
                                            }
                                        }

                                    }

                                    List<string> app_settings = geos_app_settings.Split(';').ToList();
                                    List<string> settings = new List<string>();
                                    foreach (var item in app_settings)
                                    {
                                        settings.Add(Regex.Match(item, @"\d+").Value);
                                    }
                                    #endregion
                                    #region FullName_geos_app_settings
                                    string geos_app_settingsFullName = string.Empty;
                                    using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                                    {
                                        conn.Open();
                                        MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                        command.CommandType = CommandType.StoredProcedure;
                                        command.Parameters.AddWithValue("_IdAppSetting", 85);
                                        using (MySqlDataReader dr = command.ExecuteReader())
                                        {
                                            if (dr.Read())
                                            {
                                                if (dr["DefaultValue"] != DBNull.Value)
                                                {
                                                    geos_app_settingsFullName = Convert.ToString(dr["DefaultValue"]);
                                                }
                                            }
                                        }

                                    }

                                    List<string> Tempapp_settings = geos_app_settingsFullName.Split(';').ToList();
                                    List<string> FullNamesettings = new List<string>();
                                    foreach (var item in Tempapp_settings)
                                    {
                                        FullNamesettings.Add(Regex.Match(item, @"\d+").Value);
                                    }
                                    #endregion
                                    #region geos_app_settingsDateTime
                                    string geos_app_settingsDateTime = string.Empty;
                                    using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                                    {
                                        conn.Open();
                                        MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                        command.CommandType = CommandType.StoredProcedure;
                                        command.Parameters.AddWithValue("_IdAppSetting", 84);
                                        using (MySqlDataReader dr = command.ExecuteReader())
                                        {
                                            if (dr.Read())
                                            {
                                                if (dr["DefaultValue"] != DBNull.Value)
                                                {
                                                    geos_app_settingsDateTime = Convert.ToString(dr["DefaultValue"]);
                                                }
                                            }
                                        }

                                    }

                                    List<string> dateTimeapp_settings = geos_app_settingsDateTime.Split(';').ToList();
                                    List<string> DateTimesettings = new List<string>();
                                    foreach (var item in dateTimeapp_settings)
                                    {
                                        DateTimesettings.Add(Regex.Match(item, @"\d+").Value);
                                    }
                                    #endregion
                                    #region Header&Footer 
                                    if (File.Exists(Path.Combine(updatedExcelFilePath, containstr)))
                                    {
                                        var filePath = Path.Combine(updatedExcelFilePath, containstr);
                                        byte[] bytes = System.IO.File.ReadAllBytes(filePath);
                                        var pdfReader = new iTextSharp.text.pdf.PdfReader(bytes);
                                        using (Stream output = new FileStream(filePath, FileMode.Create, FileAccess.Write, FileShare.None))
                                        {
                                            using (iTextSharp.text.pdf.PdfStamper pdfStamper = new iTextSharp.text.pdf.PdfStamper(pdfReader, output))
                                            {

                                                for (int pageIndex = 1; pageIndex <= 1; pageIndex++)
                                                // for (int pageIndex = pdfReader.NumberOfPages; pageIndex <= pdfReader.NumberOfPages; pageIndex++)
                                                {
                                                    pdfStamper.FormFlattening = false;
                                                    iTextSharp.text.Rectangle pageRectangle = pdfReader.GetPageSizeWithRotation(pageIndex);
                                                    iTextSharp.text.pdf.PdfContentByte pdfData = pdfStamper.GetOverContent(pageIndex);
                                                    pdfData.SetFontAndSize(iTextSharp.text.pdf.BaseFont.CreateFont(iTextSharp.text.pdf.BaseFont.TIMES_BOLD, iTextSharp.text.pdf.BaseFont.CP1252,
                                                    iTextSharp.text.pdf.BaseFont.NOT_EMBEDDED), 8);
                                                    iTextSharp.text.pdf.PdfGState graphicsState = new iTextSharp.text.pdf.PdfGState
                                                    {
                                                        FillOpacity = 10F
                                                    };
                                                    pdfData.SetGState(graphicsState);
                                                    iTextSharp.text.pdf.BaseFont bf = iTextSharp.text.pdf.BaseFont.CreateFont(iTextSharp.text.pdf.BaseFont.TIMES_BOLD, iTextSharp.text.pdf.BaseFont.CP1252,
                                                    iTextSharp.text.pdf.BaseFont.NOT_EMBEDDED);
                                                    pdfData.SetColorFill(iTextSharp.text.BaseColor.BLACK);
                                                    iTextSharp.text.Font font = new iTextSharp.text.Font(bf, 8, iTextSharp.text.Font.BOLD);
                                                    pdfData.SetFontAndSize(bf, 8);


                                                    #region Footer 
                                                    pdfData.BeginText();
                                                    float w = (float)Convert.ToDouble(settings[2]);
                                                    float h = (float)Convert.ToDouble(settings[3]);
                                                    float x = (float)Convert.ToDouble(settings[0]);
                                                    float y = (float)Convert.ToDouble(settings[1]);

                                                    float xFullName = (float)Convert.ToDouble(FullNamesettings[0]);
                                                    float yFullName = (float)Convert.ToDouble(FullNamesettings[1]);
                                                    float xDateTime = (float)Convert.ToDouble(DateTimesettings[0]);
                                                    float yDateTime = (float)Convert.ToDouble(DateTimesettings[1]);

                                                    string pageNumber = 1.ToString();
                                                    pdfData.ShowTextAligned(1, createExpenseReportsSign.FullName, xFullName, yFullName, 0);
                                                    pdfData.ShowTextAligned(1, createExpenseReportsSign.DateTime, xDateTime, yDateTime, 0);
                                                    pdfData.EndText();

                                                    #region Add Signature Image 
                                                    string base64encodedstring = createExpenseReportsSign.Signature;
                                                    var base64bytes = Convert.FromBase64String(base64encodedstring);
                                                    iTextSharp.text.Image image = iTextSharp.text.Image.GetInstance(base64bytes);
                                                    image.ScaleAbsolute(w, h);
                                                    image.SetAbsolutePosition(x, y);
                                                    pdfData.AddImage(image);
                                                    #endregion
                                                    #endregion
                                                }
                                            }
                                            output.Close();
                                            output.Dispose();
                                        }

                                    }

                                    #endregion

                                }
                                //sp create [APIGEOS-602][Plahange][23-09-2022] Purchasing/Orders/Sign?IdPO=39870&PlantOwner=EAES
                                #region
                                if (idSite > 0)
                                {
                                    //string siteConnectionstring = GetSiteConnectionString(idSite, mainserverConnectionString, Plantwiseconnectionstring);
                                    using (MySqlConnection connection = new MySqlConnection(siteConnectionstring))
                                    {
                                        connection.Open();
                                        //MySqlCommand command = new MySqlCommand("PurchasingOrderSignStatus_Update", connection); //sp create [APIGEOS-602][Plahange][23-09-2022] Purchasing/Orders/Sign?IdPO=39870&PlantOwner=EAES
                                        MySqlCommand command = new MySqlCommand("PurchasingOrderSignStatus_Update_V580", connection);//APIGEOS-828 Log not inserted properly in purchasing -> orders->sign   30 05 2023
                                        command.CommandType = CommandType.StoredProcedure;
                                        command.Parameters.AddWithValue("_IdWarehousePurchaseOrder", tempIdPo);
                                        command.Parameters.AddWithValue("_UserName", loginUsername);
                                        command.Parameters.AddWithValue("_FullName", string.IsNullOrEmpty(createExpenseReportsSign.FullName) ? null : createExpenseReportsSign.FullName);
                                        command.ExecuteNonQuery();
                                    }
                                }
                                #endregion
                                //sp End
                                result = true;
                            }
                            catch (Exception ex)
                            {
                                error = error + ex.Message.ToString() + ": " + tempIdPo + ";";
                                //result = false;
                                Log4NetLogger.Logger.Log(string.Format("Error PurchasingOrdersReportsSign(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                //throw ex;
                            }
                            #endregion
                        }
                        else
                        {
                            result = true;
                            //error = error + " Invalid IdPO purchase order already signed: "+ tempIdPo + ";"; 
                        }
                    }
                    catch (Exception ex)
                    {
                        error = error + ex + ": " + tempIdPo + ";";
                        //result = false;
                        Log4NetLogger.Logger.Log(string.Format("Error PurchasingOrdersReportsSign(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                    }
                    #endregion
                }
            }
            return result;
        }

        //chitra.girigosavi APIGEOS-1646 10/03/2025
        public async Task<bool> PurchasingOrdersReportsSignAsync(CreateExpenseReportsSign createExpenseReportsSign, string mainserverConnectionString, string LoginContext, string IdPO, string expensesFilePath, string Plant, string Plantwiseconnectionstring)
        {
            bool result = false;
            string companyAlias = string.Empty;
            // Int64 IdIdPOReport = Convert.ToInt64(IdPO);
            string code = string.Empty;
            string currentYear = string.Empty;
            Int64 idSite = IsEMDEPSiteExist(Plant, mainserverConnectionString);
            error = string.Empty;
            //Updated by Rahul[rgadhave] APIGEOS-754  Support for multisign in endpoint PURCHASING->ORDERS->Sign

            string[] IdPOs = IdPO.Split(',');

            var tasks = IdPOs.Select(async tempIdPo =>
            {
                try
                {
                    if (idSite > 0)
                    {
                        #region Signed
                        try
                        {
                            string siteConnectionstring = GetSiteConnectionString(idSite, mainserverConnectionString, Plantwiseconnectionstring);
                            if (IsIdPOAlreadySigned(tempIdPo, siteConnectionstring))
                            {
                                #region IsIdPONotSigned
                                if (idSite > 0)
                                {
                                    // string siteConnectionstring = GetSiteConnectionString(idSite, mainserverConnectionString, Plantwiseconnectionstring);
                                    #region MyRegion
                                    using (var conn = new MySqlConnection(siteConnectionstring))
                                    {
                                        await conn.OpenAsync();
                                        using (var command = new MySqlCommand("GEOSAPI_PurchasingOrdersExport_V430", conn))
                                        {
                                            command.CommandType = CommandType.StoredProcedure;
                                            command.Parameters.AddWithValue("_IdPO", tempIdPo);
                                            command.Parameters.AddWithValue("_idSite", idSite);
                                            using (var dr = await command.ExecuteReaderAsync())
                                            {
                                                while (await dr.ReadAsync())
                                                {
                                                    #region Get data from MySql
                                                    if (dr["Code"] != DBNull.Value)
                                                    {
                                                        code = Convert.ToString(dr["Code"]).ToString();
                                                    }
                                                    //if (dr["Warehouse"] != DBNull.Value)
                                                    //{
                                                    //    companyAlias = Convert.ToString(dr["Warehouse"]).ToString();
                                                    //}
                                                    if (dr["Year"] != DBNull.Value)
                                                    {
                                                        currentYear = Convert.ToString(dr["Year"]).ToString();
                                                    }
                                                    companyAlias = Plant;
                                                    #endregion
                                                }
                                            }
                                        }
                                    }

                                    #endregion
                                }
                                //ExportExpenses exportExpenses = new ExportExpenses();
                                try
                                {
                                    if (companyAlias != string.Empty)
                                    {
                                        //string receiptsPDF = null;

                                        string containstr = "";
                                        string MaxRevFileName = "";
                                        #region OldCode
                                        //string expensesFromDate = null;
                                        //string expensesToDate = null;
                                        //DateTime fromDate = Convert.ToDateTime(DateTime.Now);
                                        //DateTime toDate = Convert.ToDateTime(DateTime.Now);
                                        //if (!string.IsNullOrEmpty(exportExpenses._ExpensesFromDate))
                                        //{
                                        //    fromDate = DateTime.ParseExact(exportExpenses._ExpensesFromDate, "dd-MM-yyyy", CultureInfo.InvariantCulture);
                                        //    toDate = DateTime.ParseExact(exportExpenses._ExpensesToDate, "dd-MM-yyyy", CultureInfo.InvariantCulture);
                                        //}

                                        //expensesFromDate = string.Concat(fromDate.Year, fromDate.Month.ToString().PadLeft(2, '0'), fromDate.Day.ToString().PadLeft(2, '0'));
                                        //expensesToDate = string.Concat(toDate.Year, toDate.Month.ToString().PadLeft(2, '0'), toDate.Day.ToString().PadLeft(2, '0'));
                                        #endregion
                                        string updatedExcelFilePath = expensesFilePath.Replace("{0}", companyAlias);
                                        updatedExcelFilePath = updatedExcelFilePath.Replace("{PO_Number}", code);
                                        updatedExcelFilePath = updatedExcelFilePath.Replace("{YEAR}", currentYear);
                                        // updatedExcelFilePath = updatedExcelFilePath + code +@"\";
                                        if (!System.IO.Directory.Exists(updatedExcelFilePath))
                                        {
                                            System.IO.Directory.CreateDirectory(updatedExcelFilePath);
                                        }
                                        #region ReceiptsFile
                                        string search = @"PO_" + code + '*' + ".pdf";
                                        FileInfo[] files = new DirectoryInfo(updatedExcelFilePath)
                                        .GetFiles(search)
                                        .ToArray();
                                        var allfiles = files.ToList();

                                        if (allfiles.Count() > 0)
                                        {
                                            //allfiles.RemoveAll(r => r.Name.Contains("Receipts"));
                                            #region getAllFiles
                                            List<string> revPDFList = new List<string>();
                                            foreach (var itemPDF in allfiles)
                                            {
                                                string substringitem = itemPDF.ToString().Split('\\').Last();
                                                revPDFList.Add(substringitem);
                                            }

                                            if (revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault() == null)
                                            {
                                                containstr = code + ".pdf";
                                            }
                                            else
                                            {
                                                List<string> maxNumberList = new List<string>();
                                                foreach (var maxNumberitem in revPDFList)
                                                {
                                                    int indexofrev = maxNumberitem.IndexOf("rev");
                                                    string substring = "00";
                                                    if (indexofrev == -1)
                                                    {
                                                        substring = "00";
                                                    }
                                                    else
                                                    {
                                                        substring = maxNumberitem.Substring(indexofrev + 3, 2);
                                                    }
                                                    maxNumberList.Add(substring);
                                                }
                                                string maxNumber = maxNumberList.Max();
                                                //string str = revPDFList.Where(w => w.Contains(exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + maxNumber)).FirstOrDefault();
                                                //containstr = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + maxNumber + ".pdf";
                                                string str = revPDFList.Where(w => w.Contains(@"PO_" + code + ".pdf")).FirstOrDefault();
                                                containstr = @"PO_" + code + ".pdf";
                                            }
                                            if (containstr != null)
                                                MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, "*" + containstr + "*.*", SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                                            if (MaxRevFileName == null)
                                            {
                                                containstr = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault();
                                                if (containstr != null)
                                                    MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, containstr, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                                            }
                                            if (!File.Exists(MaxRevFileName))
                                            {
                                                containstr = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault().ToString().PadLeft(2, '0');
                                                if (containstr != null)
                                                    MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, containstr, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                                            }
                                            #endregion
                                        }
                                        #endregion

                                        #region Signature_Box_geos_app_settings
                                        string geos_app_settings = string.Empty;
                                        using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                                        {
                                            conn.Open();
                                            MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                            command.CommandType = CommandType.StoredProcedure;
                                            command.Parameters.AddWithValue("_IdAppSetting", 83);
                                            using (MySqlDataReader dr = command.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    if (dr["DefaultValue"] != DBNull.Value)
                                                    {
                                                        geos_app_settings = Convert.ToString(dr["DefaultValue"]);
                                                    }
                                                }
                                            }

                                        }

                                        List<string> app_settings = geos_app_settings.Split(';').ToList();
                                        List<string> settings = new List<string>();
                                        foreach (var item in app_settings)
                                        {
                                            settings.Add(Regex.Match(item, @"\d+").Value);
                                        }
                                        #endregion
                                        #region FullName_geos_app_settings
                                        string geos_app_settingsFullName = string.Empty;
                                        using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                                        {
                                            conn.Open();
                                            MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                            command.CommandType = CommandType.StoredProcedure;
                                            command.Parameters.AddWithValue("_IdAppSetting", 85);
                                            using (MySqlDataReader dr = command.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    if (dr["DefaultValue"] != DBNull.Value)
                                                    {
                                                        geos_app_settingsFullName = Convert.ToString(dr["DefaultValue"]);
                                                    }
                                                }
                                            }

                                        }

                                        List<string> Tempapp_settings = geos_app_settingsFullName.Split(';').ToList();
                                        List<string> FullNamesettings = new List<string>();
                                        foreach (var item in Tempapp_settings)
                                        {
                                            FullNamesettings.Add(Regex.Match(item, @"\d+").Value);
                                        }
                                        #endregion
                                        #region geos_app_settingsDateTime
                                        string geos_app_settingsDateTime = string.Empty;
                                        using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                                        {
                                            conn.Open();
                                            MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                            command.CommandType = CommandType.StoredProcedure;
                                            command.Parameters.AddWithValue("_IdAppSetting", 84);
                                            using (MySqlDataReader dr = command.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    if (dr["DefaultValue"] != DBNull.Value)
                                                    {
                                                        geos_app_settingsDateTime = Convert.ToString(dr["DefaultValue"]);
                                                    }
                                                }
                                            }

                                        }

                                        List<string> dateTimeapp_settings = geos_app_settingsDateTime.Split(';').ToList();
                                        List<string> DateTimesettings = new List<string>();
                                        foreach (var item in dateTimeapp_settings)
                                        {
                                            DateTimesettings.Add(Regex.Match(item, @"\d+").Value);
                                        }
                                        #endregion
                                        #region Header&Footer 
                                        if (File.Exists(Path.Combine(updatedExcelFilePath, containstr)))
                                        {
                                            var filePath = Path.Combine(updatedExcelFilePath, containstr);
                                            byte[] bytes = System.IO.File.ReadAllBytes(filePath);
                                            var pdfReader = new iTextSharp.text.pdf.PdfReader(bytes);
                                            using (Stream output = new FileStream(filePath, FileMode.Create, FileAccess.Write, FileShare.None))
                                            {
                                                using (iTextSharp.text.pdf.PdfStamper pdfStamper = new iTextSharp.text.pdf.PdfStamper(pdfReader, output))
                                                {

                                                    for (int pageIndex = 1; pageIndex <= 1; pageIndex++)
                                                    // for (int pageIndex = pdfReader.NumberOfPages; pageIndex <= pdfReader.NumberOfPages; pageIndex++)
                                                    {
                                                        pdfStamper.FormFlattening = false;
                                                        iTextSharp.text.Rectangle pageRectangle = pdfReader.GetPageSizeWithRotation(pageIndex);
                                                        iTextSharp.text.pdf.PdfContentByte pdfData = pdfStamper.GetOverContent(pageIndex);
                                                        pdfData.SetFontAndSize(iTextSharp.text.pdf.BaseFont.CreateFont(iTextSharp.text.pdf.BaseFont.TIMES_BOLD, iTextSharp.text.pdf.BaseFont.CP1252,
                                                        iTextSharp.text.pdf.BaseFont.NOT_EMBEDDED), 8);
                                                        iTextSharp.text.pdf.PdfGState graphicsState = new iTextSharp.text.pdf.PdfGState
                                                        {
                                                            FillOpacity = 10F
                                                        };
                                                        pdfData.SetGState(graphicsState);
                                                        iTextSharp.text.pdf.BaseFont bf = iTextSharp.text.pdf.BaseFont.CreateFont(iTextSharp.text.pdf.BaseFont.TIMES_BOLD, iTextSharp.text.pdf.BaseFont.CP1252,
                                                        iTextSharp.text.pdf.BaseFont.NOT_EMBEDDED);
                                                        pdfData.SetColorFill(iTextSharp.text.BaseColor.BLACK);
                                                        iTextSharp.text.Font font = new iTextSharp.text.Font(bf, 8, iTextSharp.text.Font.BOLD);
                                                        pdfData.SetFontAndSize(bf, 8);


                                                        #region Footer 
                                                        pdfData.BeginText();
                                                        float w = (float)Convert.ToDouble(settings[2]);
                                                        float h = (float)Convert.ToDouble(settings[3]);
                                                        float x = (float)Convert.ToDouble(settings[0]);
                                                        float y = (float)Convert.ToDouble(settings[1]);

                                                        float xFullName = (float)Convert.ToDouble(FullNamesettings[0]);
                                                        float yFullName = (float)Convert.ToDouble(FullNamesettings[1]);
                                                        float xDateTime = (float)Convert.ToDouble(DateTimesettings[0]);
                                                        float yDateTime = (float)Convert.ToDouble(DateTimesettings[1]);

                                                        string pageNumber = 1.ToString();
                                                        pdfData.ShowTextAligned(1, createExpenseReportsSign.FullName, xFullName, yFullName, 0);
                                                        pdfData.ShowTextAligned(1, createExpenseReportsSign.DateTime, xDateTime, yDateTime, 0);
                                                        pdfData.EndText();

                                                        #region Add Signature Image 
                                                        string base64encodedstring = createExpenseReportsSign.Signature;
                                                        var base64bytes = Convert.FromBase64String(base64encodedstring);
                                                        iTextSharp.text.Image image = iTextSharp.text.Image.GetInstance(base64bytes);
                                                        image.ScaleAbsolute(w, h);
                                                        image.SetAbsolutePosition(x, y);
                                                        pdfData.AddImage(image);
                                                        #endregion
                                                        #endregion
                                                    }
                                                }
                                                output.Close();
                                                output.Dispose();
                                            }

                                        }

                                        #endregion

                                    }
                                    //sp create [APIGEOS-602][Plahange][23-09-2022] Purchasing/Orders/Sign?IdPO=39870&PlantOwner=EAES
                                    #region
                                    if (idSite > 0)
                                    {
                                        //string siteConnectionstring = GetSiteConnectionString(idSite, mainserverConnectionString, Plantwiseconnectionstring);
                                        using (var connection = new MySqlConnection(siteConnectionstring))
                                        {
                                            await connection.OpenAsync();
                                            //MySqlCommand command = new MySqlCommand("PurchasingOrderSignStatus_Update", connection); //sp create [APIGEOS-602][Plahange][23-09-2022] Purchasing/Orders/Sign?IdPO=39870&PlantOwner=EAES
                                            using (var command = new MySqlCommand("PurchasingOrderSignStatus_Update_V580", connection))//APIGEOS-828 Log not inserted properly in purchasing -> orders->sign   30 05 2023
                                            {
                                                command.CommandType = CommandType.StoredProcedure;
                                                command.Parameters.AddWithValue("_IdWarehousePurchaseOrder", tempIdPo);
                                                command.Parameters.AddWithValue("_UserName", loginUsername);
                                                command.Parameters.AddWithValue("_FullName", string.IsNullOrEmpty(createExpenseReportsSign.FullName) ? null : createExpenseReportsSign.FullName);
                                                await command.ExecuteNonQueryAsync();
                                            }
                                        }
                                    }
                                    #endregion
                                    //sp End
                                    result = true;
                                }
                                catch (Exception ex)
                                {
                                    error = error + ex.Message.ToString() + ": " + tempIdPo + ";";
                                    //result = false;
                                    Log4NetLogger.Logger.Log(string.Format("Error PurchasingOrdersReportsSign(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                    //throw ex;
                                }
                                #endregion
                            }
                            else
                            {
                                result = true;
                                //error = error + " Invalid IdPO purchase order already signed: "+ tempIdPo + ";"; 
                            }
                        }
                        catch (Exception ex)
                        {
                            error = error + ex + ": " + tempIdPo + ";";
                            //result = false;
                            Log4NetLogger.Logger.Log(string.Format("Error PurchasingOrdersReportsSign(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                        }
                        #endregion
                    }
                }
                catch (Exception ex)
                {
                    error = error + ex + ": " + tempIdPo + ";";
                    //result = false;
                    Log4NetLogger.Logger.Log(string.Format("Error PurchasingOrdersReportsSign(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                }
            });

            await Task.WhenAll(tasks);

            return result;
        }

        public bool IsIdPOExist(string IdPO, string connstr)
        {
            bool isExist = false;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsPOCodeExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsIdPOExist", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_IdPO", IdPO);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdWarehousePurchaseOrder"] != DBNull.Value)
                            {
                                isExist = true;
                            }
                            else
                            {
                                isExist = false;
                            }
                        }
                        else
                        {
                            isExist = false;
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsIdPOExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsIdPOExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return isExist;
        }
        public bool IsIdPOAlreadySigned(string IdPO, string connstr)
        {
            bool isExist = false;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsPOCodeExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsIdPOAlreadySigned", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_IdPO", IdPO);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdWarehousePurchaseOrder"] != DBNull.Value)
                            {
                                isExist = true;
                            }
                            else
                            {
                                isExist = false;
                            }
                        }
                        else
                        {
                            isExist = false;
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsIdPOExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsIdPOExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return isExist;
        }

    }

    //Shubham[skadam] APIGEOS-1392 Use plant service for Accounting->ExpenseReports->Export  28 04 2025
    //Shubham[skadam] APIGEOS-1394 Use plant service for Accounting->ExpenseReports->Send  28 04 2025
    //Shubham[skadam] APIGEOS-1393 Use plant service for Accounting->ExpenseReports->Sign  28 04 2025
    public class AccountingExpensesManager
    {
        string _ConnString;
        string _ConnEmdepGeosString;
        private string username;
        static string loginUsername;
        string MergePdf;
        string MergeRec;
        public string CurrencyLayerAPI;
        public AccountingExpensesManager(string ConnString, string ConnEmdepGeosString)
        {
            //if (Log4NetLogger.Logger == null)
            //{
            //    string ApplicationLogFilePath = System.Web.Hosting.HostingEnvironment.MapPath("/") + "log4net.config";
            //    FileInfo file = new FileInfo(ApplicationLogFilePath);
            //    Log4NetLogger.Logger = LoggerFactory.CreateLogger(LogType.Log4Net, file);
            //}
            this._ConnString = ConnString;
            this._ConnEmdepGeosString = ConnEmdepGeosString;
        }
        public bool ExportExpenses(string IdExpenseReport, string Lang, string expensesExcelPath, string expensesFilePath, string Plantwiseconnectionstring, string ConnectionString,
            string loginConnectionString, string EmployeesExpensesAttachmentPath)
        {
            bool isDone = false;
            bool isrev = true;
            string companyAlias = string.Empty;
            string mergepdf, mergerec;
            double TotalAmount = 0;
            List<string> Alllangs = new List<string>();
            string langs = string.Empty;
            // string parentAlias = string.Empty;
            Workbook workbook = new Workbook();
            FileStream stream = null;
            ExportExpenses exportExpenses = new ExportExpenses();
            CultureInfo cultureInfo = new CultureInfo("en-GB");
            string filenameExcel = null;
            string filenamePDF = null;
            string receiptsPDF = null;
            string expensesFromDate = null;
            string expensesToDate = null;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method ExportExpenses()...."), category: Category.Info, priority: Priority.Low);
                #region Mutilanguage
                //if (Lang == "0")
                //{
                //    foreach (KeyValuePair<string, string> item in CommonManager.DictonaryHRMSitesWithIds)
                //    {
                //        Alllangs.Add(item.Value);
                //    }
                //}
                //else
                //{
                //    string[] langsArray = Lang.Split(',');
                //    foreach (string l in langsArray)
                //    {
                //        Alllangs.Add(l);
                //    }
                //}
                //langs = String.Join(",", ((List<string>)Alllangs));
                #endregion
                string[] multilang = Lang.Split(',');//[plahange][APIGEOS-713][13/03/2023]
                foreach (string lancult in multilang)
                {
                    workbook = new Workbook();
                    exportExpenses._ExportExpensesLst = new List<List_OF_Expenses>();

                    using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                    {
                        conn.Open();
                        //MySqlCommand command = new MySqlCommand("GEOSAPI_GetExpenseExport", conn);//Created by shubham[skadam] for APIGEOS-399 endpoint Accounting/Employees/ExpenseReports/Export https://helpdesk.emdep.com/browse/APIGEOS-399 DATE 31 JAN 2022
                        //MySqlCommand command = new MySqlCommand("GEOSAPI_GetExpenseExport_V400", conn);//Updated by [rdixit] for [APIGEOS-446] on [22-03-2022] endpoint Accounting/Employees/ExpenseReports https://helpdesk.emdep.com/browse/APIGEOS-446 ( Added Remarks field)
                        //MySqlCommand command = new MySqlCommand("GEOSAPI_GetExpenseExport_V410", conn); //Updated by[kshinde][APIGEOS-462][30/03/2022] and [APIGEOS-463][31/03/2022]
                        //MySqlCommand command = new MySqlCommand("GEOSAPI_GetExpenseExport_V480", conn); //Updated by[pjadhav][APIGEOS-550][01/09/2022]
                        //MySqlCommand command = new MySqlCommand("GEOSAPI_GetExpenseExport_V500", conn); // shubham[skadam] APIGEOS-659  endpoint Accounting/Employees/Export https://helpdesk.emdep.com/browse/APIGEOS-462 APIGEOS-659 APIGEOS-618 not working as expected 12 11 2022
                        //MySqlCommand command = new MySqlCommand("GEOSAPI_GetExpenseExport_V510", conn); // pooja[plahange] APIGEOS-672  endpoint Accounting/Employees/Export https://helpdesk.emdep.com/browse/APIGEOS-672 APIGEOS-672 23/11/2022
                        // MySqlCommand command = new MySqlCommand("GEOSAPI_GetExpenseExport_V550", conn); // pooja[plahange] APIGEOS-734  endpoint Accounting/Employees/Export https://helpdesk.emdep.com/browse/APIGEOS-734 APIGEOS-734 02/03/2023
                        MySqlCommand command = new MySqlCommand("GEOSAPI_GetExpenseExport_V680", conn);  // Updated By Rahul[rgadhave][APIGEOS-1091][Date:28-03-2024]
                        command.CommandType = CommandType.StoredProcedure;
                        command.Parameters.AddWithValue("_IdExpenseReport", IdExpenseReport);
                        command.Parameters.AddWithValue("_Lang", lancult);//[plahange][APIGEOS-713][13/03/2023]
                                                                          //command.Parameters.AddWithValue("_Lang", Lang);
                        command.CommandTimeout = 8000;
                        using (MySqlDataReader dr = command.ExecuteReader())
                        {
                            while (dr.Read())
                            {
                                #region Get data from MySql
                                if (dr["IdEmployeeExpenseReport"] != DBNull.Value)
                                {
                                    exportExpenses._IdEmployeeExpenseReport = Convert.ToString(dr["IdEmployeeExpenseReport"]).ToString();
                                }
                                if (dr["ReportCode"] != DBNull.Value)
                                {
                                    exportExpenses._ExpenseReportCode = Convert.ToString(dr["ReportCode"]).ToString();
                                }
                                if (dr["SubmitDate"] != DBNull.Value)//[plahange][GEOSAPI-734]
                                {
                                    exportExpenses._SubmitDate = Convert.ToDateTime(dr["SubmitDate"]).ToString("dd-MM-yyyy");
                                }
                                if (dr["CreationDate"] != DBNull.Value)
                                {
                                    exportExpenses._ReportDate = Convert.ToDateTime(dr["CreationDate"]).ToString("dd-MM-yyyy");
                                }
                                if (dr["FromDate"] != DBNull.Value)
                                {
                                    exportExpenses._ExpensesFromDate = Convert.ToDateTime(dr["FromDate"]).ToString("dd-MM-yyyy");
                                }
                                if (dr["ToDate"] != DBNull.Value)
                                {
                                    exportExpenses._ExpensesToDate = Convert.ToDateTime(dr["ToDate"]).ToString("dd-MM-yyyy");
                                }
                                if (dr["EmployeeName"] != DBNull.Value)
                                {
                                    exportExpenses._EmployeeName = Convert.ToString(dr["EmployeeName"]).ToString();
                                }
                                if (dr["DepartmentName"] != DBNull.Value)
                                {
                                    exportExpenses._EmployeeDepartment = Convert.ToString(dr["DepartmentName"]).ToString();
                                }
                                if (dr["EmployeeCode"] != DBNull.Value)
                                {
                                    exportExpenses._EmployeeCode = Convert.ToString(dr["EmployeeCode"]).ToString();
                                }
                                if (dr["JobDescriptionCode"] != DBNull.Value)
                                {
                                    exportExpenses._EmployeeJobTitleCode = Convert.ToString(dr["JobDescriptionCode"]).ToString();
                                }
                                if (dr["JobDescriptionTitle"] != DBNull.Value)
                                {
                                    exportExpenses._EmployeeJobTitle = Convert.ToString(dr["JobDescriptionTitle"]).ToString();
                                }
                                if (dr["ReportPurpose"] != DBNull.Value)
                                {
                                    exportExpenses._ReportPurpose = Convert.ToString(dr["ReportPurpose"]).ToString();
                                }
                                if (dr["ReportReason"] != DBNull.Value)//[plahange][GEOSAPI-672]
                                {
                                    exportExpenses._ReportReason = Convert.ToString(dr["ReportReason"]).ToString();
                                }
                                if (dr["PlantRegisteredName"] != DBNull.Value)
                                {
                                    exportExpenses._PlantRegisteredName = Convert.ToString(dr["PlantRegisteredName"]).ToString();

                                }
                                if (dr["PlantRegistrationNumber"] != DBNull.Value)
                                {
                                    exportExpenses._PlantRegistrationNumber = Convert.ToString(dr["PlantRegistrationNumber"]).ToString();
                                }
                                if (dr["CurrencyName"] != DBNull.Value)
                                {
                                    exportExpenses._Currency = Convert.ToString(dr["CurrencyName"]).ToString();
                                }
                                if (dr["IdCurrency"] != DBNull.Value)
                                {
                                    exportExpenses._IdCurrency = Convert.ToInt32(dr["IdCurrency"].ToString());
                                }
                                if (dr["JobTitleOrganization"] != DBNull.Value)
                                {
                                    exportExpenses._JobTitleOrganization = Convert.ToString(dr["JobTitleOrganization"]).ToString();
                                    // companyAlias = "EAES";
                                    //companyAlias = Convert.ToString(dr["JobTitleOrganization"]).ToString();
                                }

                                if (dr["Advances"] != DBNull.Value)
                                {
                                    exportExpenses._Advances = Convert.ToString(dr["Advances"]).ToString();
                                }
                                if (dr["Remarks"] != DBNull.Value)
                                {
                                    exportExpenses._Remarks = Convert.ToString(dr["Remarks"]).ToString();
                                }
                                //[001][kshinde][29/03/2022]
                                if (dr["PlantAlias"] != DBNull.Value)
                                {
                                    exportExpenses._PlantAlias = Convert.ToString(dr["PlantAlias"]).ToString();
                                }
                                if (dr["CompanyAlias"] != DBNull.Value)
                                {
                                    companyAlias = Convert.ToString(dr["CompanyAlias"]).ToString();
                                }

                                exportExpenses.Language = lancult.ToLower();
                                #endregion

                            }//while
                            #region Get data from employee_expenses
                            if (dr.NextResult())
                            {
                                int count = 1;
                                while (dr.Read())
                                {
                                    if (dr["ExpenseDate"] != DBNull.Value)
                                    {
                                        if (exportExpenses._ExportExpensesLst == null)
                                        {
                                            exportExpenses._ExportExpensesLst = new List<List_OF_Expenses>();
                                        }
                                        List_OF_Expenses expenses = new List_OF_Expenses();
                                        if (dr["ExpenseDate"] != DBNull.Value)
                                        {
                                            expenses._DateColumn = Convert.ToDateTime(dr["ExpenseDate"]).ToString("dd-MM-yyyy");
                                        }
                                        if (dr["Summary"] != DBNull.Value)
                                        {
                                            expenses._SummaryColumn = Convert.ToString(dr["Summary"]).ToString();
                                        }
                                        if (dr["IdCategory"] != DBNull.Value)
                                        {
                                            expenses._IdCategory = Convert.ToInt32(dr["IdCategory"].ToString());
                                        }
                                        if (dr["CategoryName"] != DBNull.Value)
                                        {
                                            expenses._Category = Convert.ToString(dr["CategoryName"]).ToString();
                                        }
                                        if (dr["PaymentMethod"] != DBNull.Value)
                                        {
                                            expenses._PaymentMethodColumn = Convert.ToString(dr["PaymentMethod"]).ToString();
                                        }
                                        if (dr["Amount"] != DBNull.Value)
                                        {
                                            expenses._Cost = Convert.ToDouble(dr["Amount"]);
                                            TotalAmount += expenses._Cost;
                                        }

                                        //if (dr["IdEmployeeExpenseAttendee"] != DBNull.Value)
                                        //{
                                        //    expenses._IdEmployeeExpenseAttendee = Convert.ToInt64(dr["IdEmployeeExpenseAttendee"]);
                                        //}
                                        if (dr["IdEmployeeExpenseReport"] != DBNull.Value)
                                        {
                                            expenses._IdEmployeeExpenseReport = Convert.ToInt64(dr["IdEmployeeExpenseReport"]);
                                        }
                                        if (dr["IdEmployeeExpense"] != DBNull.Value)
                                        {
                                            expenses._IdEmployeeExpense = Convert.ToInt64(dr["IdEmployeeExpense"]);
                                        }
                                        expenses._columnNum = count;

                                        if (dr["Tip"] != DBNull.Value)
                                        {
                                            string Tip = dr["Tip"].ToString();
                                            expenses._Tip = Convert.ToDouble(Tip);
                                            //TotalAmount += expenses._Tip;
                                        }
                                        if (dr["TotalAmountCompanyCredit"] != DBNull.Value)//[Sudhir.Jangra][APIGEOS-673][Added TotalCompanyCreditCardAmount]
                                        {
                                            string Tip = dr["Tip"].ToString();
                                            string TotalAmountCompanyCredit = dr["TotalAmountCompanyCredit"].ToString();
                                            exportExpenses._TotalCompanyCreditCardAmount = exportExpenses._TotalCompanyCreditCardAmount + Convert.ToDouble(TotalAmountCompanyCredit);
                                        }
                                        if (dr["TotalCompanyVoucherAmount"] != DBNull.Value)//[plahange][APIGEOS-675]
                                        {
                                            string TotalCompanyVoucherAmount = dr["TotalCompanyVoucherAmount"].ToString();
                                            exportExpenses._TotalCompanyVoucherAmount = exportExpenses._TotalCompanyVoucherAmount + Convert.ToDouble(TotalCompanyVoucherAmount);
                                        }
                                        exportExpenses._ExportExpensesLst.Add(expenses);
                                        if (expenses._Tip != 0)
                                        {
                                            List_OF_Expenses expenseswithTip = new List_OF_Expenses();
                                            expenseswithTip._SummaryColumn = "TIP";
                                            if (dr["Tip"] != DBNull.Value)
                                            {
                                                Double Tip = Convert.ToDouble(dr["Tip"]);
                                                expenseswithTip._Tip = Convert.ToDouble(Tip);
                                                expenseswithTip._Cost = Tip;
                                            }
                                            if (dr["IdCategory"] != DBNull.Value)
                                            {
                                                expenseswithTip._IdCategory = Convert.ToInt32(dr["IdCategory"].ToString());
                                            }
                                            exportExpenses._ExportExpensesLst.Add(expenseswithTip);
                                        }
                                        count = count + 1;
                                    }

                                }
                            }
                            #endregion

                            #region Get data from employee_expense_attendees
                            if (dr.NextResult())
                            {
                                while (dr.Read())
                                {
                                    if (dr["IdEmployeeExpense"] != DBNull.Value)
                                    {
                                        if (exportExpenses._ExportExpensesLst != null)
                                        {
                                            List_OF_Expenses exportExpensesLst = exportExpenses._ExportExpensesLst.Where(w => w != null && w._IdEmployeeExpense.Equals(Convert.ToInt64(dr["IdEmployeeExpense"]))).FirstOrDefault();
                                            if (exportExpensesLst != null)
                                            {
                                                if (exportExpensesLst._ExportExpensesAttendees == null)
                                                {
                                                    exportExpensesLst._ExportExpensesAttendees = new List<ExportExpensesAttendees>();
                                                }
                                                ExportExpensesAttendees accountingExpensesAttendeesPerson = new ExportExpensesAttendees();
                                                if (dr["IdEmployeeExpenseAttendee"] != DBNull.Value)
                                                {
                                                    accountingExpensesAttendeesPerson.IdEmployeeExpenseAttendee = Convert.ToInt32(dr["IdEmployeeExpenseAttendee"]);
                                                }
                                                if (dr["Name"] != DBNull.Value)
                                                {
                                                    accountingExpensesAttendeesPerson.Name = Convert.ToString(dr["Name"]).ToString();
                                                }
                                                if (dr["styleName"] != DBNull.Value)
                                                {
                                                    accountingExpensesAttendeesPerson.styleName = Convert.ToString(dr["styleName"]).ToString();
                                                }
                                                if (dr["stylesymbol"] != DBNull.Value)
                                                {
                                                    accountingExpensesAttendeesPerson.stylesymbol = Convert.ToString(dr["stylesymbol"]).ToString();
                                                }
                                                exportExpensesLst._ExportExpensesAttendees.Add(accountingExpensesAttendeesPerson);
                                            }

                                        }

                                    }
                                }
                            }
                            #endregion

                            #region Get data from employee_expense_attachments
                            if (dr.NextResult())
                            {
                                while (dr.Read())
                                {
                                    if (dr["IdEmployeeExpense"] != DBNull.Value)
                                    {
                                        List_OF_Expenses exportExpensesLst = exportExpenses._ExportExpensesLst.Where(w => w._IdEmployeeExpense.Equals(Convert.ToInt64(dr["IdEmployeeExpense"]))).FirstOrDefault();
                                        if (exportExpensesLst != null)
                                        {
                                            if (exportExpensesLst._ExportExpensesAttachments == null)
                                            {
                                                exportExpensesLst._ExportExpensesAttachments = new List<ExportExpensesattachments>();
                                            }
                                            ExportExpensesattachments accountingExpensesExpensesattachments = new ExportExpensesattachments();
                                            if (dr["IdEmployeeExpenseAttachment"] != DBNull.Value)
                                            {
                                                accountingExpensesExpensesattachments.IdEmployeeExpenseAttachment = Convert.ToInt64(dr["IdEmployeeExpenseAttachment"]);
                                            }
                                            if (dr["IdEmployeeExpense"] != DBNull.Value)
                                            {
                                                accountingExpensesExpensesattachments.IdEmployeeExpense = Convert.ToInt64(dr["IdEmployeeExpense"]);
                                            }
                                            if (dr["OriginalFileName"] != DBNull.Value)
                                            {
                                                accountingExpensesExpensesattachments.OriginalFileName = Convert.ToString(dr["OriginalFileName"]).ToString();
                                            }
                                            if (dr["SavedFileName"] != DBNull.Value)
                                            {
                                                accountingExpensesExpensesattachments.SavedFileName = Convert.ToString(dr["SavedFileName"]).ToString();
                                            }
                                            if (dr["FileType"] != DBNull.Value)
                                            {
                                                accountingExpensesExpensesattachments.FileType = Convert.ToString(dr["FileType"]).ToString();
                                            }
                                            if (dr["FileSize"] != DBNull.Value)
                                            {
                                                accountingExpensesExpensesattachments.FileSize = Convert.ToString(dr["FileSize"]).ToString();
                                            }
                                            if (dr["IsDeleted"] != DBNull.Value)
                                            {
                                                accountingExpensesExpensesattachments.IsDeleted = Convert.ToInt32(dr["IsDeleted"]);
                                            }
                                            exportExpensesLst._ExportExpensesAttachments.Add(accountingExpensesExpensesattachments);
                                        }
                                    }

                                }
                            }
                            #endregion
                        }//MySqlDataReader
                    }//Close conn
                    Log4NetLogger.Logger.Log(string.Format("Method ExportExpenses()....Executed successfully."), category: Category.Info, priority: Priority.Low);

                    Log4NetLogger.Logger.Log(string.Format("Method ExportOffer() workbook"), category: Category.Info, priority: Priority.Low);

                    if (exportExpenses != null)
                    {

                        if (exportExpenses._PlantAlias != string.Empty)//doing changes [kshinde][30/03/2022][GEOSAPI-462]
                        {
                            string cultureByPlantOwnerAndISO = GetCultureByPlantOwner(exportExpenses._PlantAlias, ConnectionString);
                            string CultureByPlantOwner = string.Empty;
                            if (!string.IsNullOrEmpty(cultureByPlantOwnerAndISO))
                            {
                                CultureByPlantOwner = lancult.ToLower() + "-" + cultureByPlantOwnerAndISO;//modify by [plahange][APIGEOS-713][13/03/2023]
                            }
                            List<Languages> Languages = Getlanguages(loginConnectionString);
                            Languages getLanguage = Languages.Where(l => l.TwoLetterISOLanguage.Equals(lancult.ToLower())).FirstOrDefault();//modify by [plahange][APIGEOS-713][13/03/2023]
                            #region CultureInfo
                            if (!lancult.ToLower().Equals("en"))//modify by [plahange][APIGEOS-713][13/03/2023]
                            {
                                if (getLanguage != null)
                                {
                                    CultureInfo myCIintl = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName, true);
                                    workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName);
                                }
                                else
                                {
                                    CultureInfo myCIintl = new CultureInfo("en-GB", true);
                                    workbook.Options.Culture = new CultureInfo("en-GB");
                                }
                            }
                            else
                            {
                                #region CultureInfo
                                List<CultureInfo> culture = CultureInfo.GetCultures(CultureTypes.AllCultures).Where<CultureInfo>(c => c.Name.EndsWith(CultureByPlantOwner)).ToList();
                                if (culture != null && culture.Count > 0)
                                {
                                    workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(CultureByPlantOwner) ? "en-GB" : CultureByPlantOwner);
                                }
                                else
                                {
                                    string plantName = cultureByPlantOwnerAndISO;
                                    List<CultureInfo> ifCultureNotexist = CultureInfo.GetCultures(CultureTypes.AllCultures).Where<CultureInfo>(c => c.Name.EndsWith(plantName)).ToList();
                                    Languages setCulture = null;
                                    if (ifCultureNotexist.Count() == 1)
                                    {
                                        setCulture = new Languages();
                                        setCulture.CultureName = ifCultureNotexist[0].Name;
                                    }
                                    else
                                    {
                                        foreach (var item in ifCultureNotexist)
                                        {
                                            setCulture = Languages.Where(s => s.TwoLetterISOLanguage.Equals(item.Parent.Name)).FirstOrDefault();
                                            if (setCulture != null)
                                            {
                                                setCulture.CultureName = item.Name;
                                                break;
                                            }
                                        }
                                    }

                                    if (setCulture != null)
                                    {
                                        CultureInfo myCIintl = new CultureInfo(string.IsNullOrEmpty(setCulture.CultureName) ? "en-GB" : setCulture.CultureName, true);
                                        if (myCIintl != null)
                                        {
                                            workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(setCulture.CultureName) ? "en-GB" : setCulture.CultureName);
                                        }

                                    }
                                    else
                                    {
                                        if (getLanguage != null)
                                        {
                                            CultureInfo myCIintl = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName, true);
                                            workbook.Options.Culture = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName);
                                        }
                                        else
                                        {
                                            CultureInfo myCIintl = new CultureInfo("en-GB", true);
                                            workbook.Options.Culture = new CultureInfo("en-GB");

                                        }

                                    }

                                }
                                #endregion
                            }
                            #endregion
                            //byte[] excelTemplateInByte = GetOfferExportChart(exportExpenses._PlantAlias, expensesExcelPath);
                            //workbook.LoadDocument(excelTemplateInByte, DocumentFormat.Xlsx);
                            //Worksheet wsDl = workbook.Worksheets[2];

                            //string filenameExcel = null;//[plahange][APIGEOS-713][13/03/2023]
                            //string filenamePDF = null;//[plahange][APIGEOS-713][13/03/2023]
                            //string receiptsPDF = null;//[plahange][APIGEOS-713][13/03/2023]
                            #region single laguage filename
                            /* exportExpenses.Language = Lang.ToUpper();//Added By[Plahange][GEOSAPI-612] endpoint Accounting/Employees/ExpenseReports/Export
                            string filelang = exportExpenses.Language; */
                            #endregion
                            //string expensesFromDate = null;//[plahange][APIGEOS-713][13/03/2023]
                            //string expensesToDate = null;//[plahange][APIGEOS-713][13/03/2023]
                            DateTime fromDate = Convert.ToDateTime(DateTime.Now);
                            DateTime toDate = Convert.ToDateTime(DateTime.Now);
                            if (!string.IsNullOrEmpty(exportExpenses._ExpensesFromDate))
                            {
                                fromDate = DateTime.ParseExact(exportExpenses._ExpensesFromDate, "dd-MM-yyyy", CultureInfo.InvariantCulture);
                                toDate = DateTime.ParseExact(exportExpenses._ExpensesToDate, "dd-MM-yyyy", CultureInfo.InvariantCulture);
                            }
                            expensesFromDate = string.Concat(fromDate.Year, fromDate.Month.ToString().PadLeft(2, '0'), fromDate.Day.ToString().PadLeft(2, '0'));
                            expensesToDate = string.Concat(toDate.Year, toDate.Month.ToString().PadLeft(2, '0'), toDate.Day.ToString().PadLeft(2, '0'));

                            string updatedExcelFilePath = expensesFilePath.Replace("{0}", exportExpenses._PlantAlias);
                            updatedExcelFilePath = updatedExcelFilePath + @"\" + exportExpenses._EmployeeCode + @"\" + exportExpenses._ExpenseReportCode + @"\";
                            if (!System.IO.Directory.Exists(updatedExcelFilePath))
                            {
                                System.IO.Directory.CreateDirectory(updatedExcelFilePath);
                            }
                            #region ReceiptsFile
                            string searchReceipts = exportExpenses._ExpenseReportCode + "_" + '*' + "_Receipts" + '*' + ".pdf";
                            FileInfo[] filesReceipts = new DirectoryInfo(updatedExcelFilePath)
                            .GetFiles(searchReceipts)
                            .OrderBy(f => f.CreationTime)
                            .ToArray();
                            var allfilesReceipts = filesReceipts.ToList();

                            if (isrev == true)
                            {
                                if (allfilesReceipts.Count() > 0)
                                {
                                    #region getAllFiles
                                    List<string> revPDFList = new List<string>();
                                    foreach (var itemPDF in allfilesReceipts)
                                    {
                                        string substringitem = itemPDF.ToString().Split('\\').Last();
                                        revPDFList.Add(substringitem);
                                    }
                                    string containstr = "";
                                    string MaxRevFileName = "";
                                    if (revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault() == null)
                                    {
                                        containstr = exportExpenses._ExpenseReportCode + "_Receipts.pdf";
                                    }
                                    else
                                    {
                                        List<string> maxNumberList = new List<string>();
                                        foreach (var item in revPDFList)
                                        {
                                            int indexofrev = item.IndexOf("rev");
                                            string substring = "00";
                                            if (indexofrev == -1)
                                            {
                                                substring = "00";
                                            }
                                            else
                                            {
                                                substring = item.Substring(indexofrev + 3, 2);
                                            }

                                            maxNumberList.Add(substring);

                                        }
                                        string maxNumber = maxNumberList.Max();
                                        string str = revPDFList.Where(w => w.Contains(exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_Receipts_" + "rev" + maxNumber)).FirstOrDefault();
                                        containstr = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_Receipts_" + "rev" + maxNumber;
                                    }
                                    MaxRevFileName = Directory.GetFiles(updatedExcelFilePath).Where(fi => fi.Contains(containstr)).FirstOrDefault();
                                    if (MaxRevFileName == null)
                                    {
                                        containstr = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault();
                                        MaxRevFileName = Directory.GetFiles(updatedExcelFilePath).Where(fi => fi.Contains(containstr)).FirstOrDefault();
                                    }
                                    if (!File.Exists(MaxRevFileName))
                                    {
                                        containstr = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault().ToString().PadLeft(2, '0');// + "_" + offer._OfferTitle;

                                        MaxRevFileName = Directory.GetFiles(updatedExcelFilePath).Where(fi => fi.Contains(containstr)).FirstOrDefault();
                                    }


                                    #region createFileName
                                    if (File.Exists(Path.Combine(updatedExcelFilePath, containstr.Replace(".pdf", ".xlsx"))) && File.Exists(Path.Combine(updatedExcelFilePath, containstr)))
                                    {
                                        int indexofrev = containstr.IndexOf("rev");
                                        string substring = containstr.Substring(indexofrev + 3, 2);
                                        if (indexofrev == -1)
                                            substring = "00";
                                        receiptsPDF = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_Receipts_" + "rev" + (Convert.ToInt32(substring) + 1).ToString().PadLeft(2, '0') + ".pdf";
                                    }
                                    else
                                    {
                                        int indexofrev = containstr.IndexOf("rev");
                                        string substring = containstr.Substring(indexofrev + 3, 2);
                                        if (indexofrev == -1)
                                            substring = "00";
                                        receiptsPDF = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_Receipts_" + "rev" + (Convert.ToInt32(substring) + 1).ToString().PadLeft(2, '0') + ".pdf";
                                    }
                                    #endregion
                                    #endregion
                                }
                                else
                                {
                                    #region receiptsPDF
                                    for (int i = 0; i < Int32.MaxValue; i++)
                                    {
                                        receiptsPDF = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_Receipts_" + "rev" + i.ToString().PadLeft(2, '0') + ".pdf";
                                        if (!File.Exists(Path.Combine(updatedExcelFilePath, receiptsPDF)))
                                        {
                                            string receiptsPDFOld = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_Receipts_" + "rev" + i + ".pdf";
                                            if (!File.Exists(Path.Combine(updatedExcelFilePath, receiptsPDFOld)))
                                            {
                                                if (i == 0)
                                                {
                                                    receiptsPDF = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_Receipts.pdf";
                                                }
                                                break;
                                            }
                                        }
                                    }

                                    #endregion
                                }
                            }
                            #endregion

                            string search = exportExpenses._ExpenseReportCode + "_" + '*' + ".pdf";
                            FileInfo[] files = new DirectoryInfo(updatedExcelFilePath)
                            .GetFiles(search)
                            .OrderBy(f => f.CreationTime)
                            .ToArray();
                            var allfiles = files.ToList();

                            if (isrev == true)
                            {
                                if (allfiles.Count() > 0)
                                {
                                    #region getAllFiles
                                    List<string> revPDFList = new List<string>();
                                    foreach (var itemPDF in allfiles)
                                    {
                                        string substringitem = itemPDF.ToString().Split('\\').Last();
                                        revPDFList.Add(substringitem);
                                    }
                                    string containstr = "";
                                    string MaxRevFileName = "";
                                    if (revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault() == null)
                                    {
                                        containstr = exportExpenses._ExpenseReportCode + ".pdf";
                                    }
                                    else
                                    {
                                        List<string> maxNumberList = new List<string>();
                                        foreach (var item in revPDFList)
                                        {
                                            int indexofrev = item.IndexOf("rev");
                                            string substring = "00";
                                            if (indexofrev == -1)
                                            {
                                                substring = "00";
                                            }
                                            else
                                            {
                                                substring = item.Substring(indexofrev + 3, 2);
                                            }

                                            maxNumberList.Add(substring);

                                        }
                                        string maxNumber = maxNumberList.Max();
                                        string str = revPDFList.Where(w => w.Contains(exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + maxNumber)).FirstOrDefault();
                                        containstr = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + '*' + "rev" + maxNumber;
                                    }
                                    if (containstr != null)
                                        MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, "*" + containstr + "*.*", SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                                    if (MaxRevFileName == null)
                                    {
                                        containstr = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault();
                                        MaxRevFileName = Directory.GetFiles(updatedExcelFilePath).Where(fi => fi.Contains(containstr)).FirstOrDefault();
                                    }
                                    if (!File.Exists(MaxRevFileName))
                                    {
                                        containstr = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault().ToString().PadLeft(2, '0');// + "_" + offer._OfferTitle;

                                        MaxRevFileName = Directory.GetFiles(updatedExcelFilePath).Where(fi => fi.Contains(containstr)).FirstOrDefault();
                                    }


                                    #region createFileName
                                    if (File.Exists(Path.Combine(updatedExcelFilePath, containstr.Replace(".pdf", ".xlsx"))) && File.Exists(Path.Combine(updatedExcelFilePath, containstr)))
                                    {
                                        int indexofrev = containstr.IndexOf("rev");
                                        string substring = containstr.Substring(indexofrev + 3, 2);
                                        if (indexofrev == -1)
                                            substring = "00";

                                        //filenameExcel = offer._OfferNumber + "_" + "rev" + (Convert.ToInt32(substring) + 1).ToString().PadLeft(2, '0') + "_" + offer._OfferTitle + "_" + Lang.ToUpper() + ".xlsx";
                                        //filenamePDF =  offer._OfferNumber + "_" + "rev" + (Convert.ToInt32(substring) + 1).ToString().PadLeft(2, '0') + "_" + offer._OfferTitle + "_" + Lang.ToUpper() + ".pdf";
                                        filenameExcel = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + (Convert.ToInt32(substring) + 1).ToString().PadLeft(2, '0') + ".xlsx";
                                        filenamePDF = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + (Convert.ToInt32(substring) + 1).ToString().PadLeft(2, '0') + ".pdf";
                                    }
                                    else
                                    {
                                        int indexofrev = containstr.IndexOf("rev");
                                        string substring = containstr.Substring(indexofrev + 3, 2);
                                        if (indexofrev == -1)
                                            substring = "00";

                                        filenameExcel = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + (Convert.ToInt32(substring) + 1).ToString().PadLeft(2, '0') + ".xlsx";
                                        filenamePDF = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + (Convert.ToInt32(substring) + 1).ToString().PadLeft(2, '0') + ".pdf";
                                    }
                                    #endregion

                                    #endregion
                                }
                                else
                                {
                                    #region Get filename

                                    filenameExcel = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + ".xlsx";
                                    filenamePDF = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + ".pdf";
                                    if (File.Exists(Path.Combine(updatedExcelFilePath, filenameExcel)) && File.Exists(Path.Combine(updatedExcelFilePath, filenamePDF)))
                                    {
                                        for (int i = 0; i < Int32.MaxValue; i++)
                                        {
                                            filenameExcel = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + i.ToString().PadLeft(2, '0') + ".xlsx";
                                            filenamePDF = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + i.ToString().PadLeft(2, '0') + ".pdf";
                                            if (i != 0)
                                                if (!File.Exists(Path.Combine(updatedExcelFilePath, filenameExcel)) && !File.Exists(Path.Combine(updatedExcelFilePath, filenamePDF)))
                                                {
                                                    break;
                                                }
                                        }
                                    }
                                    else
                                    {
                                        for (int i = 0; i < Int32.MaxValue; i++)
                                        {
                                            filenameExcel = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + i.ToString().PadLeft(2, '0') + ".xlsx";
                                            filenamePDF = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + i.ToString().PadLeft(2, '0') + ".pdf";
                                            if (!File.Exists(Path.Combine(updatedExcelFilePath, filenameExcel)) && !File.Exists(Path.Combine(updatedExcelFilePath, filenamePDF)))
                                            {
                                                string filenameExcelOld = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + i + ".xlsx";
                                                string filenamePDFOld = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + i + ".pdf";
                                                if (!File.Exists(Path.Combine(updatedExcelFilePath, filenameExcelOld)) && !File.Exists(Path.Combine(updatedExcelFilePath, filenamePDFOld)))
                                                {
                                                    if (i == 0)
                                                    {

                                                        filenameExcel = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + ".xlsx";
                                                        filenamePDF = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + ".pdf";
                                                    }
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                    #endregion
                                }
                            }
                            exportExpenses.Language = langs.ToUpper();
                            string[] langsArrays = langs.Split(',');
                            //List<string> pathlist = new List<string>();
                            //List<string> pdfpathlist = new List<string>();

                            // if (langsArrays.Count() != 0)
                            //  {
                            string exelstr, pdfstr, fileexel, filepdf;
                            exelstr = filenameExcel;
                            pdfstr = filenamePDF;
                            if (isrev == false)
                            {
                                if (!exelstr.ToLower().Contains("rev"))
                                {
                                    string[] pathexel = exelstr.Split('_');
                                    fileexel = pathexel[0] + "_" + pathexel[1] + "_" + pathexel[2] + "_" + pathexel[3] + ".xlsx";
                                    exelstr = fileexel;
                                    string[] pathpdf = pdfstr.Split('_');
                                    filepdf = pathpdf[0] + "_" + pathpdf[1] + "_" + pathpdf[2] + "_" + pathpdf[3] + ".pdf";
                                    pdfstr = filepdf;
                                }
                                else
                                {
                                    string[] pathexel = exelstr.Split('_');
                                    fileexel = pathexel[0] + "_" + pathexel[1] + "_" + pathexel[2] + "_" + pathexel[3] + "_" + pathexel[4] + ".xlsx";
                                    exelstr = fileexel;
                                    string[] pathpdf = pdfstr.Split('_');
                                    filepdf = pathpdf[0] + "_" + pathpdf[1] + "_" + pathpdf[2] + "_" + pathpdf[3] + "_" + pathpdf[4] + ".pdf";
                                    pdfstr = filepdf;
                                }

                            }
                            //[plahange][APIGEOS-713][13/03/2023]
                            // foreach (string lgs in langsArrays)//[PLahange][01/12/2022][GEOSAPI-614]
                            //{
                            // filenameExcel = null;
                            // filenamePDF = null;
                            string[] path = exelstr.Split('.');
                            filenameExcel = path[0] + "." + path[1] + "_" + lancult.ToUpper() + "." + path[2];

                            string[] pdfpath = pdfstr.Split('.');
                            filenamePDF = pdfpath[0] + "." + pdfpath[1] + "_" + lancult.ToUpper() + "." + pdfpath[2];
                            // workbook = new Workbook();//[plahange][APIGEOS-713][13/03/2023]
                            byte[] excelTemplateInByte = GetOfferExportChart(exportExpenses._PlantAlias, expensesExcelPath);
                            if (excelTemplateInByte == null)
                            {
                                throw new FileNotFoundException("File does not exist or File is open - " + expensesExcelPath);
                            }
                            workbook.LoadDocument(excelTemplateInByte, DocumentFormat.Xlsx);
                            Worksheet wsDl = workbook.Worksheets[2];
                            workbook.LoadDocument(excelTemplateInByte, DocumentFormat.Xlsx);
                            wsDl = workbook.Worksheets[2];
                            Lang = lancult;
                            isrev = false;
                            //  }
                            // }
                            //foreach (string pathitem in pathlist)
                            //{
                            //    filenameExcel = pathitem;
                            //    workbook = new Workbook();
                            //    workbook.LoadDocument(excelTemplateInByte, DocumentFormat.Xlsx);
                            //    wsDl = workbook.Worksheets[2];

                            //    foreach (string pdfpathitem in pdfpathlist)
                            //    {
                            //        filenamePDF = pdfpathitem;
                            //        workbook = new Workbook();
                            //        workbook.LoadDocument(excelTemplateInByte, DocumentFormat.Xlsx);
                            //        wsDl = workbook.Worksheets[2];

                            #region getIndexValue

                            Int32 Index_SubmitDate = 0;
                            Int32 Index_ReportDate = 0;
                            Int32 Index_ExpensesFromDate = 0;
                            Int32 Index_ExpensesToDate = 0;
                            Int32 Index_EmployeeName = 0;
                            Int32 Index_EmployeeDepartment = 0;
                            Int32 Index_EmployeeCode = 0;
                            Int32 Index_EmployeeJobTitleCode = 0;
                            Int32 Index_EmployeeJobTitle = 0;
                            Int32 Index_ReportPurpose = 0;
                            Int32 Index_ReportReason = 0;
                            Int32 Index_JobTitleOrganization = 0;
                            Int32 Index_PlantRegisteredName = 0;
                            Int32 Index_PlantRegistrationNumber = 0;
                            Int32 Index_Currency = 0;
                            Int32 Index_Remarks = 0;
                            Int32 Index_Advances = 0;
                            Int32 Index_ReportCode = 0;
                            Int32 Index_PlantAlias = 0;
                            Int32 Language = 0;
                            Int32 Index_TotalMealsAmount = 0;
                            Int32 Index_TotalCompanyVoucherAmount = 0;
                            Int32 Index_TotalCompanyCreditCardAmount = 0;//[Sudhir.Jangra][APIGEOS-673][23/11/2022]



                            //Rahul[rgadhave] for APIGEOS-883[30/10/2023]
                            Int32 CurrencyExchangeRateTo_EUR = 0;
                            Int32 CurrencyExchangeRateTo_RON = 0;
                            Int32 CurrencyExchangeRateTo_USD = 0;
                            Int32 CurrencyExchangeRateTo_MXN = 0;
                            Int32 CurrencyExchangeRateTo_CNY = 0;
                            Int32 CurrencyExchangeRateTo_HNL = 0;
                            Int32 CurrencyExchangeRateTo_BRL = 0;
                            Int32 CurrencyExchangeRateTo_TND = 0;
                            Int32 CurrencyExchangeRateTo_MAD = 0;
                            Int32 CurrencyExchangeRateTo_PYG = 0;
                            Int32 CurrencyExchangeRateTo_RUB = 0;
                            Int32 CurrencyExchangeRateTo_INR = 0;


                            Int32 CurrencyExchangeRateFrom_EUR = 0;
                            Int32 CurrencyExchangeRateFrom_RON = 0;
                            Int32 CurrencyExchangeRateFrom_USD = 0;
                            Int32 CurrencyExchangeRateFrom_MXN = 0;
                            Int32 CurrencyExchangeRateFrom_CNY = 0;
                            Int32 CurrencyExchangeRateFrom_HNL = 0;
                            Int32 CurrencyExchangeRateFrom_BRL = 0;
                            Int32 CurrencyExchangeRateFrom_TND = 0;
                            Int32 CurrencyExchangeRateFrom_MAD = 0;
                            Int32 CurrencyExchangeRateFrom_PYG = 0;
                            Int32 CurrencyExchangeRateFrom_RUB = 0;
                            Int32 CurrencyExchangeRateFrom_INR = 0;
                            // END Rahul[rgadhave] for APIGEOS-883[30/10/2023]

                            //Rahul[rgadhave] for APIGEOS-984[12/12/2023]
                            Int32 MealAllowancePerDay_Regular_EAES = 0;
                            Int32 MealAllowancePerDay_Regular_ESMA1 = 0;
                            Int32 MealAllowancePerDay_Regular_ESMA2 = 0;
                            Int32 MealAllowancePerDay_Regular_ETMA = 0;
                            Int32 MealAllowancePerDay_Regular_EARO = 0;
                            Int32 MealAllowancePerDay_Regular_EBRO = 0;
                            Int32 MealAllowancePerDay_Regular_ESCN = 0;
                            Int32 MealAllowancePerDay_Regular_ETCN = 0;
                            Int32 MealAllowancePerDay_Regular_ENRU = 0;
                            Int32 MealAllowancePerDay_Regular_ESHN = 0;
                            Int32 MealAllowancePerDay_Regular_ETTN = 0;
                            Int32 MealAllowancePerDay_Regular_EAMX = 0;
                            Int32 MealAllowancePerDay_Regular_EJMX1 = 0;
                            Int32 MealAllowancePerDay_Regular_EJMX2 = 0;
                            Int32 MealAllowancePerDay_Regular_ESMX = 0;
                            Int32 MealAllowancePerDay_Regular_EEPY = 0;
                            Int32 MealAllowancePerDay_Regular_EPIN = 0;
                            Int32 MealAllowancePerDay_Regular_EIBR = 0;
                            Int32 MealAllowancePerDay_Regular_ECPT = 0;
                            Int32 MealAllowancePerDay_Regular_EEMX = 0;
                            Int32 MealAllowancePerDay_Regular_EZTN = 0;
                            Int32 MealAllowancePerDay_Regular_EBPL = 0;
                            Int32 MealAllowancePerDay_Regular_EBTR = 0;
                            Int32 MealAllowancePerDay_Regular_EPZA = 0;
                            Int32 MealAllowancePerDay_Regular_ETHQ = 0;
                            Int32 MealAllowancePerDay_Regular_EPUS = 0;
                            Int32 MealAllowancePerDay_Global_EAES = 0;
                            Int32 MealAllowancePerDay_Global_ESMA1 = 0;
                            Int32 MealAllowancePerDay_Global_ESMA2 = 0;
                            Int32 MealAllowancePerDay_Global_ETMA = 0;
                            Int32 MealAllowancePerDay_Global_EARO = 0;
                            Int32 MealAllowancePerDay_Global_EBRO = 0;
                            Int32 MealAllowancePerDay_Global_ESCN = 0;
                            Int32 MealAllowancePerDay_Global_ETCN = 0;
                            Int32 MealAllowancePerDay_Global_ENRU = 0;
                            Int32 MealAllowancePerDay_Global_ESHN = 0;
                            Int32 MealAllowancePerDay_Global_ETTN = 0;
                            Int32 MealAllowancePerDay_Global_EAMX = 0;
                            Int32 MealAllowancePerDay_Global_EJMX1 = 0;
                            Int32 MealAllowancePerDay_Global_EJMX2 = 0;
                            Int32 MealAllowancePerDay_Global_ESMX = 0;
                            Int32 MealAllowancePerDay_Global_EEPY = 0;
                            Int32 MealAllowancePerDay_Global_EPIN = 0;
                            Int32 MealAllowancePerDay_Global_EIBR = 0;
                            Int32 MealAllowancePerDay_Global_ECPT = 0;
                            Int32 MealAllowancePerDay_Global_EEMX = 0;
                            Int32 MealAllowancePerDay_Global_EZTN = 0;
                            Int32 MealAllowancePerDay_Global_EBPL = 0;
                            Int32 MealAllowancePerDay_Global_EBTR = 0;
                            Int32 MealAllowancePerDay_Global_EPZA = 0;
                            Int32 MealAllowancePerDay_Global_ETHQ = 0;
                            Int32 MealAllowancePerDay_Global_EPUS = 0;
                            // END Rahul[rgadhave] for APIGEOS-984[12/12/2023]




                            Int32 Expenses_count = 0;
                            Int32 Expenses_ItemsStartRow = 0;
                            string Expenses_ItemWeekColumn = string.Empty;
                            string Expenses_ItemDateColumn = string.Empty;
                            string Expenses_ItemDayColumn = string.Empty;
                            string Expenses_ItemSummaryColumn = string.Empty;
                            string Expenses_ItemCategoryColumn = string.Empty;
                            string Expenses_ItemPaymentMethodColumn = string.Empty;
                            string Expenses_ItemCostColumn = string.Empty;

                            string Expenses_lblColWeek = string.Empty;
                            string Expenses_lblColDay = string.Empty;
                            string Expenses_lblColDate = string.Empty;
                            string Expenses_lblColSummary = string.Empty;
                            string Expenses_lblColCategory = string.Empty;
                            string Expenses_lblColPayment = string.Empty;
                            string Expenses_lblColCost = string.Empty;
                            string Expenses_lblAttendees = string.Empty;
                            string Expenses_lblTip = string.Empty;

                            string Expenses_lblMon = string.Empty;
                            string Expenses_lblTue = string.Empty;
                            string Expenses_lblWed = string.Empty;
                            string Expenses_lblThu = string.Empty;
                            string Expenses_lblFri = string.Empty;
                            string Expenses_lblSat = string.Empty;
                            string Expenses_lblTSun = string.Empty;
                            #endregion

                            Worksheet wsTranslations = workbook.Worksheets[3];
                            #region getIndex
                            for (int s = 0; s < 400; s++)
                            {
                                #region getValue Using if 
                                if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblColWeek_" + Lang.ToLower()))
                                {
                                    Expenses_lblColWeek = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblColDay_" + Lang.ToLower()))
                                {
                                    Expenses_lblColDay = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblColDate_" + Lang.ToLower()))
                                {
                                    Expenses_lblColDate = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblColSummary_" + Lang.ToLower()))
                                {
                                    Expenses_lblColSummary = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblColCategory_" + Lang.ToLower()))
                                {
                                    Expenses_lblColCategory = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblColPayment_" + Lang.ToLower()))
                                {
                                    Expenses_lblColPayment = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblColCost_" + Lang.ToLower()))
                                {
                                    Expenses_lblColCost = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblAttendees_" + Lang.ToLower()))
                                {
                                    Expenses_lblAttendees = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblTip_" + Lang.ToLower()))
                                {
                                    Expenses_lblTip = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblMon_" + Lang.ToLower()))
                                {
                                    Expenses_lblMon = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblTue_" + Lang.ToLower()))
                                {
                                    Expenses_lblTue = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblWed_" + Lang.ToLower()))
                                {
                                    Expenses_lblWed = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblThu_" + Lang.ToLower()))
                                {
                                    Expenses_lblThu = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblFri_" + Lang.ToLower()))
                                {
                                    Expenses_lblFri = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblSat_" + Lang.ToLower()))
                                {
                                    Expenses_lblSat = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                else if ((wsTranslations.Cells[s, 0].Value.ToString() == "Expenses_lblTSun_" + Lang.ToLower()))
                                {
                                    Expenses_lblTSun = Convert.ToString(wsTranslations.Cells[s, 1].Value.ToString());
                                }
                                #endregion
                                #region getIndex Using switch                           
                                switch (wsDl.Cells[s, 0].Value.ToString())
                                {
                                    case "Index_SubmitDate":
                                        Index_SubmitDate = s;
                                        break;
                                    case "Index_ReportDate":
                                        Index_ReportDate = s;
                                        break;
                                    case "Index_ExpensesFromDate":
                                        Index_ExpensesFromDate = s;
                                        break;
                                    case "Index_ExpensesToDate":
                                        Index_ExpensesToDate = s;
                                        break;
                                    case "Index_EmployeeName":
                                        Index_EmployeeName = s;
                                        break;
                                    case "Index_EmployeeDepartment":
                                        Index_EmployeeDepartment = s;
                                        break;
                                    case "Index_EmployeeCode":
                                        Index_EmployeeCode = s;
                                        break;
                                    case "Index_EmployeeJobTitleCode":
                                        Index_EmployeeJobTitleCode = s;
                                        break;
                                    case "Index_EmployeeJobTitle":
                                        Index_EmployeeJobTitle = s;
                                        break;
                                    case "Index_ReportPurpose":
                                        Index_ReportPurpose = s;
                                        break;
                                    case "Index_ReportReason":
                                        Index_ReportReason = s;
                                        break;
                                    case "Index_JobTitleOrganization":
                                        Index_JobTitleOrganization = s;
                                        break;
                                    case "Index_PlantRegisteredName":
                                        Index_PlantRegisteredName = s;
                                        break;
                                    case "Index_PlantRegistrationNumber":
                                        Index_PlantRegistrationNumber = s;
                                        break;

                                    #region Expenses_Items     
                                    case "Expenses_ItemsStartRow":
                                        Expenses_count = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                                        Expenses_ItemsStartRow = Convert.ToInt32(wsDl.Cells[s, 1].Value.ToString());
                                        break;
                                    case "Expenses_ItemWeekColumn":
                                        Expenses_ItemWeekColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                                        break;
                                    case "Expenses_ItemDateColumn":
                                        Expenses_ItemDateColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                                        break;
                                    case "Expenses_ItemDayColumn":
                                        Expenses_ItemDayColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                                        break;
                                    case "Expenses_ItemSummaryColumn":
                                        Expenses_ItemSummaryColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                                        break;
                                    case "Expenses_ItemCategoryColumn":
                                        Expenses_ItemCategoryColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                                        break;
                                    case "Expenses_ItemPaymentMethodColumn":
                                        Expenses_ItemPaymentMethodColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                                        break;
                                    case "Expenses_ItemCostColumn":
                                        Expenses_ItemCostColumn = Convert.ToString(wsDl.Cells[s, 1].Value.ToString());
                                        break;
                                    #endregion

                                    case "Index_Currency":
                                        Index_Currency = s;
                                        break;
                                    case "Index_Remarks":
                                        Index_Remarks = s;
                                        break;
                                    case "Index_Advances":
                                        Index_Advances = s;
                                        break;
                                    case "Index_ReportCode":
                                        Index_ReportCode = s;
                                        break;
                                    case "Index_PlantAlias":
                                        Index_PlantAlias = s;
                                        break;
                                    case "Language":
                                        Language = s;
                                        break;

                                    #region CurrencyExchangeRate
                                    case "Index_TotalMealsAmount":
                                        Index_TotalMealsAmount = s;
                                        break;
                                    case "Index_TotalCompanyVoucherAmount"://[plahange][APIGEOS-675]
                                        Index_TotalCompanyVoucherAmount = s;
                                        break;
                                    case "Index_TotalCompanyCreditCardAmount":
                                        Index_TotalCompanyCreditCardAmount = s;
                                        break;//[Sudhir.Jangra][APIGEOS-673][23/11/2022]
                                    //Rahul[rgadhave] for APIGEOS-883[30/10/2023]
                                    case "CurrencyExchangeRateTo_EUR":
                                        CurrencyExchangeRateTo_EUR = s;
                                        break;
                                    case "CurrencyExchangeRateTo_RON":
                                        CurrencyExchangeRateTo_RON = s;
                                        break;
                                    case "CurrencyExchangeRateTo_USD":
                                        CurrencyExchangeRateTo_USD = s;
                                        break;
                                    case "CurrencyExchangeRateTo_MXN":
                                        CurrencyExchangeRateTo_MXN = s;
                                        break;
                                    case "CurrencyExchangeRateTo_CNY":
                                        CurrencyExchangeRateTo_CNY = s;
                                        break;
                                    case "CurrencyExchangeRateTo_HNL":
                                        CurrencyExchangeRateTo_HNL = s;
                                        break;
                                    case "CurrencyExchangeRateTo_BRL":
                                        CurrencyExchangeRateTo_BRL = s;
                                        break;
                                    case "CurrencyExchangeRateTo_TND":
                                        CurrencyExchangeRateTo_TND = s;
                                        break;
                                    case "CurrencyExchangeRateTo_MAD":
                                        CurrencyExchangeRateTo_MAD = s;
                                        break;
                                    case "CurrencyExchangeRateTo_PYG":
                                        CurrencyExchangeRateTo_PYG = s;
                                        break;
                                    case "CurrencyExchangeRateTo_RUB":
                                        CurrencyExchangeRateTo_RUB = s;
                                        break;
                                    case "CurrencyExchangeRateTo_INR":
                                        CurrencyExchangeRateTo_INR = s;
                                        break;

                                    case "CurrencyExchangeRateFrom_EUR":
                                        CurrencyExchangeRateFrom_EUR = s;
                                        break;
                                    case "CurrencyExchangeRateFrom_RON":
                                        CurrencyExchangeRateFrom_RON = s;
                                        break;
                                    case "CurrencyExchangeRateFrom_USD":
                                        CurrencyExchangeRateFrom_USD = s;
                                        break;
                                    case "CurrencyExchangeRateFrom_MXN":
                                        CurrencyExchangeRateFrom_MXN = s;
                                        break;
                                    case "CurrencyExchangeRateFrom_CNY":
                                        CurrencyExchangeRateFrom_CNY = s;
                                        break;
                                    case "CurrencyExchangeRateFrom_HNL":
                                        CurrencyExchangeRateFrom_HNL = s;
                                        break;
                                    case "CurrencyExchangeRateFrom_BRL":
                                        CurrencyExchangeRateFrom_BRL = s;
                                        break;
                                    case "CurrencyExchangeRateFrom_TND":
                                        CurrencyExchangeRateFrom_TND = s;
                                        break;
                                    case "CurrencyExchangeRateFrom_MAD":
                                        CurrencyExchangeRateFrom_MAD = s;
                                        break;
                                    case "CurrencyExchangeRateFrom_PYG":
                                        CurrencyExchangeRateFrom_PYG = s;
                                        break;
                                    case "CurrencyExchangeRateFrom_RUB":
                                        CurrencyExchangeRateFrom_RUB = s;
                                        break;
                                    case "CurrencyExchangeRateFrom_INR":
                                        CurrencyExchangeRateFrom_INR = s;
                                        break;
                                    //End
                                    #endregion
                                    #region MealAllowancePerDay_Regular_Global
                                    case "MealAllowancePerDay_Regular_EAES":
                                        MealAllowancePerDay_Regular_EAES = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_ESMA1":
                                        MealAllowancePerDay_Regular_ESMA1 = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_ESMA2":
                                        MealAllowancePerDay_Regular_ESMA2 = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_ETMA":
                                        MealAllowancePerDay_Regular_ETMA = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_EARO":
                                        MealAllowancePerDay_Regular_EARO = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_EBRO":
                                        MealAllowancePerDay_Regular_EBRO = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_ESCN":
                                        MealAllowancePerDay_Regular_ESCN = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_ETCN":
                                        MealAllowancePerDay_Regular_ETCN = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_ENRU":
                                        MealAllowancePerDay_Regular_ENRU = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_ESHN":
                                        MealAllowancePerDay_Regular_ESHN = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_ETTN":
                                        MealAllowancePerDay_Regular_ETTN = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_EAMX":
                                        MealAllowancePerDay_Regular_EAMX = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_EJMX1":
                                        MealAllowancePerDay_Regular_EJMX1 = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_EJMX2":
                                        MealAllowancePerDay_Regular_EJMX2 = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_ESMX":
                                        MealAllowancePerDay_Regular_ESMX = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_EEPY":
                                        MealAllowancePerDay_Regular_EEPY = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_EPIN":
                                        MealAllowancePerDay_Regular_EPIN = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_EIBR":
                                        MealAllowancePerDay_Regular_EIBR = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_ECPT":
                                        MealAllowancePerDay_Regular_ECPT = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_EEMX":
                                        MealAllowancePerDay_Regular_EEMX = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_EZTN":
                                        MealAllowancePerDay_Regular_EZTN = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_EBPL":
                                        MealAllowancePerDay_Regular_EBPL = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_EBTR":
                                        MealAllowancePerDay_Regular_EBTR = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_EPZA":
                                        MealAllowancePerDay_Regular_EPZA = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_ETHQ":
                                        MealAllowancePerDay_Regular_ETHQ = s;
                                        break;
                                    case "MealAllowancePerDay_Regular_EPUS":
                                        MealAllowancePerDay_Regular_EPUS = s;
                                        break;

                                    // Global variables
                                    case "MealAllowancePerDay_Global_EAES":
                                        MealAllowancePerDay_Global_EAES = s;
                                        break;
                                    case "MealAllowancePerDay_Global_ESMA1":
                                        MealAllowancePerDay_Global_ESMA1 = s;
                                        break;
                                    case "MealAllowancePerDay_Global_ESMA2":
                                        MealAllowancePerDay_Global_ESMA2 = s;
                                        break;
                                    case "MealAllowancePerDay_Global_ETMA":
                                        MealAllowancePerDay_Global_ETMA = s;
                                        break;
                                    case "MealAllowancePerDay_Global_EARO":
                                        MealAllowancePerDay_Global_EARO = s;
                                        break;
                                    case "MealAllowancePerDay_Global_EBRO":
                                        MealAllowancePerDay_Global_EBRO = s;
                                        break;
                                    case "MealAllowancePerDay_Global_ESCN":
                                        MealAllowancePerDay_Global_ESCN = s;
                                        break;
                                    case "MealAllowancePerDay_Global_ETCN":
                                        MealAllowancePerDay_Global_ETCN = s;
                                        break;
                                    case "MealAllowancePerDay_Global_ENRU":
                                        MealAllowancePerDay_Global_ENRU = s;
                                        break;
                                    case "MealAllowancePerDay_Global_ESHN":
                                        MealAllowancePerDay_Global_ESHN = s;
                                        break;
                                    case "MealAllowancePerDay_Global_ETTN":
                                        MealAllowancePerDay_Global_ETTN = s;
                                        break;
                                    case "MealAllowancePerDay_Global_EAMX":
                                        MealAllowancePerDay_Global_EAMX = s;
                                        break;
                                    case "MealAllowancePerDay_Global_EJMX1":
                                        MealAllowancePerDay_Global_EJMX1 = s;
                                        break;
                                    case "MealAllowancePerDay_Global_EJMX2":
                                        MealAllowancePerDay_Global_EJMX2 = s;
                                        break;
                                    case "MealAllowancePerDay_Global_ESMX":
                                        MealAllowancePerDay_Global_ESMX = s;
                                        break;
                                    case "MealAllowancePerDay_Global_EEPY":
                                        MealAllowancePerDay_Global_EEPY = s;
                                        break;
                                    case "MealAllowancePerDay_Global_EPIN":
                                        MealAllowancePerDay_Global_EPIN = s;
                                        break;
                                    case "MealAllowancePerDay_Global_EIBR":
                                        MealAllowancePerDay_Global_EIBR = s;
                                        break;
                                    case "MealAllowancePerDay_Global_ECPT":
                                        MealAllowancePerDay_Global_ECPT = s;
                                        break;
                                    case "MealAllowancePerDay_Global_EEMX":
                                        MealAllowancePerDay_Global_EEMX = s;
                                        break;
                                    case "MealAllowancePerDay_Global_EZTN":
                                        MealAllowancePerDay_Global_EZTN = s;
                                        break;
                                    case "MealAllowancePerDay_Global_EBPL":
                                        MealAllowancePerDay_Global_EBPL = s;
                                        break;
                                    case "MealAllowancePerDay_Global_EBTR":
                                        MealAllowancePerDay_Global_EBTR = s;
                                        break;
                                    case "MealAllowancePerDay_Global_EPZA":
                                        MealAllowancePerDay_Global_EPZA = s;
                                        break;
                                    case "MealAllowancePerDay_Global_ETHQ":
                                        MealAllowancePerDay_Global_ETHQ = s;
                                        break;
                                    case "MealAllowancePerDay_Global_EPUS":
                                        MealAllowancePerDay_Global_EPUS = s;
                                        break;
                                    #endregion
                                    default:
                                        break;
                                }
                                #endregion
                                #region getIndex using if

                                //if ((wsDl.Cells[s, 0].Value.ToString() == "Index_ReportDate"))
                                //{
                                //    Index_ReportDate = s;
                                //}
                                //else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_ExpensesFromDate"))
                                //{
                                //    Index_ExpensesFromDate = s;
                                //}
                                //else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_ExpensesToDate"))
                                //{
                                //    Index_ExpensesToDate = s;
                                //}
                                //else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_EmployeeName"))
                                //{
                                //    Index_EmployeeName = s;
                                //}
                                //else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_EmployeeDepartment"))
                                //{
                                //    Index_EmployeeDepartment = s;
                                //}
                                //else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_EmployeeCode"))
                                //{
                                //    Index_EmployeeCode = s;
                                //}
                                //else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_EmployeeJobTitleCode"))
                                //{
                                //    Index_EmployeeJobTitleCode = s;
                                //}
                                //else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_EmployeeJobTitle"))
                                //{
                                //    Index_EmployeeJobTitle = s;
                                //}
                                //else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_ReportPurpose"))
                                //{
                                //    Index_ReportPurpose = s;
                                //}
                                //else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_JobTitleOrganization"))
                                //{
                                //    Index_JobTitleOrganization = s;
                                //}
                                //else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_PlantRegisteredName"))
                                //{
                                //    Index_PlantRegisteredName = s;
                                //}
                                //else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_PlantRegistrationNumber"))
                                //{
                                //    Index_PlantRegistrationNumber = s;
                                //}
                                //else if ((wsDl.Cells[s, 0].Value.ToString() == "Index_Currency"))
                                //{
                                //    Index_Currency = s;
                                //}
                                //else if ((wsDl.Cells[s, 0].Value.ToString() == "Language"))
                                //{
                                //    Language = s;
                                //}
                                #endregion
                            }
                            #endregion
                            using (stream = new FileStream(Path.Combine(updatedExcelFilePath, filenameExcel), FileMode.Create, FileAccess.ReadWrite))
                            {
                                cultureInfo = new CultureInfo(workbook.Options.Culture.Name);
                                #region Set CultureInfo ReportDate
                                if (!String.IsNullOrEmpty(exportExpenses._ReportDate))
                                {
                                    DateTime dt = DateTime.ParseExact(exportExpenses._ReportDate, "dd-MM-yyyy", null);
                                    wsDl.Cells[Index_ReportDate, 1].Value = dt.ToString(cultureInfo.DateTimeFormat.ShortDatePattern, cultureInfo);
                                }
                                else
                                {
                                    wsDl.Cells[Index_ReportDate, 1].Value = exportExpenses._ReportDate;
                                }
                                #endregion
                                #region Set CultureInfo ExpensesFromDate
                                if (!String.IsNullOrEmpty(exportExpenses._ExpensesFromDate))
                                {
                                    DateTime dt = DateTime.ParseExact(exportExpenses._ExpensesFromDate, "dd-MM-yyyy", null);
                                    wsDl.Cells[Index_ExpensesFromDate, 1].Value = dt.ToString(cultureInfo.DateTimeFormat.ShortDatePattern, cultureInfo);
                                }
                                else
                                {
                                    wsDl.Cells[Index_ExpensesFromDate, 1].Value = exportExpenses._ExpensesFromDate;
                                }
                                #endregion
                                #region Set CultureInfo ExpensesToDate
                                if (!String.IsNullOrEmpty(exportExpenses._ExpensesToDate))
                                {
                                    DateTime dt = DateTime.ParseExact(exportExpenses._ExpensesToDate, "dd-MM-yyyy", null);
                                    wsDl.Cells[Index_ExpensesToDate, 1].Value = dt.ToString(cultureInfo.DateTimeFormat.ShortDatePattern, cultureInfo);
                                }
                                else
                                {
                                    wsDl.Cells[Index_ExpensesToDate, 1].Value = exportExpenses._ExpensesToDate;
                                }
                                #endregion
                                #region Set CultureInfo SubmitDate
                                if (!String.IsNullOrEmpty(exportExpenses._SubmitDate))
                                {
                                    DateTime dt = DateTime.ParseExact(exportExpenses._SubmitDate, "dd-MM-yyyy", null);
                                    wsDl.Cells[Index_SubmitDate, 1].Value = dt.ToString(cultureInfo.DateTimeFormat.ShortDatePattern, cultureInfo);
                                }
                                else
                                {
                                    wsDl.Cells[Index_SubmitDate, 1].Value = exportExpenses._SubmitDate;
                                }
                                #endregion
                                //wsDl.Cells[Index_ReportDate, 1].Value = exportExpenses._ReportDate;
                                //wsDl.Cells[Index_ExpensesFromDate, 1].Value = exportExpenses._ExpensesFromDate;
                                //wsDl.Cells[Index_ExpensesToDate, 1].Value = exportExpenses._ExpensesToDate;
                                // wsDl.Cells[Index_SubmitDate, 1].Value = exportExpenses._SubmitDate;//[plahange][APIGEOS-734]
                                wsDl.Cells[Index_EmployeeName, 1].Value = exportExpenses._EmployeeName;
                                wsDl.Cells[Index_EmployeeDepartment, 1].Value = exportExpenses._EmployeeDepartment;
                                wsDl.Cells[Index_EmployeeCode, 1].Value = exportExpenses._EmployeeCode;
                                wsDl.Cells[Index_EmployeeJobTitleCode, 1].Value = exportExpenses._EmployeeJobTitleCode;
                                wsDl.Cells[Index_EmployeeJobTitle, 1].Value = exportExpenses._EmployeeJobTitle;
                                wsDl.Cells[Index_ReportPurpose, 1].Value = exportExpenses._ReportPurpose;
                                wsDl.Cells[Index_ReportReason, 1].Value = exportExpenses._ReportReason;
                                wsDl.Cells[Index_TotalCompanyCreditCardAmount, 1].Value = exportExpenses._TotalCompanyCreditCardAmount;//[Sudhir.Jangra][APIGEOS-673][23/11/2022]
                                wsDl.Cells[Index_TotalCompanyVoucherAmount, 1].Value = exportExpenses._TotalCompanyVoucherAmount;//[plahange][APIGEOS-675]
                                wsDl.Cells[Index_JobTitleOrganization, 1].Value = exportExpenses._JobTitleOrganization;
                                wsDl.Cells[Index_PlantRegisteredName, 1].Value = exportExpenses._PlantRegisteredName;
                                wsDl.Cells[Index_PlantRegistrationNumber, 1].Value = exportExpenses._PlantRegistrationNumber;
                                wsDl.Cells[Index_Currency, 1].Value = exportExpenses._Currency;
                                wsDl.Cells[Index_Remarks, 1].Value = exportExpenses._Remarks;
                                wsDl.Cells[Index_Advances, 1].Value = Convert.ToDouble(exportExpenses._Advances.ToString());
                                wsDl.Cells[Index_ReportCode, 1].Value = exportExpenses._ExpenseReportCode;
                                //wsDl.Cells[Index_PlantAlias, 1].Value = exportExpenses._PlantAlias;
                                wsDl.Cells[Index_PlantAlias, 1].Value = companyAlias;
                                wsDl.Cells[Language, 1].Value = lancult.ToLower();


                                //Added By Rahul[rgadhave]for APIGEOS-883 Display the information about the “Meal Allowance” in the Expenses Report in the Report Currency
                                try
                                {
                                    //Added By Rahul[rgadhave]for APIGEOS-984 
                                    try
                                    {
                                        using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                                        {
                                            conn.Open();
                                            MySqlCommand command = new MySqlCommand("GetMealAllowancePerDay_V650", conn);
                                            command.CommandType = CommandType.StoredProcedure;
                                            using (MySqlDataReader dr = command.ExecuteReader())
                                            {
                                                while (dr.Read())
                                                {
                                                    string alias = dr["Alias"].ToString();
                                                    decimal amount = Convert.ToDecimal(dr["Amount"]);
                                                    string currency = dr["CurrencyName"].ToString();
                                                    if (dr["Value"].ToString() == "Regular" && alias == "EAES")
                                                    {
                                                        // wsDl.Cells[MealAllowancePerDay_Regular_EAES, 1].Value = Convert.ToInt32(dr["Amount"]).ToString();
                                                        wsDl.Cells[MealAllowancePerDay_Regular_EAES, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "ESMA1")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_ESMA1, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "ESMA2")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_ESMA2, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "ETMA")
                                                    {
                                                        /// wsDl.Cells[MealAllowancePerDay_Regular_ETMA, 1].Value = Convert.ToInt32(dr["Amount"]).ToString();
                                                        wsDl.Cells[MealAllowancePerDay_Regular_ETMA, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "EARO")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_EARO, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "EBRO")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_EBRO, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "ESCN")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_ESCN, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "ETCN")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_ETCN, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "ENRU")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_ENRU, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "ESHN")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_ESHN, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "ETTN")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_ETTN, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "EAMX")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_EAMX, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "EJMX1")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_EJMX1, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "EJMX2")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_EJMX2, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "ESMX")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_ESMX, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "EEPY")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_EEPY, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "EPIN")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_EPIN, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "EIBR")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_EIBR, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "ECPT")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_ECPT, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "EEMX")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_EEMX, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "EZTN")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_EZTN, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "EBPL")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_EBPL, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "EBTR")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_EBTR, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "EPZA")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_EPZA, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "ETHQ")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_ETHQ, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                    else if (dr["Value"].ToString() == "Regular" && alias == "EPUS")
                                                    {
                                                        wsDl.Cells[MealAllowancePerDay_Regular_EPUS, 1].Value = String.Format("{0} {1}", amount, currency);
                                                    }
                                                }
                                                if (dr.NextResult())
                                                {
                                                    while (dr.Read())
                                                    {
                                                        string alias = dr["Alias"].ToString();
                                                        decimal amount = Convert.ToDecimal(dr["Amount"]);
                                                        string currency = dr["CurrencyName"].ToString();
                                                        if (dr["Value"].ToString() == "Global" && alias == "EAES")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_EAES, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "ESMA1")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_ESMA1, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "ESMA2")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_ESMA2, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "ETMA")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_ETMA, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "EARO")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_EARO, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "EBRO")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_EBRO, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "ESCN")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_ESCN, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "ETCN")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_ETCN, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "ENRU")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_ENRU, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "ESHN")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_ESHN, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "ETTN")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_ETTN, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "EAMX")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_EAMX, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "EJMX1")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_EJMX1, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "EJMX2")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_EJMX2, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "ESMX")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_ESMX, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "EEPY")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_EEPY, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "EPIN")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_EPIN, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "EIBR")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_EIBR, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "ECPT")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_ECPT, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "EEMX")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_EEMX, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "EZTN")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_EZTN, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "EBPL")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_EBPL, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "EBTR")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_EBTR, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "EPZA")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_EPZA, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "ETHQ")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_ETHQ, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                        else if (dr["Value"].ToString() == "Global" && alias == "EPUS")
                                                        {
                                                            wsDl.Cells[MealAllowancePerDay_Global_EPUS, 1].Value = String.Format("{0} {1}", amount, currency);
                                                        }
                                                    }
                                                }
                                            }
                                            conn.Close();
                                        }
                                    }
                                    catch (Exception ex)
                                    {

                                    }
                                    if (exportExpenses._ExportExpensesLst != null)
                                    {
                                        List<List_OF_Expenses> tempTotalMealsAmount = exportExpenses._ExportExpensesLst.Where(w => w._IdCategory == 1563).ToList();
                                        //if (tempTotalMealsAmount != null)
                                        //{
                                        //   // wsDl.Cells[Index_TotalMealsAmount, 1].Value = tempTotalMealsAmount.Sum(s => Convert.ToDouble(s._Cost));
                                        //   wsDl.Cells[Index_TotalMealsAmount, 1].Value = (tempTotalMealsAmount.Sum(s => Convert.ToDouble(s._Cost))) / (1+tempTotalMealsAmount.Count());
                                        //}
                                        List<double> tempExpensesLst = new List<double>();
                                        double totalexpense = 0;
                                        foreach (var eitem in tempTotalMealsAmount)
                                        {
                                            double cost = eitem._Cost;
                                            double NoofExpense;
                                            if (eitem._ExportExpensesAttendees == null)
                                            {
                                                NoofExpense = 1;
                                            }
                                            else
                                            {
                                                NoofExpense = eitem._ExportExpensesAttendees.Count() + 1;
                                            }

                                            totalexpense = cost / (NoofExpense);
                                            tempExpensesLst.Add(totalexpense);
                                        }
                                        wsDl.Cells[Index_TotalMealsAmount, 1].Value = tempExpensesLst.Sum(s => Convert.ToDouble(s));
                                    }
                                    #region CurrencyExchangeRate


                                    string CurrencyName = GetCurrency(ConnectionString);
                                    string sourceCurrencyName = exportExpenses._Currency;
                                    string APIURL = CurrencyLayerAPI.ToString();
                                    string finalstring = (APIURL + "&currencies=" + CurrencyName + "&source=" + sourceCurrencyName + "&format=1").Trim().ToString();
                                    List<Currency_conversions> currencyconversionsList = Getcurrency_conversionsForExpenses(exportExpenses._IdCurrency, loginConnectionString);
                                    if (currencyconversionsList.Count() > 1)
                                    {
                                        wsDl.Cells[CurrencyExchangeRateTo_EUR, 1].Value = Convert.ToDouble(currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 1).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateTo_RON, 1].Value = Convert.ToDouble(currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 2).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateTo_USD, 1].Value = Convert.ToDouble(currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 3).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateTo_MXN, 1].Value = Convert.ToDouble(currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 4).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateTo_CNY, 1].Value = Convert.ToDouble(currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 5).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateTo_HNL, 1].Value = Convert.ToDouble(currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 6).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateTo_BRL, 1].Value = Convert.ToDouble(currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 7).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateTo_TND, 1].Value = Convert.ToDouble(currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 8).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateTo_MAD, 1].Value = Convert.ToDouble(currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 9).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateTo_PYG, 1].Value = Convert.ToDouble(currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 10).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateTo_RUB, 1].Value = Convert.ToDouble(currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 11).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateTo_INR, 1].Value = Convert.ToDouble(currencyconversionsList.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 12).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());

                                    }
                                    else
                                    {

                                        //string finalstring = "https://apilayer.net/api/live?access_key=34fe8672eefff10710e2b1a23b0a6d40&currencies=EUR,RON,USD,MXN,CNY,HNL,BRL,TND,MAD,PYG,RUB,INR,GBP,CAD,CHF&source=EUR&format=1".ToString();
                                        string json = new WebClient().DownloadString(finalstring);
                                        CurrencyExchangeapilayer apilayercurrencyconversionsList1 = Newtonsoft.Json.JsonConvert.DeserializeObject<CurrencyExchangeapilayer>(json);
                                        if (apilayercurrencyconversionsList1 != null)
                                        {

                                            if (apilayercurrencyconversionsList1.quotes != null)
                                            {
                                                var quotes = apilayercurrencyconversionsList1.quotes;
                                                var values = Newtonsoft.Json.JsonConvert.DeserializeObject<Dictionary<string, Double>>(quotes.ToString());
                                                if (sourceCurrencyName == "EUR")
                                                {
                                                    wsDl.Cells[CurrencyExchangeRateTo_EUR, 1].Value = 1;
                                                }
                                                else
                                                {

                                                    wsDl.Cells[CurrencyExchangeRateTo_EUR, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("EUR"))).Value;
                                                }
                                                if (sourceCurrencyName == "RON")
                                                {
                                                    wsDl.Cells[CurrencyExchangeRateTo_RON, 1].Value = 1;
                                                }
                                                else
                                                {

                                                    wsDl.Cells[CurrencyExchangeRateTo_RON, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("RON"))).Value;
                                                }
                                                if (sourceCurrencyName == "USD")
                                                {
                                                    wsDl.Cells[CurrencyExchangeRateTo_USD, 1].Value = 1;
                                                }
                                                else
                                                {

                                                    wsDl.Cells[CurrencyExchangeRateTo_USD, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("USD"))).Value;

                                                }
                                                if (sourceCurrencyName == "MXN")
                                                {
                                                    wsDl.Cells[CurrencyExchangeRateTo_MXN, 1].Value = 1;
                                                }
                                                else
                                                {
                                                    wsDl.Cells[CurrencyExchangeRateTo_MXN, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("MXN"))).Value;

                                                }
                                                if (sourceCurrencyName == "CNY")
                                                {
                                                    wsDl.Cells[CurrencyExchangeRateTo_CNY, 1].Value = 1;
                                                }
                                                else
                                                {

                                                    wsDl.Cells[CurrencyExchangeRateTo_CNY, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("CNY"))).Value;
                                                }
                                                if (sourceCurrencyName == "HNL")
                                                {
                                                    wsDl.Cells[CurrencyExchangeRateTo_HNL, 1].Value = 1;
                                                }
                                                else
                                                {

                                                    wsDl.Cells[CurrencyExchangeRateTo_HNL, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("HNL"))).Value;
                                                }
                                                if (sourceCurrencyName == "BRL")
                                                {
                                                    wsDl.Cells[CurrencyExchangeRateTo_BRL, 1].Value = 1;
                                                }
                                                else
                                                {

                                                    wsDl.Cells[CurrencyExchangeRateTo_BRL, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("BRL"))).Value;
                                                }
                                                if (sourceCurrencyName == "TND")
                                                {
                                                    wsDl.Cells[CurrencyExchangeRateTo_TND, 1].Value = 1;
                                                }
                                                else
                                                {

                                                    wsDl.Cells[CurrencyExchangeRateTo_TND, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("TND"))).Value;
                                                }
                                                if (sourceCurrencyName == "MAD")
                                                {
                                                    wsDl.Cells[CurrencyExchangeRateTo_MAD, 1].Value = 1;
                                                }
                                                else
                                                {

                                                    wsDl.Cells[CurrencyExchangeRateTo_MAD, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("MAD"))).Value;
                                                }
                                                if (sourceCurrencyName == "PYG")
                                                {
                                                    wsDl.Cells[CurrencyExchangeRateTo_PYG, 1].Value = 1;
                                                }
                                                else
                                                {

                                                    wsDl.Cells[CurrencyExchangeRateTo_PYG, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("PYG"))).Value;
                                                }
                                                if (sourceCurrencyName == "RUB")
                                                {
                                                    wsDl.Cells[CurrencyExchangeRateTo_RUB, 1].Value = 1;
                                                }
                                                else
                                                {

                                                    wsDl.Cells[CurrencyExchangeRateTo_RUB, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("RUB"))).Value;
                                                }
                                                if (sourceCurrencyName == "INR")
                                                {
                                                    wsDl.Cells[CurrencyExchangeRateTo_INR, 1].Value = 1;
                                                }
                                                else
                                                {

                                                    wsDl.Cells[CurrencyExchangeRateTo_INR, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("INR"))).Value;
                                                }
                                            }

                                        }

                                    }
                                    //Rahul[rgadhave] for APIGEOS-883[30/10/2023]
                                    List<Currency_conversions> currencyconversionsList1 = Getcurrency_conversionsForExpenses_V630(exportExpenses._IdCurrency, loginConnectionString);
                                    if (currencyconversionsList1.Count() > 1)
                                    {
                                        wsDl.Cells[CurrencyExchangeRateFrom_EUR, 1].Value = Convert.ToDouble(currencyconversionsList1.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 1).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateFrom_RON, 1].Value = Convert.ToDouble(currencyconversionsList1.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 2).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateFrom_USD, 1].Value = Convert.ToDouble(currencyconversionsList1.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 3).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateFrom_MXN, 1].Value = Convert.ToDouble(currencyconversionsList1.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 4).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateFrom_CNY, 1].Value = Convert.ToDouble(currencyconversionsList1.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 5).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateFrom_HNL, 1].Value = Convert.ToDouble(currencyconversionsList1.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 6).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateFrom_BRL, 1].Value = Convert.ToDouble(currencyconversionsList1.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 7).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateFrom_TND, 1].Value = Convert.ToDouble(currencyconversionsList1.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 8).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateFrom_MAD, 1].Value = Convert.ToDouble(currencyconversionsList1.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 9).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateFrom_PYG, 1].Value = Convert.ToDouble(currencyconversionsList1.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 10).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateFrom_RUB, 1].Value = Convert.ToDouble(currencyconversionsList1.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 11).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());
                                        wsDl.Cells[CurrencyExchangeRateFrom_INR, 1].Value = Convert.ToDouble(currencyconversionsList1.Where(c => c.IdCurrencyConversionFrom == exportExpenses._IdCurrency && c.IdCurrencyConversionTo == 12).Select(c => c.CurrencyConversionRate).DefaultIfEmpty("0").FirstOrDefault());

                                    }
                                    else
                                    {

                                        //string resultString = string.Empty;
                                        List<CurrencyExchangeapilayer> currencyConversionsList2 = new List<CurrencyExchangeapilayer>();
                                        foreach (var currency in CurrencyName.Split(','))
                                        {

                                            string apiRequestURL = $"{APIURL}&currencies={sourceCurrencyName}&source={currency}&format=1";
                                            string apiResponse = new WebClient().DownloadString(apiRequestURL);
                                            // Deserialize each API response separately
                                            CurrencyExchangeapilayer apiLayerCurrencyConversions = Newtonsoft.Json.JsonConvert.DeserializeObject<CurrencyExchangeapilayer>(apiResponse);

                                            // Add each result to the list
                                            currencyConversionsList2.Add(apiLayerCurrencyConversions);
                                        }

                                        Dictionary<string, Double> currencyConversionsListvalues = new Dictionary<string, Double>();
                                        foreach (CurrencyExchangeapilayer currencyConversion in currencyConversionsList2)
                                        {
                                            try
                                            {
                                                var quotes = currencyConversion.quotes;
                                                Dictionary<string, Double> quotesvalues = Newtonsoft.Json.JsonConvert.DeserializeObject<Dictionary<string, Double>>(quotes.ToString());
                                                string currencyPair = quotesvalues.FirstOrDefault().ToString();
                                                double exchangeRate = quotesvalues.FirstOrDefault().Value;
                                                currencyConversionsListvalues.Add(currencyPair, exchangeRate);
                                            }
                                            catch (Exception ex)
                                            {

                                            }
                                        }
                                        if (currencyConversionsListvalues != null)
                                        {
                                            var values = currencyConversionsListvalues;
                                            if (sourceCurrencyName == "EUR")
                                            {
                                                wsDl.Cells[CurrencyExchangeRateFrom_EUR, 1].Value = 1;

                                            }
                                            else
                                            {

                                                wsDl.Cells[CurrencyExchangeRateFrom_EUR, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("EUR"))).Value;
                                            }
                                            if (sourceCurrencyName == "RON")
                                            {
                                                wsDl.Cells[CurrencyExchangeRateFrom_RON, 1].Value = 1;
                                            }
                                            else
                                            {

                                                wsDl.Cells[CurrencyExchangeRateFrom_RON, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("RON"))).Value;
                                            }
                                            if (sourceCurrencyName == "USD")
                                            {
                                                wsDl.Cells[CurrencyExchangeRateFrom_USD, 1].Value = 1;
                                            }
                                            else
                                            {

                                                wsDl.Cells[CurrencyExchangeRateFrom_USD, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("USD"))).Value;
                                            }
                                            if (sourceCurrencyName == "MXN")
                                            {
                                                wsDl.Cells[CurrencyExchangeRateFrom_MXN, 1].Value = 1;
                                            }
                                            else
                                            {

                                                wsDl.Cells[CurrencyExchangeRateFrom_MXN, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("MXN"))).Value;
                                            }
                                            if (sourceCurrencyName == "CNY")
                                            {
                                                wsDl.Cells[CurrencyExchangeRateFrom_CNY, 1].Value = 1;
                                            }
                                            else
                                            {

                                                wsDl.Cells[CurrencyExchangeRateFrom_CNY, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("CNY"))).Value;
                                            }
                                            if (sourceCurrencyName == "HNL")
                                            {
                                                wsDl.Cells[CurrencyExchangeRateFrom_HNL, 1].Value = 1;
                                            }
                                            else
                                            {

                                                wsDl.Cells[CurrencyExchangeRateFrom_HNL, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("HNL"))).Value;
                                            }
                                            if (sourceCurrencyName == "BRL")
                                            {
                                                wsDl.Cells[CurrencyExchangeRateFrom_BRL, 1].Value = 1;
                                            }
                                            else
                                            {

                                                wsDl.Cells[CurrencyExchangeRateFrom_BRL, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("BRL"))).Value;
                                            }
                                            if (sourceCurrencyName == "TND")
                                            {
                                                wsDl.Cells[CurrencyExchangeRateFrom_TND, 1].Value = 1;
                                            }
                                            else
                                            {

                                                wsDl.Cells[CurrencyExchangeRateFrom_TND, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("TND"))).Value;
                                            }
                                            if (sourceCurrencyName == "MAD")
                                            {
                                                wsDl.Cells[CurrencyExchangeRateFrom_MAD, 1].Value = 1;
                                            }
                                            else
                                            {

                                                wsDl.Cells[CurrencyExchangeRateFrom_MAD, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("MAD"))).Value;
                                            }
                                            if (sourceCurrencyName == "PYG")
                                            {
                                                wsDl.Cells[CurrencyExchangeRateFrom_PYG, 1].Value = 1;
                                            }
                                            else
                                            {

                                                wsDl.Cells[CurrencyExchangeRateFrom_PYG, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("PYG"))).Value;
                                            }
                                            if (sourceCurrencyName == "RUB")
                                            {
                                                wsDl.Cells[CurrencyExchangeRateFrom_RUB, 1].Value = 1;
                                            }
                                            else
                                            {

                                                wsDl.Cells[CurrencyExchangeRateFrom_RUB, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("RUB"))).Value;
                                            }
                                            if (sourceCurrencyName == "INR")
                                            {
                                                wsDl.Cells[CurrencyExchangeRateFrom_INR, 1].Value = 1;
                                            }
                                            else
                                            {

                                                wsDl.Cells[CurrencyExchangeRateFrom_INR, 1].Value = values.FirstOrDefault(k => k.Key == values.Select(i => i.Key).ToList().FirstOrDefault(j => j.Contains("INR"))).Value;
                                            }

                                        }

                                    }
                                    //End
                                    #endregion
                                }
                                catch (Exception ex)
                                {

                                }
                                #region ExportExpensesLst                          
                                if (exportExpenses._ExportExpensesLst != null)
                                {
                                    Int32 Expenses_ItemsHeadingStartRow = Convert.ToInt32(Expenses_count) - 1;
                                    Worksheet wsDlExpenses = workbook.Worksheets[1];
                                    wsDlExpenses.Cells[Expenses_ItemWeekColumn + (Expenses_ItemsStartRow - 1)].Value = Expenses_lblColWeek;
                                    wsDlExpenses.Cells[Expenses_ItemDateColumn + (Expenses_ItemsStartRow - 1)].Value = Expenses_lblColDate;
                                    wsDlExpenses.Cells[Expenses_ItemDayColumn + (Expenses_ItemsStartRow - 1)].Value = Expenses_lblColDay;

                                    wsDlExpenses.Cells[Expenses_ItemSummaryColumn + (Expenses_ItemsStartRow - 1)].Value = Expenses_lblColSummary;
                                    wsDlExpenses.Cells[Expenses_ItemCategoryColumn + (Expenses_ItemsStartRow - 1)].Value = Expenses_lblColCategory;
                                    wsDlExpenses.Cells[Expenses_ItemPaymentMethodColumn + (Expenses_ItemsStartRow - 1)].Value = Expenses_lblColPayment;
                                    wsDlExpenses.Cells[Expenses_ItemCostColumn + (Expenses_ItemsStartRow - 1)].Value = Expenses_lblColCost;

                                    if (exportExpenses._ExportExpensesLst.Count > 1)
                                        wsDlExpenses.Rows.Insert(Expenses_ItemsHeadingStartRow + 1, exportExpenses._ExportExpensesLst.Count() - 1, RowFormatMode.FormatAsPrevious);
                                    if (exportExpenses._ExportExpensesLst != null)
                                        foreach (List_OF_Expenses item in exportExpenses._ExportExpensesLst)
                                        {

                                            if (item._SummaryColumn.Equals("TIP"))
                                            {
                                                wsDlExpenses.Cells[Expenses_ItemSummaryColumn + Expenses_ItemsStartRow].Value = Expenses_lblTip;
                                                wsDlExpenses.Cells[Expenses_ItemCostColumn + Expenses_ItemsStartRow].Value = Convert.ToDouble(item._Tip.ToString());
                                                wsDlExpenses.Rows[(Expenses_ItemsStartRow - 1)].Font.Bold = true;
                                            }
                                            else
                                            {
                                                // string[] multilang = exportExpenses.Language.Split(',');
                                                // foreach (string lancult in multilang)
                                                // {

                                                if (getLanguage != null)
                                                {
                                                    //string lancult = exportExpenses.Language.ToLower() + ("-GB");
                                                    cultureInfo = new CultureInfo(string.IsNullOrEmpty(getLanguage.CultureName) ? "en-GB" : getLanguage.CultureName, true);
                                                    DayOfWeek day = cultureInfo.Calendar.GetDayOfWeek(Convert.ToDateTime(item._DateColumn.ToString()));
                                                    Log4NetLogger.Logger.Log(string.Format("Info ExportExpenses(). day- {0}", day), category: Category.Info, priority: Priority.Low);
                                                    int weekNum = cultureInfo.Calendar.GetWeekOfYear(Convert.ToDateTime(item._DateColumn), CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
                                                    Log4NetLogger.Logger.Log(string.Format("Info ExportExpenses(). weekNum- {0}", weekNum), category: Category.Info, priority: Priority.Low);
                                                    item._WeekColumn = weekNum.ToString();
                                                    string[] names = cultureInfo.DateTimeFormat.AbbreviatedDayNames;
                                                    Log4NetLogger.Logger.Log(string.Format("Info ExportExpenses(). names- {0}", string.Join(",", names)), category: Category.Info, priority: Priority.Low);
                                                    string DayColumn = names[(int)day];
                                                    Log4NetLogger.Logger.Log(string.Format("Info ExportExpenses(). DayColumn- {0}", DayColumn), category: Category.Info, priority: Priority.Low);

                                                    DayOfWeek day1 = cultureInfo.Calendar.GetDayOfWeek(Convert.ToDateTime(item._DateColumn));
                                                    Log4NetLogger.Logger.Log(string.Format("Info ExportExpenses(). day1- {0}", day1), category: Category.Info, priority: Priority.Low);
                                                    string day1ToStr = day1.ToString().Substring(0, 3);
                                                    Log4NetLogger.Logger.Log(string.Format("Info ExportExpenses(). day1ToStr- {0}", day1ToStr), category: Category.Info, priority: Priority.Low);

                                                    #region Add Expenses Attendees in SummaryColumn

                                                    if (item._ExportExpensesAttendees != null)
                                                    {
                                                        RichTextString richText = new RichTextString();
                                                        SpreadsheetFont cellFont = wsDlExpenses.Cells[Expenses_ItemSummaryColumn + Expenses_ItemsStartRow].Font;
                                                        RichTextRunFont RichTextForSummaryColumn = new RichTextRunFont(cellFont.Name, (cellFont.Size), cellFont.Color);
                                                        RichTextRunFont RichText = new RichTextRunFont(cellFont.Name, (cellFont.Size - 3), cellFont.Color);
                                                        RichTextRunFont RichText1 = new RichTextRunFont(cellFont.Name, (cellFont.Size - 3), cellFont.Color);
                                                        RichText1.UnderlineType = UnderlineType.Single;
                                                        int count = 0;
                                                        foreach (var ExportExpensesAttendees in item._ExportExpensesAttendees)
                                                        {
                                                            if (count == 0)
                                                            {
                                                                richText.AddTextRun(item._SummaryColumn, RichTextForSummaryColumn);
                                                                richText.AddTextRun("\n", new RichTextRunFont(cellFont.Name, cellFont.Size, cellFont.Color));
                                                                richText.AddTextRun(Expenses_lblAttendees, RichText1);
                                                            }
                                                            if (!string.IsNullOrEmpty(ExportExpensesAttendees.Name))
                                                            {
                                                                richText.AddTextRun("\n", new RichTextRunFont(cellFont.Name, cellFont.Size, cellFont.Color));
                                                                richText.AddTextRun(ExportExpensesAttendees.stylesymbol + ExportExpensesAttendees.Name, RichText);
                                                            }
                                                            count = count + 1;
                                                        }
                                                        wsDlExpenses.Cells[Expenses_ItemSummaryColumn + Expenses_ItemsStartRow].SetRichText(richText);
                                                    }
                                                    else
                                                    {
                                                        wsDlExpenses.Cells[Expenses_ItemSummaryColumn + Expenses_ItemsStartRow].Value = item._SummaryColumn;
                                                    }

                                                    #endregion

                                                    // item._DayColumn = day1ToStr;
                                                    // item._DayColumn = cultureInfo.DateTimeFormat.GetDayName(day).Substring(0, 3);
                                                    switch (day.ToString().ToUpper())
                                                    {
                                                        case "SUNDAY":
                                                            item._DayColumn = Expenses_lblTSun;
                                                            break;
                                                        case "MONDAY":
                                                            item._DayColumn = Expenses_lblMon;
                                                            break;
                                                        case "TUESDAY":
                                                            item._DayColumn = Expenses_lblTue;
                                                            break;
                                                        case "WEDNESDAY":
                                                            item._DayColumn = Expenses_lblWed;
                                                            break;
                                                        case "THURSDAY":
                                                            item._DayColumn = Expenses_lblThu;
                                                            break;
                                                        case "FRIDAY":
                                                            item._DayColumn = Expenses_lblFri;
                                                            break;
                                                        case "SATURDAY":
                                                            item._DayColumn = Expenses_lblSat;
                                                            break;

                                                        //if no case value is matched
                                                        default:
                                                            item._DayColumn = cultureInfo.DateTimeFormat.GetDayName(day).Substring(0, 3);
                                                            break;
                                                    }
                                                    wsDlExpenses.Cells[Expenses_ItemWeekColumn + Expenses_ItemsStartRow].Value = item._WeekColumn;

                                                    #region Set CultureInfo ExpensesToDate

                                                    if (!String.IsNullOrEmpty(item._DateColumn))
                                                    {
                                                        DateTime dt = DateTime.ParseExact(item._DateColumn, "dd-MM-yyyy", null);
                                                        wsDlExpenses.Cells[Expenses_ItemDateColumn + Expenses_ItemsStartRow].Value = dt.ToString(cultureInfo.DateTimeFormat.ShortDatePattern, cultureInfo);
                                                    }
                                                    else
                                                    {
                                                        wsDlExpenses.Cells[Expenses_ItemDateColumn + Expenses_ItemsStartRow].Value = item._DateColumn;
                                                    }
                                                    #endregion

                                                    //wsDlExpenses.Cells[Expenses_ItemDateColumn + Expenses_ItemsStartRow].Value = item._DateColumn;
                                                    wsDlExpenses.Cells[Expenses_ItemDayColumn + Expenses_ItemsStartRow].Value = item._DayColumn;
                                                    //wsDlExpenses.Cells[Expenses_ItemSummaryColumn + Expenses_ItemsStartRow].Value = item._SummaryColumn;
                                                    wsDlExpenses.Cells[Expenses_ItemCategoryColumn + Expenses_ItemsStartRow].Value = item._Category;
                                                    wsDlExpenses.Cells[Expenses_ItemPaymentMethodColumn + Expenses_ItemsStartRow].Value = item._PaymentMethodColumn;
                                                    wsDlExpenses.Cells[Expenses_ItemCostColumn + Expenses_ItemsStartRow].Value = Convert.ToDouble(item._Cost.ToString());
                                                }

                                            }

                                            Expenses_ItemsStartRow = Expenses_ItemsStartRow + 1;
                                        }
                                    wsDlExpenses.Rows.Remove(Expenses_ItemsStartRow + 3, 1048575 - (Expenses_ItemsStartRow + 2));
                                }
                                else
                                {
                                    workbook.Worksheets[1].Visible = false;
                                }
                                #endregion
                                workbook.Worksheets[2].Visible = false;
                                workbook.Worksheets[3].Visible = false;
                                workbook.SaveDocument(stream, DocumentFormat.Xlsx);
                                isDone = true;
                            }
                            using (FileStream pdfFileStream = new FileStream(Path.Combine(updatedExcelFilePath, filenamePDF), FileMode.Create))
                            {
                                workbook.ExportToPdf(pdfFileStream);
                            }
                            workbook.Dispose();
                            if (stream != null)
                            {
                                stream.Dispose();
                            }
                            // }//multi pdf close
                            // }//multiple files close
                            #region GetFiles

                            //Added By Rahul[rgadhave] for APIGEOS-911 Add a new setting to specify if generate the tickets report or not
                            string generateExpenseReceiptsReport = string.Empty;
                            using (MySqlConnection conn1 = new MySqlConnection(_ConnEmdepGeosString))
                            {
                                conn1.Open();
                                MySqlCommand command1 = new MySqlCommand("GEOSAPI_Getgeos_app_settingsByName_V620", conn1);
                                command1.CommandType = CommandType.StoredProcedure;
                                command1.Parameters.AddWithValue("_AppSettingName", "GenerateExpenseReceiptsReport");
                                using (MySqlDataReader dr = command1.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        if (dr["DefaultValue"] != DBNull.Value)
                                        {
                                            generateExpenseReceiptsReport = Convert.ToString(dr["DefaultValue"]);
                                        }
                                    }
                                }
                                conn1.Close();
                                if (generateExpenseReceiptsReport == "true")
                                {
                                    Dictionary<string, string> DictonaryArticle = new Dictionary<string, string>();
                                    List<string> AllFiles = new List<string>();
                                    //var filters = new string[] { "jpg", "jpeg", "png", "gif", "tiff", "bmp", "svg" };
                                    if (exportExpenses._ExportExpensesLst != null)
                                    {
                                        foreach (var exportExpensesItem in exportExpenses._ExportExpensesLst)
                                        {
                                            if (exportExpensesItem._ExportExpensesAttachments != null)
                                            {
                                                int numcount = 0;
                                                var tempExpensesAttachment = exportExpensesItem._ExportExpensesAttachments.Where(w => w.IdEmployeeExpense == exportExpensesItem._IdEmployeeExpense);
                                                if (tempExpensesAttachment.Count() == 1)
                                                {
                                                    //tempExpensesAttachment. = string.Format("{0}", exportExpensesItem._columnNum);
                                                    foreach (var tempExpensesAttachmentLst in tempExpensesAttachment)
                                                    {
                                                        tempExpensesAttachmentLst._attachmentNumber = string.Format("{0}", exportExpensesItem._columnNum);
                                                    }
                                                }
                                                else
                                                {
                                                    foreach (var tempExpensesAttachmentLst in tempExpensesAttachment)
                                                    {
                                                        numcount = numcount + 1;
                                                        tempExpensesAttachmentLst._attachmentNumber = string.Format("{0}.{1}", exportExpensesItem._columnNum, numcount.ToString());

                                                    }
                                                }

                                                foreach (var itemAttachment in exportExpensesItem._ExportExpensesAttachments)
                                                {
                                                    if (!DictonaryArticle.ContainsKey(itemAttachment._attachmentNumber.ToString()))
                                                    {
                                                        try
                                                        {
                                                            #region APIGEOS-659 APIGEOS-618 not working as expected
                                                            // shubham[skadam] APIGEOS-659  endpoint Accounting/Employees/Export https://helpdesk.emdep.com/browse/APIGEOS-462 APIGEOS-659 APIGEOS-618 not working as expected 12 11 2022
                                                            if (itemAttachment.FileType.ToLower() == ".pdf".ToLower())
                                                            {

                                                                if (!Directory.Exists(EmployeesExpensesAttachmentPath + @"\" + itemAttachment.IdEmployeeExpense))
                                                                {
                                                                    Directory.CreateDirectory(EmployeesExpensesAttachmentPath + @"\" + itemAttachment.IdEmployeeExpense);
                                                                }
                                                                string filepath = Directory.GetFiles(EmployeesExpensesAttachmentPath + @"\" + itemAttachment.IdEmployeeExpense, itemAttachment.SavedFileName, SearchOption.AllDirectories)
                                                                    .Where(f => f.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase)).FirstOrDefault();
                                                                if (File.Exists(filepath))
                                                                    if (filepath != null)
                                                                    {
                                                                        PdfReader pdfReader = new PdfReader(filepath);
                                                                        int numberOfPages = pdfReader.NumberOfPages;
                                                                        for (int p = 1; p <= numberOfPages; p++)
                                                                        {
                                                                            DictonaryArticle.Add(itemAttachment._attachmentNumber.ToString() + "\n ;Page_" + p, itemAttachment.OriginalFileName.ToString());
                                                                        }
                                                                    }
                                                            }
                                                            #endregion
                                                            else
                                                            {
                                                                if (File.Exists(Path.Combine(EmployeesExpensesAttachmentPath + @"\" + itemAttachment.IdEmployeeExpense + @"\" + itemAttachment.SavedFileName)))
                                                                {
                                                                    DictonaryArticle.Add(itemAttachment._attachmentNumber.ToString(), itemAttachment.OriginalFileName.ToString());
                                                                }

                                                            }
                                                        }
                                                        catch (Exception ex)
                                                        {
                                                            #region when use updated wrong files get img file
                                                            //APIGEOS - 758 Error when generating an expense report 30 03 2023
                                                            try
                                                            {
                                                                if (File.Exists(Path.Combine(EmployeesExpensesAttachmentPath + @"\" + itemAttachment.IdEmployeeExpense + @"\" +
                                                                    Path.GetFileNameWithoutExtension(itemAttachment.SavedFileName) + ".png")))
                                                                {
                                                                    DictonaryArticle.Add(itemAttachment._attachmentNumber.ToString(),
                                                                    Path.GetFileNameWithoutExtension(itemAttachment.SavedFileName) + ".png");
                                                                }
                                                            }
                                                            catch (Exception ex1)
                                                            {
                                                            }
                                                            #endregion
                                                        }
                                                    }
                                                    if (itemAttachment.IdEmployeeExpense != 0)
                                                    {
                                                        if (!Directory.Exists(EmployeesExpensesAttachmentPath + @"\" + itemAttachment.IdEmployeeExpense))
                                                        {
                                                            Directory.CreateDirectory(EmployeesExpensesAttachmentPath + @"\" + itemAttachment.IdEmployeeExpense);
                                                        }
                                                        if (File.Exists(Path.Combine(EmployeesExpensesAttachmentPath + @"\" + itemAttachment.IdEmployeeExpense + @"\" + itemAttachment.SavedFileName)))
                                                        {
                                                            string[] fileArray = Directory.GetFiles(EmployeesExpensesAttachmentPath + @"\" + itemAttachment.IdEmployeeExpense, itemAttachment.SavedFileName, SearchOption.AllDirectories).Where(f => f.EndsWith(".jpg", StringComparison.OrdinalIgnoreCase)
                                                            || f.EndsWith(".jpeg", StringComparison.OrdinalIgnoreCase) || f.EndsWith(".png", StringComparison.OrdinalIgnoreCase) || f.EndsWith(".gif", StringComparison.OrdinalIgnoreCase)
                                                            || f.EndsWith(".tiff", StringComparison.OrdinalIgnoreCase) || f.EndsWith(".bmp", StringComparison.OrdinalIgnoreCase) || f.EndsWith(".svg", StringComparison.OrdinalIgnoreCase)
                                                            || f.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase)).ToArray();
                                                            AllFiles.AddRange(fileArray);

                                                        }
                                                    }

                                                }
                                            }
                                        }
                                    }
                                    #endregion

                                    #region DeletetempFolder                     
                                    string tempFolderPath = Path.GetTempPath();
                                    string createFolderName = tempFolderPath + "ExpensesAttachment\\" + DateTime.Now.ToString("yyyyMMdd");
                                    try
                                    {
                                        string[] dirs = Directory.GetDirectories(tempFolderPath + "ExpensesAttachment\\");
                                        foreach (var item in dirs)
                                        {
                                            if (item != createFolderName)
                                            {
                                                string searchpattern = "Receipts" + '*';
                                                string[] getAllfiles = Directory.GetFiles(item, searchpattern, SearchOption.AllDirectories);
                                                foreach (var fileitem in getAllfiles)
                                                {
                                                    File.Delete(fileitem);
                                                }

                                            }
                                            if (item != createFolderName)
                                            {
                                                Directory.Delete(item, true);
                                            }
                                        }

                                    }
                                    catch (Exception ex)
                                    {
                                        //throw ex;
                                    }
                                    #endregion
                                    if (AllFiles.Count() > 0)
                                    {
                                        if (!System.IO.Directory.Exists(createFolderName))
                                        {
                                            System.IO.Directory.CreateDirectory(createFolderName);
                                        }
                                        try
                                        {
                                            #region Single page Working code

                                            using (DevExpress.XtraRichEdit.RichEditDocumentServer server = new DevExpress.XtraRichEdit.RichEditDocumentServer())
                                            {
          
                                                int pagecount = 0;
                                                for (int i = 0; i < AllFiles.Count; i++)
                                                {
                                                    #region APIGEOS-659 APIGEOS-618 not working as expected
                                                    // shubham[skadam] APIGEOS-659  endpoint Accounting/Employees/Export https://helpdesk.emdep.com/browse/APIGEOS-462 APIGEOS-659 APIGEOS-618 not working as expected 12 11 2022
                                                    string ext = Path.GetExtension(AllFiles[i]);
                                                    if (ext.ToLower() == ".pdf".ToLower())
                                                    {
                                                        int largestEdgeLength = 1000;
                                                        try
                                                        {
                                                            using (PdfDocumentProcessor processor = new PdfDocumentProcessor())
                                                            {
                                                                // Load a document.
                                                                processor.LoadDocument(AllFiles[i]);
                                                                //for (int p = 1; p <= 1; p++)
                                                                for (int p = 1; p <= processor.Document.Pages.Count; p++)
                                                                {
                                                                    // Export pages to bitmaps.
                                                                    Bitmap image = processor.CreateBitmap(p, largestEdgeLength);
                                                                    System.Drawing.Image BitmaptoImage = (System.Drawing.Image)image;
                                                                    DevExpress.XtraRichEdit.API.Native.DocumentImage BitmaptodocImage = server.Document.Images.Append(DevExpress.XtraRichEdit.API.Native.DocumentImageSource.FromImage(image));
                                                                    try
                                                                    {
                                                                        int Sections = (Convert.ToInt32(server.Document.Sections.Count) - 1);
                                                                        DevExpress.XtraRichEdit.API.Native.Section currentSectionPdftoImage = server.Document.Sections[Sections];
                                                                        currentSectionPdftoImage.Page.Width = BitmaptodocImage.Size.Width + currentSectionPdftoImage.Margins.Right + currentSectionPdftoImage.Margins.Left;
                                                                        currentSectionPdftoImage.Page.Height = BitmaptodocImage.Size.Height + currentSectionPdftoImage.Margins.Top + currentSectionPdftoImage.Margins.Bottom;
                                                                    }
                                                                    catch (Exception ex) { }

                                                                    if (p < processor.Document.Pages.Count - 1) server.Document.AppendSection();
                                                                    //server.Document.AppendSection();
                                                                    pagecount = pagecount + 1;
                                                                }
                                                            }
                                                        }
                                                        catch (Exception ex)
                                                        {
                                                            Log4NetLogger.Logger.Log(string.Format("Error ExportExpenses(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                                        }
                                                    }
                                                    #endregion
                                                    else
                                                    {
                                                        System.Drawing.Image img = System.Drawing.Image.FromFile(AllFiles[i], true);
                                                        System.Drawing.Image ResizeImage = img;
                                                        DevExpress.XtraRichEdit.API.Native.DocumentImage docImage = server.Document.Images.Append(ResizeImage);
                                                        // DevExpress.XtraRichEdit.API.Native.DocumentImage docImage = server.Document.Images.Append(DevExpress.XtraRichEdit.API.Native.DocumentImageSource.FromFile(AllFiles[i]));
                                                        try
                                                        {
                                                            int Sections = (Convert.ToInt32(server.Document.Sections.Count) - 1);
                                                            DevExpress.XtraRichEdit.API.Native.Section currentSection = server.Document.Sections[Sections];
                                                            currentSection.Page.Width = docImage.Size.Width + currentSection.Margins.Right + currentSection.Margins.Left;
                                                            currentSection.Page.Height = docImage.Size.Height + currentSection.Margins.Top + currentSection.Margins.Bottom;
                                                        }
                                                        catch (Exception ex)
                                                        {
                                                            Log4NetLogger.Logger.Log(string.Format("Error ExportExpenses(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                                        }

                                                        if (i < AllFiles.Count - 1) server.Document.AppendSection();
                                                        pagecount = pagecount + 1;
                                                    }
                                                }
                                                //Export the result to PDF
                                                foreach (var serveritem in server.Document.Sections)
                                                {
                                                    serveritem.Margins.Left = 0.5f;
                                                    serveritem.Margins.Right = 0.5f;
                                                    serveritem.Margins.Top = 1f;
                                                    serveritem.Margins.Bottom = 0.5f;
                                                }
                                                using (FileStream fs = new FileStream(Path.Combine(createFolderName, receiptsPDF), FileMode.OpenOrCreate))
                                                {
                                                    server.ExportToPdf(fs);
                                                }
                                            }
                                            #endregion
                                        }
                                        catch (Exception ex)
                                        {
                                            Log4NetLogger.Logger.Log(string.Format("Error ExportExpenses(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                        }
                                        #region ReceiptsPDF_PageSize
                                        string geos_app_settingsReceiptsPDF_PageSize = string.Empty;
                                        using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                                        {
                                            conn.Open();
                                            MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                            command.CommandType = CommandType.StoredProcedure;
                                            command.Parameters.AddWithValue("_IdAppSetting", 79);
                                            using (MySqlDataReader dr = command.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    if (dr["DefaultValue"] != DBNull.Value)
                                                    {
                                                        geos_app_settingsReceiptsPDF_PageSize = Convert.ToString(dr["DefaultValue"]);
                                                    }
                                                }
                                            }

                                        }

                                        List<string> Tempapp_settings = geos_app_settingsReceiptsPDF_PageSize.Split(';').ToList();
                                        List<float> header_PageSize_Settings = new List<float>();
                                        foreach (var item in Tempapp_settings)
                                        {
                                            header_PageSize_Settings.Add((float)Convert.ToDouble(Regex.Match(item, @"\d+").Value));
                                        }
                                        #endregion

                                        #region createPDFDocument

                                        iTextSharp.text.pdf.PdfReader reader = new iTextSharp.text.pdf.PdfReader(Path.Combine(createFolderName, receiptsPDF));
                                        iTextSharp.text.Document document = new iTextSharp.text.Document(iTextSharp.text.PageSize.A4, header_PageSize_Settings[0],
                                            header_PageSize_Settings[1], header_PageSize_Settings[2], header_PageSize_Settings[3]);
                                        //document.SetMargins(0, 0, 0, 0);
                                        //document.SetPageSize(iTextSharp.text.PageSize.A4);
                                        iTextSharp.text.pdf.PdfWriter writer = iTextSharp.text.pdf.PdfWriter.GetInstance(document, new FileStream(Path.Combine(updatedExcelFilePath, receiptsPDF), FileMode.Create));
                                        document.Open();
                                        iTextSharp.text.pdf.PdfImportedPage page;
                                        iTextSharp.text.pdf.PdfPTable table = new iTextSharp.text.pdf.PdfPTable(2);
                                        //table.LockedWidth = true;
                                        table.WidthPercentage = 100;
                                        table.SpacingBefore = 0;
                                        table.SpacingAfter = 0;
                                        table.PaddingTop = 0;
                                        int tableCount = 0;
                                        for (int i = 1; i <= reader.NumberOfPages; i++)
                                        {
                                            if (i <= DictonaryArticle.Count)
                                            {
                                                iTextSharp.text.pdf.PdfPTable innertable = new iTextSharp.text.pdf.PdfPTable(1);
                                                innertable.SpacingBefore = 0;
                                                innertable.SpacingAfter = 0;
                                                innertable.DefaultCell.Border = iTextSharp.text.Rectangle.NO_BORDER;
                                                innertable.PaddingTop = 0;

                                                //table.DefaultCell.Border = iTextSharp.text.Rectangle.NO_BORDER;
                                                // shubham[skadam] APIGEOS-659  endpoint Accounting/Employees/Export https://helpdesk.emdep.com/browse/APIGEOS-462 APIGEOS-659 APIGEOS-618 not working as expected 12 11 2022
                                                string[] tokens = DictonaryArticle.ElementAt(i - 1).Key.Split(';');
                                                string last = tokens[tokens.Length - 1];
                                                Phrase phrase = new Phrase();
                                                #region OldCode
                                                //iTextSharp.text.pdf.PdfPCell cell2 = new iTextSharp.text.pdf.PdfPCell(new iTextSharp.text.Phrase(tokens.FirstOrDefault() + "\n",
                                                // new iTextSharp.text.Font(iTextSharp.text.Font.FontFamily.TIMES_ROMAN, 16, iTextSharp.text.Font.BOLD)));
                                                //cell2.HorizontalAlignment = iTextSharp.text.Element.ALIGN_CENTER;
                                                //cell2.Border = 0;
                                                //cell2.PaddingLeft = 0;
                                                //cell2.PaddingRight = 0;
                                                //cell2.PaddingTop = 0;
                                                //cell2.PaddingBottom = 0;
                                                //innertable.AddCell(cell2);
                                                #endregion
                                                phrase.Add(new Chunk(tokens.FirstOrDefault(), new iTextSharp.text.Font(iTextSharp.text.Font.FontFamily.TIMES_ROMAN, 16, iTextSharp.text.Font.BOLD)));
                                                if (!tokens.FirstOrDefault().Equals(last))
                                                {
                                                    #region OldCode
                                                    //iTextSharp.text.pdf.PdfPCell cell3 = new iTextSharp.text.pdf.PdfPCell(new iTextSharp.text.Phrase(last + "\n",
                                                    //new iTextSharp.text.Font(iTextSharp.text.Font.FontFamily.TIMES_ROMAN, 05, iTextSharp.text.Font.BOLD)));
                                                    //cell3.HorizontalAlignment = iTextSharp.text.Element.ALIGN_CENTER;
                                                    //cell3.Border = 0;
                                                    //cell3.Border = 0;
                                                    //cell3.PaddingLeft = 0;
                                                    //cell3.PaddingRight = 0;
                                                    //cell3.PaddingTop = 0;
                                                    //cell3.PaddingBottom = 0;
                                                    //innertable.AddCell(cell3);
                                                    #endregion
                                                    phrase.Add(new Chunk(last, new iTextSharp.text.Font(iTextSharp.text.Font.FontFamily.TIMES_ROMAN, 05, iTextSharp.text.Font.BOLD)));
                                                }
                                                iTextSharp.text.pdf.PdfPCell cell2 = new iTextSharp.text.pdf.PdfPCell(phrase);
                                                cell2.HorizontalAlignment = iTextSharp.text.Element.ALIGN_CENTER;
                                                cell2.Border = 0;
                                                cell2.PaddingLeft = 0;
                                                cell2.PaddingRight = 0;
                                                cell2.PaddingTop = 0;
                                                cell2.PaddingBottom = 1;

                                                innertable.AddCell(cell2);

                                                page = writer.GetImportedPage(reader, i);
                                                //table.AddCell(iTextSharp.text.Image.GetInstance(page));
                                                iTextSharp.text.Image img = iTextSharp.text.Image.GetInstance(page);
                                                //iTextSharp.text.pdf.PdfPCell cell = new iTextSharp.text.pdf.PdfPCell();
                                                iTextSharp.text.pdf.PdfPCell cell = new iTextSharp.text.pdf.PdfPCell(img, true);
                                                //table.AddCell(new iTextSharp.text.pdf.PdfPCell(img,true));
                                                cell.Border = 0;
                                                innertable.AddCell(cell);
                                                table.AddCell(innertable);
                                            }
                                            #region APIGEOS-659 APIGEOS-618 not working as expected
                                            // shubham[skadam] APIGEOS-659  endpoint Accounting/Employees/Export https://helpdesk.emdep.com/browse/APIGEOS-462 APIGEOS-659 APIGEOS-618 not working as expected 12 11 2022
                                            else
                                            {
                                                tableCount = tableCount + 1;
                                            }
                                            #endregion
                                        }
                                        if ((reader.NumberOfPages - tableCount) % 2 != 0)
                                        {
                                            table.AddCell("");
                                        }
                                        document.Add(table);
                                        document.Close();
                                        #endregion

                                        #region Expense_Report_ReceiptsPDF_Header_Image
                                        string geos_app_settingsHeader_Image = string.Empty;
                                        using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                                        {
                                            conn.Open();
                                            MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                            command.CommandType = CommandType.StoredProcedure;
                                            command.Parameters.AddWithValue("_IdAppSetting", 78);
                                            using (MySqlDataReader dr = command.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    if (dr["DefaultValue"] != DBNull.Value)
                                                    {
                                                        geos_app_settingsHeader_Image = Convert.ToString(dr["DefaultValue"]);
                                                    }
                                                }
                                            }

                                        }

                                        List<string> Tempapp_Image_Settings = geos_app_settingsHeader_Image.Split(';').ToList();
                                        List<string> header_Image_Settings = new List<string>();
                                        int skipFirst = 0;
                                        foreach (var item in Tempapp_Image_Settings)
                                        {
                                            if (skipFirst == 0)
                                            {
                                                header_Image_Settings.Add(item);
                                            }
                                            else
                                            {
                                                header_Image_Settings.Add(Regex.Match(item, @"\d+").Value);
                                            }
                                            skipFirst = skipFirst + 1;
                                        }
                                        #endregion
                                        #region Expense_Report_ReceiptsPDF_Footer_DateTime
                                        string geos_app_settingsHeader_Footer_DateTime = string.Empty;
                                        using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                                        {
                                            conn.Open();
                                            MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                            command.CommandType = CommandType.StoredProcedure;
                                            command.Parameters.AddWithValue("_IdAppSetting", 80);
                                            using (MySqlDataReader dr = command.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    if (dr["DefaultValue"] != DBNull.Value)
                                                    {
                                                        geos_app_settingsHeader_Footer_DateTime = Convert.ToString(dr["DefaultValue"]);
                                                    }
                                                }
                                            }

                                        }

                                        List<string> Tempapp_Settings_Footer_DateTime = geos_app_settingsHeader_Footer_DateTime.Split(';').ToList();
                                        List<string> settings_Footer_DateTime = new List<string>();
                                        foreach (var item in Tempapp_Settings_Footer_DateTime)
                                        {
                                            settings_Footer_DateTime.Add(Regex.Match(item, @"\d+").Value);
                                        }
                                        #endregion
                                        #region Expense_Report_ReceiptsPDF_Footer_Email
                                        string geos_app_settings_Footer_Email = string.Empty;
                                        using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                                        {
                                            conn.Open();
                                            MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                            command.CommandType = CommandType.StoredProcedure;
                                            command.Parameters.AddWithValue("_IdAppSetting", 81);
                                            using (MySqlDataReader dr = command.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    if (dr["DefaultValue"] != DBNull.Value)
                                                    {
                                                        geos_app_settings_Footer_Email = Convert.ToString(dr["DefaultValue"]);
                                                    }
                                                }
                                            }

                                        }

                                        List<string> Tempapp_Settings_Footer_Email = geos_app_settings_Footer_Email.Split(';').ToList();
                                        List<string> settings_Footer_Email = new List<string>();
                                        int skipEmail = 0;
                                        foreach (var item in Tempapp_Settings_Footer_Email)
                                        {
                                            if (skipEmail == 0)
                                            {
                                                settings_Footer_Email.Add(item);
                                            }
                                            else
                                            {
                                                settings_Footer_Email.Add(Regex.Match(item, @"\d+").Value);
                                            }
                                            skipEmail = skipEmail + 1;
                                        }
                                        #endregion
                                        #region Expense_Report_ReceiptsPDF_Footer_pageNumber
                                        string geos_app_settingsHeader_Footer_pageNumber = string.Empty;
                                        using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                                        {
                                            conn.Open();
                                            MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                            command.CommandType = CommandType.StoredProcedure;
                                            command.Parameters.AddWithValue("_IdAppSetting", 82);
                                            using (MySqlDataReader dr = command.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    if (dr["DefaultValue"] != DBNull.Value)
                                                    {
                                                        geos_app_settingsHeader_Footer_pageNumber = Convert.ToString(dr["DefaultValue"]);
                                                    }
                                                }
                                            }

                                        }

                                        List<string> Tempapp_Settings_Footer_pageNumber = geos_app_settingsHeader_Footer_pageNumber.Split(';').ToList();
                                        List<string> settings_Footer_pageNumber = new List<string>();
                                        foreach (var item in Tempapp_Settings_Footer_pageNumber)
                                        {
                                            settings_Footer_pageNumber.Add(Regex.Match(item, @"\d+").Value);
                                        }
                                        #endregion
                                        #region Header&Footer                           
                                        var filePath = Path.Combine(updatedExcelFilePath, receiptsPDF);
                                        byte[] bytes = System.IO.File.ReadAllBytes(filePath);
                                        var pdfReader = new iTextSharp.text.pdf.PdfReader(bytes);
                                        using (Stream output = new FileStream(filePath, FileMode.Create, FileAccess.Write, FileShare.None))
                                        {
                                            using (iTextSharp.text.pdf.PdfStamper pdfStamper = new iTextSharp.text.pdf.PdfStamper(pdfReader, output))
                                            {
                                                for (int pageIndex = 1; pageIndex <= pdfReader.NumberOfPages; pageIndex++)
                                                {
                                                    pdfStamper.FormFlattening = false;
                                                    iTextSharp.text.Rectangle pageRectangle = pdfReader.GetPageSizeWithRotation(pageIndex);
                                                    iTextSharp.text.pdf.PdfContentByte pdfData = pdfStamper.GetOverContent(pageIndex);
                                                    pdfData.SetFontAndSize(iTextSharp.text.pdf.BaseFont.CreateFont(iTextSharp.text.pdf.BaseFont.TIMES_BOLD, iTextSharp.text.pdf.BaseFont.CP1252,
                                                    iTextSharp.text.pdf.BaseFont.NOT_EMBEDDED), 15);
                                                    iTextSharp.text.pdf.PdfGState graphicsState = new iTextSharp.text.pdf.PdfGState
                                                    {
                                                        FillOpacity = 10F
                                                    };
                                                    pdfData.SetGState(graphicsState);
                                                    //pdfData.BeginText();


                                                    // select the font properties
                                                    iTextSharp.text.pdf.BaseFont bf = iTextSharp.text.pdf.BaseFont.CreateFont(iTextSharp.text.pdf.BaseFont.TIMES_BOLD, iTextSharp.text.pdf.BaseFont.CP1252,
                                                    iTextSharp.text.pdf.BaseFont.NOT_EMBEDDED);
                                                    pdfData.SetColorFill(iTextSharp.text.BaseColor.BLACK);
                                                    iTextSharp.text.Font font = new iTextSharp.text.Font(bf, 15, iTextSharp.text.Font.BOLD);
                                                    pdfData.SetFontAndSize(bf, 10);

                                                    #region Header 
                                                    // write the text in the pdf content
                                                    //pdfData.BeginText();
                                                    //string Headertext = "Emdep";
                                                    //// put the alignment and coordinates here
                                                    //pdfData.ShowTextAligned(1, Headertext, 50, 825, 0);
                                                    //pdfData.EndText();
                                                    float x = (float)Convert.ToDouble(header_Image_Settings[1]);
                                                    float y = (float)Convert.ToDouble(header_Image_Settings[2]);
                                                    float w = (float)Convert.ToDouble(header_Image_Settings[3]);
                                                    float h = (float)Convert.ToDouble(header_Image_Settings[4]);

                                                    if (File.Exists(expensesExcelPath + "\\" + header_Image_Settings[0]))
                                                    {
                                                        iTextSharp.text.Image image = iTextSharp.text.Image.GetInstance(expensesExcelPath + "\\" + header_Image_Settings[0]);
                                                        image.ScaleAbsolute(w, h);
                                                        image.SetAbsolutePosition(x, y);
                                                        pdfData.AddImage(image);
                                                    }



                                                    pdfData.BeginText();
                                                    DateTime dt = DateTime.ParseExact(DateTime.Now.ToString("dd/MM/yyyy"), "dd/MM/yyyy", null);
                                                    dt.ToString(cultureInfo.DateTimeFormat.ShortDatePattern, cultureInfo);
                                                    String Headertext1 = DateTime.Now.ToString("dd/MM/yyyy HH:mm");
                                                    pdfData.ShowTextAligned(1, Headertext1, (float)Convert.ToDouble(settings_Footer_DateTime[0]), (float)Convert.ToDouble(settings_Footer_DateTime[1]), 0);
                                                    pdfData.EndText();
                                                    #endregion

                                                    #region Footer 
                                                    // write the text in the pdf content
                                                    pdfData.BeginText();
                                                    string Footertext = settings_Footer_Email[0];
                                                    // put the alignment and coordinates here
                                                    pdfData.ShowTextAligned(1, Footertext, (float)Convert.ToDouble(settings_Footer_Email[1]), (float)Convert.ToDouble(settings_Footer_Email[2]), 0);
                                                    pdfData.EndText();

                                                    pdfData.BeginText();
                                                    string pageNumber = pageIndex.ToString();
                                                    pdfData.ShowTextAligned(1, pageNumber, (float)Convert.ToDouble(settings_Footer_pageNumber[0]), (float)Convert.ToDouble(settings_Footer_pageNumber[1]), 0);
                                                    pdfData.EndText();


                                                    //pdfData.BeginText();
                                                    //string Footertext1 = "noreply@emdep.com";
                                                    //pdfData.ShowTextAligned(1, Footertext1, 500, 20, 0);
                                                    //pdfData.EndText();
                                                    #endregion
                                                }
                                            }
                                            output.Close();
                                            output.Dispose();
                                        }
                                        #endregion

                                    }
                                    #region APIGEOS-659 APIGEOS-618 not working as expected
                                    // shubham[skadam] APIGEOS-659  endpoint Accounting/Employees/Export https://helpdesk.emdep.com/browse/APIGEOS-462 APIGEOS-659 APIGEOS-618 not working as expected 12 11 2022
                                    //Added by [Plahange][GEOSAPI-618]For Merging files in EndPoint Accounting/Employees/ExpenseReports/Export
                                    //MergePdf = updatedExcelFilePath + filenamePDF;
                                    //MergeRec = updatedExcelFilePath + receiptsPDF;
                                    #endregion
                                }
                                else
                                {

                                }
                            }

                        }
                    }//files created for multiple culture
                }
            }
            catch (Exception ex)
            {
                workbook.Dispose();

                if (stream != null)
                {
                    stream.Dispose();
                }
                Log4NetLogger.Logger.Log(string.Format("Error ExportExpenses(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            return isDone;
        }
        //Created BY Rahul[rgadhave]for [APIGEOS-883][30/10/2023]
        public List<Currency_conversions> Getcurrency_conversionsForExpenses_V630(Int32 _IdCurrencyConversionFrom, string connstr)
        {
            List<Currency_conversions> currencyConversionsList = new List<Currency_conversions>();
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method Getcurrency_conversionsForExpenses()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_Getcurrency_conversionsForExpenses_V630", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_IdCurrencyConversionTo", _IdCurrencyConversionFrom);
                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            Currency_conversions currency = new Currency_conversions();
                            if (dr["IdCurrencyConversionFrom"] != DBNull.Value)
                            {
                                currency.IdCurrencyConversionFrom = Convert.ToInt32(dr["IdCurrencyConversionFrom"].ToString());
                            }
                            if (dr["IdCurrencyConversionTo"] != DBNull.Value)
                            {
                                currency.IdCurrencyConversionTo = Convert.ToInt32(dr["IdCurrencyConversionTo"].ToString());
                            }
                            if (dr["CurrencyConversionRate"] != DBNull.Value)
                            {
                                currency.CurrencyConversionRate = Convert.ToString(dr["CurrencyConversionRate"].ToString());
                            }
                            if (dr["LastMonthAVGRate"] != DBNull.Value)
                            {
                                currency.LastMonthAVGRate = Convert.ToString(dr["LastMonthAVGRate"].ToString());
                            }
                            currencyConversionsList.Add(currency);
                        }

                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method Getcurrency_conversionsForExpenses()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error Getcurrency_conversionsForExpenses(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return currencyConversionsList;
        }
        // Created By Rahul[rgadhave] for APIGEOS-959 Date:22/11/2023
        bool IsJDExist1(string email, string IdEmployeeExpenseReport, string jdCodesSetting)
        {

            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsJDExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsJDExist_V640", conn);
                    command.Parameters.AddWithValue("_mailIds", email);
                    command.Parameters.AddWithValue("_IdEmployeeExpenseReport", IdEmployeeExpenseReport);
                    command.Parameters.AddWithValue("_jdCodesSetting", jdCodesSetting);
                    command.CommandType = CommandType.StoredProcedure;
                    command.ExecuteNonQuery();
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsJDExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                return true;
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Method Exception()....IsJDExist()."), category: Category.Exception, priority: Priority.Low);
                return false;
            }
        }
        bool IsJDExist1(string email, string IdEmployeeExpenseReport, string jdCodesSetting, string ccEmail)
        {

            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsJDExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                {
                    conn.Open();
                    // MySqlCommand command = new MySqlCommand("GEOSAPI_IsJDExist_V640", conn);
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsJDExist_V820", conn);  //  Created By soumitra.kulkarni for [APIGEOS-1413]See in GHRM - Expenses Report - Who receive the report Submitted  Date:29/04/2025
                    command.Parameters.AddWithValue("_mailIds", email);
                    command.Parameters.AddWithValue("_IdEmployeeExpenseReport", IdEmployeeExpenseReport);
                    command.Parameters.AddWithValue("_jdCodesSetting", jdCodesSetting);
                    command.Parameters.AddWithValue("_ccMailIds", ccEmail);
                    command.CommandType = CommandType.StoredProcedure;
                    command.ExecuteNonQuery();
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsJDExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                return true;
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Method Exception()....IsJDExist()."), category: Category.Exception, priority: Priority.Low);
                return false;
            }
        }
        public List<Currency_conversions> Getcurrency_conversionsForExpenses(Int32 _IdCurrencyConversionFrom, string connstr)
        {
            List<Currency_conversions> currencyConversionsList = new List<Currency_conversions>();
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method Getcurrency_conversionsForExpenses()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_Getcurrency_conversionsForExpenses", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_IdCurrencyConversionFrom", _IdCurrencyConversionFrom);
                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            Currency_conversions currency = new Currency_conversions();
                            if (dr["IdCurrencyConversionFrom"] != DBNull.Value)
                            {
                                currency.IdCurrencyConversionFrom = Convert.ToInt32(dr["IdCurrencyConversionFrom"].ToString());
                            }
                            if (dr["IdCurrencyConversionTo"] != DBNull.Value)
                            {
                                currency.IdCurrencyConversionTo = Convert.ToInt32(dr["IdCurrencyConversionTo"].ToString());
                            }
                            if (dr["CurrencyConversionRate"] != DBNull.Value)
                            {
                                currency.CurrencyConversionRate = Convert.ToString(dr["CurrencyConversionRate"].ToString());
                            }
                            if (dr["LastMonthAVGRate"] != DBNull.Value)
                            {
                                currency.LastMonthAVGRate = Convert.ToString(dr["LastMonthAVGRate"].ToString());
                            }
                            currencyConversionsList.Add(currency);
                        }

                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method Getcurrency_conversionsForExpenses()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error Getcurrency_conversionsForExpenses(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return currencyConversionsList;
        }
        public string GetCurrency(string connstr)
        {
            string currencyName = string.Empty;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetCurrency()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetCurrencyForExpensesCurrency_conversions", conn);
                    command.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            if (dr["Name"] != DBNull.Value)
                            {
                                currencyName = Convert.ToString(dr["Name"].ToString());
                            }
                        }

                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetCurrency()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error GetCurrency(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return currencyName;
        }
        public byte[] GetOfferExportChart(string companyAlias, string offerExcelPath)
        {
            byte[] bytes = null;
            string defaultFileName = @"\ExpenseReport.xlsx";

            string companyFileName = string.Format("{0}{1}{2}{3}", @"\", companyAlias, "_", "ExpenseReport.xlsx");

            try
            {
                if (File.Exists(string.Format("{0}{1}", offerExcelPath, companyFileName)))
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(string.Format("{0}{1}", offerExcelPath, companyFileName), System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;

                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }
                }
                else if (File.Exists(string.Format("{0}{1}", offerExcelPath, defaultFileName)))
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(string.Format("{0}{1}", offerExcelPath, defaultFileName), System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;

                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }
                }


            }
            catch (FileNotFoundException ex)
            {

            }
            catch (DirectoryNotFoundException ex)
            {

            }
            catch (Exception ex)
            {

            }
            return bytes;
        }
        public List<Languages> Getlanguages(string connstr)
        {
            List<Languages> languagelst = new List<Languages>();
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method Getlanguages()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetLanguages", conn);
                    command.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            Languages Language = new Languages();
                            if (dr["IdLanguage"] != DBNull.Value)
                            {
                                Language.IdLanguage = Convert.ToInt32(dr["IdLanguage"].ToString());
                            }
                            if (dr["TwoLetterISOLanguage"] != DBNull.Value)
                            {
                                Language.TwoLetterISOLanguage = Convert.ToString(dr["TwoLetterISOLanguage"].ToString());
                            }
                            if (dr["Name"] != DBNull.Value)
                            {
                                Language.Name = Convert.ToString(dr["Name"].ToString());
                            }
                            if (dr["CultureName"] != DBNull.Value)
                            {
                                Language.CultureName = Convert.ToString(dr["CultureName"].ToString());
                            }
                            languagelst.Add(Language);
                        }

                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method Getlanguages()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error Getlanguages(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return languagelst;
        }
        public string GetCultureByPlantOwner(string _ShortName, string connstr)
        {
            string Culture = string.Empty;
            List<Languages> languagelst = new List<Languages>();
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetCultureByPlantOwner()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetCultureByPlantOwner", conn);
                    command.Parameters.AddWithValue("_ShortName", _ShortName);
                    command.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {

                            if (dr["Language"] != DBNull.Value)
                            {
                                Culture = Convert.ToString(dr["Language"].ToString());
                            }

                        }

                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetCultureByPlantOwner()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error Getlanguages(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return Culture;
        }

        public SendEmail SendExpense(SendMailExpenses sendMailExpense, string IdExpenseReport, string expensesFilePath, string mailServerName,
         string mailServerPort, string mailFrom, string Mailpassword, string MailUser, string Plantwiseconnectionstring)
        {
            SendEmail sendEmail = new SendEmail();
            ErrorMessage errormessage = new ErrorMessage();
            ErrorMessage warningmessage = new ErrorMessage();
            warningmessage = null;
            errormessage = null;
            string companyAlias = string.Empty;
            ExportExpenses exportExpenses = new ExportExpenses();
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method SendExpense()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                {
                    conn.Open();
                    //  MySqlCommand command = new MySqlCommand("GEOSAPI_GetSendExpense", conn);
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetSendExpense_V480", conn);// [pjadhav][GEOSAPI-550]
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_IdExpenseReport", IdExpenseReport);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["EmployeeCode"] != DBNull.Value)
                            {
                                exportExpenses._EmployeeCode = Convert.ToString(dr["EmployeeCode"]);
                            }
                            if (dr["IdEmployeeExpenseReport"] != DBNull.Value)
                            {
                                exportExpenses._IdEmployeeExpenseReport = Convert.ToString(dr["IdEmployeeExpenseReport"]).ToString();
                            }
                            if (dr["Code"] != DBNull.Value)
                            {
                                exportExpenses._ExpenseReportCode = Convert.ToString(dr["Code"]).ToString();
                            }
                            if (dr["FromDate"] != DBNull.Value)
                            {
                                exportExpenses._ExpensesFromDate = Convert.ToDateTime(dr["FromDate"]).ToString("dd-MM-yyyy");
                            }
                            if (dr["ToDate"] != DBNull.Value)
                            {
                                exportExpenses._ExpensesToDate = Convert.ToDateTime(dr["ToDate"]).ToString("dd-MM-yyyy");
                            }
                            if (dr["EmployeeCode"] != DBNull.Value)
                            {
                                exportExpenses._EmployeeCode = Convert.ToString(dr["EmployeeCode"]).ToString();
                            }
                            //if (dr["Alias"] != DBNull.Value)
                            //{
                            //    companyAlias = Convert.ToString(dr["Alias"]).ToString();
                            //}
                            if (dr["PlantAlias"] != DBNull.Value)
                            {
                                companyAlias = Convert.ToString(dr["PlantAlias"]).ToString();
                            }
                        }

                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method SendExpense()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error SendExpense(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;

            }
            try
            {
                string emailString = string.Empty;
                using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_IdAppSetting", 44);
                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["DefaultValue"] != DBNull.Value)
                            {
                                emailString = Convert.ToString(dr["DefaultValue"]);
                            }
                        }
                    }

                }
                List<string> SupportEmailList = new List<string>();
                foreach (var address in emailString.Split(new[] { ",", ";" }, StringSplitOptions.RemoveEmptyEntries))
                {
                    SupportEmailList.Add(address);
                }

                string containstr = "";
                List<string> MaxRevFileName = new List<string>();
                if (exportExpenses != null)
                {
                    string expensesFromDate = null;
                    string expensesToDate = null;
                    DateTime fromDate = Convert.ToDateTime(DateTime.Now);
                    DateTime toDate = Convert.ToDateTime(DateTime.Now);
                    if (!string.IsNullOrEmpty(exportExpenses._ExpensesFromDate))
                    {
                        fromDate = DateTime.ParseExact(exportExpenses._ExpensesFromDate, "dd-MM-yyyy", CultureInfo.InvariantCulture);
                        toDate = DateTime.ParseExact(exportExpenses._ExpensesToDate, "dd-MM-yyyy", CultureInfo.InvariantCulture);
                    }
                    expensesFromDate = string.Concat(fromDate.Year, fromDate.Month.ToString().PadLeft(2, '0'), fromDate.Day.ToString().PadLeft(2, '0'));
                    expensesToDate = string.Concat(toDate.Year, toDate.Month.ToString().PadLeft(2, '0'), toDate.Day.ToString().PadLeft(2, '0'));

                    string updatedExcelFilePath = expensesFilePath.Replace("{0}", companyAlias);

                    List<Int32> revNumber = new List<int>();
                    updatedExcelFilePath = updatedExcelFilePath + @"\" + exportExpenses._EmployeeCode + @"\" + exportExpenses._ExpenseReportCode + @"\";
                    if (!System.IO.Directory.Exists(updatedExcelFilePath))
                    {
                        System.IO.Directory.CreateDirectory(updatedExcelFilePath);
                    }
                    string search = exportExpenses._ExpenseReportCode + "_" + '*' + ".pdf";
                    FileInfo[] files = new DirectoryInfo(updatedExcelFilePath)
                    .GetFiles(search)
                    .ToArray();
                    var allfiles = files.ToList();

                    if (allfiles.Count() > 0)
                    {
                        #region getAllFiles
                        List<string> revPDFList = new List<string>();
                        foreach (var itemPDF in allfiles)
                        {
                            string substringitem = itemPDF.ToString().Split('\\').Last();
                            revPDFList.Add(substringitem);
                        }

                        if (revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault() == null)
                        {
                            containstr = exportExpenses._ExpenseReportCode + ".pdf";
                        }
                        else
                        {
                            List<string> maxNumberList = new List<string>();
                            foreach (var maxNumberitem in revPDFList)
                            {
                                int indexofrev = maxNumberitem.IndexOf("rev");
                                string substring = "00";
                                if (indexofrev == -1)
                                {
                                    substring = "00";
                                }
                                else
                                {
                                    substring = maxNumberitem.Substring(indexofrev + 3, 2);
                                }
                                maxNumberList.Add(substring);
                            }
                            string maxNumber = maxNumberList.Max();
                            if (maxNumber.Equals("00"))
                            {
                                string str = revPDFList.Where(w => w.Contains(exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate)).FirstOrDefault();
                                containstr = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + ".pdf";
                            }
                            else
                            {
                                string str = revPDFList.Where(w => w.Contains(exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + maxNumber)).FirstOrDefault();
                                containstr = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + maxNumber + ".pdf";

                            }
                            //[Sudhir.Jangra][APIGEOS-616][05/12/2022]
                            if (maxNumber != "00")
                            {
                                foreach (string latest in revPDFList)
                                {
                                    if (latest.Contains("rev" + maxNumber))
                                    {
                                        containstr = latest;
                                        var fileName = Directory.GetFiles(updatedExcelFilePath, "*" + containstr + "*.*", SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                                        if (!containstr.Contains("Receipts"))
                                        {
                                            MaxRevFileName.Add(fileName);
                                        }
                                    }

                                }
                            }
                            else
                            {
                                foreach (string latest1 in revPDFList)
                                {
                                    containstr = latest1;
                                    var fileName = Directory.GetFiles(updatedExcelFilePath, "*" + containstr + "*.*", SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                                    if (!containstr.Contains("Receipts"))
                                    {
                                        MaxRevFileName.Add(fileName);
                                    }
                                }
                            }
                        }
                        //[Sudhir.Jangra][APIGEOS-616][29/11/2022]

                        //for (int i = revPDFList.Count-1; i >= 0; i--)
                        //{
                        //     containstr = revPDFList[i];
                        //    var fileName = Directory.GetFiles(updatedExcelFilePath, "*" + containstr + "*.*", SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                        //    if (!containstr.Contains("Receipts"))
                        //    {
                        //         MaxRevFileName.Add(fileName);
                        //    }


                        //}
                        #endregion
                    }


                    #region ReceiptsFile
                    string containstr_Receipts = "";
                    string MaxRevFileName_Receipts = "";
                    string searchReceipts = exportExpenses._ExpenseReportCode + "_" + '*' + "_Receipts" + '*' + ".pdf";
                    FileInfo[] filesReceipts = new DirectoryInfo(updatedExcelFilePath)
                    .GetFiles(searchReceipts)
                    .ToArray();
                    var allfilesReceipts = filesReceipts.ToList();
                    if (allfilesReceipts.Count() > 0)
                    {
                        #region getAllFiles
                        List<string> revPDFList = new List<string>();
                        foreach (var itemPDF in allfilesReceipts)
                        {

                            string substringitem = itemPDF.ToString().Split('\\').Last();
                            revPDFList.Add(substringitem);
                        }

                        if (revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault() == null)
                        {
                            containstr = exportExpenses._ExpenseReportCode + "_Receipts.pdf";
                        }
                        else
                        {
                            List<string> maxNumberList = new List<string>();
                            foreach (var maxNumberitem in revPDFList)
                            {
                                int indexofrev = maxNumberitem.IndexOf("rev");
                                string substring = "00";
                                if (indexofrev == -1)
                                {
                                    substring = "00";
                                }
                                else
                                {
                                    substring = maxNumberitem.Substring(indexofrev + 3, 2);
                                }
                                maxNumberList.Add(substring);
                            }
                            string maxNumber = maxNumberList.Max();
                            if (maxNumber.Equals("00"))
                            {
                                string str = revPDFList.Where(w => w.Contains(exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_Receipts")).FirstOrDefault();
                                containstr_Receipts = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_Receipts" + ".pdf";

                            }
                            else
                            {
                                string str = revPDFList.Where(w => w.Contains(exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_Receipts_" + "rev" + maxNumber)).FirstOrDefault();
                                containstr_Receipts = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_Receipts_" + "rev" + maxNumber + ".pdf";

                            }

                        }
                        if (containstr_Receipts != null)
                            MaxRevFileName_Receipts = Directory.GetFiles(updatedExcelFilePath, "*" + containstr_Receipts + "*.*", SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                        if (MaxRevFileName_Receipts == null)
                        {
                            containstr_Receipts = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault();
                            if (containstr_Receipts != null)
                                MaxRevFileName_Receipts = Directory.GetFiles(updatedExcelFilePath, containstr_Receipts, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                        }
                        if (!File.Exists(MaxRevFileName_Receipts))
                        {
                            containstr_Receipts = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault().ToString().PadLeft(2, '0');
                            if (containstr_Receipts != null)
                                MaxRevFileName_Receipts = Directory.GetFiles(updatedExcelFilePath, containstr_Receipts, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                        }
                        #endregion
                    }
                    #endregion
                    Log4NetLogger.Logger.Log(string.Format("Method SendExpense()....containstr....END.... {0}", containstr), category: Category.Info, priority: Priority.Low);
                    Log4NetLogger.Logger.Log(string.Format("Method SendExpense()....MaxRevFileName....END.... {0}", MaxRevFileName), category: Category.Info, priority: Priority.Low);
                    string mailecos = string.IsNullOrEmpty(sendMailExpense.Source) ? "ECOS" : sendMailExpense.Source.ToUpper();
                    List<string> FailEmailList = new List<string>();
                    List<string> sendEmailList = new List<string>();
                    List<string> errorEmailList = new List<string>();
                    List<string> sendEmailTOList = new List<string>();
                    Regex regexEmail;
                    string allowEmailAddress = emailString;
                    allowEmailAddress = emailString.Replace('*', ' ');
                    string result = string.Concat(allowEmailAddress.Where(c => !char.IsWhiteSpace(c)));
                    string emailRegexString = result.Replace(';', '|');
                    if (emailString.Contains("*@*"))
                    {
                        regexEmail = new Regex(@"[A-Z0-9a-z._%+-]+@[A-Za-z0-9-]+\.[A-Za-z]{2,64}");
                    }
                    else
                    {
                        regexEmail = new Regex(@"\w+([-+.]\w+)*(" + emailRegexString + ")");
                    }
                    #region sendMailExpense.CC
                    if (!string.IsNullOrEmpty(sendMailExpense.CC))
                    {
                        string Emailcc = sendMailExpense.CC;
                        foreach (var address in Emailcc.Split(new[] { ",", ";" }, StringSplitOptions.RemoveEmptyEntries))
                        {
                            if (emailString.Equals(string.Empty))
                            {
                                bool checkcc = IsValidEmail(address);
                                if (checkcc == true)
                                    FailEmailList.Add(address);
                            }
                            else if (emailString != string.Empty)
                            {
                                Match match = regexEmail.Match(address);
                                if (match.Success == true)
                                {
                                    bool checkcc = IsValidEmail(address);
                                    if (checkcc == true)
                                    {
                                        sendEmailList.Add(address);
                                    }
                                }
                                else if (match.Success == false)
                                {
                                    bool checkcc = IsValidEmail(address);
                                    if (checkcc == true)
                                    {
                                        FailEmailList.Add(address);
                                    }
                                    else
                                    {
                                        errorEmailList.Add(address);
                                    }

                                }
                            }

                        }
                    }
                    #endregion
                    #region sendMailExpense.TO
                    if (!string.IsNullOrEmpty(sendMailExpense.TO))
                    {
                        string emailTo = sendMailExpense.TO;
                        foreach (var EmailTo in emailTo.Split(new[] { ",", ";" }, StringSplitOptions.RemoveEmptyEntries))
                        {
                            if (emailString.Equals(string.Empty))
                            {
                                bool checkcc = IsValidEmail(EmailTo);
                                if (checkcc == true)
                                    FailEmailList.Add(EmailTo);
                            }
                            else if (emailString != string.Empty)
                            {
                                Match match = regexEmail.Match(EmailTo);
                                if (match.Success == true)
                                {
                                    bool checkcc = IsValidEmail(EmailTo);
                                    if (checkcc == true)
                                    {
                                        sendEmailTOList.Add(EmailTo);
                                    }
                                }
                                else if (match.Success == false)
                                {
                                    bool checkcc = IsValidEmail(EmailTo);
                                    if (checkcc == true)
                                    {
                                        FailEmailList.Add(EmailTo);
                                    }
                                    else
                                    {
                                        errorEmailList.Add(EmailTo);
                                    }

                                }
                            }
                        }
                    }

                    #endregion
                    #region FailEmailList                 
                    if (FailEmailList != null)
                    {
                        if (FailEmailList.Count > 0)
                        {
                            string str = String.Join(",", FailEmailList);
                            if (warningmessage == null)
                            {
                                warningmessage = new ErrorMessage();
                            }
                            if (warningmessage != null)
                            {
                                warningmessage.code = "721";
                                if (warningmessage.info == null)
                                    warningmessage.info = "The following email are not supported to send : " + str;
                                else
                                    warningmessage.info = warningmessage.info + ",";
                            }
                        }
                    }
                    #endregion
                    #region errorEmailList                 
                    if (errorEmailList != null)
                    {
                        if (errorEmailList.Count > 0)
                        {
                            string errorstr = String.Join(",", errorEmailList);
                            if (errormessage == null)
                            {
                                errormessage = new ErrorMessage();
                            }
                            if (errormessage != null)
                            {
                                errormessage.code = "713";
                                if (errormessage.info == null)
                                    errormessage.info = "The following email (" + errorstr + ") are not correct format:";
                                else
                                    errormessage.info = errormessage.info + "," + errorstr;
                            }
                        }
                    }
                    #endregion
                    StringBuilder emailbodyStr = new StringBuilder();
                    emailbodyStr.Append(string.IsNullOrEmpty(sendMailExpense.Body) ? "" : sendMailExpense.Body.ToString());


                    AlternateView htmlView = AlternateView.CreateAlternateViewFromString(emailbodyStr.ToString(), null, "text/html");
                    List<System.Net.Mail.Attachment> item = null;
                    //[Sudhir.Jangra][APIGEOS-616][29/11/2022]
                    foreach (var fileName in MaxRevFileName)
                    {
                        if (File.Exists(fileName))
                        {
                            if (item == null)
                            {
                                item = new List<System.Net.Mail.Attachment>();
                            }
                            item.Add(new System.Net.Mail.Attachment(fileName));
                        }
                        else if (!File.Exists(fileName))
                        {
                            FailEmailList.Add("Attachment not found ");

                            if (FailEmailList != null)
                            {
                                if (FailEmailList.Count > 0)
                                {
                                    string str = String.Join(",", FailEmailList);
                                    if (warningmessage == null)
                                    {
                                        warningmessage = new ErrorMessage();
                                    }
                                    if (warningmessage != null)
                                    {
                                        warningmessage.code = "721";
                                        warningmessage.info = warningmessage.info + " Attachment not found ".ToString();
                                    }
                                }
                            }
                        }

                    }

                    if (File.Exists(MaxRevFileName_Receipts))
                    {
                        //Added By Rahul[rgadhave] for APIGEOS-911 Add a new setting to specify if generate the tickets report or not
                        string generateExpenseReceiptsReport = string.Empty;
                        using (MySqlConnection conn1 = new MySqlConnection(_ConnEmdepGeosString))
                        {
                            conn1.Open();
                            MySqlCommand command1 = new MySqlCommand("GEOSAPI_Getgeos_app_settingsByName_V620", conn1);
                            command1.CommandType = CommandType.StoredProcedure;
                            command1.Parameters.AddWithValue("_AppSettingName", "GenerateExpenseReceiptsReport");
                            using (MySqlDataReader dr = command1.ExecuteReader())
                            {
                                if (dr.Read())
                                {
                                    if (dr["DefaultValue"] != DBNull.Value)
                                    {
                                        generateExpenseReceiptsReport = Convert.ToString(dr["DefaultValue"]);
                                    }
                                }
                            }
                            conn1.Close();
                            if (generateExpenseReceiptsReport == "true")
                            {
                                if (item == null)
                                {
                                    item = new List<System.Net.Mail.Attachment>();
                                }
                                //item = new Attachment(MaxRevFileName_Receipts);
                                item.Add(new System.Net.Mail.Attachment(MaxRevFileName_Receipts));
                            }
                        }
                    }
                    else if (!File.Exists(MaxRevFileName_Receipts))
                    {
                        FailEmailList.Add("Receipts Attachment not found ");

                        if (FailEmailList != null)
                        {
                            if (FailEmailList.Count > 0)
                            {
                                string str = String.Join(",", FailEmailList);
                                if (warningmessage == null)
                                {
                                    warningmessage = new ErrorMessage();
                                }
                                if (warningmessage != null)
                                {
                                    warningmessage.code = "721";
                                    warningmessage.info = warningmessage.info + "Receipts Attachment not found ".ToString();
                                }
                            }
                        }
                    }

                    string MailCredentials = string.Empty;
                    if (!string.IsNullOrEmpty(Mailpassword))
                    {
                        var base64EncodedBytes = Convert.FromBase64String(Mailpassword);
                        MailCredentials = Encoding.UTF8.GetString(base64EncodedBytes);
                    }
                    string sendEmailToString = String.Join(", ", sendEmailTOList);
                    if (string.IsNullOrEmpty(sendEmailToString))
                    {
                        if (errormessage != null)
                        {
                            sendEmail.error = errormessage;
                        }
                        if (warningmessage != null)
                        {
                            sendEmail.warning = warningmessage;
                        }
                        return sendEmail;
                    }
                    MailAddress emailFrom = new MailAddress(mailFrom, mailecos);
                    MailAddress emailTO = new MailAddress(sendEmailToString, sendEmailToString);
                    List<string> templist = sendEmailToString.Split(',').ToList();
                    using (MailMessage mail = new MailMessage())
                    {
                        mail.From = emailFrom;
                        foreach (var emailTOList in templist)
                        {
                            mail.To.Add(emailTOList);
                        }
                        foreach (var SendEmail in sendEmailList)
                        {
                            mail.CC.Add(SendEmail);
                        }
                        if (item != null)
                            foreach (var fileItem in item)
                            {
                                mail.Attachments.Add(fileItem);
                            }
                        //if (File.Exists(MaxRevFileName) && item != null)
                        //{
                        //    mail.Attachments.Add(item);
                        //    Log4NetLogger.Logger.Log(string.Format("Method SendExpense()....Attachments....END.... {0}", item.Name), category: Category.Info, priority: Priority.Low);
                        //}
                        mail.AlternateViews.Add(htmlView);
                        // Created By [Soumitra.kulkarni] for APIGEOS-1326 Date:16/01/2025
                        mail.Subject = $"{sendMailExpense.Subject} - {exportExpenses._ExpenseReportCode}";
                        mail.Body = sendMailExpense.Body;
                        mail.IsBodyHtml = true;
                        mail.IsBodyHtml = sendMailExpense.IsHtmlBody;
                        using (SmtpClient smtp = new SmtpClient(mailServerName, Convert.ToInt32(mailServerPort)))
                        {
                            smtp.UseDefaultCredentials = false;
                            smtp.Credentials = new NetworkCredential(MailUser, MailCredentials);
                            smtp.EnableSsl = false;
                            try
                            {
                                Log4NetLogger.Logger.Log(string.Format("Method before()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                                smtp.Send(mail);
                                //Created by shubham[skadam] for APIGEOS-504 [EXPENSE_REPORT_STATUS] Modify the service GET ExpenseReport->Send to set the workflow status of an Expense Report at the same time 01 JUN 2022
                                //IsJDExist(sendEmailToString, IdExpenseReport);
                                //  Created By Rahul[rgadhave] for APIGEOS-959 Date:22/11/2023

                                //  Created By soumitra.kulkarni for [APIGEOS-1413]See in GHRM - Expenses Report - Who receive the report Submitted  Date:29/04/2025
                                string emailCcString = string.Join(", ", sendEmailList);
                                using (MySqlConnection conn1 = new MySqlConnection(_ConnEmdepGeosString))
                                {
                                    conn1.Open();
                                    MySqlCommand command1 = new MySqlCommand("GEOSAPI_Getgeos_app_settingDefaultvalues_V640", conn1);
                                    command1.CommandType = CommandType.StoredProcedure;
                                    using (MySqlDataReader reader = command1.ExecuteReader())
                                    {
                                        if (reader.Read())
                                        {
                                            string defaultValue = reader["DefaultValue"].ToString();
                                            List<string> settingList = defaultValue.Split(',').ToList();

                                            foreach (var setting in settingList)
                                            {
                                                if (IsJDExist1(sendEmailToString, IdExpenseReport, setting, emailCcString))
                                                {
                                                    break;
                                                }
                                                else
                                                {

                                                }
                                            }
                                        }
                                    }
                                    conn1.Close();
                                }

                                Log4NetLogger.Logger.Log(string.Format("Method SendExpense call successfully()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                            }

                            catch (SmtpFailedRecipientsException ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Method SmtpFailedRecipientsException()....Executed successfully."), category: Category.Exception, priority: Priority.Low);
                                if (errormessage == null)
                                {
                                    errormessage = new ErrorMessage();
                                }
                                if (errormessage != null)
                                {
                                    errormessage.code = "713";
                                    if (errormessage.info == null)
                                        errormessage.info = ex.Message.ToString();
                                    else
                                        errormessage.info = errormessage.info + "," + ex.Message.ToString();
                                }
                            }
                            catch (SmtpFailedRecipientException ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Method SmtpFailedRecipientException()....Executed successfully."), category: Category.Exception, priority: Priority.Low);
                                if (errormessage == null)
                                {
                                    errormessage = new ErrorMessage();
                                }
                                if (errormessage != null)
                                {
                                    errormessage.code = "713";
                                    if (errormessage.info == null)
                                        errormessage.info = ex.Message.ToString();
                                    else
                                        errormessage.info = errormessage.info + "," + ex.Message.ToString();
                                }
                            }
                            catch (SmtpException ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Method SmtpException()....Executed successfully."), category: Category.Exception, priority: Priority.Low);
                                if (errormessage == null)
                                {
                                    errormessage = new ErrorMessage();
                                }
                                if (errormessage != null)
                                {
                                    errormessage.code = "713";
                                    if (errormessage.info == null)
                                        errormessage.info = ex.Message.ToString();
                                    else
                                        errormessage.info = errormessage.info + "," + ex.Message.ToString();
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Method Exception()....Executed successfully."), category: Category.Exception, priority: Priority.Low);
                                if (errormessage == null)
                                {
                                    errormessage = new ErrorMessage();
                                }
                                if (errormessage != null)
                                {
                                    errormessage.code = "713";
                                    if (errormessage.info == null)
                                        errormessage.info = ex.Message.ToString();
                                    else
                                        errormessage.info = errormessage.info + "," + ex.Message.ToString();
                                }
                            }

                        }
                    }


                }
            }
            catch (Exception ex)
            {
                throw ex;
            }

            if (errormessage != null)
            {
                Log4NetLogger.Logger.Log(string.Format("Method error message call successfully()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                sendEmail.error = errormessage;
            }
            if (warningmessage != null)
            {
                Log4NetLogger.Logger.Log(string.Format("Method warning message call successfully()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                sendEmail.warning = warningmessage;
            }
            Log4NetLogger.Logger.Log(string.Format("Method  return sendEmail successfully()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            return sendEmail;

        }
        //Created by shubham[skadam] for APIGEOS-504 [EXPENSE_REPORT_STATUS] Modify the service GET ExpenseReport->Send to set the workflow status of an Expense Report at the same time 01 JUN 2022
        bool IsJDExist(string email, string IdEmployeeExpenseReport)
        {
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsJDExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsJDExist", conn);
                    command.Parameters.AddWithValue("_mailIds", email);
                    command.Parameters.AddWithValue("_IdEmployeeExpenseReport", IdEmployeeExpenseReport);
                    command.CommandType = CommandType.StoredProcedure;
                    command.ExecuteNonQuery();
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsJDExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
                return true;
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Method Exception()....IsJDExist()."), category: Category.Exception, priority: Priority.Low);
                return false;
            }
        }
        bool IsValidEmail(string email)
        {
            try
            {
                var addr = new System.Net.Mail.MailAddress(email);
                return true;
            }
            catch (Exception ex)
            {
                return false;
            }
        }

        public bool ExpenseReportsSign(CreateExpenseReportsSign createExpenseReportsSign, string mainserverConnectionString, string LoginContext, string IdExpenseReport, string expensesFilePath, string Signatory)
        {
            bool result = false;
            string companyAlias = string.Empty;
            //string parentAlias = string.Empty;
            Int64 IdEmployeeExpenseReport = Convert.ToInt64(IdExpenseReport);
            ExportExpenses exportExpenses = new ExportExpenses();
            try
            {
                using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                {
                    conn.Open();
                    // MySqlCommand command = new MySqlCommand("GEOSAPI_GetExpenseExport_V390", conn);
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GetExpenseExport_V480", conn); // [pjadhav][GEOSAPI-550]
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_IdExpenseReport", IdExpenseReport);
                    command.Parameters.AddWithValue("_Lang", "en");
                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            #region Get data from MySql
                            if (dr["IdEmployeeExpenseReport"] != DBNull.Value)
                            {
                                exportExpenses._IdEmployeeExpenseReport = Convert.ToString(dr["IdEmployeeExpenseReport"]).ToString();
                            }
                            if (dr["ReportCode"] != DBNull.Value)
                            {
                                exportExpenses._ExpenseReportCode = Convert.ToString(dr["ReportCode"]).ToString();
                            }
                            if (dr["CreationDate"] != DBNull.Value)
                            {
                                exportExpenses._ReportDate = Convert.ToDateTime(dr["CreationDate"]).ToString("dd-MM-yyyy");
                            }
                            if (dr["FromDate"] != DBNull.Value)
                            {
                                exportExpenses._ExpensesFromDate = Convert.ToDateTime(dr["FromDate"]).ToString("dd-MM-yyyy");
                            }
                            if (dr["ToDate"] != DBNull.Value)
                            {
                                exportExpenses._ExpensesToDate = Convert.ToDateTime(dr["ToDate"]).ToString("dd-MM-yyyy");
                            }
                            if (dr["EmployeeName"] != DBNull.Value)
                            {
                                exportExpenses._EmployeeName = Convert.ToString(dr["EmployeeName"]).ToString();
                            }
                            if (dr["DepartmentName"] != DBNull.Value)
                            {
                                exportExpenses._EmployeeDepartment = Convert.ToString(dr["DepartmentName"]).ToString();
                            }
                            if (dr["EmployeeCode"] != DBNull.Value)
                            {
                                exportExpenses._EmployeeCode = Convert.ToString(dr["EmployeeCode"]).ToString();
                            }

                            //if (dr["Alias"] != DBNull.Value)
                            //{
                            //    companyAlias = Convert.ToString(dr["Alias"]).ToString();
                            //}


                            if (dr["PlantAlias"] != DBNull.Value)
                            {
                                companyAlias = Convert.ToString(dr["PlantAlias"]).ToString();
                            }

                            #endregion
                        }
                    }
                }
                if (companyAlias != string.Empty)
                {
                    //if (parentAlias != string.Empty)
                    //{
                    string receiptsPDF = null;
                    //string updatedExcelFilePath = expensesFilePath.Replace("{0}", companyAlias);

                    string containstr = "";
                    string MaxRevFileName = "";
                    string expensesFromDate = null;
                    string expensesToDate = null;
                    DateTime fromDate = Convert.ToDateTime(DateTime.Now);
                    DateTime toDate = Convert.ToDateTime(DateTime.Now);
                    if (!string.IsNullOrEmpty(exportExpenses._ExpensesFromDate))
                    {
                        fromDate = DateTime.ParseExact(exportExpenses._ExpensesFromDate, "dd-MM-yyyy", CultureInfo.InvariantCulture);
                        toDate = DateTime.ParseExact(exportExpenses._ExpensesToDate, "dd-MM-yyyy", CultureInfo.InvariantCulture);
                    }


                    expensesFromDate = string.Concat(fromDate.Year, fromDate.Month.ToString().PadLeft(2, '0'), fromDate.Day.ToString().PadLeft(2, '0'));
                    expensesToDate = string.Concat(toDate.Year, toDate.Month.ToString().PadLeft(2, '0'), toDate.Day.ToString().PadLeft(2, '0'));
                    string updatedExcelFilePath = expensesFilePath.Replace("{0}", companyAlias);
                    //string updatedExcelFilePath = expensesFilePath.Replace("{0}", parentAlias);
                    updatedExcelFilePath = updatedExcelFilePath + @"\" + exportExpenses._EmployeeCode + @"\" + exportExpenses._ExpenseReportCode + @"\";
                    if (!System.IO.Directory.Exists(updatedExcelFilePath))
                    {
                        System.IO.Directory.CreateDirectory(updatedExcelFilePath);
                    }
                    #region ReceiptsFile
                    string search = exportExpenses._ExpenseReportCode + "_" + '*' + ".pdf";
                    FileInfo[] files = new DirectoryInfo(updatedExcelFilePath)
                    .GetFiles(search)
                    .ToArray();
                    List<string> finalpdflist = new List<string>();//[plahange][30-11-22][APIGEOS-615]
                    var allfiles = files.ToList();

                    if (allfiles.Count() > 0)
                    {
                        allfiles.RemoveAll(r => r.Name.Contains("Receipts"));
                        #region getAllFiles
                        List<string> revPDFList = new List<string>();
                        foreach (var itemPDF in allfiles)
                        {
                            string substringitem = itemPDF.ToString().Split('\\').Last();
                            revPDFList.Add(substringitem);
                        }

                        if (revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault() == null)
                        {
                            containstr = exportExpenses._ExpenseReportCode + ".pdf";
                        }
                        else
                        {
                            List<string> maxNumberList = new List<string>();
                            foreach (var maxNumberitem in revPDFList)
                            {
                                int indexofrev = maxNumberitem.IndexOf("rev");
                                string substring = "00";
                                if (indexofrev == -1)
                                {
                                    substring = "00";
                                }
                                else
                                {
                                    substring = maxNumberitem.Substring(indexofrev + 3, 2);
                                }
                                maxNumberList.Add(substring);
                            }
                            string maxNumber = maxNumberList.Max();
                            //code for sign on multiple pdf at a time [plahange][30-11-22][APIGEOS-615]
                            if (maxNumber != "00")
                            {
                                foreach (string mno in revPDFList)
                                {
                                    if (mno.Contains("rev" + maxNumber))
                                    {
                                        finalpdflist.Add(mno);
                                    }
                                }
                            }
                            else
                            {
                                foreach (string mno in revPDFList)
                                {
                                    finalpdflist.Add(mno);
                                }
                            }
                            // previous code for single pdf sign
                            // string str = revPDFList.Where(w => w.Contains(exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + maxNumber)).FirstOrDefault();
                            // containstr = exportExpenses._ExpenseReportCode + "_" + exportExpenses._EmployeeCode + "_" + expensesFromDate + "_" + expensesToDate + "_" + "rev" + maxNumber + ".pdf";
                        }
                        foreach (var pdfitem in finalpdflist) //code for sign on multiple pdf at a time [plahange][30-11-22][APIGEOS-615]
                        {
                            MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, "*" + pdfitem + "*.*", SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                            if (MaxRevFileName == null)
                            {
                                MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, pdfitem, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                            }
                            if (!File.Exists(MaxRevFileName))
                            {
                                MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, pdfitem, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                            }
                            // previous code for single pdf sign
                            //if (containstr != null)
                            //    MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, "*" + containstr + "*.*", SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                            //if (MaxRevFileName == null)
                            //{
                            //    containstr = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault();
                            //    if (containstr != null)
                            //        MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, containstr, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                            //}
                            //if (!File.Exists(MaxRevFileName))
                            //{
                            //    containstr = revPDFList.ToList().OrderByDescending(r => r).ToList().FirstOrDefault().ToString().PadLeft(2, '0');
                            //    if (containstr != null)
                            //        MaxRevFileName = Directory.GetFiles(updatedExcelFilePath, containstr, SearchOption.AllDirectories).Where(fi => fi.Contains(".pdf")).FirstOrDefault();
                            //}
                            #endregion
                            // }
                            #endregion

                    #region Signature_Box_geos_app_settings
                            string geos_app_settings = string.Empty;
                            using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                            {
                                conn.Open();
                                MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                command.CommandType = CommandType.StoredProcedure;
                                if (Signatory.Trim().ToUpper().Equals("Employee".Trim().ToUpper()))
                                {
                                    command.Parameters.AddWithValue("_IdAppSetting", 69);
                                }
                                else if (Signatory.Trim().ToUpper().Equals("PM".Trim().ToUpper()))
                                {
                                    command.Parameters.AddWithValue("_IdAppSetting", 70);
                                }
                                if (Signatory.Trim().ToUpper().Equals("Accounting".Trim().ToUpper()))
                                {
                                    command.Parameters.AddWithValue("_IdAppSetting", 71);
                                }

                                using (MySqlDataReader dr = command.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        if (dr["DefaultValue"] != DBNull.Value)
                                        {
                                            geos_app_settings = Convert.ToString(dr["DefaultValue"]);
                                        }
                                    }
                                }

                            }

                            List<string> app_settings = geos_app_settings.Split(';').ToList();
                            List<string> settings = new List<string>();
                            foreach (var item in app_settings)
                            {
                                settings.Add(Regex.Match(item, @"\d+").Value);
                            }
                            #endregion

                    #region FullName_geos_app_settings
                            string geos_app_settingsFullName = string.Empty;
                            using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                            {
                                conn.Open();
                                MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                command.CommandType = CommandType.StoredProcedure;
                                if (Signatory.Trim().ToUpper().Equals("Employee".Trim().ToUpper()))
                                {
                                    command.Parameters.AddWithValue("_IdAppSetting", 72);
                                }
                                else if (Signatory.Trim().ToUpper().Equals("PM".Trim().ToUpper()))
                                {
                                    command.Parameters.AddWithValue("_IdAppSetting", 73);
                                }
                                if (Signatory.Trim().ToUpper().Equals("Accounting".Trim().ToUpper()))
                                {
                                    command.Parameters.AddWithValue("_IdAppSetting", 74);
                                }

                                using (MySqlDataReader dr = command.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        if (dr["DefaultValue"] != DBNull.Value)
                                        {
                                            geos_app_settingsFullName = Convert.ToString(dr["DefaultValue"]);
                                        }
                                    }
                                }

                            }

                            List<string> Tempapp_settings = geos_app_settingsFullName.Split(';').ToList();
                            List<string> FullNamesettings = new List<string>();
                            foreach (var item in Tempapp_settings)
                            {
                                FullNamesettings.Add(Regex.Match(item, @"\d+").Value);
                            }
                            #endregion
                    #region geos_app_settingsDateTime
                            string geos_app_settingsDateTime = string.Empty;
                            using (MySqlConnection conn = new MySqlConnection(_ConnEmdepGeosString))
                            {
                                conn.Open();
                                MySqlCommand command = new MySqlCommand("GEOSAPI_Getgeos_app_settingsById", conn);
                                command.CommandType = CommandType.StoredProcedure;
                                if (Signatory.Trim().ToUpper().Equals("Employee".Trim().ToUpper()))
                                {
                                    command.Parameters.AddWithValue("_IdAppSetting", 75);
                                }
                                else if (Signatory.Trim().ToUpper().Equals("PM".Trim().ToUpper()))
                                {
                                    command.Parameters.AddWithValue("_IdAppSetting", 76);
                                }
                                if (Signatory.Trim().ToUpper().Equals("Accounting".Trim().ToUpper()))
                                {
                                    command.Parameters.AddWithValue("_IdAppSetting", 77);
                                }

                                using (MySqlDataReader dr = command.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        if (dr["DefaultValue"] != DBNull.Value)
                                        {
                                            geos_app_settingsDateTime = Convert.ToString(dr["DefaultValue"]);
                                        }
                                    }
                                }

                            }

                            List<string> dateTimeapp_settings = geos_app_settingsDateTime.Split(';').ToList();
                            List<string> DateTimesettings = new List<string>();
                            foreach (var item in dateTimeapp_settings)
                            {
                                DateTimesettings.Add(Regex.Match(item, @"\d+").Value);
                            }

                            #endregion
                    #region Header&Footer   
                            var filePath = Path.Combine(updatedExcelFilePath, pdfitem);//code for sign on multiple pdf at a time [plahange][30-11-22][APIGEOS-615]
                                                                                       // var filePath = Path.Combine(updatedExcelFilePath, containstr);
                            byte[] bytes = System.IO.File.ReadAllBytes(filePath);
                            var pdfReader = new iTextSharp.text.pdf.PdfReader(bytes);
                            using (Stream output = new FileStream(filePath, FileMode.Create, FileAccess.Write, FileShare.None))
                            {
                                using (iTextSharp.text.pdf.PdfStamper pdfStamper = new iTextSharp.text.pdf.PdfStamper(pdfReader, output))
                                {
                                    //for (int pageIndex = 1; pageIndex <= pdfReader.NumberOfPages; pageIndex++)
                                    for (int pageIndex = 1; pageIndex <= 1; pageIndex++)
                                    {
                                        pdfStamper.FormFlattening = false;
                                        iTextSharp.text.Rectangle pageRectangle = pdfReader.GetPageSizeWithRotation(pageIndex);
                                        iTextSharp.text.pdf.PdfContentByte pdfData = pdfStamper.GetOverContent(pageIndex);

                                        //string fontName = "Calibri Light";
                                        //if (!iTextSharp.text.FontFactory.IsRegistered(fontName))
                                        //{
                                        //    var fontPath = System.Web.Hosting.HostingEnvironment.MapPath("\\") + "fonts\\calibri.ttf";
                                        //    iTextSharp.text.FontFactory.Register(fontPath, fontName);
                                        //}

                                        //iTextSharp.text.pdf.BaseFont baseFont=iTextSharp.text.pdf.BaseFont.CreateFont(System.Web.Hosting.HostingEnvironment.MapPath("\\") + "fonts\\calibri.ttf", iTextSharp.text.pdf.BaseFont.CP1252, iTextSharp.text.pdf.BaseFont.EMBEDDED);

                                        //pdfData.SetFontAndSize(iTextSharp.text.pdf.BaseFont.CreateFont(System.Web.Hosting.HostingEnvironment.MapPath("\\") + "fonts\\calibri.ttf", iTextSharp.text.pdf.BaseFont.CP1252,
                                        //iTextSharp.text.pdf.BaseFont.NOT_EMBEDDED), 15);
                                        pdfData.SetFontAndSize(iTextSharp.text.pdf.BaseFont.CreateFont(iTextSharp.text.pdf.BaseFont.TIMES_BOLD, iTextSharp.text.pdf.BaseFont.CP1252,
                                        iTextSharp.text.pdf.BaseFont.NOT_EMBEDDED), 15);
                                        iTextSharp.text.pdf.PdfGState graphicsState = new iTextSharp.text.pdf.PdfGState
                                        {
                                            FillOpacity = 10F
                                        };
                                        pdfData.SetGState(graphicsState);
                                        //iTextSharp.text.pdf.BaseFont bf = iTextSharp.text.pdf.BaseFont.CreateFont(System.Web.Hosting.HostingEnvironment.MapPath("\\") + "fonts\\calibri.ttf", iTextSharp.text.pdf.BaseFont.CP1252,
                                        //iTextSharp.text.pdf.BaseFont.NOT_EMBEDDED);
                                        iTextSharp.text.pdf.BaseFont bf = iTextSharp.text.pdf.BaseFont.CreateFont(iTextSharp.text.pdf.BaseFont.TIMES_BOLD, iTextSharp.text.pdf.BaseFont.CP1252,
                                        iTextSharp.text.pdf.BaseFont.NOT_EMBEDDED);
                                        pdfData.SetColorFill(iTextSharp.text.BaseColor.BLACK);
                                        iTextSharp.text.Font font = new iTextSharp.text.Font(bf, 15, iTextSharp.text.Font.BOLD);
                                        pdfData.SetFontAndSize(bf, 10);


                                        #region Footer 
                                        pdfData.BeginText();
                                        float w = (float)Convert.ToDouble(settings[2]);
                                        float h = (float)Convert.ToDouble(settings[3]);
                                        float x = (float)Convert.ToDouble(settings[0]);
                                        float y = (float)Convert.ToDouble(settings[1]);

                                        float xFullName = (float)Convert.ToDouble(FullNamesettings[0]);
                                        float yFullName = (float)Convert.ToDouble(FullNamesettings[1]);
                                        float xDateTime = (float)Convert.ToDouble(DateTimesettings[0]);
                                        float yDateTime = (float)Convert.ToDouble(DateTimesettings[1]);

                                        string pageNumber = 1.ToString();
                                        //pdfData.ShowTextAligned(1, createExpenseReportsSign.FullName, x + 50, y + 85, 0);
                                        //pdfData.ShowTextAligned(1, createExpenseReportsSign.DateTime, x + 50 , y -10, 0);
                                        pdfData.ShowTextAligned(1, createExpenseReportsSign.FullName, xFullName, yFullName, 0);
                                        pdfData.ShowTextAligned(1, createExpenseReportsSign.DateTime, xDateTime, yDateTime, 0);
                                        pdfData.EndText();

                                        #region Add Signature Image 
                                        string base64encodedstring = createExpenseReportsSign.Signature;
                                        var base64bytes = Convert.FromBase64String(base64encodedstring);
                                        iTextSharp.text.Image image = iTextSharp.text.Image.GetInstance(base64bytes);
                                        image.ScaleAbsolute(w, h);
                                        image.SetAbsolutePosition(x, y);
                                        pdfData.AddImage(image);
                                        #endregion
                                        #endregion
                                    }
                                }
                                output.Close();
                                output.Dispose();
                            }
                        }//multi pdf sign
                    }
                    #endregion
                    result = true;
                }


            }
            catch (Exception ex)
            {
                result = false;
                Log4NetLogger.Logger.Log(string.Format("Error UpdateExpenseReports(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            return result;
        }


    }
    #region [pallavi.jadhav][03 09 2025][APIGEOS-1628]
    public class ProductionManager
    {
        public static List<ERM_CADCAMTimePerDesignType> CADCAMDesignTypeListByPlant;
        public TimetrackingAPI timeTracking;
        string _ConnString;
        string _ConnEmdepGeosString;
        private string username;
        static string loginUsername;
        static string Remarks;
        public string WorkflowStatusFrom;
        public string WorkflowStatusTo;
        public static string login;
        public List<ERM_CADCAMTimePerDesignType> CADCAMDesignTypeList;
        public ProductionManager(string ConnString, string ConnEmdepGeosString)
        {
            if (Log4NetLogger.Logger == null)
            {
                string ApplicationLogFilePath = System.Web.Hosting.HostingEnvironment.MapPath("/") + "log4net.config";
                FileInfo file = new FileInfo(ApplicationLogFilePath);
                Log4NetLogger.Logger = LoggerFactory.CreateLogger(LogType.Log4Net, file);
            }
            this._ConnString = ConnString;
            this._ConnEmdepGeosString = ConnEmdepGeosString;
        }

        public TimeTrackingResult GetPlantwiseTimetracking(string Plant, string FromDeliveryDate, string ToDeliveryDate, string Stage, string Currency, string connstr, string Plantwiseconnectionstring)
        {
            List<TimetrackingAPI> timeTrackingList = new List<TimetrackingAPI>();
            TimeTrackingResult TimeTrackingResult = new TimeTrackingResult();


            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetAccountingInvoicesList()...."), category: Category.Info, priority: Priority.Low);
                if (CommonManager.DictonarySitesGDB02 == null || CommonManager.DictonarySitesGDB02.Count == 0)
                {
                    CommonManager.ConnString = this._ConnString;
                    //   CommonManager.DictonaryPlant = new Dictionary<string, string>();
                    CommonManager.DictonarySites = CommonManager.GetAllSites();
                    CommonManager.DictonarySitesGDB02 = CommonManager.GetAllSitesGDB02();
                    //CommonManager.DictonaryPlant = CommonManager.GetAllPlant(Plant);  //[Pallavi Jadhav][APIGEOS-728][02 03 2023]
                }
                var errors = new List<string>();
                List<KeyValuePair<string, string>> plantList;
                CommonManager.DictonarySites.Where(a => a.Key != "EBID" && a.Key != "ETHQ" && a.Key != "EWCN").ToList();
                if (Plant == "0")
                    plantList = CommonManager.DictonarySites.Where(a => a.Key != "EBID" && a.Key != "ETHQ" && a.Key != "EWCN").ToList();
                else
                {
                    //selectedPlants.Except(CommonManager.DictonarySites.Select(a => a.Key == "EBID" && a.Key == "ETHQ" && a.Key == "EWCN").ToList());
                    string[] selectedPlants = Plant.Split(',');
                    plantList = CommonManager.DictonarySites
                        .Where(p => selectedPlants.Contains(p.Key))
                        .ToList();
                }
                List<WorkStage> AllProductioStage = new List<WorkStage>();
                List<SiteByShippingAddressAPI> SitesByShippingAddressList = new List<SiteByShippingAddressAPI>();
                List<TimeTrackingProductionStageAPI> TimeTrackingProductionStage = new List<TimeTrackingProductionStageAPI>();
                StageByOTItemAndIDDrawingAPI TimetrackingStagesList = new StageByOTItemAndIDDrawingAPI();
                List<KeyValuePair<string, string>> plantListActive = new List<KeyValuePair<string, string>>();
                bool IsActivePlant = new bool();
                foreach (var plant in plantList)
                {
                    try
                    {
                        string connstrs = string.Format(Plantwiseconnectionstring, CommonManager.DictonarySitesGDB02[plant.Key].FirstOrDefault().Key);
                        IsActivePlant = IsActiveERMPlant(connstrs);
                        if (IsActivePlant == true)
                        {
                            plantListActive.Add(plant);
                        }
                        else
                        {
                        }
                    }
                    catch (Exception ex)
                    {
                    }
                }
                var failedPlants = new ConcurrentBag<string>();
                foreach (var plant in plantListActive)
                {
                    try
                    {
                        string connstrs = string.Format(Plantwiseconnectionstring, CommonManager.DictonarySitesGDB02[plant.Key].FirstOrDefault().Key);
                        timeTrackingList.AddRange(GetTimetracking(
                                    Plant, FromDeliveryDate.ToString(), ToDeliveryDate.ToString(),
                                    Stage, Currency,
                                    plant.Value, plant.Key,
                                    connstrs, SitesByShippingAddressList, TimeTrackingProductionStage, TimetrackingStagesList));
                    }
                    catch
                    {
                        failedPlants.Add(plant.Key);
                    }
                    if (!failedPlants.IsEmpty)
                    {
                        TimeTrackingResult.Error = new ErrorMessage
                        {
                            code = "460",
                            info = "The following plants are not responding: " + string.Join(",", failedPlants.Distinct())
                        };
                    }
                }
                TimeTrackingResult.TimeTracking = timeTrackingList;
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetPlantwiseTimetracking(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            //return timeTrackingList;
            List<int> App_Stage = new List<int>();
            App_Stage = new List<int>();
            string ConnectionString = this._ConnEmdepGeosString;
            try
            {
                #region App_Stage
                string[] plants = Plant.Split(',');
                GeosAppSettingAPI Setting = GetGeosAppSettings(96, ConnectionString);
                if (!string.IsNullOrEmpty(Setting.defaultValue))
                {
                    List<string> tempApp_Stage = Convert.ToString(Setting.defaultValue).Split(',').ToList<string>();

                    foreach (var item in tempApp_Stage)
                    {
                        App_Stage.Add(Convert.ToInt32(item));
                    }
                }
                #endregion
                List<SiteAPI> timeTrackingResult1 = new List<SiteAPI>();
                //  timeTrackingResult1 = TimeTrackingResult.TimeTracking.Where(w => w.siteList.Any(a => a.Name.Equals(plants[0]))).FirstOrDefault().siteList;

                //var timeTracking = TimeTrackingResult.TimeTracking?.FirstOrDefault(w => w.siteList?.Any(a => a.Name.Equals(plants[0])) == true);
                var plantName = (plants?.FirstOrDefault() ?? "0");

                var timeTracking = plantName == "0"
                    ? TimeTrackingResult.TimeTracking?.FirstOrDefault()
                    : TimeTrackingResult.TimeTracking?.FirstOrDefault(w => w.siteList?.Any(a => a.Name.Equals(plantName)) == true);

                if (timeTracking != null && timeTracking.siteList != null)
                {
                    timeTrackingResult1 = timeTracking.siteList;
                }
                SiteAPI Site = timeTrackingResult1.Where(s => s.Name.Equals(plants[0])).FirstOrDefault();
                List<SiteAPI> site = new List<SiteAPI>();
                foreach (var item in CommonManager.DictonarySites)
                {
                    if (!plants.Any(a => a.Equals(item.Key)))
                    {
                        if (Site != null)
                        {


                            SiteAPI siteitem = new SiteAPI();
                            siteitem.IdSite = Site.IdSite;
                            siteitem.Name = item.Key;
                            site.Add(siteitem);
                        }

                    }
                }
                GetERMTimeTrackingFromServiceAsync(site, FromDeliveryDate, ToDeliveryDate, Stage, Currency, plants[0] /*SiteName*/, connstr, timeTrackingList, Plantwiseconnectionstring, ConnectionString);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetPlantwiseTimetracking()--->  GetERMTimeTrackingFromServiceAsync. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
            }
            return TimeTrackingResult;
        }
        public static async void GetERMTimeTrackingFromServiceAsync(List<SiteAPI> SitesList, string FromDeliveryDate, string ToDeliveryDate, string Stage, string Currency, string SiteName, string Plantwiseconnectionstring, List<TimetrackingAPI> timeTrackingList, string tempPlantwiseconnectionstring, string EmdepconnectionString)
        {
            List<WorkStage> AllProductioStage = new List<WorkStage>();

            var siteTasks = new List<Task>();

            ConcurrentBag<TimetrackingAPI> allTimeTrackings = new ConcurrentBag<TimetrackingAPI>();
            var tasks = new List<Task<List<TimetrackingAPI>>>();
            foreach (var item in SitesList)
            {
                var lockObj = new object();
                siteTasks.Add(Task.Run(() =>
                {
                    try
                    {
                        if (item.IdSite != null)
                        {
                            lock (lockObj) // Avoid race condition when updating shared CommonManager
                            {
                                if (CommonManager.DictonaryPlant != null && CommonManager.DictonaryPlant.Count != 0)
                                {
                                    CommonManager.ConnString = Plantwiseconnectionstring;
                                    CommonManager.DictonaryPlant = CommonManager.GetAllPlant(Convert.ToString(item.Name));
                                    CommonManager.ConnString = Plantwiseconnectionstring;
                                    CommonManager.DictonarySites = CommonManager.GetAllSites();
                                    CommonManager.DictonarySitesGDB02 = CommonManager.GetAllSitesGDB02();
                                }
                            }

                            if (CommonManager.DictonarySites.ContainsKey(item.Name))
                            {
                                //string connstr = string.Format(tempPlantwiseconnectionstring, CommonManager.DictonaryPlant[item.Name]);
                                string connstr = string.Format(tempPlantwiseconnectionstring, CommonManager.DictonarySitesGDB02[item.Name].FirstOrDefault().Key);

                                List<TimetrackingAPI> newTimeTracking = new List<TimetrackingAPI>();

                                List<string> allStages;
                                lock (lockObj) // Protect shared call if needed
                                {
                                    AllProductioStage = GetAllTimeTrackingProductioStage_V2340(
                                        Plantwiseconnectionstring, Stage, item.IdSite, Stage);
                                }

                                newTimeTracking = ReturnFullTimeTrackingList(
                                    item.IdSite,
                                    FromDeliveryDate,
                                    ToDeliveryDate,
                                    Stage,
                                    Currency,
                                    item.Name,
                                    connstr,
                                    timeTrackingList,
                                    EmdepconnectionString,
                                    AllProductioStage
                                );

                                foreach (var t in newTimeTracking)
                                {
                                    allTimeTrackings.Add(t);
                                }
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        Log4NetLogger.Logger.Log(
                            string.Format("Error in parallel GetERMTimeTrackingFromServiceAsync(). ErrorMessage- {0}", ex.Message),
                            category: Category.Exception,
                            priority: Priority.Low
                        );
                    }
                }));
            }
            Task.WaitAll(siteTasks.ToArray());
            // Wait for all plant/site tasks to finish
            // await Task.WhenAll(siteTasks);
            var results = await Task.WhenAll(tasks);

            foreach (var result in results)
            {
                timeTrackingList.AddRange(result);
            }

            // TimeTrackingResult.TimeTracking = timeTrackingList;
            // Convert ConcurrentBag to List and assign
            // timeTrackingList = allTimeTrackings.ToList();

            //foreach (var item in SitesList)
            //{
            //    try
            //    {
            //        if (item.IdSite != null)
            //        {
            //            if (CommonManager.DictonaryPlant != null || CommonManager.DictonaryPlant.Count != 0)
            //            {
            //                CommonManager.ConnString = Plantwiseconnectionstring;
            //                CommonManager.DictonaryPlant = new Dictionary<string, string>();
            //                CommonManager.DictonaryPlant = CommonManager.GetAllPlant(Convert.ToString(item.Name));  //[Pallavi Jadhav][APIGEOS-728][02 03 2023]
            //                var temp1 = CommonManager.DictonaryPlant.FirstOrDefault();

            //                CommonManager.ConnString = Plantwiseconnectionstring;
            //                CommonManager.DictonarySites = CommonManager.GetAllSites();
            //            }
            //            //Plantwiseconnectionstring = Plantwiseconnectionstring.Replace("10.0.9.202", "10.0.9.2022");

            //            if (CommonManager.DictonarySites.ContainsKey(item.Name))  //[Pallavi Jadhav][APIGEOS-728][02 03 2023]
            //            {
            //                string connstr = string.Format(tempPlantwiseconnectionstring, CommonManager.DictonaryPlant[item.Name]);
            //                List<TimeTracking> newTimeTracking = new List<TimeTracking>();
            //                var tasks = new List<Task>();

            //                tasks.Add(Task.Run(()=>AllProductioStage = GetAllTimeTrackingProductioStage_V2340(Plantwiseconnectionstring, Stage, item.IdSite, Stage)));
            //                tasks.Add(Task.Run(() => newTimeTracking =  ReturnFullTimeTrackingList(item.IdSite, FromDeliveryDate, ToDeliveryDate, Stage, Currency, item.Name/*SiteName*/, connstr, timeTrackingList, EmdepconnectionString, AllProductioStage)));
            //                //timeTrackingList.AddRange(GetTimeTrackingBYPlant(item.IdSite, deliveryWeek, Stage, Currency, SiteName, Plantwiseconnectionstring));
            //                Task.WaitAll(tasks.ToArray());
            //            }

            //        }
            //    }
            //    catch (Exception ex)
            //    {
            //        Log4NetLogger.Logger.Log(string.Format("Error GetERMTimeTrackingFromServiceAsync(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
            //    }
            //}

        }

        private static List<TimetrackingAPI> ReturnFullTimeTrackingList(Int64 idSite, string FromDeliveryDate, string ToDeliveryDate, string Stage, string Currency, string SiteName, string Plantwiseconnectionstring, List<TimetrackingAPI> timeTrackingList, string EmdepconnectionString, List<WorkStage> AllProductioStage)
        {
            try
            {

                timeTrackingList.AddRange(GetTimeTrackingBYPlant(idSite, FromDeliveryDate, ToDeliveryDate, Stage, Currency, SiteName, Plantwiseconnectionstring, EmdepconnectionString, AllProductioStage));
                //GetTimeTrackingBYPlant(idSite, deliveryWeek, Stage, Currency, SiteName, Plantwiseconnectionstring);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetERMTimeTrackingFromServiceAsync(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

            }
            return timeTrackingList;
        }
        public static List<WorkStage> GetAllTimeTrackingProductioStage_V2340(string ERMConnectionString, string Stage, Int64 idSite, string Stage1)
        {

            List<WorkStage> ProductionStages = new List<WorkStage>();

            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(ERMConnectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("GEOSAPI_GetAllTimeTrackingProductionStage1_V580", mySqlConnection);
                    mySqlCommand.Parameters.AddWithValue("_Stage", Stage);
                    mySqlCommand.Parameters.AddWithValue("_IdSite", idSite);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            WorkStage ProductionStage = new WorkStage();

                            ProductionStage.Id = Convert.ToInt32(reader["IdStage"]);

                            if (reader["Name"] != DBNull.Value)
                                ProductionStage.Name = Convert.ToString(reader["Name"]);

                            if (reader["Code"] != DBNull.Value)
                                ProductionStage.Code = Convert.ToString(reader["Code"]);
                            if (reader["Sequence"] != DBNull.Value)
                                ProductionStage.Sequence = Convert.ToInt32(reader["Sequence"]);
                            if (reader["ActiveInPlants"] != DBNull.Value)
                                ProductionStage.ActiveInPlants = (reader["ActiveInPlants"]).ToString();

                            ProductionStages.Add(ProductionStage);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetAllTimeTrackingProductioStage_V2320().  ErrorMessage- {1}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return ProductionStages;
        }

        public List<TimetrackingAPI> GetTimetracking(string Plant, string FromDeliveryDate, string ToDeliveryDate, string Stage, string Currency, string DatabaseIP, string SiteName, string Plantwiseconnectionstring, List<SiteByShippingAddressAPI> SitesByShippingAddressList, List<TimeTrackingProductionStageAPI> TimeTrackingProductionStage, StageByOTItemAndIDDrawingAPI TimetrackingStagesList)
        {
            List<TimetrakingEmployees> TimetrakingEmployeesList = new List<TimetrakingEmployees>();
            List<TimetrackingAPI> timeTrackingList = new List<TimetrackingAPI>();
            List<WorkStage> AllWorkStage = new List<WorkStage>();
            try

            {

                TimetrackingStagesList = GetAllStagesPerIDOTItemAndIDDrawing_V2500(Plantwiseconnectionstring); //[pallavi.jadhav][APIGEOS-1482][16 06 2025]

                TimeTrackingProductionStage.AddRange(GetAllTimeTrackingProductioStage(Plantwiseconnectionstring));//[pallavi.jadhav][APIGEOS-1482][16 06 2025]

                SitesByShippingAddressList = GetAllSitesByShippingAddress(Plantwiseconnectionstring);

            }

            catch (Exception ex)
            {
                throw;
            }
            #region 
            //  List<TimeTrackingProductionStage> TimeTrackingProductionStage = new List<Entities.TimeTrackingProductionStage>();
            List<int> OtItemStagesList = new List<int>();
            List<int> DrawingIdStagesList = new List<int>();
            //   StageByOTItemAndIDDrawing TimetrackingStagesList = new StageByOTItemAndIDDrawing();
            List<int> App_Stage = new List<int>();
            App_Stage = new List<int>();
            string ConnectionString = this._ConnEmdepGeosString;
            GeosAppSettingAPI Setting = new GeosAppSettingAPI();
            Setting = GetGeosAppSettings(96, ConnectionString);
            #region [pallavi jadhav][APIGEOS-1074][30 01 2024]
            bool IsPlantActive = false;
            GeosAppSettingAPI AppSetting = new GeosAppSettingAPI();

            List<int> App_StageActivePlant = new List<int>();
            App_StageActivePlant = new List<int>();

            AppSetting = GetGeosAppSettings(134, ConnectionString);

            if (!string.IsNullOrEmpty(AppSetting.defaultValue))
            {
                List<string> tempApp_Stage = Convert.ToString(AppSetting.defaultValue).Split(',').ToList<string>();

                foreach (var item in tempApp_Stage)
                {
                    App_StageActivePlant.Add(Convert.ToInt32(item));
                }
            }
            #endregion

            FillCADCAMDesignTypeList(ConnectionString);
            try
            {
                if (!string.IsNullOrEmpty(Setting.defaultValue))
                {
                    List<string> tempApp_Stage = Convert.ToString(Setting.defaultValue).Split(',').ToList<string>();

                    foreach (var item in tempApp_Stage)
                    {
                        App_Stage.Add(Convert.ToInt32(item));
                    }
                }
            }
            catch (Exception ex) { }
            #endregion
            try
            {
                Plant = SiteName;
                // string connstr = string.Format(Plantwiseconnectionstring, DatabaseIP);
                Int64 idSite = IsEMDEPSiteExist(Plant, Plantwiseconnectionstring);
                #region [pallavi jadhav][APIGEOS-1074][30 01 2024]
                if (App_StageActivePlant != null && App_StageActivePlant.Count > 0)
                {
                    var tempApp_Stage = App_StageActivePlant.Where(a => a == idSite).ToList();
                    if (tempApp_Stage != null && tempApp_Stage.Count > 0)
                    {
                        IsPlantActive = true;
                    }
                }
                #endregion

                List<TimetrackingAPI> TemptimeTrackingList = new List<TimetrackingAPI>();
                List<CurrencyRateListByDate> AllCurrencyRateList = new List<CurrencyRateListByDate>();//[rani dhamankar][APIGEOS-1317][28-01-2025]
                                                                                                      // List<SitesByShippingAddress> SitesByShippingAddressList = new List<SitesByShippingAddress>();  //[Pallavi Jadhav][APIGEOS-728][02 03 2023]
                SiteByShippingAddressAPI tmpSiteIdByAddress = new SiteByShippingAddressAPI();
                List<SiteAPI> SitesList = new List<SiteAPI>();
                List<WorkStage> AllProductioStage = new List<WorkStage>();
                var tasks = new List<Task>();
                try
                {
                    //tasks.Add(Task.Run(() => TimetrackingStagesList = GetAllStagesPerIDOTItemAndIDDrawing_V2500(connstr))); //[pallavi.jadhav][APIGEOS-1482][16 06 2025]
                    //tasks.Add(Task.Run(() => TimeTrackingProductionStage.AddRange(GetAllTimeTrackingProductioStage(connstr))));//[pallavi.jadhav][APIGEOS-1482][16 06 2025]
                    // tasks.Add(Task.Run(() => AllProductioStage = GetAllTimeTrackingProductioStage_V2340(connstr, Stage, idSite)));
                    AllProductioStage = GetAllTimeTrackingProductioStage_V2340(Plantwiseconnectionstring, Stage, idSite);
                    //tasks.Add(Task.Run(() => SitesByShippingAddressList = GetAllSitesByShippingAddress(connstr)));
                    //Task.WaitAll(tasks.ToArray());//[pallavi.jadhav][APIGEOS-1482][16 06 2025]
                    OtItemStagesList = new List<int>();
                    DrawingIdStagesList = new List<int>();
                    if (TimetrackingStagesList.OTITemStagesList == null)
                    {
                        TimetrackingStagesList.OTITemStagesList = new List<StagesAPI>();
                    }
                    if (TimetrackingStagesList.DrawingIdStagesList == null)
                    {
                        TimetrackingStagesList.DrawingIdStagesList = new List<StagesAPI>();
                    }
                    OtItemStagesList = TimetrackingStagesList.OTITemStagesList.Select(i => i.IdStages).ToList();
                    DrawingIdStagesList = TimetrackingStagesList.DrawingIdStagesList.Select(i => i.IdStages).ToList();
                    //AllProductioStage = GetAllTimeTrackingProductioStage_V2340(connstr, Stage, idSite);
                    //  SitesByShippingAddressList = GetAllSitesByShippingAddress(connstr);

                    Log4NetLogger.Logger.Log(string.Format("Method GetTimetracking()....."), category: Category.Info, priority: Priority.Low);
                }
                catch (Exception ex)
                {
                    throw;
                }
                #region //[rani dhamankar][APIGEOS-1317][29-01-2025]
                string[] Currencies = new string[0];
                string[] RemainingCurrencies = new string[0];
                try
                {
                    if (!string.IsNullOrEmpty(Currency))
                    {
                        if (Currency.Contains(","))
                        {
                            Currencies = Currency.Split(',');
                            RemainingCurrencies = Currencies.Skip(1).ToArray();
                        }
                        else
                        {
                            Currencies = new string[] { Currency };
                        }
                    }
                }
                catch (Exception)
                {
                    throw;
                }
                #endregion
                DataSet ds = new DataSet();
                using (MySqlConnection conn = new MySqlConnection(Plantwiseconnectionstring))
                {
                    conn.Open();

                    #region commented code
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_GetProductionTimeTracking_V540", conn);
                    //MySqlCommand command = new MySqlCommand("APIERM_GetAllTimeTracking_V560", conn);
                    //MySqlCommand command = new MySqlCommand("APIERM_GetAllTimeTracking_V640", conn); // Rahul[rgadhave][APIGEOS-978][28/11/2023]
                    //MySqlCommand command = new MySqlCommand("APIERM_GetAllTimeTracking_V690", conn); // Rahul[rgadhave][APIGEOS-978][28/11/2023]
                    //MySqlCommand command = new MySqlCommand("APIERM_GetAllTimeTracking_V740", conn); // [pallavi jadhav][APIGEOS-1189][27-08-2024]
                    //MySqlCommand command = new MySqlCommand("APIERM_GetAllTimeTracking_V790", conn); // [pallavi jadhav][APIGEOS-1074][22 01 2025]
                    //[pallavi jadhav][APIGEOS-1329][28-04-2025]
                    //[APIGEOS-1530][26.06.2025][rdixit]
                    //[pallavi jadhav][APIGEOS-1317][29 01 2025]
                    //[pallavi jadhav][APIGEOS-1317][29 01 2025]     
                    //[rani dhamankar][APIGEOS-1317][30-01-2025]
                    #endregion
                    //    MySqlCommand command = new MySqlCommand("APIERM_GetAllTimeTracking_V840", conn);
                    MySqlCommand command = new MySqlCommand("APIERM_GetAllTimeTracking_V870", conn); // [pallavi.jadhav][15 10 2025][APIGEOS-1712]
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_FromDeliveryDate", Convert.ToDateTime(FromDeliveryDate));
                    command.Parameters.AddWithValue("_ToDeliveryDate", Convert.ToDateTime(ToDeliveryDate));
                    command.Parameters.AddWithValue("_Currency", Currencies.Length > 0 && !string.IsNullOrEmpty(Currencies[0]) ? Currencies[0].ToUpper() : "EUR");
                    command.CommandTimeout = 6000;
                    #region  [rani dhamankar][APIGEOS-1317][28-01-2025]

                    try
                    {

                        using (MySqlDataAdapter adap = new MySqlDataAdapter(command))
                        {
                            adap.Fill(ds);

                        }


                    }
                    catch (Exception ex)
                    {
                        throw;
                    }
                    #endregion
                }
                try
                {
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                    {

                        if (ds.Tables[0].Rows.Count > 0)
                        {
                            var minDate = ds.Tables[0].AsEnumerable()
                                           .Min(row => row.Field<DateTime>("DeliveryDate"));

                            var maxDate = ds.Tables[0].AsEnumerable()
                                                           .Max(row => row.Field<DateTime>("DeliveryDate"));
                            AllCurrencyRateList = GetAllCurrencyDetails(Convert.ToDateTime(minDate), Convert.ToDateTime(maxDate), Plantwiseconnectionstring);

                        }
                    }

                }
                catch (Exception ex)
                {

                    throw;
                }


                try
                {
                    foreach (DataRow dr in ds.Tables[0].Rows)
                    {
                        try
                        {
                            timeTracking = new TimetrackingAPI();

                            if (dr["DeliveryWeek"] != DBNull.Value)
                            {
                                timeTracking.DeliveryWeek = Convert.ToString(dr["DeliveryWeek"].ToString());
                            }
                            if (dr["CPProductID"] != DBNull.Value)
                            {
                                timeTracking.CPProductID = Convert.ToInt32(dr["CPProductID"]);
                            }
                            if (dr["IdCP"] != DBNull.Value)
                            {
                                timeTracking.IdCP = Convert.ToInt32(dr["IdCP"]);
                            }
                            if (dr["IdCounterpart"] != DBNull.Value)
                            {
                                timeTracking.IdCounterpart = Convert.ToInt32(dr["IdCounterpart"]);
                            }
                            if (dr["DeliveryDate"] != DBNull.Value)
                            {
                                timeTracking.DeliveryDate = Convert.ToDateTime(dr["DeliveryDate"]).ToString("yyyy-MM-dd");
                            }

                            #region [pallavi jadhav][APIGEOS-1074][22 01 2025]
                            if (dr["MaxPlanDateByStages"] != DBNull.Value)
                            {
                                timeTracking.PlannedDeliveryDate = Convert.ToDateTime(dr["MaxPlanDateByStages"]).ToString("yyyy-MM-dd");
                            }

                            #endregion

                            if (dr["FirstDeliveryDate"] != DBNull.Value)
                            {
                                try
                                {
                                    timeTracking.FirstDeliveryDate = Convert.ToDateTime(dr["FirstDeliveryDate"]).ToString("yyyy-MM-dd");

                                    if (timeTracking.FirstDeliveryDate == timeTracking.DeliveryDate)
                                    {
                                        timeTracking.FirstDeliveryDate = null;
                                    }
                                }
                                catch (Exception ex)
                                {
                                    timeTracking.FirstDeliveryDate = null;
                                }
                            }
                            if (dr["QuoteSendDate"] != DBNull.Value)
                            {
                                timeTracking.QuoteSendDate = Convert.ToDateTime(dr["QuoteSendDate"]).ToString("yyyy-MM-dd");
                            }
                            //[plahange][APIGEOS-701][28/02/2023]
                            if (dr["Samples"] != DBNull.Value)
                            {
                                timeTracking.Samples = Convert.ToString(dr["Samples"].ToString());
                            }
                            if (dr["SampleReceivedIn"] != DBNull.Value)
                            {
                                timeTracking.SamplesDate = Convert.ToDateTime(dr["SampleReceivedIn"]).ToString("yyyy-MM-dd");
                                if (timeTracking.SamplesDate.Equals(DateTime.MinValue.ToString("yyyy-MM-dd")))
                                {
                                    timeTracking.SamplesDate = "";
                                }
                            }
                            if (dr["GoAheadDate"] != DBNull.Value)
                            {
                                timeTracking.GoAheadDate = Convert.ToDateTime(dr["GoAheadDate"]).ToString("yyyy-MM-dd");
                            }
                            if (dr["PODate"] != DBNull.Value)
                            {
                                timeTracking.PODate = Convert.ToDateTime(dr["PODate"]).ToString("yyyy-MM-dd");
                            }
                            if (dr["AvailForDesignDate"] != DBNull.Value)
                            {
                                timeTracking.AvailableforDesignDate = Convert.ToDateTime(dr["AvailForDesignDate"]).ToString("yyyy-MM-dd");
                            }
                            if (dr["POType"] != DBNull.Value)
                            {
                                timeTracking.POType = Convert.ToString(dr["POType"].ToString());
                            }
                            if (dr["Customer"] != DBNull.Value)
                            {
                                timeTracking.Customer = Convert.ToString(dr["Customer"].ToString());
                            }
                            if (dr["Project"] != DBNull.Value)
                            {
                                timeTracking.Project = Convert.ToString(dr["Project"].ToString());
                            }
                            if (dr["Offer"] != DBNull.Value)
                            {
                                timeTracking.Offer = Convert.ToString(dr["Offer"].ToString());
                            }
                            if (dr["OTCode"] != DBNull.Value)
                            {
                                timeTracking.OTCode = Convert.ToString(dr["OTCode"].ToString());
                            }
                            SiteAPI tmpSite = new SiteAPI();
                            if (dr["IdShippingAddress"] != DBNull.Value)  //[Pallavi Jadhav][APIGEOS-728][02 03 2023]
                            {
                                timeTracking.IdShippingAddress = Convert.ToUInt64(dr["IdShippingAddress"].ToString());

                                tmpSiteIdByAddress = SitesByShippingAddressList.Where(i => i.IdShippingAddress == timeTracking.IdShippingAddress).FirstOrDefault();
                                if (tmpSiteIdByAddress != null)
                                {
                                    if (!SitesList.Any(i => i.IdSite == tmpSiteIdByAddress.IdSite))
                                    {

                                        tmpSite.IdSite = tmpSiteIdByAddress.IdSite;
                                        tmpSite.Name = tmpSiteIdByAddress.Name;
                                        SitesList.Add(tmpSite);
                                    }
                                }
                                timeTracking.siteList = SitesList;
                            }


                            if (dr["OriginalPlant"] != DBNull.Value) //[pallavi.jadhav][29 08 205] [APIGEOS-1618]
                            {
                                timeTracking.OriginPlant = Convert.ToString(dr["OriginalPlant"]);
                            }
                            //  timeTracking.OriginPlant = SiteName;

                            if (dr["ProductionPlant"] != DBNull.Value)
                            {
                                timeTracking.ProductionPlant = Convert.ToString(dr["ProductionPlant"]);
                            }

                            if (dr["Reference"] != DBNull.Value)
                            {
                                timeTracking.CustomerReference = Convert.ToString(dr["Reference"]);
                            }
                            if (dr["Template"] != DBNull.Value)
                            {
                                timeTracking.Template = Convert.ToString(dr["Template"]);
                            }
                            if (dr["Type"] != DBNull.Value)
                            {
                                timeTracking.Type = Convert.ToString(dr["Type"]);
                            }

                            Int64 totalQTY = 0;
                            if (dr["QTY"] != DBNull.Value)
                            {
                                totalQTY = Convert.ToInt32(dr["QTY"]);
                                if (totalQTY > 1)
                                {
                                    timeTracking.QTY = 1;
                                }
                                else
                                {
                                    timeTracking.QTY = Convert.ToInt32(dr["QTY"]);
                                }

                            }

                            if (dr["Unit"] != DBNull.Value)
                            {
                                timeTracking.UnitSalePrice = Math.Round(Convert.ToDouble(dr["Unit"]), 2, MidpointRounding.AwayFromZero);
                            }
                            if (timeTracking.QTY != null && timeTracking.UnitSalePrice != null)
                            {
                                timeTracking.TotalSalePrice = Math.Round(timeTracking.UnitSalePrice * timeTracking.QTY, 2, MidpointRounding.AwayFromZero);
                            }
                            #region  [rani dhamankar][APIGEOS-1317][28-01-2025]
                            ERM_SalesPrices ermSalesPrices = new ERM_SalesPrices();
                            List<ERM_SalesPrices> cloneAllSalesprice = new List<ERM_SalesPrices>();
                            ermSalesPrices.IdCurrency = Convert.ToInt32(dr["IdCurrency"]); ;
                            ermSalesPrices.Currency = Convert.ToString(dr["CurrencySalePrice"]);
                            ermSalesPrices.UnitSalePrice = timeTracking.UnitSalePrice;
                            ermSalesPrices.TotalSalePrice = Math.Round(timeTracking.UnitSalePrice * timeTracking.QTY, 2, MidpointRounding.AwayFromZero);
                            cloneAllSalesprice.Add(ermSalesPrices);
                            try
                            {
                                if (!string.IsNullOrEmpty(Currency))
                                {
                                    if (RemainingCurrencies.Length > 0)
                                    {
                                        foreach (var cur in RemainingCurrencies)
                                        {
                                            double CurConversionRate = 0;
                                            var Curid = AllCurrencyRateList.Where(x => x.Currency == cur).Select(x => x.IdCurrency).FirstOrDefault();
                                            var tmpCurrencyRate = AllCurrencyRateList.Where(a => a.CurrencyFrom == dr["IdCurrency"].ToString() && a.CurrencyTo == Curid.ToString() && (a.ConversionDate >= Convert.ToDateTime(timeTracking.DeliveryDate) && a.ConversionDate <= Convert.ToDateTime(timeTracking.DeliveryDate))).FirstOrDefault();
                                            if (tmpCurrencyRate == null)
                                            {
                                                tmpCurrencyRate = AllCurrencyRateList.Where(a => a.CurrencyFrom == dr["IdCurrency"].ToString() && a.CurrencyTo == Curid.ToString()).FirstOrDefault();
                                            }
                                            if (tmpCurrencyRate != null)
                                            {
                                                CurConversionRate = tmpCurrencyRate.ConversionRate;
                                            }
                                            ERM_SalesPrices ermSalesPricesDetails = new ERM_SalesPrices();
                                            ermSalesPricesDetails.IdCurrency = Curid;
                                            ermSalesPricesDetails.Currency = cur;
                                            ermSalesPricesDetails.UnitSalePrice = Math.Round(timeTracking.UnitSalePrice * CurConversionRate, 2, MidpointRounding.AwayFromZero);
                                            ermSalesPricesDetails.TotalSalePrice = Math.Round(timeTracking.UnitSalePrice * timeTracking.QTY * CurConversionRate, 2, MidpointRounding.AwayFromZero);
                                            cloneAllSalesprice.Add(ermSalesPricesDetails);

                                        }
                                    }
                                }
                                timeTracking.SalesPrices = cloneAllSalesprice;


                                if (dr["workbook_drawing"] != DBNull.Value)
                                {
                                    timeTracking.WorkbookDrawing = Convert.ToString(dr["workbook_drawing"]);
                                }
                                if (dr["DesignSystem"] != DBNull.Value)
                                {
                                    timeTracking.DesignSystem = Convert.ToString(dr["DesignSystem"]);
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetTimeTraking(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw ex;
                            }
                            #endregion

                            if (dr["SerialNumber"] != DBNull.Value)
                            {
                                timeTracking.SerialNumber = Convert.ToString(dr["SerialNumber"]);
                            }
                            if (dr["itemStatus"] != DBNull.Value)
                            {
                                timeTracking.ItemStatus = Convert.ToString(dr["itemStatus"]);
                            }
                            if (dr["DrawingType"] != DBNull.Value)
                            {
                                timeTracking.DesignType = Convert.ToString(dr["DrawingType"]);
                            }
                            if (dr["TrayName"] != DBNull.Value)
                            {
                                timeTracking.Tray = Convert.ToString(dr["TrayName"]);
                            }
                            if (dr["cutWorkStation"] != DBNull.Value)
                            {
                                timeTracking.CurrentWorkStation = Convert.ToString(dr["cutWorkStation"]);
                            }


                            if (dr["Rework"] != DBNull.Value)
                            {
                                timeTracking.TotalRework = Convert.ToInt32(dr["Rework"]);
                            }
                            #region 
                            if (dr["IsBatch"] != DBNull.Value)
                            {
                                if (Convert.ToInt32(dr["IsBatch"]) == 1)
                                {
                                    timeTracking.IsBatch = true;
                                }
                                else
                                {
                                    timeTracking.IsBatch = false;
                                }
                            }

                            if (dr["IdOTItem"] != DBNull.Value)
                            {
                                timeTracking.IdOTItem = Convert.ToInt64(dr["IdOTItem"]);
                            }

                            if (dr["IdDrawing"] != DBNull.Value)
                            {
                                timeTracking.IdDrawing = Convert.ToInt64(dr["IdDrawing"]);
                            }
                            if (dr["IdOT"] != DBNull.Value)
                            {
                                timeTracking.IdOt = Convert.ToInt64(dr["IdOT"]);
                            }
                            #endregion
                            if (timeTracking.WorkStage == null)
                            {
                                if (timeTracking == null)
                                    timeTracking = new TimetrackingAPI();

                                if (timeTracking.WorkStage == null)
                                    timeTracking.WorkStage = new List<WorkStage>();

                                List<WorkStage> cloneAllProductioStage = new List<WorkStage>();
                                for (int i = 0; i < AllProductioStage.Count; i++)
                                {
                                    WorkStage workStage = new WorkStage();
                                    workStage.IdCP = timeTracking.IdCP;
                                    workStage.IdCounterpart = timeTracking.IdCounterpart;
                                    workStage.Code = AllProductioStage[i].Code;
                                    workStage.Name = AllProductioStage[i].Name;
                                    workStage.Id = AllProductioStage[i].Id;
                                    workStage.Sequence = AllProductioStage[i].Sequence;
                                    if (string.IsNullOrEmpty(AllProductioStage[i].ActiveInPlants.ToString()))
                                    {
                                        cloneAllProductioStage.Add(workStage);
                                    }
                                    else
                                    {
                                        bool idSiteFound = false;
                                        // Split the ActiveInPlants string by ',' to get individual ids
                                        string[] activeInPlantIds = AllProductioStage[i].ActiveInPlants.Split(',');
                                        idSiteFound = activeInPlantIds.ToList().Any(k => Convert.ToInt32(k.Trim()) == idSite);
                                        if (idSiteFound)
                                        {
                                            cloneAllProductioStage.Add(workStage);
                                        }
                                    }
                                }

                                timeTracking.WorkStage.AddRange(cloneAllProductioStage);
                                timeTracking.WorkStage.ForEach(f => f.IdCP = timeTracking.IdCP);
                                timeTracking.WorkStage.ForEach(f => f.IdCounterpart = timeTracking.IdCounterpart);
                            }
                            else
                            {
                                if (timeTracking == null)
                                    timeTracking = new TimetrackingAPI();

                                if (timeTracking.WorkStage == null)
                                    timeTracking.WorkStage = new List<WorkStage>();

                                List<WorkStage> cloneAllProductioStage = new List<WorkStage>();
                                for (int i = 0; i < AllProductioStage.Count; i++)
                                {
                                    WorkStage workStage = new WorkStage();
                                    workStage.IdCP = timeTracking.IdCP;
                                    workStage.IdCounterpart = timeTracking.IdCounterpart;
                                    workStage.Code = AllProductioStage[i].Code;
                                    workStage.Name = AllProductioStage[i].Name;
                                    workStage.Id = AllProductioStage[i].Id;
                                    workStage.Sequence = AllProductioStage[i].Sequence;
                                    if (string.IsNullOrEmpty(AllProductioStage[i].ActiveInPlants.ToString()))
                                    {
                                        cloneAllProductioStage.Add(workStage);
                                    }
                                    else
                                    {
                                        bool idSiteFound = false;
                                        string[] activeInPlantIds = AllProductioStage[i].ActiveInPlants.Split(',');
                                        idSiteFound = activeInPlantIds.ToList().Any(k => Convert.ToInt32(k.Trim()) == idSite);
                                        if (idSiteFound)
                                        {
                                            cloneAllProductioStage.Add(workStage);
                                        }
                                    }
                                }
                                timeTracking.WorkStage.AddRange(cloneAllProductioStage);
                                timeTracking.WorkStage.ForEach(f => f.IdCP = timeTracking.IdCP);
                                timeTracking.WorkStage.ForEach(f => f.IdCounterpart = timeTracking.IdCounterpart);
                            }
                            if (timeTracking.siteList == null)
                            {
                                timeTracking.siteList = new List<SiteAPI>();
                            }
                            timeTracking.siteList = SitesList;
                            timeTracking.TimeTrackingStage = new List<WorkStage>();
                            timeTrackingList.Add(timeTracking);
                        }
                        catch (Exception ex)
                        {

                            throw;
                        }
                    }
                }
                catch (Exception)
                {

                    throw;
                }
                try
                {
                    if (ds.Tables.Count > 1 && ds.Tables[1].Rows.Count > 0)
                    {
                        foreach (DataRow dr in ds.Tables[1].Rows)
                        {
                            if (dr.Table.Columns.Contains("IdCounterpart") && dr["IdCounterpart"] != DBNull.Value)
                            {
                                #region pallavi

                                List<TimetrackingAPI> UpdatetimetrackList = timeTrackingList.Where(i => i.IdCounterpart == Convert.ToInt64(dr["IdCounterpart"])).ToList();

                                // *** IMPORTANT: Add this check to ensure UpdatetimetrackList is not empty ***
                                if (UpdatetimetrackList.Any()) // Checks if there are any elements in the list
                                {
                                    // Your original condition, now safe to access UpdatetimetrackList[0]
                                    if (UpdatetimetrackList[0].WorkStage.Any(i => i.Id == Convert.ToInt32(dr["IdStage"])))
                                    {
                                        foreach (TimetrackingAPI itemTimeTracking in UpdatetimetrackList)
                                        {
                                            try
                                            {
                                                WorkStage test = itemTimeTracking.WorkStage.Where(i => i.Id == Convert.ToInt32(dr["IdStage"])).FirstOrDefault();


                                                if (test == null)
                                                {
                                                    // Handle the case where the WorkStage with the given Id is not found in itemTimeTracking.WorkStage
                                                    // You might want to log this or create a new WorkStage object
                                                    continue; // Skip to the next itemTimeTracking
                                                }

                                                if (itemTimeTracking.TimeTrackingStage == null)
                                                {
                                                    itemTimeTracking.TimeTrackingStage = new List<WorkStage>();
                                                }
                                                WorkStage workstage = new WorkStage();
                                                TimeTrackingCurrentStageAPI tcstageNew = new TimeTrackingCurrentStageAPI();
                                                // start[suggetion of matos and PPC team meeting][30 - 09 - 2025]
                                                tcstageNew.IdStage = Convert.ToInt32(dr["IdStage"]);
                                                if (dr["Sequence"] != DBNull.Value)
                                                {
                                                    workstage.Sequence = Convert.ToInt32(dr["Sequence"]);
                                                    tcstageNew.Sequence = Convert.ToInt32(dr["Sequence"]);

                                                }
                                                //  End[suggetion of matos and PPC team meeting][30 - 09 - 2025]
                                                if (dr["IdStage"] != DBNull.Value)
                                                {
                                                    workstage.Id = Convert.ToInt32(dr["IdStage"]);
                                                    test.Id = Convert.ToInt32(dr["IdStage"]);
                                                }
                                                if (dr["WorkStageCode"] != DBNull.Value)
                                                {
                                                    workstage.Code = Convert.ToString(dr["WorkStageCode"]);
                                                    test.Code = Convert.ToString(dr["WorkStageCode"]);
                                                    tcstageNew.Code = Convert.ToString(dr["WorkStageCode"]);
                                                }
                                                if (dr["WorkStageName"] != DBNull.Value)
                                                {
                                                    workstage.Name = Convert.ToString(dr["WorkStageName"]);
                                                    test.Name = Convert.ToString(dr["WorkStageName"]);
                                                    tcstageNew.Name = Convert.ToString(dr["WorkStageName"]);
                                                }
                                                #region
                                                if (dr["IdStage"] != DBNull.Value)
                                                {
                                                    tcstageNew.NewIdStage = Convert.ToInt32(dr["IdStage"]);
                                                    workstage.NewIdStage = Convert.ToInt32(dr["IdStage"]);
                                                    test.NewIdStage = Convert.ToInt32(dr["IdStage"]);
                                                }

                                                #endregion

                                                if (dr["StartDate"] != DBNull.Value) // Changed from != null to != DBNull.Value
                                                {
                                                    tcstageNew.Startdate = Convert.ToDateTime(dr["StartDate"]);
                                                    workstage.Startdate = Convert.ToDateTime(dr["StartDate"]);
                                                    test.Startdate = Convert.ToDateTime(dr["StartDate"]);
                                                }
                                                if (dr["EndDate"] != DBNull.Value)
                                                {
                                                    tcstageNew.Enddate = Convert.ToDateTime(dr["EndDate"]);
                                                    workstage.Enddate = Convert.ToDateTime(dr["EndDate"]);
                                                    test.Enddate = Convert.ToDateTime(dr["EndDate"]);
                                                }

                                                tcstageNew.Rework = Convert.ToInt32(dr["Rework"]);
                                                tcstageNew.IdCounterparttracking = Convert.ToInt32(dr["IdCounterpartTracking"]);
                                                tcstageNew.TimeDifference = Convert.ToDouble(dr["CurrentTime"]);

                                                //                                                var groupedMinDates = ds.Tables[1].AsEnumerable()
                                                //.Where(row => row["EndDate"] != DBNull.Value && Convert.ToInt64(row["IdCounterpart"]) == itemTimeTracking.IdCounterpart)
                                                //.GroupBy(row => Convert.ToInt32(row["IdStage"]))
                                                //.Select(g =>
                                                //{
                                                //    var idStage = g.Key;

                                                //    if (idStage == 3)
                                                //    {
                                                //        // For IdStage == 3, don't use Min, just take the first row as-is
                                                //        var firstRow = g.First();
                                                //        var endDate = Convert.ToDateTime(firstRow["EndDate"]);

                                                //        return new
                                                //        {
                                                //            IdStage = idStage,
                                                //            MinFirstValidatedDate = endDate,
                                                //            FormattedDate = endDate.ToString("yyyy-MM-dd HH:mm:ss"),
                                                //            FullRow = firstRow
                                                //        };
                                                //    }
                                                //    else
                                                //    {
                                                //        // Normal logic for all other stages
                                                //        var minEndDate = g.Min(r => Convert.ToDateTime(r["EndDate"]));
                                                //        var minRow = g
                                                //            .OrderBy(r => Convert.ToDateTime(r["EndDate"]))
                                                //            .ThenBy(r => Convert.ToInt32(r["IdCounterpartTracking"]))
                                                //            .First(r => Convert.ToDateTime(r["EndDate"]) == minEndDate);

                                                //        return new
                                                //        {
                                                //            IdStage = idStage,
                                                //            MinFirstValidatedDate = minEndDate,
                                                //            FormattedDate = minEndDate.ToString("yyyy-MM-dd HH:mm:ss"),
                                                //            FullRow = minRow
                                                //        };
                                                //    }
                                                //})
                                                //.ToList();
                                                if (workstage.Id == 3)
                                                {
                                                    workstage.FirstValidatedDate = workstage.Enddate.HasValue ? workstage.Enddate.Value.ToString("yyyy-MM-dd HH:mm:ss") : "";
                                                    test.FirstValidatedDate = workstage.Enddate.HasValue ? workstage.Enddate.Value.ToString("yyyy-MM-dd HH:mm:ss") : "";

                                                }
                                                else
                                                {
                                                    //var groupedMinDates = ds.Tables[1].AsEnumerable()
                                                    //    .Where(row => row["EndDate"] != DBNull.Value && Convert.ToInt64(row["IdCounterpart"]) == itemTimeTracking.IdCounterpart && Convert.ToInt32(row["IdStage"]) != 3)
                                                    //    .GroupBy(row => Convert.ToInt32(row["IdStage"]))
                                                    //    .Select(g =>
                                                    //    {
                                                    //        var minEndDate = g.Min(r => Convert.ToDateTime(r["EndDate"]));
                                                    //        var minRow = g
                                                    //            .OrderBy(r => Convert.ToDateTime(r["EndDate"]))
                                                    //            .ThenBy(r => Convert.ToInt32(r["IdCounterpartTracking"]))
                                                    //            .First(r => Convert.ToDateTime(r["EndDate"]) == minEndDate);

                                                    //        return new
                                                    //        {
                                                    //            IdStage = g.Key,
                                                    //            MinFirstValidatedDate = minEndDate,
                                                    //            FormattedDate = minEndDate.ToString("yyyy-MM-dd HH:mm:ss"),
                                                    //            FullRow = minRow
                                                    //        };
                                                    //    })
                                                    //    .ToList();

                                                    //var minendate = groupedMinDates.Where(a => a.IdStage == workstage.Id).FirstOrDefault();
                                                    //if (minendate != null)
                                                    //{
                                                    if (dr["EndDate"] != DBNull.Value)
                                                    {
                                                        workstage.FirstValidatedDate = Convert.ToDateTime(dr["EndDate"]).ToString("yyyy-MM-dd HH:mm:ss");
                                                        test.FirstValidatedDate = Convert.ToDateTime(dr["EndDate"]).ToString("yyyy-MM-dd HH:mm:ss");
                                                        //}
                                                    }
                                                }
                                                workstage.Reworks = Convert.ToInt32(dr["Rework"]);
                                                test.Reworks = Convert.ToInt32(dr["Rework"]);
                                                workstage.IdCounterparttracking = Convert.ToInt32(dr["IdCounterpartTracking"]);
                                                test.IdCounterparttracking = Convert.ToInt32(dr["IdCounterpartTracking"]);
                                                workstage.TimeDifference = Convert.ToDouble(dr["CurrentTime"]);
                                                test.TimeDifference = Convert.ToDouble(dr["CurrentTime"]);
                                                tcstageNew.TimeDifference = Convert.ToDouble(dr["CurrentTime"]);
                                                #region // [pallavi.jadhav][15 10 2025][APIGEOS-1712]
                                                if (dr["IdOperator"] != DBNull.Value)
                                                {
                                                    workstage.IdUser = Convert.ToInt32(dr["IdOperator"]);
                                                    test.IdUser = Convert.ToInt32(dr["IdOperator"]);

                                                }
                                                if (dr["EmployeeCode"] != DBNull.Value)
                                                {
                                                    workstage.EmployeeCode = Convert.ToString(dr["EmployeeCode"]);
                                                    test.EmployeeCode = Convert.ToString(dr["EmployeeCode"]);

                                                }
                                                if (dr["IdEmployee"] != DBNull.Value)
                                                {
                                                    workstage.IdEmployee = Convert.ToInt32(dr["IdEmployee"]);
                                                    test.IdEmployee = Convert.ToInt32(dr["IdEmployee"]);

                                                }
                                                #endregion
                                               // itemTimeTracking.TimeTrackingStage.Add(workstage);
                                            }
                                            catch (Exception ex)
                                            {
                                                throw;
                                            }
                                        }
                                    }
                                    else // This 'else' block corresponds to the 'if (UpdatetimetrackList[0].WorkStage.Any(...))' condition
                                    {
                                        foreach (TimetrackingAPI itemTimeTracking in UpdatetimetrackList)
                                        {
                                            try
                                            {
                                                if (itemTimeTracking.TimeTrackingStage == null)
                                                {
                                                    itemTimeTracking.TimeTrackingStage = new List<WorkStage>();
                                                }
                                                WorkStage workstage = new WorkStage();
                                                WorkStage tcstageNew = new WorkStage();
                                                tcstageNew.Id = Convert.ToInt32(dr["IdStage"]);
                                                // start[suggetion of matos and PPC team meeting][30 - 09 - 2025]
                                                if (dr["Sequence"] != DBNull.Value)
                                                {
                                                    workstage.Sequence = Convert.ToInt32(dr["Sequence"]);
                                                    tcstageNew.Sequence = Convert.ToInt32(dr["Sequence"]);

                                                }
                                                // start[suggetion of matos and PPC team meeting][30 - 09 - 2025]
                                                if (dr["IdStage"] != DBNull.Value)
                                                {
                                                    workstage.Id = Convert.ToInt32(dr["IdStage"]);
                                                }
                                                if (dr["WorkStageCode"] != DBNull.Value)
                                                {
                                                    workstage.Code = Convert.ToString(dr["WorkStageCode"]);
                                                }
                                                if (dr["WorkStageName"] != DBNull.Value)
                                                {
                                                    workstage.Name = Convert.ToString(dr["WorkStageName"]);
                                                }
                                                #region
                                                if (dr["IdStage"] != DBNull.Value)
                                                {
                                                    tcstageNew.NewIdStage = Convert.ToInt32(dr["IdStage"]);
                                                    workstage.NewIdStage = Convert.ToInt32(dr["IdStage"]);
                                                }

                                                #endregion

                                                if (dr["StartDate"] != DBNull.Value) // Changed from != null to != DBNull.Value
                                                {
                                                    tcstageNew.Startdate = Convert.ToDateTime(dr["StartDate"]);
                                                    workstage.Startdate = Convert.ToDateTime(dr["StartDate"]);
                                                }
                                                if (dr["EndDate"] != DBNull.Value)
                                                {
                                                    tcstageNew.Enddate = Convert.ToDateTime(dr["EndDate"]);
                                                    workstage.Enddate = Convert.ToDateTime(dr["EndDate"]);
                                                }

                                                tcstageNew.Reworks = Convert.ToInt32(dr["Rework"]);
                                                tcstageNew.IdCounterparttracking = Convert.ToInt32(dr["IdCounterpartTracking"]);
                                                tcstageNew.TimeDifference = Convert.ToDouble(dr["CurrentTime"]);

                                                //var groupedMinDates = ds.Tables[1].AsEnumerable()
                                                //    .Where(row => row["EndDate"] != DBNull.Value && Convert.ToInt64(row["IdCounterpart"]) == itemTimeTracking.IdCounterpart)
                                                //    .GroupBy(row => Convert.ToInt32(row["IdStage"]))
                                                //    .Select(g =>
                                                //    {
                                                //        var minEndDate = g.Min(r => Convert.ToDateTime(r["EndDate"]));
                                                //        var minRow = g
                                                //            .OrderBy(r => Convert.ToDateTime(r["EndDate"]))
                                                //            .ThenBy(r => Convert.ToInt32(r["IdCounterpartTracking"]))
                                                //            .First(r => Convert.ToDateTime(r["EndDate"]) == minEndDate);

                                                //        return new
                                                //        {
                                                //            IdStage = g.Key,
                                                //            MinFirstValidatedDate = minEndDate,
                                                //            FormattedDate = minEndDate.ToString("yyyy-MM-dd HH:mm:ss"),
                                                //            FullRow = minRow
                                                //        };
                                                //    })
                                                //    .ToList();

                                                //var minendate = groupedMinDates.Where(a => a.IdStage == workstage.Id).FirstOrDefault();
                                                //if (minendate != null)
                                                //{
                                                if (dr["EndDate"] != DBNull.Value)
                                                {
                                                    workstage.FirstValidatedDate = Convert.ToDateTime(dr["EndDate"]).ToString("yyyy-MM-dd HH:mm:ss");
                                                    tcstageNew.FirstValidatedDate = Convert.ToDateTime(dr["EndDate"]).ToString("yyyy-MM-dd HH:mm:ss");
                                                }
                                                // }
                                                itemTimeTracking.TimeTrackingStage.Add(workstage);

                                                workstage.Reworks = Convert.ToInt32(dr["Rework"]);
                                                workstage.IdCounterparttracking = Convert.ToInt32(dr["IdCounterpartTracking"]);
                                                workstage.TimeDifference = Convert.ToDouble(dr["CurrentTime"]);
                                                #region // [pallavi.jadhav][15 10 2025][APIGEOS-1712]
                                                if (dr["IdOperator"] != DBNull.Value)
                                                {
                                                    workstage.IdUser = Convert.ToInt32(dr["IdOperator"]);
                                                    tcstageNew.IdUser = Convert.ToInt32(dr["IdOperator"]);

                                                }
                                                if (dr["EmployeeCode"] != DBNull.Value)
                                                {
                                                    workstage.EmployeeCode = Convert.ToString(dr["EmployeeCode"]);
                                                    tcstageNew.EmployeeCode = Convert.ToString(dr["EmployeeCode"]);

                                                }
                                                if (dr["IdEmployee"] != DBNull.Value)
                                                {
                                                    workstage.IdEmployee = Convert.ToInt32(dr["IdEmployee"]);
                                                    tcstageNew.IdEmployee = Convert.ToInt32(dr["IdEmployee"]);

                                                }
                                                #endregion

                                                itemTimeTracking.WorkStage.Add(workstage);
                                            }
                                            catch (Exception ex)
                                            {
                                                // Consider logging the exception instead of just re-throwing
                                                throw;
                                            }
                                        }
                                    }
                                }
                                #endregion
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    // Log the exception details for debugging purposes
                    Console.WriteLine($"An error occurred: {ex.Message}");
                    Console.WriteLine($"Stack Trace: {ex.StackTrace}");
                    throw; // Re-throw the exception if you want it to propagate up
                }
                try
                {
                    foreach (DataRow dr in ds.Tables[2].Rows)
                    {
                        if (dr["CPProductID"] != DBNull.Value && dr["IdStage"] != DBNull.Value && dr["ExpectedTime"] != DBNull.Value)
                        {
                            List<TimetrackingAPI> UpdatetimetrackList1 = timeTrackingList.Where(i => i.IdCP == Convert.ToInt64(dr["CPProductID"])).ToList();
                            if (UpdatetimetrackList1 != null)
                            {
                                if (timeTrackingList.Any(i => i.IdCP == Convert.ToInt64(dr["CPProductID"])))
                                {
                                    if (UpdatetimetrackList1[0].WorkStage.Any(i => i.Id == Convert.ToInt32(dr["IdStage"])))
                                    {
                                        foreach (TimetrackingAPI itemTimeTracking in UpdatetimetrackList1)
                                        {
                                            WorkStage tcstage = itemTimeTracking.TimeTrackingStage.Where(i => i.Id == Convert.ToInt32(dr["IdStage"])).FirstOrDefault();
                                            if (tcstage != null)
                                            {
                                                #region App_Stage
                                                if (App_Stage.Count > 0)
                                                {
                                                    if (App_Stage.Contains(Convert.ToInt32(tcstage.Id)))
                                                    {
                                                        if (itemTimeTracking.SerialNumber.EndsWith("01"))
                                                        {
                                                            TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                            TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                            tcstage.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));
                                                            tcstage.Expected = Convert.ToDecimal(dr["ExpectedTime"]);
                                                        }
                                                        else
                                                        {
                                                            TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                            TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble(0.0));
                                                            tcstage.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));
                                                            tcstage.Expected = Convert.ToDecimal(0.0);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                        TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                        tcstage.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));
                                                        tcstage.Expected = Convert.ToDecimal(dr["ExpectedTime"]);
                                                    }
                                                }
                                                else
                                                {
                                                    TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                    TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                    tcstage.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));
                                                    tcstage.Expected = Convert.ToDecimal(dr["ExpectedTime"]);
                                                }
                                                #endregion
                                            }
                                        }
                                    }
                                    else
                                    {
                                        foreach (TimetrackingAPI itemTimeTracking in UpdatetimetrackList1)
                                        {

                                            WorkStage tcstageNew = new WorkStage();
                                            tcstageNew.Id = Convert.ToInt32(dr["IdStage"]);

                                            #region 
                                            if (App_Stage.Count > 0)
                                            {
                                                if (App_Stage.Contains(Convert.ToInt32(tcstageNew.Id)))
                                                {
                                                    if (itemTimeTracking.SerialNumber.EndsWith("01"))
                                                    {
                                                        TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                        TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                        tcstageNew.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));
                                                        tcstageNew.Expected = Convert.ToDecimal(dr["ExpectedTime"]);
                                                    }
                                                    else
                                                    {
                                                        TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                        TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((0.0)));
                                                        tcstageNew.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));
                                                        tcstageNew.Expected = Convert.ToDecimal(0.0);
                                                    }
                                                }
                                                else
                                                {
                                                    TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                    TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                    tcstageNew.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));
                                                    tcstageNew.Expected = Convert.ToDecimal(dr["ExpectedTime"]);
                                                }
                                            }
                                            else
                                            {
                                                TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                tcstageNew.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));

                                                tcstageNew.Expected = Convert.ToDecimal(dr["ExpectedTime"]);
                                                itemTimeTracking.TimeTrackingStage.Add(tcstageNew);
                                            }
                                            #endregion

                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    throw;
                }

                #region [pallavi jadhav][APIGEOS-1074][22 01 2025]
                try
                {
                    if (IsPlantActive == true)
                    {
                        foreach (DataRow dr in ds.Tables[3].Rows)   //while (dr.Read())
                        {
                            try
                            {
                                if (dr["IdCounterpart"] != DBNull.Value && dr["IdStages"] != DBNull.Value)
                                {
                                    #region [pallavi jadhav][APIGEOS-1074][22 01 2025]

                                    List<TimetrackingAPI> UpdatetimetrackList = timeTrackingList.Where(i => i.IdCounterpart == Convert.ToInt64(dr["IdCounterpart"])).ToList();  //if (UpdatetimetrackList[0].TimeTrackingStage.Any(i => i.IdStage == Convert.ToInt32(reader["IdStages"])))
                                                                                                                                                                                //{
                                    foreach (TimetrackingAPI itemTimeTrackingPDD in UpdatetimetrackList)
                                    {

                                        WorkStage tcstageByPDD = itemTimeTrackingPDD.WorkStage.Where(i => i.Id == Convert.ToInt32(dr["IdStages"])).FirstOrDefault();
                                        if (tcstageByPDD != null)
                                        {

                                            if (dr["IdStages"] != null)
                                            {
                                                tcstageByPDD.Id = Convert.ToInt32(dr["IdStages"]);
                                            }
                                            if (dr["PlanDateByStages"] != null)
                                            {
                                                tcstageByPDD.PlannedDeliveryDate = Convert.ToDateTime(dr["PlanDateByStages"]).ToString("yyyy-MM-dd");

                                            }
                                            if (itemTimeTrackingPDD.DeliveryDate != null)
                                            {
                                                int days = (Convert.ToDateTime(itemTimeTrackingPDD.DeliveryDate) - Convert.ToDateTime(tcstageByPDD.PlannedDeliveryDate)).Days;

                                                tcstageByPDD.Days = days;
                                            }
                                            itemTimeTrackingPDD.WorkStage.Add(tcstageByPDD);
                                        }
                                    }
                                    #endregion
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetTimetracking(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw ex;
                            }

                        }
                    }

                }
                catch (Exception ex)
                {

                    throw;
                }
                #endregion
                Log4NetLogger.Logger.Log(string.Format("Method GetTimetracking()....Executed successfully."), category: Category.Info, priority: Priority.Low);

                // }

                Log4NetLogger.Logger.Log(string.Format("Method GetTimetracking()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTimetracking(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            try
            {
                #region [APIGEOS-1205][gulab lakade][05 10 2024]
                for (int i = 0; i < timeTrackingList.Count; i++)
                {

                    TimeSpan TempTotalReal = TimeSpan.Parse("0");
                    TimeSpan TempTotalExpected = TimeSpan.Parse("0");
                    TimeSpan TempTotalRemaianing = TimeSpan.Parse("0");

                    if (timeTrackingList[i].WorkStage != null)
                    {
                        try
                        {
                            var FinalList = timeTrackingList[i].TimeTrackingStage.OrderBy(r => r.Startdate).ThenBy(r => r.Enddate).ToList(); // tracking wise stages
                            #region

                            string Production = string.Empty;
                            string Rework_First = string.Empty;
                            string Rework_Second = string.Empty;
                            string Rework_Third = string.Empty;
                            string Rework_Fourth = string.Empty;
                            string POWS_First = string.Empty;
                            string POWS_Second = string.Empty;
                            string POWS_Third = string.Empty;
                            string POWS_Fourth = string.Empty;
                            string ROWS_First = string.Empty;
                            string ROWS_Second = string.Empty;
                            string ROWS_Third = string.Empty;
                            string ROWS_Fourth = string.Empty;
                            #endregion

                            if (FinalList?.Count() > 0)
                            {
                                //[APIGEOS-1530][26.06.2025][rdixit]
                                ProcessWorkStages(FinalList, TimetrakingEmployeesList, timeTrackingList[i].IdCounterpart);

                                var updatedStagesList = timeTrackingList[i].WorkStage.Select(a => a.Id).Except(FinalList.Select(j => j.Id));

                                FinalList.AddRange(timeTrackingList[i].WorkStage.Where(k => updatedStagesList.Any(p => p == k.Id)));

                                if (timeTrackingList[i].SerialNumber == "2421786P008001")
                                {

                                }

                                CalculatedStagesData(FinalList, timeTrackingList[i].DesignType, CADCAMDesignTypeList);
                                #region  [07 07 2025][APIGEOS - 1531][pallavi.jadhav]
                                var groupedStages = FinalList.GroupBy(s => s.Code).Select(g =>
                                {
                                    var productionTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.ProductionTime);
                                    var reworkTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.ReworkTime);
                                    var realTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Reals);
                                    var totalRemaining = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Remaining);

                                    string productionStr = productionTime.ToString(@"hh\:mm\:ss");
                                    string reworkStr = reworkTime.ToString(@"hh\:mm\:ss");
                                    string realStr = realTime.ToString(@"hh\:mm\:ss");

                                    // Apply your logic
                                    if (reworkStr == "00:00:00" && productionStr == "00:00:00" && realStr == "00:00:00")
                                    {
                                        reworkStr = "";
                                        productionStr = "";
                                        realStr = "";
                                    }
                                    else if (reworkStr == "00:00:00" && productionStr != "00:00:00")
                                    {
                                        if (productionTime != TimeSpan.Zero)
                                        {
                                            reworkStr = "00:00:00";
                                        }
                                        else
                                        {
                                            reworkStr = "";
                                            productionStr = "";
                                        }
                                    }
                                    else if (reworkStr == "00:00:00" && productionStr == "00:00:00")
                                    {
                                        reworkStr = "";
                                        productionStr = "";
                                    }

                                    return new WorkStage
                                    {
                                        Code = g.Key,
                                        Id = g.First().Id,
                                        Name = g.First().Name,
                                        FirstValidatedDate = g.First().FirstValidatedDate,
                                        Sequence = g.First().Sequence,
                                        Employees = g.Where(x => x.Employees != null).SelectMany(x => x.Employees).Where(b => b.EmployeeCode != "").GroupBy(a => a.IdEmployee)
                                                                 .Select(e => new TimetrakingEmployees
                                                                 {
                                                                     IdEmployee = e.First().IdEmployee,
                                                                     IdUser = e.First().IdUser,
                                                                     EmployeeCode = e.First().EmployeeCode,
                                                                     Production = e.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.ProductionTime).ToString(@"hh\:mm\:ss"),
                                                                     Production_OWS = e.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Production_OWSTime).ToString(@"hh\:mm\:ss"),
                                                                     RealTime = e.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Reals).ToString(@"hh\:mm\:ss"),
                                                                     Rework = e.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.ReworkTime).ToString(@"hh\:mm\:ss"),
                                                                     Rework_OWS = e.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Rework_OWSTime).ToString(@"hh\:mm\:ss"),
                                                                 }).ToList(),
                                        // TimeSpan properties
                                        ProductionTime = productionTime,
                                        Production_OWSTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Production_OWSTime),
                                        ReworkTime = reworkTime,
                                        Rework_OWSTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Rework_OWSTime),
                                        Expecteds = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Expecteds),
                                        Reals = realTime,
                                        Remaining = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Remaining),

                                        // String versions with conditionally blanked values
                                        Production = productionStr,
                                        Rework = reworkStr,
                                        RealTime = realStr,

                                        Production_OWS = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Production_OWSTime).ToString(@"hh\:mm\:ss"),
                                        Rework_OWS = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Rework_OWSTime).ToString(@"hh\:mm\:ss"),
                                        ExpectedTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Expecteds).ToString(@"hh\:mm\:ss"),
                                        // RemainingTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Remaining).ToString(@"hh\:mm\:ss"),
                                        RemainingTime = (totalRemaining < TimeSpan.Zero ? "-" : "") + totalRemaining.Duration().ToString(@"hh\:mm\:ss"),

                                        Reworks = g.Sum(s => s.Reworks),
                                        Paused = g.Any(s => s.Paused)
                                    };
                                }).ToList();

                                FinalList = groupedStages;
                                #endregion
                            }


                            var teee = timeTrackingList[i].WorkStage;
                            timeTrackingList[i].WorkStage = new List<WorkStage>();

                            if (!string.IsNullOrEmpty(Stage))
                            {
                                string[] stageArray = Stage.Split(',');

                                List<string> IntList = new List<string>();
                                foreach (var stage in stageArray)
                                {
                                    IntList.Add(stage);
                                }
                                if (FinalList.Count > 0)
                                {
                                    if (FinalList.Where(a => IntList.Contains(Convert.ToString(a.Id))).ToList().Count > 0)
                                    {
                                        timeTrackingList[i].WorkStage = FinalList.Where(a => IntList.Contains(Convert.ToString(a.Id))).OrderBy(a => a.Id).ToList();
                                    }
                                }
                            }
                            else
                            {
                                timeTrackingList[i].WorkStage = FinalList.OrderBy(a => a.Id).ToList();
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetTimeTraking(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw ex;
                        }
                    }
                }
                #endregion

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTimeTraking(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            try
            {

                List<ReworkData> OTsWithIDOTItemList = new List<ReworkData>();
                List<ReworkData> OTsWithIDDrawingList = new List<ReworkData>();

                for (int i = 0; i < timeTrackingList.Count; i++)
                {
                    List<WorkStage> StageReworksList = new List<WorkStage>();

                    timeTrackingList[i].TotalRework = timeTrackingList[i].TotalRework;

                    if (timeTrackingList[i].IsBatch == false && timeTrackingList[i].TotalRework > 0)
                    {
                        if (timeTrackingList[i].IdOTItem != 0)
                        {
                            var TempIdOTItem = OTsWithIDOTItemList.Where(j => j.IdOT == timeTrackingList[i].IdOt && j.IdOTItem == timeTrackingList[i].IdOTItem).FirstOrDefault();

                            if (TempIdOTItem == null)
                            {
                                ReworkData TempReworkOTItem = new ReworkData();

                                TempReworkOTItem.IdOT = timeTrackingList[i].IdOt;
                                TempReworkOTItem.IdOTItem = timeTrackingList[i].IdOTItem;
                                TempReworkOTItem.IdCounterpart = timeTrackingList[i].IdCounterpart;
                                OTsWithIDOTItemList.Add(TempReworkOTItem);
                                //FlagNewAlgorithmCOM = false;
                            }
                            else
                            {
                                // Update rework for COM stage in Time tracking Lists to display in Time tracking grid 
                                if (timeTrackingList[i].WorkStage != null)
                                {
                                    StageReworksList = timeTrackingList[i].TimeTrackingStage.Where(j => OtItemStagesList.Contains(j.NewIdStage) && j.Reworks == 1).ToList();

                                    if (StageReworksList.Count > 0)  // Update rework only if rework is related to specific stage.
                                    {
                                        if (timeTrackingList[i].TotalRework > 0)
                                        {
                                            timeTrackingList[i].TotalRework = timeTrackingList[i].TotalRework - (int)StageReworksList.Count;
                                            timeTrackingList[i].TotalRework = timeTrackingList[i].TotalRework;
                                        }

                                    }
                                }
                            }
                        }

                        if (timeTrackingList[i].IdDrawing != 0)
                        {
                            var TempIdDrawing = OTsWithIDDrawingList.Where(j => j.IdOT == timeTrackingList[i].IdOt && j.IdDrawing == timeTrackingList[i].IdDrawing).FirstOrDefault();
                            if (TempIdDrawing == null)
                            {
                                ReworkData TempReworkDrawing = new ReworkData();

                                TempReworkDrawing.IdOT = timeTrackingList[i].IdOt;
                                TempReworkDrawing.IdOTItem = timeTrackingList[i].IdOTItem;
                                TempReworkDrawing.IdCounterpart = timeTrackingList[i].IdCounterpart;
                                TempReworkDrawing.IdDrawing = timeTrackingList[i].IdDrawing;
                                OTsWithIDDrawingList.Add(TempReworkDrawing);
                            }
                            else
                            {
                                // Update rework for CAD & CAM stage in ProductionOutPutReport & AllPlantWeeklyReworksMail Lists to display in mail 

                                StageReworksList = new List<WorkStage>();
                                if (timeTrackingList[i].WorkStage != null)
                                {
                                    StageReworksList = timeTrackingList[i].TimeTrackingStage.Where(j => DrawingIdStagesList.Contains(j.NewIdStage) && j.Reworks == 1).ToList();

                                    if (StageReworksList.Count > 0)  // Update rework only if rework is related to specific stage.
                                    {
                                        timeTrackingList[i].TotalRework = timeTrackingList[i].TotalRework - (int)StageReworksList.Count;
                                        timeTrackingList[i].TotalRework = timeTrackingList[i].TotalRework;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error IsEMDEPSiteExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }


            return timeTrackingList;
        }
        public static List<TimetrackingAPI> GetTimeTrackingBYPlant(Int64 idSite, string FromDeliveryDate, string ToDeliveryDate, string Stage, string Currency, string SiteName, string Plantwiseconnectionstring, string emdepconn, List<WorkStage> AllProductioStage)
        {
            List<TimetrakingEmployees> TimetrakingEmployeesList = new List<TimetrakingEmployees>();
            List<TimetrackingAPI> timeTrackingList = new List<TimetrackingAPI>();
            #region 
            List<int> OtItemStagesList = new List<int>();
            List<int> DrawingIdStagesList = new List<int>();
            StageByOTItemAndIDDrawingAPI TimetrackingStagesList = new StageByOTItemAndIDDrawingAPI();
            List<CurrencyRateListByDate> AllCurrencyRateList = new List<CurrencyRateListByDate>();//[rani dhamankar][APIGEOS-1317][28-01-2025]
            string connString = Plantwiseconnectionstring;
            bool IsPlantActiveByPlant = false;//[pallavi jadhav][APIGEOS-1074][30 01 2024]
            #endregion
            var tasks = new List<Task>();
            // = new StageByOTItemAndIDDrawing();
            tasks.Add(Task.Run(() => TimetrackingStagesList = GetAllStagesPerIDOTItemAndIDDrawing_V2500(Plantwiseconnectionstring)));
            Task.WaitAll(tasks.ToArray());
            FillCADCAMDesignTypeListByPlant(emdepconn);
            #region //[rani dhamankar][APIGEOS-1317][29-01-2025]
            string[] Currencies = new string[0];
            string[] RemainingCurrencies = new string[0];
            if (!string.IsNullOrEmpty(Currency))
            {
                if (Currency.Contains(","))
                {
                    Currencies = Currency.Split(',');
                    RemainingCurrencies = Currencies.Skip(1).ToArray();
                }
                else
                {
                    Currencies = new string[] { Currency };
                }
            }
            #endregion


            //#region
            List<int> App_Stage = new List<int>();
            App_Stage = new List<int>();
            try
            {
                // string ConnectionString = this._ConnEmdepGeosString;
                // GeosAppSetting Setting = crmmanager.GetGeosAppSettings(96, workbenchConnectionString);
                GeosAppSettingAPI Setting = GetGeosAppSettingsemdep(96, emdepconn);
                if (!string.IsNullOrEmpty(Setting.defaultValue))
                {
                    List<string> tempApp_Stage = Convert.ToString(Setting.defaultValue).Split(',').ToList<string>();

                    foreach (var item in tempApp_Stage)
                    {
                        App_Stage.Add(Convert.ToInt32(item));
                    }
                }
                #region [pallavi jadhav][APIGEOS-1074][30 01 2024]

                GeosAppSettingAPI AppSetting = new GeosAppSettingAPI();

                List<int> App_StageActivePlant = new List<int>();
                App_StageActivePlant = new List<int>();

                AppSetting = GetGeosAppSettingsemdep(134, emdepconn);

                if (!string.IsNullOrEmpty(AppSetting.defaultValue))
                {
                    List<string> tempApp_Stage = Convert.ToString(AppSetting.defaultValue).Split(',').ToList<string>();

                    foreach (var item in tempApp_Stage)
                    {
                        App_StageActivePlant.Add(Convert.ToInt32(item));
                    }
                }

                #region [pallavi jadhav][APIGEOS-1074][30 01 2024]
                if (App_StageActivePlant != null && App_StageActivePlant.Count > 0)
                {
                    var tempApp_Stage = App_StageActivePlant.Where(a => a == idSite).ToList();
                    if (tempApp_Stage != null && tempApp_Stage.Count > 0)
                    {
                        IsPlantActiveByPlant = true;
                    }
                }

                #endregion
                #endregion
            }
            catch (Exception ex) { }
            //#endregion
            try
            {
                DataSet ds = new DataSet();
                using (MySqlConnection conn = new MySqlConnection(Plantwiseconnectionstring))
                {
                    conn.Open();
                    //MySqlCommand command = new MySqlCommand("GEOSAPI_GetProductionTimeTracking_V540", conn);
                    //MySqlCommand command = new MySqlCommand("APIERM_GetAllTimeTrackingBYPlant_V560", conn);
                    //  MySqlCommand command = new MySqlCommand("APIERM_GetAllTimeTrackingBYPlant_V580", conn);
                    //MySqlCommand command = new MySqlCommand("APIERM_GetAllTimeTrackingBYPlant_V690", conn);
                    //MySqlCommand command = new MySqlCommand("APIERM_GetAllTimeTrackingBYPlant_V740", conn); // [pallavi jadhav][APIGEOS-1189][27-08-2024]
                    //  MySqlCommand command = new MySqlCommand("APIERM_GetAllTimeTrackingBYPlant_V790", conn);//[rani dhamankar][APIGEOS-1317][30-01-2025]
                    //[pallavi jadhav][APIGEOS-1329][28-04-2025]
                    //[APIGEOS-1530][26.06.2025][rdixit]
                    MySqlCommand command = new MySqlCommand("APIERM_GetAllTimeTrackingBYPlant_V870", conn);//[pallavi.jadhav][15 10 2025][APIGEOS-1712]
                    command.CommandType = CommandType.StoredProcedure;
                    if (idSite == 0)
                        command.Parameters.AddWithValue("_idSite", null);
                    else
                        command.Parameters.AddWithValue("_idSite", idSite);
                    //command.Parameters.AddWithValue("_DeliveryWeek", deliveryWeek);
                    command.Parameters.AddWithValue("_FromDeliveryDate", Convert.ToDateTime(FromDeliveryDate)); // [pallavi jadhav][APIGEOS-1317][29 01 2025]
                    command.Parameters.AddWithValue("_ToDeliveryDate", Convert.ToDateTime(ToDeliveryDate));// [pallavi jadhav][APIGEOS-1317][29 01 2025]
                                                                                                           //  command.Parameters.AddWithValue("_Stage", Stage);
                                                                                                           //command.Parameters.AddWithValue("_Currency", Currency);
                    command.Parameters.AddWithValue("_Currency", Currencies.Length > 0 && !string.IsNullOrEmpty(Currencies[0]) ? Currencies[0].ToUpper() : "EUR");//[rani dhamankar][APIGEOS-1317][30-01-2025]
                    command.CommandTimeout = 120;
                    #region  [rani dhamankar][APIGEOS-1317][28-01-2025]

                    using (MySqlDataAdapter adap = new MySqlDataAdapter(command))
                    {
                        adap.Fill(ds);


                    }
                    #endregion
                }
                try
                {

                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                    {
                        DateTime? minDate = null;
                        DateTime? maxDate = null;

                        // Efficient single loop to find min/max date
                        foreach (DataRow row in ds.Tables[0].Rows)
                        {
                            var deliveryDate = row.Field<DateTime>("DeliveryDate");
                            if (minDate == null || deliveryDate < minDate) minDate = deliveryDate;
                            if (maxDate == null || deliveryDate > maxDate) maxDate = deliveryDate;
                        }

                        if (minDate.HasValue && maxDate.HasValue)
                        {
                            // Split into 4 parallel tasks (tweak chunk count based on performance testing)
                            int totalDays = (maxDate.Value - minDate.Value).Days;
                            int chunkCount = 4;
                            int chunkSize = Math.Max(1, totalDays / chunkCount);

                            List<Task<List<CurrencyRateListByDate>>> task = new List<Task<List<CurrencyRateListByDate>>>();

                            for (int i = 0; i < chunkCount; i++)
                            {
                                DateTime chunkStart = minDate.Value.AddDays(i * chunkSize);
                                DateTime chunkEnd = (i == chunkCount - 1) ? maxDate.Value : chunkStart.AddDays(chunkSize - 1);

                                // Schedule the task for each date range
                                task.Add(Task.Run(() =>
                                    GetAllCurrencyDetailsBYPlant(chunkStart, chunkEnd, Plantwiseconnectionstring)
                                ));
                            }

                            Task.WaitAll(task.ToArray());

                            // Combine results from all tasks
                            AllCurrencyRateList = task.SelectMany(t => t.Result).ToList();
                        }
                    }
                    //if (ds != null)
                    //{
                    //    if (ds.Tables[0].Rows.Count > 0)
                    //    {
                    //        var minDate = ds.Tables[0].AsEnumerable()
                    //                       .Min(row => row.Field<DateTime>("DeliveryDate"));

                    //        var maxDate = ds.Tables[0].AsEnumerable()
                    //                                       .Max(row => row.Field<DateTime>("DeliveryDate"));
                    //        AllCurrencyRateList = GetAllCurrencyDetailsBYPlant(Convert.ToDateTime(minDate), Convert.ToDateTime(maxDate), Plantwiseconnectionstring);
                    //        if (AllCurrencyRateList == null)
                    //        {

                    //        }
                    //    }
                    //}
                }
                catch (Exception ex)
                {

                    throw;
                }
                //using (MySqlDataReader dr = command.ExecuteReader())
                //{
                TimetrackingAPI timeTrackings = new TimetrackingAPI();
                foreach (DataRow dr in ds.Tables[0].Rows)// while (dr.Read())
                {
                    try
                    {

                        TimetrackingAPI timeTracking = new TimetrackingAPI();
                        if (dr["DeliveryWeek"] != DBNull.Value)
                        {
                            timeTracking.DeliveryWeek = Convert.ToString(dr["DeliveryWeek"].ToString());
                        }
                        if (dr["CPProductID"] != DBNull.Value)
                        {
                            timeTracking.CPProductID = Convert.ToInt32(dr["CPProductID"]);
                        }
                        if (dr["IdCP"] != DBNull.Value)
                        {
                            timeTracking.IdCP = Convert.ToInt32(dr["IdCP"]);
                        }
                        if (dr["IdCounterpart"] != DBNull.Value)
                        {
                            timeTracking.IdCounterpart = Convert.ToInt32(dr["IdCounterpart"]);
                        }
                        if (dr["DeliveryDate"] != DBNull.Value)
                        {
                            timeTracking.DeliveryDate = Convert.ToDateTime(dr["DeliveryDate"]).ToString("yyyy-MM-dd");
                        }
                        if (dr["PlannedDeliveryDate"] != DBNull.Value) //Chitra[cgirigosavi] [APIGEOS-720] [20 02 2023]
                        {
                            timeTracking.PlannedDeliveryDate = Convert.ToDateTime(dr["PlannedDeliveryDate"]).ToString("yyyy-MM-dd");
                        }
                        //if (dr["FirstDeliveryDate"] != DBNull.Value)
                        //{
                        //    timeTracking.FirstDeliveryDate = Convert.ToDateTime(dr["FirstDeliveryDate"]).ToString("yyyy-MM-dd");
                        //}
                        if (dr["FirstDeliveryDate"] != DBNull.Value)
                        {
                            try
                            {
                                timeTracking.FirstDeliveryDate = Convert.ToDateTime(dr["FirstDeliveryDate"]).ToString("yyyy-MM-dd");

                                if (timeTracking.FirstDeliveryDate == timeTracking.DeliveryDate)
                                {
                                    timeTracking.FirstDeliveryDate = null;
                                }
                            }
                            catch (Exception ex)
                            {
                                timeTracking.FirstDeliveryDate = null;
                            }
                        }
                        if (dr["QuoteSendDate"] != DBNull.Value)
                        {
                            timeTracking.QuoteSendDate = Convert.ToDateTime(dr["QuoteSendDate"]).ToString("yyyy-MM-dd");
                        }
                        //[plahange][APIGEOS-701][28/02/2023]
                        if (dr["Samples"] != DBNull.Value)
                        {
                            timeTracking.Samples = Convert.ToString(dr["Samples"].ToString());
                        }
                        if (dr["SampleReceivedIn"] != DBNull.Value)
                        {
                            timeTracking.SamplesDate = Convert.ToDateTime(dr["SampleReceivedIn"]).ToString("yyyy-MM-dd");
                            if (timeTracking.SamplesDate.Equals(DateTime.MinValue.ToString("yyyy-MM-dd")))
                            {
                                timeTracking.SamplesDate = "";
                            }
                        }
                        if (dr["GoAheadDate"] != DBNull.Value)
                        {
                            timeTracking.GoAheadDate = Convert.ToDateTime(dr["GoAheadDate"]).ToString("yyyy-MM-dd");
                        }
                        if (dr["PODate"] != DBNull.Value)
                        {
                            timeTracking.PODate = Convert.ToDateTime(dr["PODate"]).ToString("yyyy-MM-dd");
                        }
                        if (dr["AvailForDesignDate"] != DBNull.Value)
                        {
                            timeTracking.AvailableforDesignDate = Convert.ToDateTime(dr["AvailForDesignDate"]).ToString("yyyy-MM-dd");
                        }
                        if (dr["POType"] != DBNull.Value)
                        {
                            timeTracking.POType = Convert.ToString(dr["POType"].ToString());
                        }
                        if (dr["Customer"] != DBNull.Value)
                        {
                            timeTracking.Customer = Convert.ToString(dr["Customer"].ToString());
                        }
                        if (dr["Project"] != DBNull.Value)
                        {
                            timeTracking.Project = Convert.ToString(dr["Project"].ToString());
                        }
                        if (dr["Offer"] != DBNull.Value)
                        {
                            timeTracking.Offer = Convert.ToString(dr["Offer"].ToString());
                        }
                        if (dr["OTCode"] != DBNull.Value)
                        {
                            timeTracking.OTCode = Convert.ToString(dr["OTCode"].ToString());
                        }

                        if (Convert.ToString(dr["SerialNumber"]) == "1803228L005001")
                        {

                        }
                        //  timeTracking.OriginPlant = SiteName;

                        if (dr["OriginalPlant"] != DBNull.Value)  //[pallavi.jadhav][29 08 205] [APIGEOS-1618]
                        {
                            timeTracking.OriginPlant = Convert.ToString(dr["OriginalPlant"]);
                        }

                        if (dr["ProductionPlant"] != DBNull.Value)
                        {
                            timeTracking.ProductionPlant = Convert.ToString(dr["ProductionPlant"]);
                        }


                        if (dr["Reference"] != DBNull.Value)
                        {
                            timeTracking.CustomerReference = Convert.ToString(dr["Reference"]);
                        }
                        if (dr["Template"] != DBNull.Value)
                        {
                            timeTracking.Template = Convert.ToString(dr["Template"]);
                        }
                        if (dr["Type"] != DBNull.Value)
                        {
                            timeTracking.Type = Convert.ToString(dr["Type"]);
                        }
                        //if (dr["QTY"] != DBNull.Value)
                        //{
                        //    timeTracking.QTY = Convert.ToInt32(dr["QTY"]);
                        //}
                        Int64 totalQTY = 0;
                        if (dr["QTY"] != DBNull.Value)
                        {
                            totalQTY = Convert.ToInt32(dr["QTY"]);
                            if (totalQTY > 1)
                            {
                                timeTracking.QTY = 1;
                            }
                            else
                            {
                                timeTracking.QTY = Convert.ToInt32(dr["QTY"]);
                            }

                        }
                        #region  [rani dhamankar][APIGEOS-1317][28-01-2025]
                        ERM_SalesPrices ermSalesPrices = new ERM_SalesPrices();
                        List<ERM_SalesPrices> cloneAllSalesprice = new List<ERM_SalesPrices>();
                        ermSalesPrices.IdCurrency = Convert.ToInt32(dr["IdCurrency"]); ;
                        ermSalesPrices.Currency = Convert.ToString(dr["CurrencySalePrice"]); ;
                        ermSalesPrices.UnitSalePrice = timeTracking.UnitSalePrice;
                        ermSalesPrices.TotalSalePrice = Math.Round(timeTracking.UnitSalePrice * timeTracking.QTY, 2, MidpointRounding.AwayFromZero);
                        cloneAllSalesprice.Add(ermSalesPrices);
                        try
                        {
                            if (!string.IsNullOrEmpty(Currency))
                            {

                                if (RemainingCurrencies.Length > 0)
                                {
                                    foreach (var cur in RemainingCurrencies)
                                    {
                                        double CurConversionRate = 0;
                                        var Curid = AllCurrencyRateList.Where(x => x.Currency == cur).Select(x => x.IdCurrency).FirstOrDefault();
                                        var tmpCurrencyRate = AllCurrencyRateList.Where(a => a.CurrencyFrom == dr["IdCurrency"].ToString() && a.CurrencyTo == Curid.ToString() && (a.ConversionDate >= Convert.ToDateTime(timeTracking.DeliveryDate) && a.ConversionDate <= Convert.ToDateTime(timeTracking.DeliveryDate))).FirstOrDefault();
                                        if (tmpCurrencyRate == null)
                                        {
                                            tmpCurrencyRate = AllCurrencyRateList.Where(a => a.CurrencyFrom == dr["IdCurrency"].ToString() && a.CurrencyTo == Curid.ToString()).FirstOrDefault();
                                        }
                                        if (tmpCurrencyRate != null)
                                        {
                                            CurConversionRate = tmpCurrencyRate.ConversionRate;
                                        }
                                        ERM_SalesPrices ermSalesPricesDetails = new ERM_SalesPrices();
                                        ermSalesPricesDetails.IdCurrency = Curid;
                                        ermSalesPricesDetails.Currency = cur;
                                        ermSalesPricesDetails.UnitSalePrice = Math.Round(timeTracking.UnitSalePrice * CurConversionRate, 2, MidpointRounding.AwayFromZero);
                                        ermSalesPricesDetails.TotalSalePrice = Math.Round(timeTracking.UnitSalePrice * timeTracking.QTY * CurConversionRate, 2, MidpointRounding.AwayFromZero);
                                        cloneAllSalesprice.Add(ermSalesPricesDetails);

                                    }
                                }
                            }
                            timeTracking.SalesPrices = cloneAllSalesprice;


                            if (dr["workbook_drawing"] != DBNull.Value)
                            {
                                timeTracking.WorkbookDrawing = Convert.ToString(dr["workbook_drawing"]);
                            }
                            if (dr["DesignSystem"] != DBNull.Value)
                            {
                                timeTracking.DesignSystem = Convert.ToString(dr["DesignSystem"]);
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetTimeTraking(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw ex;
                        }
                        #endregion

                        //if (dr["CurrencySalePrice"] != DBNull.Value)
                        //{
                        //    timeTracking.CurrencySalePrice = Convert.ToString(dr["CurrencySalePrice"]);
                        //}
                        //if (dr["Unit"] != DBNull.Value)
                        //{
                        //    timeTracking.UnitSalePrice = Math.Round(Convert.ToDouble(dr["Unit"]), 2, MidpointRounding.AwayFromZero);
                        //}
                        //if (timeTracking.QTY != null && timeTracking.UnitSalePrice != null)
                        //{
                        //    timeTracking.TotalSalePrice = Math.Round(timeTracking.UnitSalePrice * timeTracking.QTY, 2, MidpointRounding.AwayFromZero);
                        //}
                        if (dr["SerialNumber"] != DBNull.Value)
                        {
                            timeTracking.SerialNumber = Convert.ToString(dr["SerialNumber"]);
                        }
                        if (dr["itemStatus"] != DBNull.Value)
                        {
                            timeTracking.ItemStatus = Convert.ToString(dr["itemStatus"]);
                        }
                        if (dr["DrawingType"] != DBNull.Value)
                        {
                            timeTracking.DesignType = Convert.ToString(dr["DrawingType"]);
                        }
                        if (dr["TrayName"] != DBNull.Value)
                        {
                            timeTracking.Tray = Convert.ToString(dr["TrayName"]);
                        }
                        if (dr["cutWorkStation"] != DBNull.Value)
                        {
                            timeTracking.CurrentWorkStation = Convert.ToString(dr["cutWorkStation"]);
                        }
                        if (dr["Rework"] != DBNull.Value)
                        {
                            timeTracking.TotalRework = Convert.ToInt32(dr["Rework"]);
                        }
                        #region
                        if (dr["IsBatch"] != DBNull.Value)
                        {
                            if (Convert.ToInt32(dr["IsBatch"]) == 1)
                            {
                                timeTracking.IsBatch = true;
                            }
                            else
                            {
                                timeTracking.IsBatch = false;
                            }
                        }

                        if (dr["IdOTItem"] != DBNull.Value)
                        {
                            timeTracking.IdOTItem = Convert.ToInt64(dr["IdOTItem"]);
                        }

                        if (dr["IdDrawing"] != DBNull.Value)
                        {
                            timeTracking.IdDrawing = Convert.ToInt64(dr["IdDrawing"]);
                        }
                        if (dr["IdOT"] != DBNull.Value)
                        {
                            timeTracking.IdOt = Convert.ToInt64(dr["IdOT"]);
                        }
                        #endregion
                        if (timeTracking.WorkStage == null)
                        {
                            if (timeTracking == null)
                                timeTracking = new TimetrackingAPI();

                            if (timeTracking.WorkStage == null)
                                timeTracking.WorkStage = new List<WorkStage>();
                            //timeTracking = new TimeTracking(); // This is missing in your code

                            //timeTracking.WorkStage = new List<WorkStage>();
                            List<WorkStage> cloneAllProductioStage = new List<WorkStage>();
                            for (int i = 0; i < AllProductioStage.Count; i++)
                            {
                                WorkStage workStage = new WorkStage();
                                workStage.IdCP = timeTracking.IdCP;
                                workStage.IdCounterpart = timeTracking.IdCounterpart;
                                workStage.Code = AllProductioStage[i].Code;
                                workStage.Name = AllProductioStage[i].Name;
                                workStage.Id = AllProductioStage[i].Id;
                                workStage.Sequence = AllProductioStage[i].Sequence;
                                if (string.IsNullOrEmpty(AllProductioStage[i].ActiveInPlants.ToString()))
                                {
                                    cloneAllProductioStage.Add(workStage);
                                }
                                else
                                {
                                    bool idSiteFound = false;
                                    // Split the ActiveInPlants string by ',' to get individual ids
                                    string[] activeInPlantIds = AllProductioStage[i].ActiveInPlants.Split(',');
                                    idSiteFound = activeInPlantIds.ToList().Any(k => Convert.ToInt32(k.Trim()) == idSite);
                                    if (idSiteFound)
                                    {
                                        cloneAllProductioStage.Add(workStage);
                                    }
                                }
                                // cloneAllProductioStage.Add(workStage);
                            }


                            timeTracking.WorkStage.AddRange(cloneAllProductioStage);
                            timeTracking.WorkStage.ForEach(f => f.IdCP = timeTracking.IdCP);
                            timeTracking.WorkStage.ForEach(f => f.IdCounterpart = timeTracking.IdCounterpart);
                            //}
                        }
                        else
                        {
                            if (timeTracking == null)
                                timeTracking = new TimetrackingAPI();

                            if (timeTracking.WorkStage == null)
                                timeTracking.WorkStage = new List<WorkStage>();
                            //timeTracking = new TimeTracking(); // This is missing in your code

                            //timeTracking.WorkStage = new List<WorkStage>();
                            List<WorkStage> cloneAllProductioStage = new List<WorkStage>();
                            for (int i = 0; i < AllProductioStage.Count; i++)
                            {
                                WorkStage workStage = new WorkStage();
                                workStage.IdCP = timeTracking.IdCP;
                                workStage.IdCounterpart = timeTracking.IdCounterpart;
                                workStage.Code = AllProductioStage[i].Code;
                                workStage.Name = AllProductioStage[i].Name;
                                workStage.Id = AllProductioStage[i].Id;
                                workStage.Sequence = AllProductioStage[i].Sequence;
                                if (string.IsNullOrEmpty(AllProductioStage[i].ActiveInPlants.ToString()))
                                {
                                    cloneAllProductioStage.Add(workStage);
                                }
                                else
                                {
                                    bool idSiteFound = false;
                                    // Split the ActiveInPlants string by ',' to get individual ids
                                    string[] activeInPlantIds = AllProductioStage[i].ActiveInPlants.Split(',');
                                    idSiteFound = activeInPlantIds.ToList().Any(k => Convert.ToInt32(k.Trim()) == idSite);
                                    if (idSiteFound)
                                    {
                                        cloneAllProductioStage.Add(workStage);
                                    }
                                }
                                // cloneAllProductioStage.Add(workStage);
                            }


                            timeTracking.WorkStage.AddRange(cloneAllProductioStage);
                            timeTracking.WorkStage.ForEach(f => f.IdCP = timeTracking.IdCP);
                            timeTracking.WorkStage.ForEach(f => f.IdCounterpart = timeTracking.IdCounterpart);
                        }
                        timeTrackingList.Add(timeTracking);
                        timeTrackings = timeTracking;
                    }
                    catch (Exception ex)
                    {

                    }
                }
                //int count = 0;
                //if (dr.NextResult())
                //{
                try
                {
                    if (ds.Tables.Count > 1 && ds.Tables[1].Rows.Count > 0)
                    {
                        foreach (DataRow dr in ds.Tables[1].Rows)
                        {
                            // timeTracking = new TimeTracking(); // Assuming this is initialized elsewhere or at the start of the loop

                            if (dr.Table.Columns.Contains("IdCounterpart") && dr["IdCounterpart"] != DBNull.Value)
                            {
                                #region pallavi

                                List<TimetrackingAPI> UpdatetimetrackList = timeTrackingList.Where(i => i.IdCounterpart == Convert.ToInt64(dr["IdCounterpart"])).ToList();

                                // *** IMPORTANT: Add this check to ensure UpdatetimetrackList is not empty ***
                                if (UpdatetimetrackList.Any()) // Checks if there are any elements in the list
                                {
                                    // Your original condition, now safe to access UpdatetimetrackList[0]
                                    if (UpdatetimetrackList[0].TimeTrackingStage.Any(i => i.Id == Convert.ToInt32(dr["IdStage"])))
                                    {
                                        foreach (TimetrackingAPI itemTimeTracking in UpdatetimetrackList)
                                        {
                                            try
                                            {
                                                WorkStage test = itemTimeTracking.WorkStage.Where(i => i.Id == Convert.ToInt32(dr["IdStage"])).FirstOrDefault();

                                                // Ensure 'test' is not null before proceeding to avoid NullReferenceException
                                                if (test == null)
                                                {
                                                    // Handle the case where the WorkStage with the given Id is not found in itemTimeTracking.WorkStage
                                                    // You might want to log this or create a new WorkStage object
                                                    continue; // Skip to the next itemTimeTracking
                                                }

                                                if (itemTimeTracking.TimeTrackingStage == null)
                                                {
                                                    itemTimeTracking.TimeTrackingStage = new List<WorkStage>();
                                                }
                                                WorkStage workstage = new WorkStage();
                                                TimeTrackingCurrentStageAPI tcstageNew = new TimeTrackingCurrentStageAPI();
                                                // start[suggetion of matos and PPC team meeting][30 - 09 - 2025]
                                                tcstageNew.IdStage = Convert.ToInt32(dr["IdStage"]);
                                                if (dr["Sequence"] != DBNull.Value)
                                                {
                                                    workstage.Sequence = Convert.ToInt32(dr["Sequence"]);
                                                    tcstageNew.Sequence = Convert.ToInt32(dr["Sequence"]);

                                                }
                                                //  End[suggetion of matos and PPC team meeting][30 - 09 - 2025]
                                                if (dr["IdStage"] != DBNull.Value)
                                                {
                                                    workstage.Id = Convert.ToInt32(dr["IdStage"]);
                                                    test.Id = Convert.ToInt32(dr["IdStage"]);
                                                }
                                                if (dr["WorkStageCode"] != DBNull.Value)
                                                {
                                                    workstage.Code = Convert.ToString(dr["WorkStageCode"]);
                                                    test.Code = Convert.ToString(dr["WorkStageCode"]);
                                                }
                                                if (dr["WorkStageName"] != DBNull.Value)
                                                {
                                                    workstage.Name = Convert.ToString(dr["WorkStageName"]);
                                                    test.Name = Convert.ToString(dr["WorkStageName"]);
                                                }
                                                #region
                                                if (dr["IdStage"] != DBNull.Value)
                                                {
                                                    tcstageNew.NewIdStage = Convert.ToInt32(dr["IdStage"]);
                                                    workstage.NewIdStage = Convert.ToInt32(dr["IdStage"]);
                                                    test.NewIdStage = Convert.ToInt32(dr["IdStage"]);
                                                }

                                                #endregion

                                                if (dr["StartDate"] != DBNull.Value) // Changed from != null to != DBNull.Value
                                                {
                                                    tcstageNew.Startdate = Convert.ToDateTime(dr["StartDate"]);
                                                    workstage.Startdate = Convert.ToDateTime(dr["StartDate"]);
                                                    test.Startdate = Convert.ToDateTime(dr["StartDate"]);
                                                }
                                                if (dr["EndDate"] != DBNull.Value)
                                                {
                                                    tcstageNew.Enddate = Convert.ToDateTime(dr["EndDate"]);
                                                    workstage.Enddate = Convert.ToDateTime(dr["EndDate"]);
                                                    test.Enddate = Convert.ToDateTime(dr["EndDate"]);
                                                }

                                                tcstageNew.Rework = Convert.ToInt32(dr["Rework"]);
                                                tcstageNew.IdCounterparttracking = Convert.ToInt32(dr["IdCounterpartTracking"]);
                                                tcstageNew.TimeDifference = Convert.ToDouble(dr["CurrentTime"]);

                                                //var groupedMinDates = ds.Tables[1].AsEnumerable()
                                                //    .Where(row => row["EndDate"] != DBNull.Value && Convert.ToInt64(row["IdCounterpart"]) == itemTimeTracking.IdCounterpart)
                                                //    .GroupBy(row => Convert.ToInt32(row["IdStage"]))
                                                //    .Select(g =>
                                                //    {
                                                //        var minEndDate = g.Min(r => Convert.ToDateTime(r["EndDate"]));
                                                //        var minRow = g
                                                //            .OrderBy(r => Convert.ToDateTime(r["EndDate"]))
                                                //            .ThenBy(r => Convert.ToInt32(r["IdCounterpartTracking"]))
                                                //            .First(r => Convert.ToDateTime(r["EndDate"]) == minEndDate);

                                                //        return new
                                                //        {
                                                //            IdStage = g.Key,
                                                //            MinFirstValidatedDate = minEndDate,
                                                //            FormattedDate = minEndDate.ToString("yyyy-MM-dd HH:mm:ss"),
                                                //            FullRow = minRow
                                                //        };
                                                //    })
                                                //    .ToList();

                                                //var minendate = groupedMinDates.Where(a => a.IdStage == workstage.Id).FirstOrDefault();
                                                //if (minendate != null)
                                                //{
                                                if (dr["EndDate"] != DBNull.Value)
                                                {
                                                    workstage.FirstValidatedDate = Convert.ToDateTime(dr["EndDate"]).ToString("yyyy-MM-dd HH:mm:ss");
                                                    test.FirstValidatedDate = Convert.ToDateTime(dr["EndDate"]).ToString("yyyy-MM-dd HH:mm:ss");
                                                }
                                                // }
                                                workstage.Reworks = Convert.ToInt32(dr["Rework"]);
                                                test.Reworks = Convert.ToInt32(dr["Rework"]);
                                                workstage.IdCounterparttracking = Convert.ToInt32(dr["IdCounterpartTracking"]);
                                                test.IdCounterparttracking = Convert.ToInt32(dr["IdCounterpartTracking"]);
                                                workstage.TimeDifference = Convert.ToDouble(dr["CurrentTime"]);
                                                test.TimeDifference = Convert.ToDouble(dr["CurrentTime"]);
                                                #region // [pallavi.jadhav][15 10 2025][APIGEOS-1712]
                                                if (dr["IdOperator"] != DBNull.Value)
                                                {
                                                    workstage.IdUser = Convert.ToInt32(dr["IdOperator"]);
                                                    test.IdUser = Convert.ToInt32(dr["IdOperator"]);

                                                }
                                                if (dr["EmployeeCode"] != DBNull.Value)
                                                {
                                                    workstage.EmployeeCode = Convert.ToString(dr["EmployeeCode"]);
                                                    test.EmployeeCode = Convert.ToString(dr["EmployeeCode"]);

                                                }
                                                if (dr["IdEmployee"] != DBNull.Value)
                                                {
                                                    workstage.IdEmployee = Convert.ToInt32(dr["IdEmployee"]);
                                                    test.IdEmployee = Convert.ToInt32(dr["IdEmployee"]);

                                                }
                                               // itemTimeTracking.TimeTrackingStage.Add(workstage);
                                                #endregion
                                            }
                                            catch (Exception ex)
                                            {
                                                // Consider logging the exception instead of just re-throwing
                                                throw;
                                            }
                                        }
                                    }
                                    else // This 'else' block corresponds to the 'if (UpdatetimetrackList[0].WorkStage.Any(...))' condition
                                    {
                                        foreach (TimetrackingAPI itemTimeTracking in UpdatetimetrackList)
                                        {
                                            try
                                            {
                                                if (itemTimeTracking.TimeTrackingStage == null)
                                                {
                                                    itemTimeTracking.TimeTrackingStage = new List<WorkStage>();
                                                }
                                                WorkStage workstage = new WorkStage();
                                                TimeTrackingCurrentStage tcstageNew = new TimeTrackingCurrentStage();
                                                tcstageNew.IdStage = Convert.ToInt32(dr["IdStage"]);

                                                if (dr["IdStage"] != DBNull.Value)
                                                {
                                                    workstage.Id = Convert.ToInt32(dr["IdStage"]);
                                                }
                                                if (dr["WorkStageCode"] != DBNull.Value)
                                                {
                                                    workstage.Code = Convert.ToString(dr["WorkStageCode"]);
                                                }
                                                if (dr["WorkStageName"] != DBNull.Value)
                                                {
                                                    workstage.Name = Convert.ToString(dr["WorkStageName"]);
                                                }
                                                #region
                                                if (dr["IdStage"] != DBNull.Value)
                                                {
                                                    tcstageNew.NewIdStage = Convert.ToInt32(dr["IdStage"]);
                                                    workstage.NewIdStage = Convert.ToInt32(dr["IdStage"]);
                                                }

                                                #endregion

                                                if (dr["StartDate"] != DBNull.Value) // Changed from != null to != DBNull.Value
                                                {
                                                    tcstageNew.Startdate = Convert.ToDateTime(dr["StartDate"]);
                                                    workstage.Startdate = Convert.ToDateTime(dr["StartDate"]);
                                                }
                                                if (dr["EndDate"] != DBNull.Value)
                                                {
                                                    tcstageNew.Enddate = Convert.ToDateTime(dr["EndDate"]);
                                                    workstage.Enddate = Convert.ToDateTime(dr["EndDate"]);
                                                }

                                                tcstageNew.Rework = Convert.ToInt32(dr["Rework"]);
                                                tcstageNew.IdCounterparttracking = Convert.ToInt32(dr["IdCounterpartTracking"]);
                                                tcstageNew.TimeDifference = Convert.ToDouble(dr["CurrentTime"]);

                                                //var groupedMinDates = ds.Tables[1].AsEnumerable()
                                                //    .Where(row => row["EndDate"] != DBNull.Value && Convert.ToInt64(row["IdCounterpart"]) == itemTimeTracking.IdCounterpart)
                                                //    .GroupBy(row => Convert.ToInt32(row["IdStage"]))
                                                //    .Select(g =>
                                                //    {
                                                //        var minEndDate = g.Min(r => Convert.ToDateTime(r["EndDate"]));
                                                //        var minRow = g
                                                //            .OrderBy(r => Convert.ToDateTime(r["EndDate"]))
                                                //            .ThenBy(r => Convert.ToInt32(r["IdCounterpartTracking"]))
                                                //            .First(r => Convert.ToDateTime(r["EndDate"]) == minEndDate);

                                                //        return new
                                                //        {
                                                //            IdStage = g.Key,
                                                //            MinFirstValidatedDate = minEndDate,
                                                //            FormattedDate = minEndDate.ToString("yyyy-MM-dd HH:mm:ss"),
                                                //            FullRow = minRow
                                                //        };
                                                //    })
                                                //    .ToList();

                                                //var minendate = groupedMinDates.Where(a => a.IdStage == workstage.Id).FirstOrDefault();
                                                //if (minendate != null)
                                                //{
                                                if (dr["EndDate"] != DBNull.Value)
                                                {
                                                    workstage.FirstValidatedDate = Convert.ToDateTime(dr["EndDate"]).ToString("yyyy-MM-dd HH:mm:ss");
                                                }
                                                // }
                                                itemTimeTracking.TimeTrackingStage.Add(workstage);

                                                workstage.Reworks = Convert.ToInt32(dr["Rework"]);
                                                workstage.IdCounterparttracking = Convert.ToInt32(dr["IdCounterpartTracking"]);
                                                workstage.TimeDifference = Convert.ToDouble(dr["CurrentTime"]);

                                                #region // [pallavi.jadhav][15 10 2025][APIGEOS-1712]
                                                if (dr["IdOperator"] != DBNull.Value)
                                                {
                                                    workstage.IdUser = Convert.ToInt32(dr["IdOperator"]);
                                                   // tcstageNew.IdUser = Convert.ToInt32(dr["IdOperator"]);

                                                }
                                                if (dr["EmployeeCode"] != DBNull.Value)
                                                {
                                                    workstage.EmployeeCode = Convert.ToString(dr["EmployeeCode"]);
                                                   // tcstageNew.EmployeeCode = Convert.ToString(dr["EmployeeCode"]);

                                                }
                                                if (dr["IdEmployee"] != DBNull.Value)
                                                {
                                                    workstage.IdEmployee = Convert.ToInt32(dr["IdEmployee"]);
                                                   // tcstageNew.IdEmployee = Convert.ToInt32(dr["IdEmployee"]);

                                                }
                                                #endregion

                                                itemTimeTracking.WorkStage.Add(workstage);
                                            }
                                            catch (Exception ex)
                                            {
                                                // Consider logging the exception instead of just re-throwing
                                                throw;
                                            }
                                        }
                                    }
                                }

                                #endregion
                            }
                        }
                    }
                }
                catch (Exception ex)
                {

                }
                // }
                //if (dr.NextResult())
                //{
                try
                {
                    //count = 0;
                    foreach (DataRow dr in ds.Tables[2].Rows)//while (dr.Read())
                    {
                        if (dr["CPProductID"] != DBNull.Value && dr["IdStage"] != DBNull.Value && dr["ExpectedTime"] != DBNull.Value)
                        {
                            //count = count + 1;
                            List<TimetrackingAPI> UpdatetimetrackList1 = timeTrackingList.Where(i => i.IdCP == Convert.ToInt64(dr["CPProductID"])).ToList();
                            //TimeTracking UpdatetimetrackList = timeTrackingList.Where(i => i.CPProductID == Convert.ToInt64(dr["CPProductID"])).FirstOrDefault();
                            if (timeTrackingList.Any(i => i.IdCP == Convert.ToInt64(dr["CPProductID"])))
                            {
                                if (UpdatetimetrackList1[0].WorkStage.Any(i => i.Id == Convert.ToInt32(dr["IdStage"])))
                                {
                                    //WorkStage WorkStages = UpdatetimetrackList.WorkStage.Where(i => i.Id == Convert.ToInt32(dr["IdStage"])).FirstOrDefault();
                                    //if (WorkStages != null)
                                    //{
                                    //    //if (WorkStages.IdCounterpart == 356707)
                                    //    //{

                                    //    //}
                                    //    TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                    //    TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                    //    WorkStages.ExpectedTime = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));
                                    //    WorkStages.RemainingTime = WorkStages.ExpectedTime - WorkStages.RealTime;
                                    //    WorkStages.IdCP = Convert.ToInt64(dr["CPProductID"]);
                                    //}
                                    //foreach (WorkStage workStageItem in UpdatetimetrackList.WorkStage)
                                    //{
                                    //      workStageItem.RemainingTime = workStageItem.ExpectedTime - workStageItem.RealTime);
                                    //}

                                    foreach (TimetrackingAPI itemTimeTracking in UpdatetimetrackList1)
                                    {
                                        WorkStage tcstage = itemTimeTracking.TimeTrackingStage.Where(i => i.Id == Convert.ToInt32(dr["IdStage"])).FirstOrDefault();

                                        if (tcstage != null)
                                        {
                                            #region 
                                            if (App_Stage.Count > 0)
                                            {
                                                //App_Stage = new List<int>();

                                                if (App_Stage.Contains(Convert.ToInt32(tcstage.Id)))
                                                {
                                                    if (itemTimeTracking.SerialNumber.EndsWith("1"))
                                                    {
                                                        TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                        TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                        tcstage.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));
                                                        tcstage.Expected = Convert.ToDecimal(dr["ExpectedTime"]);
                                                        //  itemTimeTracking.ExpectedHtmlColorFlag = false;
                                                    }
                                                    else
                                                    {
                                                        TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                        TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble(0.0));
                                                        tcstage.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));

                                                        tcstage.Expected = Convert.ToDecimal(0.0);
                                                        //itemTimeTracking.ExpectedHtmlColorFlag = true;
                                                    }
                                                }
                                                else
                                                {
                                                    TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                    TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                    tcstage.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));

                                                    tcstage.Expected = Convert.ToDecimal(dr["ExpectedTime"]);
                                                }
                                            }
                                            else
                                            {
                                                TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                tcstage.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));

                                                tcstage.Expected = Convert.ToDecimal(dr["ExpectedTime"]);
                                            }
                                            #endregion
                                        }

                                    }
                                }
                                else
                                {
                                    foreach (TimetrackingAPI itemTimeTracking in UpdatetimetrackList1)
                                    {

                                        WorkStage tcstageNew = new WorkStage();
                                        tcstageNew.Id = Convert.ToInt32(dr["IdStage"]);

                                        #region 
                                        if (App_Stage.Count > 0)
                                        {
                                            if (App_Stage.Contains(Convert.ToInt32(tcstageNew.Id)))
                                            {
                                                if (itemTimeTracking.SerialNumber.EndsWith("1"))
                                                {
                                                    TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                    TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                    tcstageNew.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));

                                                    tcstageNew.Expected = Convert.ToDecimal(dr["ExpectedTime"]);
                                                    // itemTimeTracking.ExpectedHtmlColorFlag = false;
                                                }
                                                else
                                                {
                                                    TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                    TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((0.0)));
                                                    tcstageNew.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));

                                                    tcstageNew.Expected = Convert.ToDecimal(0.0);
                                                    //itemTimeTracking.ExpectedHtmlColorFlag = true;
                                                }
                                            }
                                            else
                                            {
                                                TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                                tcstageNew.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));

                                                tcstageNew.Expected = Convert.ToDecimal(dr["ExpectedTime"]);
                                            }
                                        }
                                        else
                                        {
                                            TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                            TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                                            tcstageNew.Expecteds = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));
                                            itemTimeTracking.TimeTrackingStage.Add(tcstageNew);
                                            tcstageNew.Expected = Convert.ToDecimal(dr["ExpectedTime"]);
                                        }
                                        #endregion




                                    }
                                }
                            }
                            //List<TimeTracking> UpdatetimetrackList = timeTrackingList.Where(i => i.IdCP == Convert.ToInt64(dr["CPProductID"])).ToList();
                            //if (timeTrackingList.Any(i => i.IdCP == Convert.ToInt64(dr["CPProductID"])))
                            //{
                            //    if(UpdatetimetrackList[0].WorkStage.Any(i => i.Id == Convert.ToInt32(dr["IdStage"])))
                            //    {
                            //        foreach (TimeTracking itemTimeTracking in UpdatetimetrackList)
                            //        {
                            //            WorkStage WorkStages = itemTimeTracking.WorkStage.Where(i => i.Id == Convert.ToInt32(dr["IdStage"])).FirstOrDefault();
                            //            if (WorkStages != null)
                            //            {
                            //                TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                            //                WorkStages.ExpectedTime = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));
                            //                WorkStages.RemainingTime = WorkStages.ExpectedTime - WorkStages.RealTime;
                            //            }

                            //        }
                            //    }
                            //}
                        }
                        #region OldCode
                        //foreach (TimeTracking item in timeTrackingList)
                        //{
                        //    WorkStage WorkStages = item.WorkStage.FirstOrDefault(i => i.Id == Convert.ToInt32(dr["IdStage"]));

                        //    if (WorkStages != null)
                        //    {

                        //        if (dr["ExpectedTime"] != DBNull.Value)
                        //        {
                        //            // WorkStages.ExpectedTime = Convert.ToString(dr["ExpectedTime"]);
                        //            TimeSpan TimeSpan = TimeSpan.FromMinutes(Convert.ToDouble((dr["ExpectedTime"])));
                        //            WorkStages.ExpectedTime = TimeSpan.Parse(string.Format("{0:00}:{1:00}:{2:00}", TimeSpan.Hours, TimeSpan.Minutes, TimeSpan.Seconds));
                        //            WorkStages.RemainingTime = WorkStages.ExpectedTime - WorkStages.RealTime;
                        //        }

                        //    }
                        //}
                        #endregion

                    }
                }
                catch (Exception ex)
                {

                }

                //}
                #region [pallavi jadhav][APIGEOS-1074][22 01 2025]
                if (IsPlantActiveByPlant == true)
                {
                    //if (dr.NextResult())
                    foreach (DataRow dr in ds.Tables[3].Rows) //while (dr.Read())
                    {

                        try
                        {
                            if (dr["IdCounterpart"] != DBNull.Value && dr["IdStages"] != DBNull.Value)
                            {///&& reader["RealTime"] != DBNull.Value
                                #region [pallavi jadhav][APIGEOS-1074][22 01 2025]

                                List<TimetrackingAPI> UpdatetimetrackList = timeTrackingList.Where(i => i.IdCounterpart == Convert.ToInt64(dr["IdCounterpart"])).ToList();  //if (UpdatetimetrackList[0].TimeTrackingStage.Any(i => i.IdStage == Convert.ToInt32(reader["IdStages"])))
                                                                                                                                                                            //{
                                foreach (TimetrackingAPI itemTimeTrackingPDD in UpdatetimetrackList)
                                {

                                    WorkStage tcstageByPDD = itemTimeTrackingPDD.WorkStage.Where(i => i.Id == Convert.ToInt32(dr["IdStages"])).FirstOrDefault();
                                    if (tcstageByPDD != null)
                                    {

                                        if (dr["IdStages"] != null)
                                        {
                                            tcstageByPDD.Id = Convert.ToInt32(dr["IdStages"]);
                                        }
                                        if (dr["PlanDateByStages"] != null)
                                        {
                                            tcstageByPDD.PlannedDeliveryDate = Convert.ToDateTime(dr["PlanDateByStages"]).ToString("yyyy-MM-dd");

                                        }
                                        if (itemTimeTrackingPDD.DeliveryDate != null)
                                        {
                                            int days = (Convert.ToDateTime(itemTimeTrackingPDD.DeliveryDate) - Convert.ToDateTime(tcstageByPDD.PlannedDeliveryDate)).Days;

                                            tcstageByPDD.Days = days;
                                        }


                                        itemTimeTrackingPDD.WorkStage.Add(tcstageByPDD);


                                    }
                                }

                                #endregion

                                //  }
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetTimeTrackingBYPlant(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw ex;
                        }

                    }
                }
                #endregion
                //}

                Log4NetLogger.Logger.Log(string.Format("Method GetTimetracking()....Executed successfully."), category: Category.Info, priority: Priority.Low);

                //   }//close mysql

                Log4NetLogger.Logger.Log(string.Format("Method GetTimetracking()....Executed successfully."), category: Category.Info, priority: Priority.Low);

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTimetracking(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }



            try
            {
                #region [APIGEOS-1205][gulab lakade][05 10 2024]
                for (int i = 0; i < timeTrackingList.Count; i++)
                {

                    TimeSpan TempTotalReal = TimeSpan.Parse("0");
                    TimeSpan TempTotalExpected = TimeSpan.Parse("0");
                    TimeSpan TempTotalRemaianing = TimeSpan.Parse("0");

                    if (timeTrackingList[i].WorkStage != null)
                    {
                        try
                        {
                            //[APIGEOS-1530][26.06.2025][rdixit]
                            var FinalList = timeTrackingList[i].TimeTrackingStage.OrderBy(r => r.Startdate).ThenBy(r => r.Enddate).ToList(); // tracking wise stages
                            #region

                            string Production = string.Empty;
                            string Rework_First = string.Empty;
                            string Rework_Second = string.Empty;
                            string Rework_Third = string.Empty;
                            string Rework_Fourth = string.Empty;
                            string POWS_First = string.Empty;
                            string POWS_Second = string.Empty;
                            string POWS_Third = string.Empty;
                            string POWS_Fourth = string.Empty;
                            string ROWS_First = string.Empty;
                            string ROWS_Second = string.Empty;
                            string ROWS_Third = string.Empty;
                            string ROWS_Fourth = string.Empty;
                            #endregion

                            if (FinalList?.Count() > 0)
                            {


                                ProcessWorkStages(FinalList, TimetrakingEmployeesList, timeTrackingList[i].IdCounterpart);
                                var updatedStagesList = timeTrackingList[i].WorkStage.Select(a => a.Id).Except(FinalList.Select(j => j.Id));

                                FinalList.AddRange(timeTrackingList[i].WorkStage.Where(k => updatedStagesList.Any(p => p == k.Id)));
                                CalculatedStagesData(FinalList, timeTrackingList[i].DesignType, CADCAMDesignTypeListByPlant);
                                //CalculatedStagesData(FinalListworkstages);

                                #region [07 07 2025][APIGEOS-1531][pallavi.jadhav]
                                var groupedStages = FinalList.GroupBy(s => s.Code).Select(g =>
                                {
                                    var productionTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.ProductionTime);
                                    var reworkTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.ReworkTime);
                                    var realTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Reals);

                                    string productionStr = productionTime.ToString(@"hh\:mm\:ss");
                                    string reworkStr = reworkTime.ToString(@"hh\:mm\:ss");
                                    string realStr = realTime.ToString(@"hh\:mm\:ss");

                                    // Apply your logic
                                    if (reworkStr == "00:00:00" && productionStr == "00:00:00" && realStr == "00:00:00")
                                    {
                                        reworkStr = "";
                                        productionStr = "";
                                        realStr = "";
                                    }
                                    else if (reworkStr == "00:00:00" && productionStr != "00:00:00")
                                    {
                                        if (productionTime != TimeSpan.Zero)
                                        {
                                            reworkStr = "00:00:00";
                                        }
                                        else
                                        {
                                            reworkStr = "";
                                            productionStr = "";
                                        }
                                    }
                                    else if (reworkStr == "00:00:00" && productionStr == "00:00:00")
                                    {
                                        reworkStr = "";
                                        productionStr = "";
                                    }

                                    return new WorkStage
                                    {
                                        Code = g.Key,
                                        Id = g.First().Id,
                                        Name = g.First().Name,
                                        FirstValidatedDate = g.First().FirstValidatedDate,
                                        Sequence = g.First().Sequence,
                                        Employees = g.Where(x => x.Employees != null).SelectMany(x => x.Employees).Where(b => b.EmployeeCode != "").GroupBy(a => a.IdEmployee)
                                                                 .Select(e => new TimetrakingEmployees
                                                                 {
                                                                     IdEmployee = e.First().IdEmployee,
                                                                     IdUser = e.First().IdUser,
                                                                     EmployeeCode = e.First().EmployeeCode,
                                                                     Production = e.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.ProductionTime).ToString(@"hh\:mm\:ss"),
                                                                     Production_OWS = e.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Production_OWSTime).ToString(@"hh\:mm\:ss"),
                                                                     RealTime = e.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Reals).ToString(@"hh\:mm\:ss"),
                                                                     Rework = e.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.ReworkTime).ToString(@"hh\:mm\:ss"),
                                                                     Rework_OWS = e.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Rework_OWSTime).ToString(@"hh\:mm\:ss"),
                                                                 }).ToList(),
                                        // TimeSpan properties
                                        ProductionTime = productionTime,
                                        Production_OWSTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Production_OWSTime),
                                        ReworkTime = reworkTime,
                                        Rework_OWSTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Rework_OWSTime),
                                        Expecteds = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Expecteds),
                                        Reals = realTime,
                                        Remaining = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Remaining),

                                        // String versions with conditionally blanked values
                                        Production = productionStr,
                                        Rework = reworkStr,
                                        RealTime = realStr,

                                        Production_OWS = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Production_OWSTime).ToString(@"hh\:mm\:ss"),
                                        Rework_OWS = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Rework_OWSTime).ToString(@"hh\:mm\:ss"),
                                        ExpectedTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Expecteds).ToString(@"hh\:mm\:ss"),
                                        RemainingTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Remaining).ToString(@"hh\:mm\:ss"),

                                        Reworks = g.Sum(s => s.Reworks),
                                        Paused = g.Any(s => s.Paused)
                                    };
                                }).ToList();

                                FinalList = groupedStages;
                                #endregion
                            }
                            //var groupedStages = FinalList.GroupBy(s => s.Code).Select(g => new WorkStage
                            //{
                            //    Code = g.Key,
                            //    Id = g.FirstOrDefault().Id,
                            //    Name = g.FirstOrDefault().Name,
                            //    FirstValidatedDate = g.FirstOrDefault().FirstValidatedDate,
                            //    // Sum all TimeSpans          
                            //    ProductionTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.ProductionTime),
                            //    Production_OWSTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Production_OWSTime),
                            //    ReworkTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.ReworkTime),
                            //    Rework_OWSTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Rework_OWSTime),
                            //    Expecteds = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Expecteds),

                            //    // Compute Real and Remaining again           
                            //    Reals = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Reals),
                            //    Remaining = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Remaining),

                            //    // Set string versions           
                            //    Production = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.ProductionTime).ToString(),
                            //    Production_OWS = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Production_OWSTime).ToString(),
                            //    Rework = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.ReworkTime).ToString(),
                            //    Rework_OWS = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Rework_OWSTime).ToString(),
                            //    ExpectedTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Expecteds).ToString(),
                            //    RealTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Reals).ToString(),
                            //    RemainingTime = g.Aggregate(TimeSpan.Zero, (sum, s) => sum + s.Remaining).ToString(),

                            //    // Optional: count total reworks           
                            //    Reworks = g.Sum(s => s.Reworks),
                            //    Paused = g.Any(s => s.Paused)
                            //}).ToList();
                            //FinalList = groupedStages;
                            //  }

                            var teee = timeTrackingList[i].WorkStage;
                            timeTrackingList[i].WorkStage = new List<WorkStage>();

                            if (!string.IsNullOrEmpty(Stage))
                            {
                                //int IdStage = Convert.ToInt32(Stage);
                                string[] stageArray = Stage.Split(',');

                                List<string> IntList = new List<string>();
                                foreach (var stage in stageArray)
                                {
                                    IntList.Add(stage);
                                }
                                if (FinalList.Count > 0)
                                {
                                    if (FinalList.Where(a => IntList.Contains(Convert.ToString(a.Id))).ToList().Count > 0)
                                    {
                                        timeTrackingList[i].WorkStage = FinalList.Where(a => IntList.Contains(Convert.ToString(a.Id))).OrderBy(a => a.Id).ToList();
                                    }
                                }
                            }
                            else
                            {
                                timeTrackingList[i].WorkStage = FinalList.OrderBy(a => a.Id).ToList();
                            }
                            #region

                            #endregion
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetTimeTraking(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw ex;
                        }
                    }
                }
                #endregion

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTimeTrakingBYPlant(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }




            try
            {


                List<ReworkData> OTsWithIDOTItemList = new List<ReworkData>();
                List<ReworkData> OTsWithIDDrawingList = new List<ReworkData>();

                for (int i = 0; i < timeTrackingList.Count; i++)
                {
                    #region 

                    //if (TimeTrackingList[i].TRework != null)
                    //{
                    //    dr["TRework"] = TimeTrackingList[i].TRework;
                    //}

                    List<WorkStage> StageReworksList = new List<WorkStage>();

                    timeTrackingList[i].TotalRework = timeTrackingList[i].TotalRework;

                    if (timeTrackingList[i].IsBatch == false && timeTrackingList[i].TotalRework > 0)
                    {
                        if (timeTrackingList[i].IdOTItem != 0)
                        {
                            var TempIdOTItem = OTsWithIDOTItemList.Where(j => j.IdOT == timeTrackingList[i].IdOt && j.IdOTItem == timeTrackingList[i].IdOTItem).FirstOrDefault();

                            if (TempIdOTItem == null)
                            {
                                ReworkData TempReworkOTItem = new ReworkData();

                                TempReworkOTItem.IdOT = timeTrackingList[i].IdOt;
                                TempReworkOTItem.IdOTItem = timeTrackingList[i].IdOTItem;
                                TempReworkOTItem.IdCounterpart = timeTrackingList[i].IdCounterpart;
                                OTsWithIDOTItemList.Add(TempReworkOTItem);
                                //FlagNewAlgorithmCOM = false;
                            }
                            else
                            {
                                //FlagNewAlgorithmCOM = true;

                                // Update rework for COM stage in Time tracking Lists to display in Time tracking grid 
                                if (timeTrackingList[i].WorkStage != null)
                                {
                                    StageReworksList = timeTrackingList[i].TimeTrackingStage.Where(j => OtItemStagesList.Contains(j.NewIdStage) && j.Reworks == 1).ToList();

                                    if (StageReworksList.Count > 0)  // Update rework only if rework is related to specific stage.
                                    {
                                        if (timeTrackingList[i].TotalRework > 0)
                                        {
                                            timeTrackingList[i].TotalRework = timeTrackingList[i].TotalRework - (int)StageReworksList.Count;
                                            timeTrackingList[i].TotalRework = timeTrackingList[i].TotalRework;
                                        }

                                    }
                                }
                            }
                        }

                        if (timeTrackingList[i].IdDrawing != 0)
                        {
                            var TempIdDrawing = OTsWithIDDrawingList.Where(j => j.IdOT == timeTrackingList[i].IdOt && j.IdDrawing == timeTrackingList[i].IdDrawing).FirstOrDefault();
                            if (TempIdDrawing == null)
                            {
                                ReworkData TempReworkDrawing = new ReworkData();

                                TempReworkDrawing.IdOT = timeTrackingList[i].IdOt;
                                TempReworkDrawing.IdOTItem = timeTrackingList[i].IdOTItem;
                                TempReworkDrawing.IdCounterpart = timeTrackingList[i].IdCounterpart;
                                TempReworkDrawing.IdDrawing = timeTrackingList[i].IdDrawing;
                                OTsWithIDDrawingList.Add(TempReworkDrawing);
                            }
                            else
                            {
                                // Update rework for CAD & CAM stage in ProductionOutPutReport & AllPlantWeeklyReworksMail Lists to display in mail 

                                StageReworksList = new List<WorkStage>();
                                if (timeTrackingList[i].WorkStage != null)
                                {
                                    StageReworksList = timeTrackingList[i].TimeTrackingStage.Where(j => DrawingIdStagesList.Contains(j.NewIdStage) && j.Reworks == 1).ToList();

                                    if (StageReworksList.Count > 0)  // Update rework only if rework is related to specific stage.
                                    {
                                        timeTrackingList[i].TotalRework = timeTrackingList[i].TotalRework - (int)StageReworksList.Count;
                                        timeTrackingList[i].TotalRework = timeTrackingList[i].TotalRework;
                                    }
                                }
                            }
                        }
                    }

                    #endregion

                }
            }
            catch (Exception ex)
            {

            }
            return timeTrackingList;
        }
        private static void FillCADCAMDesignTypeListByPlant(string ConnectionString)
        {
            try
            {
                GeosAppSettingAPI AppSetting = new GeosAppSettingAPI();

                AppSetting = GetGeosAppSettingsByPlant(124, ConnectionString);
                if (AppSetting != null)
                {
                    CADCAMDesignTypeListByPlant = new List<ERM_CADCAMTimePerDesignType>();
                    List<string> tempWorkStageList = new List<string>();
                    //foreach (var item in AppSetting)
                    //{
                    string tempstring = Convert.ToString(AppSetting.defaultValue.Replace('(', ' '));
                    tempstring = tempstring.Replace(')', ' ');
                    tempWorkStageList = Convert.ToString(tempstring).Split(',').ToList();
                    // }
                    if (tempWorkStageList.Count > 0)
                    {
                        foreach (var item in tempWorkStageList)
                        {
                            List<string> tempIDStageList = Convert.ToString(item.Trim()).Split(';').ToList();
                            if (tempIDStageList.Count() > 0)
                            {
                                ERM_CADCAMTimePerDesignType selectCADCAMDesignTypeList = new ERM_CADCAMTimePerDesignType();
                                selectCADCAMDesignTypeList.IdStage = Convert.ToInt32(tempIDStageList[0]);
                                selectCADCAMDesignTypeList.DesignType = Convert.ToString(tempIDStageList[1]);
                                selectCADCAMDesignTypeList.DesignValue = Convert.ToInt32(tempIDStageList[2]);
                                selectCADCAMDesignTypeList.RoleValue = Convert.ToString(tempIDStageList[3]);
                                CADCAMDesignTypeListByPlant.Add(selectCADCAMDesignTypeList);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {

            }

        }
        public static List<CurrencyRateListByDate> GetAllCurrencyDetailsBYPlant(DateTime FromDate, DateTime ToDate, string ConnectionString)
        {
            // public List<CurrencyRate> GetAllCurrencyDetails(DateTime FromDate, DateTime ToDate)
            List<CurrencyRateListByDate> currenciesRatesList = new List<CurrencyRateListByDate>();

            try
            {

                Log4NetLogger.Logger.Log(string.Format("Method GetAllCurrencyDetailsBYPlant()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(ConnectionString))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("APIERM_GetCurrencyRateByDate_V790", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.CommandTimeout = 8000;
                    command.Parameters.AddWithValue("_CurrencyConversionFromDate", FromDate);
                    command.Parameters.AddWithValue("_CurrencyConversionToDate", ToDate);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            CurrencyRateListByDate currencyRate = new CurrencyRateListByDate();

                            currencyRate.ConversionDate = dr["CurrencyConversionDate"] != DBNull.Value
                                ? Convert.ToDateTime(dr["CurrencyConversionDate"])
                                : DateTime.MinValue;

                            currencyRate.ConversionRate = dr["CurrencyConversionRate"] != DBNull.Value
                                ? Math.Round(Convert.ToDouble(dr["CurrencyConversionRate"]), 4)
                                : 0.0;

                            currencyRate.CurrencyFrom = dr["CurrencyFrom"] != DBNull.Value
                                ? dr["CurrencyFrom"].ToString()
                                : string.Empty;

                            currencyRate.CurrencyTo = dr["CurrencyTo"] != DBNull.Value
                                ? dr["CurrencyTo"].ToString()
                                : string.Empty;

                            currencyRate.IdCurrency = dr["IdCurrency"] != DBNull.Value
                                ? Convert.ToInt32(dr["IdCurrency"])
                                : 0;

                            currencyRate.Currency = dr["Name"] != DBNull.Value
                                ? dr["Name"].ToString()
                                : string.Empty;

                            currenciesRatesList.Add(currencyRate);
                        }
                    }


                }
                Log4NetLogger.Logger.Log(string.Format("Method GetAllCurrencyDetailsBYPlant()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetAllCurrencyDetailsBYPlant(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            return currenciesRatesList;
        }

        public List<WorkStage> GetAllTimeTrackingProductioStage_V2340(string ERMConnectionString, String Stage, Int64 idSite)
        {


            List<WorkStage> ProductionStages = new List<WorkStage>();

            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(ERMConnectionString))
                {
                    mySqlConnection.Open();
                    //    MySqlCommand mySqlCommand = new MySqlCommand("GEOSAPI_GetAllTimeTrackingProductionStage1_V580", mySqlConnection);
                    MySqlCommand mySqlCommand = new MySqlCommand("GEOSAPI_GetAllTimeTrackingProductionStage1_V790", mySqlConnection); // [pallavi jadhav][APIGEOS-1074][04 02 2024]
                    mySqlCommand.Parameters.AddWithValue("_Stage", Stage);
                    mySqlCommand.Parameters.AddWithValue("_IdSite", idSite);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.CommandTimeout = 6000; // 3 minutes (adjust if needed)

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            WorkStage ProductionStage = new WorkStage();

                            ProductionStage.Id = Convert.ToInt32(reader["IdStage"]);

                            if (reader["Name"] != DBNull.Value)
                                ProductionStage.Name = Convert.ToString(reader["Name"]);

                            if (reader["Code"] != DBNull.Value)
                                ProductionStage.Code = Convert.ToString(reader["Code"]);
                            if (reader["Sequence"] != DBNull.Value)
                                ProductionStage.Sequence = Convert.ToInt32(reader["Sequence"]);

                            if (reader["ActiveInPlants"] != DBNull.Value)
                                ProductionStage.ActiveInPlants = (reader["ActiveInPlants"]).ToString();


                            ProductionStages.Add(ProductionStage);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetAllTimeTrackingProductioStage_V2320().  ErrorMessage- {1}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return ProductionStages;
        }
        public Int64 IsEMDEPSiteExist(string Site, string connstr)
        {
            Int64 idSite = 0;
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method IsEMDEPSiteExist()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(connstr))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_IsEMDEPSiteExist", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("_ShortName", Site);

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            if (dr["IdSite"] != DBNull.Value)
                            {
                                idSite = Convert.ToInt64(dr["IdSite"]);
                            }
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method IsEMDEPSiteExist()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error IsEMDEPSiteExist(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }

            return idSite;
        }

        public List<CurrencyRateListByDate> GetAllCurrencyDetails(DateTime FromDate, DateTime ToDate, string ConnectionString)
        {
            List<CurrencyRateListByDate> currenciesRatesList = new List<CurrencyRateListByDate>();

            try
            {
                Log4NetLogger.Logger.Log("Method GetAllCurrencyDetails() started...", category: Category.Info, priority: Priority.Low);

                using (MySqlConnection conn = new MySqlConnection(ConnectionString))
                {
                    conn.Open();

                    using (MySqlCommand command = new MySqlCommand("APIERM_GetCurrencyRateByDate_V790", conn))
                    {
                        command.CommandType = CommandType.StoredProcedure;
                        command.CommandTimeout = 8000;
                        command.Parameters.AddWithValue("_CurrencyConversionFromDate", FromDate);
                        command.Parameters.AddWithValue("_CurrencyConversionToDate", ToDate);

                        using (MySqlDataReader dr = command.ExecuteReader())
                        {
                            while (dr.Read())
                            {
                                CurrencyRateListByDate currencyRate = new CurrencyRateListByDate();

                                currencyRate.ConversionDate = dr["CurrencyConversionDate"] != DBNull.Value
                                    ? Convert.ToDateTime(dr["CurrencyConversionDate"])
                                    : DateTime.MinValue;

                                currencyRate.ConversionRate = dr["CurrencyConversionRate"] != DBNull.Value
                                    ? Math.Round(Convert.ToDouble(dr["CurrencyConversionRate"]), 4)
                                    : 0.0;

                                currencyRate.CurrencyFrom = dr["CurrencyFrom"] != DBNull.Value
                                    ? dr["CurrencyFrom"].ToString()
                                    : string.Empty;

                                currencyRate.CurrencyTo = dr["CurrencyTo"] != DBNull.Value
                                    ? dr["CurrencyTo"].ToString()
                                    : string.Empty;

                                currencyRate.IdCurrency = dr["IdCurrency"] != DBNull.Value
                                    ? Convert.ToInt32(dr["IdCurrency"])
                                    : 0;

                                currencyRate.Currency = dr["Name"] != DBNull.Value
                                    ? dr["Name"].ToString()
                                    : string.Empty;

                                currenciesRatesList.Add(currencyRate);
                            }
                        }
                    }
                }

                Log4NetLogger.Logger.Log("Method GetAllCurrencyDetails() executed successfully.", category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(
                    $"Error in GetAllCurrencyDetails(). Message: {ex.Message}, StackTrace: {ex.StackTrace}",
                    category: Category.Exception,
                    priority: Priority.Low
                );
                throw; // Use 'throw;' to preserve the original stack trace
            }

            return currenciesRatesList;
        }

        public static void ProcessWorkStages(List<WorkStage> stages, List<TimetrakingEmployees> TimetrakingEmployeesList, Int32 IdCounterpart)
        {
            Stack<KeyValuePair<int, WorkStage>> ReworkStages = new Stack<KeyValuePair<int, WorkStage>>();
            Stack<KeyValuePair<int, WorkStage>> DetectedReworks = new Stack<KeyValuePair<int, WorkStage>>();
            Stack<WorkStage> DoneStages = new Stack<WorkStage>();
            if (IdCounterpart == 436586)
            {

            }
            try
            {
                //List<TimetrakingEmployees> timeEmployeesList = new List<TimetrakingEmployees>();
                // ✅ Step 1: Sort stages properly before looping
                //var orderedStages = stages
                //    .OrderBy(s => s.Startdate)
                //    .ThenBy(s => s.Enddate).Distinct().ToList();

                //Stack<WorkStage> doneStages = new Stack<WorkStage>();
                //Stack<KeyValuePair<int, WorkStage>> reworkStages = new Stack<KeyValuePair<int, WorkStage>>();
                //Stack<KeyValuePair<int, WorkStage>> detectedReworks = new Stack<KeyValuePair<int, WorkStage>>();
                List<TimetrakingEmployees> timeEmployeesList = new List<TimetrakingEmployees>();

                //for (int i = 0; i < orderedStages.Count; i++)
                //{
                //    var current = orderedStages[i];

                //    // ✅ Find or create employee record
                //    var trackingEmp = timeEmployeesList.FirstOrDefault(a =>
                //        a.IdUser == current.IdUser &&
                //        a.IdStage == current.Id &&
                //        a.IDCounterpart == IdCounterpart &&
                //        a.IDCounterpartTracking == current.IdCounterparttracking);

                //    if (trackingEmp == null)
                //    {
                //        trackingEmp = new TimetrakingEmployees
                //        {
                //            IdUser = current.IdUser,
                //            IdEmployee = current.IdEmployee,
                //            EmployeeCode = current.EmployeeCode,
                //            IdStage = current.Id,
                //            IDCounterpart = IdCounterpart,
                //            IDCounterpartTracking = current.IdCounterparttracking
                //        };
                //    }

                //    // ✅ Case 1: Stage processed first time (normal or first rework)
                //    if (!doneStages.Any(s => s.Code == current.Code))
                //    {
                //        if (reworkStages.Any(r => r.Value.Code == current.Code))
                //        {
                //            // 🌀 Reworked stage
                //            var reworkFoundStage = reworkStages.Pop();
                //            var reworkDetectedStage = detectedReworks.Pop();
                //            doneStages.Push(current);

                //            current.ProductionTime = TimeSpan.FromSeconds(current.TimeDifference);
                //            current.Production = current.ProductionTime.ToString(@"hh\:mm\:ss");

                //            trackingEmp.ProductionTime = current.ProductionTime;
                //            trackingEmp.Production = current.Production;
                //        }
                //        else
                //        {
                //            // 🕒 Normal processing
                //            if (current.TimeDifference > 0)
                //            {
                //                current.ProductionTime = TimeSpan.FromSeconds(current.TimeDifference);
                //                current.Production = current.ProductionTime.ToString(@"hh\:mm\:ss");
                //            }
                //            else
                //            {
                //                current.ProductionTime = TimeSpan.Zero;
                //                current.Production = "00:00:00";
                //            }

                //            doneStages.Push(current);
                //            trackingEmp.ProductionTime = current.ProductionTime;
                //            trackingEmp.Production = current.Production;
                //        }

                //        timeEmployeesList.Add(trackingEmp);
                //    }
                //    else
                //    {
                //        // ✅ Case 2: Stage already processed → handle rework or OWS
                //        if (reworkStages.Any(r => r.Value.Code == current.Code))
                //        {
                //            reworkStages.Pop();
                //            detectedReworks.Pop();
                //        }
                //        else
                //        {
                //            var lastRework = detectedReworks.FirstOrDefault();
                //            if (lastRework.Value != null)
                //            {
                //                var reworkStage = lastRework.Value;
                //                reworkStage.Rework_OWSTime = reworkStage.Rework_OWSTime.Add(TimeSpan.FromSeconds(current.TimeDifference));
                //                reworkStage.Rework_OWS = reworkStage.Rework_OWSTime.ToString(@"hh\:mm\:ss");
                //            }
                //        }

                //        if (detectedReworks.Any(r => r.Value.Code == current.Code))
                //        {
                //            // 🔁 Rework detected
                //            current.ReworkTime = TimeSpan.FromSeconds(current.TimeDifference);
                //            current.Rework = current.ReworkTime.ToString(@"hh\:mm\:ss");

                //            trackingEmp.ReworkTime = current.ReworkTime;
                //            trackingEmp.Rework = current.Rework;
                //        }
                //        else
                //        {
                //            // ⚙️ OWS calculation
                //            current.Production_OWSTime = TimeSpan.FromSeconds(current.TimeDifference);
                //            current.Production_OWS = current.Production_OWSTime.ToString(@"hh\:mm\:ss");

                //            trackingEmp.Production_OWSTime = current.Production_OWSTime;
                //            trackingEmp.Production_OWS = current.Production_OWS;
                //        }

                //        timeEmployeesList.Add(trackingEmp);
                //    }

                //    // ✅ Case 3: If current stage paused or has rework, mark next as rework
                //    if (current.Reworks > 0 || current.Paused)
                //    {
                //        if (doneStages.Any()) doneStages.Pop();

                //        int nextIndex = i + 1;
                //        if (nextIndex < orderedStages.Count)
                //        {
                //            var nextStage = orderedStages[nextIndex];
                //            reworkStages.Push(new KeyValuePair<int, WorkStage>(i, current));

                //            nextStage.ReworkTime = TimeSpan.FromSeconds(nextStage.TimeDifference);
                //            nextStage.Rework = nextStage.ReworkTime.ToString(@"hh\:mm\:ss");

                //            var nextEmp = new TimetrakingEmployees
                //            {
                //                IdUser = nextStage.IdUser,
                //                IdEmployee = nextStage.IdEmployee,
                //                EmployeeCode = nextStage.EmployeeCode,
                //                IdStage = nextStage.Id,
                //                IDCounterpart = IdCounterpart,
                //                IDCounterpartTracking = nextStage.IdCounterparttracking,
                //                ReworkTime = nextStage.ReworkTime,
                //                Rework = nextStage.Rework
                //            };

                //            timeEmployeesList.Add(nextEmp);
                //            detectedReworks.Push(new KeyValuePair<int, WorkStage>(nextIndex, nextStage));
                //        }
                //    }

                //    // ✅ Assign Employees uniquely to each stage
                //    if (current.Employees == null)
                //        current.Employees = new List<TimetrakingEmployees>();

                //    var stageEmployees = timeEmployeesList
                //        .Where(e => e.IdUser == current.IdUser && e.IdStage == current.Id)
                //        .GroupBy(e => e.IdEmployee)
                //        .Select(g => g.First())
                //        .ToList();

                //    current.Employees.Clear();
                //    current.Employees.AddRange(stageEmployees);
                //}


                #region // [pallavi.jadhav][15 10 2025][APIGEOS-1712]
                for (int i = 0; i < stages.Count; i++)
                {
                    var current = stages[i];

                    if (current.Employees == null)
                        current.Employees = new List<TimetrakingEmployees>();

                    // Find existing employee data for this stage
                    var timetrakingEmployees = timeEmployeesList
                        .FirstOrDefault(a => a.IdUser == current.IdUser
                                             && a.IdStage == current.Id
                                             && a.IDCounterpart == IdCounterpart
                                             && a.IDCounterpartTracking == current.IdCounterparttracking);

                    // If not found, initialize new
                    if (timetrakingEmployees == null)
                    {
                        timetrakingEmployees = new TimetrakingEmployees
                        {
                            IdUser = current.IdUser,
                            IdEmployee = current.IdEmployee,
                            EmployeeCode = current.EmployeeCode,
                            IdStage = current.Id,
                            IDCounterpart = IdCounterpart,
                            IDCounterpartTracking = current.IdCounterparttracking
                        };
                    }

                    KeyValuePair<int, WorkStage> ReworkFoundStage = new KeyValuePair<int, WorkStage>();
                    KeyValuePair<int, WorkStage> ReworkDetectedStage = new KeyValuePair<int, WorkStage>();

                    // --- MAIN PROCESSING LOGIC ---
                    if (!DoneStages.Any(k => k.Code == current.Code))
                    {
                        if (ReworkStages.Any(p => p.Value.Code == current.Code))
                        {
                            // 🔹 Rework stage processed itself
                            ReworkFoundStage = ReworkStages.Pop();
                            ReworkDetectedStage = DetectedReworks.Pop();

                            DoneStages.Push(current);
                            current.ProductionTime = TimeSpan.FromSeconds(current.TimeDifference);
                            current.Production = current.ProductionTime.ToString();

                            timetrakingEmployees.ProductionTime = current.ProductionTime;
                            timetrakingEmployees.Production = current.Production;
                        }
                        else
                        {
                            if (ReworkStages.Any())
                            {
                                var lastRework = DetectedReworks.FirstOrDefault();
                                if (lastRework.Value != null)
                                {
                                    var reworkStage = lastRework.Value;
                                    reworkStage.Rework_OWSTime = reworkStage.Rework_OWSTime.Add(TimeSpan.FromSeconds(current.TimeDifference));
                                    reworkStage.Rework_OWS = reworkStage.Rework_OWSTime.ToString();
                                }

                                current.Production_OWSTime = TimeSpan.FromSeconds(current.TimeDifference);
                                current.Production_OWS = current.Production_OWSTime.ToString();

                                timetrakingEmployees.Production_OWSTime = current.Production_OWSTime;
                                timetrakingEmployees.Production_OWS = current.Production_OWS;
                            }
                            else
                            {
                                // 🔹 Normal flow
                                DoneStages.Push(current);
                                current.ProductionTime = TimeSpan.FromSeconds(current.TimeDifference);
                                current.Production = current.ProductionTime.ToString();

                                timetrakingEmployees.ProductionTime = current.ProductionTime;
                                timetrakingEmployees.Production = current.Production;
                            }
                        }
                    }
                    else
                    {
                        // 🔹 Stage already processed
                        if (ReworkStages.Any(p => p.Value.Code == current.Code))
                        {
                            ReworkFoundStage = ReworkStages.Pop();
                            ReworkDetectedStage = DetectedReworks.Pop();
                        }
                        else
                        {
                            var lastRework = DetectedReworks.FirstOrDefault();
                            if (lastRework.Value != null)
                            {
                                var reworkStage = lastRework.Value;
                                reworkStage.Rework_OWSTime = reworkStage.Rework_OWSTime.Add(TimeSpan.FromSeconds(current.TimeDifference));
                                reworkStage.Rework_OWS = reworkStage.Rework_OWSTime.ToString();
                            }
                        }

                        if (DetectedReworks.Any(p => p.Value.Code == current.Code))
                        {
                            current.ReworkTime = TimeSpan.FromSeconds(current.TimeDifference);
                            current.Rework = current.ReworkTime.ToString();

                            timetrakingEmployees.ReworkTime = current.ReworkTime;
                            timetrakingEmployees.Rework = current.Rework;
                        }
                        else
                        {
                            current.Production_OWSTime = TimeSpan.FromSeconds(current.TimeDifference);
                            current.Production_OWS = current.Production_OWSTime.ToString();

                            timetrakingEmployees.Production_OWSTime = current.Production_OWSTime;
                            timetrakingEmployees.Production_OWS = current.Production_OWS;
                        }
                    }

                    // 🔹 Handle rework chain
                    if (current.Reworks > 0 || current.Paused)
                    {
                        if (DoneStages.Any())
                            DoneStages.Pop();

                        NextReworkExists:
                        int j = i + 1;
                        if (j < stages.Count)
                        {
                            var next = stages[j];
                            ReworkStages.Push(new KeyValuePair<int, WorkStage>(i, current));

                            next.ReworkTime = TimeSpan.FromSeconds(next.TimeDifference);
                            next.Rework = next.ReworkTime.ToString();

                            var nextEmp = timeEmployeesList.FirstOrDefault(a =>
                                a.IdUser == next.IdUser && a.IdStage == next.Id);

                            //var timetrakingEmployeesnext = TimetrakingEmployeesList.Where(a => a.IdUser == next.IdUser && a.IdStage == next.Id).FirstOrDefault();
                            if (nextEmp != null)
                            {
                                nextEmp.ReworkTime = TimeSpan.FromSeconds(next.TimeDifference);
                                nextEmp.Rework = timetrakingEmployees.ReworkTime.ToString();
                                if (next.Employees == null)
                                {
                                    next.Employees = new List<TimetrakingEmployees>();
                                }
                                // next.Employees.Add(nextEmp);
                            }
                            //if (nextEmp != null)
                            //{
                            //    nextEmp.ReworkTime = next.ReworkTime;
                            //    nextEmp.Rework = next.Rework;
                            //}

                            DetectedReworks.Push(new KeyValuePair<int, WorkStage>(j, next));

                            if (next.Reworks > 0)
                            {
                                i++;
                                current = stages[i];
                                goto NextReworkExists;
                            }
                            else
                                i++;
                        }
                    }

                    // 🔹 Update stage employee list — FIXED 🔥
                    // Add/update only employees belonging to this stage
                    if (current.Employees == null)
                    {
                        current.Employees = new List<TimetrakingEmployees>();
                    }

                    var existingEmp = current.Employees
                        .FirstOrDefault(e => e.IdUser == timetrakingEmployees.IdUser && e.IdStage == timetrakingEmployees.IdStage);

                    if (existingEmp != null)
                        current.Employees.Remove(existingEmp);

                    current.Employees.Add(timetrakingEmployees);

                    // 🔹 Update master list only once per employee-stage combo
                    var existingGlobal = timeEmployeesList
                        .FirstOrDefault(e => e.IdUser == timetrakingEmployees.IdUser && e.IdStage == timetrakingEmployees.IdStage);

                    if (existingGlobal != null)
                        timeEmployeesList.Remove(existingGlobal);

                    timeEmployeesList.Add(timetrakingEmployees);
                }

                #endregion
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error ProcessWorkStages(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }



        }
        public static void CalculatedStagesData(List<WorkStage> Stageslist, string DesignType, List<ERM_CADCAMTimePerDesignType> CADCAMDesignTypeList)
        {
            try
            {
                // Final calculation of F and G
                foreach (var stage in Stageslist)
                {
                    // F = B + C + D
                    stage.Reals = stage.ProductionTime + stage.Production_OWSTime + stage.ReworkTime;
                    stage.RealTime = stage.Reals.ToString();
                    if (stage.Employees == null)
                    {
                        stage.Employees = new List<TimetrakingEmployees>();
                    }
                    var usersListOfEmployee = stage.Employees.Where(a => a.IdUser == stage.IdUser && a.IdStage == stage.Id).FirstOrDefault(); // [pallavi.jadhav][15 10 2025][APIGEOS-1712]

                    // G = A - B
                    //stage.Remaining = stage.Expecteds - stage.ProductionTime;
                    //stage.RemainingTime = stage.Remaining.ToString();

                    if (CADCAMDesignTypeList.Count() > 0)
                    {
                        var TempCADCAM = CADCAMDesignTypeList.Where(x => x.IdStage == stage.Id && x.DesignType == Convert.ToString(DesignType)).FirstOrDefault();
                        if (TempCADCAM != null)
                        {
                            if (TempCADCAM.RoleValue == "C")
                            {
                                stage.Expecteds = TimeSpan.FromSeconds(TempCADCAM.DesignValue);

                            }
                            else
                            {

                                double doubleExpected = Convert.ToDouble(stage.Expected) * Convert.ToDouble(Convert.ToDouble(TempCADCAM.DesignValue) / Convert.ToDouble(100));
                                stage.Expecteds = TimeSpan.FromMinutes(doubleExpected);

                            }
                        }
                        else
                        {
                            double doubleExpected = Convert.ToDouble(stage.Expected);
                            stage.Expecteds = TimeSpan.FromMinutes(doubleExpected);
                        }
                    }
                    else
                    {
                        double doubleExpected = Convert.ToDouble(stage.Expected);
                        stage.Expecteds = TimeSpan.FromMinutes(doubleExpected);
                    }

                    stage.Expected = (decimal)stage.Expecteds.TotalMinutes;
                    stage.ExpectedTime = stage.Expecteds.ToString();
                    // G = A - B
                    stage.Remaining = stage.Expecteds - stage.ProductionTime;
                    stage.RemainingTime = stage.Remaining.ToString();
                    stage.Real = (decimal)stage.Reals.TotalMinutes;
                    #region // [pallavi.jadhav][15 10 2025][APIGEOS-1712]
                    if (usersListOfEmployee != null)
                    {
                        usersListOfEmployee.Reals = usersListOfEmployee.ProductionTime + usersListOfEmployee.Production_OWSTime + usersListOfEmployee.ReworkTime;
                        usersListOfEmployee.RealTime = stage.Reals.ToString();

                    }
                    #endregion


                }
            }
            catch (Exception ex)
            {

                Log4NetLogger.Logger.Log(string.Format("Error CalculatedStagesData(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
        }

        public GeosAppSettingAPI GetGeosAppSettings(Int16 IdAppSetting, string connectionString)
        {
            GeosAppSettingAPI geosAppSetting = new GeosAppSettingAPI();

            using (MySqlConnection MyConnection = new MySqlConnection(connectionString))
            {
                MyConnection.Open();
                MySqlCommand myCommand = new MySqlCommand("geosappsettings_GetGeosAppSettings", MyConnection);
                myCommand.CommandType = CommandType.StoredProcedure;
                myCommand.Parameters.AddWithValue("_IdAppSetting", IdAppSetting);

                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        geosAppSetting.idAppSetting = IdAppSetting;
                        geosAppSetting.defaultValue = reader["DefaultValue"].ToString();
                        geosAppSetting.appSettingName = reader["AppSettingName"].ToString();
                    }

                    reader.Close();
                }

                myCommand.Dispose();
                MyConnection.Close();
            }

            return geosAppSetting;
        }
        public static GeosAppSettingAPI GetGeosAppSettingsByPlant(Int16 IdAppSetting, string connectionString)
        {
            GeosAppSettingAPI geosAppSetting = new GeosAppSettingAPI();

            using (MySqlConnection MyConnection = new MySqlConnection(connectionString))
            {
                MyConnection.Open();
                MySqlCommand myCommand = new MySqlCommand("geosappsettings_GetGeosAppSettings", MyConnection);
                myCommand.CommandType = CommandType.StoredProcedure;
                myCommand.Parameters.AddWithValue("_IdAppSetting", IdAppSetting);

                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        geosAppSetting.idAppSetting = IdAppSetting;
                        geosAppSetting.defaultValue = reader["DefaultValue"].ToString();
                        geosAppSetting.appSettingName = reader["AppSettingName"].ToString();
                    }

                    reader.Close();
                }

                myCommand.Dispose();
                MyConnection.Close();
            }

            return geosAppSetting;
        }

        private void FillCADCAMDesignTypeList(string ConnectionString)
        {
            try
            {
                GeosAppSettingAPI AppSetting = new GeosAppSettingAPI();

                AppSetting = GetGeosAppSettings(124, ConnectionString);
                if (AppSetting != null)
                {
                    CADCAMDesignTypeList = new List<ERM_CADCAMTimePerDesignType>();
                    List<string> tempWorkStageList = new List<string>();
                    //foreach (var item in AppSetting)
                    //{
                    string tempstring = Convert.ToString(AppSetting.defaultValue.Replace('(', ' '));
                    tempstring = tempstring.Replace(')', ' ');
                    tempWorkStageList = Convert.ToString(tempstring).Split(',').ToList();
                    // }
                    if (tempWorkStageList.Count > 0)
                    {
                        foreach (var item in tempWorkStageList)
                        {
                            List<string> tempIDStageList = Convert.ToString(item.Trim()).Split(';').ToList();
                            if (tempIDStageList.Count() > 0)
                            {
                                ERM_CADCAMTimePerDesignType selectCADCAMDesignTypeList = new ERM_CADCAMTimePerDesignType();
                                selectCADCAMDesignTypeList.IdStage = Convert.ToInt32(tempIDStageList[0]);
                                selectCADCAMDesignTypeList.DesignType = Convert.ToString(tempIDStageList[1]);
                                selectCADCAMDesignTypeList.DesignValue = Convert.ToInt32(tempIDStageList[2]);
                                selectCADCAMDesignTypeList.RoleValue = Convert.ToString(tempIDStageList[3]);
                                CADCAMDesignTypeList.Add(selectCADCAMDesignTypeList);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {

            }

        }

        public bool IsActiveERMPlant(string ERMConnectionString)
        {

            bool IsActivePlant = false;
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(ERMConnectionString))
                {
                    try
                    {
                        mySqlConnection.Open();
                        IsActivePlant = true;
                    }
                    catch (Exception)
                    {
                        IsActivePlant = false;
                        //throw;
                    }


                }
            }
            catch (Exception ex)
            {

            }
            return IsActivePlant;
        }
        public static StageByOTItemAndIDDrawingAPI GetAllStagesPerIDOTItemAndIDDrawing_V2500(string ERMConnectionString, int? IdSite = null)
        {
            StageByOTItemAndIDDrawingAPI stagesList = new StageByOTItemAndIDDrawingAPI
            {
                OTITemStagesList = new List<StagesAPI>(),
                DrawingIdStagesList = new List<StagesAPI>()
            };

            try
            {
                using (MySqlConnection connection = new MySqlConnection(ERMConnectionString))
                {
                    connection.Open();

                    using (MySqlCommand command = new MySqlCommand("API_GetAllStagesPerIDOTItemAndIDDrawing_V740", connection))
                    {
                        command.CommandType = CommandType.StoredProcedure;
                        command.CommandTimeout = 6000; // 3 minutes (adjust if needed)

                        // Optional parameter
                        if (IdSite.HasValue)
                            command.Parameters.AddWithValue("_IdSite", IdSite.Value);

                        using (MySqlDataReader reader = command.ExecuteReader())
                        {
                            // First Result Set
                            while (reader.Read())
                            {
                                var otItemStage = new StagesAPI
                                {
                                    IdStages = reader["IdStage"] != DBNull.Value ? Convert.ToByte(reader["IdStage"]) : (byte)0,
                                    Name = reader["Name"] != DBNull.Value ? reader["Name"].ToString() : null,
                                    Code = reader["Code"] != DBNull.Value ? reader["Code"].ToString() : null,
                                    IdSequence = reader["Sequence"] != DBNull.Value ? Convert.ToInt32(reader["Sequence"]) : 0
                                };

                                stagesList.OTITemStagesList.Add(otItemStage);
                            }

                            // Second Result Set
                            if (reader.NextResult())
                            {
                                while (reader.Read())
                                {
                                    var drawingStage = new StagesAPI
                                    {
                                        IdStages = reader["IdStage"] != DBNull.Value ? Convert.ToInt32(reader["IdStage"]) : 0,
                                        Name = reader["Name"] != DBNull.Value ? reader["Name"].ToString() : null,
                                        Code = reader["Code"] != DBNull.Value ? reader["Code"].ToString() : null,
                                        IdSequence = reader["Sequence"] != DBNull.Value ? Convert.ToInt32(reader["Sequence"]) : 0
                                    };

                                    stagesList.DrawingIdStagesList.Add(drawingStage);
                                }
                            }
                        }
                    }
                }
            }
            catch (MySqlException mysqlEx)
            {
                Log4NetLogger.Logger.Log(
                    $"MySQL error in GetAllStagesPerIDOTItemAndIDDrawing_V2500: {mysqlEx.Message}",
                    category: Category.Exception,
                    priority: Priority.High);
                throw;
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(
                    $"Unhandled error in GetAllStagesPerIDOTItemAndIDDrawing_V2500: {ex.Message}",
                    category: Category.Exception,
                    priority: Priority.High);
                throw;
            }

            return stagesList;
        }


        public List<TimeTrackingProductionStageAPI> GetAllTimeTrackingProductioStage(string ERMConnectionString)
        {

            List<TimeTrackingProductionStageAPI> ProductionStages = new List<TimeTrackingProductionStageAPI>();

            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(ERMConnectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("ERM_GetAllTimeTrackingProductionStage_V2390", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.CommandTimeout = 6000; // 3 minutes (adjust if needed)


                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            TimeTrackingProductionStageAPI ProductionStage = new TimeTrackingProductionStageAPI();

                            ProductionStage.IdStage = Convert.ToInt32(reader["IdStage"]);

                            if (reader["Name"] != DBNull.Value)
                                ProductionStage.StageName = Convert.ToString(reader["Name"]);

                            if (reader["Code"] != DBNull.Value)
                                ProductionStage.StageCode = Convert.ToString(reader["Code"]);
                            if (reader["Sequence"] != DBNull.Value)
                                ProductionStage.Sequence = Convert.ToInt32(reader["Sequence"]);
                            if (reader["ActiveInPlants"] != DBNull.Value)
                                ProductionStage.ActiveInPlants = Convert.ToString(reader["ActiveInPlants"]);

                            ProductionStages.Add(ProductionStage);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetAllTimeTrackingProductioStage().  ErrorMessage- {1}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return ProductionStages;
        }

        public List<SiteByShippingAddressAPI> GetAllSitesByShippingAddress(string ERMConnectionString)
        {
            List<SiteByShippingAddressAPI> SitesListByShippingAddress = new List<SiteByShippingAddressAPI>();

            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(ERMConnectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("ERM_GetAllSiteIdByShippingAddress_V2360", mySqlConnection);
                    //mySqlCommand.Parameters.AddWithValue("_IdSiteName", Plant);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {

                            SiteByShippingAddressAPI siteByShippingAddress = new SiteByShippingAddressAPI();

                            if (reader["IdSite"] != DBNull.Value)
                            {
                                siteByShippingAddress.IdSite = Convert.ToUInt32(reader["IdSite"]);
                            }

                            if (reader["ShortName"] != DBNull.Value)
                            {
                                siteByShippingAddress.Name = Convert.ToString(reader["ShortName"]);
                            }

                            if (reader["IdShippingAddress"] != DBNull.Value)
                            {
                                siteByShippingAddress.IdShippingAddress = Convert.ToUInt32(reader["IdShippingAddress"]);
                            }

                            SitesListByShippingAddress.Add(siteByShippingAddress);
                        }

                        //List<TimeTracking> timeTrackingList = new List<TimeTracking>();
                        //timeTrackingList.siteList = IdSites;
                        return SitesListByShippingAddress;

                    }
                    //mySqlConnection.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetAllSitesByShippingAddress(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                return SitesListByShippingAddress;
            }

        }
        public static GeosAppSettingAPI GetGeosAppSettingsemdep(Int16 IdAppSetting, string connectionString)
        {
            GeosAppSettingAPI geosAppSetting = new GeosAppSettingAPI();

            using (MySqlConnection MyConnection = new MySqlConnection(connectionString))
            {
                MyConnection.Open();
                MySqlCommand myCommand = new MySqlCommand("geosappsettings_GetGeosAppSettings", MyConnection);
                myCommand.CommandType = CommandType.StoredProcedure;
                myCommand.Parameters.AddWithValue("_IdAppSetting", IdAppSetting);

                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        geosAppSetting.idAppSetting = IdAppSetting;
                        geosAppSetting.defaultValue = reader["DefaultValue"].ToString();
                        geosAppSetting.appSettingName = reader["AppSettingName"].ToString();
                    }

                    reader.Close();
                }

                myCommand.Dispose();
                MyConnection.Close();
            }

            return geosAppSetting;
        }

        private class ReworkData
        {
            public Int64 IdOT;
            public Int64 IdOTItem;
            public Int64 IdDrawing;
            public Int64 IdCounterpart;
        }
    }
    public static class CommonManager
    {
        public static Dictionary<string, string> DictonaryPlant = new Dictionary<string, string>();
        public static string ConnString;
        public static Dictionary<string, string> DictonarySites = new Dictionary<string, string>();
        public static Dictionary<string, Dictionary<string, string>> DictonarySitesGDB02 = new Dictionary<string, Dictionary<string, string>>();
        public static Dictionary<string, string> DictonarySitesWithIds = new Dictionary<string, string>();
        public static Dictionary<string, string> GetAllSites()
        {
            //Dictionary<string, string> DictonarySites = new Dictionary<string, string>();

            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetAllSites()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(ConnString))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GeosApiGetAllSites", conn);
                    command.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            if (!DictonarySites.ContainsKey(dr["ShortName"].ToString()) &&
                                !DictonarySites.ContainsValue(dr["DatabaseIP"].ToString()))
                                DictonarySites.Add(dr["ShortName"].ToString(), dr["DatabaseIP"].ToString());
                            if (!DictonarySitesWithIds.ContainsKey(dr["ShortName"].ToString()))
                                DictonarySitesWithIds.Add(dr["ShortName"].ToString(), dr["idSite"].ToString());
                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetAllSites()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetAllSites(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            return DictonarySites;
        }

        public static Dictionary<string, Dictionary<string, string>> GetAllSitesGDB02()
        {
            try
            {
                Log4NetLogger.Logger.Log(string.Format("Method GetAllSitesGDB02()...."), category: Category.Info, priority: Priority.Low);
                using (MySqlConnection conn = new MySqlConnection(ConnString))
                {
                    conn.Open();
                    MySqlCommand command = new MySqlCommand("GEOSAPI_GeosApiGetAllSitesGDB02", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    using (MySqlDataReader dr = command.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            string shortName = dr["ShortName"].ToString();
                            string databaseIP = dr["DatabaseIP"].ToString();
                            string name = dr["Name"].ToString();
                            if (!DictonarySitesGDB02.ContainsKey(name))
                            {
                                DictonarySitesGDB02.Add(name, new Dictionary<string, string> { { shortName, databaseIP } });
                            }

                        }
                    }
                }
                Log4NetLogger.Logger.Log(string.Format("Method GetAllSitesGDB02()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetAllSitesGDB02(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            return DictonarySitesGDB02;
        }
        public static Dictionary<string, string> GetAllPlant(string Plant)  //[Pallavi Jadhav][APIGEOS-728][02 03 2023]
        {
            //Dictionary<string, string> DictonarySites = new Dictionary<string, string>();

            try
            {
                if (Plant != "0" && Plant != null)
                {
                    string[] plants = Plant.Split(',');

                    foreach (var plant in plants)
                    {

                        Log4NetLogger.Logger.Log(string.Format("Method GetAllSites()...."), category: Category.Info, priority: Priority.Low);
                        using (MySqlConnection conn = new MySqlConnection(ConnString))
                        {
                            conn.Open();
                            MySqlCommand command = new MySqlCommand("GEOSAPI_GeosApiGetAllSites", conn);
                            command.CommandType = CommandType.StoredProcedure;
                            command.Parameters.AddWithValue("_Name", plant);
                            using (MySqlDataReader dr = command.ExecuteReader())
                            {
                                while (dr.Read())
                                {
                                    DictonaryPlant.Add((dr["ShortName"].ToString()), dr["DatabaseIP"].ToString());
                                }
                            }
                        }
                    }
                }
                else
                {
                    using (MySqlConnection conn = new MySqlConnection(ConnString))
                    {
                        conn.Open();
                        MySqlCommand command = new MySqlCommand("GEOSAPI_GeosApiGetAllSites", conn);
                        command.CommandType = CommandType.StoredProcedure;
                        command.Parameters.AddWithValue("_Name", null);
                        using (MySqlDataReader dr = command.ExecuteReader())
                        {

                            while (dr.Read())
                            {
                                DictonaryPlant.Add((dr["ShortName"].ToString()), dr["DatabaseIP"].ToString());
                            }
                        }
                    }
                }

                Log4NetLogger.Logger.Log(string.Format("Method GetAllSites()....Executed successfully."), category: Category.Info, priority: Priority.Low);
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetAllSites(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw ex;
            }
            return DictonaryPlant;
        }

    }
    #endregion
}