using Emdep.Geos.Data.BusinessLogic.Logging;
using Emdep.Geos.Data.Common;
using Emdep.Geos.Data.Common.APM;
using Emdep.Geos.Data.Common.Epc;
using Emdep.Geos.Data.Common.Hrm;
using Emdep.Geos.Data.Common.PCM;
using Emdep.Geos.Services.Contracts;
using Emdep.Geos.Data.Common.PLM;
using Emdep.Geos.Utility;
using MySql.Data.MySqlClient;
using Prism.Logging;
using ServiceStack;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Configuration;
using System.Data;
using System.Data.Entity;
using System.IO;
using System.IO.Compression;
using System.Linq;
using System.Net.Mail;
using System.Security.Cryptography.X509Certificates;
using System.Text;
using System.Threading.Tasks;
using System.Transactions;

namespace Emdep.Geos.Data.BusinessLogic
{
    public class APMManager
    {
        public APMManager()
        {
            try
            {
                if (Log4NetLogger.Logger == null)
                {
                    string ApplicationLogFilePath = System.Web.Hosting.HostingEnvironment.MapPath("/") + "log4net.config";
                    CreateIfNotExists(ApplicationLogFilePath);//[GEOS2-5404][rdixit][13.08.2024]
                    FileInfo file = new FileInfo(ApplicationLogFilePath);
                    Log4NetLogger.Logger = LoggerFactory.CreateLogger(LogType.Log4Net, file);
                    Log4NetLogger.Logger.Log(string.Format("APMManager()..... Constructor Executed"), category: Category.Info, priority: Priority.Low);
                }
            }
            catch
            {
                throw;
            }
        }
        //[GEOS2-5404][rdixit][13.08.2024]
        void CreateIfNotExists(string config_path)
        {
            string log4netConfig = @"<?xml version=""1.0"" encoding=""utf-8""?>
                                        <configuration>
                                          <configSections>
                                            <section name=""log4net"" type=""log4net.Config.Log4NetConfigurationSectionHandler, log4net"" />
                                          </configSections>
                                          <log4net debug=""true"">
                                            <appender name=""RollingLogFileAppender"" type=""log4net.Appender.RollingFileAppender"">
                                              <file value=""C:\Temp\LogsService.txt""/>
                                              <appendToFile value=""true"" />
                                              <rollingStyle value=""Size"" />
                                              <maxSizeRollBackups value=""10"" />
                                              <maximumFileSize value=""10MB"" />
                                              <staticLogFileName value=""true"" />
                                              <layout type=""log4net.Layout.PatternLayout"">
                                                <conversionPattern value=""%-5p %d %5rms - %m%n"" />
                                              </layout>
                                            </appender>
                                            <root>
                                              <level value=""Info"" />
                                              <appender-ref ref=""RollingLogFileAppender"" />
                                            </root>
                                          </log4net>
                                        </configuration>";

            if (!File.Exists(config_path))
            {
                File.WriteAllText(config_path, log4netConfig);
            }
        }

        public List<APMActionPlan> GetActionPlanDetails_V2550(string connectionString, long selectedPeriod)
        {
            List<APMActionPlan> actionPlanList = new List<APMActionPlan>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_V2550", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlan actionPlan = new APMActionPlan();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }

                            //if (actionPlan.TaskList==null)
                            //{
                            //    actionPlan.TaskList = new List<APMActionPlanTask>();
                            //}

                            //actionPlan.TaskList.AddRange(GetActionPlanTaskByIdActionPlan_V2550(connectionString, actionPlan.IdActionPlan));

                            actionPlanList.Add(actionPlan);
                        }
                    }
                }

                foreach (var item in actionPlanList)
                {
                    if (item.TotalActionItems != 0)
                    {
                        item.Percentage = (int)(((float)item.TotalClosedItems / item.TotalActionItems) * 100);
                    }
                    else
                    {
                        item.Percentage = 0;
                    }

                    if (item.Percentage <= 24)
                    {
                        item.TotalClosedColor = "Red";
                    }
                    else if (item.Percentage >= 25 && item.Percentage <= 49)
                    {
                        item.TotalClosedColor = "Orange";
                    }
                    else if (item.Percentage >= 50 && item.Percentage <= 74)
                    {
                        item.TotalClosedColor = "Yellow";
                    }
                    else if (item.Percentage >= 75 && item.Percentage <= 99)
                    {
                        item.TotalClosedColor = "LightGreen";
                    }
                    else if (item.Percentage == 100)
                    {
                        item.TotalClosedColor = "Green";
                    }
                }

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2550(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return actionPlanList;
        }


        //[Sudhir.Jangra][GEOS2-5971]
        public List<Company> GetAuthorizedLocationListByIdUser_V2550(string workbenchConnectionString, Int32 idUser)
        {
            List<Company> companies = new List<Company>();

            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(workbenchConnectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetAuthorizedLocationListByIdUser_V2550", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_idUser", idUser);

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {

                        while (reader.Read())
                        {
                            Company company = new Company();
                            if (reader["IdCompany"] != DBNull.Value)
                            {
                                company.IdCompany = Convert.ToInt32(reader["IdCompany"]);
                                company.Name = Convert.ToString(reader["CompanyName"]);
                                company.Alias = Convert.ToString(reader["Alias"]);
                                company.ShortName = Convert.ToString(reader["Alias"]);
                                if (reader["IdCountry"] != DBNull.Value)
                                {
                                    company.IdCountry = Convert.ToByte(reader["IdCountry"]);
                                    company.Country = new Country();
                                    company.Country.IdCountry = Convert.ToByte(reader["IdCountry"]);
                                    company.Country.Name = Convert.ToString(reader["CountryName"]);
                                }
                                if (reader["IsLocation"] != DBNull.Value)
                                    company.IsLocation = Convert.ToByte(reader["IsLocation"]);

                                if (reader["IsOrganization"] != DBNull.Value)
                                    company.IsOrganization = Convert.ToByte(reader["IsOrganization"]);

                                if (reader["IsCompany"] != DBNull.Value)
                                    company.IsCompany = Convert.ToByte(reader["IsCompany"]);

                                if (reader["IsStillActive"] != DBNull.Value)
                                    company.IsStillActive = Convert.ToByte(reader["IsStillActive"]);

                                if (reader["IdCurrency"] != DBNull.Value)
                                {
                                    company.IdCurrency = Convert.ToInt16(reader["IdCurrency"]);
                                }
                            }
                            companies.Add(company);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetAuthorizedLocationListByIdUser_V2550(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return companies;
        }

        //[Sudhir.Jangra][GEOS2-5972]
        public List<APMActionPlanTask> GetActionPlanTaskByIdActionPlan_V2560(string workbenchConnectionString, Int64 idActionPlan)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();

            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(workbenchConnectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanTaskByIdActionPlan_V2560", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", idActionPlan);

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {

                        while (reader.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();
                            if (reader["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(reader["IdTask"]);
                            }
                            if (reader["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(reader["TaskNumber"]);
                            }
                            if (reader["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(reader["Title"]);
                            }
                            if (reader["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(reader["EmployeeCode"]);
                            }
                            if (reader["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(reader["IdEmployee"]);
                            }
                            if (reader["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(reader["Responsible"]);
                            }
                            if (reader["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(reader["IdGender"]);
                            }
                            if (reader["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(reader["IdLookupStatus"]);
                            }
                            if (reader["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(reader["Status"]);
                            }
                            if (reader["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(reader["StatusHTMLColor"]);
                            }

                            if (reader["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(reader["IdLookupPriority"]);
                            }
                            if (reader["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(reader["Priority"]);
                            }
                            if (reader["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(reader["IdLookupTheme"]);
                            }
                            if (reader["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(reader["Theme"]);
                            }
                            if (reader["IdLookupBusiness"] != DBNull.Value)
                            {
                                task.IdLookupBusiness = Convert.ToInt32(reader["IdLookupBusiness"]);
                            }
                            if (reader["BusinessUnit"] != DBNull.Value)
                            {
                                task.BusinessUnit = Convert.ToString(reader["BusinessUnit"]);
                            }
                            if (reader["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(reader["DueDate"]);
                            }
                            if (reader["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(reader["DueDays"]);
                            }
                            if (reader["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(reader["DueColor"]);
                            }
                            if (reader["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(reader["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(reader["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(reader["DelegatedTo"]);
                            }
                            if (reader["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(reader["DelegatedTo"]);
                            }
                            if (reader["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(reader["Comments"]);
                            }
                            if (reader["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(reader["TaskLastComments"]);
                            }

                            if (reader["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(reader["Files"]);
                            }
                            if (reader["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(reader["Progress"]);
                            }
                            if (reader["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(reader["IdLocation"]);
                            }
                            if (reader["IdActionPlan"] != DBNull.Value)
                            {
                                task.IdActionPlan = Convert.ToInt32(reader["IdActionPlan"]);
                            }

                            taskList.Add(task);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanTaskByIdActionPlan_V2560(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return taskList;
        }

        //[Sudhir.Jangra][GEOS2-5972]
        public List<APMActionPlan> GetActionPlanDetails_V2560(string connectionString, long selectedPeriod, string countryIconFilePath)
        {
            List<APMActionPlan> actionPlanList = new List<APMActionPlan>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_V2560", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlan actionPlan = new APMActionPlan();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                if (!countryISOs.Any(co => co.ToString() == actionPlan.Country.Iso))
                                {
                                    countryISOs.Add(actionPlan.Country.Iso);
                                }
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }

                            if (actionPlan.TaskList == null)
                            {
                                actionPlan.TaskList = new List<APMActionPlanTask>();
                            }

                            actionPlan.TaskList.AddRange(GetActionPlanTaskByIdActionPlan_V2560(connectionString, actionPlan.IdActionPlan));

                            actionPlanList.Add(actionPlan);
                        }
                    }
                }

                foreach (var item in actionPlanList)
                {
                    if (item.TotalActionItems != 0)
                    {
                        item.Percentage = (int)(((float)item.TotalClosedItems / item.TotalActionItems) * 100);
                    }
                    else
                    {
                        item.Percentage = 0;
                    }

                    if (item.Percentage <= 24)
                    {
                        item.TotalClosedColor = "Red";
                    }
                    else if (item.Percentage >= 25 && item.Percentage <= 49)
                    {
                        item.TotalClosedColor = "Orange";
                    }
                    else if (item.Percentage >= 50 && item.Percentage <= 74)
                    {
                        item.TotalClosedColor = "Yellow";
                    }
                    else if (item.Percentage >= 75 && item.Percentage <= 99)
                    {
                        item.TotalClosedColor = "LightGreen";
                    }
                    else if (item.Percentage == 100)
                    {
                        item.TotalClosedColor = "Green";
                    }
                }

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2560(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            foreach (string item in countryISOs)
            {
                byte[] bytes = null;
                bytes = GetCountryIconFileInBytes(item, countryIconFilePath);
                actionPlanList.Where(oi => oi.Country.Iso == item).ToList().ForEach(oi => oi.Country.CountryIconBytes = bytes);
            }

            return actionPlanList;
        }



        //[Sudhir.Jangra][GEOS2-5977]
        public Responsible GetEmployeeCurrentDetail_V2560(string workbenchConnectionString, Int32 idUser, Int64 selectedPeriod)
        {
            Responsible employee = new Responsible();
            using (MySqlConnection mySqlConnection = new MySqlConnection(workbenchConnectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("APM_GetEmployeeCurrentDetails_V2560", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdUser", idUser);
                mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.NextResult())
                        while (reader.Read())
                        {
                            try
                            {

                                if (reader["IdEmployee"] != DBNull.Value)
                                    employee.IdEmployee = Convert.ToUInt32(reader["IdEmployee"]);

                                employee.EmployeeDepartments = Convert.ToString(reader["departIds"]);
                                employee.Organization = Convert.ToString(reader["companiesIds"]);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetEmployeeCurrentDetail_V2560(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                }
            }

            return employee;
        }


        //[Sudhir.Jangra][GEOS2-5977]
        public List<Responsible> GetActiveInactiveResponsibleForActionPlan_V2560(string connectionString, Int32 IdCompany, long selectedPeriod, string idsOrganization, string idsDepartments, Int32 idPermission)
        {
            List<Responsible> responsibleList = new List<Responsible>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActiveInactiveResponsibleForActionPlan_V2560", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdCompany", IdCompany);
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_idsOrganizationPlant", idsOrganization);
                    mySqlCommand.Parameters.AddWithValue("_idsDepartment", idsDepartments);
                    mySqlCommand.Parameters.AddWithValue("_idPermission", idPermission);
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                Responsible responsible = new Responsible();
                                if (rdr["IdEmployee"] != DBNull.Value)
                                {
                                    responsible.IdEmployee = Convert.ToUInt32(rdr["IdEmployee"]);
                                }
                                if (rdr["EmployeeCode"] != DBNull.Value)
                                {
                                    responsible.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                }
                                if (rdr["FirstName"] != DBNull.Value)
                                {
                                    responsible.FirstName = Convert.ToString(rdr["FirstName"]);
                                }
                                if (rdr["LastName"] != DBNull.Value)
                                {
                                    responsible.LastName = Convert.ToString(rdr["LastName"]);
                                }
                                if (rdr["FullName"] != DBNull.Value)
                                {
                                    responsible.FullName = Convert.ToString(rdr["FullName"]);
                                }

                                if (rdr["IdGender"] != DBNull.Value)
                                {
                                    responsible.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                }

                                if (rdr["IdCompany"] != DBNull.Value)
                                {
                                    responsible.IdOrganizationCode = Convert.ToInt32(rdr["IdCompany"]);
                                }
                                if (rdr["OrganizationCode"] != DBNull.Value)
                                {
                                    responsible.Organization = Convert.ToString(rdr["OrganizationCode"]);
                                }
                                if (rdr["IdEmployeeStatus"] != DBNull.Value)
                                {
                                    responsible.IdEmployeeStatus = Convert.ToInt16(rdr["IdEmployeeStatus"]);
                                }
                                if (rdr["JobCode"] != DBNull.Value)
                                {
                                    responsible.JobCode = Convert.ToString(rdr["JobCode"]);
                                }


                                responsibleList.Add(responsible);
                            }

                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActiveInactiveResponsibleForActionPlan_V2560(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return responsibleList;
        }



        //[Sudhir.Jangra][GEOS2-5977]
        public Responsible GetInactiveResponsibleForActionPlan_V2560(string connectionString, Int32 IdEmployee)
        {
            Responsible responsible = new Responsible();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetInActiveResponsibleForEditActionPlan_V2560", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdEmployee", IdEmployee);

                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        if (rdr.Read())
                        {
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                responsible.IdEmployee = Convert.ToUInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                responsible.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                responsible.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                responsible.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["FullName"] != DBNull.Value)
                            {
                                responsible.FullName = Convert.ToString(rdr["FullName"]);
                            }

                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                responsible.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                responsible.IdOrganizationCode = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["OrganizationCode"] != DBNull.Value)
                            {
                                responsible.Organization = Convert.ToString(rdr["OrganizationCode"]);
                            }
                            if (rdr["IdEmployeeStatus"] != DBNull.Value)
                            {
                                responsible.IdEmployeeStatus = Convert.ToInt16(rdr["IdEmployeeStatus"]);
                            }
                            if (rdr["JobCode"] != DBNull.Value)
                            {
                                responsible.JobCode = Convert.ToString(rdr["JobCode"]);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetInactiveResponsibleForActionPlan_V2560(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return responsible;
        }


        //[Sudhir.Jangra][GEOS2-5977]
        public bool UpdateActionPlan_V2560(string connectionString, APMActionPlan actionPlan)
        {
            bool isUpdated = false;
            try
            {
                if (actionPlan != null)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateActionPlan_V2560", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlan.IdActionPlan);
                            mySqlCommand.Parameters.AddWithValue("_Description", actionPlan.Description);
                            mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlan.IdCompany);
                            mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlan.IdEmployee);
                            mySqlCommand.Parameters.AddWithValue("_IdOrigin", actionPlan.IdLookupOrigin);
                            mySqlCommand.Parameters.AddWithValue("_ModifiedBy", actionPlan.ModifiedBy);


                            mySqlCommand.ExecuteNonQuery();
                            mySqlConnection.Close();


                        }

                        transactionScope.Complete();
                        transactionScope.Dispose();
                        isUpdated = true;
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateActionPlan_V2560(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }

        //[Sudhir.Jangra][GEOS2-5978]
        public string GetActionPlanLatestCode_V2560(string connectionString)
        {
            string code = string.Empty;
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanLatestCode_V2560", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        if (rdr.Read())
                        {
                            int num = 0;
                            if (rdr["CodePart"] != DBNull.Value)
                            {
                                num = Convert.ToInt32(rdr["CodePart"]);
                                num++;
                            }
                            string year = DateTime.Now.Year.ToString();
                            string lastTwoDigits = year.Substring(year.Length - 2);
                            code = "AP" + lastTwoDigits + "." + num.ToString("D4");
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanLatestCode_V2560(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return code;
        }


        //[Sudhir.jangra][GEOS2-5978]
        public APMActionPlan AddActionPlanDetails_V2560(string connectionString, APMActionPlan actionPlan)
        {
            bool isAdded = false;
            try
            {
                if (actionPlan != null)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("APM_AddActionPlanDetails_V2560", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_Code", actionPlan.Code);
                            mySqlCommand.Parameters.AddWithValue("_Description", actionPlan.Description);
                            mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlan.IdCompany);
                            mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlan.IdEmployee);
                            mySqlCommand.Parameters.AddWithValue("_IdOrigin", actionPlan.IdLookupOrigin);
                            mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlan.CreatedBy);

                            actionPlan.IdActionPlan = Convert.ToInt64(mySqlCommand.ExecuteScalar());

                            mySqlConnection.Close();
                        }

                        transactionScope.Complete();
                        transactionScope.Dispose();
                        isAdded = true;
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddActionPlanDetails_V2560(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlan;
        }
        //[shweta.thube][GEOS2-5979]
        public bool AddTaskForActionPlan_V2560(string connectionString, APMActionPlanTask actionPlanTask)
        {
            bool isAdded = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertTaskForActionPlan_V2560", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlanTask.IdLookupBusiness);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlanTask.CreatedBy);
                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();


                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isAdded = true;
                }

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddTaskForActionPlan_V2560(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isAdded;
        }




        //[Sudhir.Jangra][GEOS2-6397]
        public List<Company> GetAuthorizedLocationListByIdUser_V2560(string workbenchConnectionString, Int32 idUser, string countryIconFilePath)
        {
            List<Company> companies = new List<Company>();
            List<string> countryISOs = new List<string>();

            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(workbenchConnectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetAuthorizedLocationListByIdUser_V2560", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_idUser", idUser);

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {

                        while (reader.Read())
                        {
                            Company company = new Company();
                            if (reader["IdCompany"] != DBNull.Value)
                            {
                                company.IdCompany = Convert.ToInt32(reader["IdCompany"]);
                                company.Name = Convert.ToString(reader["CompanyName"]);
                                company.Alias = Convert.ToString(reader["Alias"]);
                                company.ShortName = Convert.ToString(reader["Alias"]);
                                if (reader["IdCountry"] != DBNull.Value)
                                {
                                    company.IdCountry = Convert.ToByte(reader["IdCountry"]);
                                    company.Country = new Country();
                                    company.Country.IdCountry = Convert.ToByte(reader["IdCountry"]);
                                    company.Country.Name = Convert.ToString(reader["CountryName"]);
                                }
                                if (reader["IsLocation"] != DBNull.Value)
                                    company.IsLocation = Convert.ToByte(reader["IsLocation"]);

                                if (reader["IsOrganization"] != DBNull.Value)
                                    company.IsOrganization = Convert.ToByte(reader["IsOrganization"]);

                                if (reader["IsCompany"] != DBNull.Value)
                                    company.IsCompany = Convert.ToByte(reader["IsCompany"]);

                                if (reader["IsStillActive"] != DBNull.Value)
                                    company.IsStillActive = Convert.ToByte(reader["IsStillActive"]);

                                if (reader["IdCurrency"] != DBNull.Value)
                                {
                                    company.IdCurrency = Convert.ToInt16(reader["IdCurrency"]);
                                }
                                if (reader["CountryISO"] != DBNull.Value)
                                {
                                    company.Iso = Convert.ToString(reader["CountryISO"]);

                                    if (!countryISOs.Any(co => co.ToString() == company.Iso))
                                    {
                                        countryISOs.Add(company.Iso);
                                    }
                                }
                            }
                            companies.Add(company);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetAuthorizedLocationListByIdUser_V2560(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            foreach (string item in countryISOs)
            {
                byte[] bytes = null;
                bytes = GetCountryIconFileInBytes(item, countryIconFilePath);
                companies.Where(ot => ot.Iso == item).ToList().ForEach(ot => ot.ImageInBytes = bytes);
            }
            return companies;
        }

        //[Sudhir.jangra][GEOS2-6397]
        public byte[] GetCountryIconFileInBytes(string countryiso, string filepath)
        {
            byte[] bytes = null;
            try
            {
                string filenamepng = countryiso + ".png";
                string filenamejpg = countryiso + ".jpg";
                string filepathjpg = Path.Combine(filepath, filenamejpg);
                string filepathpng = Path.Combine(filepath, filenamepng);

                if (File.Exists(filepathjpg))
                {

                    using (System.IO.FileStream stream = new System.IO.FileStream(filepathjpg, System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;
                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }
                }
                else if (File.Exists(filepathpng))
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(filepathpng, System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;
                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }
                }
                return bytes;

            }
            catch (FileNotFoundException ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetCountryIconFileInBytes() ISO-{0}. ErrorMessage- {1}", countryiso, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            catch (DirectoryNotFoundException ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetCountryIconFileInBytes() ISO-{0}. ErrorMessage- {1}", countryiso, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetCountryIconFileInBytes() ISO-{0}. ErrorMessage- {1}", countryiso, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
        }
        // [shweta.thube][GEOS2-5980]
        public bool UpdateTaskForActionPlan_V2560(string connectionString, APMActionPlanTask actionPlanTask)
        {
            bool isUpdated = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateTaskForActionPlan_V2560", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        // Adding parameters to update the record
                        mySqlCommand.Parameters.AddWithValue("_IdTask", actionPlanTask.IdActionPlanTask);
                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlanTask.IdLookupBusiness);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_ModifiedBy", actionPlanTask.ModifiedBy);
                        // mySqlCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isUpdated = true;
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateTaskForActionPlan_V2560(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }

        //[Sudhir.Jangra][GEOS2-6017]//By Default Commited
        public bool UpdateTaskDelegatedTo_V2570(string connectionString, APMActionPlanTask task)
        {
            bool isUpdated = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("", mySqlConnection);
                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", task.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_IdTask", task.IdActionPlanTask);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", task.IdDelegated);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isUpdated = true;
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateTaskDelegatedTo_V2570(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }

        //[Sudhir.Jangra][GEOS2-6017]
        public List<Responsible> GetEmployeeListAsPerLocation_V2570(string connectionString, string IdCompanies)
        {
            List<Responsible> responsibleList = new List<Responsible>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetDelegatedToByLocation_V2570", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdCompanyLocation", IdCompanies);
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        #region MyRegion
                        while (rdr.Read())
                        {
                            Responsible responsible = new Responsible();
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                responsible.IdEmployee = Convert.ToUInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                responsible.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                responsible.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                responsible.LastName = Convert.ToString(rdr["LastName"]);
                                responsible.FullName = responsible.FirstName + " " + responsible.LastName;
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                responsible.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                responsible.EmployeeCodeWithIdGender = responsible.EmployeeCode + "_" + responsible.IdGender;
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                responsible.IdOrganizationCode = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["OrganizationCode"] != DBNull.Value)
                            {
                                responsible.Organization = Convert.ToString(rdr["OrganizationCode"]);
                            }
                            if (rdr["IdEmployeeStatus"] != DBNull.Value)
                            {
                                responsible.IdEmployeeStatus = Convert.ToInt16(rdr["IdEmployeeStatus"]);
                            }
                            if (rdr["JobCode"] != DBNull.Value)
                            {
                                responsible.JobCode = Convert.ToString(rdr["JobCode"]);
                            }

                            responsibleList.Add(responsible);
                        }
                        #endregion
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetEmployeeListAsPerLocation_V2570(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return responsibleList;
        }


        //[Sudhir.Jangra][GEOS2-5982]
        public List<APMActionPlan> GetActionPlanDetails_V2570(string connectionString, string selectedPeriod, string countryIconFilePath)
        {
            List<APMActionPlan> actionPlanList = new List<APMActionPlan>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_V2570", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlan actionPlan = new APMActionPlan();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.Country.Iso + ".png";
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }
                            actionPlanList.Add(actionPlan);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdActionPlan"] != DBNull.Value)
                                {
                                    APMActionPlan actionPlan = actionPlanList.FirstOrDefault(x => x.IdActionPlan == Convert.ToInt32(rdr["IdActionPlan"]));
                                    if (actionPlan != null)
                                    {
                                        if (actionPlan.TaskList == null)
                                        {
                                            actionPlan.TaskList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["IdLookupBusiness"] != DBNull.Value)
                                        {
                                            task.IdLookupBusiness = Convert.ToInt32(rdr["IdLookupBusiness"]);
                                        }
                                        if (rdr["BusinessUnit"] != DBNull.Value)
                                        {
                                            task.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                                        }
                                        if (rdr["BusinessUnitHTMLColor"] != DBNull.Value)
                                        {
                                            task.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }

                                        actionPlan.TaskList.Add(task);
                                    }
                                }
                            }
                        }
                    }
                }

                foreach (var item in actionPlanList)
                {
                    if (item.TotalActionItems != 0)
                    {
                        item.Percentage = (int)(((float)item.TotalClosedItems / item.TotalActionItems) * 100);
                    }
                    else
                    {
                        item.Percentage = 0;
                    }

                    if (item.Percentage <= 24)
                    {
                        item.TotalClosedColor = "Red";
                    }
                    else if (item.Percentage >= 25 && item.Percentage <= 49)
                    {
                        item.TotalClosedColor = "Orange";
                    }
                    else if (item.Percentage >= 50 && item.Percentage <= 74)
                    {
                        item.TotalClosedColor = "Yellow";
                    }
                    else if (item.Percentage >= 75 && item.Percentage <= 99)
                    {
                        item.TotalClosedColor = "LightGreen";
                    }
                    else if (item.Percentage == 100)
                    {
                        item.TotalClosedColor = "Green";
                    }
                }

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2570(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanList;
        }

        //[shweta.thube][GEOS2-5981]
        public bool DeleteTaskForActionPlan_V2570(Int64 IdActionPlanTask, string connectionString)
        {
            bool isDeleted = false;
            if (IdActionPlanTask > 0)
            {
                try
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();
                        MySqlCommand mySqlCommand = new MySqlCommand("APM_DeleteTaskForActionPlan_V2570", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdTask", IdActionPlanTask);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }
                    isDeleted = true;
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error DeleteTaskForActionPlan_V2570(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }
            }
            return isDeleted;
        }

        //[shweta.thube][GEOS2-5981]
        public APMActionPlanTask AddTaskForActionPlan_V2570(string connectionString, APMActionPlanTask actionPlanTask)
        {
            bool isAdded = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertTaskForActionPlan_V2570", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlanTask.IdLookupBusiness);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        if (actionPlanTask.IdDelegated > 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                        mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlanTask.CreatedBy);
                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);

                        actionPlanTask.IdActionPlanTask = Convert.ToUInt32(mySqlCommand.ExecuteScalar());
                        //mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();

                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isAdded = true;
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddTaskForActionPlan_V2570(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanTask;
        }

        // [shweta.thube][GEOS2-5981]
        public bool UpdateTaskForActionPlan_V2570(string connectionString, APMActionPlanTask actionPlanTask)
        {
            bool isUpdated = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateTaskForActionPlan_V2570", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        // Adding parameters to update the record
                        mySqlCommand.Parameters.AddWithValue("_IdTask", actionPlanTask.IdActionPlanTask);
                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlanTask.IdLookupBusiness);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        if (actionPlanTask.IdDelegated > 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                        mySqlCommand.Parameters.AddWithValue("_ModifiedBy", actionPlanTask.ModifiedBy);
                        mySqlCommand.Parameters.AddWithValue("_DueDateChangeCount", actionPlanTask.ChangeCount);
                        // mySqlCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isUpdated = true;
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateTaskForActionPlan_V2570(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }

        //[Sudhir.Jangra][GEOS2-6015]
        public List<CommentsByTask> GetTaskCommentsByIdTask_V2570(string connectionString, Int64 idTask)
        {
            List<CommentsByTask> commentsList = new List<CommentsByTask>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetTaskCommentsByIdTask_V2570", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdTask", idTask);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            CommentsByTask comments = new CommentsByTask();

                            if (rdr["IdActionPlanTaskComment"] != DBNull.Value)
                            {
                                comments.IdActionPlanTaskComment = Convert.ToInt64(rdr["IdActionPlanTaskComment"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                comments.IdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                comments.IdTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["IdPerson"] != DBNull.Value)
                            {
                                comments.People = new People();
                                comments.People.IdPerson = Convert.ToInt32(rdr["IdPerson"]);
                                comments.People.Name = rdr["Name"].ToString();
                                comments.People.Surname = rdr["Surname"].ToString();
                                if (rdr["Login"] != DBNull.Value)
                                {
                                    comments.People.Login = Convert.ToString(rdr["Login"]);
                                }

                                if (rdr["IdUserGender"] != DBNull.Value)
                                {
                                    comments.People.IdPersonGender = Convert.ToByte(rdr["IdUserGender"]);
                                }
                            }

                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                comments.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["Comment"] != DBNull.Value)
                            {
                                comments.Comments = Convert.ToString(rdr["Comment"]);
                            }
                            if (rdr["IsRtfText"] != DBNull.Value)
                            {
                                comments.IsRtfText = Convert.ToBoolean(rdr["IsRtfText"]);
                            }
                            commentsList.Add(comments);
                        }
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetEmployeeListAsPerLocation_V2570(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return commentsList;
        }

        //[Sudhir.jangra][GEOS2-6017]
        public List<Responsible> GetActiveInactiveResponsibleForActionPlan_V2570(string connectionString, Int32 IdCompany, string selectedPeriod, string idsOrganization, string idsDepartments, Int32 idPermission)
        {
            List<Responsible> responsibleList = new List<Responsible>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActiveInactiveResponsibleForActionPlan_V2570", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdCompany", IdCompany);
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_idsOrganizationPlant", idsOrganization);
                    mySqlCommand.Parameters.AddWithValue("_idsDepartment", idsDepartments);
                    mySqlCommand.Parameters.AddWithValue("_idPermission", idPermission);
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                Responsible responsible = new Responsible();
                                if (rdr["IdEmployee"] != DBNull.Value)
                                {
                                    responsible.IdEmployee = Convert.ToUInt32(rdr["IdEmployee"]);
                                }
                                if (rdr["EmployeeCode"] != DBNull.Value)
                                {
                                    responsible.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                }
                                if (rdr["FirstName"] != DBNull.Value)
                                {
                                    responsible.FirstName = Convert.ToString(rdr["FirstName"]);
                                }
                                if (rdr["LastName"] != DBNull.Value)
                                {
                                    responsible.LastName = Convert.ToString(rdr["LastName"]);
                                }
                                if (rdr["FullName"] != DBNull.Value)
                                {
                                    responsible.FullName = Convert.ToString(rdr["FullName"]);
                                }

                                if (rdr["IdGender"] != DBNull.Value)
                                {
                                    responsible.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                    responsible.EmployeeCodeWithIdGender = responsible.EmployeeCode + "_" + responsible.IdGender;
                                }

                                if (rdr["IdCompany"] != DBNull.Value)
                                {
                                    responsible.IdOrganizationCode = Convert.ToInt32(rdr["IdCompany"]);
                                }
                                if (rdr["OrganizationCode"] != DBNull.Value)
                                {
                                    responsible.Organization = Convert.ToString(rdr["OrganizationCode"]);
                                }
                                if (rdr["IdEmployeeStatus"] != DBNull.Value)
                                {
                                    responsible.IdEmployeeStatus = Convert.ToInt16(rdr["IdEmployeeStatus"]);
                                }
                                if (rdr["JobCode"] != DBNull.Value)
                                {
                                    responsible.JobCode = Convert.ToString(rdr["JobCode"]);
                                }


                                responsibleList.Add(responsible);
                            }

                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActiveInactiveResponsibleForActionPlan_V2570(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return responsibleList;
        }

        //[Sudhir.Jangra][GEOS2-6017]
        public Responsible GetInactiveDelegatedToForActionPlanTask_V2570(string connectionString, Int32 IdEmployee)
        {
            Responsible responsible = new Responsible();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetInActiveDelegatedToForActionPlanTask_V2570", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdEmployee", IdEmployee);

                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        if (rdr.Read())
                        {
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                responsible.IdEmployee = Convert.ToUInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                responsible.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                responsible.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                responsible.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["FullName"] != DBNull.Value)
                            {
                                responsible.FullName = Convert.ToString(rdr["FullName"]);
                            }

                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                responsible.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                responsible.IdOrganizationCode = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["OrganizationCode"] != DBNull.Value)
                            {
                                responsible.Organization = Convert.ToString(rdr["OrganizationCode"]);
                            }
                            if (rdr["IdEmployeeStatus"] != DBNull.Value)
                            {
                                responsible.IdEmployeeStatus = Convert.ToInt16(rdr["IdEmployeeStatus"]);
                            }
                            if (rdr["JobCode"] != DBNull.Value)
                            {
                                responsible.JobCode = Convert.ToString(rdr["JobCode"]);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetInactiveDelegatedToForActionPlanTask_V2570(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return responsible;
        }


        //[Sudhir.Jangra][GEOS2-6015]
        public List<CommentsByTask> AddUpdateDeleteCommentsByIdTask_V2570(string connectionString, List<CommentsByTask> commentsList)
        {
            try
            {
                if (commentsList != null)
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        foreach (var item in commentsList)
                        {
                            if (item.TransactionOperation == ModelBase.TransactionOperations.Add)
                            {
                                MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertActionPlanTaskComment_V2570", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;
                                mySqlCommand.Parameters.AddWithValue("_Comment", item.Comments);
                                mySqlCommand.Parameters.AddWithValue("_IdTask", item.IdTask);
                                mySqlCommand.Parameters.AddWithValue("_CreatedBy", item.IdUser);
                                mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                mySqlCommand.Parameters.AddWithValue("_IsRtfText", item.IsRtfText);

                                item.IdActionPlanTaskComment = Convert.ToInt64(mySqlCommand.ExecuteScalar());
                            }
                            else if (item.TransactionOperation == ModelBase.TransactionOperations.Update)
                            {
                                if (item.IdActionPlanTaskComment > 0)
                                {
                                    MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateActionPlanTaskComment_V2570", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                                    mySqlCommand.Parameters.AddWithValue("_IdActionPlanTaskComment", item.IdActionPlanTaskComment);
                                    mySqlCommand.Parameters.AddWithValue("_Comment", item.Comments);
                                    // mySqlCommand.Parameters.AddWithValue("_IdTask", item.IdTask);
                                    //  mySqlCommand.Parameters.AddWithValue("_CreatedBy", item.IdUser);
                                    // mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                    mySqlCommand.Parameters.AddWithValue("_IsRtfText", item.IsRtfText);
                                    mySqlCommand.ExecuteNonQuery();
                                }
                            }
                            else if (item.TransactionOperation == ModelBase.TransactionOperations.Delete)
                            {
                                MySqlCommand mySqlCommand = new MySqlCommand("APM_DeleteActionPlanTaskComment_V2570", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;
                                mySqlCommand.Parameters.AddWithValue("_IdActionPlanTaskComment", item.IdActionPlanTaskComment);
                                mySqlCommand.ExecuteNonQuery();
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddUpdateDeleteCommentsByIdTask_V2570(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return commentsList;
        }
        //[shweta.thube][GEOS2-5976]
        public bool UpdateStatusByIdTask_V2570(string connectionString, APMActionPlanTask actionPlanTask, Int32 IdLookupChangedValues, string ChangedTaskComment, Int32 CreatedBy)
        {
            bool isUpdated = false;
            try
            {
                //Updating Task Status
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateStatusForActionPlanTask_V2570", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdTask", actionPlanTask.IdActionPlanTask);
                    mySqlCommand.Parameters.AddWithValue("_IdStatus", IdLookupChangedValues);
                    mySqlCommand.ExecuteNonQuery();
                    mySqlConnection.Close();
                }

                //Insert Task Comment
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertActionPlanTaskComment_V2570", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_Comment", ChangedTaskComment);
                    mySqlCommand.Parameters.AddWithValue("_IdTask", actionPlanTask.IdActionPlanTask);
                    mySqlCommand.Parameters.AddWithValue("_CreatedBy", CreatedBy);
                    mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                    mySqlCommand.Parameters.AddWithValue("_IsRtfText", 0);
                    mySqlCommand.ExecuteNonQuery();
                    mySqlConnection.Close();
                }
                isUpdated = true;
            }

            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateStatusByIdTask_V2570(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }

        //[Sudhir.Jangra][GEOS2-5976]

        public Responsible GetEmployeeCurrentDetail_V2570(string workbenchConnectionString, Int32 idUser, string selectedPeriod)
        {
            Responsible employee = new Responsible();
            using (MySqlConnection mySqlConnection = new MySqlConnection(workbenchConnectionString))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("APM_GetEmployeeCurrentDetails_V2570", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdUser", idUser);
                mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.NextResult())
                        while (reader.Read())
                        {
                            try
                            {
                                if (reader["IdEmployee"] != DBNull.Value)
                                    employee.IdEmployee = Convert.ToUInt32(reader["IdEmployee"]);
                                employee.EmployeeDepartments = Convert.ToString(reader["departIds"]);
                                employee.Organization = Convert.ToString(reader["companiesIds"]);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetEmployeeCurrentDetail_V2570(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                }
            }
            return employee;
        }

        //[Sudhir.Jangra][GEOS2-6015]
        public List<Company> GetAuthorizedLocationListByIdUser_V2570(string workbenchConnectionString, Int32 idUser, string countryIconFilePath)
        {
            List<Company> companies = new List<Company>();
            List<string> countryISOs = new List<string>();

            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(workbenchConnectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetAuthorizedLocationListByIdUser_V2560", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_idUser", idUser);

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {

                        while (reader.Read())
                        {
                            Company company = new Company();
                            if (reader["IdCompany"] != DBNull.Value)
                            {
                                company.IdCompany = Convert.ToInt32(reader["IdCompany"]);
                                company.Name = Convert.ToString(reader["CompanyName"]);
                                company.Alias = Convert.ToString(reader["Alias"]);
                                company.ShortName = Convert.ToString(reader["Alias"]);
                                if (reader["IdCountry"] != DBNull.Value)
                                {
                                    company.IdCountry = Convert.ToByte(reader["IdCountry"]);
                                    company.Country = new Country();
                                    company.Country.IdCountry = Convert.ToByte(reader["IdCountry"]);
                                    company.Country.Name = Convert.ToString(reader["CountryName"]);
                                }
                                if (reader["IsLocation"] != DBNull.Value)
                                    company.IsLocation = Convert.ToByte(reader["IsLocation"]);

                                if (reader["IsOrganization"] != DBNull.Value)
                                    company.IsOrganization = Convert.ToByte(reader["IsOrganization"]);

                                if (reader["IsCompany"] != DBNull.Value)
                                    company.IsCompany = Convert.ToByte(reader["IsCompany"]);

                                if (reader["IsStillActive"] != DBNull.Value)
                                    company.IsStillActive = Convert.ToByte(reader["IsStillActive"]);

                                if (reader["IdCurrency"] != DBNull.Value)
                                {
                                    company.IdCurrency = Convert.ToInt16(reader["IdCurrency"]);
                                }
                                if (reader["CountryISO"] != DBNull.Value)
                                {
                                    company.Iso = Convert.ToString(reader["CountryISO"]);
                                    company.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + company.Iso + ".png";

                                    //if (!countryISOs.Any(co => co.ToString() == company.Iso))
                                    //{
                                    //    countryISOs.Add(company.Iso);
                                    //}
                                }
                            }
                            companies.Add(company);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetAuthorizedLocationListByIdUser_V2560(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            //foreach (string item in countryISOs)
            //{
            //    byte[] bytes = null;
            //    bytes = GetCountryIconFileInBytes(item, countryIconFilePath);
            //    companies.Where(ot => ot.Iso == item).ToList().ForEach(ot => ot.ImageInBytes = bytes);
            //}
            return companies;
        }

        //[shweta.thube][GEOS2-6020]
        public void AddLogEntriesByActionPlan_V2580(string MainServerConnectionString, List<LogEntriesByActionPlan> LogEntriesByActionPlanList)
        {
            try
            {
                if (LogEntriesByActionPlanList != null)
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(MainServerConnectionString))
                    {
                        mySqlConnection.Open();

                        foreach (LogEntriesByActionPlan logEntriesByActionPlan in LogEntriesByActionPlanList)
                        {
                            MySqlCommand mySqlCommand = new MySqlCommand("APM_LogEntryByActionPlan_Insert_V2580", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_IdActionPlan", logEntriesByActionPlan.IdActionPlan);
                            mySqlCommand.Parameters.AddWithValue("_ChangeLogIdUser", logEntriesByActionPlan.IdUser);
                            mySqlCommand.Parameters.AddWithValue("_ChangeLogDatetime", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            mySqlCommand.Parameters.AddWithValue("_ChangeLogChange", logEntriesByActionPlan.Comments);
                            // mySqlCommand.Parameters.AddWithValue("_IdLogEntryType", logEntriesByActionPlan.IdEntryType);
                            // mySqlCommand.Parameters.AddWithValue("_IsRtfText", logEntriesByActionPlan.IsRtfText);

                            mySqlCommand.ExecuteNonQuery();
                        }
                        mySqlConnection.Close();
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddLogEntriesByActionPlan_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
        }
        //[shweta.thube][GEOS2-6020]
        public List<LogEntriesByActionPlan> GetLogEntriesByActionPlan_V2580(string connectionString, UInt32 idActionPlan)
        {
            List<LogEntriesByActionPlan> logEntries = new List<LogEntriesByActionPlan>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetChangeLogEntriesByActionPlan_V2580", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", idActionPlan);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            LogEntriesByActionPlan entries = new LogEntriesByActionPlan();
                            if (rdr["IdActionPlanChangeLog"] != DBNull.Value)
                            {
                                entries.IdActionPlanChangeLog = Convert.ToUInt32(rdr["IdActionPlanChangeLog"]);
                            }
                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                entries.IdActionPlan = Convert.ToUInt32(rdr["IdActionPlan"]);
                            }
                            if (rdr["ChangeLogDatetime"] != DBNull.Value)
                            {
                                entries.Datetime = Convert.ToDateTime(rdr["ChangeLogDatetime"]);
                            }
                            if (rdr["ChangeLogIdUser"] != DBNull.Value)
                            {
                                entries.IdUser = Convert.ToInt32(rdr["ChangeLogIdUser"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value && rdr["LastName"] != DBNull.Value)
                            {
                                entries.UserName = $"{Convert.ToString(rdr["FirstName"])} {Convert.ToString(rdr["LastName"])} ";
                            }
                            if (rdr["ChangeLogChange"] != DBNull.Value)
                            {
                                entries.Comments = Convert.ToString(rdr["ChangeLogChange"]);
                            }
                            logEntries.Add(entries);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetLogEntriesByActionPlan_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return logEntries;
        }

        //[shweta.thube][GEOS2-6020]
        public bool UpdateActionPlan_V2580(string connectionString, APMActionPlan actionPlan)
        {
            bool isUpdated = false;
            try
            {
                if (actionPlan != null)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateActionPlan_V2560", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlan.IdActionPlan);
                            mySqlCommand.Parameters.AddWithValue("_Description", actionPlan.Description);
                            mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlan.IdCompany);
                            mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlan.IdEmployee);
                            mySqlCommand.Parameters.AddWithValue("_IdOrigin", actionPlan.IdLookupOrigin);
                            mySqlCommand.Parameters.AddWithValue("_ModifiedBy", actionPlan.ModifiedBy);


                            mySqlCommand.ExecuteNonQuery();
                            mySqlConnection.Close();


                        }

                        transactionScope.Complete();
                        transactionScope.Dispose();
                        isUpdated = true;
                    }
                    if (actionPlan?.CommentList?.Count > 0 && (actionPlan.CommentList.Any(x => x.TransactionOperation == ModelBase.TransactionOperations.Add) ||
                    actionPlan.CommentList.Any(y => y.TransactionOperation == ModelBase.TransactionOperations.Update) ||
                    actionPlan.CommentList.Any(z => z.TransactionOperation == ModelBase.TransactionOperations.Delete)))
                    {
                        AddUpdateDeleteActionPlanComments(connectionString, actionPlan.CommentList);
                    }
                    if (actionPlan.ActionPlanLogEntries != null && actionPlan.ActionPlanLogEntries.Count > 0)
                    {
                        AddLogEntriesByActionPlan_V2580(connectionString, actionPlan.ActionPlanLogEntries);
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateActionPlan_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }

        //[nsatpute][24-10-2024][GEOS2-6018]
        public APMActionPlan AddActionPlanDetails_V2580(string connectionString, APMActionPlan actionPlan)
        {
            bool isAdded = false;
            try
            {
                if (actionPlan != null)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("APM_AddActionPlanDetails_V2560", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_Code", actionPlan.Code);
                            mySqlCommand.Parameters.AddWithValue("_Description", actionPlan.Description);
                            mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlan.IdCompany);
                            mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlan.IdEmployee);
                            mySqlCommand.Parameters.AddWithValue("_IdOrigin", actionPlan.IdLookupOrigin);
                            mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlan.CreatedBy);

                            actionPlan.IdActionPlan = Convert.ToInt64(mySqlCommand.ExecuteScalar());

                            mySqlConnection.Close();
                        }

                        transactionScope.Complete();
                        transactionScope.Dispose();
                        isAdded = true;
                    }
                    if (actionPlan?.CommentList?.Count > 0 && (actionPlan.CommentList.Any(x => x.TransactionOperation == ModelBase.TransactionOperations.Add) ||
                    actionPlan.CommentList.Any(y => y.TransactionOperation == ModelBase.TransactionOperations.Update)))
                    {
                        actionPlan.CommentList.ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                        AddUpdateDeleteActionPlanComments(connectionString, actionPlan.CommentList);
                    }

                    if (actionPlan.ActionPlanLogEntries != null && actionPlan.ActionPlanLogEntries.Count > 0)
                    {
                        if (actionPlan.IdActionPlan > 0)
                        {
                            actionPlan.ActionPlanLogEntries.ToList().ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                            AddLogEntriesByActionPlan_V2580(connectionString, actionPlan.ActionPlanLogEntries);
                        }
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddActionPlanDetails_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlan;
        }

        //[nsatpute][24-10-2024][GEOS2-6018]
        private void AddUpdateDeleteActionPlanComments(string connectionString, List<ActionPlanComment> commentsList)
        {
            try
            {
                if (commentsList != null)
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        foreach (var item in commentsList)
                        {
                            if (item.TransactionOperation == ModelBase.TransactionOperations.Add)
                            {
                                MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertActionPlanComment_V2580", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;
                                mySqlCommand.Parameters.AddWithValue("_Comment", item.Comment);
                                mySqlCommand.Parameters.AddWithValue("_IdActionPlan", item.IdActionPlan);
                                mySqlCommand.Parameters.AddWithValue("_CreatedBy", item.IdUser);
                                mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                mySqlCommand.ExecuteNonQuery();
                            }
                            else if (item.TransactionOperation == ModelBase.TransactionOperations.Update)
                            {
                                if (item.Id > 0)
                                {
                                    MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateActionPlanComment_V2580", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                                    mySqlCommand.Parameters.AddWithValue("_IdActionPlanComment", item.Id);
                                    mySqlCommand.Parameters.AddWithValue("_Comment", item.Comment);
                                    mySqlCommand.ExecuteNonQuery();
                                }
                            }
                            else if (item.TransactionOperation == ModelBase.TransactionOperations.Delete)
                            {
                                MySqlCommand mySqlCommand = new MySqlCommand("APM_DeleteActionPlanComment_V2580", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;
                                mySqlCommand.Parameters.AddWithValue("_IdActionPlanComment", item.Id);
                                mySqlCommand.ExecuteNonQuery();
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddUpdateDeleteActionPlanComments(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
        }
        //[nsatpute][25-10-2024][GEOS2-6018]
        public List<ActionPlanComment> GetActionPlanCommentsByIdActionPlan(string connectionString, long idActionPlan)
        {
            List<ActionPlanComment> lstComments = new List<ActionPlanComment>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanCommentsById_V2580", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", idActionPlan);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            ActionPlanComment comment = new ActionPlanComment();

                            if (rdr["IdActionPlanComment"] != DBNull.Value)
                            {
                                comment.Id = Convert.ToUInt32(rdr["IdActionPlanComment"]);
                            }
                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                comment.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Comment"] != DBNull.Value)
                            {
                                comment.Comment = Convert.ToString(rdr["Comment"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                comment.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                comment.Datetime = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["IdPerson"] != DBNull.Value)
                            {
                                comment.People = new People();
                                comment.People.IdPerson = Convert.ToInt32(rdr["IdPerson"]);
                                comment.People.Name = rdr["Name"].ToString();
                                comment.People.Surname = rdr["Surname"].ToString();
                                if (rdr["Login"] != DBNull.Value)
                                {
                                    comment.People.Login = Convert.ToString(rdr["Login"]);
                                }

                                if (rdr["IdUserGender"] != DBNull.Value)
                                {
                                    comment.People.IdPersonGender = Convert.ToByte(rdr["IdUserGender"]);
                                }
                            }
                            comment.TransactionOperation = ModelBase.TransactionOperations.Nothing;

                            lstComments.Add(comment);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2550(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return lstComments;
        }

        //[Sudhir.Jangra][GEOS2-6016]
        public List<AttachmentsByTask> GetTaskAttachmentsByIdTask_V2580(string connectionString, Int64 idTask)
        {
            List<AttachmentsByTask> attachmentList = new List<AttachmentsByTask>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetAttachmentsForActionPlanTask_V2580", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdTask", idTask);
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            AttachmentsByTask attach = new AttachmentsByTask();
                            if (rdr["IdActionPlanTaskAttachment"] != DBNull.Value)
                            {
                                attach.IdActionPlanTaskAttachment = Convert.ToInt64(rdr["IdActionPlanTaskAttachment"]);
                            }
                            if (rdr["FileName"] != DBNull.Value)
                            {
                                attach.OriginalFileName = Convert.ToString(rdr["FileName"]);
                                attach.SavedFileName = Convert.ToString(rdr["FileName"]);
                            }
                            if (rdr["FileLocation"] != DBNull.Value)
                            {
                                attach.FilePath = Convert.ToString(rdr["FileLocation"]);
                            }
                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                attach.IdTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                attach.CreatedBy = Convert.ToInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                attach.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                attach.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                attach.Description = Convert.ToString(rdr["Description"]);
                            }
                            attachmentList.Add(attach);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTaskAttachmentsByIdTask_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return attachmentList;
        }

        //[Sudhir.Jangra][GEOS2-6016]
        public AttachmentsByTask DownloadTaskAttachment_V2580(AttachmentsByTask taskAttachment, string filePath)
        {
            if (taskAttachment != null)
            {
                byte[] bytes = null;
                FileStream filestream = null;
                string fileUploadPath = filePath + @"\" + taskAttachment.IdTask + @"\" + taskAttachment.SavedFileName;
                try
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(fileUploadPath, System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;
                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }
                    taskAttachment.FileByte = bytes;
                }
                catch (FileNotFoundException ex)
                {
                    throw;
                }
                catch (DirectoryNotFoundException ex)
                {
                    throw;
                }
                catch (Exception ex)
                {
                    throw;
                }
            }
            return taskAttachment;
        }


        //[Sudhir.Jangra][GEOS2-6016]
        public List<AttachmentsByTask> AddUpdateDeleteAttachments_V2580(string connectionstring, List<AttachmentsByTask> attachmentList, string GuidString, string filePath, Int64 idTask)
        {
            string[] files = null;
            try
            {
                if (attachmentList != null)
                {
                    if (!string.IsNullOrEmpty(GuidString))
                    {
                        if (!Directory.Exists(filePath))
                        {
                            CreateDirectory(filePath);
                        }

                        if (!Directory.Exists(filePath + @"\" + idTask))
                        {
                            CreateDirectory(filePath + @"\" + idTask);
                        }

                        ZipFile.ExtractToDirectory(filePath + @"\_tmp\" + GuidString.ToString() + ".Zip", filePath + @"\_tmp\" + GuidString.ToString());

                        //Delete Zip Folder
                        File.Delete(filePath + @"\_tmp\" + GuidString.ToString() + ".Zip");
                        //Get all files in Extract folder in _tmp
                        files = Directory.GetFiles(filePath + @"\_tmp\" + GuidString.ToString());

                    }


                    foreach (AttachmentsByTask attachment in attachmentList)
                    {
                        attachment.IdTask = idTask;
                        if (Convert.ToBoolean(attachment.IsDeleted))
                        {
                            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
                            {
                                mySqlConnection.Open();

                                try
                                {
                                    MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateActionPlanTaskAttachment_V2580", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                                    mySqlCommand.Parameters.AddWithValue("_IdActionPlanTaskAttachment", attachment.IdActionPlanTaskAttachment);
                                    // mySqlCommand.Parameters.AddWithValue("_FName", attachment.SavedFileName);
                                    // mySqlCommand.Parameters.AddWithValue("_FileLocation", attachment.FilePath);
                                    // mySqlCommand.Parameters.AddWithValue("_IdTask", idTask);
                                    //  mySqlCommand.Parameters.AddWithValue("_CreatedBy", attachment.CreatedBy);
                                    //  mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                    //  mySqlCommand.Parameters.AddWithValue("_Description", attachment.Description);
                                    mySqlCommand.Parameters.AddWithValue("_IsDeleted", attachment.IsDeleted);

                                    mySqlCommand.ExecuteNonQuery();


                                    if (File.Exists(filePath + @"\" + idTask + @"\" + attachment.SavedFileName))
                                    {
                                        File.Delete(filePath + @"\" + idTask + @"\" + attachment.SavedFileName);
                                    }

                                    mySqlConnection.Close();
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error AddUpdateDeleteAttachments_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                    throw;
                                }
                            }
                        }
                        else
                        {
                            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
                            {
                                mySqlConnection.Open();

                                try
                                {
                                    string completePath = @"\" + idTask + @"\" + attachment.SavedFileName;
                                    MySqlCommand mySqlCommand = new MySqlCommand("APM_AddActionPlanTaskAttachment_V2580", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                                    mySqlCommand.Parameters.AddWithValue("_fName", attachment.SavedFileName);
                                    mySqlCommand.Parameters.AddWithValue("_FileLocation", completePath);
                                    mySqlCommand.Parameters.AddWithValue("_IdTask", idTask);
                                    mySqlCommand.Parameters.AddWithValue("_CreatedBy", attachment.CreatedBy);
                                    mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                    mySqlCommand.Parameters.AddWithValue("_Description", attachment.Description);
                                    mySqlCommand.Parameters.AddWithValue("_IsDeleted", 0);

                                    attachment.IdActionPlanTaskAttachment = Convert.ToInt64(mySqlCommand.ExecuteScalar());

                                    foreach (string file in files)
                                    {
                                        if (attachment.FileUploadName == Path.GetFileName(file))
                                        {
                                            System.IO.File.Copy(file, filePath + @"\" + idTask + @"\" + attachment.SavedFileName, true);
                                            File.Delete(file);

                                            break;
                                        }
                                    }

                                    mySqlConnection.Close();
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error AddUpdateDeleteAttachments_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                    throw;
                                }
                            }
                        }
                    }

                    if (!string.IsNullOrEmpty(GuidString))
                    {
                        Directory.Delete(filePath + @"\_tmp\" + GuidString.ToString());
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddUpdateDeleteAttachments_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return attachmentList;
        }
        public void CreateDirectory(string path)
        {

            Directory.CreateDirectory(path);


        }


        //[Sudhir.Jangra][GEOS2-6016]
        public List<APMActionPlan> GetActionPlanDetails_V2580(string connectionString, string selectedPeriod, string idLocations, string countryIconFilePath)
        {
            List<APMActionPlan> actionPlanList = new List<APMActionPlan>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_V2580", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_IdLocation", idLocations);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlan actionPlan = new APMActionPlan();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.Country.Iso + ".png";
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }
                            actionPlanList.Add(actionPlan);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdActionPlan"] != DBNull.Value)
                                {
                                    APMActionPlan actionPlan = actionPlanList.FirstOrDefault(x => x.IdActionPlan == Convert.ToInt32(rdr["IdActionPlan"]));
                                    if (actionPlan != null)
                                    {
                                        if (actionPlan.TaskList == null)
                                        {
                                            actionPlan.TaskList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["IdLookupBusiness"] != DBNull.Value)
                                        {
                                            task.IdLookupBusiness = Convert.ToInt32(rdr["IdLookupBusiness"]);
                                        }
                                        if (rdr["BusinessUnit"] != DBNull.Value)
                                        {
                                            task.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                                        }
                                        if (rdr["BusinessUnitHTMLColor"] != DBNull.Value)
                                        {
                                            task.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }

                                        actionPlan.TaskList.Add(task);
                                    }
                                }
                            }
                        }
                    }
                }

                foreach (var item in actionPlanList)
                {
                    if (item.TotalActionItems != 0)
                    {
                        item.Percentage = (int)(((float)item.TotalClosedItems / item.TotalActionItems) * 100);
                    }
                    else
                    {
                        item.Percentage = 0;
                    }

                    if (item.Percentage <= 24)
                    {
                        item.TotalClosedColor = "Red";
                    }
                    else if (item.Percentage >= 25 && item.Percentage <= 49)
                    {
                        item.TotalClosedColor = "Orange";
                    }
                    else if (item.Percentage >= 50 && item.Percentage <= 74)
                    {
                        item.TotalClosedColor = "Yellow";
                    }
                    else if (item.Percentage >= 75 && item.Percentage <= 99)
                    {
                        item.TotalClosedColor = "LightGreen";
                    }
                    else if (item.Percentage == 100)
                    {
                        item.TotalClosedColor = "Green";
                    }
                }

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanList;
        }

        //[Sudhir.Jangra][GEOS2-6016]
        public List<APMActionPlanTask> GetTaskListByIdActionPlan_V2580(string connectionString, Int64 IdActionPlan, string selectedPeriod)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetTaskListByIdActionPlan_V2580", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["IdLookupBusiness"] != DBNull.Value)
                            {
                                task.IdLookupBusiness = Convert.ToInt32(rdr["IdLookupBusiness"]);
                            }
                            if (rdr["BusinessUnit"] != DBNull.Value)
                            {
                                task.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }
                            if (rdr["BusinessUnitHTMLColor"] != DBNull.Value)
                            {
                                task.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }

                            taskList.Add(task);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTaskListByIdActionPlan_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }


        //[shweta.thube][GEOS2-6020]
        public APMActionPlanTask AddTaskForActionPlan_V2580(string connectionString, APMActionPlanTask actionPlanTask)
        {
            bool isAdded = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertTaskForActionPlan_V2570", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlanTask.IdLookupBusiness);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        if (actionPlanTask.IdDelegated > 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                        mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlanTask.CreatedBy);
                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);

                        actionPlanTask.IdActionPlanTask = Convert.ToUInt32(mySqlCommand.ExecuteScalar());
                        //mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();

                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isAdded = true;

                    AddLogEntriesByActionPlan_V2580(connectionString, actionPlanTask.ActionPlanLogEntries);
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddTaskForActionPlan_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanTask;
        }
        //[Shweta.thube][GEOS2-6020]
        public List<Responsible> GetEmployeeListAsPerLocation_V2580(string connectionString, string IdCompanies)
        {
            List<Responsible> responsibleList = new List<Responsible>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetDelegatedToByLocation_V2580", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdCompanyLocation", IdCompanies);
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        #region MyRegion
                        while (rdr.Read())
                        {
                            Responsible responsible = new Responsible();
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                responsible.IdEmployee = Convert.ToUInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                responsible.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                responsible.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                responsible.LastName = Convert.ToString(rdr["LastName"]);
                                responsible.FullName = responsible.FirstName + " " + responsible.LastName;
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                responsible.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                responsible.EmployeeCodeWithIdGender = responsible.EmployeeCode + "_" + responsible.IdGender;
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                responsible.IdOrganizationCode = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["OrganizationCode"] != DBNull.Value)
                            {
                                responsible.Organization = Convert.ToString(rdr["OrganizationCode"]);
                            }
                            if (rdr["IdEmployeeStatus"] != DBNull.Value)
                            {
                                responsible.IdEmployeeStatus = Convert.ToInt16(rdr["IdEmployeeStatus"]);
                            }
                            if (rdr["JobCode"] != DBNull.Value)
                            {
                                responsible.JobCode = Convert.ToString(rdr["JobCode"]);
                            }

                            responsibleList.Add(responsible);
                        }
                        #endregion
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetEmployeeListAsPerLocation_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return responsibleList;
        }
        //[Shweta.thube][GEOS2-6020]
        public bool UpdateTaskForActionPlan_V2580(string connectionString, APMActionPlanTask actionPlanTask)
        {
            bool isUpdated = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateTaskForActionPlan_V2570", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        // Adding parameters to update the record
                        mySqlCommand.Parameters.AddWithValue("_IdTask", actionPlanTask.IdActionPlanTask);
                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlanTask.IdLookupBusiness);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        if (actionPlanTask.IdDelegated > 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                        mySqlCommand.Parameters.AddWithValue("_ModifiedBy", actionPlanTask.ModifiedBy);
                        mySqlCommand.Parameters.AddWithValue("_DueDateChangeCount", actionPlanTask.ChangeCount);
                        // mySqlCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isUpdated = true;

                    AddLogEntriesByActionPlan_V2580(connectionString, actionPlanTask.ActionPlanLogEntries);
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateTaskForActionPlan_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }
        //[shweta.thube][GEOS2-6020]
        public bool DeleteTaskForActionPlan_V2580(string connectionString, Int64 IdActionPlanTask, List<LogEntriesByActionPlan> ActionPlanLogEntries)
        {
            bool isDeleted = false;
            if (IdActionPlanTask > 0)
            {
                try
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();
                        MySqlCommand mySqlCommand = new MySqlCommand("APM_DeleteTaskForActionPlan_V2570", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdTask", IdActionPlanTask);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }
                    isDeleted = true;

                    AddLogEntriesByActionPlan_V2580(connectionString, ActionPlanLogEntries);
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error DeleteTaskForActionPlan_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }
            }
            return isDeleted;
        }

        #region GEOS2-6019
        //[Sudhir.Jangra][GEOS2-6019]
        public List<AttachmentsByActionPlan> GetActionPlanAttachmentByIdActionPlan_V2580(string connectionString, Int64 IdActionPlan)
        {
            List<AttachmentsByActionPlan> attachmentList = new List<AttachmentsByActionPlan>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetAttachmentsForActionPlan_V2580", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            AttachmentsByActionPlan attach = new AttachmentsByActionPlan();
                            if (rdr["IdActionPlanAttachment"] != DBNull.Value)
                            {
                                attach.IdActionPlanAttachment = Convert.ToInt64(rdr["IdActionPlanAttachment"]);
                            }
                            if (rdr["FileName"] != DBNull.Value)
                            {
                                attach.OriginalFileName = Convert.ToString(rdr["FileName"]);
                                attach.SavedFileName = Convert.ToString(rdr["FileName"]);
                            }
                            if (rdr["FileLocation"] != DBNull.Value)
                            {
                                attach.FilePath = Convert.ToString(rdr["FileLocation"]);
                            }
                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                attach.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                attach.CreatedBy = Convert.ToInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                attach.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                attach.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                attach.Description = Convert.ToString(rdr["Description"]);
                            }
                            attachmentList.Add(attach);

                        }
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanAttachmentByIdActionPlan_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return attachmentList;
        }

        //[Sudhir.Jangra][GEOS2-6019]
        public bool AddActionPlanAttachments_V2580(string connectionString, List<AttachmentsByActionPlan> attachmentList, string attachmentFilePath)
        {
            bool isSaved = false;
            try
            {
                if (attachmentList != null && attachmentList.Count > 0)
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        foreach (AttachmentsByActionPlan item in attachmentList)
                        {
                            string filePath = "\\" + item.IdActionPlan + "\\" + item.SavedFileName;

                            MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertActionPlanAttachments_V2580", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;
                            mySqlCommand.Parameters.AddWithValue("_FName", item.SavedFileName);
                            mySqlCommand.Parameters.AddWithValue("_FileLocation", filePath);
                            mySqlCommand.Parameters.AddWithValue("_IdActionPlan", item.IdActionPlan);
                            mySqlCommand.Parameters.AddWithValue("_CreatedBy", item.CreatedBy);
                            mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                            mySqlCommand.Parameters.AddWithValue("_Description", item.Description);

                            item.IdActionPlanAttachment = Convert.ToInt64(mySqlCommand.ExecuteScalar());

                            if (item.IdActionPlanAttachment > 0)
                            {
                                AddActionPlanAttachedDocToPath(item, attachmentFilePath);
                            }
                            if (item.ChangeLogList != null && item.ChangeLogList.Count > 0)
                            {
                                AddChangeLogForActionPlanAttachments(connectionString, item.ChangeLogList);
                            }
                            isSaved = true;

                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddActionPlanAttachments_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isSaved;
        }

        //[Sudhir.Jangra][GEOS2-6019]
        public void AddChangeLogForActionPlanAttachments(string connectionString, List<LogEntriesByActionPlan> changeLog)
        {
            try
            {
                if (changeLog != null)
                {
                    foreach (var item in changeLog)
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();
                            MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertActionPlanAttachmentsChangeLog_V2580", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;
                            mySqlCommand.Parameters.AddWithValue("_IdActionPlan", item.IdActionPlan);
                            mySqlCommand.Parameters.AddWithValue("_ChangeLogDatetime", DateTime.Now);
                            mySqlCommand.Parameters.AddWithValue("_ChangeLogIdUser", item.IdUser);
                            mySqlCommand.Parameters.AddWithValue("_ChangeLogChange", item.Comments);
                            mySqlCommand.ExecuteNonQuery();
                            mySqlConnection.Close();
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddChangeLogForActionPlanAttachments(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
        }

        //[Sudhir.Jangra][GEOS2-6019]
        public AttachmentsByActionPlan DownloadActionPlanAttachment_V2580(AttachmentsByActionPlan taskAttachment, string filePath)
        {
            if (taskAttachment != null)
            {
                byte[] bytes = null;
                FileStream filestream = null;
                string fileUploadPath = filePath + @"\" + taskAttachment.IdActionPlan + @"\" + taskAttachment.SavedFileName;
                try
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(fileUploadPath, System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;
                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }
                    taskAttachment.FileByte = bytes;
                }
                catch (FileNotFoundException ex)
                {
                    throw;
                }
                catch (DirectoryNotFoundException ex)
                {
                    throw;
                }
                catch (Exception ex)
                {
                    throw;
                }
            }
            return taskAttachment;
        }

        //[Sudhir.Jangra][GEOS2-6019]
        public bool AddUpdateDeleteAttachmentsForActionPlan_V2580(string connectionString, List<AttachmentsByActionPlan> attachmentList, string filePath)
        {
            bool isSaved = false;
            try
            {
                if (attachmentList != null && attachmentList.Count > 0)
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        foreach (AttachmentsByActionPlan item in attachmentList)
                        {
                            if (item.TransactionOperation == ModelBase.TransactionOperations.Delete)
                            {
                                MySqlCommand mySqlCommand = new MySqlCommand("APM_DeleteAttachmentsForActionPlan_V2580", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;
                                mySqlCommand.Parameters.AddWithValue("_IdActionPlanAttachment", item.IdActionPlanAttachment);
                                mySqlCommand.ExecuteNonQuery();

                                IsDeleteActionPlanAttachedDocFromPath(item, filePath);
                                isSaved = true;
                            }
                            else if (item.TransactionOperation == ModelBase.TransactionOperations.Update)
                            {
                                if (item.IdActionPlanAttachment > 0)
                                {
                                    string cfilePath = "\\" + item.IdActionPlan + "\\" + item.SavedFileName;
                                    MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateAttachmentsForActionPlan_V2580", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                                    mySqlCommand.Parameters.AddWithValue("_IdActionPlanAttachment", item.IdActionPlanAttachment);
                                    mySqlCommand.Parameters.AddWithValue("_FName", item.SavedFileName);
                                    mySqlCommand.Parameters.AddWithValue("_FileLocation", cfilePath);
                                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", item.IdActionPlan);
                                    mySqlCommand.Parameters.AddWithValue("_CreatedBy", item.CreatedBy);
                                    mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                    mySqlCommand.Parameters.AddWithValue("_Description", item.Description);
                                    mySqlCommand.ExecuteNonQuery();


                                    UpdateActionPlanAttachedDocToPath(item, filePath, item.PreviousFileName);
                                    isSaved = true;
                                }
                            }
                            else if (item.TransactionOperation == ModelBase.TransactionOperations.Add)
                            {
                                string cfilePath = "\\" + item.IdActionPlan + "\\" + item.SavedFileName;
                                MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertActionPlanAttachments_V2580", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;
                                mySqlCommand.Parameters.AddWithValue("_fName", item.SavedFileName);
                                mySqlCommand.Parameters.AddWithValue("_FileLocation", cfilePath);
                                mySqlCommand.Parameters.AddWithValue("_IdActionPlan", item.IdActionPlan);
                                mySqlCommand.Parameters.AddWithValue("_CreatedBy", item.CreatedBy);
                                mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                mySqlCommand.Parameters.AddWithValue("_Description", item.Description);

                                item.IdActionPlanAttachment = Convert.ToInt64(mySqlCommand.ExecuteScalar());

                                if (item.IdActionPlanAttachment > 0)
                                {
                                    AddActionPlanAttachedDocToPath(item, filePath);
                                }
                                isSaved = true;
                            }

                            if (item.ChangeLogList != null)
                            {
                                foreach (LogEntriesByActionPlan log in item.ChangeLogList)
                                {
                                    MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertActionPlanAttachmentsChangeLog_V2580", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", log.IdActionPlan);
                                    mySqlCommand.Parameters.AddWithValue("_ChangeLogDatetime", DateTime.Now);
                                    mySqlCommand.Parameters.AddWithValue("_ChangeLogIdUser", log.IdUser);
                                    mySqlCommand.Parameters.AddWithValue("_ChangeLogChange", log.Comments);
                                    mySqlCommand.ExecuteNonQuery();

                                }
                                isSaved = true;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddUpdateDeleteAttachmentsForActionPlan_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isSaved;
        }

        public bool AddActionPlanAttachedDocToPath(AttachmentsByActionPlan actionPlanAttachedDoc, string actionPlanFilePath)
        {
            if (actionPlanAttachedDoc.FileByte != null)
            {
                try
                {
                    string completePath = string.Format(@"{0}\{1}", actionPlanFilePath, actionPlanAttachedDoc.IdActionPlan);
                    string filePath = completePath + "\\" + actionPlanAttachedDoc.SavedFileName;

                    if (!Directory.Exists(completePath))
                    {
                        Directory.CreateDirectory(completePath);
                    }
                    else
                    {
                        if (File.Exists(filePath))
                        {
                            File.Delete(filePath);
                        }
                    }
                    File.WriteAllBytes(filePath, actionPlanAttachedDoc.FileByte);
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error AddActionPlanAttachedDocToPath()- Filename - {0}. ErrorMessage- {1}", actionPlanAttachedDoc.SavedFileName, ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }
            }

            return true;
        }

        public bool UpdateActionPlanAttachedDocToPath(AttachmentsByActionPlan actionPlanAttachedDoc, string actionPlanFilePath, string previousFileName)
        {
            if (actionPlanAttachedDoc.FileByte != null)
            {
                try
                {
                    string completePath = string.Format(@"{0}\{1}", actionPlanFilePath, actionPlanAttachedDoc.IdActionPlan);
                    string filePath = Path.Combine(completePath, actionPlanAttachedDoc.SavedFileName);

                    // Check if the directory exists, create if not
                    if (!Directory.Exists(completePath))
                    {
                        Directory.CreateDirectory(completePath);
                    }

                    // Delete the previous file if previousFileName is provided and exists
                    if (!string.IsNullOrEmpty(previousFileName))
                    {
                        string previousFilePath = Path.Combine(completePath, previousFileName);
                        if (File.Exists(previousFilePath))
                        {
                            File.Delete(previousFilePath);
                        }
                    }

                    // Write the new file
                    File.WriteAllBytes(filePath, actionPlanAttachedDoc.FileByte);
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(
                        string.Format("Error AddActionPlanAttachedDocToPath()- Filename - {0}. ErrorMessage- {1}",
                        actionPlanAttachedDoc.SavedFileName, ex.Message),
                        category: Category.Exception, priority: Priority.Low
                    );
                    throw;
                }
            }

            return true;
        }

        public bool IsDeleteActionPlanAttachedDocFromPath(AttachmentsByActionPlan actionPlanAttachedDoc, string filepath)
        {
            try
            {
                if (filepath != null)
                {
                    string destination = string.Format(@"{0}\{1}", filepath, actionPlanAttachedDoc.IdActionPlan);
                    string completePath = string.Format(@"{0}\{1}\{2}", filepath, actionPlanAttachedDoc.IdActionPlan, actionPlanAttachedDoc.SavedFileName);

                    if (!Directory.Exists(destination))
                    {
                        return false;
                    }
                    else
                    {
                        if (File.Exists(completePath))
                        {
                            File.Delete(completePath);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error IsDeleteActionPlanAttachedDocFromPath()- Filename - {0}. ErrorMessage- {1}", actionPlanAttachedDoc.SavedFileName, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return true;
        }
        #endregion
        //[Shweta.thube][GEOS2-6591]
        public List<Responsible> GetResponsibleListAsPerLocation_V2580(string connectionString, string IdCompanies)
        {
            List<Responsible> responsibleList = new List<Responsible>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetResponsibleByLocation_V2580", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdCompanyLocation", IdCompanies);
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        #region MyRegion
                        while (rdr.Read())
                        {
                            Responsible responsible = new Responsible();
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                responsible.IdEmployee = Convert.ToUInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                responsible.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                responsible.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                responsible.LastName = Convert.ToString(rdr["LastName"]);
                                responsible.FullName = responsible.FirstName + " " + responsible.LastName;
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                responsible.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                responsible.EmployeeCodeWithIdGender = responsible.EmployeeCode + "_" + responsible.IdGender;
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                responsible.IdOrganizationCode = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["OrganizationCode"] != DBNull.Value)
                            {
                                responsible.Organization = Convert.ToString(rdr["OrganizationCode"]);
                            }
                            if (rdr["IdEmployeeStatus"] != DBNull.Value)
                            {
                                responsible.IdEmployeeStatus = Convert.ToInt16(rdr["IdEmployeeStatus"]);
                            }
                            if (rdr["JobCode"] != DBNull.Value)
                            {
                                responsible.JobCode = Convert.ToString(rdr["JobCode"]);
                            }

                            responsibleList.Add(responsible);
                        }
                        #endregion
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetResponsibleListAsPerLocation_V2580(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return responsibleList;
        }


        //[Shweta.thube][26-11-2024][GEOS2-6018]
        private void AddUpdateDeleteActionPlanComments_V2590(string connectionString, List<ActionPlanComment> commentsList)
        {
            try
            {
                if (commentsList != null)
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        foreach (var item in commentsList)
                        {
                            if (item.TransactionOperation == ModelBase.TransactionOperations.Add)
                            {
                                MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertActionPlanComment_V2580", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;
                                mySqlCommand.Parameters.AddWithValue("_Comment", item.Comment);
                                mySqlCommand.Parameters.AddWithValue("_IdActionPlan", item.IdActionPlan);
                                mySqlCommand.Parameters.AddWithValue("_CreatedBy", item.IdUser);
                                mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                mySqlCommand.ExecuteNonQuery();
                            }
                            else if (item.TransactionOperation == ModelBase.TransactionOperations.Update)
                            {
                                if (item.Id > 0)
                                {
                                    MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateActionPlanComment_V2590", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                                    mySqlCommand.Parameters.AddWithValue("_IdActionPlanComment", item.Id);
                                    mySqlCommand.Parameters.AddWithValue("_Comment", item.Comment);
                                    mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                    mySqlCommand.ExecuteNonQuery();
                                }
                            }
                            else if (item.TransactionOperation == ModelBase.TransactionOperations.Delete)
                            {
                                MySqlCommand mySqlCommand = new MySqlCommand("APM_DeleteActionPlanComment_V2580", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;
                                mySqlCommand.Parameters.AddWithValue("_IdActionPlanComment", item.Id);
                                mySqlCommand.ExecuteNonQuery();
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddUpdateDeleteActionPlanComments_V2590(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
        }

        //[shweta.thube][GEOS2-6018]
        public bool UpdateActionPlan_V2590(string connectionString, APMActionPlan actionPlan)
        {
            bool isUpdated = false;
            try
            {
                if (actionPlan != null)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateActionPlan_V2590", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlan.IdActionPlan);
                            mySqlCommand.Parameters.AddWithValue("_Description", actionPlan.Description);
                            mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlan.IdCompany);
                            mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlan.IdEmployee);
                            mySqlCommand.Parameters.AddWithValue("_IdOrigin", actionPlan.IdLookupOrigin);
                            mySqlCommand.Parameters.AddWithValue("_ModifiedBy", actionPlan.ModifiedBy);
                            mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlan.IdLookupBusinessUnit);
                            mySqlCommand.Parameters.AddWithValue("_IdDepartment", actionPlan.IdDepartment);

                            mySqlCommand.ExecuteNonQuery();
                            mySqlConnection.Close();


                        }

                        transactionScope.Complete();
                        transactionScope.Dispose();
                        isUpdated = true;
                    }
                    if (actionPlan?.CommentList?.Count > 0 && (actionPlan.CommentList.Any(x => x.TransactionOperation == ModelBase.TransactionOperations.Add) ||
                    actionPlan.CommentList.Any(y => y.TransactionOperation == ModelBase.TransactionOperations.Update) ||
                    actionPlan.CommentList.Any(z => z.TransactionOperation == ModelBase.TransactionOperations.Delete)))
                    {
                        //AddUpdateDeleteActionPlanComments(connectionString, actionPlan.CommentList);
                        AddUpdateDeleteActionPlanComments_V2590(connectionString, actionPlan.CommentList);
                    }
                    if (actionPlan.ActionPlanLogEntries != null && actionPlan.ActionPlanLogEntries.Count > 0)
                    {
                        AddLogEntriesByActionPlan_V2580(connectionString, actionPlan.ActionPlanLogEntries);
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateActionPlan_V2590(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }

        //[shweta.thube][GEOS2-6589]
        public List<APMActionPlanTask> GetTaskListByIdActionPlan_V2590(string connectionString, Int64 IdActionPlan, string selectedPeriod, Int32 idUser)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetTaskListByIdActionPlan_V2590", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            //if (rdr["IdLookupBusiness"] != DBNull.Value)
                            //{
                            //    task.IdLookupBusiness = Convert.ToInt32(rdr["IdLookupBusiness"]);
                            //}
                            //if (rdr["BusinessUnit"] != DBNull.Value)
                            //{
                            //    task.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            //}
                            //if (rdr["BusinessUnitHTMLColor"] != DBNull.Value)
                            //{
                            //    task.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHTMLColor"]);
                            //}
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }

                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }

                            taskList.Add(task);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTaskListByIdActionPlan_V2590(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }
        //[shweta.thube][GEOS2-6589]
        public List<APMActionPlan> GetActionPlanDetails_V2590(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlan> actionPlanList = new List<APMActionPlan>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_V2590", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlan actionPlan = new APMActionPlan();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.Country.Iso + ".png";
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.IdLookupBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                            }
                            if (rdr["BusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }
                            if (rdr["BusinessUnitHtmlColor"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHtmlColor"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                actionPlan.CreatedBy = Convert.ToInt16(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                actionPlan.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                actionPlan.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["IdDepartment"] != DBNull.Value)
                            {
                                actionPlan.IdDepartment = Convert.ToInt32(rdr["IdDepartment"]);
                                actionPlan.Department = Convert.ToString(rdr["Department"]);
                            }


                            actionPlanList.Add(actionPlan);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdActionPlan"] != DBNull.Value)
                                {
                                    APMActionPlan actionPlan = actionPlanList.FirstOrDefault(x => x.IdActionPlan == Convert.ToInt32(rdr["IdActionPlan"]));
                                    if (actionPlan != null)
                                    {
                                        if (actionPlan.TaskList == null)
                                        {
                                            actionPlan.TaskList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        //if (rdr["IdLookupBusiness"] != DBNull.Value)
                                        //{
                                        //    task.IdLookupBusiness = Convert.ToInt32(rdr["IdLookupBusiness"]);
                                        //}
                                        //if (rdr["BusinessUnit"] != DBNull.Value)
                                        //{
                                        //    task.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                                        //}
                                        //if (rdr["BusinessUnitHTMLColor"] != DBNull.Value)
                                        //{
                                        //    task.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHTMLColor"]);
                                        //}
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            task.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }


                                        if (task.DueDate != task.OriginalDueDate)
                                        {
                                            task.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            task.IsShowIcon = false;
                                        }
                                        actionPlan.TaskList.Add(task);
                                    }
                                }
                            }
                        }
                    }
                }

                foreach (var item in actionPlanList)
                {
                    if (item.TotalActionItems != 0)
                    {
                        item.Percentage = (int)(((float)item.TotalClosedItems / item.TotalActionItems) * 100);
                    }
                    else
                    {
                        item.Percentage = 0;
                    }

                    if (item.Percentage <= 24)
                    {
                        item.TotalClosedColor = "Red";
                    }
                    else if (item.Percentage >= 25 && item.Percentage <= 49)
                    {
                        item.TotalClosedColor = "Orange";
                    }
                    else if (item.Percentage >= 50 && item.Percentage <= 74)
                    {
                        item.TotalClosedColor = "Yellow";
                    }
                    else if (item.Percentage >= 75 && item.Percentage <= 99)
                    {
                        item.TotalClosedColor = "LightGreen";
                    }
                    else if (item.Percentage == 100)
                    {
                        item.TotalClosedColor = "Green";
                    }
                }

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2590(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanList;
        }
        //[shweta.thube][GEOS2-6585]
        public bool UpdateTaskForActionPlan_V2590(string connectionString, APMActionPlanTask actionPlanTask)
        {
            bool isUpdated = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateTaskForActionPlan_V2590", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        // Adding parameters to update the record
                        mySqlCommand.Parameters.AddWithValue("_IdTask", actionPlanTask.IdActionPlanTask);
                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        //mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlanTask.IdLookupBusiness);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        if (actionPlanTask.IdDelegated > 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                        mySqlCommand.Parameters.AddWithValue("_ModifiedBy", actionPlanTask.ModifiedBy);
                        mySqlCommand.Parameters.AddWithValue("_DueDateChangeCount", actionPlanTask.ChangeCount);
                        mySqlCommand.Parameters.AddWithValue("_Description", actionPlanTask.Description);
                        if (actionPlanTask.ClosedBy != 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_ClosedBy", actionPlanTask.ClosedBy);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_ClosedBy", null);
                        }



                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isUpdated = true;

                    AddLogEntriesByActionPlan_V2580(connectionString, actionPlanTask.ActionPlanLogEntries);
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateTaskForActionPlan_V2590(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }
        //[shweta.thube][GEOS2-6585]
        public APMActionPlanTask AddTaskForActionPlan_V2590(string connectionString, APMActionPlanTask actionPlanTask)
        {
            bool isAdded = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertTaskForActionPlan_V2590", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        //mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlanTask.IdLookupBusiness);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        if (actionPlanTask.IdDelegated > 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                        mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlanTask.CreatedBy);
                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                        mySqlCommand.Parameters.AddWithValue("_Description", actionPlanTask.Description);
                        mySqlCommand.Parameters.AddWithValue("_ClosedBy", actionPlanTask.ClosedBy);

                        actionPlanTask.IdActionPlanTask = Convert.ToUInt32(mySqlCommand.ExecuteScalar());
                        //mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();

                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isAdded = true;

                    AddLogEntriesByActionPlan_V2580(connectionString, actionPlanTask.ActionPlanLogEntries);
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddTaskForActionPlan_V2590(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanTask;
        }
        //[shweta.thube][GEOS2-6586]
        public APMActionPlan AddActionPlanDetails_V2590(string connectionString, APMActionPlan actionPlan)
        {
            bool isAdded = false;
            try
            {
                if (actionPlan != null)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("APM_AddActionPlanDetails_V2590", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_Code", actionPlan.Code);
                            mySqlCommand.Parameters.AddWithValue("_Description", actionPlan.Description);
                            mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlan.IdCompany);
                            mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlan.IdEmployee);
                            mySqlCommand.Parameters.AddWithValue("_IdOrigin", actionPlan.IdLookupOrigin);
                            mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlan.IdLookupBusinessUnit);
                            mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlan.CreatedBy);
                            mySqlCommand.Parameters.AddWithValue("_IdDepartment", actionPlan.IdDepartment);


                            actionPlan.IdActionPlan = Convert.ToInt64(mySqlCommand.ExecuteScalar());

                            mySqlConnection.Close();
                        }

                        transactionScope.Complete();
                        transactionScope.Dispose();
                        isAdded = true;
                    }
                    if (actionPlan?.CommentList?.Count > 0 && (actionPlan.CommentList.Any(x => x.TransactionOperation == ModelBase.TransactionOperations.Add) ||
                    actionPlan.CommentList.Any(y => y.TransactionOperation == ModelBase.TransactionOperations.Update)))
                    {
                        actionPlan.CommentList.ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                        AddUpdateDeleteActionPlanComments(connectionString, actionPlan.CommentList);
                    }

                    if (actionPlan.ActionPlanLogEntries != null && actionPlan.ActionPlanLogEntries.Count > 0)
                    {
                        if (actionPlan.IdActionPlan > 0)
                        {
                            actionPlan.ActionPlanLogEntries.ToList().ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                            AddLogEntriesByActionPlan_V2580(connectionString, actionPlan.ActionPlanLogEntries);
                        }
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddActionPlanDetails_V2590(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlan;
        }

        //[Sudhir.Jangra][GEOS2-6698]
        public List<Department> GetDepartmentsForActionPlan_V2590(string connectionString)
        {
            List<Department> departmentsList = new List<Department>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetDepartmentsForActionPlan_V2590", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            Department department = new Department();

                            if (rdr["IdDepartment"] != DBNull.Value)
                            {
                                department.IdDepartment = Convert.ToUInt32(rdr["IdDepartment"]);
                            }
                            if (rdr["DepartmentName"] != DBNull.Value)
                            {
                                department.DepartmentName = Convert.ToString(rdr["DepartmentName"]);
                            }
                            if (rdr["Abbreviation"] != DBNull.Value)
                            {
                                department.Abbreviation = Convert.ToString(rdr["Abbreviation"]);
                            }
                            departmentsList.Add(department);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetDepartmentsForActionPlan_V2590(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return departmentsList;
        }
        public List<VisibilityPerBU> GetEmployeeListWithBU_V2590(string connectionString, Int32 IdCompanies)
        {
            List<VisibilityPerBU> employeeList = new List<VisibilityPerBU>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetEmployeesByBusinessUnit_V2590", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_Plant", IdCompanies);
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {

                        while (rdr.Read())
                        {
                            VisibilityPerBU visibilityPerBU = new VisibilityPerBU();
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                visibilityPerBU.IdEmployee = Convert.ToUInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                visibilityPerBU.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                visibilityPerBU.ProfileImagePath = "https://api.emdep.com/GEOS/Images.aspx?FilePath=/Images/Employees/" + visibilityPerBU.EmployeeCode + ".png";
                            }
                            if (rdr["Name"] != DBNull.Value)
                            {
                                visibilityPerBU.FullName = Convert.ToString(rdr["Name"]);
                            }
                            if (rdr["IdsCompany"] != DBNull.Value)
                            {
                                visibilityPerBU.IdOrganizationCode = Convert.ToInt32(rdr["IdsCompany"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                visibilityPerBU.IdGender = Convert.ToUInt32(rdr["IdGender"]);

                                visibilityPerBU.Gender = new LookupValue();
                                visibilityPerBU.Gender.IdLookupValue = Convert.ToInt32(visibilityPerBU.IdGender);
                                visibilityPerBU.Gender.Value = Convert.ToString(rdr["Gender"]);
                            }
                            if (rdr["Organizations"] != DBNull.Value)
                            {
                                List<string> tempDifferentJobComp = Convert.ToString(rdr["Organizations"]).Split(',').ToList<string>();
                                tempDifferentJobComp = tempDifferentJobComp.Distinct().ToList();
                                visibilityPerBU.Organization = string.Join("\n", tempDifferentJobComp.Select(x => x.Trim()).ToArray());
                            }
                            if (rdr["Scope"] != DBNull.Value)
                            {
                                //visibilityPerBU.JDScope = Convert.ToString(rdr["Scope"]);
                                List<string> tempDifferentJDScope = Convert.ToString(rdr["Scope"]).Split(',').ToList<string>();
                                tempDifferentJDScope = tempDifferentJDScope.Distinct().ToList();
                                visibilityPerBU.JDScope = string.Join("\n", tempDifferentJDScope.Select(x => x.Trim()).ToArray());
                            }
                            if (rdr["JobDescriptions"] != DBNull.Value)
                            {
                                List<string> tempDifferentJobDesc = Convert.ToString(rdr["JobDescriptions"]).Split(',').ToList<string>();
                                tempDifferentJobDesc = tempDifferentJobDesc.Distinct().ToList();
                                visibilityPerBU.JobDescription = string.Join("\n", tempDifferentJobDesc.Select(x => x.Trim()).ToArray());
                            }
                            if (rdr["idActionPlanBuAccess"] != DBNull.Value)
                            {
                                List<string> tempDifferentIdsActionPlanBuAccess = Convert.ToString(rdr["idActionPlanBuAccess"]).Split(',').ToList<string>();
                                tempDifferentIdsActionPlanBuAccess = tempDifferentIdsActionPlanBuAccess.Distinct().ToList();
                                visibilityPerBU.IdsActionPlanBuAccess = string.Join("\n", tempDifferentIdsActionPlanBuAccess.Select(x => x.Trim()).ToArray());
                            }
                            if (rdr["BusinessUnits"] != DBNull.Value)
                            {
                                List<string> tempDifferentJobDesc = Convert.ToString(rdr["BusinessUnits"]).Split(',').ToList<string>();
                                tempDifferentJobDesc = tempDifferentJobDesc.Distinct().ToList();
                                visibilityPerBU.BusinessUnits = string.Join("\n", tempDifferentJobDesc.Select(x => x.Trim()).ToArray());
                            }
                            //if (rdr["BusinessUnits"] != DBNull.Value)
                            //{
                            //    if (visibilityPerBU.BusinessUnits.Contains("2159") && visibilityPerBU.TAU != "Yes")
                            //    {
                            //        visibilityPerBU.TAU = "Yes";
                            //    }
                            //    else
                            //    {
                            //        visibilityPerBU.TAU = "No";
                            //    }
                            //    if (visibilityPerBU.BusinessUnits.Contains("2160") && visibilityPerBU.ElectricTestBoards != "Yes")
                            //    {
                            //        visibilityPerBU.ElectricTestBoards = "Yes";
                            //    }
                            //    else
                            //    {
                            //        visibilityPerBU.ElectricTestBoards = "No";
                            //    }
                            //    if (visibilityPerBU.BusinessUnits.Contains("2161") && visibilityPerBU.Engineering != "Yes")
                            //    {
                            //        visibilityPerBU.Engineering = "Yes";
                            //    }
                            //    else
                            //    {
                            //        visibilityPerBU.Engineering = "No";
                            //    }
                            //    if (visibilityPerBU.BusinessUnits.Contains("2162") && visibilityPerBU.Assembly != "Yes")
                            //    {
                            //        visibilityPerBU.Assembly = "Yes";
                            //    }
                            //    else
                            //    {
                            //        visibilityPerBU.Assembly = "No";
                            //    }
                            //    if (visibilityPerBU.BusinessUnits.Contains("2163") && visibilityPerBU.Advanced != "Yes")
                            //    {
                            //        visibilityPerBU.Advanced = "Yes";
                            //    }
                            //    else
                            //    {
                            //        visibilityPerBU.Advanced = "No";
                            //    }
                            //}
                            //else
                            //{
                            //    visibilityPerBU.TAU = "No";
                            //    visibilityPerBU.ElectricTestBoards = "No";
                            //    visibilityPerBU.Engineering = "No";
                            //    visibilityPerBU.Assembly = "No";
                            //    visibilityPerBU.Advanced = "No";

                            //}
                            if (rdr["JobDescriptionCode"] != DBNull.Value)
                            {
                                visibilityPerBU.JobCode = Convert.ToString(rdr["JobDescriptionCode"]);
                            }
                            if (rdr["NativeName"] != DBNull.Value)
                            {
                                visibilityPerBU.NativeName = Convert.ToString(rdr["NativeName"]);
                            }
                            if (rdr["JobDescriptionTitle"] != DBNull.Value)
                            {
                                visibilityPerBU.FinalJobDescription = Convert.ToString(rdr["JobDescriptionTitle"]);
                            }
                            if (rdr["IdJobDescription"] != DBNull.Value)
                            {
                                visibilityPerBU.IdJobDescription = Convert.ToInt32(rdr["IdJobDescription"]);
                            }
                            if (rdr["Email"] != DBNull.Value)
                            {
                                visibilityPerBU.EmployeeContactEmail = Convert.ToString(rdr["Email"]);
                            }
                            if (rdr["LengthOfService"] != DBNull.Value)
                            {
                                visibilityPerBU.LengthOfService = Convert.ToString(rdr["LengthOfService"]);
                            }
                            if (rdr["ContractSituation"] != DBNull.Value)
                            {
                                visibilityPerBU.ContractSituation = Convert.ToString(rdr["ContractSituation"]);
                            }
                            if (rdr["HireDate"] != DBNull.Value)
                            {
                                visibilityPerBU.ContractSituationStartDate = Convert.ToDateTime(rdr["HireDate"]);
                            }
                            employeeList.Add(visibilityPerBU);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetEmployeeListWithBU_V2590(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return employeeList;
        }

        //[Shweta.thube][GEOS2-6696]
        public bool AddEmployeeWithBU_V2590(string connectionString, List<VisibilityPerBU> updateBusinessUnitList)
        {
            bool isUpdated = false;
            try
            {
                if (updateBusinessUnitList != null)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();
                            foreach (var item in updateBusinessUnitList)
                            {
                                MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertBUForEmployee_V2590", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;

                                // Adding parameters to update the record

                                mySqlCommand.Parameters.AddWithValue("_IdEmployee", item.IdEmployee);
                                mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", item.IdLookupBusinessUnit);
                                mySqlCommand.Parameters.AddWithValue("_CreatedBy", item.CreatedBy);
                                mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                mySqlCommand.Parameters.AddWithValue("_IsVisible", item.IsVisible);

                                mySqlCommand.ExecuteNonQuery();
                                mySqlConnection.Close();
                            }

                            transactionScope.Complete();
                            transactionScope.Dispose();
                            isUpdated = true;
                        }

                    }
                }

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddEmployeeWithBU_V2590(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }

        //[Sudhir.Jangra][GEOS2-6698]
        public List<Company> GetUnAuthorizedLocationListByIdCompany_V2590(string workbenchConnectionString, string idCompanies, string countryIconFilePath)
        {
            List<Company> companies = new List<Company>();
            List<string> countryISOs = new List<string>();

            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(workbenchConnectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetUnAuthorizedLocationListByIdCompany_V2590", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdCompanies", idCompanies);

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {

                        while (reader.Read())
                        {
                            Company company = new Company();
                            if (reader["IdCompany"] != DBNull.Value)
                            {
                                company.IdCompany = Convert.ToInt32(reader["IdCompany"]);
                                company.Name = Convert.ToString(reader["CompanyName"]);
                                company.Alias = Convert.ToString(reader["Alias"]);
                                company.ShortName = Convert.ToString(reader["Alias"]);
                                if (reader["IdCountry"] != DBNull.Value)
                                {
                                    company.IdCountry = Convert.ToByte(reader["IdCountry"]);
                                    company.Country = new Country();
                                    company.Country.IdCountry = Convert.ToByte(reader["IdCountry"]);
                                    company.Country.Name = Convert.ToString(reader["CountryName"]);
                                }
                                if (reader["IsLocation"] != DBNull.Value)
                                    company.IsLocation = Convert.ToByte(reader["IsLocation"]);

                                if (reader["IsOrganization"] != DBNull.Value)
                                    company.IsOrganization = Convert.ToByte(reader["IsOrganization"]);

                                if (reader["IsCompany"] != DBNull.Value)
                                    company.IsCompany = Convert.ToByte(reader["IsCompany"]);

                                if (reader["IsStillActive"] != DBNull.Value)
                                    company.IsStillActive = 0;

                                if (reader["IdCurrency"] != DBNull.Value)
                                {
                                    company.IdCurrency = Convert.ToInt16(reader["IdCurrency"]);
                                }
                                if (reader["CountryISO"] != DBNull.Value)
                                {
                                    company.Iso = Convert.ToString(reader["CountryISO"]);
                                    company.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + company.Iso + ".png";
                                }
                            }
                            companies.Add(company);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetUnAuthorizedLocationListByIdCompany_V2590(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return companies;
        }

        //[Sudhir.Jangra][GEOS2-6023]
        //public List<GlobalReport> GetGlobalReportOpenTasks_V2600(string connectionString,DateTime startDate,DateTime endDate)
        //{
        //    List<GlobalReport> taskOpenList=new List<GlobalReport>();

        //    try
        //    {
        //        using (MySqlConnection mySqlConnection=new MySqlConnection(connectionString))
        //        {
        //            mySqlConnection.Open();
        //            MySqlCommand mySqlCommand = new MySqlCommand("GetGlobalReportOpenTasks_V2600", mySqlConnection);
        //            mySqlCommand.CommandType=CommandType.StoredProcedure;
        //            mySqlCommand.Parameters.AddWithValue("_StartDate", startDate);
        //            mySqlCommand.Parameters.AddWithValue("_EndDate", endDate);

        //            using (MySqlDataReader rdr=mySqlCommand.ExecuteReader())
        //            {
        //                while (rdr.Read())
        //                {
        //                    GlobalReport task = new GlobalReport();
        //                    if (rdr["IdTask"] !=DBNull.Value)
        //                    {
        //                        task.IdTask = Convert.ToInt32(rdr["IdTask"]);
        //                    }
        //                    if (rdr["IdLocation"] != DBNull.Value)
        //                    {
        //                        task.IdLocation = Convert.ToInt32(rdr["IdLocation"]);
        //                    }
        //                    if (rdr["Plant"] != DBNull.Value)
        //                    {
        //                        task.Plant = Convert.ToString(rdr["Plant"]);
        //                    }
        //                    if (rdr["IdStatus"] != DBNull.Value)
        //                    {
        //                        task.IdStatus = Convert.ToInt32(rdr["IdStatus"]);
        //                    }
        //                    if (rdr["Status"] != DBNull.Value)
        //                    {
        //                        task.Status = Convert.ToString(rdr["Status"]);
        //                    }
        //                    if (rdr["TaskCount"] != DBNull.Value)
        //                    {
        //                        task.TaskCount = Convert.ToInt32(rdr["TaskCount"]);
        //                    }
        //                    taskOpenList.Add(task);
        //                }
        //            }
        //        }
        //    }
        //    catch (Exception ex)
        //    {
        //        Log4NetLogger.Logger.Log(string.Format("Error GetGlobalReportOpenTasks_V2600(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
        //        throw;
        //    }
        //    return taskOpenList;
        //}


        //[Sudhir.Jangra][GEOS2-6787]
        public List<Responsible> GetResponsibleListAsPerLocation_V2600(string connectionString, string IdCompanies)
        {
            List<Responsible> responsibleList = new List<Responsible>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetResponsibleByLocation_V2600", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdCompanyLocation", IdCompanies);
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        #region MyRegion
                        while (rdr.Read())
                        {
                            Responsible responsible = new Responsible();
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                responsible.IdEmployee = Convert.ToUInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                responsible.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                responsible.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                responsible.LastName = Convert.ToString(rdr["LastName"]);
                                responsible.FullName = responsible.FirstName + " " + responsible.LastName;
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                responsible.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                responsible.EmployeeCodeWithIdGender = responsible.EmployeeCode + "_" + responsible.IdGender;
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                responsible.IdOrganizationCode = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["OrganizationCode"] != DBNull.Value)
                            {
                                responsible.Organization = Convert.ToString(rdr["OrganizationCode"]);
                            }
                            if (rdr["IdEmployeeStatus"] != DBNull.Value)
                            {
                                responsible.IdEmployeeStatus = Convert.ToInt16(rdr["IdEmployeeStatus"]);
                            }
                            if (rdr["JobCode"] != DBNull.Value)
                            {
                                responsible.JobCode = Convert.ToString(rdr["JobCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                responsible.IdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["Login"] != DBNull.Value)
                            {
                                responsible.UserName = Convert.ToString(rdr["Login"]);
                            }
                            if (rdr["ResponsibleDisplayName"] != DBNull.Value)
                            {
                                responsible.ResponsibleDisplayName = Convert.ToString(rdr["ResponsibleDisplayName"]);
                            }


                            responsibleList.Add(responsible);
                        }
                        #endregion
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetResponsibleListAsPerLocation_V2600(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return responsibleList;
        }

        //[Sudhir.Jangra][GEOS2-6787]
        public List<Responsible> GetEmployeeListAsPerLocation_V2600(string connectionString, string IdCompanies)
        {
            List<Responsible> responsibleList = new List<Responsible>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetDelegatedToByLocation_V2600", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdCompanyLocation", IdCompanies);
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        #region MyRegion
                        while (rdr.Read())
                        {
                            Responsible responsible = new Responsible();
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                responsible.IdEmployee = Convert.ToUInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                responsible.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                responsible.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                responsible.LastName = Convert.ToString(rdr["LastName"]);
                                responsible.FullName = responsible.FirstName + " " + responsible.LastName;
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                responsible.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                responsible.EmployeeCodeWithIdGender = responsible.EmployeeCode + "_" + responsible.IdGender;
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                responsible.IdOrganizationCode = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["OrganizationCode"] != DBNull.Value)
                            {
                                responsible.Organization = Convert.ToString(rdr["OrganizationCode"]);
                            }
                            if (rdr["IdEmployeeStatus"] != DBNull.Value)
                            {
                                responsible.IdEmployeeStatus = Convert.ToInt16(rdr["IdEmployeeStatus"]);
                            }
                            if (rdr["JobCode"] != DBNull.Value)
                            {
                                responsible.JobCode = Convert.ToString(rdr["JobCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                responsible.IdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["Login"] != DBNull.Value)
                            {
                                responsible.UserName = Convert.ToString(rdr["Login"]);
                            }

                            responsibleList.Add(responsible);
                        }
                        #endregion
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetEmployeeListAsPerLocation_V2600(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return responsibleList;
        }
        //[shweta.thube][GEOS2-6453]
        public List<APMActionPlan> GetActionPlanDetails_V2600(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlan> actionPlanList = new List<APMActionPlan>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_V2600", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlan actionPlan = new APMActionPlan();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.Country.Iso + ".png";
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                actionPlan.ResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.IdLookupBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                            }
                            if (rdr["BusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }
                            if (rdr["BusinessUnitHtmlColor"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHtmlColor"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                actionPlan.CreatedBy = Convert.ToInt16(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                actionPlan.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                actionPlan.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["IdDepartment"] != DBNull.Value)
                            {
                                actionPlan.IdDepartment = Convert.ToInt32(rdr["IdDepartment"]);
                                actionPlan.Department = Convert.ToString(rdr["Department"]);
                            }
                            if (rdr["OriginDescription"] != DBNull.Value)
                            {
                                actionPlan.OriginDescription = Convert.ToString(rdr["OriginDescription"]);
                            }
                            if (rdr["ActionPlanResponsibleDisplayName"] != DBNull.Value)
                            {
                                actionPlan.ActionPlanResponsibleDisplayName = Convert.ToString(rdr["ActionPlanResponsibleDisplayName"]);
                            }

                            actionPlanList.Add(actionPlan);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdActionPlan"] != DBNull.Value)
                                {
                                    APMActionPlan actionPlan = actionPlanList.FirstOrDefault(x => x.IdActionPlan == Convert.ToInt32(rdr["IdActionPlan"]));
                                    if (actionPlan != null)
                                    {
                                        if (actionPlan.TaskList == null)
                                        {
                                            actionPlan.TaskList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            task.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (task.DueDate != task.OriginalDueDate)
                                        {
                                            task.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            task.IsShowIcon = false;
                                        }
                                        task.Code = actionPlan.Code;
                                        task.ActionPlanDescription = actionPlan.Description;
                                        task.TaskOrigin = actionPlan.Origin;
                                        task.BusinessUnit = actionPlan.BusinessUnit;
                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            task.Country = new Country();
                                            task.Country.Name = Convert.ToString(rdr["Country"]);
                                            task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                                        }
                                        actionPlan.TaskList.Add(task);
                                    }
                                }
                            }
                        }
                    }
                }

                foreach (var item in actionPlanList)
                {
                    if (item.TotalActionItems != 0)
                    {
                        item.Percentage = (int)(((float)item.TotalClosedItems / item.TotalActionItems) * 100);
                    }
                    else
                    {
                        item.Percentage = 0;
                    }

                    if (item.Percentage <= 24)
                    {
                        item.TotalClosedColor = "Red";
                    }
                    else if (item.Percentage >= 25 && item.Percentage <= 49)
                    {
                        item.TotalClosedColor = "Orange";
                    }
                    else if (item.Percentage >= 50 && item.Percentage <= 74)
                    {
                        item.TotalClosedColor = "Yellow";
                    }
                    else if (item.Percentage >= 75 && item.Percentage <= 99)
                    {
                        item.TotalClosedColor = "LightGreen";
                    }
                    else if (item.Percentage == 100)
                    {
                        item.TotalClosedColor = "Green";
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2600(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanList;
        }
        //[shweta.thube][GEOS2-6794]
        public APMActionPlan AddActionPlanDetails_V2600(string connectionString, APMActionPlan actionPlan)
        {
            bool isAdded = false;
            try
            {
                if (actionPlan != null)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("APM_AddActionPlanDetails_V2600", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_Code", actionPlan.Code);
                            mySqlCommand.Parameters.AddWithValue("_Description", actionPlan.Description);
                            mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlan.IdCompany);
                            mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlan.IdEmployee);
                            mySqlCommand.Parameters.AddWithValue("_IdOrigin", actionPlan.IdLookupOrigin);
                            mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlan.IdLookupBusinessUnit);
                            mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlan.CreatedBy);
                            mySqlCommand.Parameters.AddWithValue("_IdDepartment", actionPlan.IdDepartment);
                            mySqlCommand.Parameters.AddWithValue("_OriginDescription", actionPlan.OriginDescription);


                            actionPlan.IdActionPlan = Convert.ToInt64(mySqlCommand.ExecuteScalar());

                            mySqlConnection.Close();
                        }

                        transactionScope.Complete();
                        transactionScope.Dispose();
                        isAdded = true;
                    }
                    if (actionPlan?.CommentList?.Count > 0 && (actionPlan.CommentList.Any(x => x.TransactionOperation == ModelBase.TransactionOperations.Add) ||
                    actionPlan.CommentList.Any(y => y.TransactionOperation == ModelBase.TransactionOperations.Update)))
                    {
                        actionPlan.CommentList.ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                        AddUpdateDeleteActionPlanComments(connectionString, actionPlan.CommentList);
                    }

                    if (actionPlan.ActionPlanLogEntries != null && actionPlan.ActionPlanLogEntries.Count > 0)
                    {
                        if (actionPlan.IdActionPlan > 0)
                        {
                            actionPlan.ActionPlanLogEntries.ToList().ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                            AddLogEntriesByActionPlan_V2580(connectionString, actionPlan.ActionPlanLogEntries);
                        }
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddActionPlanDetails_V2600(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlan;
        }
        //[shweta.thube][GEOS2-6794]
        public bool UpdateActionPlan_V2600(string connectionString, APMActionPlan actionPlan)
        {
            bool isUpdated = false;
            try
            {
                if (actionPlan != null)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateActionPlan_V2600", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlan.IdActionPlan);
                            mySqlCommand.Parameters.AddWithValue("_Description", actionPlan.Description);
                            mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlan.IdCompany);
                            mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlan.IdEmployee);
                            mySqlCommand.Parameters.AddWithValue("_IdOrigin", actionPlan.IdLookupOrigin);
                            mySqlCommand.Parameters.AddWithValue("_ModifiedBy", actionPlan.ModifiedBy);
                            mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlan.IdLookupBusinessUnit);
                            mySqlCommand.Parameters.AddWithValue("_IdDepartment", actionPlan.IdDepartment);
                            mySqlCommand.Parameters.AddWithValue("_OriginDescription", actionPlan.OriginDescription);

                            mySqlCommand.ExecuteNonQuery();
                            mySqlConnection.Close();


                        }

                        transactionScope.Complete();
                        transactionScope.Dispose();
                        isUpdated = true;
                    }
                    if (actionPlan?.CommentList?.Count > 0 && (actionPlan.CommentList.Any(x => x.TransactionOperation == ModelBase.TransactionOperations.Add) ||
                    actionPlan.CommentList.Any(y => y.TransactionOperation == ModelBase.TransactionOperations.Update) ||
                    actionPlan.CommentList.Any(z => z.TransactionOperation == ModelBase.TransactionOperations.Delete)))
                    {
                        //AddUpdateDeleteActionPlanComments(connectionString, actionPlan.CommentList);
                        AddUpdateDeleteActionPlanComments_V2590(connectionString, actionPlan.CommentList);
                    }
                    if (actionPlan.ActionPlanLogEntries != null && actionPlan.ActionPlanLogEntries.Count > 0)
                    {
                        AddLogEntriesByActionPlan_V2580(connectionString, actionPlan.ActionPlanLogEntries);
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateActionPlan_V2600(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }
        //[shweta.thube][GEOS2-6795]
        public bool DeleteActionPlan_V2600(string connectionString, Int64 IdActionPlan)
        {
            bool isDeleted = false;
            if (IdActionPlan > 0)
            {
                try
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();
                        MySqlCommand mySqlCommand = new MySqlCommand("APM_DeleteActionPlan_V2600", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }
                    isDeleted = true;
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error DeleteActionPlan_V2600(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }
            }
            return isDeleted;
        }


        //[Sudhir.Jangra][GEOS2-6453]
        public List<APMActionPlanTask> GetActionPlanTaskDetails_V2600(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanTaskDetails_V2600", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                task.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["ActionDescription"] != DBNull.Value)
                            {
                                task.ActionPlanDescription = Convert.ToString(rdr["ActionDescription"]);
                            }
                            if (rdr["IdOrigin"] != DBNull.Value)
                            {
                                task.IdOrigin = Convert.ToInt32(rdr["IdOrigin"]);
                                task.TaskOrigin = Convert.ToString(rdr["TaskOrigin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                task.IdBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                                task.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                            {
                                task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                            }
                            if (rdr["DelegatedDisplayName"] != DBNull.Value)
                            {
                                task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                            }


                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }

                            if (rdr["Country"] != DBNull.Value)
                            {
                                task.Country = new Country();
                                task.Country.Name = Convert.ToString(rdr["Country"]);
                                task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                task.ActionPlanResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }

                            taskList.Add(task);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2600(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }

        //[Sudhir.Jangra][GEOS2-6616]
        public List<CommentsByTask> AddUpdateDeleteCommentsByIdTask_V2610(string connectionString, List<CommentsByTask> commentsList)
        {
            try
            {
                if (commentsList != null)
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        foreach (var item in commentsList)
                        {
                            if (item.TransactionOperation == ModelBase.TransactionOperations.Add)
                            {
                                MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertActionPlanTaskComment_V2570", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;
                                mySqlCommand.Parameters.AddWithValue("_Comment", item.Comments);
                                mySqlCommand.Parameters.AddWithValue("_IdTask", item.IdTask);
                                mySqlCommand.Parameters.AddWithValue("_CreatedBy", item.IdUser);
                                mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                mySqlCommand.Parameters.AddWithValue("_IsRtfText", item.IsRtfText);

                                item.IdActionPlanTaskComment = Convert.ToInt64(mySqlCommand.ExecuteScalar());
                            }
                            else if (item.TransactionOperation == ModelBase.TransactionOperations.Update)
                            {
                                if (item.IdActionPlanTaskComment > 0)
                                {
                                    MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateActionPlanTaskComment_V2610", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                                    mySqlCommand.Parameters.AddWithValue("_IdActionPlanTaskComment", item.IdActionPlanTaskComment);
                                    mySqlCommand.Parameters.AddWithValue("_Comment", item.Comments);
                                    mySqlCommand.Parameters.AddWithValue("_ModifiedBy", item.IdUser);
                                    mySqlCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    mySqlCommand.Parameters.AddWithValue("_IsRtfText", item.IsRtfText);
                                    mySqlCommand.ExecuteNonQuery();
                                }
                            }
                            else if (item.TransactionOperation == ModelBase.TransactionOperations.Delete)
                            {
                                MySqlCommand mySqlCommand = new MySqlCommand("APM_DeleteActionPlanTaskComment_V2610", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;
                                mySqlCommand.Parameters.AddWithValue("_IdActionPlanTaskComment", item.IdActionPlanTaskComment);
                                mySqlCommand.Parameters.AddWithValue("_DeletedIn", DateTime.Now);
                                mySqlCommand.Parameters.AddWithValue("_DeletedBy", item.IdUser);
                                if (item.IsDeleted)
                                {
                                    mySqlCommand.Parameters.AddWithValue("_IsDeleted", 1);
                                }
                                else
                                {
                                    mySqlCommand.Parameters.AddWithValue("_IsDeleted", 0);
                                }

                                mySqlCommand.ExecuteNonQuery();
                            }

                            if (item.ChangeLogList != null && item.ChangeLogList.Count > 0)
                            {
                                AddChangeLogForTaskComments_V2610(connectionString, item.ChangeLogList);
                            }
                        }
                        mySqlConnection.Close();
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddUpdateDeleteCommentsByIdTask_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return commentsList;
        }

        //[Sudhir.Jangra][GEOS2-6616]
        public void AddChangeLogForTaskComments_V2610(string connectionString, List<LogEntriesByActionPlan> logList)
        {
            try
            {
                if (logList != null)
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        foreach (LogEntriesByActionPlan item in logList)
                        {
                            MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertActionPlanTaskChangeLogComment_V2610", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_IdActionPlan", item.IdActionPlan);
                            mySqlCommand.Parameters.AddWithValue("_ChangeLogDateTime", DateTime.Now);
                            mySqlCommand.Parameters.AddWithValue("_ChangeLogIdUser", item.IdUser);
                            mySqlCommand.Parameters.AddWithValue("_ChangeLogChange", item.Comments);

                            mySqlCommand.ExecuteNonQuery();
                        }
                        mySqlConnection.Close();
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddChangeLogForTaskComments_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
        }

        //[Sudhir.Jangra][GEOS2-6616]
        public List<CommentsByTask> GetTaskCommentsByIdTask_V2610(string connectionString, Int64 idTask)
        {
            List<CommentsByTask> commentsList = new List<CommentsByTask>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetTaskCommentsByIdTask_V2610", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdTask", idTask);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            CommentsByTask comments = new CommentsByTask();

                            if (rdr["IdActionPlanTaskComment"] != DBNull.Value)
                            {
                                comments.IdActionPlanTaskComment = Convert.ToInt64(rdr["IdActionPlanTaskComment"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                comments.IdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                comments.IdTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["IdPerson"] != DBNull.Value)
                            {
                                comments.People = new People();
                                comments.People.IdPerson = Convert.ToInt32(rdr["IdPerson"]);
                                comments.People.Name = rdr["Name"].ToString();
                                comments.People.Surname = rdr["Surname"].ToString();
                                if (rdr["Login"] != DBNull.Value)
                                {
                                    comments.People.Login = Convert.ToString(rdr["Login"]);
                                }

                                if (rdr["IdUserGender"] != DBNull.Value)
                                {
                                    comments.People.IdPersonGender = Convert.ToByte(rdr["IdUserGender"]);
                                }
                            }

                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                comments.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["Comment"] != DBNull.Value)
                            {
                                comments.Comments = Convert.ToString(rdr["Comment"]);
                            }
                            if (rdr["IsRtfText"] != DBNull.Value)
                            {
                                comments.IsRtfText = Convert.ToBoolean(rdr["IsRtfText"]);
                            }
                            commentsList.Add(comments);
                        }
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTaskCommentsByIdTask_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return commentsList;
        }

        //[Sudhir.Jangra][GEOS2-6616]
        public List<APMActionPlan> GetActionPlanDetails_V2610(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlan> actionPlanList = new List<APMActionPlan>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_V2610", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlan actionPlan = new APMActionPlan();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.Country.Iso + ".png";
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                actionPlan.ResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.IdLookupBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                            }
                            if (rdr["BusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }
                            if (rdr["BusinessUnitHtmlColor"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHtmlColor"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                actionPlan.CreatedBy = Convert.ToInt16(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                actionPlan.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                actionPlan.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["IdDepartment"] != DBNull.Value)
                            {
                                actionPlan.IdDepartment = Convert.ToInt32(rdr["IdDepartment"]);
                                actionPlan.Department = Convert.ToString(rdr["Department"]);
                            }
                            if (rdr["OriginDescription"] != DBNull.Value)
                            {
                                actionPlan.OriginDescription = Convert.ToString(rdr["OriginDescription"]);
                            }
                            if (rdr["ActionPlanResponsibleDisplayName"] != DBNull.Value)
                            {
                                actionPlan.ActionPlanResponsibleDisplayName = Convert.ToString(rdr["ActionPlanResponsibleDisplayName"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                actionPlan.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                actionPlan.Group = Convert.ToString(rdr["CustomerName"]);
                            }

                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                actionPlan.Site = Convert.ToString(rdr["SiteName"]);
                                actionPlan.GroupName = actionPlan.Group + " " + "(" + actionPlan.Site + ")";
                            }
                            if (rdr["IdZone"] != DBNull.Value)
                            {
                                actionPlan.IdZone = Convert.ToInt32(rdr["IdZone"]);
                            }
                            if (rdr["Region"] != DBNull.Value)
                            {
                                actionPlan.Zone = Convert.ToString(rdr["Region"]);
                            }
                            actionPlanList.Add(actionPlan);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdActionPlan"] != DBNull.Value)
                                {
                                    APMActionPlan actionPlan = actionPlanList.FirstOrDefault(x => x.IdActionPlan == Convert.ToInt32(rdr["IdActionPlan"]));
                                    if (actionPlan != null)
                                    {
                                        if (actionPlan.TaskList == null)
                                        {
                                            actionPlan.TaskList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            task.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (task.DueDate != task.OriginalDueDate)
                                        {
                                            task.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            task.IsShowIcon = false;
                                        }
                                        task.Code = actionPlan.Code;
                                        task.ActionPlanDescription = actionPlan.Description;
                                        task.TaskOrigin = actionPlan.Origin;
                                        task.BusinessUnit = actionPlan.BusinessUnit;
                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            task.Country = new Country();
                                            task.Country.Name = Convert.ToString(rdr["Country"]);
                                            task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                                        }
                                        actionPlan.TaskList.Add(task);
                                    }
                                }
                            }
                        }
                    }
                }

                foreach (var item in actionPlanList)
                {
                    if (item.TotalActionItems != 0)
                    {
                        item.Percentage = (int)(((float)item.TotalClosedItems / item.TotalActionItems) * 100);
                    }
                    else
                    {
                        item.Percentage = 0;
                    }

                    if (item.Percentage <= 24)
                    {
                        item.TotalClosedColor = "Red";
                    }
                    else if (item.Percentage >= 25 && item.Percentage <= 49)
                    {
                        item.TotalClosedColor = "Orange";
                    }
                    else if (item.Percentage >= 50 && item.Percentage <= 74)
                    {
                        item.TotalClosedColor = "Yellow";
                    }
                    else if (item.Percentage >= 75 && item.Percentage <= 99)
                    {
                        item.TotalClosedColor = "LightGreen";
                    }
                    else if (item.Percentage == 100)
                    {
                        item.TotalClosedColor = "Green";
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanList;
        }

        //[Sudhir.Jangra][GEOS2-6616]
        public List<APMActionPlanTask> GetTaskListByIdActionPlan_V2610(string connectionString, Int64 IdActionPlan, string selectedPeriod, Int32 idUser)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetTaskListByIdActionPlan_V2610", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }

                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }

                            taskList.Add(task);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTaskListByIdActionPlan_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }

        //[Sudhir.Jangra][GEOS2-6616]
        public List<APMActionPlanTask> GetActionPlanTaskDetails_V2610(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanTaskDetails_V2600", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                task.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["ActionDescription"] != DBNull.Value)
                            {
                                task.ActionPlanDescription = Convert.ToString(rdr["ActionDescription"]);
                            }
                            if (rdr["IdOrigin"] != DBNull.Value)
                            {
                                task.IdOrigin = Convert.ToInt32(rdr["IdOrigin"]);
                                task.TaskOrigin = Convert.ToString(rdr["TaskOrigin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                task.IdBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                                task.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                            {
                                task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                            }
                            if (rdr["DelegatedDisplayName"] != DBNull.Value)
                            {
                                task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                            }


                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }

                            if (rdr["Country"] != DBNull.Value)
                            {
                                task.Country = new Country();
                                task.Country.Name = Convert.ToString(rdr["Country"]);
                                task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                task.ActionPlanResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }

                            taskList.Add(task);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanTaskDetails_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }

        //[shweta.thube][GEOS2-6911]
        public List<APMCustomer> GetCustomersWithSite_V2610(string connectionString)
        {
            List<APMCustomer> CustomerList = new List<APMCustomer>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("GetCustomersWithSites_V2610", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMCustomer customer = new APMCustomer();

                            if (rdr["IdCustomer"] != DBNull.Value)
                            {
                                customer.IdCustomer = Convert.ToInt32(rdr["IdCustomer"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                customer.Group = Convert.ToString(rdr["CustomerName"]);
                            }
                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                customer.Site = Convert.ToString(rdr["SiteName"]);
                                customer.GroupName = customer.Group + "(" + customer.Site + ")";
                            }
                            if (rdr["Region"] != DBNull.Value)
                            {
                                customer.Region = Convert.ToString(rdr["Region"]);
                            }
                            if (rdr["IdZone"] != DBNull.Value)
                            {
                                customer.IdRegion = Convert.ToInt32(rdr["IdZone"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                customer.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }


                            CustomerList.Add(customer);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetCustomersWithSite_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return CustomerList;
        }

        //[shweta.thube][GEOS2-6911]
        public APMActionPlan AddActionPlanDetails_V2610(string connectionString, APMActionPlan actionPlan)
        {
            bool isAdded = false;
            try
            {
                if (actionPlan != null)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("APM_AddActionPlanDetails_V2610", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_Code", actionPlan.Code);
                            mySqlCommand.Parameters.AddWithValue("_Description", actionPlan.Description);
                            mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlan.IdCompany);
                            mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlan.IdEmployee);
                            mySqlCommand.Parameters.AddWithValue("_IdOrigin", actionPlan.IdLookupOrigin);
                            mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlan.IdLookupBusinessUnit);
                            mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlan.CreatedBy);
                            mySqlCommand.Parameters.AddWithValue("_IdDepartment", actionPlan.IdDepartment);
                            mySqlCommand.Parameters.AddWithValue("_OriginDescription", actionPlan.OriginDescription);
                            //mySqlCommand.Parameters.AddWithValue("_IdSite", actionPlan.IdSite);
                            mySqlCommand.Parameters.AddWithValue("_IdSite", actionPlan.IdSite == 0 ? (object)DBNull.Value : actionPlan.IdSite);


                            actionPlan.IdActionPlan = Convert.ToInt64(mySqlCommand.ExecuteScalar());

                            mySqlConnection.Close();
                        }

                        transactionScope.Complete();
                        transactionScope.Dispose();
                        isAdded = true;
                    }
                    if (actionPlan?.CommentList?.Count > 0 && (actionPlan.CommentList.Any(x => x.TransactionOperation == ModelBase.TransactionOperations.Add) ||
                    actionPlan.CommentList.Any(y => y.TransactionOperation == ModelBase.TransactionOperations.Update)))
                    {
                        actionPlan.CommentList.ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                        AddUpdateDeleteActionPlanComments(connectionString, actionPlan.CommentList);
                    }

                    if (actionPlan.ActionPlanLogEntries != null && actionPlan.ActionPlanLogEntries.Count > 0)
                    {
                        if (actionPlan.IdActionPlan > 0)
                        {
                            actionPlan.ActionPlanLogEntries.ToList().ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                            AddLogEntriesByActionPlan_V2580(connectionString, actionPlan.ActionPlanLogEntries);
                        }
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddActionPlanDetails_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlan;
        }

        //[shweta.thube][GEOS2-6911]
        public bool UpdateActionPlan_V2610(string connectionString, APMActionPlan actionPlan)
        {
            bool isUpdated = false;
            try
            {
                if (actionPlan != null)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateActionPlan_V2610", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlan.IdActionPlan);
                            mySqlCommand.Parameters.AddWithValue("_Description", actionPlan.Description);
                            mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlan.IdCompany);
                            mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlan.IdEmployee);
                            mySqlCommand.Parameters.AddWithValue("_IdOrigin", actionPlan.IdLookupOrigin);
                            mySqlCommand.Parameters.AddWithValue("_ModifiedBy", actionPlan.ModifiedBy);
                            mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlan.IdLookupBusinessUnit);
                            mySqlCommand.Parameters.AddWithValue("_IdDepartment", actionPlan.IdDepartment);
                            mySqlCommand.Parameters.AddWithValue("_OriginDescription", actionPlan.OriginDescription);
                            //mySqlCommand.Parameters.AddWithValue("_IdSite", actionPlan.IdSite);
                            mySqlCommand.Parameters.AddWithValue("_IdSite", actionPlan.IdSite == 0 ? (object)DBNull.Value : actionPlan.IdSite);


                            mySqlCommand.ExecuteNonQuery();
                            mySqlConnection.Close();


                        }

                        transactionScope.Complete();
                        transactionScope.Dispose();
                        isUpdated = true;
                    }
                    if (actionPlan?.CommentList?.Count > 0 && (actionPlan.CommentList.Any(x => x.TransactionOperation == ModelBase.TransactionOperations.Add) ||
                    actionPlan.CommentList.Any(y => y.TransactionOperation == ModelBase.TransactionOperations.Update) ||
                    actionPlan.CommentList.Any(z => z.TransactionOperation == ModelBase.TransactionOperations.Delete)))
                    {
                        //AddUpdateDeleteActionPlanComments(connectionString, actionPlan.CommentList);
                        AddUpdateDeleteActionPlanComments_V2590(connectionString, actionPlan.CommentList);
                    }
                    if (actionPlan.ActionPlanLogEntries != null && actionPlan.ActionPlanLogEntries.Count > 0)
                    {
                        AddLogEntriesByActionPlan_V2580(connectionString, actionPlan.ActionPlanLogEntries);
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateActionPlan_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }
        //[shweta.thube][GEOS2-6911]
        public List<APMCustomer> GetActiveUserIdRegion_V2610(string connectionString, Int32 IdCompany)
        {
            List<APMCustomer> ActiveUserIdRegion = new List<APMCustomer>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("GetActiveUserRegionbyIdCountry_V2610", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdCompany", IdCompany);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMCustomer a = new APMCustomer();

                            if (rdr["IdRegion"] != DBNull.Value)
                            {
                                a.IdRegion = Convert.ToInt32(rdr["IdRegion"]);
                            }
                            if (rdr["Region"] != DBNull.Value)
                            {
                                a.Region = Convert.ToString(rdr["Region"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                a.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            ActiveUserIdRegion.Add(a);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActiveUserIdRegion_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return ActiveUserIdRegion;
        }

        //[GEOS2-6021][rdixit][17.02.2025]
        public bool AddImportedActionPlanDetails(string connectionString, APMActionPlan actionPlan)
        {
            bool isAdded = false;
            try
            {
                if (actionPlan != null)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("APM_AddImportActionPlanDetails_V2610", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_Code", actionPlan.Code);
                            mySqlCommand.Parameters.AddWithValue("_Description", actionPlan.Description);
                            mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlan.IdCompany);
                            mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlan.IdEmployee);
                            mySqlCommand.Parameters.AddWithValue("_IdOrigin", actionPlan.IdLookupOrigin);
                            mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlan.IdLookupBusinessUnit);
                            mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlan.CreatedBy);
                            mySqlCommand.Parameters.AddWithValue("_IdDepartment", actionPlan.IdDepartment);
                            mySqlCommand.Parameters.AddWithValue("_IdSite", actionPlan.IdCustomer);
                            actionPlan.IdActionPlan = Convert.ToInt64(mySqlCommand.ExecuteScalar());
                            mySqlConnection.Close();
                        }

                        if (actionPlan.ActionPlanLogEntries != null && actionPlan.ActionPlanLogEntries.Count > 0)
                        {
                            if (actionPlan.IdActionPlan > 0)
                            {
                                actionPlan.ActionPlanLogEntries.ToList().ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                                AddLogEntriesByActionPlan_V2580(connectionString, actionPlan.ActionPlanLogEntries);
                            }
                        }

                        #region [rdixit][Commented code as per pedro request]
                        if (actionPlan.TaskList != null && actionPlan.TaskList.Count > 0)
                        {
                            foreach (var actionPlanTask in actionPlan.TaskList)
                            {
                                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                                {
                                    mySqlConnection.Open();

                                    MySqlCommand mySqlCommand = new MySqlCommand("APM_AddImportTaskForActionPlan_V2610", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;

                                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlan.IdActionPlan);
                                    mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                                    mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                                    mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                                    mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                                    mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                                    mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                                    mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                                    mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                                    mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                                    mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlanTask.CreatedBy);
                                    mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                                    if (actionPlanTask.IdDelegated > 0)
                                    {
                                        mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                                    }
                                    else
                                    {
                                        mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                                    }
                                    mySqlCommand.Parameters.AddWithValue("_Description", actionPlanTask.Description);

                                    actionPlanTask.IdActionPlanTask = Convert.ToUInt32(mySqlCommand.ExecuteScalar());
                                    actionPlanTask.IdActionPlan = actionPlan.IdActionPlan;
                                    mySqlConnection.Close();

                                }

                                if (actionPlanTask.ActionPlanLogEntries != null && actionPlanTask.ActionPlanLogEntries.Count > 0)
                                {
                                    if (actionPlanTask.IdActionPlan > 0)
                                    {
                                        actionPlanTask.ActionPlanLogEntries.ToList().ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                                        AddLogEntriesByActionPlan_V2580(connectionString, actionPlanTask.ActionPlanLogEntries);
                                    }
                                }

                            }
                        }
                        #endregion

                        transactionScope.Complete();
                        transactionScope.Dispose();
                        isAdded = true;
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddImportedActionPlanDetails(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isAdded;
        }

        //[Sudhir.Jangra][GEOS2-6913][changed Data And properties again in 2630 for task GEOS2-7233]
        public DelayedTasks GetDelayedTasks_V2610(string connectionString, DateTime startDate, Int32 idCompany)
        {
            DelayedTasks task = new DelayedTasks();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetDelayedTaskList_V2610", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_StartDate", startDate);
                    mySqlCommand.Parameters.AddWithValue("_IdCompany", idCompany);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            if (rdr["OpenCurrentMonth"] != DBNull.Value)
                            {
                                task.OpenCurrentMonth = Convert.ToString(rdr["OpenCurrentMonth"]);
                            }
                            if (rdr["Open12Month"] != DBNull.Value)
                            {
                                task.Open12Month = Convert.ToString(rdr["Open12Month"]);
                            }
                            if (rdr["OverdueCurrentMonth"] != DBNull.Value)
                            {
                                task.OverdueCurrentMonth = Convert.ToString(rdr["OverdueCurrentMonth"]);
                            }
                            if (rdr["OverdueCurrentMonthHigh"] != DBNull.Value)
                            {
                                task.OverdueCurrentMonthHigh = Convert.ToString(rdr["OverdueCurrentMonthHigh"]);
                            }
                            if (rdr["OverdueCurrentMonthMedium"] != DBNull.Value)
                            {
                                task.OverdueCurrentMonthMedium = Convert.ToString(rdr["OverdueCurrentMonthMedium"]);
                            }
                            if (rdr["OverdueCurrentMonthLow"] != DBNull.Value)
                            {
                                task.OverdueCurrentMonthLow = Convert.ToString(rdr["OverdueCurrentMonthLow"]);
                            }
                            if (rdr["Overdue12Month"] != DBNull.Value)
                            {
                                task.Overdue12Month = Convert.ToString(rdr["Overdue12Month"]);
                            }
                            if (rdr["Overdue12MonthHigh"] != DBNull.Value)
                            {
                                task.Overdue12MonthHigh = Convert.ToString(rdr["Overdue12MonthHigh"]);
                            }
                            if (rdr["Overdue12MonthMedium"] != DBNull.Value)
                            {
                                task.Overdue12MonthMedium = Convert.ToString(rdr["Overdue12MonthMedium"]);
                            }
                            if (rdr["Overdue12MonthLow"] != DBNull.Value)
                            {
                                task.Overdue12MonthLow = Convert.ToString(rdr["Overdue12MonthLow"]);
                            }
                            if (rdr["OpenDaysCurrentMonth"] != DBNull.Value)
                            {
                                task.OpenDaysCurrentMonth = Convert.ToString(rdr["OpenDaysCurrentMonth"]);
                            }
                            if (rdr["OpenDays12Month"] != DBNull.Value)
                            {
                                task.OpenDays12Month = Convert.ToString(rdr["OpenDays12Month"]);
                            }
                            if (rdr["BlockedCurrentMonth"] != DBNull.Value)
                            {
                                task.BlockedCurrentMonth = Convert.ToString(rdr["BlockedCurrentMonth"]);
                            }
                            if (rdr["Blocked12Month"] != DBNull.Value)
                            {
                                task.Blocked12Month = Convert.ToString(rdr["Blocked12Month"]);
                            }
                            if (rdr["Total12Month"] != DBNull.Value)
                            {
                                task.Total12Month = Convert.ToString(rdr["Total12Month"]);
                            }
                            if (rdr["LastDays"] != DBNull.Value)
                            {
                                task.LastDays = Convert.ToString(rdr["LastDays"]);
                            }
                            if (rdr["OpenDays12Month"] != DBNull.Value)
                            {
                                task.Open12MonthCustomDays = Convert.ToString(rdr["OpenDays12Month"]);
                            }
                        }
                    }
                    con.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetDelayedTasks_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return task;
        }

        //[Sudhir.Jangra][GEOS2-6913]
        public List<OverdueTaskMail> GetOverdueTOTaskMail_V2610(string connectionString, Int32 IdCompany, string To_Ids)
        {
            List<OverdueTaskMail> overdueTaskList = new List<OverdueTaskMail>();

            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {

                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_GetDelayedTasksToMailIDs_V2610", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdCompany", IdCompany);
                        // mySqlCommand.Parameters.AddWithValue("_TO_CC_Ids", To_CC_Ids);
                        mySqlCommand.Parameters.AddWithValue("_TO_Ids", To_Ids);
                        //  mySqlCommand.Parameters.AddWithValue("_CC_Ids", cc_Ids);

                        using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                try
                                {
                                    OverdueTaskMail overdueTaskMail = new OverdueTaskMail();

                                    if (reader["IdEmployee"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdEmployee = Convert.ToUInt32(reader["IdEmployee"]);
                                    }

                                    if (reader["IdCompany"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdCompany = Convert.ToUInt32(reader["IdCompany"]);
                                    }

                                    if (reader["IdJobDescription"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdJobDescription = Convert.ToUInt32(reader["IdJobDescription"]);
                                    }

                                    if (reader["CompanyEmail"] != DBNull.Value)
                                    {
                                        overdueTaskMail.EmployeeContactValue = Convert.ToString(reader["CompanyEmail"]);
                                    }

                                    if (reader["FirstName"] != DBNull.Value)
                                    {
                                        overdueTaskMail.FirstName = Convert.ToString(reader["FirstName"]);
                                    }

                                    if (reader["LastName"] != DBNull.Value)
                                    {
                                        overdueTaskMail.LastName = Convert.ToString(reader["LastName"]);
                                    }

                                    if (reader["EmployeeCode"] != DBNull.Value)
                                    {
                                        overdueTaskMail.EmployeeCode = Convert.ToString(reader["EmployeeCode"]);
                                    }
                                    if (reader["JobDescriptionCode"] != DBNull.Value)
                                    {
                                        overdueTaskMail.JobDescriptionCode = Convert.ToString(reader["JobDescriptionCode"]);
                                    }

                                    overdueTaskList.Add(overdueTaskMail);
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetOverdueTOTaskMail_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                                }
                            }
                        }

                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                }

                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();



                    Log4NetLogger.Logger.Log(string.Format("Error GetOverdueTOTaskMail_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    throw;
                }
                return overdueTaskList;
            }
        }

        //[Sudhir.Jangra][GEOS2-6913]
        public List<OverdueTaskMail> GetOverdueCCTaskMail_V2610(string connectionString, Int32 IdCompany, string To_CC_Ids, string cc_Ids)
        {
            List<OverdueTaskMail> overdueTaskList = new List<OverdueTaskMail>();

            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {

                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_GetDelayedTasksCCMailIDs_V2610", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdCompany", IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_TO_CC_Ids", To_CC_Ids);
                        //mySqlCommand.Parameters.AddWithValue("_TO_Ids", To_Ids);
                        mySqlCommand.Parameters.AddWithValue("_CC_Ids", cc_Ids);

                        using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                try
                                {
                                    OverdueTaskMail overdueTaskMail = new OverdueTaskMail();

                                    if (reader["IdEmployee"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdEmployee = Convert.ToUInt32(reader["IdEmployee"]);
                                    }

                                    if (reader["IdCompany"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdCompany = Convert.ToUInt32(reader["IdCompany"]);
                                    }

                                    if (reader["IdJobDescription"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdJobDescription = Convert.ToUInt32(reader["IdJobDescription"]);
                                    }

                                    if (reader["CompanyEmail"] != DBNull.Value)
                                    {
                                        overdueTaskMail.EmployeeContactValue = Convert.ToString(reader["CompanyEmail"]);
                                    }

                                    if (reader["FirstName"] != DBNull.Value)
                                    {
                                        overdueTaskMail.FirstName = Convert.ToString(reader["FirstName"]);
                                    }

                                    if (reader["LastName"] != DBNull.Value)
                                    {
                                        overdueTaskMail.LastName = Convert.ToString(reader["LastName"]);
                                    }

                                    if (reader["EmployeeCode"] != DBNull.Value)
                                    {
                                        overdueTaskMail.EmployeeCode = Convert.ToString(reader["EmployeeCode"]);
                                    }
                                    if (reader["JobDescriptionCode"] != DBNull.Value)
                                    {
                                        overdueTaskMail.JobDescriptionCode = Convert.ToString(reader["JobDescriptionCode"]);
                                    }

                                    overdueTaskList.Add(overdueTaskMail);
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetOverdueCCTaskMail_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                                }
                            }
                        }

                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                }

                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();



                    Log4NetLogger.Logger.Log(string.Format("Error GetOverdueCCTaskMail_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    throw;
                }
                return overdueTaskList;
            }
        }


        //[Sudhir.Jangra][GEOS2-6913]
        public List<OverdueTaskMail> GetResponsibleOverdueTaskMail_V2610(string connectionString, Int32 IdCompany, string To_CC_Ids, DateTime startDate)
        {
            List<OverdueTaskMail> overdueTaskList = new List<OverdueTaskMail>();

            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {

                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_GetResponsibleDelayedTaskListWithMailIDs_V2610", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_StartDate", startDate);
                        mySqlCommand.Parameters.AddWithValue("_IdCompany", IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_TO_CC_Ids", To_CC_Ids);

                        using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                try
                                {
                                    OverdueTaskMail overdueTaskMail = new OverdueTaskMail();

                                    if (reader["IdEmployee"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdEmployee = Convert.ToUInt32(reader["IdEmployee"]);
                                    }

                                    if (reader["IdCompany"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdCompany = Convert.ToUInt32(reader["IdCompany"]);
                                    }

                                    if (reader["IdJobDescription"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdJobDescription = Convert.ToUInt32(reader["IdJobDescription"]);
                                    }

                                    if (reader["CompanyEmail"] != DBNull.Value)
                                    {
                                        overdueTaskMail.EmployeeContactValue = Convert.ToString(reader["CompanyEmail"]);
                                    }

                                    if (reader["FirstName"] != DBNull.Value)
                                    {
                                        overdueTaskMail.FirstName = Convert.ToString(reader["FirstName"]);
                                    }

                                    if (reader["LastName"] != DBNull.Value)
                                    {
                                        overdueTaskMail.LastName = Convert.ToString(reader["LastName"]);
                                    }

                                    if (reader["EmployeeCode"] != DBNull.Value)
                                    {
                                        overdueTaskMail.EmployeeCode = Convert.ToString(reader["EmployeeCode"]);
                                    }
                                    if (reader["JobDescriptionCode"] != DBNull.Value)
                                    {
                                        overdueTaskMail.JobDescriptionCode = Convert.ToString(reader["JobDescriptionCode"]);
                                    }

                                    overdueTaskList.Add(overdueTaskMail);
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetResponsibleOverdueTaskMail_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                                }
                            }
                        }

                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                }

                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();



                    Log4NetLogger.Logger.Log(string.Format("Error GetResponsibleOverdueTaskMail_V2610(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    throw;
                }
                return overdueTaskList;
            }
        }

        //[Sudhir.Jangra][GEOS2-7006]
        public bool UpdateTaskForActionPlan_V2620(string connectionString, APMActionPlanTask actionPlanTask, string filePath)
        {
            bool isUpdated = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateTaskForActionPlan_V2620", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        // Adding parameters to update the record
                        mySqlCommand.Parameters.AddWithValue("_IdTask", actionPlanTask.IdActionPlanTask);
                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        //mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlanTask.IdLookupBusiness);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        if (actionPlanTask.IdDelegated > 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                        mySqlCommand.Parameters.AddWithValue("_ModifiedBy", actionPlanTask.ModifiedBy);
                        mySqlCommand.Parameters.AddWithValue("_DueDateChangeCount", actionPlanTask.ChangeCount);
                        mySqlCommand.Parameters.AddWithValue("_Description", actionPlanTask.Description);
                        if (actionPlanTask.ClosedBy != 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_ClosedBy", actionPlanTask.ClosedBy);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_ClosedBy", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_IdOTItem", actionPlanTask.IdOTItem == 0 ? (object)DBNull.Value : actionPlanTask.IdOTItem);


                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isUpdated = true;

                    if (actionPlanTask.ActionPlanLogEntries != null)
                    {
                        AddLogEntriesByActionPlan_V2580(connectionString, actionPlanTask.ActionPlanLogEntries);
                    }

                    if (!string.IsNullOrEmpty(actionPlanTask.TaskStatusComment))
                    {
                        CommentsByTask commentsByTask = new CommentsByTask();
                        commentsByTask.Comments = actionPlanTask.TaskStatusComment;
                        commentsByTask.IdTask = actionPlanTask.IdActionPlanTask;
                        commentsByTask.IdUser = actionPlanTask.ModifiedBy;
                        commentsByTask.IsRtfText = false;

                        AddStatusCommentForTask_V2620(connectionString, commentsByTask);
                    }

                    if (actionPlanTask.TaskAttachmentList != null && actionPlanTask.TaskAttachmentList.Count > 0)
                    {
                        actionPlanTask.TaskAttachmentList.ForEach(x => x.Description = actionPlanTask.TaskStatusDescription);
                        actionPlanTask.TaskAttachmentList.ForEach(x => x.IdTask = actionPlanTask.IdActionPlanTask);
                        AddStatusAttachmentForTask_V2620(connectionString, actionPlanTask.TaskAttachmentList, filePath);
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateTaskForActionPlan_V2620(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }

        //[Sudhir.Jangra][GEOS2-7006]
        public void AddStatusAttachmentForTask_V2620(string connectionString, List<AttachmentsByTask> attachmentList, string filePath)
        {
            try
            {
                if (attachmentList != null && attachmentList.Count > 0)
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        foreach (AttachmentsByTask item in attachmentList)
                        {
                            string completePath = @"\" + item.IdTask + @"\" + item.SavedFileName;
                            MySqlCommand mySqlCommand = new MySqlCommand("APM_AddActionPlanTaskAttachment_V2620", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;
                            mySqlCommand.Parameters.AddWithValue("_fName", item.SavedFileName);
                            mySqlCommand.Parameters.AddWithValue("_FileLocation", completePath);
                            mySqlCommand.Parameters.AddWithValue("_IdTask", item.IdTask);
                            mySqlCommand.Parameters.AddWithValue("_CreatedBy", item.CreatedBy);
                            mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                            mySqlCommand.Parameters.AddWithValue("_Description", item.Description);
                            mySqlCommand.Parameters.AddWithValue("_IsDeleted", 0);

                            item.IdActionPlanTaskAttachment = Convert.ToInt64(mySqlCommand.ExecuteScalar());

                            if (item.IdActionPlanTaskAttachment > 0)
                            {
                                AddActionPlanTaskAttachedDocToPath(item, filePath);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddStatusAttachmentForTask_V2620(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
        }

        //[Sudhir.Jangra][GEOS2-7006]
        public bool AddActionPlanTaskAttachedDocToPath(AttachmentsByTask actionPlanAttachedDoc, string actionPlanFilePath)
        {
            if (actionPlanAttachedDoc.FileByte != null)
            {
                try
                {
                    string completePath = string.Format(@"{0}\{1}", actionPlanFilePath, actionPlanAttachedDoc.IdTask);
                    string filePath = completePath + "\\" + actionPlanAttachedDoc.SavedFileName;

                    if (!Directory.Exists(completePath))
                    {
                        Directory.CreateDirectory(completePath);
                    }
                    else
                    {
                        if (File.Exists(filePath))
                        {
                            File.Delete(filePath);
                        }
                    }
                    File.WriteAllBytes(filePath, actionPlanAttachedDoc.FileByte);
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error AddActionPlanAttachedDocToPath()- Filename - {0}. ErrorMessage- {1}", actionPlanAttachedDoc.SavedFileName, ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }
            }

            return true;
        }

        //[Sudhir.Jangra][GEOS2-7006]
        public void AddStatusCommentForTask_V2620(string connectionString, CommentsByTask commentsByTask)
        {
            try
            {
                if (commentsByTask != null)
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertActionPlanTaskComment_V2620", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_Comment", commentsByTask.Comments);
                        mySqlCommand.Parameters.AddWithValue("_IdTask", commentsByTask.IdTask);
                        mySqlCommand.Parameters.AddWithValue("_CreatedBy", commentsByTask.IdUser);
                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                        mySqlCommand.Parameters.AddWithValue("_IsRtfText", commentsByTask.IsRtfText);
                        mySqlCommand.ExecuteNonQuery();

                        mySqlConnection.Close();
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddStatusCommentForTask_V2620(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
        }

        //[shweta.thube][GEOS2-6912]
        #region connection methods

        /// <summary>
        /// This method is used to get connection string name exists or not by name.
        /// </summary>
        public bool IsConnectionStringNameExist_V2620(string Name)
        {
            bool isExist = false;
            ConnectionStringSettingsCollection settings = ConfigurationManager.ConnectionStrings;
            if (settings != null)
            {
                foreach (ConnectionStringSettings cs in settings)
                {
                    if (cs.Name == Name)
                    {
                        isExist = true;
                        return isExist;
                    }
                }
            }
            return isExist;
        }

        #endregion
        //[shweta.thube][GEOS2-6912]
        public List<Company> GetEmdepSitesCompanies_V2620(string connectionstring, Int64 IdSite, Int64 IdResponsibleLocation)
        {
            List<Company> companies = new List<Company>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionstring))
                {
                    con.Open();
                    MySqlCommand consitecommand = new MySqlCommand("emdepsites_GetEmdepSitesDetail_V2620", con);
                    consitecommand.CommandType = CommandType.StoredProcedure;
                    consitecommand.Parameters.AddWithValue("_IdCustomerSite", IdSite);
                    consitecommand.Parameters.AddWithValue("_IdEmdepSite", IdResponsibleLocation);
                    using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                    {
                        while (sitereader.Read())
                        {
                            string connstr = "Data Source = " + sitereader["DatabaseIP"].ToString() + "; Database = geos; User ID = GeosUsr; Password = GEOS;Convert Zero Datetime=True";
                            if (companies.Any(co => co.ConnectPlantConstr == connstr))
                            {

                            }

                            else
                            {
                                Company company = new Company();

                                company.IdCompany = Convert.ToInt32(sitereader["IdSite"].ToString());
                                company.Name = sitereader["Name"].ToString();
                                company.ShortName = sitereader["ShortName"].ToString();
                                company.Alias = sitereader["ShortName"].ToString();
                                company.ConnectPlantId = sitereader["IdSite"].ToString();
                                company.ConnectPlantConstr = connstr;
                                if (sitereader["IdCurrency"] != DBNull.Value)
                                    company.IdCurrency = Convert.ToInt32(sitereader["IdCurrency"].ToString());
                                company.Country = new Country();
                                company.Country.IdCountry = Convert.ToByte(sitereader["idCountry"].ToString());
                                company.Country.Name = sitereader["name"].ToString();
                                companies.Add(company);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetEmdepSitesCompanies_V2620(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return companies;
        }
        //[shweta.thube][GEOS2-6912]
        public List<OTs> GetOTsAsPerTaskLocation_V2620(Int32 IdCompany, string connectionstring, DateTime FromDate, DateTime ToDate)
        {

            List<OTs> oTsList = new List<OTs>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionstring))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetOtsAsPerTaskLocation_V2620", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdSite", IdCompany);
                    mySqlCommand.Parameters.AddWithValue("_FromDate", FromDate);
                    mySqlCommand.Parameters.AddWithValue("_ToDate", ToDate);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            OTs ot = new OTs();

                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                ot.IdOT = Convert.ToInt32(rdr["IdOT"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                ot.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                ot.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["CreationDate"] != DBNull.Value)
                            {
                                ot.CreationDate = Convert.ToDateTime(rdr["CreationDate"]);
                            }
                            if (!oTsList.Any(x => x.IdOT == ot.IdOT))
                                oTsList.Add(ot);

                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                OTs o = oTsList.FirstOrDefault(x => x.IdOT == Convert.ToInt32(rdr["IdOT"]));
                                if (o != null)
                                {
                                    if (o.OtItemsList == null)
                                    {
                                        o.OtItemsList = new List<OTs>();
                                    }
                                    OTs temp = new OTs();

                                    temp.IdOT = Convert.ToInt32(rdr["IdOT"]);

                                    if (rdr["IdItemOtStatus"] != DBNull.Value)
                                    {
                                        temp.IdItemOtStatus = Convert.ToInt64(rdr["IdItemOtStatus"]);
                                    }
                                    if (rdr["StatusName"] != DBNull.Value)
                                    {
                                        temp.StatusName = Convert.ToString(rdr["StatusName"]);
                                    }
                                    if (rdr["IdOTItem"] != DBNull.Value)
                                    {
                                        temp.IdOTItem = Convert.ToInt64(rdr["IdOTItem"]);
                                    }
                                    if (rdr["Code"] != DBNull.Value)
                                    {
                                        temp.Code = Convert.ToString(rdr["Code"]);
                                    }
                                    if (rdr["Reference"] != DBNull.Value)
                                    {
                                        temp.Reference = Convert.ToString(rdr["Reference"]);
                                    }
                                    if (rdr["Description"] != DBNull.Value)
                                    {
                                        temp.Description = Convert.ToString(rdr["Description"]);
                                    }
                                    if (rdr["NumItem"] != DBNull.Value)
                                    {
                                        temp.NumItem = Convert.ToString(rdr["NumItem"]);
                                    }
                                    if (rdr["NumItem"] != DBNull.Value)
                                    {
                                        temp.CodeNumber = temp.Code + " " + "–" + " " + temp.NumItem;
                                    }
                                    o.OtItemsList.Add(temp);
                                }
                            }

                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetOTsAsPerTaskLocation_V2620(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return oTsList;
        }
        //[shweta.thube][GEOS2-6912]
        public APMActionPlanTask AddTaskForActionPlan_V2620(string connectionString, APMActionPlanTask actionPlanTask)
        {
            bool isAdded = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertTaskForActionPlan_V2620", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        //mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlanTask.IdLookupBusiness);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        if (actionPlanTask.IdDelegated > 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                        mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlanTask.CreatedBy);
                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                        mySqlCommand.Parameters.AddWithValue("_Description", actionPlanTask.Description);
                        mySqlCommand.Parameters.AddWithValue("_ClosedBy", actionPlanTask.ClosedBy);
                        mySqlCommand.Parameters.AddWithValue("_IdOTItem", actionPlanTask.IdOTItem == 0 ? (object)DBNull.Value : actionPlanTask.IdOTItem);

                        actionPlanTask.IdActionPlanTask = Convert.ToUInt32(mySqlCommand.ExecuteScalar());

                        //mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();

                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isAdded = true;

                    AddLogEntriesByActionPlan_V2580(connectionString, actionPlanTask.ActionPlanLogEntries);
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddTaskForActionPlan_V2620(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanTask;
        }

        //[shweta.thube][GEOS2-6912]
        public List<APMActionPlan> GetActionPlanDetails_V2620(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlan> actionPlanList = new List<APMActionPlan>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_V2620", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlan actionPlan = new APMActionPlan();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.Country.Iso + ".png";
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                actionPlan.ResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.IdLookupBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                            }
                            if (rdr["BusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }
                            if (rdr["BusinessUnitHtmlColor"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHtmlColor"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                actionPlan.CreatedBy = Convert.ToInt16(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                actionPlan.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                actionPlan.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["IdDepartment"] != DBNull.Value)
                            {
                                actionPlan.IdDepartment = Convert.ToInt32(rdr["IdDepartment"]);
                                actionPlan.Department = Convert.ToString(rdr["Department"]);
                            }
                            if (rdr["OriginDescription"] != DBNull.Value)
                            {
                                actionPlan.OriginDescription = Convert.ToString(rdr["OriginDescription"]);
                            }
                            if (rdr["ActionPlanResponsibleDisplayName"] != DBNull.Value)
                            {
                                actionPlan.ActionPlanResponsibleDisplayName = Convert.ToString(rdr["ActionPlanResponsibleDisplayName"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                actionPlan.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                actionPlan.Group = Convert.ToString(rdr["CustomerName"]);
                            }

                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                actionPlan.Site = Convert.ToString(rdr["SiteName"]);
                                actionPlan.GroupName = actionPlan.Group + " " + "(" + actionPlan.Site + ")";
                            }
                            if (rdr["IdZone"] != DBNull.Value)
                            {
                                actionPlan.IdZone = Convert.ToInt32(rdr["IdZone"]);
                            }
                            if (rdr["Region"] != DBNull.Value)
                            {
                                actionPlan.Zone = Convert.ToString(rdr["Region"]);
                            }
                            actionPlanList.Add(actionPlan);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdActionPlan"] != DBNull.Value)
                                {
                                    APMActionPlan actionPlan = actionPlanList.FirstOrDefault(x => x.IdActionPlan == Convert.ToInt32(rdr["IdActionPlan"]));
                                    if (actionPlan != null)
                                    {
                                        if (actionPlan.TaskList == null)
                                        {
                                            actionPlan.TaskList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            task.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (task.DueDate != task.OriginalDueDate)
                                        {
                                            task.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            task.IsShowIcon = false;
                                        }
                                        task.Code = actionPlan.Code;
                                        task.ActionPlanDescription = actionPlan.Description;
                                        task.TaskOrigin = actionPlan.Origin;
                                        task.BusinessUnit = actionPlan.BusinessUnit;
                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            task.Country = new Country();
                                            task.Country.Name = Convert.ToString(rdr["Country"]);
                                            task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["NumItem"] != DBNull.Value)
                                        {
                                            task.NumItem = Convert.ToString(rdr["NumItem"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            task.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            task.IdOT = Convert.ToInt32(rdr["IdOT"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        actionPlan.TaskList.Add(task);
                                    }
                                }
                            }
                        }
                    }
                }

                foreach (var item in actionPlanList)
                {
                    if (item.TotalActionItems != 0)
                    {
                        item.Percentage = (int)(((float)item.TotalClosedItems / item.TotalActionItems) * 100);
                    }
                    else
                    {
                        item.Percentage = 0;
                    }

                    if (item.Percentage <= 24)
                    {
                        item.TotalClosedColor = "Red";
                    }
                    else if (item.Percentage >= 25 && item.Percentage <= 49)
                    {
                        item.TotalClosedColor = "Orange";
                    }
                    else if (item.Percentage >= 50 && item.Percentage <= 74)
                    {
                        item.TotalClosedColor = "Yellow";
                    }
                    else if (item.Percentage >= 75 && item.Percentage <= 99)
                    {
                        item.TotalClosedColor = "LightGreen";
                    }
                    else if (item.Percentage == 100)
                    {
                        item.TotalClosedColor = "Green";
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2620(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanList;
        }
        //[shweta.thube][GEOS2-6912]
        public List<APMActionPlanTask> GetTaskListByIdActionPlan_V2620(string connectionString, Int64 IdActionPlan, string selectedPeriod, Int32 idUser)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetTaskListByIdActionPlan_V2620", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }

                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }
                            if (rdr["IdOTItem"] != DBNull.Value)
                            {
                                task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                            }
                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                task.IdOT = Convert.ToInt64(rdr["IdOT"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.OTCode = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                            {
                                task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                            }
                            if (rdr["Participant"] != DBNull.Value)
                            {
                                string participantString = rdr["Participant"].ToString();
                                task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                            }
                            taskList.Add(task);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTaskListByIdActionPlan_V2620(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }
        //[shweta.thube][GEOS2-6912]
        public List<APMActionPlanTask> GetActionPlanTaskDetails_V2620(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanTaskDetails_V2620", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                task.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["ActionDescription"] != DBNull.Value)
                            {
                                task.ActionPlanDescription = Convert.ToString(rdr["ActionDescription"]);
                            }
                            if (rdr["IdOrigin"] != DBNull.Value)
                            {
                                task.IdOrigin = Convert.ToInt32(rdr["IdOrigin"]);
                                task.TaskOrigin = Convert.ToString(rdr["TaskOrigin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                task.IdBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                                task.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                            {
                                task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                            }
                            if (rdr["DelegatedDisplayName"] != DBNull.Value)
                            {
                                task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                            }


                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }

                            if (rdr["Country"] != DBNull.Value)
                            {
                                task.Country = new Country();
                                task.Country.Name = Convert.ToString(rdr["Country"]);
                                task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                task.ActionPlanResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }

                            if (rdr["IdOTItem"] != DBNull.Value)
                            {
                                task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                            }
                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                task.IdOT = Convert.ToInt64(rdr["IdOT"]);
                            }
                            if (rdr["OTCode"] != DBNull.Value)
                            {
                                task.OTCode = Convert.ToString(rdr["OTCode"]);
                            }
                            if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                            {
                                task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                            }
                            if (rdr["Participant"] != DBNull.Value)
                            {
                                string participantString = rdr["Participant"].ToString();
                                task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;
                            }

                            taskList.Add(task);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanTaskDetails_V2620(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }

        //[Sudhir.Jangra][GEOS2-7007]
        public bool UpdateStatusByIdTask_V2620(string connectionString, APMActionPlanTask actionPlanTask, Int32 IdLookupChangedValues, string ChangedTaskComment, Int32 CreatedBy, string filePath)
        {
            bool isUpdated = false;
            try
            {
                //Updating Task Status
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateStatusForActionPlanTask_V2570", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdTask", actionPlanTask.IdActionPlanTask);
                    mySqlCommand.Parameters.AddWithValue("_IdStatus", IdLookupChangedValues);
                    mySqlCommand.ExecuteNonQuery();
                    mySqlConnection.Close();
                }

                //Insert Task Comment
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertActionPlanTaskComment_V2570", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_Comment", ChangedTaskComment);
                    mySqlCommand.Parameters.AddWithValue("_IdTask", actionPlanTask.IdActionPlanTask);
                    mySqlCommand.Parameters.AddWithValue("_CreatedBy", CreatedBy);
                    mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                    mySqlCommand.Parameters.AddWithValue("_IsRtfText", 0);
                    mySqlCommand.ExecuteNonQuery();
                    mySqlConnection.Close();
                }

                if (actionPlanTask.TaskAttachmentList != null && actionPlanTask.TaskAttachmentList.Count > 0)
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();
                        foreach (var item in actionPlanTask.TaskAttachmentList)
                        {
                            item.IdTask = actionPlanTask.IdActionPlanTask;
                            string completePath = @"\" + actionPlanTask.IdActionPlanTask + @"\" + item.SavedFileName;
                            MySqlCommand mySqlCommand = new MySqlCommand("APM_AddActionPlanTaskAttachment_V2620", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;
                            mySqlCommand.Parameters.AddWithValue("_fName", item.SavedFileName);
                            mySqlCommand.Parameters.AddWithValue("_FileLocation", completePath);
                            mySqlCommand.Parameters.AddWithValue("_IdTask", actionPlanTask.IdActionPlanTask);
                            mySqlCommand.Parameters.AddWithValue("_CreatedBy", CreatedBy);
                            mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                            mySqlCommand.Parameters.AddWithValue("_Description", item.Description);
                            mySqlCommand.Parameters.AddWithValue("_IsDeleted", 0);

                            item.IdActionPlanTaskAttachment = Convert.ToInt64(mySqlCommand.ExecuteScalar());

                            if (item.IdActionPlanTaskAttachment > 0)
                            {
                                AddActionPlanTaskAttachedDocToPath(item, filePath);
                            }
                        }
                        mySqlConnection.Close();
                    }
                }

                if (actionPlanTask.ActionPlanLogEntries != null)
                {
                    AddLogEntriesByActionPlan_V2580(connectionString, actionPlanTask.ActionPlanLogEntries);
                }
                isUpdated = true;
            }

            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateStatusByIdTask_V2620(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }
        //[shweta.thube][GEOS2-7008]
        public List<Responsible> GetParticipantsByIdTask_V2620(string connectionString, Int64 idTask)
        {
            List<Responsible> participantsList = new List<Responsible>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetParticipantsByIdTask_V2620", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdTask", idTask);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            Responsible responsible = new Responsible();
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                responsible.IdEmployee = Convert.ToUInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                responsible.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                responsible.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                responsible.LastName = Convert.ToString(rdr["LastName"]);
                                responsible.FullName = responsible.FirstName + " " + responsible.LastName;
                            }
                            //if (rdr["IdCompany"] != DBNull.Value)
                            //{
                            //    responsible.IdOrganizationCode = Convert.ToInt32(rdr["IdCompany"]);
                            //}
                            if (rdr["OrganizationCode"] != DBNull.Value)
                            {
                                responsible.Organization = Convert.ToString(rdr["OrganizationCode"]);
                            }
                            if (rdr["JobCode"] != DBNull.Value)
                            {
                                responsible.JobCode = Convert.ToString(rdr["JobCode"]);
                            }
                            if (rdr["ResponsibleDisplayName"] != DBNull.Value)
                            {
                                responsible.ResponsibleDisplayName = Convert.ToString(rdr["ResponsibleDisplayName"]);
                            }
                            if (rdr["JobDescriptionTitle"] != DBNull.Value)
                            {
                                responsible.JobDescriptionTitle = Convert.ToString(rdr["JobDescriptionTitle"]);
                            }

                            participantsList.Add(responsible);
                        }
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetParticipantsByIdTask_V2620(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return participantsList;
        }
        //[shweta.thube][GEOS2-7008]
        public List<Responsible> AddDeleteParticipantsByIdTask_V2620(string connectionString, List<Responsible> tempParticipantsList)
        {
            try
            {
                if (tempParticipantsList != null)
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        foreach (var item in tempParticipantsList)
                        {
                            if (item.TransactionOperation == ModelBase.TransactionOperations.Add)
                            {
                                MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertRequestParticipants_V2620", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;
                                mySqlCommand.Parameters.AddWithValue("_IdTask", item.IdTask);
                                mySqlCommand.Parameters.AddWithValue("_IdEmployee", item.IdEmployee);

                                mySqlCommand.ExecuteNonQuery();

                            }
                            else if (item.TransactionOperation == ModelBase.TransactionOperations.Delete)
                            {
                                MySqlCommand mySqlCommand = new MySqlCommand("APM_DeleteRequestParticipant_V2620", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;
                                mySqlCommand.Parameters.AddWithValue("_IdTask", item.IdTask);
                                mySqlCommand.Parameters.AddWithValue("_IdEmployee", item.IdEmployee);

                                mySqlCommand.ExecuteNonQuery();

                            }

                        }

                        mySqlConnection.Close();
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddDeleteParticipantsByIdTask_V2620(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return tempParticipantsList;
        }
        //[shweta.thube][GEOS2-7008]
        public List<Responsible> GetResponsibleListAsPerLocation_V2620(string connectionString, string IdCompanies)
        {
            List<Responsible> responsibleList = new List<Responsible>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetResponsibleByLocation_V2620", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdCompanyLocation", IdCompanies);
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        #region MyRegion
                        while (rdr.Read())
                        {
                            Responsible responsible = new Responsible();
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                responsible.IdEmployee = Convert.ToUInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                responsible.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                responsible.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                responsible.LastName = Convert.ToString(rdr["LastName"]);
                                responsible.FullName = responsible.FirstName + " " + responsible.LastName;
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                responsible.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                responsible.EmployeeCodeWithIdGender = responsible.EmployeeCode + "_" + responsible.IdGender;
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                responsible.IdOrganizationCode = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["OrganizationCode"] != DBNull.Value)
                            {
                                responsible.Organization = Convert.ToString(rdr["OrganizationCode"]);
                            }
                            if (rdr["IdEmployeeStatus"] != DBNull.Value)
                            {
                                responsible.IdEmployeeStatus = Convert.ToInt16(rdr["IdEmployeeStatus"]);
                            }
                            if (rdr["JobCode"] != DBNull.Value)
                            {
                                responsible.JobCode = Convert.ToString(rdr["JobCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                responsible.IdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["Login"] != DBNull.Value)
                            {
                                responsible.UserName = Convert.ToString(rdr["Login"]);
                            }
                            if (rdr["ResponsibleDisplayName"] != DBNull.Value)
                            {
                                responsible.ResponsibleDisplayName = Convert.ToString(rdr["ResponsibleDisplayName"]);
                            }
                            if (rdr["JobDescriptionTitle"] != DBNull.Value)
                            {
                                responsible.JobDescriptionTitle = Convert.ToString(rdr["JobDescriptionTitle"]);
                            }

                            responsibleList.Add(responsible);
                        }
                        #endregion
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetResponsibleListAsPerLocation_V2620(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return responsibleList;
        }

        //[Sudhir.Jangra][GEOS2-7209]
        public List<APMActionPlan> GetActionPlanDetails_V2630(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlan> actionPlanList = new List<APMActionPlan>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_V2630", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlan actionPlan = new APMActionPlan();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.Country.Iso + ".png";
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                actionPlan.ResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.IdLookupBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                            }
                            if (rdr["BusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }
                            if (rdr["BusinessUnitHtmlColor"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHtmlColor"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                actionPlan.CreatedBy = Convert.ToInt16(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                actionPlan.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                actionPlan.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["IdDepartment"] != DBNull.Value)
                            {
                                actionPlan.IdDepartment = Convert.ToInt32(rdr["IdDepartment"]);
                                actionPlan.Department = Convert.ToString(rdr["Department"]);
                            }
                            if (rdr["OriginDescription"] != DBNull.Value)
                            {
                                actionPlan.OriginDescription = Convert.ToString(rdr["OriginDescription"]);
                            }
                            if (rdr["ActionPlanResponsibleDisplayName"] != DBNull.Value)
                            {
                                actionPlan.ActionPlanResponsibleDisplayName = Convert.ToString(rdr["ActionPlanResponsibleDisplayName"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                actionPlan.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                actionPlan.Group = Convert.ToString(rdr["CustomerName"]);
                            }

                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                actionPlan.Site = Convert.ToString(rdr["SiteName"]);
                                actionPlan.GroupName = actionPlan.Group + " " + "(" + actionPlan.Site + ")";
                            }
                            if (rdr["IdZone"] != DBNull.Value)
                            {
                                actionPlan.IdZone = Convert.ToInt32(rdr["IdZone"]);
                            }
                            if (rdr["Region"] != DBNull.Value)
                            {
                                actionPlan.Zone = Convert.ToString(rdr["Region"]);
                            }
                            actionPlanList.Add(actionPlan);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdActionPlan"] != DBNull.Value)
                                {
                                    APMActionPlan actionPlan = actionPlanList.FirstOrDefault(x => x.IdActionPlan == Convert.ToInt32(rdr["IdActionPlan"]));
                                    if (actionPlan != null)
                                    {
                                        if (actionPlan.TaskList == null)
                                        {
                                            actionPlan.TaskList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            task.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (task.DueDate != task.OriginalDueDate)
                                        {
                                            task.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            task.IsShowIcon = false;
                                        }
                                        task.Code = actionPlan.Code;
                                        task.ActionPlanDescription = actionPlan.Description;
                                        task.TaskOrigin = actionPlan.Origin;
                                        task.BusinessUnit = actionPlan.BusinessUnit;
                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            task.Country = new Country();
                                            task.Country.Name = Convert.ToString(rdr["Country"]);
                                            task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["NumItem"] != DBNull.Value)
                                        {
                                            task.NumItem = Convert.ToString(rdr["NumItem"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            task.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            task.IdOT = Convert.ToInt32(rdr["IdOT"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        actionPlan.TaskList.Add(task);
                                    }
                                }
                            }
                        }
                    }
                }

                foreach (var item in actionPlanList)
                {
                    if (item.TotalActionItems != 0)
                    {
                        item.Percentage = (int)(((float)item.TotalClosedItems / item.TotalActionItems) * 100);
                    }
                    else
                    {
                        item.Percentage = 0;
                    }

                    if (item.Percentage <= 24)
                    {
                        item.TotalClosedColor = "Red";
                    }
                    else if (item.Percentage >= 25 && item.Percentage <= 49)
                    {
                        item.TotalClosedColor = "Orange";
                    }
                    else if (item.Percentage >= 50 && item.Percentage <= 74)
                    {
                        item.TotalClosedColor = "Yellow";
                    }
                    else if (item.Percentage >= 75 && item.Percentage <= 99)
                    {
                        item.TotalClosedColor = "LightGreen";
                    }
                    else if (item.Percentage == 100)
                    {
                        item.TotalClosedColor = "Green";
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2630(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanList;
        }


        //[shweta.thube][GEOS2-7238]
        public List<APMActionPlanTask> GetActionPlanTaskDetails_V2630(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanTaskDetails_V2630", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                task.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["ActionDescription"] != DBNull.Value)
                            {
                                task.ActionPlanDescription = Convert.ToString(rdr["ActionDescription"]);
                            }
                            if (rdr["IdOrigin"] != DBNull.Value)
                            {
                                task.IdOrigin = Convert.ToInt32(rdr["IdOrigin"]);
                                task.TaskOrigin = Convert.ToString(rdr["TaskOrigin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                task.IdBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                                task.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                            {
                                task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                            }
                            if (rdr["DelegatedDisplayName"] != DBNull.Value)
                            {
                                task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                            }


                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }

                            if (rdr["Country"] != DBNull.Value)
                            {
                                task.Country = new Country();
                                task.Country.Name = Convert.ToString(rdr["Country"]);
                                task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                task.ActionPlanResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }

                            if (rdr["IdOTItem"] != DBNull.Value)
                            {
                                task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                            }
                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                task.IdOT = Convert.ToInt64(rdr["IdOT"]);
                            }
                            if (rdr["OTCode"] != DBNull.Value)
                            {
                                task.OTCode = Convert.ToString(rdr["OTCode"]);
                            }
                            if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                            {
                                task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                            }
                            if (rdr["Participant"] != DBNull.Value)
                            {
                                string participantString = rdr["Participant"].ToString();
                                task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                task.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            taskList.Add(task);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanTaskDetails_V2630(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }

        //[Sudhir.Jangra][GEOS2-7209]
        public List<APMActionPlanTask> GetTaskListByIdActionPlan_V2630(string connectionString, Int64 IdActionPlan, string selectedPeriod, Int32 idUser)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetTaskListByIdActionPlan_V2630", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }

                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }
                            if (rdr["IdOTItem"] != DBNull.Value)
                            {
                                task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                            }
                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                task.IdOT = Convert.ToInt64(rdr["IdOT"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.OTCode = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                            {
                                task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                            }
                            if (rdr["Participant"] != DBNull.Value)
                            {
                                string participantString = rdr["Participant"].ToString();
                                task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                            }
                            taskList.Add(task);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTaskListByIdActionPlan_V2630(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }

        //[rdixit][GEOS2-7883][15.04.2025]
        public bool AddImportedActionPlanDetails_V2630(string connectionString, APMActionPlan actionPlan)
        {
            bool isAdded = false;
            try
            {
                if (actionPlan != null)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("APM_AddImportActionPlanDetails_V2610", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_Code", actionPlan.Code);
                            mySqlCommand.Parameters.AddWithValue("_Description", actionPlan.Description);
                            mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlan.IdCompany);
                            mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlan.IdEmployee);
                            mySqlCommand.Parameters.AddWithValue("_IdOrigin", actionPlan.IdLookupOrigin);
                            mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlan.IdLookupBusinessUnit);
                            mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlan.CreatedBy);
                            mySqlCommand.Parameters.AddWithValue("_IdDepartment", actionPlan.IdDepartment);
                            if (actionPlan.IdCustomer == 0)
                                mySqlCommand.Parameters.AddWithValue("_IdSite", null);
                            else
                                mySqlCommand.Parameters.AddWithValue("_IdSite", actionPlan.IdCustomer);
                            actionPlan.IdActionPlan = Convert.ToInt64(mySqlCommand.ExecuteScalar());
                            mySqlConnection.Close();
                        }

                        if (actionPlan.ActionPlanLogEntries != null && actionPlan.ActionPlanLogEntries.Count > 0)
                        {
                            if (actionPlan.IdActionPlan > 0)
                            {
                                actionPlan.ActionPlanLogEntries.ToList().ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                                AddLogEntriesByActionPlan_V2580(connectionString, actionPlan.ActionPlanLogEntries);
                            }
                        }

                        #region [rdixit][Commented code as per pedro request]
                        if (actionPlan.TaskList != null && actionPlan.TaskList.Count > 0)
                        {
                            foreach (var actionPlanTask in actionPlan.TaskList)
                            {
                                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                                {
                                    mySqlConnection.Open();

                                    MySqlCommand mySqlCommand = new MySqlCommand("APM_AddImportTaskForActionPlan_V2610", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;

                                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlan.IdActionPlan);
                                    mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                                    mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                                    mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                                    mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                                    mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                                    mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                                    mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                                    mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                                    mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                                    mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlanTask.CreatedBy);
                                    mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                                    if (actionPlanTask.IdDelegated > 0)
                                    {
                                        mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                                    }
                                    else
                                    {
                                        mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                                    }
                                    mySqlCommand.Parameters.AddWithValue("_Description", actionPlanTask.Description);

                                    actionPlanTask.IdActionPlanTask = Convert.ToUInt32(mySqlCommand.ExecuteScalar());
                                    actionPlanTask.IdActionPlan = actionPlan.IdActionPlan;
                                    mySqlConnection.Close();

                                }

                                if (actionPlanTask.ActionPlanLogEntries != null && actionPlanTask.ActionPlanLogEntries.Count > 0)
                                {
                                    if (actionPlanTask.IdActionPlan > 0)
                                    {
                                        actionPlanTask.ActionPlanLogEntries.ToList().ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                                        AddLogEntriesByActionPlan_V2580(connectionString, actionPlanTask.ActionPlanLogEntries);
                                    }
                                }

                            }
                        }
                        #endregion

                        transactionScope.Complete();
                        transactionScope.Dispose();
                        isAdded = true;
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddImportedActionPlanDetails(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isAdded;
        }

        //[shweta.thube][GEOS2-7212][23.04.2025]
        public List<APMActionPlan> GetActionPlanDetails_V2640(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlan> actionPlanList = new List<APMActionPlan>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_V2640", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlan actionPlan = new APMActionPlan();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.Country.Iso + ".png";
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                actionPlan.ResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.IdLookupBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                            }
                            if (rdr["BusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }
                            if (rdr["BusinessUnitHtmlColor"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHtmlColor"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                actionPlan.CreatedBy = Convert.ToInt16(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                actionPlan.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                actionPlan.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["IdDepartment"] != DBNull.Value)
                            {
                                actionPlan.IdDepartment = Convert.ToInt32(rdr["IdDepartment"]);
                                actionPlan.Department = Convert.ToString(rdr["Department"]);
                            }
                            if (rdr["OriginDescription"] != DBNull.Value)
                            {
                                actionPlan.OriginDescription = Convert.ToString(rdr["OriginDescription"]);
                            }
                            if (rdr["ActionPlanResponsibleDisplayName"] != DBNull.Value)
                            {
                                actionPlan.ActionPlanResponsibleDisplayName = Convert.ToString(rdr["ActionPlanResponsibleDisplayName"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                actionPlan.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                actionPlan.Group = Convert.ToString(rdr["CustomerName"]);
                            }

                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                actionPlan.Site = Convert.ToString(rdr["SiteName"]);
                                actionPlan.GroupName = actionPlan.Group + " " + "(" + actionPlan.Site + ")";
                            }
                            if (rdr["IdZone"] != DBNull.Value)
                            {
                                actionPlan.IdZone = Convert.ToInt32(rdr["IdZone"]);
                            }
                            if (rdr["Region"] != DBNull.Value)
                            {
                                actionPlan.Zone = Convert.ToString(rdr["Region"]);
                            }
                            actionPlanList.Add(actionPlan);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdActionPlan"] != DBNull.Value)
                                {
                                    APMActionPlan actionPlan = actionPlanList.FirstOrDefault(x => x.IdActionPlan == Convert.ToInt32(rdr["IdActionPlan"]));
                                    if (actionPlan != null)
                                    {
                                        if (actionPlan.TaskList == null)
                                        {
                                            actionPlan.TaskList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            task.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (task.DueDate != task.OriginalDueDate)
                                        {
                                            task.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            task.IsShowIcon = false;
                                        }
                                        task.Code = actionPlan.Code;
                                        task.ActionPlanDescription = actionPlan.Description;
                                        task.TaskOrigin = actionPlan.Origin;
                                        task.BusinessUnit = actionPlan.BusinessUnit;
                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            task.Country = new Country();
                                            task.Country.Name = Convert.ToString(rdr["Country"]);
                                            task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["NumItem"] != DBNull.Value)
                                        {
                                            task.NumItem = Convert.ToString(rdr["NumItem"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            task.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            task.IdOT = Convert.ToInt32(rdr["IdOT"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        actionPlan.TaskList.Add(task);
                                    }
                                }
                            }
                        }
                    }
                }

                foreach (var item in actionPlanList)
                {
                    if (item.TotalActionItems != 0)
                    {
                        item.Percentage = (int)(((float)item.TotalClosedItems / item.TotalActionItems) * 100);
                    }
                    else
                    {
                        item.Percentage = 0;
                    }

                    if (item.Percentage <= 24)
                    {
                        item.TotalClosedColor = "Red";
                    }
                    else if (item.Percentage >= 25 && item.Percentage <= 49)
                    {
                        item.TotalClosedColor = "Orange";
                    }
                    else if (item.Percentage >= 50 && item.Percentage <= 74)
                    {
                        item.TotalClosedColor = "Yellow";
                    }
                    else if (item.Percentage >= 75 && item.Percentage <= 99)
                    {
                        item.TotalClosedColor = "LightGreen";
                    }
                    else if (item.Percentage == 100)
                    {
                        item.TotalClosedColor = "Green";
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2640(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanList;
        }

        //[shweta.thube][GEOS2-7212][23.04.2025]
        public List<APMActionPlanTask> GetActionPlanTaskDetails_V2640(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanTaskDetails_V2640", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                task.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["ActionDescription"] != DBNull.Value)
                            {
                                task.ActionPlanDescription = Convert.ToString(rdr["ActionDescription"]);
                            }
                            if (rdr["IdOrigin"] != DBNull.Value)
                            {
                                task.IdOrigin = Convert.ToInt32(rdr["IdOrigin"]);
                                task.TaskOrigin = Convert.ToString(rdr["TaskOrigin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                task.IdBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                                task.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                            {
                                task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                            }
                            if (rdr["DelegatedDisplayName"] != DBNull.Value)
                            {
                                task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                            }


                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }

                            if (rdr["Country"] != DBNull.Value)
                            {
                                task.Country = new Country();
                                task.Country.Name = Convert.ToString(rdr["Country"]);
                                task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                task.ActionPlanResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }

                            if (rdr["IdOTItem"] != DBNull.Value)
                            {
                                task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                            }
                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                task.IdOT = Convert.ToInt64(rdr["IdOT"]);
                            }
                            if (rdr["OTCode"] != DBNull.Value)
                            {
                                task.OTCode = Convert.ToString(rdr["OTCode"]);
                            }
                            if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                            {
                                task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                            }
                            if (rdr["Participant"] != DBNull.Value)
                            {
                                string participantString = rdr["Participant"].ToString();
                                task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                task.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            taskList.Add(task);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanTaskDetails_V2640(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }

        //[shweta.thube][GEOS2-7212][23.04.2025]
        public List<APMActionPlanTask> GetTaskListByIdActionPlan_V2640(string connectionString, Int64 IdActionPlan, string selectedPeriod, Int32 idUser)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetTaskListByIdActionPlan_V2640", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }

                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }
                            if (rdr["IdOTItem"] != DBNull.Value)
                            {
                                task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                            }
                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                task.IdOT = Convert.ToInt64(rdr["IdOT"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.OTCode = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                            {
                                task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                            }
                            if (rdr["Participant"] != DBNull.Value)
                            {
                                string participantString = rdr["Participant"].ToString();
                                task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                            }
                            taskList.Add(task);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTaskListByIdActionPlan_V2640(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }
        //[shweta.thube][GEOS2-8072][19.05.2025]
        public DelayedTasks GetDelayedTasks_V2640(string connectionString, DateTime startDate, Int32 idCompany)
        {
            DelayedTasks task = new DelayedTasks();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetDelayedTaskList_V2640", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_StartDate", startDate);
                    mySqlCommand.Parameters.AddWithValue("_IdCompany", idCompany);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            if (rdr["OpenCurrentMonth"] != DBNull.Value)
                            {
                                task.OpenCurrentMonth = Convert.ToString(rdr["OpenCurrentMonth"]);
                            }
                            if (rdr["Open12Month"] != DBNull.Value)
                            {
                                task.Open12Month = Convert.ToString(rdr["Open12Month"]);
                            }
                            if (rdr["OverdueCurrentMonth"] != DBNull.Value)
                            {
                                task.OverdueCurrentMonth = Convert.ToString(rdr["OverdueCurrentMonth"]);
                            }
                            if (rdr["OverdueCurrentMonthHigh"] != DBNull.Value)
                            {
                                task.OverdueCurrentMonthHigh = Convert.ToString(rdr["OverdueCurrentMonthHigh"]);
                            }
                            if (rdr["OverdueCurrentMonthMedium"] != DBNull.Value)
                            {
                                task.OverdueCurrentMonthMedium = Convert.ToString(rdr["OverdueCurrentMonthMedium"]);
                            }
                            if (rdr["OverdueCurrentMonthLow"] != DBNull.Value)
                            {
                                task.OverdueCurrentMonthLow = Convert.ToString(rdr["OverdueCurrentMonthLow"]);
                            }
                            if (rdr["Overdue12Month"] != DBNull.Value)
                            {
                                task.Overdue12Month = Convert.ToString(rdr["Overdue12Month"]);
                            }
                            if (rdr["Overdue12MonthHigh"] != DBNull.Value)
                            {
                                task.Overdue12MonthHigh = Convert.ToString(rdr["Overdue12MonthHigh"]);
                            }
                            if (rdr["Overdue12MonthMedium"] != DBNull.Value)
                            {
                                task.Overdue12MonthMedium = Convert.ToString(rdr["Overdue12MonthMedium"]);
                            }
                            if (rdr["Overdue12MonthLow"] != DBNull.Value)
                            {
                                task.Overdue12MonthLow = Convert.ToString(rdr["Overdue12MonthLow"]);
                            }
                            if (rdr["OpenDaysCurrentMonth"] != DBNull.Value)
                            {
                                task.OpenDaysCurrentMonth = Convert.ToString(rdr["OpenDaysCurrentMonth"]);
                            }
                            if (rdr["OpenDays12Month"] != DBNull.Value)
                            {
                                task.OpenDays12Month = Convert.ToString(rdr["OpenDays12Month"]);
                            }
                            if (rdr["BlockedCurrentMonth"] != DBNull.Value)
                            {
                                task.BlockedCurrentMonth = Convert.ToString(rdr["BlockedCurrentMonth"]);
                            }
                            if (rdr["Blocked12Month"] != DBNull.Value)
                            {
                                task.Blocked12Month = Convert.ToString(rdr["Blocked12Month"]);
                            }
                            if (rdr["Total12Month"] != DBNull.Value)
                            {
                                task.Total12Month = Convert.ToString(rdr["Total12Month"]);
                            }
                            if (rdr["LastDays"] != DBNull.Value)
                            {
                                task.LastDays = Convert.ToString(rdr["LastDays"]);
                            }
                            if (rdr["OpenDays12Month"] != DBNull.Value)
                            {
                                task.Open12MonthCustomDays = Convert.ToString(rdr["OpenDays12Month"]);
                            }
                            if (rdr["ClosedCurrentMonth"] != DBNull.Value)
                            {
                                task.ClosedCurrentMonth = Convert.ToString(rdr["ClosedCurrentMonth"]);
                            }
                            if (rdr["Closed12Month"] != DBNull.Value)
                            {
                                task.Closed12Month = Convert.ToString(rdr["Closed12Month"]);
                            }
                            if (rdr["NewTasksCurrentMonth"] != DBNull.Value)
                            {
                                task.NewTasksCurrentMonth = Convert.ToString(rdr["NewTasksCurrentMonth"]);
                            }
                            if (rdr["NewTasksCurrentMonthHigh"] != DBNull.Value)
                            {
                                task.NewTasksCurrentMonthHigh = Convert.ToString(rdr["NewTasksCurrentMonthHigh"]);
                            }
                            if (rdr["NewTasksCurrentMonthMedium"] != DBNull.Value)
                            {
                                task.NewTasksCurrentMonthMedium = Convert.ToString(rdr["NewTasksCurrentMonthMedium"]);
                            }
                            if (rdr["NewTasksCurrentMonthLow"] != DBNull.Value)
                            {
                                task.NewTasksCurrentMonthLow = Convert.ToString(rdr["NewTasksCurrentMonthLow"]);
                            }
                        }
                    }
                    con.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetDelayedTasks_V2640(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return task;
        }
        //[shweta.thube][GEOS2-8051][15/05/2025]
        public List<APMActionPlanTask> GetTopFiveDelayedTaks_V2640(string connectionString, DateTime startDate, Int32 idCompany)
        {
            List<APMActionPlanTask> delayedTaksList = new List<APMActionPlanTask>();

            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {

                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_GetTopFiveDelayedTaks_V2640", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_startDate", startDate);
                        mySqlCommand.Parameters.AddWithValue("_IdCompany", idCompany);


                        using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                try
                                {
                                    APMActionPlanTask aPMActionPlanTask = new APMActionPlanTask();

                                    if (reader["Code"] != DBNull.Value)
                                    {
                                        aPMActionPlanTask.Code = Convert.ToString(reader["Code"]);
                                    }
                                    if (reader["Title"] != DBNull.Value)
                                    {
                                        aPMActionPlanTask.Title = Convert.ToString(reader["Title"]);
                                    }
                                    if (reader["TaskNumber"] != DBNull.Value)
                                    {
                                        aPMActionPlanTask.TaskNumber = Convert.ToInt32(reader["TaskNumber"]);
                                    }

                                    if (reader["Priority"] != DBNull.Value)
                                    {
                                        aPMActionPlanTask.Priority = Convert.ToString(reader["Priority"]);
                                    }

                                    if (reader["Status"] != DBNull.Value)
                                    {
                                        aPMActionPlanTask.Status = Convert.ToString(reader["Status"]);
                                    }
                                    if (reader["StatusHTMLColor"] != DBNull.Value)
                                    {
                                        aPMActionPlanTask.StatusHTMLColor = Convert.ToString(reader["StatusHTMLColor"]);
                                    }
                                    if (reader["DueDate"] != DBNull.Value)
                                    {
                                        aPMActionPlanTask.DueDate = Convert.ToDateTime(reader["DueDate"]);
                                    }
                                    if (reader["DueDate"] != DBNull.Value)
                                    {
                                        aPMActionPlanTask.Responsible = Convert.ToString(reader["Responsible"]);
                                    }
                                    if (reader["PriorityHTMLColor"] != DBNull.Value)
                                    {
                                        aPMActionPlanTask.PriorityHTMLColor = Convert.ToString(reader["PriorityHTMLColor"]);
                                    }
                                    delayedTaksList.Add(aPMActionPlanTask);
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetTopFiveDelayedTaks_V2640(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                                }
                            }
                        }

                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                }

                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();



                    Log4NetLogger.Logger.Log(string.Format("Error GetTopFiveDelayedTaks_V2640(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    throw;
                }
                return delayedTaksList;
            }
        }
        //[shweta.thube][GEOS2-8061]
        public bool UpdateManualAttachmentSetting_V2640(string connectionString, APMActionPlanTask apmActionPlanTask)
        {
            bool isUpdated = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateManualAttachmentSetting_V2650", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdAppSetting", apmActionPlanTask.IdAppSetting);
                        mySqlCommand.Parameters.AddWithValue("_DefaultValue", apmActionPlanTask.SettingInUse);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();

                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isUpdated = true;
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateManualAttachmentSetting_V2640(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }
        //[shweta.thube][GEOS2-8061]
        public APMActionPlanTask GetManualAttachmentSetting(string connectionString, Int32 idAppSetting)
        {
            APMActionPlanTask setting = new APMActionPlanTask();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetManualAttachmentSetting_V2650", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdAppSetting", idAppSetting);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            if (rdr["DefaultValue"] != DBNull.Value)
                            {
                                setting.SettingInUse = Convert.ToByte(rdr["DefaultValue"]);
                            }
                            if (rdr["IdAppSetting"] != DBNull.Value)
                            {
                                setting.IdAppSetting = Convert.ToInt32(rdr["IdAppSetting"]);
                            }

                        }
                    }
                    con.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetManualAttachmentSetting(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return setting;
        }

        //[shweta.thube][GEOS2-8063][27/05/2025]
        public List<APMActionPlanTask> GetResponsibleListForEmailNotification_V2650(string connectionString, Int64 IdActionPlan, string selectedPeriod, Int32 idUser)
        {
            List<APMActionPlanTask> responsibleListForEmailNotification = new List<APMActionPlanTask>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetResponsibleListForEmailNotification_V2650", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                APMActionPlanTask responsible = new APMActionPlanTask();

                                if (rdr["EmployeeName"] != DBNull.Value)
                                {
                                    responsible.Responsible = Convert.ToString(rdr["EmployeeName"]);
                                }
                                if (rdr["OpenTaskCount"] != DBNull.Value)
                                {
                                    responsible.OpenTaskCount = Convert.ToString(rdr["OpenTaskCount"]);
                                    responsible.ResponsibleWithTaskCount = $"{responsible.Responsible} - [{responsible.OpenTaskCount} Task{(responsible.OpenTaskCount == "1" ? "" : "s")}]";
                                }
                                if (rdr["IdResponsibleEmployee"] != DBNull.Value)
                                {
                                    responsible.IdEmployee = Convert.ToInt32(rdr["IdResponsibleEmployee"]);
                                }
                                responsibleListForEmailNotification.Add(responsible);
                            }
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdResponsibleEmployee"] != DBNull.Value)
                                {
                                    APMActionPlanTask responsible = responsibleListForEmailNotification.FirstOrDefault(x => x.IdEmployee == Convert.ToInt32(rdr["IdEmployee"]));
                                    if (responsible != null)
                                    {
                                        if (responsible.EmailTaskDetailsList == null)
                                        {
                                            responsible.EmailTaskDetailsList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);
                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            task.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["ActionPlanCode"] != DBNull.Value)
                                        {
                                            task.Code = Convert.ToString(rdr["ActionPlanCode"]);
                                        }
                                        if (rdr["PriorityHTMLColor"] != DBNull.Value)
                                        {
                                            task.PriorityHTMLColor = Convert.ToString(rdr["PriorityHTMLColor"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        responsible.EmailTaskDetailsList.Add(task);
                                    }
                                }

                            }

                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetResponsibleListForEmailNotification_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return responsibleListForEmailNotification;
        }
        //[shweta.thube][GEOS2-8066]
        public APMActionPlanTask GetCCPersonMail_V2650(string connectionString, Int64 ccPersonEmailID)
        {
            APMActionPlanTask email = new APMActionPlanTask();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetCCPersonMail_V2650", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", ccPersonEmailID);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                email.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["EmployeeContactValue"] != DBNull.Value)
                            {
                                email.EmployeeContactValue = Convert.ToString(rdr["EmployeeContactValue"]);
                            }
                            if (rdr["IdEmployeeContact"] != DBNull.Value)
                            {
                                email.IdEmployeeContact = Convert.ToInt32(rdr["IdEmployeeContact"]);
                            }

                        }
                    }
                    con.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetCCPersonMail_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return email;
        }
        //[shweta.thube][GEOS2-8066]
        public APMActionPlanTask GetToPersonMail_V2650(string connectionString, Int64 toPersonEmailID)
        {
            APMActionPlanTask email = new APMActionPlanTask();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetToPersonMail_V2650", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", toPersonEmailID);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                email.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["EmployeeContactValue"] != DBNull.Value)
                            {
                                email.EmployeeContactValue = Convert.ToString(rdr["EmployeeContactValue"]);
                            }
                            if (rdr["IdEmployeeContact"] != DBNull.Value)
                            {
                                email.IdEmployeeContact = Convert.ToInt32(rdr["IdEmployeeContact"]);
                            }

                        }
                    }
                    con.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetToPersonMail_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return email;
        }

        //[shweta.thube][GEOS2-7241][27/05/2025]
        public List<VisibilityPerBU> GetEmployeeListWithBU_V2650(string connectionString, Int32 IdCompanies)
        {
            List<VisibilityPerBU> employeeList = new List<VisibilityPerBU>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetEmployeesByBusinessUnit_V2650", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_Plant", IdCompanies);
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        if (rdr.NextResult())
                            while (rdr.Read())
                            {
                                VisibilityPerBU visibilityPerBU = new VisibilityPerBU();
                                if (rdr["IdEmployee"] != DBNull.Value)
                                {
                                    visibilityPerBU.IdEmployee = Convert.ToUInt32(rdr["IdEmployee"]);
                                }
                                if (rdr["EmployeeCode"] != DBNull.Value)
                                {
                                    visibilityPerBU.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                    visibilityPerBU.ProfileImagePath = "https://api.emdep.com/GEOS/Images.aspx?FilePath=/Images/Employees/" + visibilityPerBU.EmployeeCode + ".png";
                                }
                                if (rdr["Name"] != DBNull.Value)
                                {
                                    visibilityPerBU.FullName = Convert.ToString(rdr["Name"]);
                                }
                                if (rdr["IdsCompany"] != DBNull.Value)
                                {
                                    visibilityPerBU.IdOrganizationCode = Convert.ToInt32(rdr["IdsCompany"]);
                                }
                                if (rdr["IdGender"] != DBNull.Value)
                                {
                                    visibilityPerBU.IdGender = Convert.ToUInt32(rdr["IdGender"]);

                                    visibilityPerBU.Gender = new LookupValue();
                                    visibilityPerBU.Gender.IdLookupValue = Convert.ToInt32(visibilityPerBU.IdGender);
                                    visibilityPerBU.Gender.Value = Convert.ToString(rdr["Gender"]);
                                }
                                if (rdr["Organizations"] != DBNull.Value)
                                {
                                    List<string> tempDifferentJobComp = Convert.ToString(rdr["Organizations"]).Split(',').ToList<string>();
                                    tempDifferentJobComp = tempDifferentJobComp.Distinct().ToList();
                                    visibilityPerBU.Organization = string.Join("\n", tempDifferentJobComp.Select(x => x.Trim()).ToArray());
                                }
                                if (rdr["Scope"] != DBNull.Value)
                                {
                                    //visibilityPerBU.JDScope = Convert.ToString(rdr["Scope"]);
                                    List<string> tempDifferentJDScope = Convert.ToString(rdr["Scope"]).Split(',').ToList<string>();
                                    tempDifferentJDScope = tempDifferentJDScope.Distinct().ToList();
                                    visibilityPerBU.JDScope = string.Join("\n", tempDifferentJDScope.Select(x => x.Trim()).ToArray());
                                }
                                if (rdr["JobDescriptions"] != DBNull.Value)
                                {
                                    //List<string> tempDifferentJobDesc = Convert.ToString(rdr["JobDescriptions"]).Split(',').ToList<string>();
                                    //tempDifferentJobDesc = tempDifferentJobDesc.Distinct().ToList();
                                    visibilityPerBU.JobDescription = Convert.ToString(rdr["JobCodes"]);
                                }
                                if (rdr["idActionPlanBuAccess"] != DBNull.Value)
                                {
                                    List<string> tempDifferentIdsActionPlanBuAccess = Convert.ToString(rdr["idActionPlanBuAccess"]).Split(',').ToList<string>();
                                    tempDifferentIdsActionPlanBuAccess = tempDifferentIdsActionPlanBuAccess.Distinct().ToList();
                                    visibilityPerBU.IdsActionPlanBuAccess = string.Join("\n", tempDifferentIdsActionPlanBuAccess.Select(x => x.Trim()).ToArray());
                                }
                                if (rdr["BusinessUnits"] != DBNull.Value)
                                {
                                    List<string> tempDifferentJobDesc = Convert.ToString(rdr["BusinessUnits"]).Split(',').ToList<string>();
                                    tempDifferentJobDesc = tempDifferentJobDesc.Distinct().ToList();
                                    visibilityPerBU.BusinessUnits = string.Join("\n", tempDifferentJobDesc.Select(x => x.Trim()).ToArray());
                                }
                                if (rdr["JobDescriptionCode"] != DBNull.Value)
                                {
                                    visibilityPerBU.JobCode = Convert.ToString(rdr["JobDescriptionCode"]);
                                }
                                if (rdr["NativeName"] != DBNull.Value)
                                {
                                    visibilityPerBU.NativeName = Convert.ToString(rdr["NativeName"]);
                                }
                                if (rdr["JobDescriptionTitle"] != DBNull.Value)
                                {
                                    visibilityPerBU.FinalJobDescription = Convert.ToString(rdr["JobDescriptionTitle"]);
                                }
                                if (rdr["IdJobDescription"] != DBNull.Value)
                                {
                                    visibilityPerBU.IdJobDescription = Convert.ToInt32(rdr["IdJobDescription"]);
                                }
                                if (rdr["CompanyEmails"] != DBNull.Value)
                                {
                                    visibilityPerBU.EmployeeContactCompanyEmailList = Convert.ToString(rdr["CompanyEmails"]).Split('\n').ToList<string>();
                                    if (visibilityPerBU.EmployeeContactCompanyEmailList != null && visibilityPerBU.EmployeeContactCompanyEmailList.Count > 0)
                                    {
                                        visibilityPerBU.EmployeeContactEmail = visibilityPerBU.EmployeeContactCompanyEmailList.First();
                                    }
                                }
                                if (rdr["CompanyMobiles"] != DBNull.Value)
                                {
                                    visibilityPerBU.EmployeeContactCompanyMobiles = Convert.ToString(rdr["CompanyMobiles"]);
                                    visibilityPerBU.EmployeeContactCompanyMobileList = Convert.ToString(rdr["CompanyMobiles"]).Split('\n').ToList<string>();
                                    if (visibilityPerBU.EmployeeContactCompanyMobileList != null && visibilityPerBU.EmployeeContactCompanyMobileList.Count > 0)
                                    {
                                        visibilityPerBU.EmployeeContactMobile = visibilityPerBU.EmployeeContactCompanyMobileList.First();
                                    }
                                }
                                if (rdr["LengthOfService"] != DBNull.Value)
                                {
                                    visibilityPerBU.LengthOfService = Convert.ToString(rdr["LengthOfService"]);
                                }
                                if (rdr["ContractSituation"] != DBNull.Value)
                                {
                                    visibilityPerBU.ContractSituation = Convert.ToString(rdr["ContractSituation"]);
                                }
                                if (rdr["HireDate"] != DBNull.Value)
                                {
                                    visibilityPerBU.ContractSituationStartDate = Convert.ToDateTime(rdr["HireDate"]);
                                }
                                if (rdr["JobTitlesWithCompanyAlias"] != DBNull.Value)
                                {
                                    visibilityPerBU.EmployeeJobTitles = Convert.ToString(rdr["JobTitlesWithCompanyAlias"]);
                                    List<String> result = new List<String>(visibilityPerBU.EmployeeJobTitles.Split(new string[] { "\n" }, StringSplitOptions.None));
                                    if (result.Count() > 1)
                                    {
                                        string matchString = null;
                                        bool isDiffPlant = false;
                                        matchString = result[0].Substring(result[0].IndexOf("[") + 1, ((result[0].IndexOf("]")) - (result[0].IndexOf("[") + 1)));
                                        if (string.IsNullOrEmpty(matchString))
                                        {
                                            isDiffPlant = false;
                                        }
                                        else
                                        {
                                            matchString = " [" + matchString + "]";
                                            foreach (string item in result)
                                            {
                                                if (!item.Contains(matchString))
                                                {
                                                    isDiffPlant = true;
                                                    break;
                                                }
                                            }
                                        }
                                        if (isDiffPlant == false)
                                        {
                                            visibilityPerBU.EmployeeJobTitles = Convert.ToString(rdr["JobTitles"]);
                                        }
                                    }
                                    else if (result.Count() == 1)
                                    {
                                        visibilityPerBU.EmployeeJobTitles = Convert.ToString(rdr["JobTitles"]);
                                    }
                                }
                                if (rdr["JobCodes"] != DBNull.Value)
                                {
                                    visibilityPerBU.EmpJobCodes = Convert.ToString(rdr["JobCodes"]);
                                    visibilityPerBU.EmployeeJobCodes = Convert.ToString(rdr["JobCodes"]).Split('\n').ToList<string>();
                                }
                                employeeList.Add(visibilityPerBU);
                            }
                        if (rdr.NextResult())
                            while (rdr.Read())
                            {
                                try
                                {
                                    if (rdr["IdEmployee"] != DBNull.Value)
                                    {
                                        VisibilityPerBU vb = employeeList.Where(i => i.IdEmployee == Convert.ToInt32(rdr["IdEmployee"])).FirstOrDefault();
                                        if (vb != null)
                                        {
                                            if (vb.EmployeeContractSituations == null)
                                            {
                                                vb.EmployeeContractSituations = new List<EmployeeContractSituation>();
                                            }
                                            EmployeeContractSituation employeeContractSituation = new EmployeeContractSituation();
                                            if (rdr["IdEmployee"] != DBNull.Value)
                                                employeeContractSituation.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                            if (rdr["IdContractSituation"] != DBNull.Value)
                                                employeeContractSituation.IdContractSituation = Convert.ToUInt16(rdr["IdContractSituation"]);
                                            if (rdr["ContractSituationFileName"] != DBNull.Value)
                                                employeeContractSituation.ContractSituationFileName = Convert.ToString(rdr["ContractSituationFileName"]);
                                            if (rdr["IdEmployeeContractSituation"] != DBNull.Value)
                                                employeeContractSituation.IdEmployeeContractSituation = Convert.ToUInt64(rdr["IdEmployeeContractSituation"]);
                                            if (rdr["ContractSituationEndDate"] != DBNull.Value)
                                                employeeContractSituation.ContractSituationEndDate = Convert.ToDateTime(rdr["ContractSituationEndDate"]);
                                            if (rdr["ContractSituationRemarks"] != DBNull.Value)
                                                employeeContractSituation.ContractSituationRemarks = Convert.ToString(rdr["ContractSituationRemarks"]);
                                            if (rdr["ContractSituationStartDate"] != DBNull.Value)
                                                employeeContractSituation.ContractSituationStartDate = Convert.ToDateTime(rdr["ContractSituationStartDate"]);
                                            if (rdr["IdProfessionalCategory"] != DBNull.Value)
                                                employeeContractSituation.IdProfessionalCategory = Convert.ToUInt16(rdr["IdProfessionalCategory"]);
                                            if (rdr["IdEmployeeExitEvent"] != DBNull.Value)
                                                employeeContractSituation.IdEmployeeExitEvent = Convert.ToUInt16(rdr["IdEmployeeExitEvent"]);
                                            vb.EmployeeContractSituations.Add(employeeContractSituation);
                                        }
                                    }
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetEmployeeListWithBU_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                    throw;
                                }
                            }

                        if (rdr.NextResult())
                            while (rdr.Read())
                            {
                                try
                                {
                                    if (rdr["IdEmployee"] != DBNull.Value)
                                    {
                                        VisibilityPerBU vb = employeeList.Where(i => i.IdEmployee == Convert.ToInt32(rdr["IdEmployee"])).FirstOrDefault();
                                        if (vb != null)
                                        {
                                            if (vb.EmployeeExitEvents == null)
                                            {
                                                vb.EmployeeExitEvents = new List<EmployeeExitEvent>();
                                            }
                                            EmployeeExitEvent employeeExitEvent = new EmployeeExitEvent();
                                            if (rdr["IdEmployeeExitEvent"] != DBNull.Value)
                                            {
                                                employeeExitEvent.IdEmployeeExitEvent = Convert.ToInt64(rdr["IdEmployeeExitEvent"]);
                                                employeeExitEvent.IsExist = true;
                                            }
                                            if (rdr["ExitDate"] != DBNull.Value)
                                                employeeExitEvent.ExitDate = Convert.ToDateTime(rdr["ExitDate"]);
                                            if (rdr["IdExitEvent"] != DBNull.Value)
                                            {
                                                employeeExitEvent.IdExitEvent = Convert.ToByte(rdr["IdExitEvent"]);
                                            }
                                            if (rdr["IdEmployee"] != DBNull.Value)
                                                employeeExitEvent.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                            if (rdr["IdReason"] != DBNull.Value)
                                            {
                                                employeeExitEvent.IdReason = Convert.ToInt32(rdr["IdReason"]);
                                                employeeExitEvent.ExitReason = new LookupValue();
                                                employeeExitEvent.ExitReason.IdLookupValue = employeeExitEvent.IdReason;
                                                employeeExitEvent.ExitReason.Value = Convert.ToString(rdr["Reason"]);
                                            }
                                            if (rdr["Remarks"] != DBNull.Value)
                                                employeeExitEvent.Remarks = Convert.ToString(rdr["Remarks"]);
                                            if (rdr["FileName"] != DBNull.Value)
                                            {
                                                employeeExitEvent.FileName = Convert.ToString(rdr["FileName"]);
                                                //employeeExitEvent.ExitEventBytes = GetEmployeesExitDocument(employeeCode, employeeExitEvent, exitDocumnetFilePath);
                                            }
                                            vb.EmployeeExitEvents.Add(employeeExitEvent);
                                        }
                                    }
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetEmployeeListWithBU_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                    throw;
                                }
                            }

                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetEmployeeListWithBU_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return employeeList;
        }
        //[shweta.thube][GEOS2-8069]
        public APMActionPlan GetActionPlanInfo_V2650(string connectionString, Int64 IdActionPlan)
        {
            APMActionPlan actionPlan = new APMActionPlan();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanInfo_V2650", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {

                            if (rdr["ActionPlanCode"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["ActionPlanCode"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["BusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                actionPlan.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["ActionPlanResponsibleDisplayName"] != DBNull.Value)
                            {
                                actionPlan.ActionPlanResponsibleDisplayName = Convert.ToString(rdr["ActionPlanResponsibleDisplayName"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                actionPlan.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                actionPlan.Group = Convert.ToString(rdr["CustomerName"]);
                            }
                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                actionPlan.Site = Convert.ToString(rdr["SiteName"]);
                                actionPlan.GroupName = actionPlan.Group + " " + "(" + actionPlan.Site + ")";
                            }
                            if (rdr["Department"] != DBNull.Value)
                            {
                                actionPlan.Department = Convert.ToString(rdr["Department"]);
                            }
                        }
                    }
                    con.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanInfo_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlan;
        }

        //[Pallavi.Kale][GEOS2-8216][19/06/2025]
        public bool ValidateCustomerBySites(string connectionString, Int32 CustomerId)
        {
            bool isValid = false;

            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_ImportedCustomersValidForRegion_V2650", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_CustomerId", CustomerId);

                        using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                        {
                            if (reader.Read())
                            {
                                isValid = reader["IsValid"] != DBNull.Value && Convert.ToBoolean(reader["IsValid"]);
                            }
                        }

                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error ValidateCustomerBySites(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return isValid;
        }


        //[pallavi.kale][GEOS2-7002][19.06.2025]
        public List<APMActionPlan> GetActionPlanDetails_V2650(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlan> actionPlanList = new List<APMActionPlan>();
            List<APMActionPlanTask> actionPlanTaskList = new List<APMActionPlanTask>();
            List<string> countryISOs = new List<string>();

            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_V2650", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlan actionPlan = new APMActionPlan();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.Country.Iso + ".png";
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                actionPlan.ResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.IdLookupBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                            }
                            if (rdr["BusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }
                            if (rdr["BusinessUnitHtmlColor"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHtmlColor"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                actionPlan.CreatedBy = Convert.ToInt16(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                actionPlan.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                actionPlan.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["IdDepartment"] != DBNull.Value)
                            {
                                actionPlan.IdDepartment = Convert.ToInt32(rdr["IdDepartment"]);
                                actionPlan.Department = Convert.ToString(rdr["Department"]);
                            }
                            if (rdr["OriginDescription"] != DBNull.Value)
                            {
                                actionPlan.OriginDescription = Convert.ToString(rdr["OriginDescription"]);
                            }
                            if (rdr["ActionPlanResponsibleDisplayName"] != DBNull.Value)
                            {
                                actionPlan.ActionPlanResponsibleDisplayName = Convert.ToString(rdr["ActionPlanResponsibleDisplayName"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                actionPlan.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                actionPlan.Group = Convert.ToString(rdr["CustomerName"]);
                            }

                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                actionPlan.Site = Convert.ToString(rdr["SiteName"]);
                                actionPlan.GroupName = actionPlan.Group + " " + "(" + actionPlan.Site + ")";
                            }
                            if (rdr["IdZone"] != DBNull.Value)
                            {
                                actionPlan.IdZone = Convert.ToInt32(rdr["IdZone"]);
                            }
                            if (rdr["Region"] != DBNull.Value)
                            {
                                actionPlan.Zone = Convert.ToString(rdr["Region"]);
                            }
                            actionPlanList.Add(actionPlan);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdActionPlan"] != DBNull.Value)
                                {
                                    APMActionPlan actionPlanTask = actionPlanList.FirstOrDefault(x => x.IdActionPlan == Convert.ToInt32(rdr["IdActionPlan"]));
                                    if (actionPlanTask != null)
                                    {
                                        if (actionPlanTask.TaskList == null)
                                        {
                                            actionPlanTask.TaskList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);
                                        if (rdr["IdActionPlan"] != DBNull.Value)
                                        {
                                            task.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                                        }
                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }

                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            task.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            task.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (task.DueDate != task.OriginalDueDate)
                                        {
                                            task.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            task.IsShowIcon = false;
                                        }
                                        task.Code = actionPlanTask.Code;
                                        task.ActionPlanDescription = actionPlanTask.Description;
                                        task.TaskOrigin = actionPlanTask.Origin;
                                        task.BusinessUnit = actionPlanTask.BusinessUnit;
                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            task.Country = new Country();
                                            task.Country.Name = Convert.ToString(rdr["Country"]);
                                            task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["NumItem"] != DBNull.Value)
                                        {
                                            task.NumItem = Convert.ToString(rdr["NumItem"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            task.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            task.IdOT = Convert.ToInt32(rdr["IdOT"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        actionPlanTask.TaskList.Add(task);
                                    }
                                }
                            }
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdParent"] != DBNull.Value)
                                {

                                    long parentId = Convert.ToInt64(rdr["IdParent"]);

                                    APMActionPlanTask actionPlanSubTask = actionPlanList
                                        .SelectMany(ap => ap.TaskList ?? new List<APMActionPlanTask>())
                                        .FirstOrDefault(t => t.IdActionPlanTask == parentId);
                                    if (actionPlanSubTask != null)
                                    {
                                        if (actionPlanSubTask.SubTaskList == null)
                                        {
                                            actionPlanSubTask.SubTaskList = new List<APMActionPlanSubTask>();
                                        }
                                        APMActionPlanSubTask subTask = new APMActionPlanSubTask();


                                        if (rdr["IdActionPlan"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                                        }
                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            subTask.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["ParentTaskNumber"] != DBNull.Value)
                                        {
                                            subTask.ParentTaskNumber = Convert.ToInt64(rdr["ParentTaskNumber"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.SubTaskNumber = Convert.ToInt64(rdr["TaskNumber"]);
                                            subTask.SubTaskCode = subTask.ParentTaskNumber + "." + subTask.SubTaskNumber;
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            subTask.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            subTask.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            subTask.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            subTask.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            subTask.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            subTask.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            subTask.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            subTask.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            subTask.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            subTask.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            subTask.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            subTask.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            subTask.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            subTask.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            subTask.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo = new Responsible();
                                            subTask.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            subTask.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            subTask.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            subTask.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            subTask.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            subTask.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            subTask.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            subTask.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            subTask.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            subTask.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            subTask.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            subTask.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            subTask.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            subTask.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            subTask.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            subTask.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            subTask.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            subTask.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            subTask.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            subTask.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            subTask.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (subTask.DueDate != subTask.OriginalDueDate)
                                        {
                                            subTask.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            subTask.IsShowIcon = false;
                                        }
                                        subTask.Code = actionPlanSubTask.Code;
                                        subTask.ActionPlanDescription = actionPlanSubTask.Description;
                                        subTask.TaskOrigin = actionPlanSubTask.Origin;
                                        subTask.BusinessUnit = actionPlanSubTask.BusinessUnit;
                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            subTask.Country = new Country();
                                            subTask.Country.Name = Convert.ToString(rdr["Country"]);
                                            subTask.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            subTask.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + subTask.Country.Iso + ".png";
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            subTask.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["NumItem"] != DBNull.Value)
                                        {
                                            subTask.NumItem = Convert.ToString(rdr["NumItem"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            subTask.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            subTask.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            subTask.IdOT = Convert.ToInt32(rdr["IdOT"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            subTask.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        actionPlanSubTask.SubTaskList.Add(subTask);

                                    }
                                }
                            }
                        }
                    }
                }


                foreach (var item in actionPlanList)
                {
                    if (item.TotalActionItems != 0)
                    {
                        item.Percentage = (int)(((float)item.TotalClosedItems / item.TotalActionItems) * 100);
                    }
                    else
                    {
                        item.Percentage = 0;
                    }

                    if (item.Percentage <= 24)
                    {
                        item.TotalClosedColor = "Red";
                    }
                    else if (item.Percentage >= 25 && item.Percentage <= 49)
                    {
                        item.TotalClosedColor = "Orange";
                    }
                    else if (item.Percentage >= 50 && item.Percentage <= 74)
                    {
                        item.TotalClosedColor = "Yellow";
                    }
                    else if (item.Percentage >= 75 && item.Percentage <= 99)
                    {
                        item.TotalClosedColor = "LightGreen";
                    }
                    else if (item.Percentage == 100)
                    {
                        item.TotalClosedColor = "Green";
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanList;
        }

        //[pallavi.kale][GEOS2-7002][19.06.2025]
        public List<APMActionPlanTask> GetActionPlanTaskDetails_V2650(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanTaskDetails_V2650", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                task.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["ActionDescription"] != DBNull.Value)
                            {
                                task.ActionPlanDescription = Convert.ToString(rdr["ActionDescription"]);
                            }
                            if (rdr["IdOrigin"] != DBNull.Value)
                            {
                                task.IdOrigin = Convert.ToInt32(rdr["IdOrigin"]);
                                task.TaskOrigin = Convert.ToString(rdr["TaskOrigin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                task.IdBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                                task.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                            {
                                task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                            }
                            if (rdr["DelegatedDisplayName"] != DBNull.Value)
                            {
                                task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                            }


                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }

                            if (rdr["Country"] != DBNull.Value)
                            {
                                task.Country = new Country();
                                task.Country.Name = Convert.ToString(rdr["Country"]);
                                task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                task.ActionPlanResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }

                            if (rdr["IdOTItem"] != DBNull.Value)
                            {
                                task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                            }
                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                task.IdOT = Convert.ToInt64(rdr["IdOT"]);
                            }
                            if (rdr["OTCode"] != DBNull.Value)
                            {
                                task.OTCode = Convert.ToString(rdr["OTCode"]);
                            }
                            if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                            {
                                task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                            }
                            if (rdr["Participant"] != DBNull.Value)
                            {
                                string participantString = rdr["Participant"].ToString();
                                task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                task.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["IdParent"] != DBNull.Value)
                            {
                                task.IdParent = Convert.ToInt64(rdr["IdParent"]);
                            }

                            taskList.Add(task);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdParent"] != DBNull.Value)
                                {
                                    APMActionPlanTask actionPlanSubTask = taskList.FirstOrDefault(x => x.IdActionPlanTask == Convert.ToInt64(rdr["IdParent"]));

                                    if (actionPlanSubTask != null)
                                    {
                                        if (actionPlanSubTask.SubTaskList == null)
                                        {
                                            actionPlanSubTask.SubTaskList = new List<APMActionPlanSubTask>();
                                        }

                                        APMActionPlanSubTask subTask = new APMActionPlanSubTask();

                                        if (rdr["IdActionPlan"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            subTask.Code = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["ActionDescription"] != DBNull.Value)
                                        {
                                            subTask.ActionPlanDescription = Convert.ToString(rdr["ActionDescription"]);
                                        }
                                        if (rdr["IdOrigin"] != DBNull.Value)
                                        {
                                            subTask.IdOrigin = Convert.ToInt32(rdr["IdOrigin"]);
                                            subTask.TaskOrigin = Convert.ToString(rdr["TaskOrigin"]);
                                        }
                                        if (rdr["IdBusinessUnit"] != DBNull.Value)
                                        {
                                            subTask.IdBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                                            subTask.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                                        }

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            subTask.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            subTask.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            subTask.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            subTask.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            subTask.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            subTask.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            subTask.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            subTask.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            subTask.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            subTask.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            subTask.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            subTask.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            subTask.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            subTask.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            subTask.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo = new Responsible();
                                            subTask.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            subTask.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            subTask.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            subTask.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            subTask.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            subTask.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            subTask.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            subTask.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            subTask.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            subTask.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            subTask.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            subTask.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            subTask.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            subTask.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            subTask.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            subTask.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            subTask.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            subTask.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            subTask.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            subTask.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            subTask.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (subTask.DueDate != subTask.OriginalDueDate)
                                        {
                                            subTask.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            subTask.IsShowIcon = false;
                                        }

                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            subTask.Country = new Country();
                                            subTask.Country.Name = Convert.ToString(rdr["Country"]);
                                            subTask.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            subTask.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + subTask.Country.Iso + ".png";
                                        }
                                        if (rdr["IdUser"] != DBNull.Value)
                                        {
                                            subTask.ActionPlanResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                                        }

                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            subTask.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            subTask.IdOT = Convert.ToInt64(rdr["IdOT"]);
                                        }
                                        if (rdr["OTCode"] != DBNull.Value)
                                        {
                                            subTask.OTCode = Convert.ToString(rdr["OTCode"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            subTask.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            subTask.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;
                                        }
                                        if (rdr["FirstName"] != DBNull.Value)
                                        {
                                            subTask.FirstName = Convert.ToString(rdr["FirstName"]);
                                        }
                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            subTask.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["ParentTaskNumber"] != DBNull.Value)
                                        {
                                            subTask.ParentTaskNumber = Convert.ToInt64(rdr["ParentTaskNumber"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.SubTaskNumber = Convert.ToInt64(rdr["TaskNumber"]);
                                            subTask.SubTaskCode = subTask.ParentTaskNumber + "." + subTask.SubTaskNumber;
                                        }
                                        actionPlanSubTask.SubTaskList.Add(subTask);
                                    }
                                }
                            }


                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanTaskDetails_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }

        //[pallavi.kale][GEOS2-7002][19.06.2025]
        public List<APMActionPlanTask> GetTaskListByIdActionPlan_V2650(string connectionString, Int64 IdActionPlan, string selectedPeriod, Int32 idUser)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetTaskListByIdActionPlan_V2650", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }

                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }
                            if (rdr["IdOTItem"] != DBNull.Value)
                            {
                                task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                            }
                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                task.IdOT = Convert.ToInt64(rdr["IdOT"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.OTCode = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                            {
                                task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                            }
                            if (rdr["Participant"] != DBNull.Value)
                            {
                                string participantString = rdr["Participant"].ToString();
                                task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                            }
                            if (rdr["IdParent"] != DBNull.Value)
                            {
                                task.IdParent = Convert.ToInt64(rdr["IdParent"]);
                            }
                            taskList.Add(task);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdParent"] != DBNull.Value)
                                {
                                    APMActionPlanTask actionPlanSubTask = taskList.FirstOrDefault(x => x.IdActionPlanTask == Convert.ToInt64(rdr["IdParent"]));

                                    if (actionPlanSubTask != null)
                                    {
                                        if (actionPlanSubTask.SubTaskList == null)
                                        {
                                            actionPlanSubTask.SubTaskList = new List<APMActionPlanSubTask>();
                                        }

                                        APMActionPlanSubTask subTask = new APMActionPlanSubTask();
                                        subTask.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            subTask.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            subTask.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            subTask.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            subTask.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            subTask.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            subTask.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            subTask.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            subTask.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            subTask.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            subTask.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            subTask.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            subTask.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            subTask.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            subTask.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            subTask.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo = new Responsible();
                                            subTask.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            subTask.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            subTask.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            subTask.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            subTask.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            subTask.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            subTask.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            subTask.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            subTask.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            subTask.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            subTask.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            subTask.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            subTask.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            subTask.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            subTask.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            subTask.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            subTask.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            subTask.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            subTask.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }

                                        if (subTask.DueDate != subTask.OriginalDueDate)
                                        {
                                            subTask.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            subTask.IsShowIcon = false;
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            subTask.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            subTask.IdOT = Convert.ToInt64(rdr["IdOT"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            subTask.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            subTask.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            subTask.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            subTask.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["ParentTaskNumber"] != DBNull.Value)
                                        {
                                            subTask.ParentTaskNumber = Convert.ToInt64(rdr["ParentTaskNumber"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.SubTaskNumber = Convert.ToInt64(rdr["TaskNumber"]);
                                            subTask.SubTaskCode = subTask.ParentTaskNumber + "." + subTask.SubTaskNumber;
                                        }
                                        actionPlanSubTask.SubTaskList.Add(subTask);
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTaskListByIdActionPlan_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }
        //[shweta.thube][GEOS2-7004][25.06.2025]
        public List<CommentsByTask> GetSubTaskCommentsByIdSubTask_V2650(string connectionString, Int64 idTask)
        {
            List<CommentsByTask> commentsList = new List<CommentsByTask>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetSubTaskCommentsByIdTask_V2650", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdTask", idTask);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            CommentsByTask comments = new CommentsByTask();

                            if (rdr["IdActionPlanTaskComment"] != DBNull.Value)
                            {
                                comments.IdActionPlanTaskComment = Convert.ToInt64(rdr["IdActionPlanTaskComment"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                comments.IdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                comments.IdTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["IdPerson"] != DBNull.Value)
                            {
                                comments.People = new People();
                                comments.People.IdPerson = Convert.ToInt32(rdr["IdPerson"]);
                                comments.People.Name = rdr["Name"].ToString();
                                comments.People.Surname = rdr["Surname"].ToString();
                                if (rdr["Login"] != DBNull.Value)
                                {
                                    comments.People.Login = Convert.ToString(rdr["Login"]);
                                }

                                if (rdr["IdUserGender"] != DBNull.Value)
                                {
                                    comments.People.IdPersonGender = Convert.ToByte(rdr["IdUserGender"]);
                                }
                            }

                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                comments.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["Comment"] != DBNull.Value)
                            {
                                comments.Comments = Convert.ToString(rdr["Comment"]);
                            }
                            if (rdr["IsRtfText"] != DBNull.Value)
                            {
                                comments.IsRtfText = Convert.ToBoolean(rdr["IsRtfText"]);
                            }
                            commentsList.Add(comments);
                        }
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetSubTaskCommentsByIdSubTask_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return commentsList;
        }
        //[shweta.thube][GEOS2-7004][25.06.2025]
        public List<CommentsByTask> AddUpdateDeleteCommentsByIdSubTask_V2650(string connectionString, List<CommentsByTask> commentsList)
        {
            try
            {
                if (commentsList != null)
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        foreach (var item in commentsList)
                        {
                            if (item.TransactionOperation == ModelBase.TransactionOperations.Add)
                            {
                                MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertActionPlanSubTaskComment_V2650", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;
                                mySqlCommand.Parameters.AddWithValue("_Comment", item.Comments);
                                mySqlCommand.Parameters.AddWithValue("_IdTask", item.IdTask);
                                mySqlCommand.Parameters.AddWithValue("_CreatedBy", item.IdUser);
                                mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                mySqlCommand.Parameters.AddWithValue("_IsRtfText", item.IsRtfText);

                                item.IdActionPlanTaskComment = Convert.ToInt64(mySqlCommand.ExecuteScalar());
                            }
                            else if (item.TransactionOperation == ModelBase.TransactionOperations.Update)
                            {
                                if (item.IdActionPlanTaskComment > 0)
                                {
                                    MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateActionPlanSubTaskComment_V2650", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                                    mySqlCommand.Parameters.AddWithValue("_IdActionPlanTaskComment", item.IdActionPlanTaskComment);
                                    mySqlCommand.Parameters.AddWithValue("_Comment", item.Comments);
                                    mySqlCommand.Parameters.AddWithValue("_ModifiedBy", item.IdUser);
                                    mySqlCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    mySqlCommand.Parameters.AddWithValue("_IsRtfText", item.IsRtfText);
                                    mySqlCommand.ExecuteNonQuery();
                                }
                            }
                            else if (item.TransactionOperation == ModelBase.TransactionOperations.Delete)
                            {
                                MySqlCommand mySqlCommand = new MySqlCommand("APM_DeleteActionPlanSubTaskComment_V2650", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;
                                mySqlCommand.Parameters.AddWithValue("_IdActionPlanTaskComment", item.IdActionPlanTaskComment);
                                mySqlCommand.Parameters.AddWithValue("_DeletedIn", DateTime.Now);
                                mySqlCommand.Parameters.AddWithValue("_DeletedBy", item.IdUser);
                                if (item.IsDeleted)
                                {
                                    mySqlCommand.Parameters.AddWithValue("_IsDeleted", 1);
                                }
                                else
                                {
                                    mySqlCommand.Parameters.AddWithValue("_IsDeleted", 0);
                                }

                                mySqlCommand.ExecuteNonQuery();
                            }
                        }
                        mySqlConnection.Close();
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddUpdateDeleteCommentsByIdSubTask_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return commentsList;
        }
        //[shweta.thube][GEOS2-7004][25.06.2025]
        public List<AttachmentsByTask> GetTaskAttachmentsByIdSubTask_V2650(string connectionString, Int64 idTask)
        {
            List<AttachmentsByTask> attachmentList = new List<AttachmentsByTask>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetAttachmentsForActionPlanSubTask_V2650", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdTask", idTask);
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            AttachmentsByTask attach = new AttachmentsByTask();
                            if (rdr["IdActionPlanTaskAttachment"] != DBNull.Value)
                            {
                                attach.IdActionPlanTaskAttachment = Convert.ToInt64(rdr["IdActionPlanTaskAttachment"]);
                            }
                            if (rdr["FileName"] != DBNull.Value)
                            {
                                attach.OriginalFileName = Convert.ToString(rdr["FileName"]);
                                attach.SavedFileName = Convert.ToString(rdr["FileName"]);
                            }
                            if (rdr["FileLocation"] != DBNull.Value)
                            {
                                attach.FilePath = Convert.ToString(rdr["FileLocation"]);
                            }
                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                attach.IdTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                attach.CreatedBy = Convert.ToInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                attach.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                attach.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                attach.Description = Convert.ToString(rdr["Description"]);
                            }
                            attachmentList.Add(attach);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTaskAttachmentsByIdSubTask_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return attachmentList;
        }
        //[shweta.thube][GEOS2-7004][25.06.2025]
        public List<AttachmentsByTask> AddDeleteSubTaskAttachments_V2650(string connectionstring, List<AttachmentsByTask> attachmentList, string GuidString, string filePath, Int64 idTask)
        {
            string[] files = null;
            try
            {
                if (attachmentList != null)
                {
                    if (!string.IsNullOrEmpty(GuidString))
                    {
                        if (!Directory.Exists(filePath))
                        {
                            CreateDirectory(filePath);
                        }

                        if (!Directory.Exists(filePath + @"\" + idTask))
                        {
                            CreateDirectory(filePath + @"\" + idTask);
                        }

                        ZipFile.ExtractToDirectory(filePath + @"\_tmp\" + GuidString.ToString() + ".Zip", filePath + @"\_tmp\" + GuidString.ToString());

                        //Delete Zip Folder
                        File.Delete(filePath + @"\_tmp\" + GuidString.ToString() + ".Zip");
                        //Get all files in Extract folder in _tmp
                        files = Directory.GetFiles(filePath + @"\_tmp\" + GuidString.ToString());

                    }


                    foreach (AttachmentsByTask attachment in attachmentList)
                    {
                        attachment.IdTask = idTask;
                        if (Convert.ToBoolean(attachment.IsDeleted))
                        {
                            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
                            {
                                mySqlConnection.Open();

                                try
                                {
                                    MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateActionPlanSubTaskAttachment_V2650", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                                    mySqlCommand.Parameters.AddWithValue("_IdActionPlanTaskAttachment", attachment.IdActionPlanTaskAttachment);
                                    mySqlCommand.Parameters.AddWithValue("_IsDeleted", attachment.IsDeleted);

                                    mySqlCommand.ExecuteNonQuery();


                                    if (File.Exists(filePath + @"\" + idTask + @"\" + attachment.SavedFileName))
                                    {
                                        File.Delete(filePath + @"\" + idTask + @"\" + attachment.SavedFileName);
                                    }

                                    mySqlConnection.Close();
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error AddDeleteSubTaskAttachments_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                    throw;
                                }
                            }
                        }
                        else
                        {
                            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
                            {
                                mySqlConnection.Open();

                                try
                                {
                                    string completePath = @"\" + idTask + @"\" + attachment.SavedFileName;
                                    MySqlCommand mySqlCommand = new MySqlCommand("APM_AddActionPlanSubTaskAttachment_V2650", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                                    mySqlCommand.Parameters.AddWithValue("_fName", attachment.SavedFileName);
                                    mySqlCommand.Parameters.AddWithValue("_FileLocation", completePath);
                                    mySqlCommand.Parameters.AddWithValue("_IdTask", idTask);
                                    mySqlCommand.Parameters.AddWithValue("_CreatedBy", attachment.CreatedBy);
                                    mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                    mySqlCommand.Parameters.AddWithValue("_Description", attachment.Description);
                                    mySqlCommand.Parameters.AddWithValue("_IsDeleted", 0);

                                    attachment.IdActionPlanTaskAttachment = Convert.ToInt64(mySqlCommand.ExecuteScalar());

                                    foreach (string file in files)
                                    {
                                        if (attachment.FileUploadName == Path.GetFileName(file))
                                        {
                                            System.IO.File.Copy(file, filePath + @"\" + idTask + @"\" + attachment.SavedFileName, true);
                                            File.Delete(file);

                                            break;
                                        }
                                    }

                                    mySqlConnection.Close();
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error AddDeleteSubTaskAttachments_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                    throw;
                                }
                            }
                        }
                    }

                    if (!string.IsNullOrEmpty(GuidString))
                    {
                        Directory.Delete(filePath + @"\_tmp\" + GuidString.ToString());
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddDeleteSubTaskAttachments_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return attachmentList;
        }

        //[pallavi.kale][GEOS2-7003]
        public APMActionPlanSubTask AddSubTaskForActionPlan_V2650(string connectionString, APMActionPlanSubTask actionPlanTask)
        {
            bool isAdded = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertSubTaskForActionPlan_V2650", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdParent", actionPlanTask.IdParent);
                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        if (actionPlanTask.IdDelegated > 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                        mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlanTask.CreatedBy);
                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                        mySqlCommand.Parameters.AddWithValue("_Description", actionPlanTask.Description);
                        mySqlCommand.Parameters.AddWithValue("_ClosedBy", actionPlanTask.ClosedBy);
                        mySqlCommand.Parameters.AddWithValue("_IdOTItem", actionPlanTask.IdOTItem == 0 ? (object)DBNull.Value : actionPlanTask.IdOTItem);
                        actionPlanTask.IdActionPlanTask = Convert.ToUInt32(mySqlCommand.ExecuteScalar());

                        mySqlConnection.Close();

                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isAdded = true;

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddSubTaskForActionPlan_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanTask;
        }

        //[pallavi.kale][GEOS2-7003]
        public bool UpdateSubTaskForActionPlan_V2650(string connectionString, APMActionPlanSubTask actionPlanTask, string filePath)
        {
            bool isUpdated = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateSubTaskForActionPlan_V2650", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdTask", actionPlanTask.IdActionPlanTask);
                        mySqlCommand.Parameters.AddWithValue("_IdParent", actionPlanTask.IdParent);
                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        if (actionPlanTask.IdDelegated > 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                        mySqlCommand.Parameters.AddWithValue("_ModifiedBy", actionPlanTask.ModifiedBy);
                        mySqlCommand.Parameters.AddWithValue("_DueDateChangeCount", actionPlanTask.ChangeCount);
                        mySqlCommand.Parameters.AddWithValue("_Description", actionPlanTask.Description);
                        if (actionPlanTask.ClosedBy != 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_ClosedBy", actionPlanTask.ClosedBy);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_ClosedBy", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_IdOTItem", actionPlanTask.IdOTItem == 0 ? (object)DBNull.Value : actionPlanTask.IdOTItem);


                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isUpdated = true;

                    if (!string.IsNullOrEmpty(actionPlanTask.TaskStatusComment))
                    {
                        CommentsByTask commentsByTask = new CommentsByTask();
                        commentsByTask.Comments = actionPlanTask.TaskStatusComment;
                        commentsByTask.IdTask = actionPlanTask.IdActionPlanTask;
                        commentsByTask.IdUser = actionPlanTask.ModifiedBy;
                        commentsByTask.IsRtfText = false;

                        AddStatusCommentForSubTask_V2650(connectionString, commentsByTask);
                    }

                    if (actionPlanTask.TaskAttachmentList != null && actionPlanTask.TaskAttachmentList.Count > 0)
                    {
                        actionPlanTask.TaskAttachmentList.ForEach(x => x.Description = actionPlanTask.TaskStatusDescription);
                        actionPlanTask.TaskAttachmentList.ForEach(x => x.IdTask = actionPlanTask.IdActionPlanTask);
                        AddStatusAttachmentForSubTask_V2650(connectionString, actionPlanTask.TaskAttachmentList, filePath);
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateSubTaskForActionPlan_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }

        //[pallavi.kale][GEOS2-7003]
        public void AddStatusCommentForSubTask_V2650(string connectionString, CommentsByTask commentsByTask)
        {
            try
            {
                if (commentsByTask != null)
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertActionPlanSubTaskComment_V2650", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_Comment", commentsByTask.Comments);
                        mySqlCommand.Parameters.AddWithValue("_IdTask", commentsByTask.IdTask);
                        mySqlCommand.Parameters.AddWithValue("_CreatedBy", commentsByTask.IdUser);
                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                        mySqlCommand.Parameters.AddWithValue("_IsRtfText", commentsByTask.IsRtfText);
                        mySqlCommand.ExecuteNonQuery();

                        mySqlConnection.Close();
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddStatusCommentForSubTask_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
        }

        //[pallavi.kale][GEOS2-7003]
        public void AddStatusAttachmentForSubTask_V2650(string connectionString, List<AttachmentsByTask> attachmentList, string filePath)
        {
            try
            {
                if (attachmentList != null && attachmentList.Count > 0)
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        foreach (AttachmentsByTask item in attachmentList)
                        {
                            string completePath = @"\" + item.IdTask + @"\" + item.SavedFileName;
                            MySqlCommand mySqlCommand = new MySqlCommand("APM_AddActionPlanSubTaskAttachment_V2650", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;
                            mySqlCommand.Parameters.AddWithValue("_fName", item.SavedFileName);
                            mySqlCommand.Parameters.AddWithValue("_FileLocation", completePath);
                            mySqlCommand.Parameters.AddWithValue("_IdTask", item.IdTask);
                            mySqlCommand.Parameters.AddWithValue("_CreatedBy", item.CreatedBy);
                            mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                            mySqlCommand.Parameters.AddWithValue("_Description", item.Description);
                            mySqlCommand.Parameters.AddWithValue("_IsDeleted", 0);

                            item.IdActionPlanTaskAttachment = Convert.ToInt64(mySqlCommand.ExecuteScalar());

                            if (item.IdActionPlanTaskAttachment > 0)
                            {
                                AddActionPlanTaskAttachedDocToPath(item, filePath);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddStatusAttachmentForSubTask_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
        }
        //[shweta.thube][GEOS2-8683][01.07.2025]
        public bool DeleteSubTaskForActionPlan_V2650(string connectionString, Int64 IdActionPlanTask, List<LogEntriesByActionPlan> ActionPlanLogEntries)
        {
            bool isDeleted = false;
            if (IdActionPlanTask > 0)
            {
                try
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();
                        MySqlCommand mySqlCommand = new MySqlCommand("APM_DeleteSubTaskForActionPlan_V2650", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdTask", IdActionPlanTask);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }
                    isDeleted = true;

                    AddLogEntriesByActionPlan_V2580(connectionString, ActionPlanLogEntries);
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error DeleteSubTaskForActionPlan_V2650(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }
            }
            return isDeleted;
        }
        //[shweta.thube][GEOS2-7005][08.07.2025]
        public APMActionPlanSubTask AddSubTaskForActionPlan_V2660(string connectionString, APMActionPlanSubTask actionPlanTask)
        {
            bool isAdded = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertSubTaskForActionPlan_V2650", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdParent", actionPlanTask.IdParent);
                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        if (actionPlanTask.IdDelegated > 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                        mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlanTask.CreatedBy);
                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                        mySqlCommand.Parameters.AddWithValue("_Description", actionPlanTask.Description);
                        mySqlCommand.Parameters.AddWithValue("_ClosedBy", actionPlanTask.ClosedBy);
                        mySqlCommand.Parameters.AddWithValue("_IdOTItem", actionPlanTask.IdOTItem == 0 ? (object)DBNull.Value : actionPlanTask.IdOTItem);
                        actionPlanTask.IdActionPlanTask = Convert.ToUInt32(mySqlCommand.ExecuteScalar());

                        mySqlConnection.Close();

                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isAdded = true;
                    if (actionPlanTask.ActionPlanLogEntries != null && actionPlanTask.ActionPlanLogEntries.Count > 0)
                    {
                        AddLogEntriesByActionPlan_V2580(connectionString, actionPlanTask.ActionPlanLogEntries);
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddSubTaskForActionPlan_V2660(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanTask;
        }
        //[shweta.thube][GEOS2-7005][08.07.2025]
        public bool UpdateSubTaskForActionPlan_V2660(string connectionString, APMActionPlanSubTask actionPlanTask, string filePath)
        {
            bool isUpdated = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateSubTaskForActionPlan_V2650", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdTask", actionPlanTask.IdActionPlanTask);
                        mySqlCommand.Parameters.AddWithValue("_IdParent", actionPlanTask.IdParent);
                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        if (actionPlanTask.IdDelegated > 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                        mySqlCommand.Parameters.AddWithValue("_ModifiedBy", actionPlanTask.ModifiedBy);
                        mySqlCommand.Parameters.AddWithValue("_DueDateChangeCount", actionPlanTask.ChangeCount);
                        mySqlCommand.Parameters.AddWithValue("_Description", actionPlanTask.Description);
                        if (actionPlanTask.ClosedBy != 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_ClosedBy", actionPlanTask.ClosedBy);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_ClosedBy", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_IdOTItem", actionPlanTask.IdOTItem == 0 ? (object)DBNull.Value : actionPlanTask.IdOTItem);


                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isUpdated = true;

                    if (!string.IsNullOrEmpty(actionPlanTask.TaskStatusComment))
                    {
                        CommentsByTask commentsByTask = new CommentsByTask();
                        commentsByTask.Comments = actionPlanTask.TaskStatusComment;
                        commentsByTask.IdTask = actionPlanTask.IdActionPlanTask;
                        commentsByTask.IdUser = actionPlanTask.ModifiedBy;
                        commentsByTask.IsRtfText = false;

                        AddStatusCommentForSubTask_V2650(connectionString, commentsByTask);
                    }

                    if (actionPlanTask.TaskAttachmentList != null && actionPlanTask.TaskAttachmentList.Count > 0)
                    {
                        actionPlanTask.TaskAttachmentList.ForEach(x => x.Description = actionPlanTask.TaskStatusDescription);
                        actionPlanTask.TaskAttachmentList.ForEach(x => x.IdTask = actionPlanTask.IdActionPlanTask);
                        AddStatusAttachmentForSubTask_V2650(connectionString, actionPlanTask.TaskAttachmentList, filePath);
                    }
                    if (actionPlanTask.ActionPlanLogEntries != null)
                    {
                        AddLogEntriesByActionPlan_V2580(connectionString, actionPlanTask.ActionPlanLogEntries);
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateSubTaskForActionPlan_V2660(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }
        //[shweta.thube][GEOS2-7218][23.07.2025]
        public APMActionPlan GetActionPlanDetailsByIdActionPlan_V2660(string connectionString, Int64 idActionplan)
        {
            APMActionPlan actionPlan = new APMActionPlan();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetailsByIdActionPlan_V2660", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdActionplan", idActionplan);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.Country.Iso + ".png";
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                actionPlan.ResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.IdLookupBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                            }
                            if (rdr["BusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }
                            if (rdr["BusinessUnitHtmlColor"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHtmlColor"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                actionPlan.CreatedBy = Convert.ToInt16(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                actionPlan.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                actionPlan.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["IdDepartment"] != DBNull.Value)
                            {
                                actionPlan.IdDepartment = Convert.ToInt32(rdr["IdDepartment"]);
                                actionPlan.Department = Convert.ToString(rdr["Department"]);
                            }
                            if (rdr["OriginDescription"] != DBNull.Value)
                            {
                                actionPlan.OriginDescription = Convert.ToString(rdr["OriginDescription"]);
                            }
                            if (rdr["ActionPlanResponsibleDisplayName"] != DBNull.Value)
                            {
                                actionPlan.ActionPlanResponsibleDisplayName = Convert.ToString(rdr["ActionPlanResponsibleDisplayName"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                actionPlan.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                actionPlan.Group = Convert.ToString(rdr["CustomerName"]);
                            }

                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                actionPlan.Site = Convert.ToString(rdr["SiteName"]);
                                actionPlan.GroupName = actionPlan.Group + " " + "(" + actionPlan.Site + ")";
                            }
                            if (rdr["IdZone"] != DBNull.Value)
                            {
                                actionPlan.IdZone = Convert.ToInt32(rdr["IdZone"]);
                            }
                            if (rdr["Region"] != DBNull.Value)
                            {
                                actionPlan.Zone = Convert.ToString(rdr["Region"]);
                            }
                        }
                    }

                    con.Close();
                }

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetailsByIdActionPlan_V2660(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlan;
        }
        //[shweta.thube][GEOS2-8985][18.07.2025]
        public string GetMaxTaskNumberByIdActionPlan_V2660(string connectionString, Int64 idActionplan)
        {
            string TaskNumber = string.Empty;
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetMaxTaskNumberByIdActionPlan_V2660", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdActionplan", idActionplan);
                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        if (rdr.Read())
                        {
                            if (rdr["NextTaskNumber"] != DBNull.Value)
                            {
                                TaskNumber = Convert.ToString(rdr["NextTaskNumber"]);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetMaxTaskNumberByIdActionPlan_V2660(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return TaskNumber;
        }
        //[shweta.thube][GEOS2-8985][18.07.2025]
        public string GetMaxSubTaskCodeByIdTask_V2660(string connectionString, Int32 idTask)
        {
            string code = string.Empty;
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetMaxSubTaskCodeByIdTask_V2660", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdTask", idTask);
                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        if (rdr.Read())
                        {
                            if (rdr["NextSubTaskCode"] != DBNull.Value)
                            {
                                code = Convert.ToString(rdr["NextSubTaskCode"]);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetMaxSubTaskCodeByIdTask_V2660(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return code;
        }

        //[shweta.thube][GEOS2-7217][23.07.2025]
        public List<APMActionPlan> GetActionPlanDetails_V2660(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlan> actionPlanList = new List<APMActionPlan>();
            List<APMActionPlanTask> actionPlanTaskList = new List<APMActionPlanTask>();
            List<string> countryISOs = new List<string>();

            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_V2660", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlan actionPlan = new APMActionPlan();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.Country.Iso + ".png";
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                actionPlan.ResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.IdLookupBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                            }
                            if (rdr["BusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }
                            if (rdr["BusinessUnitHtmlColor"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHtmlColor"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                actionPlan.CreatedBy = Convert.ToInt16(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                actionPlan.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                actionPlan.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["IdDepartment"] != DBNull.Value)
                            {
                                actionPlan.IdDepartment = Convert.ToInt32(rdr["IdDepartment"]);
                                actionPlan.Department = Convert.ToString(rdr["Department"]);
                            }
                            if (rdr["OriginDescription"] != DBNull.Value)
                            {
                                actionPlan.OriginDescription = Convert.ToString(rdr["OriginDescription"]);
                            }
                            if (rdr["ActionPlanResponsibleDisplayName"] != DBNull.Value)
                            {
                                actionPlan.ActionPlanResponsibleDisplayName = Convert.ToString(rdr["ActionPlanResponsibleDisplayName"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                actionPlan.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                actionPlan.Group = Convert.ToString(rdr["CustomerName"]);
                            }

                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                actionPlan.Site = Convert.ToString(rdr["SiteName"]);
                                actionPlan.GroupName = actionPlan.Group + " " + "(" + actionPlan.Site + ")";
                            }
                            if (rdr["IdZone"] != DBNull.Value)
                            {
                                actionPlan.IdZone = Convert.ToInt32(rdr["IdZone"]);
                            }
                            if (rdr["Region"] != DBNull.Value)
                            {
                                actionPlan.Zone = Convert.ToString(rdr["Region"]);
                            }
                            actionPlanList.Add(actionPlan);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdActionPlan"] != DBNull.Value)
                                {
                                    APMActionPlan actionPlanTask = actionPlanList.FirstOrDefault(x => x.IdActionPlan == Convert.ToInt32(rdr["IdActionPlan"]));
                                    if (actionPlanTask != null)
                                    {
                                        if (actionPlanTask.TaskList == null)
                                        {
                                            actionPlanTask.TaskList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);
                                        if (rdr["IdActionPlan"] != DBNull.Value)
                                        {
                                            task.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                                        }
                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }

                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            task.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            task.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (task.DueDate != task.OriginalDueDate)
                                        {
                                            task.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            task.IsShowIcon = false;
                                        }
                                        task.Code = actionPlanTask.Code;
                                        task.ActionPlanDescription = actionPlanTask.Description;
                                        task.TaskOrigin = actionPlanTask.Origin;
                                        task.BusinessUnit = actionPlanTask.BusinessUnit;
                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            task.Country = new Country();
                                            task.Country.Name = Convert.ToString(rdr["Country"]);
                                            task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["NumItem"] != DBNull.Value)
                                        {
                                            task.NumItem = Convert.ToString(rdr["NumItem"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            task.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            task.IdOT = Convert.ToInt32(rdr["IdOT"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        if (rdr["FirstName"] != DBNull.Value)
                                        {
                                            task.FirstName = Convert.ToString(rdr["FirstName"]);
                                        }
                                        actionPlanTask.TaskList.Add(task);
                                    }
                                }
                            }
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdParent"] != DBNull.Value)
                                {

                                    long parentId = Convert.ToInt64(rdr["IdParent"]);

                                    APMActionPlanTask actionPlanSubTask = actionPlanList
                                        .SelectMany(ap => ap.TaskList ?? new List<APMActionPlanTask>())
                                        .FirstOrDefault(t => t.IdActionPlanTask == parentId);
                                    if (actionPlanSubTask != null)
                                    {
                                        if (actionPlanSubTask.SubTaskList == null)
                                        {
                                            actionPlanSubTask.SubTaskList = new List<APMActionPlanSubTask>();
                                        }
                                        APMActionPlanSubTask subTask = new APMActionPlanSubTask();


                                        if (rdr["IdActionPlan"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                                        }
                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            subTask.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["ParentTaskNumber"] != DBNull.Value)
                                        {
                                            subTask.ParentTaskNumber = Convert.ToInt64(rdr["ParentTaskNumber"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.SubTaskNumber = Convert.ToInt64(rdr["TaskNumber"]);
                                            subTask.SubTaskCode = subTask.ParentTaskNumber + "." + subTask.SubTaskNumber;
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            subTask.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            subTask.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            subTask.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            subTask.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            subTask.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            subTask.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            subTask.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            subTask.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            subTask.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            subTask.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            subTask.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            subTask.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            subTask.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            subTask.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            subTask.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo = new Responsible();
                                            subTask.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            subTask.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            subTask.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            subTask.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            subTask.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            subTask.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            subTask.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            subTask.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            subTask.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            subTask.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            subTask.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            subTask.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            subTask.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            subTask.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            subTask.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            subTask.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            subTask.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            subTask.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            subTask.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            subTask.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            subTask.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (subTask.DueDate != subTask.OriginalDueDate)
                                        {
                                            subTask.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            subTask.IsShowIcon = false;
                                        }
                                        subTask.Code = actionPlanSubTask.Code;
                                        subTask.ActionPlanDescription = actionPlanSubTask.Description;
                                        subTask.TaskOrigin = actionPlanSubTask.Origin;
                                        subTask.BusinessUnit = actionPlanSubTask.BusinessUnit;
                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            subTask.Country = new Country();
                                            subTask.Country.Name = Convert.ToString(rdr["Country"]);
                                            subTask.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            subTask.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + subTask.Country.Iso + ".png";
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            subTask.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["NumItem"] != DBNull.Value)
                                        {
                                            subTask.NumItem = Convert.ToString(rdr["NumItem"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            subTask.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            subTask.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            subTask.IdOT = Convert.ToInt32(rdr["IdOT"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            subTask.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        actionPlanSubTask.SubTaskList.Add(subTask);

                                    }
                                }
                            }
                        }
                    }
                }


                foreach (var item in actionPlanList)
                {
                    if (item.TotalActionItems != 0)
                    {
                        item.Percentage = (int)(((float)item.TotalClosedItems / item.TotalActionItems) * 100);
                    }
                    else
                    {
                        item.Percentage = 0;
                    }

                    if (item.Percentage <= 24)
                    {
                        item.TotalClosedColor = "Red";
                    }
                    else if (item.Percentage >= 25 && item.Percentage <= 49)
                    {
                        item.TotalClosedColor = "Orange";
                    }
                    else if (item.Percentage >= 50 && item.Percentage <= 74)
                    {
                        item.TotalClosedColor = "Yellow";
                    }
                    else if (item.Percentage >= 75 && item.Percentage <= 99)
                    {
                        item.TotalClosedColor = "LightGreen";
                    }
                    else if (item.Percentage == 100)
                    {
                        item.TotalClosedColor = "Green";
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2660(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanList;
        }
        //[shweta.thube][GEOS2-9237][14.08.2025]
        public List<APMActionPlan> GetActionPlanDetails_V2670(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlan> actionPlanList = new List<APMActionPlan>();
            List<APMActionPlanTask> actionPlanTaskList = new List<APMActionPlanTask>();
            List<string> countryISOs = new List<string>();

            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_V2670", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlan actionPlan = new APMActionPlan();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.Country.Iso + ".png";
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                actionPlan.ResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.IdLookupBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                            }
                            if (rdr["BusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }
                            if (rdr["BusinessUnitHtmlColor"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHtmlColor"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                actionPlan.CreatedBy = Convert.ToInt16(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                actionPlan.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                actionPlan.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["IdDepartment"] != DBNull.Value)
                            {
                                actionPlan.IdDepartment = Convert.ToInt32(rdr["IdDepartment"]);
                                actionPlan.Department = Convert.ToString(rdr["Department"]);
                            }
                            if (rdr["OriginDescription"] != DBNull.Value)
                            {
                                actionPlan.OriginDescription = Convert.ToString(rdr["OriginDescription"]);
                            }
                            if (rdr["ActionPlanResponsibleDisplayName"] != DBNull.Value)
                            {
                                actionPlan.ActionPlanResponsibleDisplayName = Convert.ToString(rdr["ActionPlanResponsibleDisplayName"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                actionPlan.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                actionPlan.Group = Convert.ToString(rdr["CustomerName"]);
                            }

                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                actionPlan.Site = Convert.ToString(rdr["SiteName"]);
                                actionPlan.GroupName = actionPlan.Group + " " + "(" + actionPlan.Site + ")";
                            }
                            if (rdr["IdZone"] != DBNull.Value)
                            {
                                actionPlan.IdZone = Convert.ToInt32(rdr["IdZone"]);
                            }
                            if (rdr["Region"] != DBNull.Value)
                            {
                                actionPlan.Zone = Convert.ToString(rdr["Region"]);
                            }
                            actionPlanList.Add(actionPlan);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdActionPlan"] != DBNull.Value)
                                {
                                    APMActionPlan actionPlanTask = actionPlanList.FirstOrDefault(x => x.IdActionPlan == Convert.ToInt32(rdr["IdActionPlan"]));
                                    if (actionPlanTask != null)
                                    {
                                        if (actionPlanTask.TaskList == null)
                                        {
                                            actionPlanTask.TaskList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);
                                        if (rdr["IdActionPlan"] != DBNull.Value)
                                        {
                                            task.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                                        }
                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }

                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            task.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            task.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (task.DueDate != task.OriginalDueDate)
                                        {
                                            task.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            task.IsShowIcon = false;
                                        }
                                        task.Code = actionPlanTask.Code;
                                        task.ActionPlanDescription = actionPlanTask.Description;
                                        task.TaskOrigin = actionPlanTask.Origin;
                                        task.BusinessUnit = actionPlanTask.BusinessUnit;
                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            task.Country = new Country();
                                            task.Country.Name = Convert.ToString(rdr["Country"]);
                                            task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["NumItem"] != DBNull.Value)
                                        {
                                            task.NumItem = Convert.ToString(rdr["NumItem"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            task.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            task.IdOT = Convert.ToInt32(rdr["IdOT"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        if (rdr["FirstName"] != DBNull.Value)
                                        {
                                            task.FirstName = Convert.ToString(rdr["FirstName"]);
                                        }
                                        actionPlanTask.TaskList.Add(task);
                                    }
                                }
                            }
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdParent"] != DBNull.Value)
                                {

                                    long parentId = Convert.ToInt64(rdr["IdParent"]);

                                    APMActionPlanTask actionPlanSubTask = actionPlanList
                                        .SelectMany(ap => ap.TaskList ?? new List<APMActionPlanTask>())
                                        .FirstOrDefault(t => t.IdActionPlanTask == parentId);
                                    if (actionPlanSubTask != null)
                                    {
                                        if (actionPlanSubTask.SubTaskList == null)
                                        {
                                            actionPlanSubTask.SubTaskList = new List<APMActionPlanSubTask>();
                                        }
                                        APMActionPlanSubTask subTask = new APMActionPlanSubTask();


                                        if (rdr["IdActionPlan"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                                        }
                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            subTask.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["ParentTaskNumber"] != DBNull.Value)
                                        {
                                            subTask.ParentTaskNumber = Convert.ToInt64(rdr["ParentTaskNumber"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.SubTaskNumber = Convert.ToInt64(rdr["TaskNumber"]);
                                            subTask.SubTaskCode = subTask.ParentTaskNumber + "." + subTask.SubTaskNumber;
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            subTask.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            subTask.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            subTask.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            subTask.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            subTask.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            subTask.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            subTask.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            subTask.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            subTask.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            subTask.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            subTask.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            subTask.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            subTask.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            subTask.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            subTask.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo = new Responsible();
                                            subTask.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            subTask.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            subTask.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            subTask.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            subTask.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            subTask.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            subTask.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            subTask.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            subTask.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            subTask.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            subTask.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            subTask.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            subTask.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            subTask.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            subTask.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            subTask.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            subTask.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            subTask.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            subTask.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            subTask.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            subTask.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (subTask.DueDate != subTask.OriginalDueDate)
                                        {
                                            subTask.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            subTask.IsShowIcon = false;
                                        }
                                        subTask.Code = actionPlanSubTask.Code;
                                        subTask.ActionPlanDescription = actionPlanSubTask.Description;
                                        subTask.TaskOrigin = actionPlanSubTask.Origin;
                                        subTask.BusinessUnit = actionPlanSubTask.BusinessUnit;
                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            subTask.Country = new Country();
                                            subTask.Country.Name = Convert.ToString(rdr["Country"]);
                                            subTask.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            subTask.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + subTask.Country.Iso + ".png";
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            subTask.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["NumItem"] != DBNull.Value)
                                        {
                                            subTask.NumItem = Convert.ToString(rdr["NumItem"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            subTask.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            subTask.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            subTask.IdOT = Convert.ToInt32(rdr["IdOT"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            subTask.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        actionPlanSubTask.SubTaskList.Add(subTask);

                                    }
                                }
                            }
                        }
                    }
                }


                foreach (var item in actionPlanList)
                {
                    if (item.TotalActionItems != 0)
                    {
                        item.Percentage = (int)(((float)item.TotalClosedItems / item.TotalActionItems) * 100);
                    }
                    else
                    {
                        item.Percentage = 0;
                    }

                    if (item.Percentage <= 24)
                    {
                        item.TotalClosedColor = "Red";
                    }
                    else if (item.Percentage >= 25 && item.Percentage <= 49)
                    {
                        item.TotalClosedColor = "Orange";
                    }
                    else if (item.Percentage >= 50 && item.Percentage <= 74)
                    {
                        item.TotalClosedColor = "Yellow";
                    }
                    else if (item.Percentage >= 75 && item.Percentage <= 99)
                    {
                        item.TotalClosedColor = "LightGreen";
                    }
                    else if (item.Percentage == 100)
                    {
                        item.TotalClosedColor = "Green";
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanList;
        }

        //[pallavi.kale][GEOS2-8084][04.08.2025]
        public List<APMActionPlanTask> GetActionPlanTaskDetails_V2670(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanTaskDetails_V2670", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                task.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["ActionDescription"] != DBNull.Value)
                            {
                                task.ActionPlanDescription = Convert.ToString(rdr["ActionDescription"]);
                            }
                            if (rdr["IdOrigin"] != DBNull.Value)
                            {
                                task.IdOrigin = Convert.ToInt32(rdr["IdOrigin"]);
                                task.TaskOrigin = Convert.ToString(rdr["TaskOrigin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                task.IdBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                                task.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                            {
                                task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                            }
                            if (rdr["DelegatedDisplayName"] != DBNull.Value)
                            {
                                task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                            }


                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }

                            if (rdr["Country"] != DBNull.Value)
                            {
                                task.Country = new Country();
                                task.Country.Name = Convert.ToString(rdr["Country"]);
                                task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                task.ActionPlanResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }

                            if (rdr["IdOTItem"] != DBNull.Value)
                            {
                                task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                            }
                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                task.IdOT = Convert.ToInt64(rdr["IdOT"]);
                            }
                            if (rdr["OTCode"] != DBNull.Value)
                            {
                                task.OTCode = Convert.ToString(rdr["OTCode"]);
                            }
                            if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                            {
                                task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                            }
                            if (rdr["Participant"] != DBNull.Value)
                            {
                                string participantString = rdr["Participant"].ToString();
                                task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                task.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["IdParent"] != DBNull.Value)
                            {
                                task.IdParent = Convert.ToInt64(rdr["IdParent"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                task.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                task.Group = Convert.ToString(rdr["CustomerName"]);
                            }

                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                task.Site = Convert.ToString(rdr["SiteName"]);
                                task.GroupName = task.Group + " " + "(" + task.Site + ")";
                            }

                            taskList.Add(task);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdParent"] != DBNull.Value)
                                {
                                    APMActionPlanTask actionPlanSubTask = taskList.FirstOrDefault(x => x.IdActionPlanTask == Convert.ToInt64(rdr["IdParent"]));

                                    if (actionPlanSubTask != null)
                                    {
                                        if (actionPlanSubTask.SubTaskList == null)
                                        {
                                            actionPlanSubTask.SubTaskList = new List<APMActionPlanSubTask>();
                                        }

                                        APMActionPlanSubTask subTask = new APMActionPlanSubTask();

                                        if (rdr["IdActionPlan"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            subTask.Code = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["ActionDescription"] != DBNull.Value)
                                        {
                                            subTask.ActionPlanDescription = Convert.ToString(rdr["ActionDescription"]);
                                        }
                                        if (rdr["IdOrigin"] != DBNull.Value)
                                        {
                                            subTask.IdOrigin = Convert.ToInt32(rdr["IdOrigin"]);
                                            subTask.TaskOrigin = Convert.ToString(rdr["TaskOrigin"]);
                                        }
                                        if (rdr["IdBusinessUnit"] != DBNull.Value)
                                        {
                                            subTask.IdBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                                            subTask.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                                        }

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            subTask.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            subTask.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            subTask.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            subTask.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            subTask.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            subTask.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            subTask.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            subTask.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            subTask.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            subTask.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            subTask.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            subTask.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            subTask.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            subTask.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            subTask.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo = new Responsible();
                                            subTask.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            subTask.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            subTask.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            subTask.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            subTask.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            subTask.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            subTask.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            subTask.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            subTask.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            subTask.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            subTask.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            subTask.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            subTask.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            subTask.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            subTask.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            subTask.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            subTask.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            subTask.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            subTask.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            subTask.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            subTask.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (subTask.DueDate != subTask.OriginalDueDate)
                                        {
                                            subTask.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            subTask.IsShowIcon = false;
                                        }

                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            subTask.Country = new Country();
                                            subTask.Country.Name = Convert.ToString(rdr["Country"]);
                                            subTask.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            subTask.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + subTask.Country.Iso + ".png";
                                        }
                                        if (rdr["IdUser"] != DBNull.Value)
                                        {
                                            subTask.ActionPlanResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                                        }

                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            subTask.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            subTask.IdOT = Convert.ToInt64(rdr["IdOT"]);
                                        }
                                        if (rdr["OTCode"] != DBNull.Value)
                                        {
                                            subTask.OTCode = Convert.ToString(rdr["OTCode"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            subTask.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            subTask.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;
                                        }
                                        if (rdr["FirstName"] != DBNull.Value)
                                        {
                                            subTask.FirstName = Convert.ToString(rdr["FirstName"]);
                                        }
                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            subTask.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["ParentTaskNumber"] != DBNull.Value)
                                        {
                                            subTask.ParentTaskNumber = Convert.ToInt64(rdr["ParentTaskNumber"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.SubTaskNumber = Convert.ToInt64(rdr["TaskNumber"]);
                                            subTask.SubTaskCode = subTask.ParentTaskNumber + "." + subTask.SubTaskNumber;
                                        }
                                        if (rdr["IdSite"] != DBNull.Value)
                                        {
                                            subTask.IdSite = Convert.ToInt32(rdr["IdSite"]);
                                        }
                                        if (rdr["CustomerName"] != DBNull.Value)
                                        {
                                            subTask.Group = Convert.ToString(rdr["CustomerName"]);
                                        }

                                        if (rdr["SiteName"] != DBNull.Value)
                                        {
                                            subTask.Site = Convert.ToString(rdr["SiteName"]);
                                            subTask.GroupName = subTask.Group + " " + "(" + subTask.Site + ")";
                                        }
                                        actionPlanSubTask.SubTaskList.Add(subTask);
                                    }
                                }
                            }


                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error APM_GetActionPlanTaskDetails_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }

        //[rdixit][GEOS2-9354][01.09.2025]
        public List<Responsible> GetResponsibleListAsPerLocation_V2670(string connectionString, string IdCompanies)
        {
            List<Responsible> responsibleList = new List<Responsible>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetResponsibleByLocation_V2670", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdCompanyLocation", IdCompanies);
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        #region MyRegion
                        while (rdr.Read())
                        {
                            Responsible responsible = new Responsible();
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                responsible.IdEmployee = Convert.ToUInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                responsible.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                responsible.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                responsible.LastName = Convert.ToString(rdr["LastName"]);
                                responsible.FullName = responsible.FirstName + " " + responsible.LastName;
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                responsible.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                responsible.EmployeeCodeWithIdGender = responsible.EmployeeCode + "_" + responsible.IdGender;
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                responsible.IdOrganizationCode = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["OrganizationCode"] != DBNull.Value)
                            {
                                responsible.Organization = Convert.ToString(rdr["OrganizationCode"]);
                            }
                            if (rdr["IdEmployeeStatus"] != DBNull.Value)
                            {
                                responsible.IdEmployeeStatus = Convert.ToInt16(rdr["IdEmployeeStatus"]);
                            }
                            if (rdr["JobCode"] != DBNull.Value)
                            {
                                responsible.JobCode = Convert.ToString(rdr["JobCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                responsible.IdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["Login"] != DBNull.Value)
                            {
                                responsible.UserName = Convert.ToString(rdr["Login"]);
                            }
                            if (rdr["ResponsibleDisplayName"] != DBNull.Value)
                            {
                                responsible.ResponsibleDisplayName = Convert.ToString(rdr["ResponsibleDisplayName"]);
                            }
                            responsibleList.Add(responsible);
                        }
                        #endregion
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetResponsibleListAsPerLocation_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return responsibleList;
        }
        #region  //[shweta.thube][GEOS2-6048][03.09.2025]
        public List<GlobalMailReport> GetGlobalReportTOTaskMail_V2670(string connectionString, Int32 IdCompany, string To_Ids)
        {
            List<GlobalMailReport> globalToMailReportList = new List<GlobalMailReport>();
            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetGlobalReportTOTaskMail_V2670", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdCompany", IdCompany);
                    // mySqlCommand.Parameters.AddWithValue("_TO_CC_Ids", To_CC_Ids);
                    mySqlCommand.Parameters.AddWithValue("_TO_Ids", To_Ids);
                    //  mySqlCommand.Parameters.AddWithValue("_CC_Ids", cc_Ids);

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                GlobalMailReport globalMailReport = new GlobalMailReport();

                                if (reader["IdEmployee"] != DBNull.Value)
                                {
                                    globalMailReport.IdEmployee = Convert.ToUInt32(reader["IdEmployee"]);
                                }

                                if (reader["IdCompany"] != DBNull.Value)
                                {
                                    globalMailReport.IdCompany = Convert.ToUInt32(reader["IdCompany"]);
                                }

                                if (reader["IdJobDescription"] != DBNull.Value)
                                {
                                    globalMailReport.IdJobDescription = Convert.ToUInt32(reader["IdJobDescription"]);
                                }

                                if (reader["CompanyEmail"] != DBNull.Value)
                                {
                                    globalMailReport.EmployeeContactValue = Convert.ToString(reader["CompanyEmail"]);
                                }

                                if (reader["FirstName"] != DBNull.Value)
                                {
                                    globalMailReport.FirstName = Convert.ToString(reader["FirstName"]);
                                }

                                if (reader["LastName"] != DBNull.Value)
                                {
                                    globalMailReport.LastName = Convert.ToString(reader["LastName"]);
                                }

                                if (reader["EmployeeCode"] != DBNull.Value)
                                {
                                    globalMailReport.EmployeeCode = Convert.ToString(reader["EmployeeCode"]);
                                }
                                if (reader["JobDescriptionCode"] != DBNull.Value)
                                {
                                    globalMailReport.JobDescriptionCode = Convert.ToString(reader["JobDescriptionCode"]);
                                }

                                globalToMailReportList.Add(globalMailReport);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetGlobalReportTOTaskMail_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                            }
                        }
                    }

                    mySqlConnection.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetGlobalReportTOTaskMail_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                throw;
            }
            return globalToMailReportList;
        }


        public List<GlobalMailReport> GetGlobalReportCCTaskMail_V2670(string connectionString, Int32 IdCompany, string cc_Ids)
        {
            List<GlobalMailReport> globalCCMailReportList = new List<GlobalMailReport>();

            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetGlobalReportCCTaskMail_V2670", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdCompany", IdCompany);
                    mySqlCommand.Parameters.AddWithValue("_CC_Ids", cc_Ids);

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                GlobalMailReport globalMailReport = new GlobalMailReport();

                                if (reader["IdEmployee"] != DBNull.Value)
                                {
                                    globalMailReport.IdEmployee = Convert.ToUInt32(reader["IdEmployee"]);
                                }

                                if (reader["IdCompany"] != DBNull.Value)
                                {
                                    globalMailReport.IdCompany = Convert.ToUInt32(reader["IdCompany"]);
                                }

                                if (reader["IdJobDescription"] != DBNull.Value)
                                {
                                    globalMailReport.IdJobDescription = Convert.ToUInt32(reader["IdJobDescription"]);
                                }

                                if (reader["CompanyEmail"] != DBNull.Value)
                                {
                                    globalMailReport.EmployeeContactValue = Convert.ToString(reader["CompanyEmail"]);
                                }

                                if (reader["FirstName"] != DBNull.Value)
                                {
                                    globalMailReport.FirstName = Convert.ToString(reader["FirstName"]);
                                }

                                if (reader["LastName"] != DBNull.Value)
                                {
                                    globalMailReport.LastName = Convert.ToString(reader["LastName"]);
                                }

                                if (reader["EmployeeCode"] != DBNull.Value)
                                {
                                    globalMailReport.EmployeeCode = Convert.ToString(reader["EmployeeCode"]);
                                }
                                if (reader["JobDescriptionCode"] != DBNull.Value)
                                {
                                    globalMailReport.JobDescriptionCode = Convert.ToString(reader["JobDescriptionCode"]);
                                }

                                globalCCMailReportList.Add(globalMailReport);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error APM_GetGlobalReportCCTaskMail_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                            }
                        }
                    }

                    mySqlConnection.Close();
                }
            }

            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error APM_GetGlobalReportCCTaskMail_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return globalCCMailReportList;
        }

        public List<GlobalMailReport> GetGlobalReportCCIdsTaskMail_V2670(string connectionString, string cc_Ids)
        {
            List<GlobalMailReport> globalCCMailReportList = new List<GlobalMailReport>();
            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetGlobalReportCCIdsTaskMail_V2670", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_TO_CC_Ids", cc_Ids);

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                GlobalMailReport globalMailReport = new GlobalMailReport();

                                if (reader["IdEmployee"] != DBNull.Value)
                                {
                                    globalMailReport.IdEmployee = Convert.ToUInt32(reader["IdEmployee"]);
                                }

                                if (reader["IdCompany"] != DBNull.Value)
                                {
                                    globalMailReport.IdCompany = Convert.ToUInt32(reader["IdCompany"]);
                                }

                                if (reader["IdJobDescription"] != DBNull.Value)
                                {
                                    globalMailReport.IdJobDescription = Convert.ToUInt32(reader["IdJobDescription"]);
                                }

                                if (reader["CompanyEmail"] != DBNull.Value)
                                {
                                    globalMailReport.EmployeeContactValue = Convert.ToString(reader["CompanyEmail"]);
                                }

                                if (reader["FirstName"] != DBNull.Value)
                                {
                                    globalMailReport.FirstName = Convert.ToString(reader["FirstName"]);
                                }

                                if (reader["LastName"] != DBNull.Value)
                                {
                                    globalMailReport.LastName = Convert.ToString(reader["LastName"]);
                                }

                                if (reader["EmployeeCode"] != DBNull.Value)
                                {
                                    globalMailReport.EmployeeCode = Convert.ToString(reader["EmployeeCode"]);
                                }
                                if (reader["JobDescriptionCode"] != DBNull.Value)
                                {
                                    globalMailReport.JobDescriptionCode = Convert.ToString(reader["JobDescriptionCode"]);
                                }

                                globalCCMailReportList.Add(globalMailReport);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetGlobalReportCCIdsTaskMail_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                            }
                        }
                    }

                    mySqlConnection.Close();
                }
            }

            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetGlobalReportCCIdsTaskMail_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return globalCCMailReportList;
        }

        public List<GlobalMailReport> GetMonthlyTaskStatusCountByLocation_V2670(string connectionString, DateTime StartDate, string idLocations)
        {
            List<GlobalMailReport> taskCount = new List<GlobalMailReport>();
            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetMonthlyTaskStatusCountByLocation_V2670", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_StartDate", StartDate);
                    mySqlCommand.Parameters.AddWithValue("_IdLocations", idLocations);
                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                GlobalMailReport employee = new GlobalMailReport();

                                if (reader["IdLocation"] != DBNull.Value)
                                {
                                    employee.IdCompany = Convert.ToUInt32(reader["IdLocation"]);
                                }
                                if (reader["Location"] != DBNull.Value)
                                {
                                    employee.Alias = Convert.ToString(reader["Location"]);
                                }
                                if (reader["ToDo"] != DBNull.Value)
                                {
                                    employee.ToDo = Convert.ToString(reader["ToDo"]);
                                }
                                if (reader["InProgress"] != DBNull.Value)
                                {
                                    employee.InProgress = Convert.ToString(reader["InProgress"]);
                                }
                                if (reader["Done"] != DBNull.Value)
                                {
                                    employee.Done = Convert.ToString(reader["Done"]);
                                }
                                if (reader["Blocked"] != DBNull.Value)
                                {
                                    employee.Blocked = Convert.ToString(reader["Blocked"]);
                                }
                                if (reader["TotalCount"] != DBNull.Value)
                                {
                                    employee.TotalNumberOfTasks = Convert.ToString(reader["TotalCount"]);
                                }
                                taskCount.Add(employee);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetMonthlyTaskStatusCountByLocation_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                            }
                        }
                    }

                    mySqlConnection.Close();
                }
            }

            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetMonthlyTaskStatusCountByLocation_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskCount;
        }

        public List<GlobalMailReport> GetMonthlyOpenAndClosedTaskCountByLocation_V2670(string connectionString, DateTime StartDate, string idLocations)
        {
            List<GlobalMailReport> TaskCount = new List<GlobalMailReport>();

            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetMonthlyOpenAndClosedTaskCountByLocation_V2670", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_StartDate", StartDate);
                    mySqlCommand.Parameters.AddWithValue("_IdLocations", idLocations);
                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                GlobalMailReport employee = new GlobalMailReport();

                                if (reader["IdLocation"] != DBNull.Value)
                                {
                                    employee.IdCompany = Convert.ToUInt32(reader["IdLocation"]);
                                }
                                if (reader["Location"] != DBNull.Value)
                                {
                                    employee.Alias = Convert.ToString(reader["Location"]);
                                }
                                if (reader["OpenTasks"] != DBNull.Value)
                                {
                                    employee.OpenTaskCount = Convert.ToString(reader["OpenTasks"]);
                                }
                                if (reader["ClosedTasks"] != DBNull.Value)
                                {
                                    employee.ClosedTaskCount = Convert.ToString(reader["ClosedTasks"]);
                                }
                                if (reader["TotalNumberOfTasks"] != DBNull.Value)
                                {
                                    employee.TotalNumberOfTasks = Convert.ToString(reader["TotalNumberOfTasks"]);
                                }
                                if (reader["CreatedCount"] != DBNull.Value)
                                {
                                    employee.CreatedCount = Convert.ToInt16(reader["CreatedCount"]);
                                }
                                //employee.TotalNumberOfTasks = (Convert.ToInt32(employee.OpenTaskCount) + Convert.ToInt32(employee.ClosedTaskCount)).ToString();
                                TaskCount.Add(employee);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetMonthlyOpenAndClosedTaskCountByLocation_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                            }
                        }
                    }
                    mySqlConnection.Close();
                }
            }

            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetMonthlyOpenAndClosedTaskCountByLocation_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                throw;
            }
            return TaskCount;
        }
        #endregion
        //[shweta.thube][GEOS2-9354][03.09.2025]
        public List<Responsible> GetParticipantsListAsPerLocation_V2670(string connectionString, string IdCompanies)
        {
            List<Responsible> responsibleList = new List<Responsible>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetParticipantsListAsPerLocation_V2670", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdCompanyLocation", IdCompanies);
                    mySqlCommand.CommandTimeout = 6000;

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        #region MyRegion
                        while (rdr.Read())
                        {
                            Responsible responsible = new Responsible();
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                responsible.IdEmployee = Convert.ToUInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                responsible.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                responsible.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                responsible.LastName = Convert.ToString(rdr["LastName"]);
                                responsible.FullName = responsible.FirstName + " " + responsible.LastName;
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                responsible.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                responsible.EmployeeCodeWithIdGender = responsible.EmployeeCode + "_" + responsible.IdGender;
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                responsible.IdOrganizationCode = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["OrganizationCode"] != DBNull.Value)
                            {
                                responsible.Organization = Convert.ToString(rdr["OrganizationCode"]);
                            }
                            if (rdr["IdEmployeeStatus"] != DBNull.Value)
                            {
                                responsible.IdEmployeeStatus = Convert.ToInt16(rdr["IdEmployeeStatus"]);
                            }
                            if (rdr["JobCode"] != DBNull.Value)
                            {
                                responsible.JobCode = Convert.ToString(rdr["JobCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                responsible.IdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["Login"] != DBNull.Value)
                            {
                                responsible.UserName = Convert.ToString(rdr["Login"]);
                            }
                            if (rdr["ResponsibleDisplayName"] != DBNull.Value)
                            {
                                responsible.ResponsibleDisplayName = Convert.ToString(rdr["ResponsibleDisplayName"]);
                            }
                            if (rdr["JobDescriptionTitle"] != DBNull.Value)
                            {
                                responsible.JobDescriptionTitle = Convert.ToString(rdr["JobDescriptionTitle"]);
                            }

                            responsibleList.Add(responsible);
                        }
                        #endregion
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetParticipantsListAsPerLocation_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return responsibleList;
        }
        //[shweta.thube][GEOS2-9273][08.09.2025]
        public bool AddImportedActionPlanDetails_V2670(string connectionString, APMActionPlan actionPlan)
        {
            bool isAdded = false;
            try
            {
                if (actionPlan != null)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("APM_AddImportActionPlanDetails_V2670", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_Code", actionPlan.Code);
                            mySqlCommand.Parameters.AddWithValue("_Description", actionPlan.Description);
                            mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlan.IdCompany);
                            mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlan.IdEmployee);
                            mySqlCommand.Parameters.AddWithValue("_IdOrigin", actionPlan.IdLookupOrigin);
                            mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlan.IdLookupBusinessUnit);
                            mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlan.CreatedBy);
                            mySqlCommand.Parameters.AddWithValue("_IdDepartment", actionPlan.IdDepartment);
                            mySqlCommand.Parameters.AddWithValue("_OriginDescription", actionPlan.OriginDescription);
                            if (actionPlan.IdCustomer == 0)
                                mySqlCommand.Parameters.AddWithValue("_IdSite", null);
                            else
                                mySqlCommand.Parameters.AddWithValue("_IdSite", actionPlan.IdCustomer);
                            actionPlan.IdActionPlan = Convert.ToInt64(mySqlCommand.ExecuteScalar());
                            mySqlConnection.Close();
                        }

                        if (actionPlan.ActionPlanLogEntries != null && actionPlan.ActionPlanLogEntries.Count > 0)
                        {
                            if (actionPlan.IdActionPlan > 0)
                            {
                                actionPlan.ActionPlanLogEntries.ToList().ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                                AddLogEntriesByActionPlan_V2580(connectionString, actionPlan.ActionPlanLogEntries);
                            }
                        }

                        #region [rdixit][Commented code as per pedro request]
                        if (actionPlan.TaskList != null && actionPlan.TaskList.Count > 0)
                        {
                            foreach (var actionPlanTask in actionPlan.TaskList)
                            {
                                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                                {
                                    mySqlConnection.Open();

                                    MySqlCommand mySqlCommand = new MySqlCommand("APM_AddImportTaskForActionPlan_V2670", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;

                                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlan.IdActionPlan);
                                    mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                                    mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                                    mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                                    mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                                    mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                                    mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                                    mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                                    mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                                    mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                                    mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlanTask.CreatedBy);
                                    mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                                    mySqlCommand.Parameters.AddWithValue("_ClosedBy", actionPlanTask.ClosedBy);
                                    mySqlCommand.Parameters.AddWithValue("_IdOTItem", actionPlanTask.IdOTItem == 0 ? (object)DBNull.Value : actionPlanTask.IdOTItem);
                                    mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                    if (actionPlanTask.IdDelegated > 0)
                                    {
                                        mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                                    }
                                    else
                                    {
                                        mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                                    }
                                    mySqlCommand.Parameters.AddWithValue("_Description", actionPlanTask.Description);
                                    mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                                    actionPlanTask.IdActionPlanTask = Convert.ToUInt32(mySqlCommand.ExecuteScalar());
                                    actionPlanTask.IdActionPlan = actionPlan.IdActionPlan;
                                    mySqlConnection.Close();

                                }

                                if (actionPlanTask.ActionPlanLogEntries != null && actionPlanTask.ActionPlanLogEntries.Count > 0)
                                {
                                    if (actionPlanTask.IdActionPlan > 0)
                                    {
                                        actionPlanTask.ActionPlanLogEntries.ToList().ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                                        AddLogEntriesByActionPlan_V2580(connectionString, actionPlanTask.ActionPlanLogEntries);
                                    }
                                }

                                // 2. Insert subtasks linked to this parent
                                foreach (var subtask in actionPlanTask.SubTaskList)
                                {
                                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                                    {
                                        mySqlConnection.Open();

                                        MySqlCommand subCmd = new MySqlCommand("APM_AddImportSubTaskForActionPlan_V2670", mySqlConnection);
                                        subCmd.CommandType = CommandType.StoredProcedure;

                                        subCmd.Parameters.AddWithValue("_IdParent", actionPlanTask.IdActionPlanTask); // ✅ link to parent
                                        subCmd.Parameters.AddWithValue("_IdActionPlan", actionPlan.IdActionPlan);
                                        subCmd.Parameters.AddWithValue("_TaskNumber", subtask.TaskNumber);
                                        subCmd.Parameters.AddWithValue("_Title", subtask.Title);
                                        subCmd.Parameters.AddWithValue("_IdLocation", subtask.IdCompany);
                                        subCmd.Parameters.AddWithValue("_IdResponsibleEmployee", subtask.IdEmployee);
                                        subCmd.Parameters.AddWithValue("_IdStatus", subtask.IdLookupStatus);
                                        subCmd.Parameters.AddWithValue("_IdPriority", subtask.IdLookupPriority);
                                        subCmd.Parameters.AddWithValue("_IdTheme", subtask.IdLookupTheme);
                                        subCmd.Parameters.AddWithValue("_DueDate", subtask.DueDate);
                                        subCmd.Parameters.AddWithValue("_DelegatedTo", subtask.IdDelegated);
                                        subCmd.Parameters.AddWithValue("_DelegatedIn", subtask.IdDelegated > 0 ? DateTime.Now : (object)DBNull.Value);
                                        subCmd.Parameters.AddWithValue("_Progress", subtask.Progress);
                                        subCmd.Parameters.AddWithValue("_CloseDate", subtask.CloseDate);
                                        subCmd.Parameters.AddWithValue("_CreatedBy", subtask.CreatedBy);
                                        subCmd.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                        subCmd.Parameters.AddWithValue("_Description", subtask.Description);
                                        subCmd.Parameters.AddWithValue("_ClosedBy", subtask.ClosedBy);
                                        subCmd.Parameters.AddWithValue("_IdOTItem", subtask.IdOTItem == 0 ? (object)DBNull.Value : subtask.IdOTItem);

                                        subtask.IdActionPlanTask = Convert.ToUInt32(subCmd.ExecuteScalar());

                                        mySqlConnection.Close();
                                    }

                                    // ✅ Add log entries for subtask
                                    if (subtask.ActionPlanLogEntries != null && subtask.ActionPlanLogEntries.Count > 0)
                                    {
                                        subtask.ActionPlanLogEntries.ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                                        AddLogEntriesByActionPlan_V2580(connectionString, subtask.ActionPlanLogEntries);
                                    }

                                }
                            }
                            #endregion

                            transactionScope.Complete();
                            transactionScope.Dispose();
                            isAdded = true;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddImportedActionPlanDetails_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isAdded;
        }
        //[shweta.thube][GEOS2-9273][08.09.2025]
        public bool UpdateImportedActionPlan_V2670(string connectionString, APMActionPlan actionPlan)
        {
            bool isUpdated = false;
            try
            {
                if (actionPlan != null)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateImportedActionPlan_V2670", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlan.IdActionPlan);
                            mySqlCommand.Parameters.AddWithValue("_Description", actionPlan.Description);
                            mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlan.IdCompany);
                            mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlan.IdEmployee);
                            mySqlCommand.Parameters.AddWithValue("_IdOrigin", actionPlan.IdLookupOrigin);
                            mySqlCommand.Parameters.AddWithValue("_ModifiedBy", actionPlan.ModifiedBy);
                            mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlan.IdLookupBusinessUnit);
                            mySqlCommand.Parameters.AddWithValue("_IdDepartment", actionPlan.IdDepartment);
                            mySqlCommand.Parameters.AddWithValue("_OriginDescription", actionPlan.OriginDescription);
                            mySqlCommand.Parameters.AddWithValue("_IdSite", actionPlan.IdSite == 0 ? (object)DBNull.Value : actionPlan.IdSite);


                            mySqlCommand.ExecuteNonQuery();
                            mySqlConnection.Close();


                        }
                        if (actionPlan.ActionPlanLogEntries != null && actionPlan.ActionPlanLogEntries.Count > 0)
                        {
                            AddLogEntriesByActionPlan_V2580(connectionString, actionPlan.ActionPlanLogEntries);
                        }
                        if (actionPlan.TaskList != null && actionPlan.TaskList.Count > 0)
                        {
                            foreach (var actionPlanTask in actionPlan.TaskList)
                            {
                                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                                {
                                    mySqlConnection.Open();

                                    MySqlCommand mySqlCommand = new MySqlCommand("APM_AddImportTaskForActionPlan_V2670", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;

                                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlan.IdActionPlan);
                                    mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                                    mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                                    mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                                    mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                                    mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                                    mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                                    mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                                    mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                                    mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                                    mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlanTask.CreatedBy);
                                    mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                                    mySqlCommand.Parameters.AddWithValue("_ClosedBy", actionPlanTask.ClosedBy);
                                    mySqlCommand.Parameters.AddWithValue("_IdOTItem", actionPlanTask.IdOTItem == 0 ? (object)DBNull.Value : actionPlanTask.IdOTItem);
                                    mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                    if (actionPlanTask.IdDelegated > 0)
                                    {
                                        mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                                    }
                                    else
                                    {
                                        mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                                    }
                                    mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                                    mySqlCommand.Parameters.AddWithValue("_Description", actionPlanTask.Description);

                                    actionPlanTask.IdActionPlanTask = Convert.ToUInt32(mySqlCommand.ExecuteScalar());
                                    actionPlanTask.IdActionPlan = actionPlan.IdActionPlan;
                                    mySqlConnection.Close();

                                }

                                if (actionPlanTask.ActionPlanLogEntries != null && actionPlanTask.ActionPlanLogEntries.Count > 0)
                                {
                                    if (actionPlanTask.IdActionPlan > 0)
                                    {
                                        actionPlanTask.ActionPlanLogEntries.ToList().ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                                        AddLogEntriesByActionPlan_V2580(connectionString, actionPlanTask.ActionPlanLogEntries);
                                    }
                                }

                                // 2. Insert subtasks linked to this parent
                                foreach (var subtask in actionPlanTask.SubTaskList)
                                {
                                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                                    {
                                        mySqlConnection.Open();

                                        MySqlCommand subCmd = new MySqlCommand("APM_AddImportSubTaskForActionPlan_V2670", mySqlConnection);
                                        subCmd.CommandType = CommandType.StoredProcedure;

                                        subCmd.Parameters.AddWithValue("_IdParent", actionPlanTask.IdActionPlanTask); // ✅ link to parent
                                        subCmd.Parameters.AddWithValue("_IdActionPlan", actionPlan.IdActionPlan);
                                        subCmd.Parameters.AddWithValue("_TaskNumber", subtask.TaskNumber);
                                        subCmd.Parameters.AddWithValue("_Title", subtask.Title);
                                        subCmd.Parameters.AddWithValue("_IdLocation", subtask.IdCompany);
                                        subCmd.Parameters.AddWithValue("_IdResponsibleEmployee", subtask.IdEmployee);
                                        subCmd.Parameters.AddWithValue("_IdStatus", subtask.IdLookupStatus);
                                        subCmd.Parameters.AddWithValue("_IdPriority", subtask.IdLookupPriority);
                                        subCmd.Parameters.AddWithValue("_IdTheme", subtask.IdLookupTheme);
                                        subCmd.Parameters.AddWithValue("_DueDate", subtask.DueDate);
                                        subCmd.Parameters.AddWithValue("_DelegatedTo", subtask.IdDelegated);
                                        subCmd.Parameters.AddWithValue("_DelegatedIn", subtask.IdDelegated > 0 ? DateTime.Now : (object)DBNull.Value);
                                        subCmd.Parameters.AddWithValue("_Progress", subtask.Progress);
                                        subCmd.Parameters.AddWithValue("_CloseDate", subtask.CloseDate);
                                        subCmd.Parameters.AddWithValue("_CreatedBy", subtask.CreatedBy);
                                        subCmd.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                        subCmd.Parameters.AddWithValue("_Description", subtask.Description);
                                        subCmd.Parameters.AddWithValue("_ClosedBy", subtask.ClosedBy);
                                        subCmd.Parameters.AddWithValue("_IdOTItem", subtask.IdOTItem == 0 ? (object)DBNull.Value : subtask.IdOTItem);

                                        subtask.IdActionPlanTask = Convert.ToUInt32(subCmd.ExecuteScalar());

                                        mySqlConnection.Close();
                                    }

                                    // ✅ Add log entries for subtask
                                    if (subtask.ActionPlanLogEntries != null && subtask.ActionPlanLogEntries.Count > 0)
                                    {
                                        subtask.ActionPlanLogEntries.ForEach(x => x.IdActionPlan = actionPlan.IdActionPlan);
                                        AddLogEntriesByActionPlan_V2580(connectionString, subtask.ActionPlanLogEntries);
                                    }

                                }
                            }
                            transactionScope.Complete();
                            transactionScope.Dispose();
                            isUpdated = true;
                        }
                    }


                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateImportedActionPlan_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }
        //[shweta.thube][GEOS2-9273][08.09.2025]
        public APMActionPlan GetActionPlanInfoByIdActionPlan_V2670(string connectionString, Int64 idActionplan)
        {
            APMActionPlan actionPlan = new APMActionPlan();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanInfoByIdActionPlan_V2670", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdActionplan", idActionplan);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.Country.Iso + ".png";
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                actionPlan.ResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.IdLookupBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                            }
                            if (rdr["BusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }
                            if (rdr["BusinessUnitHtmlColor"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHtmlColor"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                actionPlan.CreatedBy = Convert.ToInt16(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                actionPlan.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                actionPlan.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["IdDepartment"] != DBNull.Value)
                            {
                                actionPlan.IdDepartment = Convert.ToInt32(rdr["IdDepartment"]);
                                actionPlan.Department = Convert.ToString(rdr["Department"]);
                            }
                            if (rdr["OriginDescription"] != DBNull.Value)
                            {
                                actionPlan.OriginDescription = Convert.ToString(rdr["OriginDescription"]);
                            }
                            if (rdr["ActionPlanResponsibleDisplayName"] != DBNull.Value)
                            {
                                actionPlan.ActionPlanResponsibleDisplayName = Convert.ToString(rdr["ActionPlanResponsibleDisplayName"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                actionPlan.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                actionPlan.Group = Convert.ToString(rdr["CustomerName"]);
                            }

                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                actionPlan.Site = Convert.ToString(rdr["SiteName"]);
                                actionPlan.GroupName = actionPlan.Group + " " + "(" + actionPlan.Site + ")";
                            }
                            if (rdr["IdZone"] != DBNull.Value)
                            {
                                actionPlan.IdZone = Convert.ToInt32(rdr["IdZone"]);
                            }
                            if (rdr["Region"] != DBNull.Value)
                            {
                                actionPlan.Zone = Convert.ToString(rdr["Region"]);
                            }
                            if (rdr["NextTaskNumber"] != DBNull.Value)
                            {
                                actionPlan.MaxTaskNumber = Convert.ToInt32(rdr["NextTaskNumber"]);
                            }
                        }
                    }

                    con.Close();
                }

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetailsByIdActionPlan_V2660(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlan;
        }
        #region  //[shweta.thube][GEOS2-6048][03.09.2025]
        public APMActionPlanTask GetNewMonthlyTasksRegisteredCount_V2670(string connectionString, DateTime startDate, string idLocations)
        {
            APMActionPlanTask task = new APMActionPlanTask();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetNewMonthlyTasksRegisteredCount_V2670", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_StartDate", startDate);
                    mySqlCommand.Parameters.AddWithValue("_IdLocation", idLocations);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            if (rdr["TotalTaskCount"] != DBNull.Value)
                            {
                                task.TotalTaskCount = Convert.ToInt32(rdr["TotalTaskCount"]);
                            }
                        }
                    }
                    con.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetNewMonthlyTasksRegisteredCount_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return task;
        }

        public APMActionPlanTask GetReportPerPlantOpenTaskCount_V2670(string connectionString, DateTime fromDate, string idLocations)
        {
            APMActionPlanTask task = new APMActionPlanTask();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetReportPerPlantOpenTaskCount_V2670", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_StartDate", fromDate);
                    mySqlCommand.Parameters.AddWithValue("_IdLocation", idLocations);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            if (rdr["OpenTaskCount"] != DBNull.Value)
                            {
                                task.OpenStatusTaskCount = Convert.ToInt32(rdr["OpenTaskCount"]);
                            }
                            if (rdr["ClosedTaskCount"] != DBNull.Value)
                            {
                                task.ClosedTaskCount = Convert.ToInt32(rdr["ClosedTaskCount"]);
                            }
                            if (rdr["TotalTaskCount"] != DBNull.Value)
                            {
                                task.TotalTaskCount = Convert.ToInt32(rdr["TotalTaskCount"]);
                            }
                        }
                    }
                    con.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetReportPerPlantOpenTaskCount_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return task;
        }

        public ReportPerPlant GetReportPerPlantCreatedAndPendingTasks_V2670(string connectionString, DateTime fromDate, string idLocations)
        {
            ReportPerPlant task = new ReportPerPlant();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetReportPerPlantCreatedAndPendingTasks_V2670", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_StartDate", fromDate);
                    mySqlCommand.Parameters.AddWithValue("_IdLocation", idLocations);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            if (rdr["OpenTaskCount"] != DBNull.Value)
                            {
                                task.OpenTaskCount = Convert.ToString(rdr["OpenTaskCount"]);
                            }
                            if (rdr["PendingTaskCount"] != DBNull.Value)
                            {
                                task.PendingTaskCount = Convert.ToInt32(rdr["PendingTaskCount"]);
                            }

                        }
                    }
                    con.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetReportPerPlantCreatedAndPendingTasks_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return task;
        }

        public List<ReportPerPlant> GetReportPerPlantYearlyProgress_V2670(string connectionString, string idLocations)
        {
            List<ReportPerPlant> taskList = new List<ReportPerPlant>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetReportPerPlantYearlyProgress_V2670", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdLocation", idLocations);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            ReportPerPlant reportPerPlant = new ReportPerPlant();

                            if (rdr["Year"] != DBNull.Value)
                            {
                                reportPerPlant.Year = Convert.ToString(rdr["Year"]);
                            }
                            if (rdr["IssuesResolved"] != DBNull.Value)
                            {
                                reportPerPlant.IssuesResolved = Convert.ToInt32(rdr["IssuesResolved"]);
                            }
                            if (rdr["OpenIssues"] != DBNull.Value)
                            {
                                reportPerPlant.OpenIssues = Convert.ToInt32(rdr["OpenIssues"]);
                            }
                            if (rdr["TasksCreated"] != DBNull.Value)
                            {
                                reportPerPlant.TasksCreated = Convert.ToInt32(rdr["TasksCreated"]);
                            }
                            taskList.Add(reportPerPlant);
                        }
                    }
                    con.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetReportPerPlantYearlyProgress_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }

        public List<ReportPerPlant> GetReportPerPlantMonthWithYearProgress_V2670(string connectionString, DateTime startDate, string idLocations)
        {
            List<ReportPerPlant> task = new List<ReportPerPlant>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetReportPerPlantMonthWithYearProgress_V2670", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_StartDate", startDate);
                    mySqlCommand.Parameters.AddWithValue("_IdLocation", idLocations);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            ReportPerPlant reportPerPlant = new ReportPerPlant();
                            if (rdr["Month"] != DBNull.Value)
                            {
                                reportPerPlant.Year = Convert.ToString(rdr["Month"]);
                            }
                            if (rdr["IssuesResolved"] != DBNull.Value)
                            {
                                reportPerPlant.IssuesResolved = Convert.ToInt32(rdr["IssuesResolved"]);
                            }
                            if (rdr["OpenIssues"] != DBNull.Value)
                            {
                                reportPerPlant.OpenIssues = Convert.ToInt32(rdr["OpenIssues"]);
                            }
                            if (rdr["TasksCreated"] != DBNull.Value)
                            {
                                reportPerPlant.TasksCreated = Convert.ToInt32(rdr["TasksCreated"]);
                            }
                            if (rdr["CumulativeTasksResolved"] != DBNull.Value)
                            {
                                reportPerPlant.CumulativeTasksResolved = Convert.ToInt32(rdr["CumulativeTasksResolved"]);
                            }
                            if (rdr["CumulativeTasksCreated"] != DBNull.Value)
                            {
                                reportPerPlant.CumulativeTasksCreated = Convert.ToInt32(rdr["CumulativeTasksCreated"]);
                            }
                            task.Add(reportPerPlant);
                        }
                    }
                    con.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetReportPerPlantMonthWithYearProgress_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return task;
        }

        public List<ReportPerPlant> GetTasksCountByTheme_V2670(string connectionString, DateTime StartDate, string idLocations)
        {
            List<ReportPerPlant> TaskCount = new List<ReportPerPlant>();

            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {

                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();
                        MySqlCommand mySqlCommand = new MySqlCommand("APM_GetTasksCountByTheme_V2670", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_StartDate", StartDate);
                        mySqlCommand.Parameters.AddWithValue("_IdLocations", idLocations);
                        using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                try
                                {
                                    ReportPerPlant statusCount = new ReportPerPlant();

                                    if (reader["ToDoCount"] != DBNull.Value)
                                    {
                                        statusCount.ToDo = Convert.ToString(reader["ToDoCount"]);
                                    }
                                    if (reader["InProgressCount"] != DBNull.Value)
                                    {
                                        statusCount.InProgress = Convert.ToString(reader["InProgressCount"]);
                                    }
                                    if (reader["Theme"] != DBNull.Value)
                                    {
                                        statusCount.Theme = Convert.ToString(reader["Theme"]);
                                    }
                                    if (reader["TotalCount"] != DBNull.Value)
                                    {
                                        statusCount.TotalNumberOfTasks = Convert.ToString(reader["TotalCount"]);
                                    }
                                    TaskCount.Add(statusCount);
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetTasksCountByTheme_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                                }
                            }
                        }

                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                }

                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();



                    Log4NetLogger.Logger.Log(string.Format("Error GetTasksCountByTheme_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    throw;
                }
                return TaskCount;
            }
        }
        //[shweta.thube][GEOS2-8695][22.09.2025]
        public List<APMActionPlanTask> GetTaskListByIdActionPlan_V2670(string connectionString, Int64 IdActionPlan, string selectedPeriod, Int32 idUser)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetTaskListByIdActionPlan_V2670", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }

                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }
                            if (rdr["IdOTItem"] != DBNull.Value)
                            {
                                task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                            }
                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                task.IdOT = Convert.ToInt64(rdr["IdOT"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.OTCode = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                            {
                                task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                            }
                            if (rdr["Participant"] != DBNull.Value)
                            {
                                string participantString = rdr["Participant"].ToString();
                                task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                            }
                            if (rdr["IdParent"] != DBNull.Value)
                            {
                                task.IdParent = Convert.ToInt64(rdr["IdParent"]);
                            }
                            taskList.Add(task);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdParent"] != DBNull.Value)
                                {
                                    APMActionPlanTask actionPlanSubTask = taskList.FirstOrDefault(x => x.IdActionPlanTask == Convert.ToInt64(rdr["IdParent"]));

                                    if (actionPlanSubTask != null)
                                    {
                                        if (actionPlanSubTask.SubTaskList == null)
                                        {
                                            actionPlanSubTask.SubTaskList = new List<APMActionPlanSubTask>();
                                        }

                                        APMActionPlanSubTask subTask = new APMActionPlanSubTask();
                                        subTask.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            subTask.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            subTask.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            subTask.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            subTask.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            subTask.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            subTask.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            subTask.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            subTask.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            subTask.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            subTask.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            subTask.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            subTask.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            subTask.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            subTask.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            subTask.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo = new Responsible();
                                            subTask.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            subTask.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            subTask.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            subTask.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            subTask.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            subTask.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            subTask.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            subTask.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            subTask.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            subTask.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            subTask.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            subTask.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            subTask.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            subTask.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            subTask.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            subTask.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            subTask.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            subTask.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            subTask.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }

                                        if (subTask.DueDate != subTask.OriginalDueDate)
                                        {
                                            subTask.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            subTask.IsShowIcon = false;
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            subTask.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            subTask.IdOT = Convert.ToInt64(rdr["IdOT"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            subTask.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            subTask.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            subTask.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            subTask.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["ParentTaskNumber"] != DBNull.Value)
                                        {
                                            subTask.ParentTaskNumber = Convert.ToInt64(rdr["ParentTaskNumber"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.SubTaskNumber = Convert.ToInt64(rdr["TaskNumber"]);
                                            subTask.SubTaskCode = subTask.ParentTaskNumber + "." + subTask.SubTaskNumber;
                                        }
                                        actionPlanSubTask.SubTaskList.Add(subTask);
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTaskListByIdActionPlan_V2670(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }
        #endregion
        //[Shweta.Thube][GEOS2-9618][29-10-2025]
        public List<APMActionPlanTask> GetResponsibleListForEmailNotification_V2680(string connectionString, Int64 IdActionPlan, string selectedPeriod, Int32 idUser)
        {
            List<APMActionPlanTask> responsibleListForEmailNotification = new List<APMActionPlanTask>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetResponsibleListForEmailNotification_V2680", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask responsible = new APMActionPlanTask();

                            if (rdr["EmployeeName"] != DBNull.Value)
                            {
                                responsible.Responsible = Convert.ToString(rdr["EmployeeName"]);
                            }
                            if (rdr["OpenTaskCount"] != DBNull.Value)
                            {
                                responsible.OpenTaskCount = Convert.ToString(rdr["OpenTaskCount"]);
                                string Lable = Convert.ToString(rdr["TaskSubtaskLabel"]);
                                responsible.ResponsibleWithTaskCount = $"{responsible.Responsible} - [{Lable}]";

                            }
                            if (rdr["OpenSubtaskCount"] != DBNull.Value)
                            {
                                responsible.OpenSubtaskCount = Convert.ToString(rdr["OpenSubtaskCount"]);
                            }
                            if (rdr["IdResponsibleEmployee"] != DBNull.Value)
                            {
                                responsible.IdEmployee = Convert.ToInt32(rdr["IdResponsibleEmployee"]);
                            }
                            if (rdr["MostRecentDate"] != DBNull.Value && !string.IsNullOrWhiteSpace(rdr["MostRecentDate"].ToString()))
                            {
                                if (DateTime.TryParse(rdr["MostRecentDate"].ToString(), out DateTime dt))
                                    responsible.SentDateTime = dt;
                                else
                                    responsible.SentDateTime = null; // or handle invalid format case
                            }
                            else
                            {
                                responsible.SentDateTime = null;
                            }

                            if (rdr["CompanyEmail"] != DBNull.Value)
                            {
                                responsible.CompanyEmail = Convert.ToString(rdr["CompanyEmail"]);
                            }
                            responsibleListForEmailNotification.Add(responsible);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdResponsibleEmployee"] != DBNull.Value)
                                {
                                    APMActionPlanTask responsible = responsibleListForEmailNotification.FirstOrDefault(x => x.IdEmployee == Convert.ToInt32(rdr["IdEmployee"]));
                                    if (responsible != null)
                                    {
                                        if (responsible.EmailTaskDetailsList == null)
                                        {
                                            responsible.EmailTaskDetailsList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);
                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumberLable = Convert.ToString(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            task.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["ActionPlanCode"] != DBNull.Value)
                                        {
                                            task.Code = Convert.ToString(rdr["ActionPlanCode"]);
                                        }
                                        if (rdr["PriorityHTMLColor"] != DBNull.Value)
                                        {
                                            task.PriorityHTMLColor = Convert.ToString(rdr["PriorityHTMLColor"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        responsible.EmailTaskDetailsList.Add(task);
                                    }
                                }

                            }

                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdResponsibleEmployee"] != DBNull.Value)
                                {
                                    APMActionPlanTask responsible = responsibleListForEmailNotification.FirstOrDefault(x => x.IdEmployee == Convert.ToInt32(rdr["IdEmployee"]));
                                    if (responsible != null)
                                    {
                                        if (responsible.EmailTaskDetailsList == null)
                                        {
                                            responsible.EmailTaskDetailsList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);
                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            task.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["SubTaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumberLable = Convert.ToString(rdr["SubTaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            task.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["ActionPlanCode"] != DBNull.Value)
                                        {
                                            task.Code = Convert.ToString(rdr["ActionPlanCode"]);
                                        }
                                        if (rdr["PriorityHTMLColor"] != DBNull.Value)
                                        {
                                            task.PriorityHTMLColor = Convert.ToString(rdr["PriorityHTMLColor"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        responsible.EmailTaskDetailsList.Add(task);
                                    }
                                }

                            }

                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetResponsibleListForEmailNotification_V2680(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return responsibleListForEmailNotification;
        }
        //[Shweta.Thube][GEOS2-9129][09-10-2025]
        public bool APMEmailSend_V2680(string emailto, string sub, string emailbody, string MailServerName, string MailServerPort, Dictionary<string, byte[]> attachments, string EmailFrom, List<string> ccAddress)
        {
            Log4NetLogger.Logger.Log(string.Format("[INFO] APMEmailSend_V2680......"), category: Category.Info, priority: Priority.Low);
            try
            {

                MailControl.SendHtmlMailWithccAndMultipleAttachment(sub, emailbody.ToString(), emailto, ccAddress, EmailFrom, MailServerName, MailServerPort, attachments);
                return true;
                Log4NetLogger.Logger.Log(string.Format("[INFO] Supplier email sent to email - {0}", emailto), category: Category.Info, priority: Priority.Low);
            }

            catch (System.Net.Mail.SmtpFailedRecipientException ex)
            {
                Log4NetLogger.Logger.Log(string.Format("[ERROR] APMEmailSend_V2680() in MailControl.SendHtmlMail-SmtpFailedRecipient - {0} - {1}", ex.FailedRecipient, ex.Message), category: Category.Exception, priority: Priority.Low);
                return false;
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("[ERROR] APMEmailSend_V2680() in MailControl.SendHtmlMail - {1}", ex.Message), category: Category.Exception, priority: Priority.Low);
                return false;
            }
        }
        #region connection methods

        /// <summary>
        /// This method is used to get connection string name exists or not by name.
        /// </summary>
        public bool IsConnectionStringNameExist(string Name)
        {
            bool isExist = false;
            ConnectionStringSettingsCollection settings = ConfigurationManager.ConnectionStrings;
            if (settings != null)
            {
                foreach (ConnectionStringSettings cs in settings)
                {
                    if (cs.Name == Name)
                    {
                        isExist = true;
                        return isExist;
                    }
                }
            }
            return isExist;
        }

        #endregion
        //[Shweta.Thube][GEOS2-9129][09-10-2025]
        public bool UpdateSendDateTime_V2680(string connectionString, APMActionPlanTask apmActionPlanTask)
        {
            bool isUpdated = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();
                        foreach(APMActionPlanTask item in apmActionPlanTask.EmailTaskDetailsList)
                        {
                            MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateSendDateTime_V2680", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;

                            mySqlCommand.Parameters.AddWithValue("_IdActionPlanTask", item.IdActionPlanTask);
                            mySqlCommand.Parameters.AddWithValue("_IdActionPlan", item.IdActionPlan);
                            mySqlCommand.Parameters.AddWithValue("_IdEmployee", item.IdEmployee);
                            mySqlCommand.ExecuteNonQuery();
                        }
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isUpdated = true;
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateSendDateTime_V2680(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }
        
        //[pallavi.kale][GEOS2-9000][28.10.2025]
        public List<APMActionPlanTask> GetActionPlanTaskDetails_V2680(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanTaskDetails_V2680", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                task.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["ActionDescription"] != DBNull.Value)
                            {
                                task.ActionPlanDescription = Convert.ToString(rdr["ActionDescription"]);
                            }
                            if (rdr["IdOrigin"] != DBNull.Value)
                            {
                                task.IdOrigin = Convert.ToInt32(rdr["IdOrigin"]);
                                task.TaskOrigin = Convert.ToString(rdr["TaskOrigin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                task.IdBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                                task.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                            {
                                task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                            }
                            if (rdr["DelegatedDisplayName"] != DBNull.Value)
                            {
                                task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                            }


                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }

                            if (rdr["Country"] != DBNull.Value)
                            {
                                task.Country = new Country();
                                task.Country.Name = Convert.ToString(rdr["Country"]);
                                task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                task.ActionPlanResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }

                            if (rdr["IdOTItem"] != DBNull.Value)
                            {
                                task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                            }
                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                task.IdOT = Convert.ToInt64(rdr["IdOT"]);
                            }
                            if (rdr["OTCode"] != DBNull.Value)
                            {
                                task.OTCode = Convert.ToString(rdr["OTCode"]);
                            }
                            if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                            {
                                task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                            }
                            if (rdr["Participant"] != DBNull.Value)
                            {
                                string participantString = rdr["Participant"].ToString();
                                task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                task.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["IdParent"] != DBNull.Value)
                            {
                                task.IdParent = Convert.ToInt64(rdr["IdParent"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                task.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                task.Group = Convert.ToString(rdr["CustomerName"]);
                            }

                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                task.Site = Convert.ToString(rdr["SiteName"]);
                                task.GroupName = task.Group + " " + "(" + task.Site + ")";
                            }
                            if (rdr["OriginWeek"] != DBNull.Value)
                            {
                                task.OriginWeek = Convert.ToString(rdr["OriginWeek"]);
                            }

                            taskList.Add(task);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdParent"] != DBNull.Value)
                                {
                                    APMActionPlanTask actionPlanSubTask = taskList.FirstOrDefault(x => x.IdActionPlanTask == Convert.ToInt64(rdr["IdParent"]));

                                    if (actionPlanSubTask != null)
                                    {
                                        if (actionPlanSubTask.SubTaskList == null)
                                        {
                                            actionPlanSubTask.SubTaskList = new List<APMActionPlanSubTask>();
                                        }

                                        APMActionPlanSubTask subTask = new APMActionPlanSubTask();

                                        if (rdr["IdActionPlan"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            subTask.Code = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["ActionDescription"] != DBNull.Value)
                                        {
                                            subTask.ActionPlanDescription = Convert.ToString(rdr["ActionDescription"]);
                                        }
                                        if (rdr["IdOrigin"] != DBNull.Value)
                                        {
                                            subTask.IdOrigin = Convert.ToInt32(rdr["IdOrigin"]);
                                            subTask.TaskOrigin = Convert.ToString(rdr["TaskOrigin"]);
                                        }
                                        if (rdr["IdBusinessUnit"] != DBNull.Value)
                                        {
                                            subTask.IdBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                                            subTask.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                                        }

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            subTask.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            subTask.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            subTask.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            subTask.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            subTask.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            subTask.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            subTask.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            subTask.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            subTask.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            subTask.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            subTask.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            subTask.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            subTask.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            subTask.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            subTask.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo = new Responsible();
                                            subTask.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            subTask.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            subTask.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            subTask.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            subTask.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            subTask.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            subTask.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            subTask.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            subTask.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            subTask.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            subTask.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            subTask.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            subTask.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            subTask.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            subTask.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            subTask.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            subTask.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            subTask.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            subTask.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            subTask.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            subTask.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (subTask.DueDate != subTask.OriginalDueDate)
                                        {
                                            subTask.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            subTask.IsShowIcon = false;
                                        }

                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            subTask.Country = new Country();
                                            subTask.Country.Name = Convert.ToString(rdr["Country"]);
                                            subTask.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            subTask.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + subTask.Country.Iso + ".png";
                                        }
                                        if (rdr["IdUser"] != DBNull.Value)
                                        {
                                            subTask.ActionPlanResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                                        }

                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            subTask.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            subTask.IdOT = Convert.ToInt64(rdr["IdOT"]);
                                        }
                                        if (rdr["OTCode"] != DBNull.Value)
                                        {
                                            subTask.OTCode = Convert.ToString(rdr["OTCode"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            subTask.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            subTask.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;
                                        }
                                        if (rdr["FirstName"] != DBNull.Value)
                                        {
                                            subTask.FirstName = Convert.ToString(rdr["FirstName"]);
                                        }
                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            subTask.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["ParentTaskNumber"] != DBNull.Value)
                                        {
                                            subTask.ParentTaskNumber = Convert.ToInt64(rdr["ParentTaskNumber"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.SubTaskNumber = Convert.ToInt64(rdr["TaskNumber"]);
                                            subTask.SubTaskCode = subTask.ParentTaskNumber + "." + subTask.SubTaskNumber;
                                        }
                                        if (rdr["IdSite"] != DBNull.Value)
                                        {
                                            subTask.IdSite = Convert.ToInt32(rdr["IdSite"]);
                                        }
                                        if (rdr["CustomerName"] != DBNull.Value)
                                        {
                                            subTask.Group = Convert.ToString(rdr["CustomerName"]);
                                        }

                                        if (rdr["SiteName"] != DBNull.Value)
                                        {
                                            subTask.Site = Convert.ToString(rdr["SiteName"]);
                                            subTask.GroupName = subTask.Group + " " + "(" + subTask.Site + ")";
                                        }
                                        if (rdr["OriginWeek"] != DBNull.Value)
                                        {
                                            subTask.OriginWeek = Convert.ToString(rdr["OriginWeek"]);
                                        }
                                        actionPlanSubTask.SubTaskList.Add(subTask);
                                    }
                                }
                            }


                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanTaskDetails_V2680(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }



        //[pallavi.kale][GEOS2-8995][28.10.2025]
        public List<APMActionPlan> GetActionPlanDetails_V2680(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlan> actionPlanList = new List<APMActionPlan>();
            List<APMActionPlanTask> actionPlanTaskList = new List<APMActionPlanTask>();
            List<string> countryISOs = new List<string>();

            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_V2680", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlan actionPlan = new APMActionPlan();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.Country.Iso + ".png";
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                actionPlan.ResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.IdLookupBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                            }
                            if (rdr["BusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }
                            if (rdr["BusinessUnitHtmlColor"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHtmlColor"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                actionPlan.CreatedBy = Convert.ToInt16(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                actionPlan.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                actionPlan.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["IdDepartment"] != DBNull.Value)
                            {
                                actionPlan.IdDepartment = Convert.ToInt32(rdr["IdDepartment"]);
                                actionPlan.Department = Convert.ToString(rdr["Department"]);
                            }
                            if (rdr["OriginDescription"] != DBNull.Value)
                            {
                                actionPlan.OriginDescription = Convert.ToString(rdr["OriginDescription"]);
                            }
                            if (rdr["ActionPlanResponsibleDisplayName"] != DBNull.Value)
                            {
                                actionPlan.ActionPlanResponsibleDisplayName = Convert.ToString(rdr["ActionPlanResponsibleDisplayName"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                actionPlan.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                actionPlan.Group = Convert.ToString(rdr["CustomerName"]);
                            }

                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                actionPlan.Site = Convert.ToString(rdr["SiteName"]);
                                actionPlan.GroupName = actionPlan.Group + " " + "(" + actionPlan.Site + ")";
                            }
                            if (rdr["IdZone"] != DBNull.Value)
                            {
                                actionPlan.IdZone = Convert.ToInt32(rdr["IdZone"]);
                            }
                            if (rdr["Region"] != DBNull.Value)
                            {
                                actionPlan.Zone = Convert.ToString(rdr["Region"]);
                            }
                            actionPlanList.Add(actionPlan);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdActionPlan"] != DBNull.Value)
                                {
                                    APMActionPlan actionPlanTask = actionPlanList.FirstOrDefault(x => x.IdActionPlan == Convert.ToInt32(rdr["IdActionPlan"]));
                                    if (actionPlanTask != null)
                                    {
                                        if (actionPlanTask.TaskList == null)
                                        {
                                            actionPlanTask.TaskList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);
                                        if (rdr["IdActionPlan"] != DBNull.Value)
                                        {
                                            task.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                                        }
                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }

                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            task.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            task.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (task.DueDate != task.OriginalDueDate)
                                        {
                                            task.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            task.IsShowIcon = false;
                                        }
                                        task.Code = actionPlanTask.Code;
                                        task.ActionPlanDescription = actionPlanTask.Description;
                                        task.TaskOrigin = actionPlanTask.Origin;
                                        task.BusinessUnit = actionPlanTask.BusinessUnit;
                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            task.Country = new Country();
                                            task.Country.Name = Convert.ToString(rdr["Country"]);
                                            task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["NumItem"] != DBNull.Value)
                                        {
                                            task.NumItem = Convert.ToString(rdr["NumItem"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            task.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            task.IdOT = Convert.ToInt32(rdr["IdOT"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        if (rdr["FirstName"] != DBNull.Value)
                                        {
                                            task.FirstName = Convert.ToString(rdr["FirstName"]);
                                        }
                                        if (rdr["OriginWeek"] != DBNull.Value)
                                        {
                                            task.OriginWeek = Convert.ToString(rdr["OriginWeek"]);
                                        }
                                        actionPlanTask.TaskList.Add(task);
                                    }
                                }
                            }
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdParent"] != DBNull.Value)
                                {

                                    long parentId = Convert.ToInt64(rdr["IdParent"]);

                                    APMActionPlanTask actionPlanSubTask = actionPlanList
                                        .SelectMany(ap => ap.TaskList ?? new List<APMActionPlanTask>())
                                        .FirstOrDefault(t => t.IdActionPlanTask == parentId);
                                    if (actionPlanSubTask != null)
                                    {
                                        if (actionPlanSubTask.SubTaskList == null)
                                        {
                                            actionPlanSubTask.SubTaskList = new List<APMActionPlanSubTask>();
                                        }
                                        APMActionPlanSubTask subTask = new APMActionPlanSubTask();


                                        if (rdr["IdActionPlan"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                                        }
                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            subTask.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["ParentTaskNumber"] != DBNull.Value)
                                        {
                                            subTask.ParentTaskNumber = Convert.ToInt64(rdr["ParentTaskNumber"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.SubTaskNumber = Convert.ToInt64(rdr["TaskNumber"]);
                                            subTask.SubTaskCode = subTask.ParentTaskNumber + "." + subTask.SubTaskNumber;
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            subTask.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            subTask.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            subTask.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            subTask.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            subTask.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            subTask.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            subTask.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            subTask.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            subTask.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            subTask.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            subTask.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            subTask.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            subTask.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            subTask.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            subTask.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo = new Responsible();
                                            subTask.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            subTask.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            subTask.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            subTask.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            subTask.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            subTask.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            subTask.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            subTask.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            subTask.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            subTask.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            subTask.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            subTask.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            subTask.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            subTask.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            subTask.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            subTask.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            subTask.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            subTask.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            subTask.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            subTask.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            subTask.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (subTask.DueDate != subTask.OriginalDueDate)
                                        {
                                            subTask.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            subTask.IsShowIcon = false;
                                        }
                                        subTask.Code = actionPlanSubTask.Code;
                                        subTask.ActionPlanDescription = actionPlanSubTask.Description;
                                        subTask.TaskOrigin = actionPlanSubTask.Origin;
                                        subTask.BusinessUnit = actionPlanSubTask.BusinessUnit;
                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            subTask.Country = new Country();
                                            subTask.Country.Name = Convert.ToString(rdr["Country"]);
                                            subTask.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            subTask.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + subTask.Country.Iso + ".png";
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            subTask.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["NumItem"] != DBNull.Value)
                                        {
                                            subTask.NumItem = Convert.ToString(rdr["NumItem"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            subTask.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            subTask.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            subTask.IdOT = Convert.ToInt32(rdr["IdOT"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            subTask.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        if (rdr["OriginWeek"] != DBNull.Value)
                                        {
                                            subTask.OriginWeek = Convert.ToString(rdr["OriginWeek"]);
                                        }
                                        actionPlanSubTask.SubTaskList.Add(subTask);

                                    }
                                }
                            }
                        }
                    }
                }


                foreach (var item in actionPlanList)
                {
                    if (item.TotalActionItems != 0)
                    {
                        item.Percentage = (int)(((float)item.TotalClosedItems / item.TotalActionItems) * 100);
                    }
                    else
                    {
                        item.Percentage = 0;
                    }

                    if (item.Percentage <= 24)
                    {
                        item.TotalClosedColor = "Red";
                    }
                    else if (item.Percentage >= 25 && item.Percentage <= 49)
                    {
                        item.TotalClosedColor = "Orange";
                    }
                    else if (item.Percentage >= 50 && item.Percentage <= 74)
                    {
                        item.TotalClosedColor = "Yellow";
                    }
                    else if (item.Percentage >= 75 && item.Percentage <= 99)
                    {
                        item.TotalClosedColor = "LightGreen";
                    }
                    else if (item.Percentage == 100)
                    {
                        item.TotalClosedColor = "Green";
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2680(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanList;
        }

        public List<APMActionPlanModern> GetActionPlanDetails_WithCounts(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath, string filterAlert = null, string filterTheme = null)
        {
            List<APMActionPlanModern> actionPlanList = new List<APMActionPlanModern>();
            // Dicionários para montagem rápida da hierarquia
            var planDictionary = new Dictionary<long, APMActionPlanModern>();
            var taskDictionary = new Dictionary<long, APMActionPlanTask>();

            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_WithCounts", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);
                    // Novos Parâmetros de Filtro
                    mySqlCommand.Parameters.AddWithValue("_FilterAlertStatus", string.IsNullOrEmpty(filterAlert) ? (object)DBNull.Value : filterAlert);
                    mySqlCommand.Parameters.AddWithValue("_FilterTheme", string.IsNullOrEmpty(filterTheme) ? (object)DBNull.Value : filterTheme);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        // ==========================================================
                        // 1. LER ACTION PLANS (Tabela 0)
                        // ==========================================================
                        while (rdr.Read())
                        {
                            APMActionPlanModern actionPlan = new APMActionPlanModern();

                            // Mapeamento Básico
                            if (rdr["IdActionPlan"] != DBNull.Value) actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            if (rdr["Code"] != DBNull.Value) actionPlan.Code = Convert.ToString(rdr["Code"]);
                            if (rdr["Description"] != DBNull.Value) actionPlan.Description = Convert.ToString(rdr["Description"]);

                            // ... (Mapeamentos existentes de Location, Responsible, etc.) ...
                            if (rdr["IdCompany"] != DBNull.Value) actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            if (rdr["Location"] != DBNull.Value) actionPlan.Location = Convert.ToString(rdr["Location"]);
                            if (rdr["Responsible"] != DBNull.Value) actionPlan.Responsible = Convert.ToString(rdr["Responsible"]); else actionPlan.Responsible = string.Empty;

                            // Country & Icon
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.CountryName = Convert.ToString(rdr["Country"]);
                                actionPlan.CountryIso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.CountryIso + ".png";
                            }

                            // User Details
                            if (rdr["EmployeeCode"] != DBNull.Value) actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            if (rdr["IdUser"] != DBNull.Value) actionPlan.ResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            if (rdr["IdEmployee"] != DBNull.Value) actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            if (rdr["FirstName"] != DBNull.Value) actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            if (rdr["LastName"] != DBNull.Value) actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            if (rdr["IdGender"] != DBNull.Value) actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);

                            // Origin & Business Unit
                            if (rdr["IdLookupValue"] != DBNull.Value) actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            if (rdr["Origin"] != DBNull.Value) actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            if (rdr["IdBusinessUnit"] != DBNull.Value) actionPlan.IdLookupBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                            if (rdr["BusinessUnit"] != DBNull.Value) actionPlan.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            if (rdr["BusinessUnitHtmlColor"] != DBNull.Value) actionPlan.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHtmlColor"]);

                            // Counts (Stats)
                            if (rdr["TotalActionItems"] != DBNull.Value) actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            if (rdr["TotalOpenItems"] != DBNull.Value) actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            if (rdr["TotalClosedItems"] != DBNull.Value) actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);

                            // Stats extra
                            if (rdr["Stat_Overdue15"] != DBNull.Value) actionPlan.Stat_Overdue15 = Convert.ToInt32(rdr["Stat_Overdue15"]);
                            if (rdr["Stat_HighPriorityOverdue"] != DBNull.Value) actionPlan.Stat_HighPriorityOverdue = Convert.ToInt32(rdr["Stat_HighPriorityOverdue"]);
                            if (rdr["Stat_MaxDueDays"] != DBNull.Value) actionPlan.Stat_MaxDueDays = Convert.ToInt32(rdr["Stat_MaxDueDays"]);
                            if (rdr["Stat_ThemesList"] != DBNull.Value) actionPlan.Stat_ThemesList = Convert.ToString(rdr["Stat_ThemesList"]); else actionPlan.Stat_ThemesList = string.Empty;

                            // --- NOVOS CAMPOS AGREGADOS (Importante para os Filtros) ---
                            if (rdr["ThemeAggregates"] != DBNull.Value) actionPlan.ThemeAggregates = Convert.ToString(rdr["ThemeAggregates"]); else actionPlan.ThemeAggregates = string.Empty;
                            if (rdr["StatusAggregates"] != DBNull.Value) actionPlan.StatusAggregates = Convert.ToString(rdr["StatusAggregates"]); else actionPlan.StatusAggregates = string.Empty;

                            // Meta Info
                            if (rdr["CreatedBy"] != DBNull.Value) actionPlan.CreatedBy = Convert.ToInt16(rdr["CreatedBy"]);
                            if (rdr["CreatedByName"] != DBNull.Value) actionPlan.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            if (rdr["CreatedIn"] != DBNull.Value) actionPlan.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            if (rdr["IdDepartment"] != DBNull.Value) { actionPlan.IdDepartment = Convert.ToInt32(rdr["IdDepartment"]); actionPlan.Department = Convert.ToString(rdr["Department"]); }
                            if (rdr["OriginDescription"] != DBNull.Value) actionPlan.OriginDescription = Convert.ToString(rdr["OriginDescription"]);
                            if (rdr["ActionPlanResponsibleDisplayName"] != DBNull.Value) actionPlan.ActionPlanResponsibleDisplayName = Convert.ToString(rdr["ActionPlanResponsibleDisplayName"]);

                            // Grouping / Site Info
                            if (rdr["IdSite"] != DBNull.Value) actionPlan.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            if (rdr["CustomerName"] != DBNull.Value) actionPlan.Group = Convert.ToString(rdr["CustomerName"]);
                            if (rdr["SiteName"] != DBNull.Value) { actionPlan.Site = Convert.ToString(rdr["SiteName"]); actionPlan.GroupName = actionPlan.Group + " " + "(" + actionPlan.Site + ")"; }
                            if (rdr["IdZone"] != DBNull.Value) actionPlan.IdZone = Convert.ToInt32(rdr["IdZone"]);
                            if (rdr["Region"] != DBNull.Value) actionPlan.Zone = Convert.ToString(rdr["Region"]);

                            // Percentage Logic
                            if (actionPlan.TotalActionItems != 0) actionPlan.Percentage = (int)(((float)actionPlan.TotalClosedItems / actionPlan.TotalActionItems) * 100);
                            else actionPlan.Percentage = 0;

                            if (actionPlan.Percentage <= 24) actionPlan.TotalClosedColor = "Red";
                            else if (actionPlan.Percentage >= 25 && actionPlan.Percentage <= 49) actionPlan.TotalClosedColor = "Orange";
                            else if (actionPlan.Percentage >= 50 && actionPlan.Percentage <= 74) actionPlan.TotalClosedColor = "Yellow";
                            else if (actionPlan.Percentage >= 75 && actionPlan.Percentage <= 99) actionPlan.TotalClosedColor = "LightGreen";
                            else if (actionPlan.Percentage == 100) actionPlan.TotalClosedColor = "Green";

                            // Inicializar lista de tasks
                            actionPlan.TaskList = new List<APMActionPlanTask>();

                            // Adicionar à lista principal e ao dicionário
                            actionPlanList.Add(actionPlan);
                            if (!planDictionary.ContainsKey(actionPlan.IdActionPlan))
                                planDictionary.Add(actionPlan.IdActionPlan, actionPlan);
                        }

                        // ==========================================================
                        // 2. LER TASKS (Tabela 1) - Se existirem
                        // ==========================================================
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                var task = MapTaskFromReader(rdr); // Helper method ou código inline

                                // Encontrar o pai (Action Plan) e adicionar
                                if (task.IdActionPlan > 0 && planDictionary.ContainsKey(task.IdActionPlan))
                                {
                                    var parent = planDictionary[task.IdActionPlan];
                                    parent.TaskList.Add(task);

                                    // Adicionar ao dicionário de tasks para as subtasks usarem depois
                                    if (!taskDictionary.ContainsKey(task.IdActionPlanTask))
                                        taskDictionary.Add(task.IdActionPlanTask, task);
                                }
                            }
                        }

                        // ==========================================================
                        // 3. LER SUB-TASKS (Tabela 2) - Se existirem
                        // ==========================================================
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                var subTask = MapTaskFromReader(rdr);

                                // CORREÇÃO: IdParent é long, verificamos se é > 0 em vez de .HasValue
                                if (subTask.IdParent > 0 && taskDictionary.ContainsKey(subTask.IdParent))
                                {
                                    var parentTask = taskDictionary[subTask.IdParent]; // CORREÇÃO: Removemos o .Value

                                    // Requer a Opção A (propriedade SubTasks na classe)
                                    if (parentTask.SubTasks == null) parentTask.SubTasks = new List<APMActionPlanTask>();
                                    parentTask.SubTasks.Add(subTask);
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_WithCounts: {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return actionPlanList;
        }

        private APMActionPlanTask MapTaskFromReader(MySqlDataReader rdr)
        {
            APMActionPlanTask task = new APMActionPlanTask();

            if (rdr["IdTask"] != DBNull.Value) task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
            if (rdr["IdActionPlan"] != DBNull.Value) task.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
            if (rdr["TaskNumber"] != DBNull.Value) task.TaskNumber = Convert.ToInt32(rdr["TaskNumber"]);
            if (rdr["Title"] != DBNull.Value) task.Title = Convert.ToString(rdr["Title"]);
            if (rdr["Description"] != DBNull.Value) task.Description = Convert.ToString(rdr["Description"]);

            if (rdr["IdParent"] != DBNull.Value) task.IdParent = Convert.ToInt64(rdr["IdParent"]);

            if (rdr["Status"] != DBNull.Value) task.Status = Convert.ToString(rdr["Status"]);
            if (rdr["Priority"] != DBNull.Value) task.Priority = Convert.ToString(rdr["Priority"]);
            if (rdr["Theme"] != DBNull.Value) task.Theme = Convert.ToString(rdr["Theme"]);

            if (rdr["StatusHTMLColor"] != DBNull.Value) task.CardDueColor = Convert.ToString(rdr["StatusHTMLColor"]);

            if (rdr["DueDate"] != DBNull.Value) task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
            if (rdr["OpenDate"] != DBNull.Value) task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
            if (rdr["CloseDate"] != DBNull.Value) task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);


            return task;
        }


        //[pallavi.kale][GEOS2-8997][28.10.2025]
        public List<APMActionPlanTask> GetTaskListByIdActionPlan_V2680(string connectionString, Int64 IdActionPlan, string selectedPeriod, Int32 idUser)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetTaskListByIdActionPlan_V2680", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }

                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }
                            if (rdr["IdOTItem"] != DBNull.Value)
                            {
                                task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                            }
                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                task.IdOT = Convert.ToInt64(rdr["IdOT"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.OTCode = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                            {
                                task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                            }
                            if (rdr["Participant"] != DBNull.Value)
                            {
                                string participantString = rdr["Participant"].ToString();
                                task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                            }
                            if (rdr["IdParent"] != DBNull.Value)
                            {
                                task.IdParent = Convert.ToInt64(rdr["IdParent"]);
                            }
                            if (rdr["OriginWeek"] != DBNull.Value)
                            {
                                task.OriginWeek = Convert.ToString(rdr["OriginWeek"]);
                            }
                            taskList.Add(task);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdParent"] != DBNull.Value)
                                {
                                    APMActionPlanTask actionPlanSubTask = taskList.FirstOrDefault(x => x.IdActionPlanTask == Convert.ToInt64(rdr["IdParent"]));

                                    if (actionPlanSubTask != null)
                                    {
                                        if (actionPlanSubTask.SubTaskList == null)
                                        {
                                            actionPlanSubTask.SubTaskList = new List<APMActionPlanSubTask>();
                                        }

                                        APMActionPlanSubTask subTask = new APMActionPlanSubTask();
                                        subTask.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            subTask.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            subTask.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            subTask.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            subTask.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            subTask.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            subTask.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            subTask.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            subTask.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            subTask.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            subTask.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            subTask.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            subTask.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            subTask.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            subTask.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            subTask.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo = new Responsible();
                                            subTask.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            subTask.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            subTask.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            subTask.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            subTask.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            subTask.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            subTask.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            subTask.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            subTask.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            subTask.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            subTask.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            subTask.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            subTask.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            subTask.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            subTask.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            subTask.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            subTask.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            subTask.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            subTask.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }

                                        if (subTask.DueDate != subTask.OriginalDueDate)
                                        {
                                            subTask.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            subTask.IsShowIcon = false;
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            subTask.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            subTask.IdOT = Convert.ToInt64(rdr["IdOT"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            subTask.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            subTask.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            subTask.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            subTask.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["ParentTaskNumber"] != DBNull.Value)
                                        {
                                            subTask.ParentTaskNumber = Convert.ToInt64(rdr["ParentTaskNumber"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.SubTaskNumber = Convert.ToInt64(rdr["TaskNumber"]);
                                            subTask.SubTaskCode = subTask.ParentTaskNumber + "." + subTask.SubTaskNumber;
                                        }
                                        if (rdr["OriginWeek"] != DBNull.Value)
                                        {
                                            subTask.OriginWeek = Convert.ToString(rdr["OriginWeek"]);
                                        }
                                        actionPlanSubTask.SubTaskList.Add(subTask);
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTaskListByIdActionPlan_V2680(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }
        //[Shweta.Thube][GEOS2-8058][30-10-2025]
        public List<OverdueTaskMail> GetRegionalEmployeelist_V2680(string connectionString, string IdCompany, string To_CC_Ids, string cc_Ids)
        {
            List<OverdueTaskMail> overdueTaskList = new List<OverdueTaskMail>();

          
                try
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_RegionalEmployeelist_V2680", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdCompanies", IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_TO_CC_Ids", To_CC_Ids);
                        //mySqlCommand.Parameters.AddWithValue("_TO_Ids", To_Ids);
                        mySqlCommand.Parameters.AddWithValue("_CC_Ids", cc_Ids);

                        using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                try
                                {
                                    OverdueTaskMail overdueTaskMail = new OverdueTaskMail();

                                    if (reader["IdEmployee"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdEmployee = Convert.ToUInt32(reader["IdEmployee"]);
                                    }

                                    if (reader["IdCompany"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdCompany = Convert.ToUInt32(reader["IdCompany"]);
                                    }

                                    if (reader["IdJobDescription"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdJobDescription = Convert.ToUInt32(reader["IdJobDescription"]);
                                    }

                                    if (reader["CompanyEmail"] != DBNull.Value)
                                    {
                                        overdueTaskMail.EmployeeContactValue = Convert.ToString(reader["CompanyEmail"]);
                                    }

                                    if (reader["FirstName"] != DBNull.Value)
                                    {
                                        overdueTaskMail.FirstName = Convert.ToString(reader["FirstName"]);
                                    }

                                    if (reader["LastName"] != DBNull.Value)
                                    {
                                        overdueTaskMail.LastName = Convert.ToString(reader["LastName"]);
                                    }

                                    if (reader["EmployeeCode"] != DBNull.Value)
                                    {
                                        overdueTaskMail.EmployeeCode = Convert.ToString(reader["EmployeeCode"]);
                                    }
                                    if (reader["JobDescriptionCode"] != DBNull.Value)
                                    {
                                        overdueTaskMail.JobDescriptionCode = Convert.ToString(reader["JobDescriptionCode"]);
                                    }
                                    if (reader["IdJDScope"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdJDScope = Convert.ToInt32(reader["IdJDScope"]);
                                    }
                                    if (reader["Scope"] != DBNull.Value)
                                    {
                                        overdueTaskMail.Scope = Convert.ToString(reader["Scope"]);
                                    }
                                    if (reader["IdRegion"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdRegion = Convert.ToUInt16(reader["IdRegion"]);
                                    }
                                    overdueTaskList.Add(overdueTaskMail);
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetRegionalEmployeelist_V2680(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                                }
                            }
                        }

                        mySqlConnection.Close();
                    }
                }

                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error GetRegionalEmployeelist_V2680(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    throw;
                }
                return overdueTaskList;
            
        }
        //[Shweta.Thube][GEOS2-8058][30-10-2025]
        public List<OverdueTaskMail> GetRegionlistwithCompanies_V2680(string connectionString)
        {
            List<OverdueTaskMail> overdueTaskList = new List<OverdueTaskMail>();

           
                try
                {

                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_RegionlistwithCompanies_V2680", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                try
                                {
                                    OverdueTaskMail overdueTaskMail = new OverdueTaskMail();

                                    if (reader["IdRegion"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdRegion = Convert.ToUInt16(reader["IdRegion"]);
                                    }

                                    if (reader["IdCompany"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdCompany = Convert.ToUInt32(reader["IdCompany"]);
                                    }

                                    if (reader["REGION"] != DBNull.Value)
                                    {
                                        overdueTaskMail.Region = Convert.ToString(reader["REGION"]);
                                    }
                                    if (reader["Alias"] != DBNull.Value)
                                    {
                                        overdueTaskMail.PlantName = Convert.ToString(reader["Alias"]);
                                    }
                                    overdueTaskList.Add(overdueTaskMail);
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetRegionlistwithCompanies_V2680(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                                }
                            }
                        }

                        mySqlConnection.Close();
                    }

                }

                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error GetRegionlistwithCompanies_V2680(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    throw;
                }
                return overdueTaskList;
            
        }
        //[shweta.thube][06-11-2025][GEOS2-9812]
        public List<OverdueTaskMail> GetPriorityDelayedSettingExceptionMailIDs_V2680(string connectionString, Int32 IdCompany, string To_CC_Ids)
        {
            List<OverdueTaskMail> overdueTaskList = new List<OverdueTaskMail>();

   
                try
                {

                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_GetPriorityDelayedSettingExceptionMailIDs_V2680", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_TO_CC_Ids", To_CC_Ids);

                        using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                try
                                {
                                    OverdueTaskMail overdueTaskMail = new OverdueTaskMail();

                                    if (reader["IdEmployee"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdEmployee = Convert.ToUInt32(reader["IdEmployee"]);
                                    }

                                    if (reader["IdCompany"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdCompany = Convert.ToUInt32(reader["IdCompany"]);
                                    }

                                    if (reader["IdJobDescription"] != DBNull.Value)
                                    {
                                        overdueTaskMail.IdJobDescription = Convert.ToUInt32(reader["IdJobDescription"]);
                                    }

                                    if (reader["CompanyEmail"] != DBNull.Value)
                                    {
                                        overdueTaskMail.EmployeeContactValue = Convert.ToString(reader["CompanyEmail"]);
                                    }

                                    if (reader["FirstName"] != DBNull.Value)
                                    {
                                        overdueTaskMail.FirstName = Convert.ToString(reader["FirstName"]);
                                    }

                                    if (reader["LastName"] != DBNull.Value)
                                    {
                                        overdueTaskMail.LastName = Convert.ToString(reader["LastName"]);
                                    }

                                    if (reader["EmployeeCode"] != DBNull.Value)
                                    {
                                        overdueTaskMail.EmployeeCode = Convert.ToString(reader["EmployeeCode"]);
                                    }
                                    if (reader["JobDescriptionCode"] != DBNull.Value)
                                    {
                                        overdueTaskMail.JobDescriptionCode = Convert.ToString(reader["JobDescriptionCode"]);
                                    }

                                    overdueTaskList.Add(overdueTaskMail);
                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetPriorityDelayedSettingExceptionMailIDs_V2680(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                                }
                            }
                        }

                        mySqlConnection.Close();
                    }
                }

                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error GetPriorityDelayedSettingExceptionMailIDs_V2680(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    throw;
                }
                return overdueTaskList;
            
        }
        //[shweta.thube] [GEOS2-9868][07-11-2025]
        public List<APMActionPlan> GetActionPlanDetails_V2690(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlan> actionPlanList = new List<APMActionPlan>();
            List<APMActionPlanTask> actionPlanTaskList = new List<APMActionPlanTask>();
            List<string> countryISOs = new List<string>();

            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanDetails_V2690", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlan actionPlan = new APMActionPlan();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                actionPlan.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                actionPlan.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                actionPlan.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                actionPlan.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                actionPlan.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Country"] != DBNull.Value)
                            {
                                actionPlan.Country = new Country();
                                actionPlan.Country.Name = Convert.ToString(rdr["Country"]);
                                actionPlan.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                actionPlan.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + actionPlan.Country.Iso + ".png";
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                actionPlan.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                actionPlan.ResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                actionPlan.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                actionPlan.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["LastName"] != DBNull.Value)
                            {
                                actionPlan.LastName = Convert.ToString(rdr["LastName"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                actionPlan.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }

                            if (rdr["IdLookupValue"] != DBNull.Value)
                            {
                                actionPlan.IdLookupOrigin = Convert.ToInt32(rdr["IdLookupValue"]);
                            }
                            if (rdr["Origin"] != DBNull.Value)
                            {
                                actionPlan.Origin = Convert.ToString(rdr["Origin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.IdLookupBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                            }
                            if (rdr["BusinessUnit"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }
                            if (rdr["BusinessUnitHtmlColor"] != DBNull.Value)
                            {
                                actionPlan.BusinessUnitHTMLColor = Convert.ToString(rdr["BusinessUnitHtmlColor"]);
                            }
                            if (rdr["TotalActionItems"] != DBNull.Value)
                            {
                                actionPlan.TotalActionItems = Convert.ToInt16(rdr["TotalActionItems"]);
                            }
                            if (rdr["TotalOpenItems"] != DBNull.Value)
                            {
                                actionPlan.TotalOpenItems = Convert.ToInt16(rdr["TotalOpenItems"]);
                            }
                            if (rdr["TotalClosedItems"] != DBNull.Value)
                            {
                                actionPlan.TotalClosedItems = Convert.ToInt16(rdr["TotalClosedItems"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                actionPlan.CreatedBy = Convert.ToInt16(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                actionPlan.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                actionPlan.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["IdDepartment"] != DBNull.Value)
                            {
                                actionPlan.IdDepartment = Convert.ToInt32(rdr["IdDepartment"]);
                                actionPlan.Department = Convert.ToString(rdr["Department"]);
                            }
                            if (rdr["OriginDescription"] != DBNull.Value)
                            {
                                actionPlan.OriginDescription = Convert.ToString(rdr["OriginDescription"]);
                            }
                            if (rdr["ActionPlanResponsibleDisplayName"] != DBNull.Value)
                            {
                                actionPlan.ActionPlanResponsibleDisplayName = Convert.ToString(rdr["ActionPlanResponsibleDisplayName"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                actionPlan.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                actionPlan.Group = Convert.ToString(rdr["CustomerName"]);
                            }

                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                actionPlan.Site = Convert.ToString(rdr["SiteName"]);
                                actionPlan.GroupName = actionPlan.Group + " " + "(" + actionPlan.Site + ")";
                            }
                            if (rdr["IdZone"] != DBNull.Value)
                            {
                                actionPlan.IdZone = Convert.ToInt32(rdr["IdZone"]);
                            }
                            if (rdr["Region"] != DBNull.Value)
                            {
                                actionPlan.Zone = Convert.ToString(rdr["Region"]);
                            }
                            actionPlanList.Add(actionPlan);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdActionPlan"] != DBNull.Value)
                                {
                                    APMActionPlan actionPlanTask = actionPlanList.FirstOrDefault(x => x.IdActionPlan == Convert.ToInt32(rdr["IdActionPlan"]));
                                    if (actionPlanTask != null)
                                    {
                                        if (actionPlanTask.TaskList == null)
                                        {
                                            actionPlanTask.TaskList = new List<APMActionPlanTask>();
                                        }
                                        APMActionPlanTask task = new APMActionPlanTask();

                                        task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);
                                        if (rdr["IdActionPlan"] != DBNull.Value)
                                        {
                                            task.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                                        }
                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }

                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            task.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            task.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            task.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            task.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            task.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            task.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            task.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo = new Responsible();
                                            task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            task.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            task.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            task.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            task.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            task.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (task.DueDate != task.OriginalDueDate)
                                        {
                                            task.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            task.IsShowIcon = false;
                                        }
                                        task.Code = actionPlanTask.Code;
                                        task.ActionPlanDescription = actionPlanTask.Description;
                                        task.TaskOrigin = actionPlanTask.Origin;
                                        task.BusinessUnit = actionPlanTask.BusinessUnit;
                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            task.Country = new Country();
                                            task.Country.Name = Convert.ToString(rdr["Country"]);
                                            task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["NumItem"] != DBNull.Value)
                                        {
                                            task.NumItem = Convert.ToString(rdr["NumItem"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            task.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            task.IdOT = Convert.ToInt32(rdr["IdOT"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        if (rdr["FirstName"] != DBNull.Value)
                                        {
                                            task.FirstName = Convert.ToString(rdr["FirstName"]);
                                        }
                                        if (rdr["OriginWeek"] != DBNull.Value)
                                        {
                                            task.OriginWeek = Convert.ToString(rdr["OriginWeek"]);
                                        }
                                        if (rdr["IdSite"] != DBNull.Value)
                                        {
                                            task.IdSite = Convert.ToInt32(rdr["IdSite"]);
                                        }
                                        if (rdr["CustomerName"] != DBNull.Value)
                                        {
                                            task.Group = Convert.ToString(rdr["CustomerName"]);
                                        }
                                        if (rdr["SiteName"] != DBNull.Value)
                                        {
                                            task.Site = Convert.ToString(rdr["SiteName"]);
                                            task.GroupName = task.Group + " " + "(" + task.Site + ")";
                                        }
                                        actionPlanTask.TaskList.Add(task);
                                    }
                                }
                            }
                        }
                        // Bloco do 3º Result Set (Subtarefas) - OTIMIZADO
                        if (rdr.NextResult())
                        {
                            // -----------------------------------------------------------------------
                            // OTIMIZAÇÃO: Criar um Dicionário para encontrar o Pai instantaneamente.
                            // Evita percorrer a lista inteira milhares de vezes dentro do loop.
                            // -----------------------------------------------------------------------
                            Dictionary<long, APMActionPlanTask> taskDictionary = new Dictionary<long, APMActionPlanTask>();
                            foreach (var plan in actionPlanList)
                            {
                                if (plan.TaskList != null)
                                {
                                    foreach (var t in plan.TaskList)
                                    {
                                        if (!taskDictionary.ContainsKey(t.IdActionPlanTask))
                                        {
                                            taskDictionary.Add(t.IdActionPlanTask, t);
                                        }
                                    }
                                }
                            }

                            while (rdr.Read())
                            {
                                if (rdr["IdParent"] != DBNull.Value)
                                {
                                    long parentId = Convert.ToInt64(rdr["IdParent"]);

                                    // Tenta encontrar o Pai no dicionário (muito rápido)
                                    // A variável 'actionPlanSubTask' aqui representa a TAREFA PAI
                                    if (taskDictionary.TryGetValue(parentId, out APMActionPlanTask actionPlanSubTask))
                                    {
                                        if (actionPlanSubTask.SubTaskList == null)
                                        {
                                            actionPlanSubTask.SubTaskList = new List<APMActionPlanSubTask>();
                                        }

                                        APMActionPlanSubTask subTask = new APMActionPlanSubTask();

                                        // --- MAPEAMENTO DAS COLUNAS (Mantido igual ao original) ---

                                        if (rdr["IdActionPlan"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                                        }
                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            subTask.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["ParentTaskNumber"] != DBNull.Value)
                                        {
                                            subTask.ParentTaskNumber = Convert.ToInt64(rdr["ParentTaskNumber"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.SubTaskNumber = Convert.ToInt64(rdr["TaskNumber"]);
                                            subTask.SubTaskCode = subTask.ParentTaskNumber + "." + subTask.SubTaskNumber;
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            subTask.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            subTask.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            subTask.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            subTask.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            subTask.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            subTask.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            subTask.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }
                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            subTask.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            subTask.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            subTask.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            subTask.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            subTask.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            subTask.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            subTask.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            subTask.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo = new Responsible();
                                            subTask.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            subTask.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            subTask.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            subTask.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }
                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            subTask.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            subTask.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            subTask.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            subTask.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            subTask.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            subTask.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            subTask.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            subTask.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            subTask.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            subTask.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            subTask.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            subTask.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            subTask.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            subTask.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            subTask.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            subTask.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            subTask.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }

                                        if (subTask.DueDate != subTask.OriginalDueDate)
                                        {
                                            subTask.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            subTask.IsShowIcon = false;
                                        }

                                        subTask.Code = actionPlanSubTask.Code;
                                        subTask.ActionPlanDescription = actionPlanSubTask.Description;
                                        subTask.TaskOrigin = actionPlanSubTask.Origin;
                                        subTask.BusinessUnit = actionPlanSubTask.BusinessUnit;

                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            subTask.Country = new Country();
                                            subTask.Country.Name = Convert.ToString(rdr["Country"]);
                                            subTask.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            subTask.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + subTask.Country.Iso + ".png";
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            subTask.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["NumItem"] != DBNull.Value)
                                        {
                                            subTask.NumItem = Convert.ToString(rdr["NumItem"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            subTask.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            subTask.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            subTask.IdOT = Convert.ToInt32(rdr["IdOT"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            subTask.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;
                                        }
                                        if (rdr["OriginWeek"] != DBNull.Value)
                                        {
                                            subTask.OriginWeek = Convert.ToString(rdr["OriginWeek"]);
                                        }

                                        // Adiciona a subtarefa à lista do pai encontrado
                                        actionPlanSubTask.SubTaskList.Add(subTask);
                                    }
                                }
                            }
                        }
                    }
                }


                foreach (var item in actionPlanList)
                {
                    if (item.TotalActionItems != 0)
                    {
                        item.Percentage = (int)(((float)item.TotalClosedItems / item.TotalActionItems) * 100);
                    }
                    else
                    {
                        item.Percentage = 0;
                    }

                    if (item.Percentage <= 24)
                    {
                        item.TotalClosedColor = "Red";
                    }
                    else if (item.Percentage >= 25 && item.Percentage <= 49)
                    {
                        item.TotalClosedColor = "Orange";
                    }
                    else if (item.Percentage >= 50 && item.Percentage <= 74)
                    {
                        item.TotalClosedColor = "Yellow";
                    }
                    else if (item.Percentage >= 75 && item.Percentage <= 99)
                    {
                        item.TotalClosedColor = "LightGreen";
                    }
                    else if (item.Percentage == 100)
                    {
                        item.TotalClosedColor = "Green";
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanDetails_V2690(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanList;
        }
        //[shweta.thube] [GEOS2-9868][19-11-2025]
        public List<APMActionPlanTask> GetActionPlanTaskDetails_V2690(string connectionString, string selectedPeriod, Int32 idUser, string countryIconFilePath)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            List<string> countryISOs = new List<string>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetActionPlanTaskDetails_V2690", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            if (rdr["IdActionPlan"] != DBNull.Value)
                            {
                                task.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.Code = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["ActionDescription"] != DBNull.Value)
                            {
                                task.ActionPlanDescription = Convert.ToString(rdr["ActionDescription"]);
                            }
                            if (rdr["IdOrigin"] != DBNull.Value)
                            {
                                task.IdOrigin = Convert.ToInt32(rdr["IdOrigin"]);
                                task.TaskOrigin = Convert.ToString(rdr["TaskOrigin"]);
                            }
                            if (rdr["IdBusinessUnit"] != DBNull.Value)
                            {
                                task.IdBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                                task.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                            }

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }
                            if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                            {
                                task.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                            }
                            if (rdr["DelegatedDisplayName"] != DBNull.Value)
                            {
                                task.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                            }


                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }

                            if (rdr["Country"] != DBNull.Value)
                            {
                                task.Country = new Country();
                                task.Country.Name = Convert.ToString(rdr["Country"]);
                                task.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                task.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + task.Country.Iso + ".png";
                            }
                            if (rdr["IdUser"] != DBNull.Value)
                            {
                                task.ActionPlanResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                            }

                            if (rdr["IdOTItem"] != DBNull.Value)
                            {
                                task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                            }
                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                task.IdOT = Convert.ToInt64(rdr["IdOT"]);
                            }
                            if (rdr["OTCode"] != DBNull.Value)
                            {
                                task.OTCode = Convert.ToString(rdr["OTCode"]);
                            }
                            if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                            {
                                task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                            }
                            if (rdr["Participant"] != DBNull.Value)
                            {
                                string participantString = rdr["Participant"].ToString();
                                task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;
                            }
                            if (rdr["FirstName"] != DBNull.Value)
                            {
                                task.FirstName = Convert.ToString(rdr["FirstName"]);
                            }
                            if (rdr["IdParent"] != DBNull.Value)
                            {
                                task.IdParent = Convert.ToInt64(rdr["IdParent"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                task.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                task.Group = Convert.ToString(rdr["CustomerName"]);
                            }

                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                task.Site = Convert.ToString(rdr["SiteName"]);
                                task.GroupName = task.Group + " " + "(" + task.Site + ")";
                            }
                            if (rdr["OriginWeek"] != DBNull.Value)
                            {
                                task.OriginWeek = Convert.ToString(rdr["OriginWeek"]);
                            }

                            taskList.Add(task);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdParent"] != DBNull.Value)
                                {
                                    APMActionPlanTask actionPlanSubTask = taskList.FirstOrDefault(x => x.IdActionPlanTask == Convert.ToInt64(rdr["IdParent"]));

                                    if (actionPlanSubTask != null)
                                    {
                                        if (actionPlanSubTask.SubTaskList == null)
                                        {
                                            actionPlanSubTask.SubTaskList = new List<APMActionPlanSubTask>();
                                        }

                                        APMActionPlanSubTask subTask = new APMActionPlanSubTask();

                                        if (rdr["IdActionPlan"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlan = Convert.ToInt64(rdr["IdActionPlan"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            subTask.Code = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["ActionDescription"] != DBNull.Value)
                                        {
                                            subTask.ActionPlanDescription = Convert.ToString(rdr["ActionDescription"]);
                                        }
                                        if (rdr["IdOrigin"] != DBNull.Value)
                                        {
                                            subTask.IdOrigin = Convert.ToInt32(rdr["IdOrigin"]);
                                            subTask.TaskOrigin = Convert.ToString(rdr["TaskOrigin"]);
                                        }
                                        if (rdr["IdBusinessUnit"] != DBNull.Value)
                                        {
                                            subTask.IdBusinessUnit = Convert.ToInt32(rdr["IdBusinessUnit"]);
                                            subTask.BusinessUnit = Convert.ToString(rdr["BusinessUnit"]);
                                        }

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            subTask.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            subTask.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            subTask.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            subTask.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            subTask.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            subTask.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            subTask.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            subTask.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            subTask.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            subTask.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            subTask.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            subTask.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            subTask.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            subTask.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            subTask.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo = new Responsible();
                                            subTask.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            subTask.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            subTask.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            subTask.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            subTask.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            subTask.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            subTask.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            subTask.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            subTask.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            subTask.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            subTask.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            subTask.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            subTask.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            subTask.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            subTask.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            subTask.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            subTask.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            subTask.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            subTask.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }
                                        if (rdr["TaskResponsibleDisplayName"] != DBNull.Value)
                                        {
                                            subTask.TaskResponsibleDisplayName = Convert.ToString(rdr["TaskResponsibleDisplayName"]);
                                        }
                                        if (rdr["DelegatedDisplayName"] != DBNull.Value)
                                        {
                                            subTask.DelegatedDisplayName = Convert.ToString(rdr["DelegatedDisplayName"]);
                                        }


                                        if (subTask.DueDate != subTask.OriginalDueDate)
                                        {
                                            subTask.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            subTask.IsShowIcon = false;
                                        }

                                        if (rdr["Country"] != DBNull.Value)
                                        {
                                            subTask.Country = new Country();
                                            subTask.Country.Name = Convert.ToString(rdr["Country"]);
                                            subTask.Country.Iso = Convert.ToString(rdr["CountryIso"]);
                                            subTask.Country.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + subTask.Country.Iso + ".png";
                                        }
                                        if (rdr["IdUser"] != DBNull.Value)
                                        {
                                            subTask.ActionPlanResponsibleIdUser = Convert.ToInt32(rdr["IdUser"]);
                                        }

                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            subTask.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            subTask.IdOT = Convert.ToInt64(rdr["IdOT"]);
                                        }
                                        if (rdr["OTCode"] != DBNull.Value)
                                        {
                                            subTask.OTCode = Convert.ToString(rdr["OTCode"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            subTask.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            subTask.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;
                                        }
                                        if (rdr["FirstName"] != DBNull.Value)
                                        {
                                            subTask.FirstName = Convert.ToString(rdr["FirstName"]);
                                        }
                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            subTask.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["ParentTaskNumber"] != DBNull.Value)
                                        {
                                            subTask.ParentTaskNumber = Convert.ToInt64(rdr["ParentTaskNumber"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.SubTaskNumber = Convert.ToInt64(rdr["TaskNumber"]);
                                            subTask.SubTaskCode = subTask.ParentTaskNumber + "." + subTask.SubTaskNumber;
                                        }
                                        if (rdr["IdSite"] != DBNull.Value)
                                        {
                                            subTask.IdSite = Convert.ToInt32(rdr["IdSite"]);
                                        }
                                        if (rdr["CustomerName"] != DBNull.Value)
                                        {
                                            subTask.Group = Convert.ToString(rdr["CustomerName"]);
                                        }
                                        if (rdr["SiteName"] != DBNull.Value)
                                        {
                                            subTask.Site = Convert.ToString(rdr["SiteName"]);
                                            subTask.GroupName = subTask.Group + " " + "(" + subTask.Site + ")";
                                        }
                                        if (rdr["OriginWeek"] != DBNull.Value)
                                        {
                                            subTask.OriginWeek = Convert.ToString(rdr["OriginWeek"]);
                                        }
                                        actionPlanSubTask.SubTaskList.Add(subTask);
                                    }
                                }
                            }


                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetActionPlanTaskDetails_V2690(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }
        //[shweta.thube] [GEOS2-9868][19-11-2025]
        public List<APMActionPlanTask> GetTaskListByIdActionPlan_V2690(string connectionString, Int64 IdActionPlan, string selectedPeriod, Int32 idUser)
        {
            List<APMActionPlanTask> taskList = new List<APMActionPlanTask>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetTaskListByIdActionPlan_V2690", con);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_SelectedPeriod", selectedPeriod);
                    mySqlCommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);
                    mySqlCommand.Parameters.AddWithValue("_iduser", idUser);

                    using (MySqlDataReader rdr = mySqlCommand.ExecuteReader())
                    {
                        while (rdr.Read())
                        {
                            APMActionPlanTask task = new APMActionPlanTask();

                            task.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                            if (rdr["IdTask"] != DBNull.Value)
                            {
                                task.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                            }
                            if (rdr["TaskNumber"] != DBNull.Value)
                            {
                                task.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                            }
                            if (rdr["Title"] != DBNull.Value)
                            {
                                task.Title = Convert.ToString(rdr["Title"]);
                            }
                            if (rdr["EmployeeCode"] != DBNull.Value)
                            {
                                task.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                            }
                            if (rdr["IdEmployee"] != DBNull.Value)
                            {
                                task.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                            }
                            if (rdr["Responsible"] != DBNull.Value)
                            {
                                task.Responsible = Convert.ToString(rdr["Responsible"]);
                            }
                            if (rdr["IdGender"] != DBNull.Value)
                            {
                                task.IdGender = Convert.ToInt16(rdr["IdGender"]);
                            }
                            if (rdr["IdLookupStatus"] != DBNull.Value)
                            {
                                task.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                            }
                            if (rdr["Status"] != DBNull.Value)
                            {
                                task.Status = Convert.ToString(rdr["Status"]);
                            }
                            if (rdr["StatusHTMLColor"] != DBNull.Value)
                            {
                                task.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                            }

                            if (rdr["IdLookupPriority"] != DBNull.Value)
                            {
                                task.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                            }
                            if (rdr["Priority"] != DBNull.Value)
                            {
                                task.Priority = Convert.ToString(rdr["Priority"]);
                            }
                            if (rdr["IdLookupTheme"] != DBNull.Value)
                            {
                                task.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                            }
                            if (rdr["Theme"] != DBNull.Value)
                            {
                                task.Theme = Convert.ToString(rdr["Theme"]);
                            }
                            if (rdr["ThemeHTMLColor"] != DBNull.Value)
                            {
                                task.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                            }
                            if (rdr["DueDate"] != DBNull.Value)
                            {
                                task.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                            }
                            if (rdr["DueDays"] != DBNull.Value)
                            {
                                task.DueDays = Convert.ToInt32(rdr["DueDays"]);
                            }
                            if (rdr["DueColor"] != DBNull.Value)
                            {
                                task.DueColor = Convert.ToString(rdr["DueColor"]);
                            }
                            if (rdr["IdDelegated"] != DBNull.Value)
                            {
                                task.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo = new Responsible();
                                task.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                task.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["DelegatedTo"] != DBNull.Value)
                            {
                                task.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                            }
                            if (rdr["Comments"] != DBNull.Value)
                            {
                                task.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                            }
                            if (rdr["TaskLastComments"] != DBNull.Value)
                            {
                                task.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                            }

                            if (rdr["Files"] != DBNull.Value)
                            {
                                task.FileCount = Convert.ToInt32(rdr["Files"]);
                            }
                            if (rdr["Progress"] != DBNull.Value)
                            {
                                task.Progress = Convert.ToInt32(rdr["Progress"]);
                            }
                            if (rdr["IdLocation"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                            }
                            if (rdr["OpenDate"] != DBNull.Value)
                            {
                                task.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                            }
                            if (rdr["OriginalDueDate"] != DBNull.Value)
                            {
                                task.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                            }
                            if (rdr["Duration"] != DBNull.Value)
                            {
                                task.Duration = Convert.ToInt32(rdr["Duration"]);
                            }
                            if (rdr["CloseDate"] != DBNull.Value)
                            {
                                task.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                            }
                            if (rdr["ChangeCount"] != DBNull.Value)
                            {
                                task.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                            }
                            if (rdr["LastUpdated"] != DBNull.Value)
                            {
                                task.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                            }
                            if (rdr["IdCompany"] != DBNull.Value)
                            {
                                task.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                            }
                            if (rdr["Location"] != DBNull.Value)
                            {
                                task.Location = Convert.ToString(rdr["Location"]);
                            }
                            if (rdr["Description"] != DBNull.Value)
                            {
                                task.Description = Convert.ToString(rdr["Description"]);
                            }
                            if (rdr["ClosedBy"] != DBNull.Value)
                            {
                                task.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                            }
                            if (rdr["ClosedByName"] != DBNull.Value)
                            {
                                task.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                            }
                            if (rdr["CreatedIn"] != DBNull.Value)
                            {
                                task.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                            }
                            if (rdr["CreatedBy"] != DBNull.Value)
                            {
                                task.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                            }
                            if (rdr["CreatedByName"] != DBNull.Value)
                            {
                                task.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                            }

                            if (task.DueDate != task.OriginalDueDate)
                            {
                                task.IsShowIcon = true;
                            }
                            else
                            {
                                task.IsShowIcon = false;
                            }
                            if (rdr["IdOTItem"] != DBNull.Value)
                            {
                                task.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                            }
                            if (rdr["IdOT"] != DBNull.Value)
                            {
                                task.IdOT = Convert.ToInt64(rdr["IdOT"]);
                            }
                            if (rdr["Code"] != DBNull.Value)
                            {
                                task.OTCode = Convert.ToString(rdr["Code"]);
                            }
                            if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                            {
                                task.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                            }
                            if (rdr["Participant"] != DBNull.Value)
                            {
                                string participantString = rdr["Participant"].ToString();
                                task.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                            }
                            if (rdr["IdParent"] != DBNull.Value)
                            {
                                task.IdParent = Convert.ToInt64(rdr["IdParent"]);
                            }
                            if (rdr["OriginWeek"] != DBNull.Value)
                            {
                                task.OriginWeek = Convert.ToString(rdr["OriginWeek"]);
                            }
                            if (rdr["IdSite"] != DBNull.Value)
                            {
                                task.IdSite = Convert.ToInt32(rdr["IdSite"]);
                            }
                            if (rdr["CustomerName"] != DBNull.Value)
                            {
                                task.Group = Convert.ToString(rdr["CustomerName"]);
                            }

                            if (rdr["SiteName"] != DBNull.Value)
                            {
                                task.Site = Convert.ToString(rdr["SiteName"]);
                                task.GroupName = task.Group + " " + "(" + task.Site + ")";
                            }
                            taskList.Add(task);
                        }
                        if (rdr.NextResult())
                        {
                            while (rdr.Read())
                            {
                                if (rdr["IdParent"] != DBNull.Value)
                                {
                                    APMActionPlanTask actionPlanSubTask = taskList.FirstOrDefault(x => x.IdActionPlanTask == Convert.ToInt64(rdr["IdParent"]));

                                    if (actionPlanSubTask != null)
                                    {
                                        if (actionPlanSubTask.SubTaskList == null)
                                        {
                                            actionPlanSubTask.SubTaskList = new List<APMActionPlanSubTask>();
                                        }

                                        APMActionPlanSubTask subTask = new APMActionPlanSubTask();
                                        subTask.IdActionPlan = Convert.ToInt32(rdr["IdActionPlan"]);

                                        if (rdr["IdTask"] != DBNull.Value)
                                        {
                                            subTask.IdActionPlanTask = Convert.ToInt64(rdr["IdTask"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.TaskNumber = Convert.ToInt16(rdr["TaskNumber"]);
                                        }
                                        if (rdr["Title"] != DBNull.Value)
                                        {
                                            subTask.Title = Convert.ToString(rdr["Title"]);
                                        }
                                        if (rdr["EmployeeCode"] != DBNull.Value)
                                        {
                                            subTask.EmployeeCode = Convert.ToString(rdr["EmployeeCode"]);
                                        }
                                        if (rdr["IdEmployee"] != DBNull.Value)
                                        {
                                            subTask.IdEmployee = Convert.ToInt32(rdr["IdEmployee"]);
                                        }
                                        if (rdr["Responsible"] != DBNull.Value)
                                        {
                                            subTask.Responsible = Convert.ToString(rdr["Responsible"]);
                                        }
                                        if (rdr["IdGender"] != DBNull.Value)
                                        {
                                            subTask.IdGender = Convert.ToInt16(rdr["IdGender"]);
                                        }
                                        if (rdr["IdLookupStatus"] != DBNull.Value)
                                        {
                                            subTask.IdLookupStatus = Convert.ToInt32(rdr["IdLookupStatus"]);
                                        }
                                        if (rdr["Status"] != DBNull.Value)
                                        {
                                            subTask.Status = Convert.ToString(rdr["Status"]);
                                        }
                                        if (rdr["StatusHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.StatusHTMLColor = Convert.ToString(rdr["StatusHTMLColor"]);
                                        }

                                        if (rdr["IdLookupPriority"] != DBNull.Value)
                                        {
                                            subTask.IdLookupPriority = Convert.ToInt32(rdr["IdLookupPriority"]);
                                        }
                                        if (rdr["Priority"] != DBNull.Value)
                                        {
                                            subTask.Priority = Convert.ToString(rdr["Priority"]);
                                        }
                                        if (rdr["IdLookupTheme"] != DBNull.Value)
                                        {
                                            subTask.IdLookupTheme = Convert.ToInt32(rdr["IdLookupTheme"]);
                                        }
                                        if (rdr["Theme"] != DBNull.Value)
                                        {
                                            subTask.Theme = Convert.ToString(rdr["Theme"]);
                                        }
                                        if (rdr["ThemeHTMLColor"] != DBNull.Value)
                                        {
                                            subTask.ThemeHTMLColor = Convert.ToString(rdr["ThemeHTMLColor"]);
                                        }
                                        if (rdr["DueDate"] != DBNull.Value)
                                        {
                                            subTask.DueDate = Convert.ToDateTime(rdr["DueDate"]);
                                        }
                                        if (rdr["DueDays"] != DBNull.Value)
                                        {
                                            subTask.DueDays = Convert.ToInt32(rdr["DueDays"]);
                                        }
                                        if (rdr["DueColor"] != DBNull.Value)
                                        {
                                            subTask.DueColor = Convert.ToString(rdr["DueColor"]);
                                        }
                                        if (rdr["IdDelegated"] != DBNull.Value)
                                        {
                                            subTask.IdDelegated = Convert.ToInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo = new Responsible();
                                            subTask.SelectedDelegatedTo.IdEmployee = Convert.ToUInt32(rdr["IdDelegated"]);
                                            subTask.SelectedDelegatedTo.FullName = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["DelegatedTo"] != DBNull.Value)
                                        {
                                            subTask.DelegatedTo = Convert.ToString(rdr["DelegatedTo"]);
                                        }
                                        if (rdr["Comments"] != DBNull.Value)
                                        {
                                            subTask.CommentsCount = Convert.ToInt32(rdr["Comments"]);
                                        }
                                        if (rdr["TaskLastComments"] != DBNull.Value)
                                        {
                                            subTask.TaskLastComment = Convert.ToString(rdr["TaskLastComments"]);
                                        }

                                        if (rdr["Files"] != DBNull.Value)
                                        {
                                            subTask.FileCount = Convert.ToInt32(rdr["Files"]);
                                        }
                                        if (rdr["Progress"] != DBNull.Value)
                                        {
                                            subTask.Progress = Convert.ToInt32(rdr["Progress"]);
                                        }
                                        if (rdr["IdLocation"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdLocation"]);
                                        }
                                        if (rdr["OpenDate"] != DBNull.Value)
                                        {
                                            subTask.OpenDate = Convert.ToDateTime(rdr["OpenDate"]);
                                        }
                                        if (rdr["OriginalDueDate"] != DBNull.Value)
                                        {
                                            subTask.OriginalDueDate = Convert.ToDateTime(rdr["OriginalDueDate"]);
                                        }
                                        if (rdr["Duration"] != DBNull.Value)
                                        {
                                            subTask.Duration = Convert.ToInt32(rdr["Duration"]);
                                        }
                                        if (rdr["CloseDate"] != DBNull.Value)
                                        {
                                            subTask.CloseDate = Convert.ToDateTime(rdr["CloseDate"]);
                                        }
                                        if (rdr["ChangeCount"] != DBNull.Value)
                                        {
                                            subTask.ChangeCount = Convert.ToInt32(rdr["ChangeCount"]);
                                        }
                                        if (rdr["LastUpdated"] != DBNull.Value)
                                        {
                                            subTask.LastUpdated = Convert.ToDateTime(rdr["LastUpdated"]);
                                        }
                                        if (rdr["IdCompany"] != DBNull.Value)
                                        {
                                            subTask.IdCompany = Convert.ToInt32(rdr["IdCompany"]);
                                        }
                                        if (rdr["Location"] != DBNull.Value)
                                        {
                                            subTask.Location = Convert.ToString(rdr["Location"]);
                                        }
                                        if (rdr["Description"] != DBNull.Value)
                                        {
                                            subTask.Description = Convert.ToString(rdr["Description"]);
                                        }
                                        if (rdr["ClosedBy"] != DBNull.Value)
                                        {
                                            subTask.ClosedBy = Convert.ToInt32(rdr["ClosedBy"]);
                                        }
                                        if (rdr["ClosedByName"] != DBNull.Value)
                                        {
                                            subTask.ClosedByName = Convert.ToString(rdr["ClosedByName"]);
                                        }
                                        if (rdr["CreatedIn"] != DBNull.Value)
                                        {
                                            subTask.CreatedIn = Convert.ToDateTime(rdr["CreatedIn"]);
                                        }
                                        if (rdr["CreatedBy"] != DBNull.Value)
                                        {
                                            subTask.CreatedBy = Convert.ToUInt32(rdr["CreatedBy"]);
                                        }
                                        if (rdr["CreatedByName"] != DBNull.Value)
                                        {
                                            subTask.CreatedByName = Convert.ToString(rdr["CreatedByName"]);
                                        }

                                        if (subTask.DueDate != subTask.OriginalDueDate)
                                        {
                                            subTask.IsShowIcon = true;
                                        }
                                        else
                                        {
                                            subTask.IsShowIcon = false;
                                        }
                                        if (rdr["IdOTItem"] != DBNull.Value)
                                        {
                                            subTask.IdOTItem = Convert.ToInt32(rdr["IdOTItem"]);
                                        }
                                        if (rdr["IdOT"] != DBNull.Value)
                                        {
                                            subTask.IdOT = Convert.ToInt64(rdr["IdOT"]);
                                        }
                                        if (rdr["Code"] != DBNull.Value)
                                        {
                                            subTask.OTCode = Convert.ToString(rdr["Code"]);
                                        }
                                        if (rdr["OTCodeAndItemNumber"] != DBNull.Value)
                                        {
                                            subTask.CodeNumber = Convert.ToString(rdr["OTCodeAndItemNumber"]);
                                        }
                                        if (rdr["Participant"] != DBNull.Value)
                                        {
                                            string participantString = rdr["Participant"].ToString();
                                            subTask.ParticipantCount = participantString.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Length;

                                        }
                                        if (rdr["IdParent"] != DBNull.Value)
                                        {
                                            subTask.IdParent = Convert.ToInt64(rdr["IdParent"]);
                                        }
                                        if (rdr["ParentTaskNumber"] != DBNull.Value)
                                        {
                                            subTask.ParentTaskNumber = Convert.ToInt64(rdr["ParentTaskNumber"]);
                                        }
                                        if (rdr["TaskNumber"] != DBNull.Value)
                                        {
                                            subTask.SubTaskNumber = Convert.ToInt64(rdr["TaskNumber"]);
                                            subTask.SubTaskCode = subTask.ParentTaskNumber + "." + subTask.SubTaskNumber;
                                        }
                                        if (rdr["OriginWeek"] != DBNull.Value)
                                        {
                                            subTask.OriginWeek = Convert.ToString(rdr["OriginWeek"]);
                                        }

                                        actionPlanSubTask.SubTaskList.Add(subTask);
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetTaskListByIdActionPlan_V2690(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return taskList;
        }
        //[shweta.thube] [GEOS2-9870][19-11-2025]
        public List<Company> GetAuthorizedLocationListByIdUser_V2690(string workbenchConnectionString, Int32 idUser, string countryIconFilePath)
        {
            List<Company> companies = new List<Company>();
            List<string> countryISOs = new List<string>();

            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(workbenchConnectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetAuthorizedLocationListByIdUser_V2690", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_idUser", idUser);

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {

                        while (reader.Read())
                        {
                            Company company = new Company();
                            if (reader["IdCompany"] != DBNull.Value)
                            {
                                company.IdCompany = Convert.ToInt32(reader["IdCompany"]);
                                company.Name = Convert.ToString(reader["CompanyName"]);
                                company.Alias = Convert.ToString(reader["Alias"]);
                                company.ShortName = Convert.ToString(reader["Alias"]);
                                if (reader["IdCountry"] != DBNull.Value)
                                {
                                    company.IdCountry = Convert.ToByte(reader["IdCountry"]);
                                    company.Country = new Country();
                                    company.Country.IdCountry = Convert.ToByte(reader["IdCountry"]);
                                    company.Country.Name = Convert.ToString(reader["CountryName"]);
                                }
                                if (reader["IsLocation"] != DBNull.Value)
                                    company.IsLocation = Convert.ToByte(reader["IsLocation"]);

                                if (reader["IsOrganization"] != DBNull.Value)
                                    company.IsOrganization = Convert.ToByte(reader["IsOrganization"]);

                                if (reader["IsCompany"] != DBNull.Value)
                                    company.IsCompany = Convert.ToByte(reader["IsCompany"]);

                                if (reader["IsStillActive"] != DBNull.Value)
                                    company.IsStillActive = Convert.ToByte(reader["IsStillActive"]);

                                if (reader["IdCurrency"] != DBNull.Value)
                                {
                                    company.IdCurrency = Convert.ToInt16(reader["IdCurrency"]);
                                }
                                if (reader["CountryISO"] != DBNull.Value)
                                {
                                    company.Iso = Convert.ToString(reader["CountryISO"]);
                                    company.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + company.Iso + ".png";

                                    //if (!countryISOs.Any(co => co.ToString() == company.Iso))
                                    //{
                                    //    countryISOs.Add(company.Iso);
                                    //}
                                }
                                if (reader["IdRegion"] != DBNull.Value)
                                {
                                    company.IdRegion = Convert.ToInt16(reader["IdRegion"]);
                                }
                                if (reader["Region"] != DBNull.Value)
                                {
                                    company.Region = Convert.ToString(reader["Region"]);
                                }
                            }
                            companies.Add(company);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetAuthorizedLocationListByIdUser_V2690(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            //foreach (string item in countryISOs)
            //{
            //    byte[] bytes = null;
            //    bytes = GetCountryIconFileInBytes(item, countryIconFilePath);
            //    companies.Where(ot => ot.Iso == item).ToList().ForEach(ot => ot.ImageInBytes = bytes);
            //}
            return companies;
        }
        //[shweta.thube] [GEOS2-9870][19-11-2025]
        public APMActionPlanTask AddTaskForActionPlan_V2690(string connectionString, APMActionPlanTask actionPlanTask)
        {
            bool isAdded = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_InsertTaskForActionPlan_V2690", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        //mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlanTask.IdLookupBusiness);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        if (actionPlanTask.IdDelegated > 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                        mySqlCommand.Parameters.AddWithValue("_CreatedBy", actionPlanTask.CreatedBy);
                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                        mySqlCommand.Parameters.AddWithValue("_Description", actionPlanTask.Description);
                        mySqlCommand.Parameters.AddWithValue("_ClosedBy", actionPlanTask.ClosedBy);
                        mySqlCommand.Parameters.AddWithValue("_IdOTItem", actionPlanTask.IdOTItem == 0 ? (object)DBNull.Value : actionPlanTask.IdOTItem);
                        //mySqlCommand.Parameters.AddWithValue("_IdCustomerSite", actionPlanTask.IdSite);
                        mySqlCommand.Parameters.AddWithValue("_IdCustomerSite", actionPlanTask.IdSite == 0 ? (object)DBNull.Value : actionPlanTask.IdSite);
                        actionPlanTask.IdActionPlanTask = Convert.ToUInt32(mySqlCommand.ExecuteScalar());

                        //mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();

                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isAdded = true;

                    AddLogEntriesByActionPlan_V2580(connectionString, actionPlanTask.ActionPlanLogEntries);
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error AddTaskForActionPlan_V2690(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return actionPlanTask;
        }
        //[shweta.thube] [GEOS2-9870][19-11-2025]
        public bool UpdateTaskForActionPlan_V2690(string connectionString, APMActionPlanTask actionPlanTask, string filePath)
        {
            bool isUpdated = false;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("APM_UpdateTaskForActionPlan_V2690", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        // Adding parameters to update the record
                        mySqlCommand.Parameters.AddWithValue("_IdTask", actionPlanTask.IdActionPlanTask);
                        mySqlCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanTask.IdActionPlan);
                        mySqlCommand.Parameters.AddWithValue("_TaskNumber", actionPlanTask.TaskNumber);
                        mySqlCommand.Parameters.AddWithValue("_Title", actionPlanTask.Title);
                        mySqlCommand.Parameters.AddWithValue("_IdLocation", actionPlanTask.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdResponsibleEmployee", actionPlanTask.IdEmployee);
                        mySqlCommand.Parameters.AddWithValue("_IdStatus", actionPlanTask.IdLookupStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdPriority", actionPlanTask.IdLookupPriority);
                        //mySqlCommand.Parameters.AddWithValue("_IdBusinessUnit", actionPlanTask.IdLookupBusiness);
                        mySqlCommand.Parameters.AddWithValue("_IdTheme", actionPlanTask.IdLookupTheme);
                        mySqlCommand.Parameters.AddWithValue("_DueDate", actionPlanTask.DueDate);
                        mySqlCommand.Parameters.AddWithValue("_DelegatedTo", actionPlanTask.IdDelegated);
                        if (actionPlanTask.IdDelegated > 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", DateTime.Now);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_DelegatedIn", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_Progress", actionPlanTask.Progress);
                        mySqlCommand.Parameters.AddWithValue("_CloseDate", actionPlanTask.CloseDate);
                        mySqlCommand.Parameters.AddWithValue("_ModifiedBy", actionPlanTask.ModifiedBy);
                        mySqlCommand.Parameters.AddWithValue("_DueDateChangeCount", actionPlanTask.ChangeCount);
                        mySqlCommand.Parameters.AddWithValue("_Description", actionPlanTask.Description);
                        if (actionPlanTask.ClosedBy != 0)
                        {
                            mySqlCommand.Parameters.AddWithValue("_ClosedBy", actionPlanTask.ClosedBy);
                        }
                        else
                        {
                            mySqlCommand.Parameters.AddWithValue("_ClosedBy", null);
                        }
                        mySqlCommand.Parameters.AddWithValue("_IdOTItem", actionPlanTask.IdOTItem == 0 ? (object)DBNull.Value : actionPlanTask.IdOTItem);
                        //mySqlCommand.Parameters.AddWithValue("_IdCustomerSite", actionPlanTask.IdSite);
                        mySqlCommand.Parameters.AddWithValue("_IdCustomerSite", actionPlanTask.IdSite == 0 ? (object)DBNull.Value : actionPlanTask.IdSite);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    isUpdated = true;

                    if (actionPlanTask.ActionPlanLogEntries != null)
                    {
                        AddLogEntriesByActionPlan_V2580(connectionString, actionPlanTask.ActionPlanLogEntries);
                    }

                    if (!string.IsNullOrEmpty(actionPlanTask.TaskStatusComment))
                    {
                        CommentsByTask commentsByTask = new CommentsByTask();
                        commentsByTask.Comments = actionPlanTask.TaskStatusComment;
                        commentsByTask.IdTask = actionPlanTask.IdActionPlanTask;
                        commentsByTask.IdUser = actionPlanTask.ModifiedBy;
                        commentsByTask.IsRtfText = false;

                        AddStatusCommentForTask_V2620(connectionString, commentsByTask);
                    }

                    if (actionPlanTask.TaskAttachmentList != null && actionPlanTask.TaskAttachmentList.Count > 0)
                    {
                        actionPlanTask.TaskAttachmentList.ForEach(x => x.Description = actionPlanTask.TaskStatusDescription);
                        actionPlanTask.TaskAttachmentList.ForEach(x => x.IdTask = actionPlanTask.IdActionPlanTask);
                        AddStatusAttachmentForTask_V2620(connectionString, actionPlanTask.TaskAttachmentList, filePath);
                    }

                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateTaskForActionPlan_V2690(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isUpdated;
        }
      
        //[shweta.thube][GEOS2-9547][27-11-2025]
        public List<Company> GetUnAuthorizedLocationListByIdCompany_V2690(string workbenchConnectionString, string idCompanies, string countryIconFilePath)
        {
            List<Company> companies = new List<Company>();
            List<string> countryISOs = new List<string>();

            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(workbenchConnectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("APM_GetUnAuthorizedLocationListByIdCompany_V2690", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdCompanies", idCompanies);

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {

                        while (reader.Read())
                        {
                            Company company = new Company();
                            if (reader["IdCompany"] != DBNull.Value)
                            {
                                company.IdCompany = Convert.ToInt32(reader["IdCompany"]);
                                company.Name = Convert.ToString(reader["CompanyName"]);
                                company.Alias = Convert.ToString(reader["Alias"]);
                                company.ShortName = Convert.ToString(reader["Alias"]);
                                if (reader["IdCountry"] != DBNull.Value)
                                {
                                    company.IdCountry = Convert.ToByte(reader["IdCountry"]);
                                    company.Country = new Country();
                                    company.Country.IdCountry = Convert.ToByte(reader["IdCountry"]);
                                    company.Country.Name = Convert.ToString(reader["CountryName"]);
                                }
                                if (reader["IsLocation"] != DBNull.Value)
                                    company.IsLocation = Convert.ToByte(reader["IsLocation"]);

                                if (reader["IsOrganization"] != DBNull.Value)
                                    company.IsOrganization = Convert.ToByte(reader["IsOrganization"]);

                                if (reader["IsCompany"] != DBNull.Value)
                                    company.IsCompany = Convert.ToByte(reader["IsCompany"]);

                                if (reader["IsStillActive"] != DBNull.Value)
                                    company.IsStillActive = Convert.ToByte(reader["IsStillActive"]);

                                if (reader["IdCurrency"] != DBNull.Value)
                                {
                                    company.IdCurrency = Convert.ToInt16(reader["IdCurrency"]);
                                }
                                if (reader["CountryISO"] != DBNull.Value)
                                {
                                    company.Iso = Convert.ToString(reader["CountryISO"]);
                                    company.CountryIconUrl = "https://api.emdep.com/GEOS/Images?FilePath=/Images/Countries/" + company.Iso + ".png";

                                    //if (!countryISOs.Any(co => co.ToString() == company.Iso))
                                    //{
                                    //    countryISOs.Add(company.Iso);
                                    //}
                                }
                                if (reader["IdRegion"] != DBNull.Value)
                                {
                                    company.IdRegion = Convert.ToInt16(reader["IdRegion"]);
                                }
                                if (reader["Region"] != DBNull.Value)
                                {
                                    company.Region = Convert.ToString(reader["Region"]);
                                }
                            }
                            companies.Add(company);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetUnAuthorizedLocationListByIdCompany_V2690(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return companies;
        }
    }
}




