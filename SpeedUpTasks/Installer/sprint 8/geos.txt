DROP PROCEDURE IF EXISTS geos.sites_GetSites;
CREATE PROCEDURE geos.`sites_GetSites`()
BEGIN
 SELECT sites.IdSite AS IdCompany,sites.Name AS Name FROM sites;
END;


DROP PROCEDURE IF EXISTS geos.currency_GetAllCurrency;
CREATE PROCEDURE geos.`currency_GetAllCurrency`()
BEGIN
 SELECT * FROM currency;

END;


DROP PROCEDURE IF EXISTS geos.salesstatustype_GetAllSalesStatusType;
CREATE PROCEDURE geos.`salesstatustype_GetAllSalesStatusType`()
BEGIN
 SELECT  ss.IdSalesStatusType, ss.Name AS SalesStatusType, ss.IdImage, ss.HtmlColor,if(ss.IdSalesStatusType = 5,17,oft.IdOfferStatusType) AS IdOfferStatusType,oft.Name AS OfferStatusType,oft.Position AS OfferStatusPosition, oft.HtmlColor AS OfferStatusHtmlColor FROM sales_status_types ss INNER JOIN offerstatustypes oft ON ss.IdSalesStatusType = oft.IdSalesStatusType GROUP BY ss.IdSalesStatusType ORDER BY ss.Position;
END;


DROP PROCEDURE IF EXISTS geos.templatesbyofferoption_GetTemplatesByOfferOption;
CREATE PROCEDURE geos.`templatesbyofferoption_GetTemplatesByOfferOption`(
   IN _IdOfferOption int(10) UNSIGNED)
BEGIN
      SELECT t.Suffix,
             t.Name,
             t.IdTemplate,
             t.Type
        FROM templatesbyofferoption op
             INNER JOIN templates t ON op.idtemplate = t.idtemplate
       WHERE op.idofferoption = _IdOfferOption;
   END;


DROP PROCEDURE IF EXISTS geos.offertypes_GetAllOffertypes;
CREATE PROCEDURE geos.`offertypes_GetAllOffertypes`()
BEGIN
 SELECT * FROM offertypes;
END;


DROP PROCEDURE IF EXISTS geos.optionsbyoffer_Insert;
CREATE PROCEDURE geos.`optionsbyoffer_Insert`(
   IN _IdOffer    int(10) UNSIGNED,
   IN _IdOption   int(10) UNSIGNED,
   IN _Quantity   int(10))
BEGIN
      INSERT INTO optionsbyoffer(IdOffer, IdOption, Quantity)
           VALUES (_IdOffer, _IdOption, _Quantity);
   END;


DROP PROCEDURE IF EXISTS geos.quotations_Insert;
CREATE PROCEDURE geos.`quotations_Insert`(
   IN _IdOffer                int(10) UNSIGNED,
   IN _IdCustomer             smallint(5) UNSIGNED,
   IN _Year                   smallint(4) UNSIGNED,
   IN _Number                 smallint(5) UNSIGNED,
   IN _Code                   varchar(13),
   IN _CreatedIn              Datetime,
   IN _IdDetectionsTemplate   tinyint(3) UNSIGNED,
   IN _QuotQuantity           int(10))
BEGIN
      IF ((SELECT count(*)
             FROM quotations
            WHERE IdOffer = _IdOffer AND Code = _Code) = 0)
      THEN
         BEGIN
            INSERT INTO quotations(Idoffer,
                                   IdCustomer,
                                   Year,
                                   Number,
                                   Code,
                                   CreatedIn,
                                   IdDetectionsTemplate,
                                   QuotQuantity)
                 VALUES (_IdOffer,
                         _IdCustomer,
                         _Year,
                         _Number,
                         _Code,
                         _CreatedIn,
                         _IdDetectionsTemplate,
                         _QuotQuantity);

            SELECT LAST_INSERT_ID();
         END;
      END IF;
   END;



DROP PROCEDURE IF EXISTS geos.logEntryByOffer_Insert;
CREATE PROCEDURE geos.`logEntryByOffer_Insert`(
   IN _IdOffer          int(10) UNSIGNED,
   IN _IdUser           int(10) UNSIGNED,
   IN _Datetime         Datetime,
   IN _Comments         varchar(1000),
   IN _IdLogEntryType   tinyint(3) UNSIGNED)
BEGIN
      INSERT INTO logentriesbyoffer(idoffer,
                                    idUser,
                                    datetime,
                                    comments,
                                    idLogEntryType)
           VALUES (_IdOffer,
                   _IdUser,
                   _Datetime,
                   _Comments,
                   _IdLogEntryType);
   END;


DROP PROCEDURE IF EXISTS geos.offercontact_Insert;
CREATE PROCEDURE geos.`offercontact_Insert`(
   IN _IdOffer                 int(10) UNSIGNED,
   IN _IdContact               smallint(5) UNSIGNED,
   IN _IsPrimaryOfferContact   tinyint(3) UNSIGNED)
BEGIN
      INSERT INTO offer_contacts(IdOffer, IdContact, IsPrimaryOfferContact)
           VALUES (_IdOffer, _IdContact, _IsPrimaryOfferContact);

      SELECT LAST_INSERT_ID();
   END;


DROP PROCEDURE IF EXISTS geos.sites_Insert;
CREATE PROCEDURE geos.`sites_Insert`(
   IN _IdCustomer          smallint(5) UNSIGNED,
   IN _Name                varchar(50),
   IN _IdCountry           int(10) UNSIGNED,
   IN _Address             varchar(100),
   IN _Telephone           varchar(30),
   IN _Email               varchar(50),
   IN _Region              varchar(100),
   IN _Fax                 varchar(20),
   IN _IdBusinessCenter    tinyint(4) UNSIGNED,
   IN _IdBusinessField     tinyint(4) UNSIGNED,
   IN _Size                double,
   IN _CuttingMachines     smallint(5) UNSIGNED,
   IN _Line                smallint(5) UNSIGNED,
   IN _Website             varchar(255),
   IN _NumberOfEmployees   smallint(5) UNSIGNED,
   IN _City                varchar(50),
   IN _PostCode            varchar(100),
   IN _CreatedBy           smallint(5) UNSIGNED,
   IN _CreatedIn           datetime)
BEGIN
      INSERT INTO sites(IdCustomer,
                        Name,
                        IdCountry,
                        Address,
                        Telephone,
                        Email,
                        Region,
                        Fax,
                        IdBusinessCenter,
                        IdBusinessField,
                        Size,
                        CuttingMachines,
                        Line,
                        Website,
                        City,
                        NumberOfEmployees,
                        PostCode,
                        CreatedBy,
                        CreatedIn)
           VALUES (_IdCustomer,
                   concat(_name,
                          " (",
                          (SELECT name
                             FROM countries
                            WHERE idCountry = _IdCountry),
                          ")"),
                   _IdCountry,
                   _Address,
                   _Telephone,
                   _Email,
                   _Region,
                   _Fax,
                   _IdBusinessCenter,
                   _IdBusinessField,
                   _Size,
                   _CuttingMachines,
                   _Line,
                   _Website,
                   _City,
                   _NumberOfEmployees,
                   _PostCode,
                   _CreatedBy,
                   _CreatedIn);

      SELECT LAST_INSERT_ID();
   END;


DROP PROCEDURE IF EXISTS geos.sites_Update;
CREATE PROCEDURE geos.`sites_Update`(
   IN _IdSite             smallint(5) UNSIGNED,
   IN _IdCustomer         smallint(5) UNSIGNED,
   IN _Name               varchar(50),
   IN _IdCountry          int(10) UNSIGNED,
   IN _Address            varchar(100),
   IN _Telephone          varchar(30),
   IN _Email              varchar(50),
   IN _Region             varchar(100),
   IN _Fax                varchar(20),
   IN _IdBusinessCenter   tinyint(4) UNSIGNED,
   IN _IdBusinessField    tinyint(4) UNSIGNED,
   IN _Size               double,
   IN _CuttingMachines    smallint(5) UNSIGNED,
   IN _Line               smallint(5) UNSIGNED,
   IN _NumberOfEmployee   smallint(5) UNSIGNED,
   IN _Website            varchar(255),
   IN _City               varchar(50),
   IN _PostCode           varchar(100),
   IN _ModifiedBy         smallint(5) UNSIGNED,
   IN _ModifiedIn         datetime)
BEGIN
      UPDATE sites
         SET IdCustomer = _IdCustomer,
             Name =
                concat(_name,
                       " (",
                       (SELECT name
                          FROM countries
                         WHERE idCountry = _IdCountry),
                       ")"),
             IdCountry = _IdCountry,
             City = _City,
             Address = _Address,
             Telephone = _Telephone,
             Fax = _Fax,
             Email = _Email,
             PostCode = _PostCode,
             Region = _Region,
             ModifiedBy = _ModifiedBy,
             ModifiedIn = _ModifiedIn,
             Website = _Website,
             Line = _Line,
             CuttingMachines = _CuttingMachines,
             Size = _Size,
             NumberOfEmployees = _NumberOfEmployee,
             IdBusinessField = _IdBusinessField,
             IdBusinessCenter = _IdBusinessCenter
       WHERE IdSite = _IdSite;
   END;


DROP PROCEDURE IF EXISTS geos.offers_Insert;
CREATE PROCEDURE geos.`offers_Insert`(
   IN _Code                   varchar(45),
   IN _IdOfferType            tinyint(4) UNSIGNED,
   IN _IdCustomer             int(10) UNSIGNED,
   IN _IdProject              int(10) UNSIGNED,
   IN _Description            varchar(500),
   IN _IdStatus               int(10) UNSIGNED,
   IN _Amount                 double,
   IN _ProbabilityOfSuccess   tinyint(2),
   IN _OfferExpectedDate      datetime,
   IN _IdCurrency             tinyint(4) UNSIGNED,
   IN _Year                   int(10) UNSIGNED,
   IN _Number                 int(10) UNSIGNED,
   IN _CreatedBy              smallint(5) UNSIGNED,
   IN _CreatedIn              datetime,
   IN _ModifiedBy             smallint(5) UNSIGNED,
   IN _ModifiedIn             datetime,
   IN _DeliveryDate           datetime,
   IN _IdBusinessUnit         tinyint(3) UNSIGNED,
   IN _IdSalesOwner           smallint(5) UNSIGNED,
   IN _IdCarOEM               smallint(5) UNSIGNED,
   IN _IdSource               tinyint(3) UNSIGNED,
   IN _RFQReception           datetime,
   IN _SendIn                 datetime)
BEGIN
      INSERT INTO offers(Code,
                         IdOfferType,
                         IdCustomer,
                         IdProject,
                         Description,
                         IdStatus,
                         Value,
                         ProbabilityOfSuccess,
                         OfferExpectedDate,
                         Year,
                         Number,
                         Contact,
                         Rfq,
                         IdCurrency,
                         IdCustomerToDelivery,
                         CreatedBy,
                         CreatedIn,
                         ModifiedBy,
                         ModifiedIn,
                         Comments,
                         Title,
                         DeliveryDate,
                         IdBusinessUnit,
                         IdSalesOwner,
                         IdCarOEM,
                         IdSource,
                         RFQReception,
                         SendIn)
           VALUES (_Code,
                   _IdOfferType,
                   _IdCustomer,
                   _IdProject,
                   _Description,
                   _IdStatus,
                   _Amount,
                   _ProbabilityOfSuccess,
                   _OfferExpectedDate,
                   _Year,
                   _Number,
                   '',
                   '',
                   _IdCurrency,
                   0,
                   _CreatedBy,
                   _CreatedIn,
                   _ModifiedBy,
                   '1000-01-01',
                   '',
                   '',
                   _DeliveryDate,
                   _IdBusinessUnit,
                   _IdSalesOwner,
                   _IdCarOEM,
                   _IdSource,
                   _RFQReception,
                   _SendIn);

      SELECT LAST_INSERT_ID();
   END;



DROP PROCEDURE IF EXISTS geos.logentry_GetAllLogEntriesByIdOffer;
CREATE PROCEDURE geos.`logentry_GetAllLogEntriesByIdOffer`(
   IN _idOffer int(10) UNSIGNED)
BEGIN
        SELECT logentry.idLogEntry,
               logentry.idOffer,
               logentry.idUser,
               logentry.idLogEntryType,
               logentry.dateTime,
               logentry.comments,
               peo.Name,
               peo.Surname
          FROM logentriesbyoffer AS logentry
               LEFT JOIN people AS peo ON peo.IdPerson = logentry.idUser
         WHERE idOffer = _idOffer AND idLogEntryType NOT IN (1, 15)
      ORDER BY logentry.`dateTime` DESC;
   END;


DROP PROCEDURE IF EXISTS geos.logentry_GetAllCommentsByIdOffer;
CREATE PROCEDURE geos.`logentry_GetAllCommentsByIdOffer`(
   IN _idOffer int(10) UNSIGNED)
BEGIN
        SELECT logentry.idLogEntry,
               logentry.idOffer,
               logentry.idUser,
               logentry.idLogEntryType,
               logentry.dateTime,
               logentry.comments,
               peo.Name,
               peo.Surname
          FROM logentriesbyoffer AS logentry
               LEFT JOIN people AS peo ON peo.IdPerson = logentry.idUser
         WHERE idOffer = _idOffer AND idLogEntryType IN (1, 15)
      ORDER BY logentry.`dateTime` DESC;
   END;



DROP PROCEDURE IF EXISTS geos.optionsbyoffer_Update;
CREATE PROCEDURE geos.`optionsbyoffer_Update`(
   IN _IdOffer    int(10) UNSIGNED,
   IN _IdOption   int(10) UNSIGNED,
   IN _Quantity   int(10))
BEGIN
      IF (SELECT count(*)
            FROM optionsbyoffer
           WHERE IdOffer = _IdOffer AND IdOption = _IdOption) > 0
      THEN
         BEGIN
            UPDATE optionsbyoffer
               SET Quantity = _Quantity
             WHERE IdOffer = _IdOffer AND IdOption = _IdOption;
         END;
      ELSE
         BEGIN
            INSERT INTO optionsbyoffer(IdOffer, IdOption, Quantity)
                 VALUES (_IdOffer, _IdOption, _Quantity);
         END;
      END IF;
   END;


DROP PROCEDURE IF EXISTS geos.offers_LeadOTUpdate;
CREATE PROCEDURE geos.`offers_LeadOTUpdate`(
   IN _IdOffer                int(10) UNSIGNED,
   IN _Code                   varchar(45),
   IN _IdOfferType            tinyint(4) UNSIGNED,
   IN _IdCustomer             int(10) UNSIGNED,
   IN _IdProject              int(10) UNSIGNED,
   IN _Description            varchar(500),
   IN _IdStatus               int(10) UNSIGNED,
   IN _Amount                 double,
   IN _ProbabilityOfSuccess   tinyint(2),
   IN _OfferExpectedDate      datetime,
   IN _IdCurrency             tinyint(4) UNSIGNED,
   IN _Year                   int(10) UNSIGNED,
   IN _Number                 int(10) UNSIGNED,
   IN _ModifiedBy             smallint(5) UNSIGNED,
   IN _ModifiedIn             datetime,
   IN _DeliveryDate           datetime,
   IN _IdBusinessUnit         tinyint(3) UNSIGNED,
   IN _IdSalesOwner           smallint(5) UNSIGNED,
   IN _IdCarOEM               smallint(5) UNSIGNED,
   IN _IdSource               tinyint(3) UNSIGNED,
   IN _RFQReception           datetime,
   IN _SendIn                 datetime)
BEGIN
      UPDATE offers
         SET Code = _Code,
             idOfferType = _IdOfferType,
             IdCustomer = _IdCustomer,
             IdProject = _IdProject,
             Description = _Description,
             IdStatus = _IdStatus,
             Value = _Amount,
             ProbabilityOfSuccess = _ProbabilityOfSuccess,
             OfferExpectedDate = _OfferExpectedDate,
             IdCurrency = _IdCurrency,
             `Year` = _Year,
             Number = _Number,
             ModifiedBy = _ModifiedBy,
             ModifiedIn = _ModifiedIn,
             DeliveryDate = _DeliveryDate,
             IdBusinessUnit = _IdBusinessUnit,
             IdSalesOwner = _IdSalesOwner,
             IdCarOEM = _IdCarOEM,
             IdSource = _IdSource,
             RFQReception = _RFQReception,
             SendIn = _SendIn
       WHERE IdOffer = _IdOffer;
   END;


DROP PROCEDURE IF EXISTS geos.offers_Update;
CREATE PROCEDURE geos.`offers_Update`(
   IN _Code                   varchar(45),
   IN _IdCustomer             int(10) UNSIGNED,
   IN _IdProject              int(10) UNSIGNED,
   IN _Description            varchar(500),
   IN _IdStatus               int(10) UNSIGNED,
   IN _Amount                 double,
   IN _ProbabilityOfSuccess   tinyint(2),
   IN _OfferExpectedDate      datetime,
   IN _IdCurrency             tinyint(4) UNSIGNED,
   IN _ModifiedBy             smallint(5) UNSIGNED,
   IN _ModifiedIn             datetime,
   IN _DeliveryDate           datetime,
   IN _IdBusinessUnit         tinyint(3) UNSIGNED,
   IN _IdSalesOwner           smallint(5) UNSIGNED,
   IN _IdCarOEM               smallint(5) UNSIGNED,
   IN _IdSource               tinyint(3) UNSIGNED,
   IN _RFQReception           datetime,
   IN _SendIn                 datetime)
BEGIN
      UPDATE offers
         SET IdCustomer = _IdCustomer,
             IdProject = _IdProject,
             Description = _Description,
             IdStatus = _IdStatus,
             Value = _Amount,
             ProbabilityOfSuccess = _ProbabilityOfSuccess,
             OfferExpectedDate = _OfferExpectedDate,
             IdCurrency = _IdCurrency,
             ModifiedBy = _ModifiedBy,
             ModifiedIn = _ModifiedIn,
             DeliveryDate = _DeliveryDate,
             IdBusinessUnit = _IdBusinessUnit,
             IdSalesOwner = _IdSalesOwner,
             IdCarOEM = _IdCarOEM,
             IdSource = _IdSource,
             RFQReception = _RFQReception,
             SendIn = _SendIn
       WHERE Code = _Code;
   END;


DROP PROCEDURE IF EXISTS geos.quotations_GetQuotationsByofferId;
CREATE PROCEDURE geos.`quotations_GetQuotationsByofferId`(
   IN _offerId int(10) UNSIGNED)
BEGIN
      SELECT qu.IdOffer,
             qu.IdQuotation,
             ifnull(qu.QuotQuantity, 0) AS QuotQuantity,
             qu.IdDetectionsTemplate,
             t.IdTemplate,
             t.Name,
             t.Suffix
        FROM quotations qu
             INNER JOIN templates t ON t.IdTemplate = qu.IdDetectionsTemplate
       WHERE qu.IdOffer = _offerId;
   END;


DROP PROCEDURE IF EXISTS geos.offers_UpdateOfferStatus;
CREATE PROCEDURE geos.`offers_UpdateOfferStatus`(
   IN _IdOffer             int(10) UNSIGNED,
   IN _IdStatus            int(10) UNSIGNED,
   IN _IdSalesStatusType   int(10) UNSIGNED,
   IN _StatusDate          datetime,
   IN _ModifiedBy          smallint(5) UNSIGNED,
   IN _ModifiedIn          datetime,
   IN _IsCodeUpdate        varchar(20),
   IN _Code                varchar(45),
   IN _Number              int(10) UNSIGNED,
   IN _IdOfferType tinyint(4) unsigned)
BEGIN
      IF (_IdSalesStatusType = 3)
      THEN
         BEGIN
            IF (_IsCodeUpdate = "True")
            THEN
               BEGIN
                  UPDATE offers
                     SET Code = _Code,
                         Number = _Number,
                         idOfferType =_IdOfferType,
                         IdStatus = _IdStatus,
                         SendIn = _StatusDate,
                         ModifiedBy = _ModifiedBy,
                         ModifiedIn = _ModifiedIn
                   WHERE idoffer = _IdOffer;
               END;
            ELSE
               UPDATE offers
                  SET IdStatus = _IdStatus,
                      SendIn = _StatusDate,
                      ModifiedBy = _ModifiedBy,
                      ModifiedIn = _ModifiedIn
                WHERE idoffer = _IdOffer;
            END IF;
         END;
      ELSEIF (_IdSalesStatusType = 6)
      THEN
         BEGIN
            IF (_IsCodeUpdate = "True")
            THEN
               BEGIN
                  UPDATE offers
                     SET Code = _Code,
                         Number = _Number,
                         idOfferType =_IdOfferType,
                         IdStatus = _IdStatus,
                         RFQReception = _StatusDate,
                         ModifiedBy = _ModifiedBy,
                         ModifiedIn = _ModifiedIn
                   WHERE idoffer = _IdOffer;
               END;
            ELSE
               UPDATE offers
                  SET IdStatus = _IdStatus,
                      RFQReception = _StatusDate,
                      ModifiedBy = _ModifiedBy,
                      ModifiedIn = _ModifiedIn
                WHERE idoffer = _IdOffer;
            END IF;
         END;
      ELSE
         BEGIN
            IF (_IsCodeUpdate = "True")
            THEN
               BEGIN
                  UPDATE offers
                     SET Code = _Code,
                         Number = _Number,
                         idOfferType =_IdOfferType,
                         IdStatus = _IdStatus,
                         ModifiedBy = _ModifiedBy,
                         ModifiedIn = _ModifiedIn
                   WHERE idoffer = _IdOffer;
               END;
            ELSE
               UPDATE offers
                  SET IdStatus = _IdStatus,
                      ModifiedBy = _ModifiedBy,
                      ModifiedIn = _ModifiedIn
                WHERE idoffer = _IdOffer;
            END IF;
         END;
      END IF;
   END;


DROP PROCEDURE IF EXISTS geos.salestargetbysite_Update;
CREATE PROCEDURE geos.`salestargetbysite_Update`(
   IN _IdSite         smallint(5) UNSIGNED,
   IN _Year           smallint(4) UNSIGNED,
   IN _TargetAmount   double UNSIGNED,
   IN _IdCurrency     tinyint(4) UNSIGNED)
BEGIN
      IF (SELECT count(*)
            FROM salestargetbysite
           WHERE IdSite = _IdSite AND Year = _Year) > 0
      THEN
         BEGIN
            UPDATE salestargetbysite
               SET TargetAmount = _TargetAmount, IdCurrency = _IdCurrency
             WHERE IdSite = _IdSite AND Year = _Year;
         END;
      ELSE
         BEGIN
            INSERT INTO salestargetbysite(IdSite,
                                          Year,
                                          TargetAmount,
                                          IdCurrency)
                 VALUES (_IdSite,
                         _Year,
                         _TargetAmount,
                         _IdCurrency);
         END;
      END IF;
   END;


DROP PROCEDURE IF EXISTS geos.lostReasonsByOffer_Update;
CREATE PROCEDURE geos.`lostReasonsByOffer_Update`(
   IN _IdOffer            int(10) UNSIGNED,
   IN _IdLostReasonList   varchar(22),
   IN _IdCompetitor       int(10),
   IN _Comments           varchar(255))
BEGIN
      UPDATE lostreasonsbyoffer
         SET IdLostReasonList = _IdLostReasonList,
             IdCompetitor = _IdCompetitor,
             Comments = _Comments
       WHERE IdOffer = _IdOffer;
   END;




DROP PROCEDURE IF EXISTS geos.lostReasonsByOffer_Insert;
CREATE PROCEDURE geos.`lostReasonsByOffer_Insert`(
   IN _IdOffer            int(10) UNSIGNED,
   IN _IdLostReasonList   varchar(22),
   IN _IdCompetitor       int(10),
   IN _Comments           varchar(255))
BEGIN
      INSERT INTO lostreasonsbyoffer(Idoffer,
                                     IdLostReasonList,
                                     IdCompetitor,
                                     Comments)
           VALUES (_IdOffer,
                   _IdLostReasonList,
                   _IdCompetitor,
                   _Comments);
   END;



DROP PROCEDURE IF EXISTS geos.offers_GetTopOffers;
CREATE PROCEDURE geos.`offers_GetTopOffers`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _offerLimit       smallint(5) UNSIGNED,
   IN _accountingYear   smallint(5) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
      SET @query =
             concat(
                ' SELECT of.IdOffer, ',
                ' of.Code,',
                ' UPPER(cu.Name) AS CustomerGroup,',
                ' co.name AS Country,',
                ' replace(si.name, concat(\'(\', co.name, \')\'), \'\') AS CustomerName,',
                ' of.Description AS OfferTitle,',
                ' CAST( ',
                '    ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))',
                '  AS OfferAmount,',
                ' cur.Name OfferCurrency,',
                ' DATE(IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\')))',
                ' AS ExpectedPoReceptionDate,',
                ' cur.Symbol',
                ' FROM offers of',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idCustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' WHERE     CASE',
                ' WHEN ',
                _idPermission,
                ' = 20',
                ' THEN',
                ' (   si.idsalesresponsible IN (',
                _idUser,
                ' )',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                ' ))',
                ' WHEN ',
                _idPermission,
                ' = 21',
                ' THEN',
                ' (   si.idsalesresponsible IN (',
                _idUser,
                ' )',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                ' ))',
                ' WHEN ',
                _idPermission,
                ' = 22',
                ' THEN',
                ' TRUE',
                ' ELSE',
                ' FALSE',
                ' END',
                ' AND YEAR(',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\'))) =',
                _accountingYear,
                ' AND of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) AND of.idoffertype IN (1, 10)',
                ' AND cu.IdCustomer NOT IN (8, 10)',
                ' AND of.idStatus IN (1)',
                ' Group by of.IdOffer',
                ' ORDER BY OfferAmount DESC',
                ' LIMIT ',
                _offerLimit,
                ';');

       PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;



DROP PROCEDURE IF EXISTS geos.offers_GetSelectedUsersTopOffers;
CREATE PROCEDURE geos.`offers_GetSelectedUsersTopOffers`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(2000),
   IN _offerLimit       smallint(5) UNSIGNED,
   IN _accountingYear   smallint(5) UNSIGNED)
BEGIN
   
      SET @query =
             concat(
                ' SELECT of.IdOffer, ',
                ' of.Code,',
                ' UPPER(cu.Name) AS CustomerGroup,',
                ' co.name AS Country,',
                ' replace(si.name, concat(\'(\', co.name, \')\'), \'\') AS CustomerName,',
                ' of.Description AS OfferTitle,',
                ' CAST( ',
                '    ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))',
                '  AS OfferAmount,',
                ' cur.Name OfferCurrency,',
                ' DATE(IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\')))',
                ' AS ExpectedPoReceptionDate,',
                ' cur.Symbol',
                ' FROM offers of',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idCustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' WHERE ',
                ' (   si.idsalesresponsible IN (',
                _idUser,
                ' )',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                ' ))',
                ' AND YEAR(',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\'))) =',
                _accountingYear,
                ' AND of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) AND of.idoffertype IN (1, 10)',
                ' AND cu.IdCustomer NOT IN (8, 10)',
                ' AND of.idStatus IN (1)',
                ' Group by of.IdOffer',
                ' ORDER BY OfferAmount DESC',
                ' LIMIT ',
                _offerLimit,
                ';');

       PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;



DROP PROCEDURE IF EXISTS geos.offers_GetSalesStatus;
CREATE PROCEDURE geos.`offers_GetSalesStatus`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission   smallint(5) UNSIGNED)
BEGIN
    
        SELECT of.IdStatus AS OfferStatusId,
               oft.Name AS OfferStatusName,
               COUNT(*) AS NumberOfOffers,
               CAST(
                  SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))
                  AS TotalOfferAmount,
               cur.Name AS OfferCurrency,
               cur.Symbol,
               ss.IdImage AS StatusIdImage,
               ss.Name AS Status
          FROM offers of
               LEFT JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types ss
                  ON oft.IdSalesStatusType = ss.IdSalesStatusType
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
                 LEFT JOIN
             (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear 
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer

         WHERE     YEAR(
                      IF(
                         tmp.Code IS NULL,
                         IFNULL(of.DeliveryDate,
                                concat(_accountingYear, '-01-01')),
                         tmp.ReceivedIn)) = _accountingYear
               AND of.idoffertype IN (1, 10)
               AND si.IdCustomer NOT IN (8, 10)
               AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) OR tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
               AND of.idStatus NOT IN (12) AND ss.IdSalesStatusType NOT IN(4)
      GROUP BY Status UNION (SELECT of.IdStatus AS OfferStatusId,
               oft.Name AS OfferStatusName,
               COUNT(*) AS NumberOfOffers,
               CAST(
                  SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))
                  AS TotalOfferAmount,
               cur.Name AS OfferCurrency,
               cur.Symbol,
               ss.IdImage AS StatusIdImage,
               ss.Name AS Status
          FROM offers of
               LEFT JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types ss
                  ON oft.IdSalesStatusType = ss.IdSalesStatusType
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
                 INNER JOIN
             (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear 
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer

         WHERE     YEAR(
                      IF(
                         tmp.Code IS NULL,
                         IFNULL(of.DeliveryDate,
                                concat(_accountingYear, '-01-01')),
                         tmp.ReceivedIn)) = _accountingYear
               AND of.idoffertype IN (1, 10)
               AND si.IdCustomer NOT IN (8, 10)
               AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) AND tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
               AND of.idStatus NOT IN (12) AND ss.IdSalesStatusType IN(4)
      GROUP BY Status);
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetSelectedUsersSalesStatus;
CREATE PROCEDURE geos.`offers_GetSelectedUsersSalesStatus`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(2000),
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                ' SELECT of.IdStatus AS OfferStatusId,',
                ' oft.Name AS OfferStatusName,',
                ' COUNT(*) AS NumberOfOffers,',
                ' CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS TotalOfferAmount,',
                ' cur.Name AS OfferCurrency,',
                ' cur.Symbol,',
                ' ss.IdImage AS StatusIdImage,',
                ' ss.Name AS Status',
                ' FROM offers of',
                ' LEFT JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types ss',
                ' ON oft.IdSalesStatusType = ss.IdSalesStatusType',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
               ' LEFT JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND (of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10) OR tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10))',

                ' AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' AND of.idStatus NOT IN (12)  AND ss.IdSalesStatusType NOT IN(4)',
                ' GROUP BY Status UNION SELECT of.IdStatus AS OfferStatusId,',
                ' oft.Name AS OfferStatusName,',
                ' COUNT(*) AS NumberOfOffers,',
                ' CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS TotalOfferAmount,',
                ' cur.Name AS OfferCurrency,',
                ' cur.Symbol,',
                ' ss.IdImage AS StatusIdImage,',
                ' ss.Name AS Status',
                ' FROM offers of',
                ' LEFT JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types ss',
                ' ON oft.IdSalesStatusType = ss.IdSalesStatusType',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
               ' INNER JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND (of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10) AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10))',

                ' AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' AND of.idStatus NOT IN (12)  AND ss.IdSalesStatusType IN(4)',
                ' GROUP BY Status');

                 PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;



DROP PROCEDURE IF EXISTS geos.templates_GetTemplates;
CREATE PROCEDURE geos.`templates_GetTemplates`()
BEGIN
SELECT * FROM templates;
END;


DROP PROCEDURE IF EXISTS geos.offers_GetSalesStatusByWeek;
CREATE PROCEDURE geos.`offers_GetSalesStatusByWeek`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
        SELECT COUNT(*) AS NumberOfOffers,
               WEEK(
                  IF(
                     tmp.Code IS NULL,
                     IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01')),
                     tmp.ReceivedIn))
                  AS CurrentWeek,
               of.IdStatus AS OfferStatusId,
               oft.Name AS OfferStatusName,
               COUNT(*) AS NumberOfOffers,
               CAST(
                  SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))
                  AS TotalOfferAmount,
               cur.Name AS OfferCurrency,
               cur.Symbol,
               ss.Name AS Status
          FROM offers of
               INNER JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types ss
                  ON oft.IdSalesStatusType = ss.IdSalesStatusType
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               LEFT JOIN
               (  SELECT idoffer, p.code, p.ReceivedIn
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE     YEAR(p.receivedin) = _accountingYear
                         AND p.idsite NOT IN (SELECT IdSite
                                                FROM sites
                                               WHERE IdCustomer = 10)
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     YEAR(
                      IF(
                         tmp.Code IS NULL,
                         IFNULL(of.DeliveryDate,
                                concat(_accountingYear, '-01-01')),
                         tmp.ReceivedIn)) = _accountingYear
               AND of.idoffertype IN (1, 10)
               AND si.IdCustomer NOT IN (8, 10)
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
               AND of.idStatus NOT IN (12)
      GROUP BY of.IdStatus,
               WEEK(
                  IF(
                     tmp.Code IS NULL,
                     IFNULL(of.DeliveryDate,
                            concat(_accountingYear, '-01-01')),
                     tmp.ReceivedIn))
      ORDER BY WEEK(
                  IF(
                     tmp.Code IS NULL,
                     IFNULL(of.DeliveryDate,
                            concat(_accountingYear, '-01-01')),
                     tmp.ReceivedIn)),
               Status;
   END;


DROP PROCEDURE IF EXISTS geos.offercontacts_GetOfferContacts;
CREATE PROCEDURE geos.`offercontacts_GetOfferContacts`(
   IN _IdOffer int(10) UNSIGNED)
BEGIN
      SELECT con.IdOfferContact,
             con.IdOffer,
             con.IdContact,
             p.Name,
             p.Surname,
             p.Email,
             p.Phone,
             p.Observations,
             p.IdPersonGender,
             con.IsPrimaryOfferContact
        FROM offer_contacts con
             INNER JOIN people p ON con.IdContact = p.IdPerson
       WHERE con.IdOffer = _IdOffer;
   END;



DROP PROCEDURE IF EXISTS geos.offers_GetSalesStatusByMonth;
CREATE PROCEDURE geos.`offers_GetSalesStatusByMonth`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission   smallint(5) UNSIGNED)
BEGIN
    
       Select * from( SELECT COUNT(*) AS NumberOfOffers,
               Month(
                  IF(
                     tmp.Code IS NULL,
                     IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01')),
                     tmp.ReceivedIn))
                  AS CurrentMonth,
               of.IdStatus AS OfferStatusId,
               oft.Name AS OfferStatusName,
              
               CAST(
                  SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))
                  AS TotalOfferAmount,
               cur.Name AS OfferCurrency,
               cur.Symbol,
               ss.Name AS Status
          FROM offers of
               LEFT JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types ss
                  ON oft.IdSalesStatusType = ss.IdSalesStatusType
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               LEFT JOIN
             (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear 
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     YEAR(
                      IF(
                         tmp.Code IS NULL,
                         IFNULL(of.DeliveryDate,
                                concat(_accountingYear, '-01-01')),
                         tmp.ReceivedIn)) = _accountingYear
               AND of.idoffertype IN (1, 10)
               AND si.IdCustomer NOT IN (8, 10)
              AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) OR tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                        THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
               AND of.idStatus NOT IN (12) AND ss.IdSalesStatusType NOT IN(4)
      GROUP BY CurrentMonth, Status
       UNION  SELECT COUNT(*) AS NumberOfOffers,
               Month(
                  IF(
                     tmp.Code IS NULL,
                     IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01')),
                     tmp.ReceivedIn))
                  AS CurrentMonth,
               of.IdStatus AS OfferStatusId,
               oft.Name AS OfferStatusName,
              
               CAST(
                  SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))
                  AS TotalOfferAmount,
               cur.Name AS OfferCurrency,
               cur.Symbol,
               ss.Name AS Status
          FROM offers of
               LEFT JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types ss
                  ON oft.IdSalesStatusType = ss.IdSalesStatusType
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN
             (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear 
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     YEAR(
                      IF(
                         tmp.Code IS NULL,
                         IFNULL(of.DeliveryDate,
                                concat(_accountingYear, '-01-01')),
                         tmp.ReceivedIn)) = _accountingYear
               AND of.idoffertype IN (1, 10)
               AND si.IdCustomer NOT IN (8, 10)
              AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) AND tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                        THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
               AND of.idStatus NOT IN (12)  AND ss.IdSalesStatusType IN(4)
      GROUP BY CurrentMonth, Status) As tmp2
      ORDER BY tmp2.CurrentMonth, tmp2.Status;
   END;



DROP PROCEDURE IF EXISTS geos.offers_GetSelectedUserSalesStatusByMonth;
CREATE PROCEDURE geos.`offers_GetSelectedUserSalesStatusByMonth`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(200),
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                ' select * from(SELECT COUNT(*) AS NumberOfOffers,',
                ' Month(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn))',
                ' AS CurrentMonth,',
                ' of.IdStatus AS OfferStatusId,',
                ' oft.Name AS OfferStatusName,',
                
                ' CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS TotalOfferAmount,',
                ' cur.Name AS OfferCurrency,',
                ' cur.Symbol,',
                ' ss.Name AS Status',
                ' FROM offers of',
                ' LEFT JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types ss',
                ' ON oft.IdSalesStatusType = ss.IdSalesStatusType',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' LEFT JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND (of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10) OR tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10))',

                ' AND (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' AND of.idStatus NOT IN (12)  AND ss.IdSalesStatusType NOT IN(4)',
                ' GROUP BY CurrentMonth, Status',
                ' UNION SELECT COUNT(*) AS NumberOfOffers,',
                ' Month(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn))',
                ' AS CurrentMonth,',
                ' of.IdStatus AS OfferStatusId,',
                ' oft.Name AS OfferStatusName,',
               
                ' CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS TotalOfferAmount,',
                ' cur.Name AS OfferCurrency,',
                ' cur.Symbol,',
                ' ss.Name AS Status',
                ' FROM offers of',
                ' LEFT JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types ss',
                ' ON oft.IdSalesStatusType = ss.IdSalesStatusType',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND (of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10) AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10))',

                ' AND (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' AND of.idStatus NOT IN (12) AND ss.IdSalesStatusType IN(4)',
                ' GROUP BY CurrentMonth, Status) As tmp2',
                ' ORDER BY tmp2.CurrentMonth, tmp2.Status');
                
         PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.salestargetbysite_GetSalesStatusTarget;
CREATE PROCEDURE geos.`salestargetbysite_GetSalesStatusTarget`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
      SELECT CAST(
                Sum(ROUND(t.TargetAmount, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))
                AS SalesTarget,
             cur.Name,
             cur.Symbol
        FROM sites s
             INNER JOIN countries co ON co.idcountry = s.idcountry
             INNER JOIN zones zo ON zo.idzone = co.idzone
             INNER JOIN salestargetbysite t
                ON t.idsite = s.idsite AND t.year = _accountingYear
             INNER JOIN currencyconversions cc
                ON     cc.idcurrencyFrom = t.idcurrency
                   AND idcurrencyTo = _idcurrency
             INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
       WHERE     s.IdCustomer NOT IN (8, 10)
             AND CASE
                    WHEN _idPermission = 20
                    THEN
                       (   s.idsalesresponsible IN (_idUser)
                        OR s.IdSalesResponsibleAssemblyBU IN (_idUser))
                    WHEN _idPermission = 21
                    THEN
                       (   s.idsalesresponsible IN (_idUser)
                        OR s.IdSalesResponsibleAssemblyBU IN (_idUser))
                    WHEN _idPermission = 22
                    THEN
                       TRUE
                    ELSE
                       FALSE
                 END;
   END;


DROP PROCEDURE IF EXISTS geos.salestargetbysite_GetSelectedUsersSalesStatusTarget;
CREATE PROCEDURE geos.`salestargetbysite_GetSelectedUsersSalesStatusTarget`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(2000),
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                ' SELECT CAST(',
                ' Sum(ROUND(t.TargetAmount, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS SalesTarget,',
                ' cur.Name,',
                ' cur.Symbol',
                ' FROM sites s',
                ' INNER JOIN countries co ON co.idcountry = s.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN salestargetbysite t',
                ' ON t.idsite = s.idsite AND t.year = ',
                _accountingYear,
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = t.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' WHERE     s.IdCustomer NOT IN (8, 10)',
                ' AND  (   s.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR s.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))');
                         PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;



DROP PROCEDURE IF EXISTS geos.currencyconversions_GetCurrencyConversions;
CREATE PROCEDURE geos.`currencyconversions_GetCurrencyConversions`()
BEGIN
SELECT cc.idcurrencyfrom,cc.idcurrencyto ,curFrom.Name AS CurrencyFrom,curTo.Name AS CurrencyTo,cc.ExchangeRate,DATE(cc.LastUpdate) AS ModificationDate
FROM currencyconversions cc
INNER JOIN currency curFrom ON curFrom.idCurrency=cc.idcurrencyFrom
INNER JOIN currency curTo ON curTo.idCurrency=cc.idcurrencyTo
ORDER BY idcurrencyfrom,idcurrencyto;
END;



DROP PROCEDURE IF EXISTS geos.people_GetPeopleContacts;
CREATE PROCEDURE geos.`people_GetPeopleContacts`(
   IN _idUser         smallint(5) UNSIGNED,
   IN _idZone         smallint(5) UNSIGNED,
   IN _idPermission   smallint(5) UNSIGNED)
BEGIN
      SELECT p.IdPerson AS IdContact,
             p.Name AS FirstName,
             Surname AS LastName,
             IFNULL(LOWER(p.Email), '') AS ContactEmail,
             IFNULL(p.Phone, '') AS ContactPhone,
             t.Name AS Department
        FROM people p
             INNER JOIN peopletypes t ON t.idPersonType = p.idPersonType
       WHERE IdSite IN
                (SELECT IdSite
                   FROM Sites si
                        INNER JOIN countries co
                           ON co.idcountry = si.idcountry
                        INNER JOIN zones zo ON zo.idzone = co.idzone
                  WHERE     CASE
                               WHEN _idPermission = 20
                               THEN
                                  (   si.idsalesresponsible IN (_idUser)
                                   OR si.IdSalesResponsibleAssemblyBU IN
                                         (_idUser))
                               WHEN _idPermission = 21
                               THEN
                                  (   si.idsalesresponsible IN (_idUser)
                                   OR si.IdSalesResponsibleAssemblyBU IN
                                         (_idUser))
                               WHEN _idPermission = 22
                               THEN
                                  TRUE
                               ELSE
                                  FALSE
                            END
                        AND IdCustomer NOT IN (8, 10));
   END;



DROP PROCEDURE IF EXISTS geos.people_GetContactsOfSiteByOfferId;
CREATE PROCEDURE geos.`people_GetContactsOfSiteByOfferId`(
   IN _idSite int(10) UNSIGNED)
BEGIN
      SELECT p.IdPerson,
             p.Name,
             p.Surname,
             p.IdPersonType,
             p.Email,
             p.IdSite,
             p.IsStillActive,
             p.Phone,
             p.Observations,
             p.CreatedIn,
             p.DisabledIn,
             p.IdPersonGender,
             pt.Name AS Department
        FROM people p
             INNER JOIN peopletypes pt ON pt.IdPersonType = p.IdPersonType
       WHERE p.IdSite = _idSite;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetSiteInfo;
CREATE PROCEDURE geos.`sites_GetSiteInfo`(
   IN _idUser         smallint(5) UNSIGNED,
   IN _idZone         smallint(5) UNSIGNED,
   IN _idPermission   smallint(5) UNSIGNED)
BEGIN
      SELECT s.IdSite,
             UPPER(c.Name) AS CustomerGroup,
             s.Name AS CustomerName,
             IFNULL(s.RegisteredName, '') AS CustomerOfficialName,
             IFNULL(s.Cif, '') AS CustomerVatNumber,
             UPPER(co.Name) AS CustomerCountry,
             s.Address AS CustomerAddress,
             IFNULL(s.City, '') AS CustomerCity,
             IFNULL(s.PostCode, '') AS CustomerCityZipCode,
             IFNULL(s.Region, '') AS CustomerRegion,
             'Latitude' AS LocationLatitude,
             'Longitud' AS LocationLongitude,
             IFNULL(s.Telephone, '') AS CustomerPhone,
             IFNULL(s.Fax, '') AS CustomerFax,
             IFNULL(s.Website, '') AS CustomerWebsite,
             p.Name AS SalesOwnerFirstName,
             p.Surname AS SalesOwnerLastName,
             "2.000.000" AS AnnualSalesTargetAmount,
             'EUR' AS AnnualSalesTargetCurrency,
             'Business' AS CustomerBusiness,
             '200' AS CustomerSizeInSquareMeters,
             '2000' AS CustomerNumberOfEmployees
        FROM sites s
             INNER JOIN customers c ON c.IdCustomer = s.IdCustomer
             INNER JOIN countries co ON co.IdCountry = s.IdCountry
             INNER JOIN zones zo ON zo.IdZone = co.IdZone
             LEFT JOIN people p ON p.IdPerson = s.IdSalesResponsible
       WHERE     s.IdCustomer NOT IN (8, 10)
             AND CASE
                    WHEN _idPermission = 20
                    THEN
                       (   s.idsalesresponsible IN (_idUser)
                        OR s.IdSalesResponsibleAssemblyBU IN (_idUser))
                    WHEN _idPermission = 21
                    THEN
                       (   s.idsalesresponsible IN (_idUser)
                        OR s.IdSalesResponsibleAssemblyBU IN (_idUser))
                    WHEN _idPermission = 22
                    THEN
                       TRUE
                    ELSE
                       FALSE
                 END;
   END;


DROP PROCEDURE IF EXISTS geos.emdepsites_GetAllPlantsDetails;
CREATE PROCEDURE geos.`emdepsites_GetAllPlantsDetails`(
   IN _idUser smallint(5) UNSIGNED)
BEGIN
        SELECT emsi.idSite,
               emsi.IP,
               emsi.Code,
               emsi.DatabaseIP,
               si.ShortName,
               si.Name
          FROM emdepsites emsi
               INNER JOIN sites si ON emsi.idSite = si.IdSite
               INNER JOIN emdep_geos.site_user_permission usrpermission
                  ON usrpermission.IdCompany = si.IdSite
         WHERE usrpermission.IdUser = _IdUser
      GROUP BY emsi.idSite;
   END;


DROP PROCEDURE IF EXISTS geos.emdepsites_GetAllPlantsDetailsById;
CREATE PROCEDURE geos.`emdepsites_GetAllPlantsDetailsById`(
   IN _idUser   smallint(5) UNSIGNED,
   IN _idSite   smallint(5) UNSIGNED)
BEGIN
        SELECT emsi.idSite,
               emsi.IP,
               emsi.Code,
               emsi.DatabaseIP,
               si.ShortName
          FROM emdepsites emsi
               INNER JOIN sites si ON emsi.idSite = si.IdSite
               INNER JOIN emdep_geos.site_user_permission usrpermission
                  ON usrpermission.IdCompany = si.IdSite
         WHERE usrpermission.IdUser = _IdUser AND emsi.idSite = _idSite
      GROUP BY emsi.idSite;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetOffersWithoutPurchaseOrder;
CREATE PROCEDURE geos.`offers_GetOffersWithoutPurchaseOrder`(
   IN _idUser           smallint(5) UNSIGNED,
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
 DROP TEMPORARY TABLE IF EXISTS table2;
 CREATE TEMPORARY TABLE IF NOT EXISTS table2 AS (
              
      SELECT of.idoffer ,
             of.idOfferType AS IdOfferType,
             of.Code AS OfferCode,
             of.description AS OfferTitle,
             of.IdSalesOwner,
             zo.name AS CustomerZone,
             UPPER(co.name) AS CustomerCountry,
             UPPER(cu.name) AS CustomerGroup,
             si.IdSite AS IdSite,
             si.IdSalesResponsible,
             si.IdSalesResponsibleAssemblyBU,
             replace(si.name, concat('(', co.name, ')'), '') AS SiteName,
             cu.IdCustomer AS IdCustomer,
             cu.Name AS CustomerName,
             oft.IdOfferStatusType AS OfferStatusid,
             oft.name AS OfferStatus,
             oft.HtmlColor AS OfferStatusColor,
             CAST(
                ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))
                AS OfferAmount,
             cur.IdCurrency,
             cur.name AS OfferCurrency,
             of.probabilityofsuccess AS OfferConfidentialLevel,
             DATE(IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01')))
                AS OfferExpectedPODate,
             sst.IdSalesStatusType,
             sst.Name AS SalesStatusType,
             sst.HtmlColor AS SalesStatusTypeColor
             FROM offers of
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types sst
                  ON sst.IdSalesStatusType = oft.IdSalesStatusType
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo

                LEFT JOIN customerpurchaseordersbyoffer cpbo
                  ON cpbo.idoffer = of.idoffer


         WHERE     YEAR(
                      IFNULL(of.DeliveryDate,
                             concat(_accountingYear, '-01-01'))) =
                      _accountingYear
               AND of.idoffertype IN (1, 10)
               AND si.IdCustomer NOT IN (8, 10)
               AND of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 )   
               AND ((of.idstatus NOT IN (12) AND cpbo.IdOffer IS NULL) OR (of.idstatus IN (4) AND NOT cpbo.IdOffer IS NULL))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                        (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      GROUP BY of.idoffer
      ORDER BY of.year, of.number);
      
     select * from table2;
      
        SELECT op.IdOffer,
               op.IdOption,
               op.Quantity,
               ofop.Name AS offeroption,
               ofop.IdOfferOptionType,
               oftype.Name AS offeroptiontype
          FROM 
                optionsbyoffer op
               INNER JOIN offeroptions ofop
                  ON op.IdOption = ofop.idOfferOption
               INNER JOIN offeroptiontypes oftype
                  ON oftype.IdOfferOptionType = ofop.IdOfferOptionType
             
         WHERE  op.IdOffer IN(select idoffer from table2)
      GROUP BY op.IdOffer, op.IdOption;
     
   END;



DROP PROCEDURE IF EXISTS geos.offers_GetSelectedUsersOffersWithoutPurchaseOrder;
CREATE PROCEDURE geos.`offers_GetSelectedUsersOffersWithoutPurchaseOrder`(
   IN _idUser           varchar(2000),
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
 DROP TEMPORARY TABLE IF EXISTS table2;
      SET @query =
             concat( ' CREATE TEMPORARY TABLE IF NOT EXISTS table2 AS (',
                '  SELECT of.idoffer,',
                ' of.idOfferType AS IdOfferType,',
                ' of.Code AS OfferCode,',
                ' of.description AS OfferTitle,',
                ' of.IdSalesOwner,',
                ' zo.name AS CustomerZone,',
                ' UPPER(co.name) AS CustomerCountry,',
                ' UPPER(cu.name) AS CustomerGroup,',
                ' si.IdSite AS IdSite,',
                ' si.IdSalesResponsible,',
                ' si.IdSalesResponsibleAssemblyBU,',
                ' replace(si.name, concat(\'(\', co.name, \')\'), \'\') AS SiteName,',
                ' cu.IdCustomer AS IdCustomer,',
                ' cu.Name AS CustomerName,',
                ' oft.IdOfferStatusType AS OfferStatusid,',
                ' oft.name AS OfferStatus,',
                ' oft.HtmlColor AS OfferStatusColor,',
                ' CAST(',
                ' ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))',
                ' AS OfferAmount,',
                ' cur.IdCurrency,',
                ' cur.name AS OfferCurrency,',
                ' of.probabilityofsuccess AS OfferConfidentialLevel,',
                ' DATE(IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\')))',
                ' AS OfferExpectedPODate,',
                ' sst.IdSalesStatusType,',
                ' sst.Name AS SalesStatusType,',
                ' sst.HtmlColor AS SalesStatusTypeColor',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types sst',
                '  ON sst.IdSalesStatusType = oft.IdSalesStatusType',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' LEFT JOIN ',
                 ' customerpurchaseordersbyoffer cpbo  ON cpbo.idoffer = of.idoffer',
                ' WHERE     YEAR(',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\'))) =',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10)',
                ' AND si.IdCustomer NOT IN (8, 10)',
               ' AND of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 )',
                ' AND ((of.idstatus NOT IN (12) AND cpbo.IdOffer IS NULL) OR (of.idstatus IN (4) AND NOT cpbo.IdOffer IS NULL))',
                ' AND (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY of.idoffer',
                ' ORDER BY of.year, of.number)');

       PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
       
       select * from table2;
       
        SELECT op.IdOffer,
               op.IdOption,
               op.Quantity,
               ofop.Name AS offeroption,
               ofop.IdOfferOptionType,
               oftype.Name AS offeroptiontype
          FROM 
                optionsbyoffer op
               INNER JOIN offeroptions ofop
                  ON op.IdOption = ofop.idOfferOption
               INNER JOIN offeroptiontypes oftype
                  ON oftype.IdOfferOptionType = ofop.IdOfferOptionType
             
         WHERE  op.IdOffer IN(select idoffer from table2)
      GROUP BY op.IdOffer, op.IdOption;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetOfferPipeline;
CREATE PROCEDURE geos.`offers_GetOfferPipeline`(
   IN _idUser           smallint(5) UNSIGNED,
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
       Select * from ( SELECT of.idoffer,
               of.idOfferType AS IdOfferType,
               of.Code AS OfferCode,
               of.description AS OfferTitle,
               of.IdBusinessUnit,
               of.IdSource,
               of.IdSalesOwner,
               of.sendIn,
               of.RFQReception,
               UPPER(zo.name) AS CustomerZone,
               UPPER(co.name) AS CustomerCountry,
               UPPER(cu.name) AS CustomerGroup,
               si.IdSite AS IdSite,
               si.IdSalesResponsible,
               si.IdSalesResponsibleAssemblyBU,
               replace(si.name, concat('(', co.name, ')'), '') AS SiteName,
               cu.IdCustomer AS IdCustomer,
               cu.Name AS CustomerName,
               oft.IdOfferStatusType AS OfferStatusid,
               oft.name AS OfferStatus,
               oft.HtmlColor AS OfferStatusColor,
               CAST(
                  ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))
                  AS OfferAmount,
               cur.IdCurrency,
               cur.name AS OfferCurrency,
               of.probabilityofsuccess AS OfferConfidentialLevel,
               IF(
                  sst.IdSalesStatusType = 4,
                  (  SELECT tp.ReceivedIn
                       FROM customerpurchaseordersbyoffer tpo
                            INNER JOIN customerpurchaseorders tp
                               ON tp.idcustomerpurchaseorders =
                                     tpo.idcustomerpurchaseorder
                      WHERE tpo.idOffer = of.idOffer
                   ORDER BY tp.ReceivedIn ASC
                      LIMIT 1),
                  DATE(
                     IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01'))))
                  AS OfferExpectedPODate,
               of.CreatedIn,
               of.ModifiedIn,
               sst.IdSalesStatusType,
               sst.Name AS SalesStatusType,
               sst.HtmlColor AS SalesStatusTypeColor,of.year,of.Number
          FROM offers of
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types sst
                  ON sst.IdSalesStatusType = oft.IdSalesStatusType
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               LEFT JOIN
                (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear 
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     YEAR(
                      IF(
                         tmp.Code IS NULL,
                         IFNULL(of.DeliveryDate,
                                concat(_accountingYear, '-01-01')),
                         tmp.ReceivedIn)) = _accountingYear
               AND of.idoffertype IN (1, 10) AND sst.IdSalesStatusType NOT IN(4)
               AND si.IdCustomer NOT IN (8, 10)
               AND of.idstatus NOT IN (12)
                AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) OR tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      GROUP BY of.IdOffer UNION SELECT of.idoffer,
               of.idOfferType AS IdOfferType,
               of.Code AS OfferCode,
               of.description AS OfferTitle,
               of.IdBusinessUnit,
               of.IdSource,
               of.IdSalesOwner,
               of.sendIn,
               of.RFQReception,
               UPPER(zo.name) AS CustomerZone,
               UPPER(co.name) AS CustomerCountry,
               UPPER(cu.name) AS CustomerGroup,
               si.IdSite AS IdSite,
               si.IdSalesResponsible,
               si.IdSalesResponsibleAssemblyBU,
               replace(si.name, concat('(', co.name, ')'), '') AS SiteName,
               cu.IdCustomer AS IdCustomer,
               cu.Name AS CustomerName,
               oft.IdOfferStatusType AS OfferStatusid,
               oft.name AS OfferStatus,
               oft.HtmlColor AS OfferStatusColor,
               CAST(
                  ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))
                  AS OfferAmount,
               cur.IdCurrency,
               cur.name AS OfferCurrency,
               of.probabilityofsuccess AS OfferConfidentialLevel,
               IF(
                  sst.IdSalesStatusType = 4,
                  (  SELECT tp.ReceivedIn
                       FROM customerpurchaseordersbyoffer tpo
                            INNER JOIN customerpurchaseorders tp
                               ON tp.idcustomerpurchaseorders =
                                     tpo.idcustomerpurchaseorder
                      WHERE tpo.idOffer = of.idOffer
                   ORDER BY tp.ReceivedIn ASC
                      LIMIT 1),
                  DATE(
                     IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01'))))
                  AS OfferExpectedPODate,
               of.CreatedIn,
               of.ModifiedIn,
               sst.IdSalesStatusType,
               sst.Name AS SalesStatusType,
               sst.HtmlColor AS SalesStatusTypeColor,of.year,of.Number
          FROM offers of
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types sst
                  ON sst.IdSalesStatusType = oft.IdSalesStatusType
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               INNER JOIN
                (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear 
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     YEAR(
                      IF(
                         tmp.Code IS NULL,
                         IFNULL(of.DeliveryDate,
                                concat(_accountingYear, '-01-01')),
                         tmp.ReceivedIn)) = _accountingYear
               AND of.idoffertype IN (1, 10) AND sst.IdSalesStatusType IN(4)
               AND si.IdCustomer NOT IN (8, 10)
               AND of.idstatus NOT IN (12)
               AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) AND tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      GROUP BY of.IdOffer) As tmp2
      ORDER BY tmp2.year, tmp2.number;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetOfferPipelineLogEntryWise;
CREATE PROCEDURE geos.`offers_GetOfferPipelineLogEntryWise`(
   IN _idUser           smallint(5) UNSIGNED,
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
        Select * from (SELECT of.idoffer,
                        
               oft.IdOfferStatusType AS OfferStatusid,
               oft.name AS OfferStatus,
               oft.HtmlColor AS OfferStatusColor,
               CAST(
                  ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))
                  AS OfferAmount,
                         
               sst.IdSalesStatusType,
               sst.Name AS SalesStatusType,
               sst.HtmlColor AS SalesStatusTypeColor,
               tmplogentry.comments,
               tmplogentry.idLogEntry,of.year, of.number
             
          FROM offers of
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types sst
                  ON sst.IdSalesStatusType = oft.IdSalesStatusType
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               INNER JOIN
               (  SELECT comments, idOffer, idLogEntry
                    FROM logentriesbyoffer
                   WHERE iduser = 164
              
                ORDER BY logentriesbyoffer.`dateTime` ASC) AS tmplogentry
                  ON tmplogentry.idOffer = of.IdOffer
               LEFT JOIN
               (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear 
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     YEAR(
                      IF(
                         tmp.Code IS NULL,
                         IFNULL(of.DeliveryDate,
                                concat(_accountingYear, '-01-01')),
                         tmp.ReceivedIn)) = _accountingYear
               AND of.idoffertype IN (1, 10)  AND sst.IdSalesStatusType NOT IN(4)
               AND si.IdCustomer NOT IN (8, 10)
               AND of.idstatus NOT IN (12)
                AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) OR tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      GROUP BY tmplogentry.idLogEntry,of.IdOffer UNION SELECT of.idoffer,
                        
               oft.IdOfferStatusType AS OfferStatusid,
               oft.name AS OfferStatus,
               oft.HtmlColor AS OfferStatusColor,
               CAST(
                  ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))
                  AS OfferAmount,
                         
               sst.IdSalesStatusType,
               sst.Name AS SalesStatusType,
               sst.HtmlColor AS SalesStatusTypeColor,
               tmplogentry.comments,
               tmplogentry.idLogEntry,of.year, of.number
             
          FROM offers of
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types sst
                  ON sst.IdSalesStatusType = oft.IdSalesStatusType
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               INNER JOIN
               (  SELECT comments, idOffer, idLogEntry
                    FROM logentriesbyoffer
                   WHERE iduser = 164
              
                ORDER BY logentriesbyoffer.`dateTime` ASC) AS tmplogentry
                  ON tmplogentry.idOffer = of.IdOffer
               INNER JOIN
               (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear 
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     YEAR(
                      IF(
                         tmp.Code IS NULL,
                         IFNULL(of.DeliveryDate,
                                concat(_accountingYear, '-01-01')),
                         tmp.ReceivedIn)) = _accountingYear
               AND of.idoffertype IN (1, 10)  AND sst.IdSalesStatusType IN(4)
               AND si.IdCustomer NOT IN (8, 10)
               AND of.idstatus NOT IN (12)
                AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) AND tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      GROUP BY tmplogentry.idLogEntry,of.IdOffer) As tmp2
      ORDER BY tmp2.year, tmp2.number;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetSelectedUserOfferPipeline;
CREATE PROCEDURE geos.`offers_GetSelectedUserOfferPipeline`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(2000),
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                ' Select * from (SELECT of.idoffer,',
                ' of.idOfferType AS IdOfferType,',
                ' of.Code AS OfferCode,',
                ' of.description AS OfferTitle,',
                ' of.IdSalesOwner,',
                ' of.sendIn,',
                ' of.RFQReception,',
                ' UPPER(zo.name) AS CustomerZone,',
                ' UPPER(co.name) AS CustomerCountry,',
                ' UPPER(cu.name) AS CustomerGroup,',
                ' si.IdSite AS IdSite,',
                ' si.IdSalesResponsible,',
                ' si.IdSalesResponsibleAssemblyBU,',
                ' replace(si.name, concat(\'(\', co.name, \')\'), \'\') AS SiteName,',
                ' cu.IdCustomer AS IdCustomer,',
                ' cu.Name AS CustomerName,',
                ' oft.IdOfferStatusType AS OfferStatusid,',
                ' oft.name AS OfferStatus,',
                ' oft.HtmlColor AS OfferStatusColor,',
                ' CAST(',
                ' ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))',
                ' AS OfferAmount,',
                ' cur.IdCurrency,',
                ' cur.name AS OfferCurrency,',
                ' of.probabilityofsuccess AS OfferConfidentialLevel,',
                ' IF(',
                ' sst.IdSalesStatusType = 4,',
                ' (  SELECT tp.ReceivedIn',
                '  FROM customerpurchaseordersbyoffer tpo',
                ' INNER JOIN customerpurchaseorders tp',
                ' ON tp.idcustomerpurchaseorders =',
                ' tpo.idcustomerpurchaseorder',
                ' WHERE tpo.idOffer = of.idOffer',
                ' ORDER BY tp.ReceivedIn ASC',
                '  LIMIT 1),',
                ' DATE(IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ',\'-01-01\'))))',
                ' AS OfferExpectedPODate,',
                ' of.CreatedIn,',
                ' of.ModifiedIn,',
                ' sst.IdSalesStatusType,',
                ' sst.Name AS SalesStatusType,',
                ' sst.HtmlColor AS SalesStatusTypeColor,of.year, of.number',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types sst',
                ' ON sst.IdSalesStatusType = oft.IdSalesStatusType',
                ' INNER JOIN currencyconversions cc',
                ' ON cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
               ' LEFT JOIN',
                '  (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10) AND sst.IdSalesStatusType NOT IN (4) ',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND of.idstatus NOT IN (12)',
               ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) OR tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) ',
                ' AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY of.IdOffer UNION SELECT of.idoffer,',
                ' of.idOfferType AS IdOfferType,',
                ' of.Code AS OfferCode,',
                ' of.description AS OfferTitle,',
                ' of.IdSalesOwner,',
                ' of.sendIn,',
                ' of.RFQReception,',
                ' UPPER(zo.name) AS CustomerZone,',
                ' UPPER(co.name) AS CustomerCountry,',
                ' UPPER(cu.name) AS CustomerGroup,',
                ' si.IdSite AS IdSite,',
                ' si.IdSalesResponsible,',
                ' si.IdSalesResponsibleAssemblyBU,',
                ' replace(si.name, concat(\'(\', co.name, \')\'), \'\') AS SiteName,',
                ' cu.IdCustomer AS IdCustomer,',
                ' cu.Name AS CustomerName,',
                ' oft.IdOfferStatusType AS OfferStatusid,',
                ' oft.name AS OfferStatus,',
                ' oft.HtmlColor AS OfferStatusColor,',
                ' CAST(',
                ' ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))',
                ' AS OfferAmount,',
                ' cur.IdCurrency,',
                ' cur.name AS OfferCurrency,',
                ' of.probabilityofsuccess AS OfferConfidentialLevel,',
                ' IF(',
                ' sst.IdSalesStatusType = 4,',
                ' (  SELECT tp.ReceivedIn',
                '  FROM customerpurchaseordersbyoffer tpo',
                ' INNER JOIN customerpurchaseorders tp',
                ' ON tp.idcustomerpurchaseorders =',
                ' tpo.idcustomerpurchaseorder',
                ' WHERE tpo.idOffer = of.idOffer',
                ' ORDER BY tp.ReceivedIn ASC',
                '  LIMIT 1),',
                ' DATE(IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ',\'-01-01\'))))',
                ' AS OfferExpectedPODate,',
                ' of.CreatedIn,',
                ' of.ModifiedIn,',
                ' sst.IdSalesStatusType,',
                ' sst.Name AS SalesStatusType,',
                ' sst.HtmlColor AS SalesStatusTypeColor,of.year, of.number',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types sst',
                ' ON sst.IdSalesStatusType = oft.IdSalesStatusType',
                ' INNER JOIN currencyconversions cc',
                ' ON cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
               ' INNER JOIN',
                '  (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10) AND sst.IdSalesStatusType IN (4) ',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND of.idstatus NOT IN (12)',
               ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) ',
                ' AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY of.IdOffer) As tmp2',
                ' ORDER BY tmp2.year, tmp2.number;');

        PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetSelectedUserOfferPipelineLogEntryWise;
CREATE PROCEDURE geos.`offers_GetSelectedUserOfferPipelineLogEntryWise`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(2000),
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                ' Select * from ( SELECT of.idoffer,',
               
                ' oft.IdOfferStatusType AS OfferStatusid,',
                ' oft.name AS OfferStatus,',
                ' oft.HtmlColor AS OfferStatusColor,',
                ' CAST(',
                ' ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))',
                ' AS OfferAmount,',
              
                ' sst.IdSalesStatusType,',
                ' sst.Name AS SalesStatusType,',
                ' sst.HtmlColor AS SalesStatusTypeColor,',
                ' tmplogentry.comments,',
                ' tmplogentry.idLogEntry, of.year, of.number',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types sst',
                ' ON sst.IdSalesStatusType = oft.IdSalesStatusType',
                ' INNER JOIN currencyconversions cc',
                ' ON cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN',
                ' (  SELECT comments, idOffer, idLogEntry',
                ' FROM logentriesbyoffer',
                ' WHERE iduser = 164',
               
                ' ORDER BY logentriesbyoffer.`dateTime` ASC) AS tmplogentry',
                ' ON tmplogentry.idOffer = of.IdOffer',
              
                ' LEFT JOIN',
                '  (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10) AND sst.IdSalesStatusType NOT IN (4) ',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND of.idstatus NOT IN (12)',
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) OR tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) ',
                ' AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY tmplogentry.idLogEntry,of.idoffer UNION SELECT of.idoffer,',
               
                ' oft.IdOfferStatusType AS OfferStatusid,',
                ' oft.name AS OfferStatus,',
                ' oft.HtmlColor AS OfferStatusColor,',
                ' CAST(',
                ' ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))',
                ' AS OfferAmount,',
              
                ' sst.IdSalesStatusType,',
                ' sst.Name AS SalesStatusType,',
                ' sst.HtmlColor AS SalesStatusTypeColor,',
                ' tmplogentry.comments,',
                ' tmplogentry.idLogEntry, of.year, of.number',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types sst',
                ' ON sst.IdSalesStatusType = oft.IdSalesStatusType',
                ' INNER JOIN currencyconversions cc',
                ' ON cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN',
                ' (  SELECT comments, idOffer, idLogEntry',
                ' FROM logentriesbyoffer',
                ' WHERE iduser = 164',
               
                ' ORDER BY logentriesbyoffer.`dateTime` ASC) AS tmplogentry',
                ' ON tmplogentry.idOffer = of.IdOffer',
              
                ' INNER JOIN',
                '  (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10) AND sst.IdSalesStatusType IN (4) ',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND of.idstatus NOT IN (12)',
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) ',
                ' AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY tmplogentry.idLogEntry,of.idoffer) As tmp2',
                ' ORDER BY tmp2.year, tmp2.number;');

        PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetOffersDailyEvents;
CREATE PROCEDURE geos.`offers_GetOffersDailyEvents`(
   IN _idUser           smallint(5) UNSIGNED,
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
      SELECT of.idoffer,
             of.Code AS OfferCode,
             of.description AS OfferTitle,
             oft.IdOfferStatusType AS OfferStatusid,
             oft.name AS OfferStatus,
             oft.HtmlColor AS OfferStatusColor,
             DATE(IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01')))
                AS OfferExpectedPODate,
             sst.IdSalesStatusType,
             sst.Name AS SalesStatusType,
             sst.HtmlColor AS SalesStatusTypeColor
             FROM offers of
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types sst
                  ON sst.IdSalesStatusType = oft.IdSalesStatusType

                LEFT JOIN customerpurchaseordersbyoffer cpbo
                  ON cpbo.idoffer = of.idoffer

         WHERE     YEAR(
                      IFNULL(of.DeliveryDate,
                             concat(_accountingYear, '-01-01'))) =
                      _accountingYear
               AND of.idoffertype IN (1, 10)
               AND si.IdCustomer NOT IN (8, 10)
                AND of.IdCustomerToDelivery NOT IN (SELECT IdSite
                                                     FROM sites
                                                    WHERE IdCustomer = 10)
               AND (    (of.idstatus NOT IN (12) AND cpbo.IdOffer IS NULL)
                    AND (of.idstatus NOT IN (4)))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      GROUP BY of.idoffer
      ORDER BY of.year, of.number;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetOrders;
CREATE PROCEDURE geos.`offers_GetOrders`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
        SELECT of.idoffer,
               of.Code AS OfferCode,
               of.description AS OfferTitle,
               zo.name AS CustomerZone,
               of.IdSalesOwner,
               si.IdSalesResponsible,
               si.IdSalesResponsibleAssemblyBU,
               UPPER(co.name) AS CustomerCountry,
               UPPER(cu.name) AS CustomerGroup,
               replace(si.name, concat('(', co.name, ')'), '') AS CustomerName,
               of.IdStatus AS IdStatus,
               oft.HtmlColor AS OfferStatusColor,
               oft.name AS OfferStatus,
               CAST(
                  ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))
                  AS OfferAmount,
               cur.name AS OfferCurrency,
               DATE(MIN(tmp.ReceivedIn)) AS PoReceptionDate,
               oft.HtmlColor AS OfferStatusColor,
               oft.IdSalesStatusType AS IdSalesStatusType,
               ss.Name AS Status,
               ss.HtmlColor AS SalesStatusTypeColor
          FROM offers of
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               INNER JOIN sales_status_types ss
                  ON ss.IdSalesStatusType = oft.IdSalesStatusType
                 INNER JOIN
              (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     of.idoffertype IN (1, 10)
               AND si.IdCustomer NOT IN (8, 10)
               AND of.idstatus NOT IN (4, 12)
                AND (of.IdCustomerToDelivery NOT IN (SELECT IdSite
                                                     FROM sites
                                                    WHERE IdCustomer = 10) AND tmp.IdSite NOT IN (SELECT IdSite
                                                     FROM sites
                                                    WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      GROUP BY of.idoffer
        HAVING YEAR(MIN(tmp.ReceivedIn)) = _accountingYear
      ORDER BY of.year, of.number;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetSelectedUserOffersDailyEvents;
CREATE PROCEDURE geos.`offers_GetSelectedUserOffersDailyEvents`(
   IN _idUser           varchar(2000),
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                'SELECT of.idoffer,',
                ' of.idOfferType AS IdOfferType,',
                ' of.Code AS OfferCode,',
                ' of.description AS OfferTitle,',
                ' oft.IdOfferStatusType AS OfferStatusid,',
                ' oft.name AS OfferStatus,',
                ' oft.HtmlColor AS OfferStatusColor,',
                ' DATE(IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\')))',
                ' AS OfferExpectedPODate,',
                ' sst.IdSalesStatusType,',
                ' sst.Name AS SalesStatusType,',
                ' sst.HtmlColor AS SalesStatusTypeColor',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types sst',
                ' ON sst.IdSalesStatusType = oft.IdSalesStatusType',
                
                ' LEFT JOIN customerpurchaseordersbyoffer cpbo',
                ' ON cpbo.idoffer = of.idoffer',
                ' WHERE     YEAR(',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\'))) =',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10)',
                ' AND (    (of.idstatus NOT IN (12) AND cpbo.IdOffer IS NULL)',
                ' AND (of.idstatus NOT IN (4)))',
                ' AND (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY of.idoffer',
                ' ORDER BY of.year, of.number;');

         PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetSelectedUsersOrders;
CREATE PROCEDURE geos.`offers_GetSelectedUsersOrders`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(2000),
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                ' SELECT of.idoffer,',
                ' of.Code AS OfferCode,',
                ' of.description AS OfferTitle,',
                ' zo.name AS CustomerZone,',
                ' of.IdSalesOwner,',
                ' si.IdSalesResponsible,',
                ' si.IdSalesResponsibleAssemblyBU,',
                ' UPPER(co.name) AS CustomerCountry,',
                ' UPPER(cu.name) AS CustomerGroup,',
                ' replace(si.name, concat(\'(\', co.name, \')\'), \'\') AS CustomerName,',
                ' of.IdStatus AS IdStatus,',
                ' oft.HtmlColor AS OfferStatusColor,',
                ' oft.name AS OfferStatus,',
                ' CAST(',
                ' ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))',
                ' AS OfferAmount,',
                ' cur.name AS OfferCurrency,',
                ' DATE(MIN(tmp.ReceivedIn)) AS PoReceptionDate,',
                ' oft.HtmlColor AS OfferStatusColor,',
                ' oft.IdSalesStatusType AS IdSalesStatusType,',
                ' ss.Name AS Status,',
                ' ss.HtmlColor AS SalesStatusTypeColor',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                '  INNER JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType = oft.IdSalesStatusType',
              ' INNER JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND of.idstatus NOT IN (4, 12)',
                 ' AND (of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10) AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10))',
                ' AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY of.idoffer',
                ' HAVING YEAR(MIN(tmp.ReceivedIn)) =',
                _accountingYear,
                ' ORDER BY of.year, of.number;');

       PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;



DROP PROCEDURE IF EXISTS geos.offers_GetLeadSource;
CREATE PROCEDURE geos.`offers_GetLeadSource`(
   IN _idUser           smallint(5) UNSIGNED,
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
        SELECT count(*) NumberOfOffers,
               IFNULL(of.IdSource, 0) AS IdSource,
               IFNULL(lv.Value, "Others") AS Source
          FROM offers of
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN offerstatustypes offst on offst.IdOfferStatusType = of.IdStatus
               INNER JOIN sales_status_types ss on ss.IdSalesStatusType = offst.IdSalesStatusType
               LEFT JOIN emdep_geos.lookup_values lv
                  ON lv.IdLookupValue = of.IdSource
               INNER JOIN
               (  SELECT idoffer, p.code, p.ReceivedIn,p.idsite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE     YEAR(p.receivedin) = _accountingYear
                         
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     YEAR(
                      IF(
                         tmp.Code IS NULL,
                         IFNULL(of.DeliveryDate,
                                concat(_accountingYear, '-01-01')),
                         tmp.ReceivedIn)) = _accountingYear
               AND of.idoffertype IN (1, 10) AND ss.IdSalesStatusType IN(4)
               AND si.IdCustomer NOT IN (8, 10)
               AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) AND tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                          (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      GROUP BY Source UNION SELECT count(*) NumberOfOffers,
               IFNULL(of.IdSource, 0) AS IdSource,
               IFNULL(lv.Value, "Others") AS Source
          FROM offers of
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN offerstatustypes offst on offst.IdOfferStatusType = of.IdStatus
               INNER JOIN sales_status_types ss on ss.IdSalesStatusType = offst.IdSalesStatusType
               LEFT JOIN emdep_geos.lookup_values lv
                  ON lv.IdLookupValue = of.IdSource
               LEFT JOIN
               (  SELECT idoffer, p.code, p.ReceivedIn,p.idsite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE     YEAR(p.receivedin) = _accountingYear
                         
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     YEAR(
                      IF(
                         tmp.Code IS NULL,
                         IFNULL(of.DeliveryDate,
                                concat(_accountingYear, '-01-01')),
                         tmp.ReceivedIn)) = _accountingYear
               AND of.idoffertype IN (1, 10) AND ss.IdSalesStatusType NOT IN(4)
               AND si.IdCustomer NOT IN (8, 10)
               AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) OR tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                          (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      GROUP BY Source;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetSelectedUsersLeadSource;
CREATE PROCEDURE geos.`offers_GetSelectedUsersLeadSource`(
   IN _idUser           varchar(2000),
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                ' SELECT count(*) NumberOfOffers,',
                ' IFNULL(of.IdSource, 0) AS IdSource,',
                ' IFNULL(lv.Value, "Others") AS Source',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' LEFT JOIN emdep_geos.lookup_values lv',
                ' ON lv.IdLookupValue = of.IdSource',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType = oft.IdSalesStatusType',
                ' INNER JOIN',
                '  (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                '  concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10)  AND ss.IdSalesStatusType IN (4) ',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) ',
                ' AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY Source UNION SELECT count(*) NumberOfOffers,',
                ' IFNULL(of.IdSource, 0) AS IdSource,',
                ' IFNULL(lv.Value, "Others") AS Source',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' LEFT JOIN emdep_geos.lookup_values lv',
                ' ON lv.IdLookupValue = of.IdSource',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType = oft.IdSalesStatusType',
                ' LEFT JOIN',
                '  (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                '  concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10)  AND ss.IdSalesStatusType NOT IN (4) ',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) OR tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) ',
                ' AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY Source;');
                
       PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.currencyconversions_UpdateCurrencyConversions;
CREATE PROCEDURE geos.`currencyconversions_UpdateCurrencyConversions`(
   IN _idcurrencyTo     tinyint(4) UNSIGNED,
   IN _idcurrencyFrom   tinyint(4) UNSIGNED,
   IN _exchangeRate     float,
   IN _lastupdate       datetime)
BEGIN
      UPDATE currencyconversions
         SET exchangerate = _exchangeRate, lastupdate = _lastupdate
       WHERE     idcurrencyfrom = _idcurrencyFrom
             AND idcurrencyto = _idcurrencyTo;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetOfferDetailsById;
CREATE PROCEDURE geos.`offers_GetOfferDetailsById`(
   IN _offerId          int(10) UNSIGNED,
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SELECT of.idoffer,
             of.Code AS OfferCode,
             of.IdStatus,
             of.ModifiedBy,
             of.IdBusinessUnit,
             of.IdSource,
             of.`Year` AS OfferYear,
             of.Number AS number,
             of.description AS OfferTitle,
             zo.name AS CustomerZone,
             UPPER(co.name) AS CustomerCountry,
             UPPER(cu.name) AS CustomerGroup,
             replace(si.name, concat('(', co.name, ')'), '') AS SiteName,
             of.IdProject,
             of.IdCarOEM,
             oft.name AS OfferStatus,
             CAST(
                ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))
                AS OfferAmount,
             of.probabilityofsuccess AS OfferConfidentialLevel,
             DATE(IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01')))
                AS OfferExpectedDate,
             of.Rfq,
             of.Comments,
             of.DeliveryDate,
             of.idOfferType,
             currency.IdCurrency,
             currency.Name AS CurrencyName,
             cu.IdCustomer,
             si.IdSite,
             of.ModifiedIn,
             of.CreatedIn,
             of.SendIn,
             of.RFQReception,
             of.IdSalesOwner,
             salesowner.Name AS OfferSalesOwnerName,
             salesowner.Surname AS OfferSalesOwnerSurName
        FROM offers of
             INNER JOIN sites si ON si.idsite = of.idcustomer
             INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
              INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
             INNER JOIN offerstatustypes oft
                ON oft.idofferstatustype = of.idstatus
             INNER JOIN currencyconversions cc
                ON     cc.idcurrencyFrom = of.idcurrency
                   AND cc.idcurrencyTo = _idcurrency
             INNER JOIN currency ON currency.IdCurrency = cc.idcurrencyTo
             LEFT JOIN people salesowner
                ON salesowner.idperson = of.IdSalesOwner
       WHERE of.idoffer = _offerId;
   END;


DROP PROCEDURE IF EXISTS geos.optionsbyoffer_GetOptionsByOfferId;
CREATE PROCEDURE geos.`optionsbyoffer_GetOptionsByOfferId`(
   IN _offerId int(10) UNSIGNED)
BEGIN
      SELECT op.IdOffer,
             op.IdOption,
             op.Quantity,
             ofop.Name AS offeroption,
             ofop.IdOfferOptionType,
             oftype.Name AS offeroptiontype
        FROM optionsbyoffer op
             INNER JOIN offeroptions ofop ON op.IdOption = ofop.idOfferOption
             INNER JOIN offeroptiontypes oftype
                ON oftype.IdOfferOptionType = ofop.IdOfferOptionType
       WHERE op.IdOffer = _offerId;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetForecastedByCustomer;
CREATE PROCEDURE geos.`sites_GetForecastedByCustomer`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
        SELECT of.idCustomer,
               YEAR(
                  Date(
                     IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01'))))
                  AS ForecastedYear,
               Convert(
                  CONCAT(
                     'Q',
                     QUARTER(
                        Date(
                           IFNULL(of.DeliveryDate,
                                  CONCAT(_accountingYear, '-01-01'))))),
                  char)
                  AS ForecastedQuarter,
               CAST(
                  SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))
                  AS ForecastedAmount,
               cur.name AS ForecastedCurrency
          FROM offers of
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               INNER JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types ss
                  ON oft.IdSalesStatusType = ss.IdSalesStatusType
              LEFT JOIN
              (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear 
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     of.idoffertype IN (1, 10)
               AND si.IdCustomer NOT IN (8, 10)
               AND ss.IdSalesStatusType IN (1)
               AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) OR tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
               AND YEAR(
                      IF(
                         tmp.Code IS NULL,
                         Date(
                            IFNULL(of.DeliveryDate,
                                   concat(_accountingYear, '-01-01'))),
                         tmp.ReceivedIn)) = _accountingYear
      GROUP BY of.idCustomer, ForecastedYear, ForecastedQuarter;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetSalesByCustomer;
CREATE PROCEDURE geos.`sites_GetSalesByCustomer`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission   smallint(5) UNSIGNED)
BEGIN
     
        SELECT of.idCustomer,
               YEAR(
                  Date(
                     IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01'))))
                  AS SalesYear,
               Convert(
                  CONCAT(
                     'Q',
                     QUARTER(
                        Date(
                           IFNULL(of.DeliveryDate,
                                  concat(_accountingYear, '-01-01'))))),
                  char)
                  AS SalesQuarter,
               CAST(
                  SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))
                  AS OfferAmount,
               cur.name AS OfferCurrency
          FROM offers of
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               LEFT JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types ss
                  ON oft.IdSalesStatusType = ss.IdSalesStatusType
                INNER JOIN
            (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear 
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     of.idoffertype IN (1, 10)
               AND YEAR(
                      IF(
                         tmp.Code IS NULL,
                         IFNULL(of.DeliveryDate,
                                concat(_accountingYear, '-01-01')),
                         tmp.ReceivedIn)) = _accountingYear
               AND si.IdCustomer NOT IN (8, 10)
               AND ss.IdSalesStatusType IN (4)
               AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) AND tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      GROUP BY of.idCustomer, SalesQuarter, SalesYear;
   END;



DROP PROCEDURE IF EXISTS geos.sites_GetQuotedByCustomer;
CREATE PROCEDURE geos.`sites_GetQuotedByCustomer`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
        SELECT of.idCustomer,
               YEAR(
                  DATE(
                     IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01'))))
                  AS QuotedYear,
               Convert(
                  CONCAT(
                     'Q',
                     QUARTER(
                        Date(
                           IFNULL(of.DeliveryDate,
                                  CONCAT(_accountingYear, '-01-01'))))),
                  char)
                  AS QuotedQuarter,
               CAST(
                  SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))
                  AS QuotedAmount,
               cur.name AS QuotedCurrency
          FROM offers of
               INNER JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types ss
                  ON oft.IdSalesStatusType = ss.IdSalesStatusType
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
              LEFT JOIN
              (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear 
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     YEAR(
                      IF(
                         tmp.Code IS NULL,
                         Date(
                            IFNULL(of.DeliveryDate,
                                   concat(_accountingYear, '-01-01'))),
                         tmp.ReceivedIn)) = _accountingYear
               AND of.idoffertype IN (1, 10)
               AND si.IdCustomer NOT IN (8, 10)
              AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) OR tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
               AND ss.IdSalesStatusType IN (3)
      GROUP BY of.idCustomer, QuotedYear, QuotedQuarter;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetQualifiedByCustomer;
CREATE PROCEDURE geos.`sites_GetQualifiedByCustomer`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
        SELECT of.idCustomer,
               YEAR(
                  Date(
                     IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01'))))
                  AS QualifiedYear,
               Convert(
                  CONCAT(
                     'Q',
                     QUARTER(
                        Date(
                           IFNULL(of.DeliveryDate,
                                  concat(_accountingYear, '-01-01'))))),
                  char)
                  AS QualifiedQuarter,
               CAST(
                  SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))
                  AS QualifiedAmount,
               cur.name AS QualifiedCurrency
          FROM offers of
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               INNER JOIN offerstatustypes offst
                  ON offst.IdOfferStatusType = of.IdStatus
               INNER JOIN sales_status_types ss
                  ON offst.IdSalesStatusType = ss.IdSalesStatusType
              LEFT JOIN
              (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear 
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     of.idoffertype IN (1, 10)
               AND si.IdCustomer NOT IN (8, 10)
               AND ss.IdSalesStatusType IN (2)
               AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) OR tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
               AND YEAR(
                      IF(
                         tmp.Code IS NULL,
                         Date(
                            IFNULL(of.DeliveryDate,
                                   concat(_accountingYear, '-01-01'))),
                         tmp.ReceivedIn)) = _accountingYear
      GROUP BY of.idCustomer, QualifiedYear, QualifiedQuarter;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetRFQByCustomer;
CREATE PROCEDURE geos.`sites_GetRFQByCustomer`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
        SELECT of.idCustomer,
               YEAR(
                  Date(
                     IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01'))))
                  AS RFQYear,
               Convert(
                  CONCAT(
                     'Q',
                     QUARTER(
                        Date(
                           IFNULL(of.DeliveryDate,
                                  concat(_accountingYear, '-01-01'))))),
                  char)
                  AS RFQQuarter,
               CAST(
                  SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))
                  AS RFQAmount,
               cur.name AS RFQCurrency
          FROM offers of
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               INNER JOIN offerstatustypes offst
                  ON offst.IdOfferStatusType = of.IdStatus
               INNER JOIN sales_status_types ss
                  ON offst.IdSalesStatusType = ss.IdSalesStatusType
               LEFT JOIN
              (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear 
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     of.idoffertype IN (1, 10)
               AND si.IdCustomer NOT IN (8, 10)
               AND ss.IdSalesStatusType IN (6)
               AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) OR tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
               AND YEAR(
                      IF(
                         tmp.Code IS NULL,
                         Date(
                            IFNULL(of.DeliveryDate,
                                   concat(_accountingYear, '-01-01'))),
                         tmp.ReceivedIn)) = _accountingYear
      GROUP BY of.idCustomer, RFQYear, RFQQuarter;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetTargetByCustomer;
CREATE PROCEDURE geos.`sites_GetTargetByCustomer`(
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
        SELECT s.IdSite,
               UPPER(co.Name) AS CustomerCountry,
               zo.Name AS CustomerZone,
               c.IdCustomer,
               UPPER(c.Name) AS CustomerGroup,
               s.Name AS CustomerName,
               CAST(
                  ROUND(t.TargetAmount, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))
                  AS TargetSalesAmount,
               cur.Name AS TargetSalesCurrency
          FROM sites s
               INNER JOIN customers c ON c.IdCustomer = s.IdCustomer
               INNER JOIN countries co ON co.idCountry = s.IdCountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               LEFT JOIN salestargetbysite t
                  ON t.idsite = s.idsite AND t.year = _accountingYear
               LEFT JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = t.idcurrency
                     AND idcurrencyTo = _idcurrency
               LEFT JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
         WHERE     s.IdCustomer NOT IN (8, 10)
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   s.idsalesresponsible IN (_idUser)
                          OR s.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   s.idsalesresponsible IN (_idUser)
                          OR s.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      GROUP BY s.IdSite
      ORDER BY CustomerCountry, CustomerGroup, CustomerName;
   END;

DROP PROCEDURE IF EXISTS geos.sites_GetSelectedUsersForecastedByCustomer;
CREATE PROCEDURE geos.`sites_GetSelectedUsersForecastedByCustomer`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(2000),
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                ' SELECT of.idCustomer,',
                ' YEAR(',
                ' Date(',
                ' IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\'))))',
                ' AS ForecastedYear,',
                ' Convert(',
                ' CONCAT(',
                '\'Q\',',
                ' QUARTER(',
                ' Date(',
                ' IFNULL(of.DeliveryDate,',
                ' CONCAT(',
                _accountingYear,
                ', \'-01-01\'))))),',
                ' char)',
                ' AS ForecastedQuarter,',
                ' CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS ForecastedAmount,',
                ' cur.name AS ForecastedCurrency',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' LEFT JOIN sales_status_types ss',
                ' ON oft.IdSalesStatusType = ss.IdSalesStatusType',
               ' LEFT JOIN',
               ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND ss.IdSalesStatusType IN (1)',
               ' AND (of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10) OR tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10))',
                ' AND (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' AND YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' Date(',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\'))),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' GROUP BY of.idCustomer, ForecastedYear, ForecastedQuarter;');

        PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;

DROP PROCEDURE IF EXISTS geos.sites_GetSelectedUsersSalesByCustomer;
CREATE PROCEDURE geos.`sites_GetSelectedUsersSalesByCustomer`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(2000),
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                '  SELECT of.idCustomer,',
                ' YEAR(',
                ' Date(',
                ' IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\'))))',
                ' AS SalesYear,',
                ' Convert(',
                ' CONCAT(',
                ' \'Q\',',
                ' QUARTER(',
                ' Date(',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\'))))),',
                ' char)',
                ' AS SalesQuarter,',
                ' CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS OfferAmount,',
                ' cur.name AS OfferCurrency',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' LEFT JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types ss',
                ' ON oft.IdSalesStatusType = ss.IdSalesStatusType',
              ' INNER JOIN',
               ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10)',
                ' AND YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND ss.IdSalesStatusType IN (4)',
               ' AND (of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10) AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10))',

                ' AND (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY of.idCustomer, SalesQuarter, SalesYear;');


        PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetSelectedUserQuotedByCustomer;
CREATE PROCEDURE geos.`sites_GetSelectedUserQuotedByCustomer`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(2000),
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                ' SELECT of.idCustomer,',
                ' YEAR(',
                ' DATE(',
                ' IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\'))))',
                ' AS QuotedYear,',
                ' Convert(',
                ' CONCAT(',
                ' \'Q\',',
                ' QUARTER(',
                ' Date(',
                ' IFNULL(of.DeliveryDate,',
                ' CONCAT(',
                _accountingYear,
                ', \'-01-01\'))))),',
                ' char)',
                ' AS QuotedQuarter,',
                ' CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS QuotedAmount,',
                ' cur.name AS QuotedCurrency',
                ' FROM offers of',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types ss',
                ' ON oft.IdSalesStatusType = ss.IdSalesStatusType',
                ' INNER JOIN currencyconversions cc',
                '  ON     cc.idcurrencyFrom = of.idcurrency',
                '  AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' LEFT JOIN',
               ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' Date(',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\'))),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND (of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10) OR tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10))',
                ' AND (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                '  AND ss.IdSalesStatusType IN (3)',
                ' GROUP BY of.idCustomer, QuotedYear, QuotedQuarter;');

      PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetSelectedUsersQualifiedByCustomer;
CREATE PROCEDURE geos.`sites_GetSelectedUsersQualifiedByCustomer`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(2000),
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                ' SELECT of.idCustomer,',
                ' YEAR(',
                ' Date(',
                ' IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\'))))',
                ' AS QualifiedYear,',
                ' Convert(',
                ' CONCAT(',
                ' \'Q\',',
                ' QUARTER(',
                ' Date(',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\'))))),',
                ' char)',
                ' AS QualifiedQuarter,',
                ' CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS QualifiedAmount,',
                '  cur.name AS QualifiedCurrency',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                '  ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offerstatustypes offst',
                ' ON offst.IdOfferStatusType = of.IdStatus',
                ' INNER JOIN sales_status_types ss',
                ' ON offst.IdSalesStatusType = ss.IdSalesStatusType',
               ' LEFT JOIN',
               ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND ss.IdSalesStatusType IN (2)',
                ' AND (of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10) OR tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10))',
                ' AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' AND YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' Date(',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\'))),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                '  GROUP BY of.idCustomer, QualifiedYear, QualifiedQuarter;');

    PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetSelectedUsersRFQByCustomer;
CREATE PROCEDURE geos.`sites_GetSelectedUsersRFQByCustomer`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(2000),
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                ' SELECT of.idCustomer,',
                ' YEAR(',
                ' Date(',
                ' IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\'))))',
                ' AS RFQYear,',
                ' Convert(',
                ' CONCAT(',
                ' \'Q\',',
                ' QUARTER(',
                ' Date(',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\'))))),',
                ' char)',
                ' AS RFQQuarter,',
                ' CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS RFQAmount,',
                ' cur.name AS RFQCurrency',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offerstatustypes offst',
                ' ON offst.IdOfferStatusType = of.IdStatus',
                ' INNER JOIN sales_status_types ss',
                ' ON offst.IdSalesStatusType = ss.IdSalesStatusType',
                ' LEFT JOIN',
               ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND ss.IdSalesStatusType IN (6)',
               ' AND (of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10) OR tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10))',
                ' AND (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' AND YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' Date(',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\'))),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' GROUP BY of.idCustomer, RFQYear, RFQQuarter;');

       PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetSelectedUsersTargetByCustomer;
CREATE PROCEDURE geos.`sites_GetSelectedUsersTargetByCustomer`(
   IN _idUser           varchar(2000),
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                ' SELECT s.IdSite,',
                ' UPPER(co.Name) AS CustomerCountry,',
                ' zo.Name AS CustomerZone,',
                ' c.IdCustomer,',
                ' UPPER(c.Name) AS CustomerGroup,',
                ' s.Name AS CustomerName,',
                ' CAST(',
                ' ROUND(t.TargetAmount, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))',
                ' AS TargetSalesAmount,',
                ' cur.Name AS TargetSalesCurrency',
                ' FROM sites s',
                ' INNER JOIN customers c ON c.IdCustomer = s.IdCustomer',
                ' INNER JOIN countries co ON co.idCountry = s.IdCountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' LEFT JOIN salestargetbysite t',
                ' ON t.idsite = s.idsite AND t.year = ',
                _accountingYear,
                ' LEFT JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = t.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' LEFT JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' WHERE     s.IdCustomer NOT IN (8, 10)',
                ' AND  (   s.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR s.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY s.IdSite',
                ' ORDER BY CustomerCountry, CustomerGroup, CustomerName;');

        PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetTopOtherCustomersDashboardDetails;
CREATE PROCEDURE geos.`sites_GetTopOtherCustomersDashboardDetails`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _customerLimit    smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission     SMALLINT(5) UNSIGNED)
BEGIN
      DROP TEMPORARY TABLE IF EXISTS table2;
      SET @query =
             concat(
                ' CREATE TEMPORARY TABLE IF NOT EXISTS table2 AS (SELECT idCustomer',
                ' FROM (  Select * from(SELECT DISTINCT ',
                ' (cu.idCustomer) idCustomer,CAST(',
               ' SUM(',
               ' ROUND(of.value, 4)',
               ' * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))  As Amount,ss.IdSalesStatusType',
                ' FROM offers of',
                ' INNER JOIN sites si',
                ' ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu',
                ' ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co',
                ' ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo',
                ' ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom =',
                ' of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur',
                ' ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.IdOfferStatusType = of.IdStatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType =',
                ' oft.IdSalesStatusType',
                ' INNER JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
                ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10) AND ss.IdSalesStatusType IN (4)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(',
                ' of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ',\'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10) AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) AND CASE',
                ' WHEN ',
                _idPermission,
                ' = 20',
                ' THEN',
                ' (   si.idsalesresponsible IN',
                ' (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN',
                ' (',
                _idUser,
                '))',
                ' WHEN ',
                _idPermission,
                ' = 21',
                ' THEN',
                ' (   si.idsalesresponsible IN',
                ' (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN',
                ' (',
                _idUser,
                '))',
                ' WHEN ',
                _idPermission,
                ' = 22',
                ' THEN',
                ' TRUE',
                ' ELSE',
                ' FALSE',
                ' END',
                ' GROUP BY cu.idCustomer UNION SELECT DISTINCT ',
                ' (cu.idCustomer) idCustomer,CAST(',
               ' SUM(',
               ' ROUND(of.value, 4)',
               ' * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))  As Amount,ss.IdSalesStatusType',
                ' FROM offers of',
                ' INNER JOIN sites si',
                ' ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu',
                ' ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co',
                ' ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo',
                ' ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom =',
                ' of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur',
                ' ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.IdOfferStatusType = of.IdStatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType =',
                ' oft.IdSalesStatusType',
                ' LEFT JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
                ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10) AND ss.IdSalesStatusType NOT IN (4) ',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(',
                ' of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ',\'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10) OR tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) AND CASE',
                ' WHEN ',
                _idPermission,
                ' = 20',
                ' THEN',
                ' (   si.idsalesresponsible IN',
                ' (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN',
                ' (',
                _idUser,
                '))',
                ' WHEN ',
                _idPermission,
                ' = 21',
                ' THEN',
                ' (   si.idsalesresponsible IN',
                ' (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN',
                ' (',
                _idUser,
                '))',
                ' WHEN ',
                _idPermission,
                ' = 22',
                ' THEN',
                ' TRUE',
                ' ELSE',
                ' FALSE',
                ' END',
                ' GROUP BY cu.idCustomer) As tmpcustomer',
                ' ORDER BY tmpcustomer.IdSalesStatusType = 4 DESC,',
                ' tmpcustomer.Amount DESC',
                ' LIMIT ',
                _customerLimit,
                ') AS cust);');
                 PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
       
        DROP TEMPORARY TABLE IF EXISTS table2copy;
      SET @querycopy =
             concat(
                'CREATE TEMPORARY TABLE IF NOT EXISTS table2copy AS (select * from table2);');
                PREPARE stmt FROM @querycopy      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;


      SET @query2 =
             Concat(
                'Select * from ( SELECT cu.idCustomer,',
                ' UPPER(cu.Name) AS CustomerGroup,',
                ' si.IdSite,',
                ' si.Name AS CustomerPlant,',
                ' replace(si.name, concat(\' (\', co.name, \')\'), \'\') AS SiteName,',
                ' concat(\'(\', co.name, \')\') AS Country,',
                ' CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS Amount,',
                ' CAST(',
                ' ROUND(t.TargetAmount, 4) * ROUND(cctarget.exchangerate, 4) AS DECIMAL(18, 4))',
                ' AS TargetAmount,',
                ' ss.IdSalesStatusType,',
                ' ss.Name',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND cc.idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.IdOfferStatusType = of.IdStatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType = oft.IdSalesStatusType',
                ' LEFT JOIN salestargetbysite t',
                ' ON t.idsite = si.idsite AND t.year = ',
                _accountingYear,
                ' LEFT JOIN currencyconversions cctarget',
                ' ON     cctarget.idcurrencyFrom = t.idcurrency',
                ' AND cctarget.idcurrencyTo = ',
                _idcurrency,
                ' LEFT JOIN currency curtarget',
                ' ON curtarget.IdCurrency = cctarget.IdCurrencyTo',
                ' INNER JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10) AND ss.IdSalesStatusType IN (4) ',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) AND CASE',
                '  WHEN ',
                _idPermission,
                ' = 20',
                ' THEN',
                ' (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' WHEN ',
                _idPermission,
                ' = 21',
                ' THEN',
                ' (   si.idsalesresponsible IN',
                ' (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN',
                ' (',
                _idUser,
                '))',
                ' WHEN ',
                _idPermission,
                ' = 22',
                ' THEN',
                ' TRUE',
                ' ELSE',
                ' FALSE',
                ' END',
                ' AND cu.IdCustomer IN',
                ' (SELECT idCustomer from table2)',
                ' GROUP BY cu.idCustomer, si.IdSite,ss.IdSalesStatusType UNION SELECT cu.idCustomer,',
                ' UPPER(cu.Name) AS CustomerGroup,',
                ' si.IdSite,',
                ' si.Name AS CustomerPlant,',
                ' replace(si.name, concat(\' (\', co.name, \')\'), \'\') AS SiteName,',
                ' concat(\'(\', co.name, \')\') AS Country,',
                ' CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS Amount,',
                ' CAST(',
                ' ROUND(t.TargetAmount, 4) * ROUND(cctarget.exchangerate, 4) AS DECIMAL(18, 4))',
                ' AS TargetAmount,',
                ' ss.IdSalesStatusType,',
                ' ss.Name',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND cc.idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.IdOfferStatusType = of.IdStatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType = oft.IdSalesStatusType',
                ' LEFT JOIN salestargetbysite t',
                ' ON t.idsite = si.idsite AND t.year = ',
                _accountingYear,
                ' LEFT JOIN currencyconversions cctarget',
                ' ON     cctarget.idcurrencyFrom = t.idcurrency',
                ' AND cctarget.idcurrencyTo = ',
                _idcurrency,
                ' LEFT JOIN currency curtarget',
                ' ON curtarget.IdCurrency = cctarget.IdCurrencyTo',
                ' LEFT JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10) AND ss.IdSalesStatusType NOT IN (4) ',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer = 10 ) OR tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) AND CASE',
                '  WHEN ',
                _idPermission,
                ' = 20',
                ' THEN',
                ' (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' WHEN ',
                _idPermission,
                ' = 21',
                ' THEN',
                ' (   si.idsalesresponsible IN',
                ' (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN',
                ' (',
                _idUser,
                '))',
                ' WHEN ',
                _idPermission,
                ' = 22',
                ' THEN',
                ' TRUE',
                ' ELSE',
                ' FALSE',
                ' END',
                ' AND cu.IdCustomer IN',
                ' (SELECT idCustomer from table2copy)',
                ' GROUP BY cu.idCustomer, si.IdSite,ss.IdSalesStatusType) As tmp2',
                ' ORDER BY CASE tmp2.IdSalesStatusType',
                ' WHEN 4',
                ' THEN',
                ' tmp2.Amount',
                ' END DESC;');

       PREPARE stmt FROM @query2      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
       
       
        SET @query3 =
             Concat(
                ' SELECT CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS Amount,',
                ' ss.IdSalesStatusType,ss.Name',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND cc.idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.IdOfferStatusType = of.IdStatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType = oft.IdSalesStatusType',
                ' INNER JOIN',
                '  (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
                ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10) AND ss.IdSalesStatusType IN (4)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND YEAR(',
                ' IF(tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10)  AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) AND CASE',
                ' WHEN ',
                _idPermission,
                ' = 20',
                ' THEN',
                ' (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' WHEN ',
                _idPermission,
                ' = 21',
                ' THEN',
                ' (   si.idsalesresponsible IN',
                '(',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN',
                '(',
                _idUser,
                '))',
                ' WHEN ',
                _idPermission,
                ' = 22',
                ' THEN',
                ' TRUE',
                ' ELSE',
                ' FALSE',
                '  END',
                ' AND cu.IdCustomer NOT IN ',
                ' (SELECT idCustomer from table2)',
                ' GROUP BY ss.Name UNION SELECT CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS Amount,',
                ' ss.IdSalesStatusType,ss.Name',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND cc.idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.IdOfferStatusType = of.IdStatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType = oft.IdSalesStatusType',
                ' LEFT JOIN',
                '  (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
                ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10) AND ss.IdSalesStatusType NOT IN (4) ',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND YEAR(',
                ' IF(tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10)  OR tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) AND CASE',
                ' WHEN ',
                _idPermission,
                ' = 20',
                ' THEN',
                ' (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' WHEN ',
                _idPermission,
                ' = 21',
                ' THEN',
                ' (   si.idsalesresponsible IN',
                '(',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN',
                '(',
                _idUser,
                '))',
                ' WHEN ',
                _idPermission,
                ' = 22',
                ' THEN',
                ' TRUE',
                ' ELSE',
                ' FALSE',
                '  END',
                ' AND cu.IdCustomer NOT IN ',
                ' (SELECT idCustomer from table2copy)',
                ' GROUP BY ss.Name;');

       PREPARE stmt FROM @query3      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetSelectedUsersTopOthersCustomersDashboardDetails;
CREATE PROCEDURE geos.`sites_GetSelectedUsersTopOthersCustomersDashboardDetails`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(2000),
   IN _customerLimit    smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      DROP TEMPORARY TABLE IF EXISTS table2;
      SET @query =
             concat(
                ' CREATE TEMPORARY TABLE IF NOT EXISTS table2 AS (SELECT idCustomer',
                ' FROM (  Select * from(SELECT DISTINCT',
                ' (cu.idCustomer) idCustomer,CAST(',
               ' SUM(',
               ' ROUND(of.value, 4)',
               ' * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))  As Amount,ss.IdSalesStatusType',
                ' FROM offers of',
                ' INNER JOIN sites si',
                ' ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu',
                ' ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co',
                ' ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo',
                ' ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom =',
                ' of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur',
                ' ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.IdOfferStatusType = of.IdStatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType =',
                ' oft.IdSalesStatusType',
                ' INNER JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
                ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10)  AND ss.IdSalesStatusType IN (4)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(',
                ' of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ',\'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) AND ',
                ' (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY cu.idCustomer UNION SELECT DISTINCT',
                ' (cu.idCustomer) idCustomer,CAST(',
               ' SUM(',
               ' ROUND(of.value, 4)',
               ' * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))  As Amount,ss.IdSalesStatusType',
                ' FROM offers of',
                ' INNER JOIN sites si',
                ' ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu',
                ' ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co',
                ' ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo',
                ' ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom =',
                ' of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur',
                ' ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.IdOfferStatusType = of.IdStatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType =',
                ' oft.IdSalesStatusType',
                ' LEFT JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
                ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10)  AND ss.IdSalesStatusType NOT IN (4)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(',
                ' of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ',\'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) OR tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) AND ',
                ' (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY cu.idCustomer) As tmpcustomer',
                ' ORDER BY tmpcustomer.IdSalesStatusType = 4 DESC,',
                ' tmpcustomer.Amount DESC',
                ' LIMIT ',
                _customerLimit,
                ') AS cust);');
                PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
       
       
      DROP TEMPORARY TABLE IF EXISTS table2copy;
      SET @querycopy =
             concat(
                'CREATE TEMPORARY TABLE IF NOT EXISTS table2copy AS (select * from table2);');
                PREPARE stmt FROM @querycopy      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;

      SET @query2 =
             Concat(
                ' Select * from (SELECT cu.idCustomer,',
                ' UPPER(cu.Name) AS CustomerGroup,',
                ' si.IdSite,',
                ' si.Name AS CustomerPlant,',
                ' replace(si.name, concat(\' (\', co.name, \')\'), \'\') AS SiteName,',
                ' concat(\'(\', co.name, \')\') AS Country,',
                ' CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS Amount,',
                ' CAST(',
                ' ROUND(t.TargetAmount, 4) * ROUND(cctarget.exchangerate, 4) AS DECIMAL(18, 4))',
                ' AS TargetAmount,',
                ' ss.IdSalesStatusType,',
                ' ss.Name',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND cc.idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.IdOfferStatusType = of.IdStatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType = oft.IdSalesStatusType',
                ' LEFT JOIN salestargetbysite t',
                ' ON t.idsite = si.idsite AND t.year = ',
                _accountingYear,
                ' LEFT JOIN currencyconversions cctarget',
                ' ON     cctarget.idcurrencyFrom = t.idcurrency',
                ' AND cctarget.idcurrencyTo = ',
                _idcurrency,
                ' LEFT JOIN currency curtarget',
                ' ON curtarget.IdCurrency = cctarget.IdCurrencyTo',
                ' INNER JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
                ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10)  AND ss.IdSalesStatusType IN (4) ',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) AND ',
                ' (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' AND cu.IdCustomer IN',
                ' (SELECT idCustomer from table2)',
                ' GROUP BY cu.idCustomer, si.IdSite,ss.IdSalesStatusType UNION SELECT cu.idCustomer,',
                ' UPPER(cu.Name) AS CustomerGroup,',
                ' si.IdSite,',
                ' si.Name AS CustomerPlant,',
                ' replace(si.name, concat(\' (\', co.name, \')\'), \'\') AS SiteName,',
                ' concat(\'(\', co.name, \')\') AS Country,',
                ' CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS Amount,',
                ' CAST(',
                ' ROUND(t.TargetAmount, 4) * ROUND(cctarget.exchangerate, 4) AS DECIMAL(18, 4))',
                ' AS TargetAmount,',
                ' ss.IdSalesStatusType,',
                ' ss.Name',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND cc.idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.IdOfferStatusType = of.IdStatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType = oft.IdSalesStatusType',
                ' LEFT JOIN salestargetbysite t',
                ' ON t.idsite = si.idsite AND t.year = ',
                _accountingYear,
                ' LEFT JOIN currencyconversions cctarget',
                ' ON     cctarget.idcurrencyFrom = t.idcurrency',
                ' AND cctarget.idcurrencyTo = ',
                _idcurrency,
                ' LEFT JOIN currency curtarget',
                ' ON curtarget.IdCurrency = cctarget.IdCurrencyTo',
                ' LEFT JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
                ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10)  AND ss.IdSalesStatusType NOT IN (4) ',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) OR tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) AND ',
                ' (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' AND cu.IdCustomer IN',
                ' (SELECT idCustomer from table2copy)',
                ' GROUP BY cu.idCustomer, si.IdSite,ss.IdSalesStatusType) As tmp2',
                ' ORDER BY CASE tmp2.IdSalesStatusType',
                ' WHEN 4',
                ' THEN',
                ' tmp2.Amount',
                ' END DESC;');

       PREPARE stmt FROM @query2      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
       
       
       SET @query3 =
             Concat(
                ' SELECT CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS Amount,',
                ' ss.IdSalesStatusType,ss.Name',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND cc.idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.IdOfferStatusType = of.IdStatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType = oft.IdSalesStatusType',
                ' INNER JOIN',
                '  (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10) AND ss.IdSalesStatusType IN (4) ',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND YEAR(',
                ' IF(tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) AND ',
                ' (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' AND cu.IdCustomer NOT IN',
                ' (SELECT idCustomer from table2)',
                ' GROUP BY ss.Name UNION SELECT CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS Amount,',
                ' ss.IdSalesStatusType,ss.Name',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND cc.idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.IdOfferStatusType = of.IdStatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType = oft.IdSalesStatusType',
                ' LEFT JOIN',
                '  (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10) AND ss.IdSalesStatusType NOT IN (4) ',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND YEAR(',
                ' IF(tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) = ',
                _accountingYear,
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) OR tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) AND ',
                ' (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' AND cu.IdCustomer NOT IN',
                ' (SELECT idCustomer from table2copy)',
                ' GROUP BY ss.Name;');

       PREPARE stmt FROM @query3      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.GetlostReasonsByOffer;
CREATE PROCEDURE geos.`GetlostReasonsByOffer`(IN _IdOffer int(10) UNSIGNED)
BEGIN
      SELECT Idoffer,
             IdLostReasonList,
             IdCompetitor,
             Comments
        FROM lostreasonsbyoffer
       WHERE IdOffer = _IdOffer;
   END;

DROP PROCEDURE IF EXISTS geos.lostreasonsbyoffer_GetOfferLostReasonsDetails;
CREATE PROCEDURE geos.`lostreasonsbyoffer_GetOfferLostReasonsDetails`(
   IN _idUser           smallint(5) UNSIGNED,
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idLostReason     tinyint(3) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
      SELECT Count(tmp.IdOffer) NumberOfOffers,
             tmp.IdCompetitor,
             tmp.Competitor
        FROM (  SELECT lostreasonsbyoffer.IdOffer,
                       SUBSTRING_INDEX(IdLostReasonList, ';', 1)
                          AS LostReasonId1,
                       if(
                          SUBSTRING_INDEX(
                             SUBSTRING_INDEX(IdLostReasonList, ';', 2),
                             ';',
                             -1) != SUBSTRING_INDEX(IdLostReasonList, ';', 1),
                          SUBSTRING_INDEX(
                             SUBSTRING_INDEX(IdLostReasonList, ';', 2),
                             ';',
                             -1),
                          '')
                          AS LostReasonId2,
                       if(
                          SUBSTRING_INDEX(
                             SUBSTRING_INDEX(IdLostReasonList, ';', 3),
                             ';',
                             -1) !=
                             SUBSTRING_INDEX(
                                SUBSTRING_INDEX(IdLostReasonList, ';', 2),
                                ';',
                                -1),
                          SUBSTRING_INDEX(
                             SUBSTRING_INDEX(IdLostReasonList, ';', 3),
                             ';',
                             -1),
                          '')
                          AS LostReasonId3,
                       if(
                          SUBSTRING_INDEX(
                             SUBSTRING_INDEX(IdLostReasonList, ';', 4),
                             ';',
                             -1) !=
                             SUBSTRING_INDEX(
                                SUBSTRING_INDEX(IdLostReasonList, ';', 3),
                                ';',
                                -1),
                          SUBSTRING_INDEX(
                             SUBSTRING_INDEX(IdLostReasonList, ';', 4),
                             ';',
                             -1),
                          '')
                          AS LostReasonId4,
                       lostreasonsbyoffer.IdCompetitor,
                       comp.Name AS Competitor
                  FROM lostreasonsbyoffer
                       LEFT JOIN competitors comp
                          ON comp.IdCompetitor =
                                lostreasonsbyoffer.IdCompetitor
                       INNER JOIN offers of
                          ON lostreasonsbyoffer.IdOffer = of.IdOffer
                       INNER JOIN sites si ON si.idsite = of.idcustomer
                       INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
                       INNER JOIN countries co ON co.idcountry = si.idcountry
                       INNER JOIN zones zo ON zo.idzone = co.idzone
                           INNER JOIN offerstatustypes offst on offst.IdOfferStatusType = of.IdStatus
                       INNER JOIN sales_status_types ss on ss.IdSalesStatusType = offst.IdSalesStatusType
                       LEFT JOIN
                       (  SELECT idoffer, p.code, p.ReceivedIn,p.IdSite
                            FROM customerpurchaseordersbyoffer po
                                 INNER JOIN customerpurchaseorders p
                                    ON p.idcustomerpurchaseorders =
                                          po.idcustomerpurchaseorder
                           WHERE     YEAR(p.receivedin) = _accountingYear
                        GROUP BY idoffer
                          HAVING MIN(p.receivedin)) AS tmppo
                          ON tmppo.idoffer = of.idoffer
                 WHERE     YEAR(
                              IF(
                                 tmppo.Code IS NULL,
                                 IFNULL(of.DeliveryDate,
                                        concat(_accountingYear, '-01-01')),
                                 tmppo.ReceivedIn)) = _accountingYear
                       AND of.idoffertype IN (1, 10) AND ss.IdSalesStatusType NOT IN (4)
                       AND si.IdCustomer NOT IN (8, 10)
                       AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) OR tmppo.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
                       AND CASE
                              WHEN _idPermission = 20
                              THEN
                                 (   si.idsalesresponsible IN (_idUser)
                                  OR si.IdSalesResponsibleAssemblyBU IN
                                        (_idUser))
                              WHEN _idPermission = 21
                              THEN
                                 (   si.idsalesresponsible IN (_idUser)
                                  OR si.IdSalesResponsibleAssemblyBU IN
                                        (_idUser))
                              WHEN _idPermission = 22
                              THEN
                                 TRUE
                              ELSE
                                 FALSE
                           END
              GROUP BY lostreasonsbyoffer.IdOffer) AS tmp
       WHERE    tmp.LostReasonId3 = _idLostReason
             OR tmp.LostReasonId1 = _idLostReason
             OR tmp.LostReasonId2 = _idLostReason
             OR tmp.LostReasonId4 = _idLostReason UNION SELECT Count(tmp.IdOffer) NumberOfOffers,
             tmp.IdCompetitor,
             tmp.Competitor
        FROM (  SELECT lostreasonsbyoffer.IdOffer,
                       SUBSTRING_INDEX(IdLostReasonList, ';', 1)
                          AS LostReasonId1,
                       if(
                          SUBSTRING_INDEX(
                             SUBSTRING_INDEX(IdLostReasonList, ';', 2),
                             ';',
                             -1) != SUBSTRING_INDEX(IdLostReasonList, ';', 1),
                          SUBSTRING_INDEX(
                             SUBSTRING_INDEX(IdLostReasonList, ';', 2),
                             ';',
                             -1),
                          '')
                          AS LostReasonId2,
                       if(
                          SUBSTRING_INDEX(
                             SUBSTRING_INDEX(IdLostReasonList, ';', 3),
                             ';',
                             -1) !=
                             SUBSTRING_INDEX(
                                SUBSTRING_INDEX(IdLostReasonList, ';', 2),
                                ';',
                                -1),
                          SUBSTRING_INDEX(
                             SUBSTRING_INDEX(IdLostReasonList, ';', 3),
                             ';',
                             -1),
                          '')
                          AS LostReasonId3,
                       if(
                          SUBSTRING_INDEX(
                             SUBSTRING_INDEX(IdLostReasonList, ';', 4),
                             ';',
                             -1) !=
                             SUBSTRING_INDEX(
                                SUBSTRING_INDEX(IdLostReasonList, ';', 3),
                                ';',
                                -1),
                          SUBSTRING_INDEX(
                             SUBSTRING_INDEX(IdLostReasonList, ';', 4),
                             ';',
                             -1),
                          '')
                          AS LostReasonId4,
                       lostreasonsbyoffer.IdCompetitor,
                       comp.Name AS Competitor
                  FROM lostreasonsbyoffer
                       LEFT JOIN competitors comp
                          ON comp.IdCompetitor =
                                lostreasonsbyoffer.IdCompetitor
                       INNER JOIN offers of
                          ON lostreasonsbyoffer.IdOffer = of.IdOffer
                       INNER JOIN sites si ON si.idsite = of.idcustomer
                       INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
                       INNER JOIN countries co ON co.idcountry = si.idcountry
                       INNER JOIN zones zo ON zo.idzone = co.idzone
                         INNER JOIN offerstatustypes offst on offst.IdOfferStatusType = of.IdStatus
                       INNER JOIN sales_status_types ss on ss.IdSalesStatusType = offst.IdSalesStatusType
                       INNER JOIN
                       (  SELECT idoffer, p.code, p.ReceivedIn,p.IdSite
                            FROM customerpurchaseordersbyoffer po
                                 INNER JOIN customerpurchaseorders p
                                    ON p.idcustomerpurchaseorders =
                                          po.idcustomerpurchaseorder
                           WHERE     YEAR(p.receivedin) = _accountingYear
                        GROUP BY idoffer
                          HAVING MIN(p.receivedin)) AS tmppo
                          ON tmppo.idoffer = of.idoffer
                 WHERE     YEAR(
                              IF(
                                 tmppo.Code IS NULL,
                                 IFNULL(of.DeliveryDate,
                                        concat(_accountingYear, '-01-01')),
                                 tmppo.ReceivedIn)) = _accountingYear
                       AND of.idoffertype IN (1, 10) AND ss.IdSalesStatusType IN(4)
                       AND si.IdCustomer NOT IN (8, 10)
                       AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) AND tmppo.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
                       AND CASE
                              WHEN _idPermission = 20
                              THEN
                                 (   si.idsalesresponsible IN (_idUser)
                                  OR si.IdSalesResponsibleAssemblyBU IN
                                        (_idUser))
                              WHEN _idPermission = 21
                              THEN
                                 (   si.idsalesresponsible IN (_idUser)
                                  OR si.IdSalesResponsibleAssemblyBU IN
                                        (_idUser))
                              WHEN _idPermission = 22
                              THEN
                                 TRUE
                              ELSE
                                 FALSE
                           END
              GROUP BY lostreasonsbyoffer.IdOffer) AS tmp
       WHERE    tmp.LostReasonId3 = _idLostReason
             OR tmp.LostReasonId1 = _idLostReason
             OR tmp.LostReasonId2 = _idLostReason
             OR tmp.LostReasonId4 = _idLostReason;
   END;



DROP PROCEDURE IF EXISTS geos.lostreasonsbyoffer_GetSelectedUsersOfferLostReasonsDetails;
CREATE PROCEDURE geos.`lostreasonsbyoffer_GetSelectedUsersOfferLostReasonsDetails`(
   IN _idUser           varchar(2000),
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idLostReason     tinyint(3) UNSIGNED)
BEGIN
      SET @query =
             concat(
                '  SELECT Count(tmp.IdOffer) NumberOfOffers,',
                ' tmp.IdCompetitor,',
                ' tmp.Competitor',
                ' FROM (  SELECT lostreasonsbyoffer.IdOffer,',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 1)',
                ' AS LostReasonId1,',
                ' if(',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 2),',
                ' \';\',',
                ' -1) != SUBSTRING_INDEX(IdLostReasonList, \';\', 1),',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 2),',
                ' \';\',',
                ' -1),',
                ' \'\')',
                ' AS LostReasonId2,',
                ' if(',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 3),',
                ' \';\',',
                ' -1) !=',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 2),',
                ' \';\',',
                ' -1),',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 3),',
                ' \';\',',
                ' -1),',
                ' \'\')',
                ' AS LostReasonId3,',
                ' if(',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 4),',
                ' \';\',',
                ' -1) !=',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 3),',
                ' \';\',',
                ' -1),',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 4),',
                ' \';\',',
                ' -1),',
                ' \'\')',
                ' AS LostReasonId4,',
                ' lostreasonsbyoffer.IdCompetitor,',
                ' comp.Name AS Competitor',
                '  FROM lostreasonsbyoffer',
                ' LEFT JOIN competitors comp',
                ' ON comp.IdCompetitor =',
                ' lostreasonsbyoffer.IdCompetitor',
                '  INNER JOIN offers of',
                ' ON lostreasonsbyoffer.IdOffer = of.IdOffer',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType = oft.IdSalesStatusType',
                ' LEFT JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmppo',
                ' ON tmppo.idoffer = of.idoffer',
                ' WHERE     YEAR(',
                ' IF(',
                ' tmppo.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                '  concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmppo.ReceivedIn)) = ',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10) AND ss.IdSalesStatusType NOT IN (4)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) OR tmppo.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) ',
                '  AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN',
                ' (',
                _idUser,
                '))',
                ' GROUP BY lostreasonsbyoffer.IdOffer) AS tmp',
                '  WHERE    tmp.LostReasonId3 = ',
                _idLostReason,
                ' OR tmp.LostReasonId1 = ',
                _idLostReason,
                ' OR tmp.LostReasonId2 = ',
                _idLostReason,
                ' OR tmp.LostReasonId4 = ',
                _idLostReason,
                ' UNION SELECT Count(tmp.IdOffer) NumberOfOffers,',
                ' tmp.IdCompetitor,',
                ' tmp.Competitor',
                ' FROM (  SELECT lostreasonsbyoffer.IdOffer,',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 1)',
                ' AS LostReasonId1,',
                ' if(',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 2),',
                ' \';\',',
                ' -1) != SUBSTRING_INDEX(IdLostReasonList, \';\', 1),',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 2),',
                ' \';\',',
                ' -1),',
                ' \'\')',
                ' AS LostReasonId2,',
                ' if(',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 3),',
                ' \';\',',
                ' -1) !=',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 2),',
                ' \';\',',
                ' -1),',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 3),',
                ' \';\',',
                ' -1),',
                ' \'\')',
                ' AS LostReasonId3,',
                ' if(',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 4),',
                ' \';\',',
                ' -1) !=',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 3),',
                ' \';\',',
                ' -1),',
                ' SUBSTRING_INDEX(',
                ' SUBSTRING_INDEX(IdLostReasonList, \';\', 4),',
                ' \';\',',
                ' -1),',
                ' \'\')',
                ' AS LostReasonId4,',
                ' lostreasonsbyoffer.IdCompetitor,',
                ' comp.Name AS Competitor',
                '  FROM lostreasonsbyoffer',
                ' LEFT JOIN competitors comp',
                ' ON comp.IdCompetitor =',
                ' lostreasonsbyoffer.IdCompetitor',
                '  INNER JOIN offers of',
                ' ON lostreasonsbyoffer.IdOffer = of.IdOffer',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType = oft.IdSalesStatusType',
                ' INNER JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite ',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmppo',
                ' ON tmppo.idoffer = of.idoffer',
                ' WHERE     YEAR(',
                ' IF(',
                ' tmppo.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                '  concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmppo.ReceivedIn)) = ',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10) AND ss.IdSalesStatusType IN (4)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND (of.IdCustomerToDelivery NOT IN(select IdSite from sites where IdCustomer =10 ) AND tmppo.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10)) ',
                '  AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN',
                ' (',
                _idUser,
                '))',
                ' GROUP BY lostreasonsbyoffer.IdOffer) AS tmp',
                '  WHERE    tmp.LostReasonId3 = ',
                _idLostReason,
                ' OR tmp.LostReasonId1 = ',
                _idLostReason,
                ' OR tmp.LostReasonId2 = ',
                _idLostReason,
                ' OR tmp.LostReasonId4 = ',
                _idLostReason,';');
              PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;

DROP PROCEDURE IF EXISTS geos.sites_GetTargetByCustomerYearwise;
CREATE PROCEDURE geos.`sites_GetTargetByCustomerYearwise`(
   IN _idUser               smallint(5) UNSIGNED,
   IN _idZone               smallint(5) UNSIGNED,
   IN _idcurrency           TINYINT(4) UNSIGNED,
   IN _accountingFromYear   int(10) UNSIGNED,
   IN _accountingToYear     int(10) UNSIGNED,
   IN _idPermission         smallint(5) UNSIGNED)
BEGIN
        SELECT s.IdSite,
               UPPER(co.Name) AS CustomerCountry,
               UPPER(c.Name) AS CustomerGroup,
               s.Name AS CustomerName,
               CAST(
                  ROUND(t.TargetAmount, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))
                  AS TargetSalesAmount,
               cur.IdCurrency AS TargetSalesIdCurrency,
               cur.Symbol AS TargetSalesCurrencySymbol,
               cur.Name AS TargetSalesCurrency,
               t.`Year`
          FROM sites s
               INNER JOIN customers c ON c.IdCustomer = s.IdCustomer
               INNER JOIN countries co ON co.idCountry = s.IdCountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN salestargetbysite t
                  ON (    t.idsite = s.idsite
                      AND (t.`Year` BETWEEN _accountingFromYear
                                        AND _accountingToYear))
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = t.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
         WHERE     s.IdCustomer NOT IN (8, 10)
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   s.idsalesresponsible IN (_idUser)
                          OR s.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   s.idsalesresponsible IN (_idUser)
                          OR s.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      ORDER BY CustomerCountry, CustomerGroup, CustomerName;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetSelectedUsersTargetByCustomerYearwise;
CREATE PROCEDURE geos.`sites_GetSelectedUsersTargetByCustomerYearwise`(
   IN _idUser               varchar(2000),
   IN _idcurrency           TINYINT(4) UNSIGNED,
   IN _accountingFromYear   int(10) UNSIGNED,
   IN _accountingToYear     int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                '  SELECT s.IdSite,',
                ' UPPER(co.Name) AS CustomerCountry,',
                ' UPPER(c.Name) AS CustomerGroup,',
                ' s.Name AS CustomerName,',
                ' CAST(',
                ' ROUND(t.TargetAmount, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))',
                ' AS TargetSalesAmount,',
                ' cur.IdCurrency AS TargetSalesIdCurrency,',
                ' cur.Symbol AS TargetSalesCurrencySymbol,',
                ' cur.Name AS TargetSalesCurrency,',
                '  t.`Year`',
                ' FROM sites s',
                ' INNER JOIN customers c ON c.IdCustomer = s.IdCustomer',
                ' INNER JOIN countries co ON co.idCountry = s.IdCountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN salestargetbysite t',
                ' ON (    t.idsite = s.idsite',
                '  AND (t.`Year` BETWEEN ',
                _accountingFromYear,
                ' AND ',
                _accountingToYear,
                '))',
                '  INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = t.idcurrency',
                '  AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                '  WHERE     s.IdCustomer NOT IN (8, 10)',
                ' AND (   s.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR s.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                '  ORDER BY CustomerCountry, CustomerGroup, CustomerName;');

      PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetForecastedByCustomerYearwise;
CREATE PROCEDURE geos.`sites_GetForecastedByCustomerYearwise`(
   IN _idcurrency           TINYINT(4) UNSIGNED,
   IN _idUser               smallint(5) UNSIGNED,
   IN _idZone               smallint(5) UNSIGNED,
   IN _accountingFromYear   int(10) UNSIGNED,
   IN _accountingToYear     int(10) UNSIGNED,
   IN _idPermission         smallint(5) UNSIGNED)
BEGIN
        SELECT of.idCustomer,
               YEAR(
                  IF(
                     tmp.Code IS NULL,
                     IFNULL(of.DeliveryDate,
                            concat(_accountingFromYear, '-01-01')),
                     tmp.ReceivedIn))
                  AS ForecastedYear,
               CAST(
                  SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))
                  AS Amount,
               cur.name AS Currency,
               cur.Symbol AS CurrencySymbol
          FROM offers of
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               LEFT JOIN
               (  SELECT idoffer, p.code, p.ReceivedIn
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE     YEAR(p.receivedin) BETWEEN _accountingFromYear
                                              AND _accountingToYear
                         AND p.idsite NOT IN (SELECT IdSite
                                                FROM sites
                                               WHERE IdCustomer = 10)
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     of.idoffertype IN (1, 10)
               AND si.IdCustomer NOT IN (8, 10)
               AND of.IdStatus IN (15)
               AND of.IdCustomerToDelivery NOT IN (SELECT IdSite
                                                     FROM sites
                                                    WHERE IdCustomer = 10)
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
               AND YEAR(
                      IF(
                         tmp.Code IS NULL,
                         IFNULL(of.DeliveryDate,
                                concat(_accountingFromYear, '-01-01')),
                         tmp.ReceivedIn)) BETWEEN _accountingFromYear
                                              AND _accountingToYear
      GROUP BY of.idCustomer,
               YEAR(
                  IF(
                     tmp.Code IS NULL,
                     IFNULL(of.DeliveryDate,
                            concat(_accountingFromYear, '-01-01')),
                     tmp.ReceivedIn));
   END;



DROP PROCEDURE IF EXISTS geos.sites_GetTargetByCustomerYearwise;
CREATE PROCEDURE geos.`sites_GetTargetByCustomerYearwise`(
   IN _idUser               smallint(5) UNSIGNED,
   IN _idZone               smallint(5) UNSIGNED,
   IN _idcurrency           TINYINT(4) UNSIGNED,
   IN _accountingFromYear   int(10) UNSIGNED,
   IN _accountingToYear     int(10) UNSIGNED,
   IN _idPermission         smallint(5) UNSIGNED)
BEGIN
        SELECT s.IdSite,
               UPPER(co.Name) AS CustomerCountry,
               UPPER(c.Name) AS CustomerGroup,
               s.Name AS CustomerName,
               CAST(
                  ROUND(t.TargetAmount, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))
                  AS TargetSalesAmount,
               cur.IdCurrency AS TargetSalesIdCurrency,
               cur.Symbol AS TargetSalesCurrencySymbol,
               cur.Name AS TargetSalesCurrency,
               t.`Year`
          FROM sites s
               INNER JOIN customers c ON c.IdCustomer = s.IdCustomer
               INNER JOIN countries co ON co.idCountry = s.IdCountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN salestargetbysite t
                  ON (    t.idsite = s.idsite
                      AND (t.`Year` BETWEEN _accountingFromYear
                                        AND _accountingToYear))
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = t.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
         WHERE     s.IdCustomer NOT IN (8, 10)
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   s.idsalesresponsible IN (_idUser)
                          OR s.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   s.idsalesresponsible IN (_idUser)
                          OR s.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      ORDER BY CustomerCountry, CustomerGroup, CustomerName;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetCustomerDetails;
CREATE PROCEDURE geos.`sites_GetCustomerDetails`(
   IN _idUser         smallint(5) UNSIGNED,
   IN _idZone         smallint(5) UNSIGNED,
   IN _idPermission   smallint(5) UNSIGNED)
BEGIN
        SELECT s.IdSite,
               UPPER(co.Name) AS CustomerCountry,
               UPPER(c.Name) AS CustomerGroup,
               zo.Name AS CustomerZone,
               replace(s.name, concat('(', co.name, ')'), '') AS CustomerName,
               c.IdCustomer,
               s.IdSalesResponsible,
               s.IdSalesResponsibleAssemblyBU
          FROM sites s
               INNER JOIN customers c ON c.IdCustomer = s.IdCustomer
               INNER JOIN countries co ON co.idCountry = s.IdCountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
         WHERE     s.IdCustomer NOT IN (8, 10)
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   s.idsalesresponsible IN (_idUser)
                          OR s.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   s.idsalesresponsible IN (_idUser)
                          OR s.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      ORDER BY CustomerCountry, CustomerGroup, CustomerName;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetSelectedUsersForecastedByCustomerYearwise;
CREATE PROCEDURE geos.`sites_GetSelectedUsersForecastedByCustomerYearwise`(
   IN _idcurrency           TINYINT(4) UNSIGNED,
   IN _idUser               varchar(2000),
   IN _accountingFromYear   int(10) UNSIGNED,
   IN _accountingToYear     int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                ' SELECT of.idCustomer,',
                ' YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingFromYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn))',
                ' AS ForecastedYear,',
                ' CAST(',
                ' SUM(ROUND(of.value, 4) * ROUND(cc.exchangerate, 4)) AS DECIMAL(18, 4))',
                ' AS Amount,',
                ' cur.name AS Currency,',
                ' cur.Symbol AS CurrencySymbol',
                
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                '  INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' LEFT JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) BETWEEN ',
                _accountingFromYear,
                ' AND ',
                _accountingToYear,
                ' AND p.idsite NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10) GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND of.IdStatus IN (15)',
                ' AND of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                '   FROM sites',
                '  WHERE IdCustomer = 10)',
                '  AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' AND YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingFromYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn)) BETWEEN ',
                _accountingFromYear,
                ' AND ',
                _accountingToYear,
                ' GROUP BY of.idCustomer,',
                '  YEAR(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingFromYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn));');
                       PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetSelectedUsersTargetByCustomerYearwise;
CREATE PROCEDURE geos.`sites_GetSelectedUsersTargetByCustomerYearwise`(
   IN _idUser               varchar(2000),
   IN _idcurrency           TINYINT(4) UNSIGNED,
   IN _accountingFromYear   int(10) UNSIGNED,
   IN _accountingToYear     int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                '  SELECT s.IdSite,',
                ' UPPER(co.Name) AS CustomerCountry,',
                ' UPPER(c.Name) AS CustomerGroup,',
                ' s.Name AS CustomerName,',
                ' CAST(',
                ' ROUND(t.TargetAmount, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))',
                ' AS TargetSalesAmount,',
                ' cur.IdCurrency AS TargetSalesIdCurrency,',
                ' cur.Symbol AS TargetSalesCurrencySymbol,',
                ' cur.Name AS TargetSalesCurrency,',
                '  t.`Year`',
                ' FROM sites s',
                ' INNER JOIN customers c ON c.IdCustomer = s.IdCustomer',
                ' INNER JOIN countries co ON co.idCountry = s.IdCountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' INNER JOIN salestargetbysite t',
                ' ON (    t.idsite = s.idsite',
                '  AND (t.`Year` BETWEEN ',
                _accountingFromYear,
                ' AND ',
                _accountingToYear,
                '))',
                '  INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = t.idcurrency',
                '  AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                '  WHERE     s.IdCustomer NOT IN (8, 10)',
                ' AND (   s.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR s.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                '  ORDER BY CustomerCountry, CustomerGroup, CustomerName;');

      PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetSelectedUsersCustomerDetails;
CREATE PROCEDURE geos.`sites_GetSelectedUsersCustomerDetails`(
   IN _idUser varchar(2000))
BEGIN
      SET @query =
             concat(
                ' SELECT s.IdSite,',
                ' UPPER(co.Name) AS CustomerCountry,',
                ' UPPER(c.Name) AS CustomerGroup,',
                ' zo.Name AS CustomerZone,',
                '  replace(s.name, concat(\'(\', co.name, \')\'), \'\') AS CustomerName,',
                ' c.IdCustomer,',
                ' s.IdSalesResponsible,',
                ' s.IdSalesResponsibleAssemblyBU',
                '  FROM sites s',
                ' INNER JOIN customers c ON c.IdCustomer = s.IdCustomer',
                ' INNER JOIN countries co ON co.idCountry = s.IdCountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' WHERE     s.IdCustomer NOT IN (8, 10)',
                ' AND (   s.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR s.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' ORDER BY CustomerCountry, CustomerGroup, CustomerName;');
         PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetInvoicesAmount;
CREATE PROCEDURE geos.`offers_GetInvoicesAmount`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission smallint(5) UNSIGNED)
BEGIN
     
        SELECT of.IdOffer,
               CAST(
                    SUM(ROUND(cdni.UnitPrice, 4) * ROUND(Quantity, 4))
                  * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))
                  AS InvoiceAmount,
               cur.Name AS InvoiceCurrency
          FROM customerinvoiceitems cii
               INNER JOIN customerdeliverynoteitems cdni
                  ON cdni.idCustomerdeliverynoteitem =
                        cii.idCustomerDeliveryNoteItem
               INNER JOIN customerdeliverynotes cdn
                  ON cdn.Iddeliverynote = cdni.idCustomerdeliverynote
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = cdn.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo
               INNER JOIN offers of ON of.idOffer = cdni.IdOffer
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
              INNER JOIN (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear 
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     of.idoffertype IN (1, 10)
               AND si.IdCustomer NOT IN (8, 10)
               AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) AND tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                            (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
               AND YEAR(tmp.receivedIn) = _accountingYear
      GROUP BY of.IdOffer;
   END;



DROP PROCEDURE IF EXISTS geos.offers_GetOrdersDatatable;
CREATE PROCEDURE geos.`offers_GetOrdersDatatable`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED,
   IN _idPermission     smallint(5) UNSIGNED)
BEGIN
DROP TEMPORARY TABLE IF EXISTS table2;
 CREATE TEMPORARY TABLE IF NOT EXISTS table2 AS (
              
      SELECT of.idoffer,
             of.Code AS OfferCode,
             of.description AS OfferTitle,
             zo.name AS CustomerZone,
             of.IdSalesOwner,
             si.IdSalesResponsible,
             si.IdSalesResponsibleAssemblyBU,
             UPPER(co.name) AS CustomerCountry,
               UPPER(cu.name) AS CustomerGroup,
               replace(si.name, concat('(', co.name, ')'), '') AS CustomerName,
               of.IdStatus AS IdStatus,
           
               oft.name AS OfferStatus,
               CAST(
                  ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))
                  AS OfferAmount,
               cur.name AS OfferCurrency,
               DATE(MIN(tmp.ReceivedIn)) AS PoReceptionDate,
               oft.HtmlColor AS OfferStatusColor,
               oft.IdSalesStatusType AS IdSalesStatusType,
               ss.Name AS Status,
               ss.HtmlColor AS SalesStatusTypeColor
          FROM offers of
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
               INNER JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN currencyconversions cc
                  ON     cc.idcurrencyFrom = of.idcurrency
                     AND idcurrencyTo = _idcurrency
               INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo

               INNER JOIN sales_status_types ss
                  ON ss.IdSalesStatusType = oft.IdSalesStatusType
               INNER JOIN
              (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer

         WHERE     of.idoffertype IN (1, 10)
               AND si.IdCustomer NOT IN (8, 10)
               AND of.idstatus NOT IN (4, 12)
               AND (of.IdCustomerToDelivery NOT IN (SELECT IdSite
                                                     FROM sites
                                                    WHERE IdCustomer = 10) AND tmp.IdSite NOT IN (SELECT IdSite
                                                     FROM sites
                                                    WHERE IdCustomer = 10))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                          (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      GROUP BY of.idoffer
        HAVING YEAR(MIN(tmp.ReceivedIn)) = _accountingYear
      ORDER BY of.year, of.number);
      
      select * from table2;
      
        SELECT op.IdOffer,
               op.IdOption,
               op.Quantity,
               ofop.Name AS offeroption,
               ofop.IdOfferOptionType,
               oftype.Name AS offeroptiontype
          FROM 
                optionsbyoffer op
               INNER JOIN offeroptions ofop
                  ON op.IdOption = ofop.idOfferOption
               INNER JOIN offeroptiontypes oftype
                  ON oftype.IdOfferOptionType = ofop.IdOfferOptionType
             
         WHERE  op.IdOffer IN(select idoffer from table2)
      GROUP BY op.IdOffer, op.IdOption;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetSelectedUserInvoicesAmount;
CREATE PROCEDURE geos.`offers_GetSelectedUserInvoicesAmount`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(2000),
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             concat(
                ' SELECT of.IdOffer,',
                ' CAST(',
                ' SUM(ROUND(cdni.UnitPrice, 4) * ROUND(Quantity, 4))',
                ' * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))',
                ' AS InvoiceAmount,',
                ' cur.Name AS InvoiceCurrency',
                ' FROM customerinvoiceitems cii',
                ' INNER JOIN customerdeliverynoteitems cdni',
                ' ON cdni.idCustomerdeliverynoteitem =',
                '  cii.idCustomerDeliveryNoteItem',
                ' INNER JOIN customerdeliverynotes cdn',
                ' ON cdn.Iddeliverynote = cdni.idCustomerdeliverynote',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = cdn.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN offers of ON of.idOffer = cdni.IdOffer',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
               ' INNER JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE of.idoffertype IN (1, 10)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                 ' AND (of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10) AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10))',
                ' AND (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' AND YEAR(tmp.receivedIn) = ',
                _accountingYear,
                ' GROUP BY of.IdOffer;');
                
                 PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;



DROP PROCEDURE IF EXISTS geos.offers_GetSelectedUsersOrdersDatatable;
CREATE PROCEDURE geos.`offers_GetSelectedUsersOrdersDatatable`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(2000),
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      DROP TEMPORARY TABLE IF EXISTS table2;
      SET @query =
             concat(
                ' CREATE TEMPORARY TABLE IF NOT EXISTS table2 AS ( ',
                ' SELECT of.idoffer,',
                ' of.Code AS OfferCode,',
                ' of.description AS OfferTitle,',
                ' zo.name AS CustomerZone,',
                ' of.IdSalesOwner,',
                ' si.IdSalesResponsible,',
                ' si.IdSalesResponsibleAssemblyBU,',
                ' UPPER(co.name) AS CustomerCountry,',
                ' UPPER(cu.name) AS CustomerGroup,',
                ' replace(si.name, concat(\'(\', co.name, \')\'), \'\') AS CustomerName,',
                ' of.IdStatus AS IdStatus,',
                ' oft.HtmlColor AS OfferStatusColor,',
                ' oft.name AS OfferStatus,',
                ' CAST(',
                ' ROUND(of.value, 4) * ROUND(cc.exchangerate, 4) AS DECIMAL(18, 4))',
                ' AS OfferAmount,',
                ' cur.name AS OfferCurrency,',
                ' DATE(MIN(tmp.ReceivedIn)) AS PoReceptionDate,',
                ' oft.IdSalesStatusType AS IdSalesStatusType,',
                ' ss.Name AS Status,',
                ' ss.HtmlColor AS SalesStatusTypeColor',
                ' FROM offers of',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                '  INNER JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN currencyconversions cc',
                ' ON     cc.idcurrencyFrom = of.idcurrency',
                ' AND idcurrencyTo = ',
                _idcurrency,
                ' INNER JOIN currency cur ON cur.IdCurrency = cc.IdCurrencyTo',
                ' INNER JOIN sales_status_types ss',
                ' ON ss.IdSalesStatusType = oft.IdSalesStatusType',
               ' INNER JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     of.idoffertype IN (1, 10)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND of.idstatus NOT IN (4, 12)',
                ' AND (of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10) AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10))',
                ' AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY of.idoffer',
                ' HAVING YEAR(MIN(tmp.ReceivedIn)) =',
                _accountingYear,
                ' ORDER BY of.year, of.number)');

       PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;


      SELECT * FROM table2;

        SELECT op.IdOffer,
               op.IdOption,
               op.Quantity,
               ofop.Name AS offeroption,
               ofop.IdOfferOptionType,
               oftype.Name AS offeroptiontype
          FROM optionsbyoffer op
               INNER JOIN offeroptions ofop ON op.IdOption = ofop.idOfferOption
               INNER JOIN offeroptiontypes oftype
                  ON oftype.IdOfferOptionType = ofop.IdOfferOptionType
         WHERE op.IdOffer IN (SELECT idoffer FROM table2)
      GROUP BY op.IdOffer, op.IdOption;
   END;


DROP PROCEDURE IF EXISTS geos.people_GetContactsBySalesOwnerId;
CREATE PROCEDURE geos.`people_GetContactsBySalesOwnerId`(
   IN _idUser         smallint(5) UNSIGNED,
   IN _idZone         smallint(5) UNSIGNED,
   IN _idPermission   smallint(5) UNSIGNED)
BEGIN
        SELECT p.IdPerson,
               TRIM(p.Name) AS FirstName,
               TRIM(IFNULL(p.Surname, '')) AS LastName,
               TRIM(IFNULL(p.phone, '')) AS Telephone,
               TRIM(IFNULL(p.email, '')) AS Email,
               p.IdPersonGender,
               p.Observations,
               si.IdSite AS IdCompany,
               c.IdCustomer AS IdCustomer,
               UPPER(c.Name) AS CustomerGroup,
               co.idCountry AS IdCountry,
               co.name AS Country,
               zo.Name AS Zone,
               replace(si.name, concat('(', co.name, ')'), '') AS CustomerPlant,
               si.Address AS SiteAddress,
               si.City AS SiteCity,
               si.CIF AS SiteCIF,
               si.Telephone AS SiteTelephone,
               si.Fax AS SiteFax,
               si.PostCode AS SitePostCode,
               si.Region AS SiteRegion,
               si.RegisteredName AS SiteRegisteredName,
               si.Website AS SiteWebsite
          FROM people p
               INNER JOIN sites si ON si.IdSite = p.IdSite
               INNER JOIN countries co ON co.IdCountry = si.IdCountry
               INNER JOIN zones zo ON zo.IdZone = co.IdZone
               INNER JOIN customers c ON c.IdCustomer = si.IdCustomer
         WHERE     si.IdCustomer NOT IN (8, 10)
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
               AND p.IsStillActive = TRUE
      ORDER BY p.Name,
               p.Surname,
               c.Name,
               si.Name;
   END;


DROP PROCEDURE IF EXISTS geos.people_GetSelectedUserContactsBySalesOwnerId;
CREATE PROCEDURE geos.`people_GetSelectedUserContactsBySalesOwnerId`(
   IN _idUser varchar(2000))
BEGIN
      SET @query =
             concat(
                'SELECT p.IdPerson,',
                ' TRIM(p.Name) AS FirstName,',
                ' TRIM(IFNULL(p.Surname, \'\')) AS LastName,',
                ' TRIM(IFNULL(p.phone, \'\')) AS Telephone,',
                ' TRIM(IFNULL(p.email, \'\')) AS Email,',
                ' p.IdPersonGender,',
                ' p.Observations,',
                ' si.IdSite As IdCompany,',
                ' c.IdCustomer As IdCustomer,',
                ' UPPER(c.Name) AS CustomerGroup,',
                ' co.idCountry AS IdCountry,',
                ' co.name AS Country,',
                ' zo.Name AS Zone,',
                ' replace(si.name, concat(\'(\', co.name, \')\'), \'\') AS CustomerPlant,',
                ' si.Address AS SiteAddress,',
                ' si.City AS SiteCity,',
                ' si.CIF AS SiteCIF,',
                ' si.Telephone AS SiteTelephone,',
                ' si.Fax AS SiteFax,',
                ' si.PostCode AS SitePostCode,',
                ' si.Region AS SiteRegion,',
                ' si.RegisteredName AS SiteRegisteredName,',
                ' si.Website AS SiteWebsite',
                '  FROM people p',
                ' INNER JOIN sites si ON si.IdSite = p.IdSite',
                ' INNER JOIN countries co ON co.IdCountry = si.IdCountry',
                ' INNER JOIN zones zo ON zo.IdZone = co.IdZone',
                ' INNER JOIN customers c ON c.IdCustomer = si.IdCustomer',
                ' WHERE     si.IdCustomer NOT IN (8, 10)',
                ' AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' AND p.IsStillActive = TRUE',
                ' ORDER BY p.Name,',
                ' p.Surname,',
                ' c.Name,',
                ' si.Name;');

       PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.people_UpdateContact;
CREATE PROCEDURE geos.`people_UpdateContact`(
   IN _IdPerson         smallint(5) UNSIGNED,
   IN _Name             varchar(20),
   IN _Surname          varchar(50),
   IN _Email            varchar(50),
   IN _IdSite           smallint(5) UNSIGNED,
   IN _Phone            varchar(30),
   IN _Observations     varchar(100),
   IN _IdPersonGender   tinyint(3) UNSIGNED,
   IN _IdCompany        smallint(5) UNSIGNED,
   IN _IdCountry        int(10) UNSIGNED,
   IN _Address          varchar(100),
   IN _Telephone        varchar(30),
   IN _CompanyEmail     varchar(50),
   IN _Region           varchar(255),
   IN _City             varchar(50),
   IN _PostCode         varchar(100),
   IN _ModifiedBy       smallint(5) UNSIGNED,
   IN _ModifiedIn       datetime)
BEGIN
      UPDATE people
         SET Name = _Name,
             Surname = _Surname,
             Email = _Email,
             IdSite = _IdSite,
             Phone = _Phone,
             Observations = _Observations,
             IdPersonGender = _IdPersonGender
       WHERE IdPerson = _IdPerson;

      UPDATE sites
         SET IdCountry = _IdCountry,
             City = _City,
             Address = _Address,
             Telephone = _Telephone,
             Email = _CompanyEmail,
             PostCode = _PostCode,
             Region = _Region,
             ModifiedBy = _ModifiedBy,
             ModifiedIn = _ModifiedIn
       WHERE IdSite = _IdCompany;
   END;


DROP PROCEDURE IF EXISTS geos.people_InsertContact;
CREATE PROCEDURE geos.`people_InsertContact`(
   IN _IdPersonType     tinyint(3) UNSIGNED,
   IN _Name             varchar(20),
   IN _Surname          varchar(50),
   IN _Email            varchar(50),
   IN _Phone            varchar(30),
   IN _Observations     varchar(100),
   IN _IdPersonGender   tinyint(3) UNSIGNED,
   IN _CreatedIn        datetime,
   IN _IdCompany        smallint(5) UNSIGNED,
   IN _IdCountry        int(10) UNSIGNED,
   IN _Address          varchar(100),
   IN _Telephone        varchar(30),
   IN _CompanyEmail     varchar(50),
   IN _Region           varchar(255),
   IN _City             varchar(50),
   IN _PostCode         varchar(100),
   IN _ModifiedBy       smallint(5) UNSIGNED,
   IN _ModifiedIn       datetime)
BEGIN
      INSERT INTO people(Name,
                         Surname,
                         IdPersonType,
                         IdSite,
                         Email,
                         Phone,
                         Observations,
                         CreatedIn,
                         IdPersonGender)
           VALUES (_Name,
                   _Surname,
                   _IdPersonType,
                   _IdCompany,
                   _Email,
                   _Phone,
                   _Observations,
                   _CreatedIn,
                   _IdPersonGender);


      UPDATE sites
         SET IdCountry = _IdCountry,
             City = _City,
             Address = _Address,
             Telephone = _Telephone,
             Email = _CompanyEmail,
             PostCode = _PostCode,
             Region = _Region,
             ModifiedBy = _ModifiedBy,
             ModifiedIn = _ModifiedIn
       WHERE IdSite = _IdCompany;
       
          SELECT LAST_INSERT_ID();
   END;


DROP PROCEDURE IF EXISTS geos.offeroptions_GetAllOfferOptions;
CREATE PROCEDURE geos.`offeroptions_GetAllOfferOptions`()
BEGIN
SELECT offeroptions.idOfferOption,offeroptions.Name,offeroptions.IdOfferOptionType,offeroptiontypes.Name AS offeroptiontype
FROM offeroptions INNER JOIN offeroptiontypes ON offeroptiontypes.IdOfferOptionType = offeroptions.IdOfferOptionType;
END;


DROP PROCEDURE IF EXISTS geos.sites_GetSalesOwnerBySiteId;
CREATE PROCEDURE geos.`sites_GetSalesOwnerBySiteId`(
   IN _idSite smallint(5) UNSIGNED)
BEGIN
        SELECT p.IdPerson, p.Name, p.Surname
          FROM sites si
               INNER JOIN people p
                  ON    p.IdPerson = si.idsalesresponsible
                     OR p.IdPerson = si.IdSalesResponsibleAssemblyBU
         WHERE si.IdSite = _idSite AND si.IdCustomer NOT IN (10)
      GROUP BY p.Name
      ORDER BY p.Name;
   END;


DROP PROCEDURE IF EXISTS geos.caroems_GetCarOEM;
CREATE PROCEDURE geos.`caroems_GetCarOEM`()
BEGIN
     SELECT IdCarOEM, Name FROM caroems ORDER BY name;
END;


DROP PROCEDURE IF EXISTS geos.competitors_GetCompetitors;
CREATE PROCEDURE geos.`competitors_GetCompetitors`()
BEGIN
     SELECT IdCompetitor, Name FROM competitors ORDER BY name;
END;


DROP PROCEDURE IF EXISTS geos.projects_GetProjectsByCustomerId;
CREATE PROCEDURE geos.`projects_GetProjectsByCustomerId`(
   _IdCustomer int(10) UNSIGNED)
BEGIN
      SELECT IdProject, Code, Title
        FROM projects
       WHERE IdCustomer = _IdCustomer;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetCustomersBySalesOwnerId;
CREATE PROCEDURE geos.`sites_GetCustomersBySalesOwnerId`(
   IN _idUser   smallint(5) UNSIGNED,
   IN _idZone   smallint(5) UNSIGNED,
   IN _idPermission   smallint(5) UNSIGNED)
BEGIN
   
        SELECT si.IdSite,
               cus.IdCustomer,
               UPPER(cus.Name) AS CustomerGroup,
               replace(si.name, concat(' (', co.name, ')'), '')
                  AS CustomerPlant,
               TRIM(IFNULL(si.RegisteredName, '')) AS RegisteredName,
               TRIM(IFNULL(si.CIF, '')) AS RegistrationNumber,
               co.idCountry,
               co.Name AS Country,
               TRIM(IFNULL(si.City, '')) AS City,
               TRIM(si.Address) AS Address,
               TRIM(IFNULL(si.telephone, '')) AS Phone,
               TRIM(IFNULL(si.fax, '')) AS Fax,
               TRIM(IFNULL(si.website, '')) AS WebSite,
               TRIM(IFNULL(si.Email, '')) AS Email,
               si.IdSalesResponsible,
               si.IdSalesResponsibleAssemblyBU,
               salesresponsible.Name AS SalesResponsibleName,
               salesresponsible.Surname AS SalesResponsibleSurname,
               salesresponsiblebu.Name AS SalesResponsiblebuName,
               salesresponsiblebu.Surname AS SalesResponsiblebuSurname,
               zo.Name AS SalesZone,
               si.PostCode,
               si.Line,
               si.CuttingMachines,
               si.Size,
               si.NumberOfEmployees,
               si.IdBusinessField,
               si.IdBusinessCenter,
               bf.Value AS BusinessField,
               bc.Value AS BusinessCenter
          FROM sites si
               INNER JOIN customers cus ON cus.IdCustomer = si.IdCustomer
               INNER JOIN countries co ON co.IdCountry = si.IdCountry
               INNER JOIN zones zo ON zo.IdZone = co.IdZone
               LEFT JOIN people salesresponsible
                  ON salesresponsible.IdPerson = si.IdSalesResponsible
               LEFT JOIN people salesresponsiblebu
                  ON salesresponsiblebu.IdPerson =
                        si.IdSalesResponsibleAssemblyBU
               LEFT JOIN emdep_geos.lookup_values bf
                  ON bf.IdLookupValue = si.IdBusinessField
               LEFT JOIN emdep_geos.lookup_values bc
                  ON bc.IdLookupValue = si.IdBusinessCenter
         WHERE     si.IdCustomer NOT IN (8, 10)
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                        (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
               AND si.IsStillActive = TRUE
      GROUP BY si.IdSite
      ORDER BY CustomerGroup, CustomerPlant;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetSelectedUserCustomersBySalesOwnerId;
CREATE PROCEDURE geos.`sites_GetSelectedUserCustomersBySalesOwnerId`(
   IN _idUser varchar(2000))
BEGIN
      SET @query =
             concat(
                ' SELECT si.IdSite,',
                ' cus.IdCustomer,',
                ' UPPER(cus.Name) AS CustomerGroup,',
                ' replace(si.name, concat(\' (\', co.name, \')\'), \'\')',
                ' AS CustomerPlant,',
                '  TRIM(IFNULL(si.RegisteredName, \'\')) AS RegisteredName,',
                ' TRIM(IFNULL(si.CIF, \'\')) AS RegistrationNumber,',
                ' co.idCountry,',
                ' co.Name AS Country,',
                ' TRIM(IFNULL(si.City, \'\')) AS City,',
                ' TRIM(si.Address) AS Address,',
                ' TRIM(IFNULL(si.telephone, \'\')) AS Phone,',
                ' TRIM(IFNULL(si.fax, \'\')) AS Fax,',
                ' TRIM(IFNULL(si.website, \'\')) AS WebSite,',
                ' TRIM(IFNULL(si.Email, \'\')) AS Email,',
                ' si.IdSalesResponsible,',
                ' si.IdSalesResponsibleAssemblyBU,',
                ' zo.Name AS SalesZone,',
                ' si.PostCode,',
                ' si.Line,',
                ' si.CuttingMachines,',
                ' si.Size,',
                ' si.NumberOfEmployees,',
                ' si.IdBusinessField,',
                ' si.IdBusinessCenter,',
                ' bf.Value AS BusinessField,',
                ' bc.Value AS BusinessCenter',
                ' FROM sites si',
                ' INNER JOIN customers cus ON cus.IdCustomer = si.IdCustomer',
                ' INNER JOIN countries co ON co.IdCountry = si.IdCountry',
                ' INNER JOIN zones zo ON zo.IdZone = co.IdZone',
                ' LEFT JOIN emdep_geos.lookup_values bf',
                ' ON bf.IdLookupValue = si.IdBusinessField',
                ' LEFT JOIN emdep_geos.lookup_values bc',
                '  ON bc.IdLookupValue = si.IdBusinessCenter',
                '  WHERE     si.IdCustomer NOT IN (8, 10)',
                ' AND (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' AND si.IsStillActive = TRUE',
                ' GROUP BY si.IdSite',
                ' ORDER BY CustomerGroup, CustomerPlant;');

       PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetOfferQuantitySalesStatusByMonth;
CREATE PROCEDURE geos.`offers_GetOfferQuantitySalesStatusByMonth`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           smallint(5) UNSIGNED,
   IN _idZone           smallint(5) UNSIGNED,
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      DECLARE _idPermission   smallint(5) UNSIGNED;
      SET _idPermission =
             (  SELECT IdPermission
                  FROM emdep_geos.user_permissions
                 WHERE (IdPermission IN (20, 21, 22) AND IdUser = _idUser)
              ORDER BY IdPermission DESC
                 LIMIT 1);

       Select * from ( SELECT of.idcustomer AS IdSite,
               si.IdCustomer AS IdCustomer,
               Month(
                  IF(
                     po.Code IS NULL,
                     IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01')),
                     po.ReceivedIn))
                  AS CurrentMonth,
               Week(
                  IF(
                     po.Code IS NULL,
                     IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01')),
                     po.ReceivedIn),
                  3)
                  AS CurrentWeek,
               UPPER(cu.Name) AS CustomerGroup,
               replace(si.name, concat('(', co.name, ')'), '') AS CustomerPlant,
               of.IdStatus AS OfferStatusId,
               oft.Name AS OfferStatusName,
               COUNT(*) AS NumberOfOffers,
               optoffer.Quantity AS OfferQuantity,
               optoffer.IdOption,
               opt.Name AS OfferOption,
               ss.IdSalesStatusType AS IdSalesStatusType,
               ss.Name AS Status
          FROM offers of
               LEFT JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types ss
                  ON oft.IdSalesStatusType = ss.IdSalesStatusType
               INNER JOIN optionsbyoffer optoffer
                  ON optoffer.IdOffer = of.IdOffer
               INNER JOIN offeroptions opt
                  ON opt.idOfferOption = optoffer.IdOption
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON si.IdCustomer = cu.IdCustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
              LEFT JOIN customerpurchaseordersbyoffer cpbo
                  ON cpbo.idoffer = of.idoffer
               LEFT JOIN customerpurchaseorders po
                  ON po.idcustomerpurchaseorders = cpbo.idcustomerpurchaseorder
         WHERE     YEAR(
                      IFNULL(of.DeliveryDate,
                             concat(_accountingYear, '-01-01'))) =
                      _accountingYear
               AND of.idoffertype IN (1, 10) AND ss.IdSalesStatusType NOT IN(4)
               AND si.IdCustomer NOT IN (8, 10)
              AND of.IdCustomerToDelivery NOT IN (SELECT IdSite
                                                     FROM sites
                                                    WHERE IdCustomer = 10)
               AND (   (of.idstatus NOT IN (12) AND cpbo.IdOffer IS NULL)
                    OR (of.idstatus IN (4) AND NOT cpbo.IdOffer IS NULL))
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                       (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      GROUP BY CurrentMonth,
               CurrentWeek,
               optoffer.IdOption,IdSite,IdCustomer,
               Status UNION SELECT of.idcustomer AS IdSite,
               si.IdCustomer AS IdCustomer,
               Month(
                  IF(
                     tmp.Code IS NULL,
                     IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01')),
                     tmp.ReceivedIn))
                  AS CurrentMonth,
               Week(
                  IF(
                     tmp.Code IS NULL,
                     IFNULL(of.DeliveryDate, concat(_accountingYear, '-01-01')),
                     tmp.ReceivedIn),
                  3)
                  AS CurrentWeek,
               UPPER(cu.Name) AS CustomerGroup,
               replace(si.name, concat('(', co.name, ')'), '') AS CustomerPlant,
               of.IdStatus AS OfferStatusId,
               oft.Name AS OfferStatusName,
               COUNT(*) AS NumberOfOffers,
               optoffer.Quantity AS OfferQuantity,
               optoffer.IdOption,
               opt.Name AS OfferOption,
               ss.IdSalesStatusType AS IdSalesStatusType,
               ss.Name AS Status
          FROM offers of
               LEFT JOIN offerstatustypes oft
                  ON oft.idofferstatustype = of.idstatus
               INNER JOIN sales_status_types ss
                  ON oft.IdSalesStatusType = ss.IdSalesStatusType
               INNER JOIN optionsbyoffer optoffer
                  ON optoffer.IdOffer = of.IdOffer
               INNER JOIN offeroptions opt
                  ON opt.idOfferOption = optoffer.IdOption
               INNER JOIN sites si ON si.idsite = of.idcustomer
               INNER JOIN customers cu ON si.IdCustomer = cu.IdCustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
                 INNER JOIN
             (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite
                    FROM customerpurchaseordersbyoffer po
                         INNER JOIN customerpurchaseorders p
                            ON p.idcustomerpurchaseorders =
                                  po.idcustomerpurchaseorder
                   WHERE YEAR(p.receivedin) = _accountingYear 
                GROUP BY idoffer
                  HAVING MIN(p.receivedin)) AS tmp
                  ON tmp.idoffer = of.idoffer
         WHERE     YEAR(
                      IFNULL(of.DeliveryDate,
                             concat(_accountingYear, '-01-01'))) =
                      _accountingYear
               AND of.idoffertype IN (1, 10) AND ss.IdSalesStatusType IN(4)
               AND si.IdCustomer NOT IN (8, 10)
               AND (of.IdCustomerToDelivery NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10) AND tmp.IdSite NOT IN
                                 (SELECT IdSite
                                    FROM sites
                                   WHERE IdCustomer = 10))
             
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                       (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      GROUP BY CurrentMonth,
               CurrentWeek,IdSite,IdCustomer,
               optoffer.IdOption,
               Status) As tmp2
      ORDER BY tmp2.CurrentMonth,
               tmp2.CurrentWeek,tmp2.IdSite,tmp2.IdCustomer,
               tmp2.IdOption,
               tmp2.Status;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GetSelectedUsersOfferQuantitySalesStatusByMonth;
CREATE PROCEDURE geos.`offers_GetSelectedUsersOfferQuantitySalesStatusByMonth`(
   IN _idcurrency       TINYINT(4) UNSIGNED,
   IN _idUser           varchar(2000),
   IN _accountingYear   int(10) UNSIGNED)
BEGIN
      SET @query =
             Concat(
                'Select * from (SELECT of.idcustomer AS IdSite,',
                ' si.IdCustomer AS IdCustomer,',
                ' Month(',
                ' IF(',
                ' po.Code IS NULL,',
                ' IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' po.ReceivedIn))',
                ' AS CurrentMonth,',
                ' Week(',
                ' IF(',
                ' po.Code IS NULL,',
                ' IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' po.ReceivedIn),',
                ' 3)',
                ' AS CurrentWeek,',
                ' UPPER(cu.Name) AS CustomerGroup,',
                ' replace(si.name, concat(\'(\', co.name, \')\'), \'\') AS CustomerPlant,',
                ' of.IdStatus AS OfferStatusId,',
                ' oft.Name AS OfferStatusName,',
                ' COUNT(*) AS NumberOfOffers,',
                ' optoffer.Quantity AS OfferQuantity,',
                ' optoffer.IdOption,',
                ' opt.Name AS OfferOption,',
                ' ss.IdSalesStatusType AS IdSalesStatusType,',
                ' ss.Name AS Status',
                ' FROM offers of',
                ' LEFT JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types ss',
                ' ON oft.IdSalesStatusType = ss.IdSalesStatusType',
                ' INNER JOIN optionsbyoffer optoffer',
                ' ON optoffer.IdOffer = of.IdOffer',
                ' INNER JOIN offeroptions opt',
                ' ON opt.idOfferOption = optoffer.IdOption',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                '  INNER JOIN customers cu ON si.IdCustomer = cu.IdCustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
               
                ' LEFT JOIN customerpurchaseordersbyoffer cpbo',
                ' ON cpbo.idoffer = of.idoffer',
                ' LEFT JOIN customerpurchaseorders po',
                ' ON po.idcustomerpurchaseorders = cpbo.idcustomerpurchaseorder',
                ' WHERE     YEAR(',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\'))) =',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10) AND ss.IdSalesStatusType NOT IN(4)',
                ' AND si.IdCustomer NOT IN (8, 10)',
              ' AND of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10)',
                ' AND (   (of.idstatus NOT IN (12) AND cpbo.IdOffer IS NULL)',
                ' OR (of.idstatus IN (4) AND NOT cpbo.IdOffer IS NULL))',
                ' AND (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY CurrentMonth,',
                ' CurrentWeek,',
                ' optoffer.IdOption,IdSite,IdCustomer,',
                ' Status UNION SELECT of.idcustomer AS IdSite,',
                ' si.IdCustomer AS IdCustomer,',
                ' Month(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn))',
                ' AS CurrentMonth,',
                ' Week(',
                ' IF(',
                ' tmp.Code IS NULL,',
                ' IFNULL(of.DeliveryDate, concat(',
                _accountingYear,
                ', \'-01-01\')),',
                ' tmp.ReceivedIn),',
                ' 3)',
                ' AS CurrentWeek,',
                ' UPPER(cu.Name) AS CustomerGroup,',
                ' replace(si.name, concat(\'(\', co.name, \')\'), \'\') AS CustomerPlant,',
                ' of.IdStatus AS OfferStatusId,',
                ' oft.Name AS OfferStatusName,',
                ' COUNT(*) AS NumberOfOffers,',
                ' optoffer.Quantity AS OfferQuantity,',
                ' optoffer.IdOption,',
                ' opt.Name AS OfferOption,',
                ' ss.IdSalesStatusType AS IdSalesStatusType,',
                ' ss.Name AS Status',
                ' FROM offers of',
                ' LEFT JOIN offerstatustypes oft',
                ' ON oft.idofferstatustype = of.idstatus',
                ' INNER JOIN sales_status_types ss',
                ' ON oft.IdSalesStatusType = ss.IdSalesStatusType',
                ' INNER JOIN optionsbyoffer optoffer',
                ' ON optoffer.IdOffer = of.IdOffer',
                ' INNER JOIN offeroptions opt',
                ' ON opt.idOfferOption = optoffer.IdOption',
                ' INNER JOIN sites si ON si.idsite = of.idcustomer',
                '  INNER JOIN customers cu ON si.IdCustomer = cu.IdCustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
               ' INNER JOIN',
                ' (  SELECT idoffer, p.code, p.ReceivedIn, p.IdSite',
                ' FROM customerpurchaseordersbyoffer po',
                ' INNER JOIN customerpurchaseorders p',
                ' ON p.idcustomerpurchaseorders =',
                ' po.idcustomerpurchaseorder',
                ' WHERE YEAR(p.receivedin) = ',
                _accountingYear,
               ' GROUP BY idoffer',
                ' HAVING MIN(p.receivedin)) AS tmp',
                ' ON tmp.idoffer = of.idoffer',
                ' WHERE     YEAR(',
                ' IFNULL(of.DeliveryDate,',
                ' concat(',
                _accountingYear,
                ', \'-01-01\'))) =',
                _accountingYear,
                ' AND of.idoffertype IN (1, 10)  AND ss.IdSalesStatusType IN(4)',
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND (of.IdCustomerToDelivery NOT IN (SELECT IdSite',
                ' FROM sites',
                ' WHERE IdCustomer = 10) AND tmp.IdSite NOT IN (SELECT IdSite FROM sites WHERE IdCustomer = 10))',
              
                ' AND (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY CurrentMonth,IdSite,IdCustomer,',
                ' CurrentWeek,',
                ' optoffer.IdOption,',
                ' Status) As tmp2',
                ' ORDER BY tmp2.CurrentMonth,',
                ' tmp2.CurrentWeek,',
                ' tmp2.IdOption,tmp2.IdSite,tmp2.IdCustomer,',
                '  tmp2.Status;');

              PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.offers_GeosOfferStatus;
CREATE PROCEDURE geos.`offers_GeosOfferStatus`()
BEGIN
 SELECT c2.IdOfferStatusType,c2.Name,c2.Position,c2.HtmlColor,c2.IdSalesStatusType,ss.Name AS SalesStatusType,ss.IdImage,ss.HtmlColor AS SalesStatusTypeHtmlColor
  FROM  offerstatustypes c2
  LEFT JOIN sales_status_types ss ON c2.IdSalesStatusType = ss.IdSalesStatusType GROUP BY c2.IdOfferStatusType ORDER BY c2.Position;
END;


DROP PROCEDURE IF EXISTS geos.customers_GetCompanyGroup;
CREATE PROCEDURE geos.`customers_GetCompanyGroup`(
   IN _idUser         smallint(5) UNSIGNED,
   IN _idZone         smallint(5) UNSIGNED,
   IN _idPermission   smallint(5) UNSIGNED)
BEGIN
        SELECT cu.IdCustomer, UPPER(cu.Name) As Name
          FROM sites si
               INNER JOIN customers cu ON cu.idcustomer = si.idcustomer
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone
         WHERE     cu.IdCustomer NOT IN (8, 10)
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      GROUP BY cu.IdCustomer
      ORDER BY cu.Name;
   END;


DROP PROCEDURE IF EXISTS geos.customers_GetSelectedUserCompanyGroup;
CREATE PROCEDURE geos.`customers_GetSelectedUserCompanyGroup`(
   IN _idUser varchar(2000))
BEGIN
      SET @query =
             concat(
                ' SELECT cu.IdCustomer, UPPER(cu.Name) As Name',
                ' FROM sites si',
                ' INNER JOIN customers cu ON cu.idcustomer = si.idcustomer',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' WHERE     cu.IdCustomer NOT IN (8, 10)',
                ' AND (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                ' OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' GROUP BY cu.IdCustomer',
                ' ORDER BY cu.Name;');
            PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetCompanyPlantByCustomerIdAndUserId;
CREATE PROCEDURE geos.`sites_GetCompanyPlantByCustomerIdAndUserId`(
   IN _idCustomer     smallint(5) UNSIGNED,
   IN _idUser         smallint(5) UNSIGNED,
   IN _idZone         smallint(5) UNSIGNED,
   IN _idPermission   smallint(5) UNSIGNED)
BEGIN
      SELECT si.IdSite,
             si.Name,
             replace(si.name, concat(' (', co.name, ')'), '') AS SiteName,
             si.IdSalesResponsible,
             si.IdSalesResponsibleAssemblyBU, co.idCountry,
               co.name AS Country,
               zo.IdZone,
               zo.Name AS Zone
          FROM sites si
               INNER JOIN countries co ON co.idcountry = si.idcountry
               INNER JOIN zones zo ON zo.idzone = co.idzone

         WHERE     si.IdCustomer = _idCustomer
               AND si.IdCustomer NOT IN (8, 10)
               AND CASE
                      WHEN _idPermission = 20
                      THEN
                         (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 21
                      THEN
                       (   si.idsalesresponsible IN (_idUser)
                          OR si.IdSalesResponsibleAssemblyBU IN (_idUser))
                      WHEN _idPermission = 22
                      THEN
                         TRUE
                      ELSE
                         FALSE
                   END
      ORDER BY si.Name;
   END;


DROP PROCEDURE IF EXISTS geos.sites_GetSelectedUserCompanyPlantByCustomerIdAndUserId;
CREATE PROCEDURE geos.`sites_GetSelectedUserCompanyPlantByCustomerIdAndUserId`(
   IN _idCustomer   smallint(5) UNSIGNED,
   IN _idUser       varchar(2000))
BEGIN
      SET @query =
             concat(
                ' SELECT si.IdSite,',
                ' si.Name,',
                ' replace(si.name, concat(\' (\', co.name, \')\'), \'\') AS SiteName,',
                ' si.IdSalesResponsible,',
                ' si.IdSalesResponsibleAssemblyBU,',
                ' co.idCountry,',
                ' co.name AS Country,',
                '  zo.IdZone,',
                ' zo.Name AS Zone',
                ' FROM sites si',
                ' INNER JOIN countries co ON co.idcountry = si.idcountry',
                ' INNER JOIN zones zo ON zo.idzone = co.idzone',
                ' WHERE     si.IdCustomer = ',
                _idCustomer,
                ' AND si.IdCustomer NOT IN (8, 10)',
                ' AND  (   si.idsalesresponsible IN (',
                _idUser,
                ')',
                '  OR si.IdSalesResponsibleAssemblyBU IN (',
                _idUser,
                '))',
                ' ORDER BY si.Name;');

         PREPARE stmt FROM @query      ;
       EXECUTE stmt      ;
       DEALLOCATE PREPARE stmt      ;
   END;
