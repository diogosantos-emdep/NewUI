using ChinhDo.Transactions;
using Emdep.Geos.Data.BusinessLogic.Logging;
using Emdep.Geos.Data.Common;
using Emdep.Geos.Data.Common.Epc;
using Emdep.Geos.Data.Common.OptimizedClass;
using Emdep.Geos.Utility;
using MySql.Data.MySqlClient;
using Prism.Logging;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Data;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Net.Mail;
using System.Text;
using System.Threading.Tasks;
using System.Transactions;

namespace Emdep.Geos.Data.BusinessLogic
{
    public class WarehouseManager
    {
        DataTable DataTableArticleDecompostion;
        bool isCheckedPosition = false;
        Int64 addedPosition = 0;


        public WarehouseManager()
        {
            try
            {
                if (Log4NetLogger.Logger == null)
                {
                    string ApplicationLogFilePath = System.Web.Hosting.HostingEnvironment.MapPath("/") + "log4net.config";
                    FileInfo file = new FileInfo(ApplicationLogFilePath);
                    Log4NetLogger.Logger = LoggerFactory.CreateLogger(LogType.Log4Net, file);
                }
            }
            catch
            {
                throw;
            }
        }

        /// <summary>
        ///  [WAREHOUSE-M026-06] Add pending po section && [WAREHOUSE-M027-03] Add PO schedule section.
        ///  1. View all-purchase orders  2. Partial Pending-View the once with 1 or more delivery notes 
        ///  3. All Pending-View the once with 0 delivery notes.
        ///  Not used after sprint 28 - replaced with this function GetPurchaseOrdersPendingReceptionByWarehouse.
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <returns>List of warehouse purchase order details</returns>
        public List<WarehousePurchaseOrder> GetPurchaseOrdersPendingReception(string connectionString)
        {
            List<WarehousePurchaseOrder> warehousePurchaseOrders = new List<WarehousePurchaseOrder>();

            using (MySqlConnection connPurchaseOrders = new MySqlConnection(connectionString))
            {
                connPurchaseOrders.Open();

                MySqlCommand poCommand = new MySqlCommand("warehouse_GetPurchaseOrdersPendingReception", connPurchaseOrders);
                poCommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader poReader = poCommand.ExecuteReader())
                {
                    double totalQuantity = 0;
                    double receivedQuantity = 0;

                    while (poReader.Read())
                    {
                        try
                        {
                            totalQuantity = 0;
                            receivedQuantity = 0;

                            WarehousePurchaseOrder warehousePurchaseOrder = new WarehousePurchaseOrder();

                            warehousePurchaseOrder.IdWarehousePurchaseOrder = Convert.ToInt64(poReader["idWarehousepurchaseorder"]);

                            if (poReader["Code"] != DBNull.Value)
                                warehousePurchaseOrder.Code = Convert.ToString(poReader["Code"]);

                            if (poReader["IdArticleSupplier"] != DBNull.Value)
                            {
                                ArticleSupplier articleSupplier = new ArticleSupplier();
                                articleSupplier.IdArticleSupplier = Convert.ToInt64(poReader["IdArticleSupplier"]);

                                if (poReader["Supplier"] != DBNull.Value)
                                    articleSupplier.Name = Convert.ToString(poReader["Supplier"]);

                                if (poReader["IdCountry"] != DBNull.Value)
                                {
                                    articleSupplier.IdCountry = Convert.ToInt64(poReader["IdCountry"]);
                                    articleSupplier.Country = new Country();
                                    articleSupplier.Country.IdCountry = Convert.ToByte(poReader["IdCountry"]);
                                    articleSupplier.Country.Name = Convert.ToString(poReader["CountryName"]);
                                }

                                warehousePurchaseOrder.ArticleSupplier = articleSupplier;
                            }

                            if (poReader["DeliveryDate"] != DBNull.Value && Convert.ToDateTime(poReader["deliveryDate"]) != DateTime.MinValue)
                            {
                                warehousePurchaseOrder.DeliveryDate = Convert.ToDateTime(poReader["deliveryDate"]);
                                warehousePurchaseOrder.Delay = (int)(warehousePurchaseOrder.DeliveryDate.Value.Date - DateTime.Now.Date).TotalDays;
                            }

                            if (poReader["AttachedPO"] != DBNull.Value)
                                warehousePurchaseOrder.AttachedPO = Convert.ToByte(poReader["AttachedPO"]);

                            if (poReader["Deliveries"] != DBNull.Value)
                            {
                                warehousePurchaseOrder.Deliveries = Convert.ToInt32(poReader["Deliveries"]);

                                if (warehousePurchaseOrder.Deliveries > 0)
                                {
                                    warehousePurchaseOrder.IsPartialPending = true;
                                }
                            }

                            if (poReader["LatestDeliveryDate"] != DBNull.Value)
                                warehousePurchaseOrder.LatestDeliveryDate = Convert.ToDateTime(poReader["LatestDeliveryDate"]);

                            if (poReader["OrderQty"] != DBNull.Value)
                                totalQuantity = Convert.ToDouble(poReader["OrderQty"]);

                            if (poReader["ReceivedQuantity"] != DBNull.Value)
                                receivedQuantity = Convert.ToDouble(poReader["ReceivedQuantity"]);

                            if (totalQuantity > 0)
                                warehousePurchaseOrder.Status = (Int16)((receivedQuantity / totalQuantity) * 100);

                            //warehousePurchaseOrder.WarehousePurchaseOrderItems = GetArticlesByIdWarehousePurchaseOrder(connectionString, warehousePurchaseOrder.IdWarehousePurchaseOrder);

                            //if (warehousePurchaseOrder.WarehousePurchaseOrderItems.Count > 0)
                            //{
                            //    double totalQuantity = warehousePurchaseOrder.WarehousePurchaseOrderItems.Sum(x => Convert.ToInt32(x.Quantity));
                            //    double receivedQuantity = warehousePurchaseOrder.WarehousePurchaseOrderItems.Sum(x => Convert.ToInt32(x.ReceivedQuantity));

                            //    if (totalQuantity > 0)
                            //        warehousePurchaseOrder.Status = (Int16)((receivedQuantity / totalQuantity) * 100);
                            //}

                            warehousePurchaseOrders.Add(warehousePurchaseOrder);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPurchaseOrdersPendingReception(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetPurchaseOrdersPendingReception().", category: Category.Info, priority: Priority.Low);
            return warehousePurchaseOrders;
        }

        public List<OrderProcessing> GetOrderInProcessing_V2051(Warehouses warehouse, string userProfileImageFilePath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OrderProcessing> orderProcessings = new List<OrderProcessing>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetOrderInProcessing_V2051", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OrderProcessing orderProcessing = new OrderProcessing();
                                if (reader["idoffer"] != DBNull.Value)
                                    orderProcessing.IdOffer = Convert.ToInt64(reader["idoffer"]);

                                if (reader["IsCritical"] != DBNull.Value)
                                    orderProcessing.IsCritical = Convert.ToByte(reader["IsCritical"]);

                                if (reader["IdStatus"] != DBNull.Value)
                                    orderProcessing.IdStatus = Convert.ToInt64(reader["IdStatus"]);

                                if (reader["StatusColor"] != DBNull.Value)
                                    orderProcessing.StatusColor = Convert.ToString(reader["StatusColor"]);

                                if (reader["code"] != DBNull.Value)
                                    orderProcessing.OfferCode = Convert.ToString(reader["code"]);

                                if (reader["Customer"] != DBNull.Value)
                                    orderProcessing.Customer = Convert.ToString(reader["Customer"]);

                                if (reader["PODate"] != DBNull.Value)
                                    orderProcessing.POReceivedDate = Convert.ToDateTime(Convert.ToDateTime(reader["PODate"]).ToString("yyyy-MM-dd"));

                                if (reader["Login"] != DBNull.Value)
                                {
                                    orderProcessing.AssignedLoginName = Convert.ToString(reader["Login"]);

                                    if (reader["IdUserGender"] != DBNull.Value)
                                        orderProcessing.IdUserGender = Convert.ToByte(reader["IdUserGender"]);

                                    if (reader["UserName"] != DBNull.Value)
                                        orderProcessing.UserName = Convert.ToString(reader["UserName"]);

                                    orderProcessing.AssignedToImageInBytes = GetUserProfileImageInBytes(orderProcessing.AssignedLoginName, userProfileImageFilePath);
                                }

                                if (reader["POCode"] != DBNull.Value)
                                    orderProcessing.POCode = Convert.ToString(reader["POCode"]);


                                orderProcessings.Add(orderProcessing);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetOrderInProcessing_V2051() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return orderProcessings;
        }

        /// <summary>
        /// [WAREHOUSE-M028-07] Load info by warehouse - Load PurchaseOrders PendingReception by warehouse 
        /// </summary>
        /// <param name="warehouseIds">The ids of warehouse.</param>
        /// <param name="warehouse">The warehouse for connection string</param>
        /// <returns>List of warehouse purchase order details</returns>
        public List<WarehousePurchaseOrder> GetPurchaseOrdersPendingReceptionByWarehouse(string warehouseIds, Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<WarehousePurchaseOrder> warehousePurchaseOrders = new List<WarehousePurchaseOrder>();

            using (MySqlConnection connPurchaseOrders = new MySqlConnection(connectionString))
            {
                connPurchaseOrders.Open();

                MySqlCommand poCommand = new MySqlCommand("warehouse_GetPurchaseOrdersPendingReceptionByWarehouse", connPurchaseOrders);
                poCommand.CommandType = CommandType.StoredProcedure;
                poCommand.Parameters.AddWithValue("_IdsWarehouse", warehouseIds);

                using (MySqlDataReader poReader = poCommand.ExecuteReader())
                {
                    double totalQuantity = 0;
                    double receivedQuantity = 0;

                    while (poReader.Read())
                    {
                        try
                        {
                            totalQuantity = 0;
                            receivedQuantity = 0;

                            WarehousePurchaseOrder warehousePurchaseOrder = new WarehousePurchaseOrder();

                            warehousePurchaseOrder.IdWarehousePurchaseOrder = Convert.ToInt64(poReader["idWarehousepurchaseorder"]);

                            if (poReader["Code"] != DBNull.Value)
                                warehousePurchaseOrder.Code = Convert.ToString(poReader["Code"]);

                            if (poReader["IdArticleSupplier"] != DBNull.Value)
                            {
                                ArticleSupplier articleSupplier = new ArticleSupplier();

                                articleSupplier.IdArticleSupplier = Convert.ToInt64(poReader["IdArticleSupplier"]);

                                if (poReader["Supplier"] != DBNull.Value)
                                    articleSupplier.Name = Convert.ToString(poReader["Supplier"]);

                                if (poReader["IdCountry"] != DBNull.Value)
                                {
                                    articleSupplier.IdCountry = Convert.ToInt64(poReader["IdCountry"]);

                                    articleSupplier.Country = new Country();
                                    articleSupplier.Country.IdCountry = Convert.ToByte(poReader["IdCountry"]);
                                    articleSupplier.Country.Name = Convert.ToString(poReader["CountryName"]);
                                }

                                warehousePurchaseOrder.ArticleSupplier = articleSupplier;
                            }

                            if (poReader["DeliveryDate"] != DBNull.Value && Convert.ToDateTime(poReader["deliveryDate"]) != DateTime.MinValue)
                            {
                                warehousePurchaseOrder.DeliveryDate = Convert.ToDateTime(poReader["deliveryDate"]);
                                warehousePurchaseOrder.Delay = (int)(warehousePurchaseOrder.DeliveryDate.Value.Date - DateTime.Now.Date).TotalDays;
                            }

                            if (poReader["AttachedPO"] != DBNull.Value)
                                warehousePurchaseOrder.AttachedPO = Convert.ToByte(poReader["AttachedPO"]);

                            if (poReader["Deliveries"] != DBNull.Value)
                            {
                                warehousePurchaseOrder.Deliveries = Convert.ToInt32(poReader["Deliveries"]);

                                if (warehousePurchaseOrder.Deliveries > 0)
                                {
                                    warehousePurchaseOrder.IsPartialPending = true;
                                }
                            }

                            if (poReader["LatestDeliveryDate"] != DBNull.Value)
                                warehousePurchaseOrder.LatestDeliveryDate = Convert.ToDateTime(poReader["LatestDeliveryDate"]);

                            if (poReader["IdWarehouse"] != DBNull.Value)
                                warehousePurchaseOrder.IdWarehouse = Convert.ToInt64(poReader["IdWarehouse"]);

                            if (poReader["OrderQty"] != DBNull.Value)
                                totalQuantity = Convert.ToDouble(poReader["OrderQty"]);

                            if (poReader["ReceivedQuantity"] != DBNull.Value)
                                receivedQuantity = Convert.ToDouble(poReader["ReceivedQuantity"]);

                            if (totalQuantity > 0)
                                warehousePurchaseOrder.Status = (Int16)((receivedQuantity / totalQuantity) * 100);

                            //warehousePurchaseOrder.WarehousePurchaseOrderItems = GetArticlesByIdWarehousePurchaseOrder(connectionString, warehousePurchaseOrder.IdWarehousePurchaseOrder);

                            //if (warehousePurchaseOrder.WarehousePurchaseOrderItems.Count > 0)
                            //{
                            //    double totalQuantity = warehousePurchaseOrder.WarehousePurchaseOrderItems.Sum(x => Convert.ToInt32(x.Quantity));
                            //    double receivedQuantity = warehousePurchaseOrder.WarehousePurchaseOrderItems.Sum(x => Convert.ToInt32(x.ReceivedQuantity));

                            //    if (totalQuantity > 0)
                            //        warehousePurchaseOrder.Status = (Int16)((receivedQuantity / totalQuantity) * 100);
                            //}

                            warehousePurchaseOrders.Add(warehousePurchaseOrder);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPurchaseOrdersPendingReception(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetPurchaseOrdersPendingReception().", category: Category.Info, priority: Priority.Low);
            return warehousePurchaseOrders;
        }

        /// <summary>
        /// [WAREHOUSE-M026-07] Add the PO information section
        /// Purchase Order Information - PO pending reception.
        /// </summary>
        /// <param name="connectionString">The connection string. (crm-context)</param>
        /// <param name="idWarehousePurchaseOrder">The idwarehousepurchseorder.</param>
        /// <returns>Warehouse purchase order details</returns>
        public WarehousePurchaseOrder GetPurchaseOrderPendingReceptionByIdWarehousePurchaseOrder(string connectionString, Int64 idWarehousePurchaseOrder, string purchaseOrdersPath)
        {
            WarehousePurchaseOrder warehousePurchaseOrder = null;

            using (MySqlConnection connPOPendingReception = new MySqlConnection(connectionString))
            {
                connPOPendingReception.Open();

                MySqlCommand activitiesCommand = new MySqlCommand("warehouse_GetPOPendingReceptionByIdWarehousePurchaseOrder", connPOPendingReception);
                activitiesCommand.CommandType = CommandType.StoredProcedure;
                activitiesCommand.Parameters.AddWithValue("_IdWarehousePurchaseOrder", idWarehousePurchaseOrder);

                using (MySqlDataReader poReader = activitiesCommand.ExecuteReader())
                {
                    if (poReader.Read())
                    {
                        try
                        {
                            warehousePurchaseOrder = new WarehousePurchaseOrder();

                            warehousePurchaseOrder.IdWarehousePurchaseOrder = idWarehousePurchaseOrder;

                            if (poReader["Code"] != DBNull.Value)
                                warehousePurchaseOrder.Code = Convert.ToString(poReader["Code"]);

                            if (poReader["IdArticleSupplier"] != DBNull.Value)
                            {
                                warehousePurchaseOrder.IdArticleSupplier = Convert.ToInt64(poReader["IdArticleSupplier"]);

                                ArticleSupplier articleSupplier = new ArticleSupplier();
                                articleSupplier.IdArticleSupplier = Convert.ToInt64(poReader["IdArticleSupplier"]);

                                if (poReader["Supplier"] != DBNull.Value)
                                    articleSupplier.Name = Convert.ToString(poReader["Supplier"]);

                                if (poReader["Serie"] != DBNull.Value)
                                    articleSupplier.Serie = Convert.ToChar(poReader["Serie"]);

                                if (poReader["IdCountry"] != DBNull.Value)
                                {
                                    articleSupplier.IdCountry = Convert.ToInt64(poReader["IdCountry"]);

                                    articleSupplier.Country = new Country();
                                    articleSupplier.Country.IdCountry = (byte)articleSupplier.IdCountry;
                                    articleSupplier.Country.Name = Convert.ToString(poReader["CountryName"]);

                                    if (poReader["IdCountryGroup"] != DBNull.Value)
                                        articleSupplier.Country.IdCountryGroup = Convert.ToInt64(poReader["IdCountryGroup"]);
                                }

                                if (poReader["IdArticleSupplierType"] != DBNull.Value)
                                {
                                    articleSupplier.IdArticleSupplierType = Convert.ToInt32(poReader["IdArticleSupplierType"]);

                                    articleSupplier.ArticleSupplierType = new ArticleSupplierType();
                                    articleSupplier.ArticleSupplierType.IdArticleSupplierType = Convert.ToInt32(poReader["IdArticleSupplierType"]);
                                    articleSupplier.ArticleSupplierType.Name = Convert.ToString(poReader["ArticleSupplierType"]);
                                    articleSupplier.ArticleSupplierType.HtmlColor = Convert.ToString(poReader["HtmlColor"]);
                                }

                                warehousePurchaseOrder.ArticleSupplier = articleSupplier;
                            }

                            if (poReader["DeliveryDate"] != DBNull.Value && Convert.ToDateTime(poReader["deliveryDate"]) != DateTime.MinValue)
                            {
                                warehousePurchaseOrder.DeliveryDate = Convert.ToDateTime(poReader["deliveryDate"]);
                            }

                            if (poReader["AttachedPO"] != DBNull.Value)
                                warehousePurchaseOrder.AttachedPO = Convert.ToByte(poReader["AttachedPO"]);

                            if (poReader["IdPaymentType"] != DBNull.Value)
                                warehousePurchaseOrder.IdPaymentType = Convert.ToInt64(poReader["IdPaymentType"]);

                            if (poReader["ReminderEmailDate"] != DBNull.Value)
                                warehousePurchaseOrder.ReminderEmailDate = Convert.ToDateTime(poReader["ReminderEmailDate"]);

                            if (poReader["CreatedIn"] != DBNull.Value)
                                warehousePurchaseOrder.CreatedIn = Convert.ToDateTime(poReader["CreatedIn"]);

                            if (poReader["ModifiedIn"] != DBNull.Value)
                                warehousePurchaseOrder.ModifiedIn = Convert.ToDateTime(poReader["ModifiedIn"]);

                            if (poReader["ModifiedIn"] != DBNull.Value)
                                warehousePurchaseOrder.ModifiedIn = Convert.ToDateTime(poReader["ModifiedIn"]);

                            if (poReader["Comments"] != DBNull.Value)
                                warehousePurchaseOrder.Comments = Convert.ToString(poReader["Comments"]);

                            if (poReader["IsClosed"] != DBNull.Value)
                                warehousePurchaseOrder.IsClosed = Convert.ToByte(poReader["IsClosed"]);

                            if (poReader["CreatedBy"] != DBNull.Value)
                                warehousePurchaseOrder.CreatedBy = Convert.ToInt64(poReader["CreatedBy"]);

                            if (poReader["ModifiedBy"] != DBNull.Value)
                                warehousePurchaseOrder.ModifiedBy = Convert.ToInt64(poReader["ModifiedBy"]);

                            if (poReader["ReasonClosed"] != DBNull.Value)
                                warehousePurchaseOrder.ReasonClosed = Convert.ToString(poReader["ReasonClosed"]);

                            if (poReader["IdWarehouse"] != DBNull.Value)
                                warehousePurchaseOrder.IdWarehouse = Convert.ToInt64(poReader["IdWarehouse"]);

                            if (poReader["IdCurrency"] != DBNull.Value)
                                warehousePurchaseOrder.IdCurrency = Convert.ToByte(poReader["IdCurrency"]);

                            warehousePurchaseOrder.WarehouseDeliveryNotes = GetDeliveryNotesByIdWarehousePurchaseOrder(connectionString, warehousePurchaseOrder, purchaseOrdersPath);

                            warehousePurchaseOrder.WarehousePurchaseOrderItems = GetArticlesByIdWarehousePurchaseOrder(connectionString, warehousePurchaseOrder.IdWarehousePurchaseOrder);

                            //if (poReader["namecurrency"] != DBNull.Value)
                            //    warehousePurchaseOrder.namecurrency = Convert.ToDateTime(poReader["namecurrency"]);

                            //if (poReader["currencySymbol"] != DBNull.Value)
                            //    warehousePurchaseOrder.currencySymbol = Convert.ToDateTime(poReader["currencySymbol"]);

                            //if (poReader["currencySymbol"] != DBNull.Value)
                            //    warehousePurchaseOrder.currencySymbol = Convert.ToDateTime(poReader["currencySymbol"]);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPurchaseOrdersPendingReception(idOT-{0}), ErrorMessage- {1} ", idWarehousePurchaseOrder, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetPurchaseOrdersPendingReception().", category: Category.Info, priority: Priority.Low);
            return warehousePurchaseOrder;
        }

        /// <summary>
        /// [WAREHOUSE-M026-07] Add the PO information section
        /// Get delivery notes by IdWarehousePurchaseOrder.
        /// </summary>
        /// <param name="connectionString">The connection strin CRM-Context.</param>
        /// <param name="idWarehousePurchaseOrder"></param>
        /// <returns>The idwarehousepurchseorder.</returns>
        public List<WarehouseDeliveryNote> GetDeliveryNotesByIdWarehousePurchaseOrder(string connectionString, WarehousePurchaseOrder warehousePurchaseOrder, string purchaseOrdersPath)
        {
            List<WarehouseDeliveryNote> warehouseDeliveryNotes = new List<WarehouseDeliveryNote>();

            using (MySqlConnection connActivities = new MySqlConnection(connectionString))
            {
                connActivities.Open();

                MySqlCommand activitiesCommand = new MySqlCommand("warehouse_GetDeliveryNotesByIdWarehousePurchaseOrder", connActivities);
                activitiesCommand.CommandType = CommandType.StoredProcedure;
                activitiesCommand.Parameters.AddWithValue("_IdWarehousePurchaseOrder", warehousePurchaseOrder.IdWarehousePurchaseOrder);

                using (MySqlDataReader poReader = activitiesCommand.ExecuteReader())
                {
                    while (poReader.Read())
                    {
                        try
                        {
                            WarehouseDeliveryNote warehouseDeliveryNote = new WarehouseDeliveryNote();

                            warehouseDeliveryNote.IdWarehousePurchaseOrder = warehousePurchaseOrder.IdWarehousePurchaseOrder;

                            if (poReader["Idwarehousedeliverynote"] != DBNull.Value)
                                warehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(poReader["Idwarehousedeliverynote"]);

                            if (poReader["Attacheddeliverynotes"] != DBNull.Value)
                                warehouseDeliveryNote.AttachedDeliveryNotes = Convert.ToByte(poReader["Attacheddeliverynotes"]);

                            if (poReader["IdCurrencyImportExpenses"] != DBNull.Value)
                                warehouseDeliveryNote.IdCurrencyImportExpenses = Convert.ToInt64(poReader["IdCurrencyImportExpenses"]);

                            if (poReader["ImportExpenses"] != DBNull.Value)
                                warehouseDeliveryNote.ImportExpenses = Convert.ToDouble(poReader["ImportExpenses"]);

                            if (poReader["Code"] != DBNull.Value)
                                warehouseDeliveryNote.Code = Convert.ToString(poReader["Code"]);

                            if (poReader["DeliveryDate"] != DBNull.Value)
                                warehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(poReader["DeliveryDate"]);

                            if (poReader["CreatedIn"] != DBNull.Value)
                                warehouseDeliveryNote.CreatedIn = Convert.ToDateTime(poReader["CreatedIn"]);

                            if (poReader["ModifiedIn"] != DBNull.Value)
                                warehouseDeliveryNote.ModifiedIn = Convert.ToDateTime(poReader["ModifiedIn"]);

                            if (poReader["SupplierCode"] != DBNull.Value)
                                warehouseDeliveryNote.SupplierCode = Convert.ToString(poReader["SupplierCode"]);

                            if (poReader["Idcurrency"] != DBNull.Value)
                                warehouseDeliveryNote.IdCurrency = Convert.ToByte(poReader["Idcurrency"]);

                            //if (poReader["LocalIdCurrency"] != DBNull.Value)
                            //    warehouseDeliveryNote.LocalIdCurrency = Convert.ToByte(poReader["LocalIdCurrency"]);

                            if (poReader["ExchangeRate"] != DBNull.Value)
                                warehouseDeliveryNote.ExchangeRate = Convert.ToByte(poReader["ExchangeRate"]);

                            if (poReader["ZF01"] != DBNull.Value)
                                warehouseDeliveryNote.ZF01 = Convert.ToString(poReader["ZF01"]);

                            if (poReader["CurrentlyAccessedBy"] != DBNull.Value)
                                warehouseDeliveryNote.CurrentlyAccessedBy = Convert.ToInt32(poReader["CurrentlyAccessedBy"]);

                            warehouseDeliveryNote.PdfFilePath = purchaseOrdersPath + @"\" + warehousePurchaseOrder.CreatedIn.Year + @"\" + warehousePurchaseOrder.Code + @"\02 Delivery Notes\DN_" + warehouseDeliveryNote.Code + ".pdf"; ;

                            warehouseDeliveryNotes.Add(warehouseDeliveryNote);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Executed GetDeliveryNotesByIdWarehousePurchaseOrder(idWarehousePurchaseOrder-{0}). ErrorMessage- {1}", warehousePurchaseOrder.IdWarehousePurchaseOrder, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetDeliveryNotesByIdWarehousePurchaseOrder().", category: Category.Info, priority: Priority.Low);
            return warehouseDeliveryNotes;
        }

        /// <summary>
        /// [WAREHOUSE-M026-07]
        /// Get articles by IdWarehousePurchaseOrder
        /// </summary>
        /// <param name="connectionString">The connection string.</param>
        /// <param name="idWarehousePurchaseOrder">The idwarehousepurchseorder.</param>
        /// <returns>The List WarehousePurchaseOrderItems</returns>
        public List<WarehousePurchaseOrderItem> GetArticlesByIdWarehousePurchaseOrder(string connectionString, Int64 idWarehousePurchaseOrder)
        {
            List<WarehousePurchaseOrderItem> warehousePurchaseOrderItems = new List<WarehousePurchaseOrderItem>();

            using (MySqlConnection connWarehousePurchaseOrderItem = new MySqlConnection(connectionString))
            {
                connWarehousePurchaseOrderItem.Open();

                MySqlCommand activitiesCommand = new MySqlCommand("warehouse_GetArticlesByIdWarehousePurchaseOrder", connWarehousePurchaseOrderItem);
                activitiesCommand.CommandType = CommandType.StoredProcedure;
                activitiesCommand.Parameters.AddWithValue("_IdWarehousePurchaseOrder", idWarehousePurchaseOrder);

                using (MySqlDataReader poReader = activitiesCommand.ExecuteReader())
                {
                    while (poReader.Read())
                    {
                        try
                        {
                            WarehousePurchaseOrderItem warehousePurchaseOrderItem = new WarehousePurchaseOrderItem();

                            warehousePurchaseOrderItem.IdWarehousePurchaseOrder = idWarehousePurchaseOrder;

                            if (poReader["IdWarehousePurchaseOrderItem"] != DBNull.Value)
                                warehousePurchaseOrderItem.IdWarehousePurchaseOrderItem = Convert.ToInt64(poReader["IdWarehousePurchaseOrderItem"]);

                            if (poReader["Description"] != DBNull.Value)
                                warehousePurchaseOrderItem.Description = Convert.ToString(poReader["Description"]);

                            if (poReader["IdArticle"] != DBNull.Value)
                            {
                                warehousePurchaseOrderItem.IdArticle = Convert.ToInt32(poReader["IdArticle"]);

                                Article article = new Article();

                                if (poReader["Reference"] != DBNull.Value)
                                    article.Reference = Convert.ToString(poReader["Reference"]);

                                if (poReader["IsGeneric"] != DBNull.Value)
                                    article.IsGeneric = Convert.ToSByte(poReader["IsGeneric"]);

                                if (poReader["IdArticleCategory"] != DBNull.Value)
                                    article.IdArticleCategory = Convert.ToInt32(poReader["IdArticleCategory"]);

                                warehousePurchaseOrderItem.Article = article;
                            }

                            if (poReader["Quantity"] != DBNull.Value)
                                warehousePurchaseOrderItem.Quantity = Convert.ToInt32(poReader["Quantity"]);

                            if (poReader["UnitPrice"] != DBNull.Value)
                                warehousePurchaseOrderItem.UnitPrice = Convert.ToDouble(poReader["UnitPrice"]);

                            if (poReader["Discount"] != DBNull.Value)
                                warehousePurchaseOrderItem.Discount = Convert.ToDouble(poReader["Discount"]);

                            if (poReader["Iva"] != DBNull.Value)
                                warehousePurchaseOrderItem.IVA = Convert.ToDouble(poReader["Iva"]);

                            if (poReader["AdditionalComments"] != DBNull.Value)
                                warehousePurchaseOrderItem.AdditionalComments = Convert.ToString(poReader["AdditionalComments"]);

                            if (poReader["Position"] != DBNull.Value)
                                warehousePurchaseOrderItem.Position = Convert.ToInt64(poReader["Position"]);

                            if (poReader["AlbaranQty"] != DBNull.Value)
                                warehousePurchaseOrderItem.ReceivedQuantity = Convert.ToInt32(poReader["AlbaranQty"]);

                            if (warehousePurchaseOrderItem.Quantity > 0)
                            {
                                warehousePurchaseOrderItem.Status = (Int32)(warehousePurchaseOrderItem.ReceivedQuantity / warehousePurchaseOrderItem.Quantity * 100);
                            }

                            warehousePurchaseOrderItem.WarehousePurchaseOrderExpectedItems = GetWarehousePOExpectedItems(connectionString, warehousePurchaseOrderItem.IdWarehousePurchaseOrderItem);

                            if (warehousePurchaseOrderItem.WarehousePurchaseOrderExpectedItems.Count > 0)
                            {
                                warehousePurchaseOrderItem.ExpectedDate = warehousePurchaseOrderItem.WarehousePurchaseOrderExpectedItems.First().Date;
                            }

                            warehousePurchaseOrderItem.ReceivedDeliveryNotes = GetDeliveryNotesByIdWarehousePurchaseOrderItem(connectionString, warehousePurchaseOrderItem.IdWarehousePurchaseOrderItem);
                            warehousePurchaseOrderItems.Add(warehousePurchaseOrderItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticlesByIdWarehousePurchaseOrder(idWarehousePurchaseOrder-{0}). ErrorMessage- {1}", idWarehousePurchaseOrder, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetArticlesByIdWarehousePurchaseOrder().", category: Category.Info, priority: Priority.Low);
            return warehousePurchaseOrderItems;
        }

        /// <summary>
        /// [WMS-M028-08] Changes in PO details section - Show POExpectedItems dates in grid.
        /// </summary>
        /// <param name="connectionString">The Connection string to PO - warehouse</param>
        /// <param name="idWarehousePurchaseOrderItem">The IdWarehousePurchaseOrderItem</param>
        /// <returns>List of warehouse purchase order expected item details</returns>
        public List<WarehousePurchaseOrderExpectedItem> GetWarehousePOExpectedItems(string connectionString, Int64 idWarehousePurchaseOrderItem)
        {
            List<WarehousePurchaseOrderExpectedItem> warehousePurchaseOrderExpectedItems = new List<WarehousePurchaseOrderExpectedItem>();

            using (MySqlConnection connWarehousePurchaseOrderItem = new MySqlConnection(connectionString))
            {
                connWarehousePurchaseOrderItem.Open();

                MySqlCommand activitiesCommand = new MySqlCommand("warehouse_GetWarehousePOExpectedItems", connWarehousePurchaseOrderItem);
                activitiesCommand.CommandType = CommandType.StoredProcedure;
                activitiesCommand.Parameters.AddWithValue("_idWarehousePurchaseOrderItem", idWarehousePurchaseOrderItem);

                using (MySqlDataReader poReader = activitiesCommand.ExecuteReader())
                {
                    while (poReader.Read())
                    {
                        try
                        {
                            WarehousePurchaseOrderExpectedItem warehousePurchaseOrderExpectedItem = new WarehousePurchaseOrderExpectedItem();

                            if (poReader["idWarehousePurchaseOrderItem"] != DBNull.Value)
                                warehousePurchaseOrderExpectedItem.IdWarehousePurchaseOrderItem = Convert.ToInt64(poReader["idWarehousePurchaseOrderItem"]);

                            if (poReader["Quantity"] != DBNull.Value)
                                warehousePurchaseOrderExpectedItem.Quantity = Convert.ToInt64(poReader["Quantity"]);

                            if (poReader["Date"] != DBNull.Value)
                                warehousePurchaseOrderExpectedItem.Date = Convert.ToDateTime(poReader["Date"]);

                            warehousePurchaseOrderExpectedItems.Add(warehousePurchaseOrderExpectedItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetWarehousePOExpectedItems(idWarehousePurchaseOrder-{0}). ErrorMessage- {1}", idWarehousePurchaseOrderItem, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetWarehousePOExpectedItems().", category: Category.Info, priority: Priority.Low);
            return warehousePurchaseOrderExpectedItems;
        }

        /// <summary>
        /// [WMS-M028-08] Changes in PO details section - Show delivery notes to perticuler PO item.
        /// </summary>
        /// <param name="connectionString">The Connection string to PO - warehouse</param>
        /// <param name="IdWarehousePurchaseOrderItem">The IdWarehousePurchaseOrderItem</param>
        /// <returns>List of warehouse delivery note details</returns>
        public List<WarehouseDeliveryNote> GetDeliveryNotesByIdWarehousePurchaseOrderItem(string connectionString, Int64 IdWarehousePurchaseOrderItem)
        {
            List<WarehouseDeliveryNote> warehouseDeliveryNotes = new List<WarehouseDeliveryNote>();

            using (MySqlConnection connActivities = new MySqlConnection(connectionString))
            {
                connActivities.Open();

                MySqlCommand activitiesCommand = new MySqlCommand("warehouse_GetDeliveryNotesByIdWarehousePOItem", connActivities);
                activitiesCommand.CommandType = CommandType.StoredProcedure;
                activitiesCommand.Parameters.AddWithValue("_IdWarehousePurchaseOrderItem", IdWarehousePurchaseOrderItem);

                using (MySqlDataReader poReader = activitiesCommand.ExecuteReader())
                {
                    while (poReader.Read())
                    {
                        try
                        {
                            WarehouseDeliveryNote warehouseDeliveryNote = new WarehouseDeliveryNote();

                            if (poReader["IdWarehousePurchaseOrder"] != DBNull.Value)
                                warehouseDeliveryNote.IdWarehousePurchaseOrder = Convert.ToInt64(poReader["IdWarehousePurchaseOrder"]);

                            if (poReader["IdWarehouseDeliveryNote"] != DBNull.Value)
                                warehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(poReader["IdWarehouseDeliveryNote"]);

                            if (poReader["Code"] != DBNull.Value)
                                warehouseDeliveryNote.Code = Convert.ToString(poReader["Code"]);

                            if (poReader["DeliveryDate"] != DBNull.Value)
                                warehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(poReader["DeliveryDate"]);

                            if (poReader["SupplierCode"] != DBNull.Value)
                                warehouseDeliveryNote.SupplierCode = Convert.ToString(poReader["SupplierCode"]);

                            if (poReader["Quantity"] != DBNull.Value)
                                warehouseDeliveryNote.Quantity = Convert.ToInt64(poReader["Quantity"]);

                            warehouseDeliveryNotes.Add(warehouseDeliveryNote);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Executed GetDeliveryNotesByIdWarehousePurchaseOrderItem(idWarehousePurchaseOrder-{0}). ErrorMessage- {1}", IdWarehousePurchaseOrderItem, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetDeliveryNotesByIdWarehousePurchaseOrderItem().", category: Category.Info, priority: Priority.Low);
            return warehouseDeliveryNotes;
        }

        /// <summary>
        /// [WAREHOUSE-M027-02] Add Pending Work Orders Section
        /// </summary>
        /// <param name="connectionString">The local plant connection string.</param>
        /// <param name="idTemplateType">The Id Template type.</param>
        /// <returns>The list of templates</returns>
        public List<Template> GetTemplatesByIdTemplateType(string connectionString, Int64 idTemplateType)
        {
            List<Template> templates = new List<Template>();

            using (MySqlConnection connTemplates = new MySqlConnection(connectionString))
            {
                connTemplates.Open();

                MySqlCommand templatesCommand = new MySqlCommand("templates_GetTemplatesByIdTemplateType", connTemplates);
                templatesCommand.CommandType = CommandType.StoredProcedure;
                templatesCommand.Parameters.AddWithValue("_IdTemplateType", idTemplateType);

                using (MySqlDataReader poReader = templatesCommand.ExecuteReader())
                {
                    while (poReader.Read())
                    {
                        try
                        {
                            Template template = new Template();

                            template.IdTemplate = Convert.ToByte(poReader["IdTemplate"]);
                            template.Name = Convert.ToString(poReader["Name"]);
                            template.Name_es = Convert.ToString(poReader["Name_es"]);
                            template.Name_fr = Convert.ToString(poReader["Name_fr"]);

                            if (poReader["Suffix"] != DBNull.Value)
                                template.Suffix = Convert.ToString(poReader["Suffix"]);

                            template.Type = Convert.ToInt64(poReader["Type"]);
                            template.Name_ro = Convert.ToString(poReader["Name_ro"]);
                            template.Name_zh = Convert.ToString(poReader["Name_zh"]);
                            template.Name_pt = Convert.ToString(poReader["Name_pt"]);
                            template.Name_ru = Convert.ToString(poReader["Name_ru"]);

                            if (poReader["HtmlColor"] != DBNull.Value)
                                template.HtmlColor = Convert.ToString(poReader["HtmlColor"]);

                            templates.Add(template);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Executed GetTemplatesByIdTemplateType(idTemplateType-{0}). ErrorMessage- {1}", idTemplateType, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetTemplatesByIdTemplateType().", category: Category.Info, priority: Priority.Low);
            return templates;
        }

        /// <summary>
        /// [WAREHOUSE-M027-02] Add Pending Work Orders Section && [WAREHOUSE-M024-05]	Add WO Schedule section
        /// Get pending material work orders.
        /// </summary>
        /// <param name="connectionString">The connection string.</param>
        /// <returns>The of pending material work orders.</returns>
        public List<Ots> GetPendingMaterialWorkOrders(string connectionString)
        {
            List<Ots> ots = new List<Ots>();

            using (MySqlConnection connOts = new MySqlConnection(connectionString))
            {
                connOts.Open();

                MySqlCommand otsCommand = new MySqlCommand("warehouse_GetPendingMaterialWorkOrders", connOts);
                otsCommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader otReader = otsCommand.ExecuteReader())
                {
                    if (otReader.HasRows)
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = new Ots();
                                ot.IdOT = Convert.ToInt64(otReader["IdOT"]);
                                ot.NumOT = Convert.ToByte(otReader["NumOT"]);

                                if (otReader["OtCode"] != DBNull.Value)
                                    ot.Code = Convert.ToString(otReader["OtCode"]);

                                if (otReader["DeliveryDate"] != DBNull.Value)
                                {
                                    ot.DeliveryDate = Convert.ToDateTime(otReader["DeliveryDate"]);
                                    ot.Delay = (int)(ot.DeliveryDate.Value.Date - DateTime.Now.Date).TotalDays;
                                }

                                ot.Quotation = new Quotation();
                                ot.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                                ot.Quotation.IdDetectionsTemplate = Convert.ToByte(otReader["IdTemplate"]);
                                ot.Quotation.Template = new Template();
                                ot.Quotation.Template.IdTemplate = ot.Quotation.IdDetectionsTemplate;
                                ot.Quotation.Template.Name = Convert.ToString(otReader["Template"]);
                                ot.Quotation.Template.IdTemplate = Convert.ToByte(otReader["TemplateType"]);

                                if (otReader["IdSite"] != DBNull.Value)
                                {
                                    ot.Quotation.IdCustomer = Convert.ToInt32(otReader["IdSite"]);
                                    ot.Quotation.Site = new Company();
                                    ot.Quotation.Site.IdCompany = ot.Quotation.IdCustomer;
                                    ot.Quotation.Site.SiteNameWithoutCountry = Convert.ToString(otReader["SiteName"]);

                                    if (otReader["ShortName"] != DBNull.Value && !string.IsNullOrEmpty(Convert.ToString(otReader["ShortName"])))
                                    {
                                        ot.Quotation.Site.Name = Convert.ToString(otReader["ShortName"]);
                                    }
                                    else
                                    {
                                        ot.Quotation.Site.Name = Convert.ToString(otReader["Customer"]);
                                    }

                                    ot.Quotation.Site.Customer = new Customer();
                                    ot.Quotation.Site.Customer.IdCustomer = Convert.ToInt32(otReader["IdCustomer"]);
                                    ot.Quotation.Site.Customer.CustomerName = Convert.ToString(otReader["CustomerName"]);

                                    if (otReader["IdCountry"] != DBNull.Value)
                                    {
                                        ot.Quotation.Site.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country = new Country();
                                        ot.Quotation.Site.Country.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country.Name = Convert.ToString(otReader["CountryName"]);
                                    }
                                }

                                if (otReader["ActualQty"] != DBNull.Value)
                                    ot.ActualQuantity = Convert.ToInt64(otReader["ActualQty"]);

                                if (otReader["PODate"] != DBNull.Value)
                                    ot.PoDate = Convert.ToDateTime(otReader["PODate"]);

                                ots.Add(ot);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrders() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    ot.DownloadedQuantity = Convert.ToInt64(otReader["DownloadedQty"]);
                                    ot.RemainingQuantity = ot.ActualQuantity + ot.DownloadedQuantity;

                                    if (ot.ActualQuantity > 0)
                                    {
                                        ot.Status = (Int16)((Math.Abs(ot.DownloadedQuantity) / ot.ActualQuantity) * 100);
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrders() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
            Log4NetLogger.Logger.Log("Executed GetPendingMaterialWorkOrders().", category: Category.Info, priority: Priority.Low);
            return ots;
        }

        /// <summary>
        /// [WAREHOUSE-M028-07] Load info by warehouse - Load pending PO by warehouse.
        /// </summary>
        /// <param name="warehouseIds">The Warehouse ids.</param>
        /// <param name="warehouse">The Warehouse which contains connection string.</param>
        /// <returns>The list of ots.</returns>
        public List<Ots> GetPendingMaterialWorkOrdersByWarehouse(string warehouseIds, Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<Ots> ots = new List<Ots>();

            using (MySqlConnection connOts = new MySqlConnection(connectionString))
            {
                connOts.Open();

                MySqlCommand otsCommand = new MySqlCommand("warehouse_GetPendingMaterialWorkOrdersByWarehouse", connOts);
                otsCommand.CommandType = CommandType.StoredProcedure;
                otsCommand.Parameters.AddWithValue("_IdsWarehouse", warehouseIds);
                otsCommand.CommandTimeout = 6000;

                using (MySqlDataReader otReader = otsCommand.ExecuteReader())
                {
                    if (otReader.HasRows)
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = new Ots();
                                ot.IdOT = Convert.ToInt64(otReader["IdOT"]);
                                ot.NumOT = Convert.ToByte(otReader["NumOT"]);

                                if (otReader["OtCode"] != DBNull.Value)
                                {
                                    ot.Code = Convert.ToString(otReader["OtCode"]);
                                    ot.MergeCode = Convert.ToString(otReader["MergeCode"]);
                                }

                                if (otReader["DeliveryDate"] != DBNull.Value)
                                {
                                    ot.DeliveryDate = Convert.ToDateTime(otReader["DeliveryDate"]);
                                    ot.Delay = (int)(ot.DeliveryDate.Value.Date - DateTime.Now.Date).TotalDays;
                                }

                                ot.Quotation = new Quotation();

                                if (otReader["IdQuotation"] != DBNull.Value)
                                {
                                    ot.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                                    ot.Quotation.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                                    ot.Quotation.Code = Convert.ToString(otReader["QuotationCode"]);
                                }

                                if (otReader["IdTemplate"] != DBNull.Value)
                                {
                                    ot.Quotation.IdDetectionsTemplate = Convert.ToByte(otReader["IdTemplate"]);

                                    ot.Quotation.Template = new Template();
                                    ot.Quotation.Template.IdTemplate = ot.Quotation.IdDetectionsTemplate;
                                    ot.Quotation.Template.Name = Convert.ToString(otReader["Template"]);
                                    ot.Quotation.Template.IdTemplate = Convert.ToByte(otReader["TemplateType"]);
                                }

                                if (otReader["IdOffer"] != DBNull.Value)
                                {
                                    ot.Quotation.IdOffer = Convert.ToInt64(otReader["IdOffer"]);
                                    ot.Quotation.Offer = new Offer();
                                    ot.Quotation.Offer.IdOffer = ot.Quotation.IdOffer;

                                    if (otReader["IsCritical"] != DBNull.Value)
                                        ot.Quotation.Offer.IsCritical = Convert.ToByte(otReader["IsCritical"]);

                                    if (otReader["IdStatus"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdStatus = Convert.ToInt64(otReader["IdStatus"]);
                                        ot.Quotation.Offer.GeosStatus = new GeosStatus();
                                        ot.Quotation.Offer.GeosStatus.IdOfferStatusType = Convert.ToInt64(otReader["IdStatus"]);
                                        ot.Quotation.Offer.GeosStatus.Name = Convert.ToString(otReader["OfferStatus"]);
                                        ot.Quotation.Offer.GeosStatus.HtmlColor = Convert.ToString(otReader["OfferStatusHtmlColor"]);

                                        if (otReader["IdSalesStatusType"] != DBNull.Value)
                                        {
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType = new SalesStatusType();
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.IdSalesStatusType = Convert.ToInt64(otReader["IdSalesStatusType"]);
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.Name = Convert.ToString(otReader["SalesStatusType"]);
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.HtmlColor = Convert.ToString(otReader["SalesStatusHtmlColor"]);
                                            if (otReader["SalesStatusIdImage"] != DBNull.Value)
                                                ot.Quotation.Offer.GeosStatus.SalesStatusType.IdImage = Convert.ToInt64(otReader["SalesStatusIdImage"]);
                                        }
                                    }

                                    ot.Quotation.Offer.Code = Convert.ToString(otReader["OfferCode"]);
                                    ot.Quotation.Offer.Description = Convert.ToString(otReader["Description"]);

                                    if (otReader["POCloseDate"] != DBNull.Value)
                                        ot.Quotation.Offer.DeliveryDate = Convert.ToDateTime(otReader["POCloseDate"]);

                                    if (otReader["IdOfferType"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdOfferType = Convert.ToByte(otReader["IdOfferType"]);

                                        ot.Quotation.Offer.OfferType = new OfferType();
                                        ot.Quotation.Offer.OfferType.IdOfferType = Convert.ToByte(ot.Quotation.Offer.IdOfferType);
                                        ot.Quotation.Offer.OfferType.Name = Convert.ToString(otReader["OfferType"]);

                                        //ot.MergeCode = ot.Quotation.Code + " " + ot.Quotation.Offer.OfferType.Name + " " + ot.NumOT;
                                    }

                                    if (otReader["IdCarriageMethod"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdCarriageMethod = Convert.ToByte(otReader["IdCarriageMethod"]);
                                        ot.Quotation.Offer.CarriageMethod = new LookupValue();
                                        ot.Quotation.Offer.CarriageMethod.IdLookupValue = Convert.ToByte(ot.Quotation.Offer.IdCarriageMethod);
                                        ot.Quotation.Offer.CarriageMethod.Value = Convert.ToString(otReader["CarriageMethod"]);

                                        if (otReader["CarriageImage"] != DBNull.Value)
                                            ot.Quotation.Offer.CarriageMethod.IdImage = Convert.ToInt64(otReader["CarriageImage"]);
                                    }
                                }

                                if (otReader["IdWarehouse"] != DBNull.Value)
                                {
                                    ot.Quotation.IdWarehouse = Convert.ToInt64(otReader["IdWarehouse"]);
                                }

                                if (otReader["IdSite"] != DBNull.Value)
                                {
                                    ot.Quotation.IdCustomer = Convert.ToInt32(otReader["IdSite"]);
                                    ot.Quotation.Site = new Company();
                                    ot.Quotation.Site.IdCompany = ot.Quotation.IdCustomer;
                                    ot.Quotation.Site.SiteNameWithoutCountry = Convert.ToString(otReader["SiteName"]);

                                    if (otReader["ShortName"] != DBNull.Value && !string.IsNullOrEmpty(Convert.ToString(otReader["ShortName"])))
                                    {
                                        ot.Quotation.Site.ShortName = Convert.ToString(otReader["ShortName"]);
                                        ot.Quotation.Site.Name = ot.Quotation.Site.ShortName;
                                    }
                                    else
                                    {
                                        ot.Quotation.Site.ShortName = null;
                                        ot.Quotation.Site.Name = Convert.ToString(otReader["SiteName"]);
                                    }

                                    ot.Quotation.Site.Customer = new Customer();
                                    ot.Quotation.Site.Customer.IdCustomer = Convert.ToInt32(otReader["IdCustomer"]);
                                    ot.Quotation.Site.Customer.CustomerName = Convert.ToString(otReader["CustomerName"]);

                                    if (otReader["IdCountry"] != DBNull.Value)
                                    {
                                        ot.Quotation.Site.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country = new Country();
                                        ot.Quotation.Site.Country.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country.Name = Convert.ToString(otReader["CountryName"]);
                                    }
                                }

                                if (otReader["ActualQty"] != DBNull.Value)
                                    ot.ActualQuantity = Convert.ToInt64(otReader["ActualQty"]);

                                if (otReader["DownloadedQty"] != DBNull.Value)
                                    ot.DownloadedQuantity = Convert.ToInt64(otReader["DownloadedQty"]);

                                if (otReader["PODate"] != DBNull.Value)
                                    ot.PoDate = Convert.ToDateTime(otReader["PODate"]);

                                if (otReader["ProducerCountryGroupName"] != DBNull.Value)
                                {
                                    ot.CountryGroup = new CountryGroup();
                                    ot.CountryGroup.Name = otReader["ProducerCountryGroupName"].ToString();
                                    if (otReader["ProducerCountryGroupHTMLColor"] != DBNull.Value)
                                        ot.CountryGroup.HtmlColor = otReader["ProducerCountryGroupHTMLColor"].ToString();
                                }


                                ot.RemainingQuantity = ot.ActualQuantity + ot.DownloadedQuantity;
                                if (ot.ActualQuantity > 0)
                                {
                                    ot.Status = (Int16)((Math.Abs(ot.DownloadedQuantity) / ot.ActualQuantity) * 100);
                                }
                                ot.OtItems = new List<OtItem>();
                                ots.Add(ot);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrders() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otItem = new OtItem();
                                    if (otReader["IdOT"] != DBNull.Value)
                                        otItem.IdOT = Convert.ToInt64(otReader["IdOT"]);
                                    if (otReader["IdOtItem"] != DBNull.Value)
                                        otItem.IdOTItem = Convert.ToInt64(otReader["IdOtItem"]);
                                    if (otReader["IdRevisionItem"] != DBNull.Value)
                                    {
                                        otItem.IdRevisionItem = Convert.ToInt64(otReader["IdRevisionItem"]);
                                        otItem.RevisionItem = new RevisionItem();
                                        otItem.RevisionItem.IdRevisionItem = Convert.ToInt64(otReader["IdRevisionItem"]);
                                        otItem.RevisionItem.Quantity = Convert.ToDecimal(otReader["Quantity"]);
                                        if (otReader["DownloadedQty"] != DBNull.Value)
                                            otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otReader["DownloadedQty"]);

                                        if (otReader["RemainingQty"] != DBNull.Value)
                                            otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otReader["RemainingQty"]);
                                    }
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    ot.OtItems.Add(otItem);
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrders() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }


                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(otReader["idotitem"])).FirstOrDefault();

                                    OtItem decomposed = new OtItem();
                                    if (otitem != null)
                                    {
                                        decomposed.IdOT = ot.IdOT;
                                        decomposed.IdOTItem = Convert.ToInt64(otReader["IdOtItem"]);

                                        if (otReader["idParent"] != DBNull.Value)
                                        {
                                            decomposed.ParentId = Convert.ToInt32(otReader["idParent"]);
                                        }
                                        decomposed.RevisionItem = new RevisionItem();
                                        decomposed.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                        decomposed.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otReader["IdWarehouseproduct"]);



                                        if (otReader["IdComponent"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otReader["IdComponent"]);
                                        }
                                        if (decomposed.ParentId == -1)
                                        {
                                            if (otReader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = otitem.RevisionItem.Quantity * Convert.ToDecimal(otReader["Quantity"]);
                                        }
                                        else
                                        {
                                            decimal qty = otitem.ArticleDecomposedList.First(x => x.RevisionItem.WarehouseProduct.IdComponent == decomposed.ParentId).RevisionItem.Quantity;
                                            if (otReader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = qty * Convert.ToDecimal(otReader["Quantity"]);
                                        }

                                        if (otReader["IdArticle"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otReader["IdArticle"]);
                                        }

                                        // int downloaded = GetOtItemDownloadedQuantity(connectionString, decomposed.RevisionItem.WarehouseProduct.IdArticle, decomposed.IdOTItem, decomposed.RevisionItem.WarehouseProduct.IdComponent, Convert.ToInt64(warehouseIds));


                                        decomposed.RevisionItem.DownloadedQuantity = 0;

                                        //  decomposed.RevisionItem.RemainingQuantity = ((Int64)decomposed.RevisionItem.Quantity - downloaded);




                                        otitem.ArticleDecomposedList.Add(decomposed);

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrders() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(otReader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(otReader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(otReader["idarticle"]) && i.RevisionItem.WarehouseProduct.IdComponent == Convert.ToInt64(otReader["idwarehouseproductcomponent"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (otReader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(otReader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrders() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(otReader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(otReader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(otReader["idarticle"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (otReader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(otReader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrders() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }




                    foreach (Ots itemOT in ots)
                    {
                        Int64 downloadedQty = 0;
                        decimal Qty = 0;
                        foreach (OtItem itemOtitem in itemOT.OtItems)
                        {
                            if (itemOtitem.ArticleDecomposedList.Count > 0)
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.DownloadedQuantity));
                                Qty = Qty + itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.Quantity);
                                // ot.Status = (Int16)((Math.Abs(ot.DownloadedQuantity) / ot.ActualQuantity) * 100);

                            }
                            else
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.RevisionItem.DownloadedQuantity);
                                Qty = Qty + itemOtitem.RevisionItem.Quantity;
                            }

                        }
                        if (Qty > 0)
                        {
                            itemOT.Status = (Int16)((Math.Abs(downloadedQty) / Qty) * 100);
                        }
                    }
                }
            }

            ots = ots.Where(x => x.Status < 100).ToList();
            Log4NetLogger.Logger.Log("Executed GetPendingMaterialWorkOrders().", category: Category.Info, priority: Priority.Low);
            return ots;
        }

        /// <summary>
        /// This method is to get all quotation of type sites
        /// </summary>
        /// <param name="idActiveUser">Get id user</param>
        /// <param name="idCurrency">Get id currency</param>
        /// <param name="accountingYearFrom">Get accounting year from</param>
        /// <param name="accountingYearTo">Get accounting year to</param>
        /// <param name="warehouse">Get warehouse details</param>
        /// <returns>List of quotation details</returns>
        public List<Quotation> GetAllQuotationsOfTypeSites(Int32 idActiveUser, byte idCurrency, DateTime? accountingYearFrom, DateTime? accountingYearTo, Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<Quotation> quotations = new List<Quotation>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("warehouse_GetAllQuotationsOfTypeSitesDateWise", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdActiveUser", idActiveUser);
                mySqlCommand.Parameters.AddWithValue("_IdCurrency", idCurrency);
                mySqlCommand.Parameters.AddWithValue("_AccountingYearFrom", accountingYearFrom);
                mySqlCommand.Parameters.AddWithValue("_AccountingYearTo", accountingYearTo);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                Quotation quotation = new Quotation();
                                quotation.IdQuotation = Convert.ToInt64(reader["IdQuotation"]);

                                if (reader["QuotationCode"] != DBNull.Value)
                                    quotation.Code = Convert.ToString(reader["QuotationCode"]);

                                if (reader["IdOffer"] != DBNull.Value)
                                {
                                    quotation.Offer = new Offer();

                                    quotation.Offer.IdOffer = Convert.ToInt64(reader["IdOffer"]);

                                    if (reader["OfferCode"] != DBNull.Value)
                                        quotation.Offer.Code = Convert.ToString(reader["OfferCode"]);

                                    if (reader["IsCritical"] != DBNull.Value)
                                        quotation.Offer.IsCritical = Convert.ToByte(reader["IsCritical"]);

                                    if (reader["OfferDeliveryDate"] != DBNull.Value)
                                        quotation.Offer.DeliveryDate = Convert.ToDateTime(reader["OfferDeliveryDate"]);

                                    if (reader["IdCarriageMethod"] != DBNull.Value)
                                    {
                                        quotation.Offer.IdCarriageMethod = Convert.ToByte(reader["IdCarriageMethod"]);
                                        quotation.Offer.CarriageMethod = new LookupValue();
                                        quotation.Offer.CarriageMethod.IdLookupValue = Convert.ToByte(quotation.Offer.IdCarriageMethod);
                                        quotation.Offer.CarriageMethod.Value = Convert.ToString(reader["CarriageMethod"]);

                                        if (reader["CarriageImage"] != DBNull.Value)
                                            quotation.Offer.CarriageMethod.IdImage = Convert.ToInt64(reader["CarriageImage"]);
                                    }

                                    quotation.IdDetectionsTemplate = Convert.ToByte(reader["IdTemplate"]);
                                    quotation.Template = new Template();
                                    quotation.Template.IdTemplate = quotation.IdDetectionsTemplate;
                                    quotation.Template.Name = Convert.ToString(reader["Template"]);

                                    if (reader["IdStatus"] != DBNull.Value)
                                    {
                                        quotation.Offer.IdStatus = Convert.ToInt64(reader["IdStatus"]);
                                    }

                                    if (reader["IdOfferStatusType"] != DBNull.Value)
                                    {
                                        quotation.Offer.IdStatus = Convert.ToByte(reader["IdOfferStatusType"]);

                                        quotation.Offer.GeosStatus = new GeosStatus();
                                        quotation.Offer.GeosStatus.IdOfferStatusType = quotation.Offer.IdStatus;
                                        quotation.Offer.GeosStatus.Name = Convert.ToString(reader["OfferStatus"]);
                                    }
                                }

                                if (reader["IdSite"] != DBNull.Value)
                                {
                                    quotation.IdCustomer = Convert.ToInt32(reader["IdSite"]);
                                    quotation.Site = new Company();
                                    quotation.Site.IdCompany = quotation.IdCustomer;
                                    quotation.Site.SiteNameWithoutCountry = Convert.ToString(reader["SiteNameWithoutCountry"]);

                                    if (reader["ShortName"] != DBNull.Value && !string.IsNullOrEmpty(Convert.ToString(reader["ShortName"])))
                                    {
                                        quotation.Site.Name = Convert.ToString(reader["ShortName"]);
                                    }
                                    else
                                    {
                                        quotation.Site.ShortName = null;
                                        quotation.Site.Name = Convert.ToString(reader["SiteNameWithCountry"]);
                                    }

                                    quotation.Site.Customer = new Customer();
                                    quotation.Site.Customer.IdCustomer = Convert.ToInt32(reader["IdCustomer"]);
                                    quotation.Site.Customer.CustomerName = Convert.ToString(reader["CustomerName"]);

                                    quotation.Site.ConnectPlantId = warehouse.Company.ConnectPlantId;
                                    quotation.Site.ConnectPlantConstr = warehouse.Company.ConnectPlantConstr;

                                    //if (otReader["IdCountry"] != DBNull.Value)
                                    //{
                                    //    quotation.Site.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                    //    quotation.Site.Country = new Country();
                                    //    quotation.Site.Country.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                    //    quotation.Site.Country.Name = Convert.ToString(otReader["CountryName"]);
                                    //}
                                }

                                if (reader["OfferDeliveryDate"] != DBNull.Value)
                                    quotation.Offer.DeliveryDate = Convert.ToDateTime(reader["OfferDeliveryDate"]);

                                quotations.Add(quotation);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetAllQuotationsOfTypeSites() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return quotations;
        }

        /// <summary>
        /// [WAREHOUSE-M027-04] Add the Work Order section information
        /// This method is used to show Workorder information by idot.
        /// </summary>
        /// <param name="connectionString">The current plant connection string.</param>
        /// <param name="idOt">The idOt</param>
        /// <param name="idWarehouse">The current plant id.</param>
        /// <returns>ots details</returns>
        public Ots GetWorkOrderByIdOt(Int64 idOt, Warehouses warehouse = null)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            Ots ot = null;

            using (MySqlConnection connOT = new MySqlConnection(connectionString))
            {
                connOT.Open();

                MySqlCommand otCommand = new MySqlCommand("warehouse_GetMaterialOtInformationByIdOt", connOT);
                otCommand.CommandType = CommandType.StoredProcedure;
                otCommand.Parameters.AddWithValue("_IdOt", idOt);

                using (MySqlDataReader otReader = otCommand.ExecuteReader())
                {
                    if (otReader.Read())
                    {
                        try
                        {
                            ot = new Ots();
                            ot.IdOT = idOt;

                            if (otReader["OtCode"] != DBNull.Value)
                                ot.Code = Convert.ToString(otReader["OtCode"]);

                            ot.NumOT = Convert.ToByte(otReader["NumOT"]);

                            if (otReader["Comments"] != DBNull.Value)
                                ot.Comments = Convert.ToString(otReader["Comments"]);

                            if (otReader["CreatedBy"] != DBNull.Value)
                            {
                                ot.CreatedBy = Convert.ToInt32(otReader["CreatedBy"]);

                                ot.CreatedByPerson = new People();
                                ot.CreatedByPerson.IdPerson = ot.CreatedBy;
                                ot.CreatedByPerson.Name = Convert.ToString(otReader["CreatedByName"]);
                                ot.CreatedByPerson.Surname = Convert.ToString(otReader["CreatedBySurname"]);
                            }

                            ot.ReviewedBy = Convert.ToInt32(otReader["ReviewedBy"]);

                            //CreatedBy
                            if (otReader["CreatedBy"] != DBNull.Value)
                            {
                                ot.CreatedBy = Convert.ToInt32(otReader["CreatedBy"]);

                                ot.CreatedByPerson = new People();
                                ot.CreatedByPerson.IdPerson = ot.CreatedBy;
                                ot.CreatedByPerson.Name = Convert.ToString(otReader["CreatedByName"]);
                                ot.CreatedByPerson.Surname = Convert.ToString(otReader["CreatedBySurname"]);
                            }

                            if (otReader["CreationDate"] != DBNull.Value)
                                ot.CreationDate = Convert.ToDateTime(otReader["CreationDate"]);

                            //ModifiedBy
                            if (otReader["ModifiedBy"] != DBNull.Value)
                            {
                                ot.ModifiedBy = Convert.ToInt32(otReader["ModifiedBy"]);

                                ot.ModifiedByPerson = new People();
                                ot.ModifiedByPerson.IdPerson = ot.ModifiedBy;
                                ot.ModifiedByPerson.Name = Convert.ToString(otReader["ModifiedByName"]);
                                ot.ModifiedByPerson.Surname = Convert.ToString(otReader["ModifiedBySurname"]);
                            }

                            if (otReader["ModifiedIn"] != DBNull.Value)
                                ot.ModifiedIn = Convert.ToDateTime(otReader["ModifiedIn"]);

                            if (otReader["DeliveryDate"] != DBNull.Value)
                                ot.DeliveryDate = Convert.ToDateTime(otReader["DeliveryDate"]);

                            if (otReader["WareHouseLockSession"] != DBNull.Value)
                                ot.WareHouseLockSession = Convert.ToString(otReader["WareHouseLockSession"]);

                            if (otReader["AttachedFiles"] != DBNull.Value)
                                ot.AttachedFiles = Convert.ToString(otReader["AttachedFiles"]);

                            if (otReader["IdShippingAddress"] != DBNull.Value)
                                ot.IdShippingAddress = Convert.ToInt64(otReader["IdShippingAddress"]);

                            ot.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                            ot.Quotation = new Quotation();
                            ot.Quotation.Code = Convert.ToString(otReader["QuotationCode"]);

                            if (otReader["Year"] != DBNull.Value)
                                ot.Quotation.Year = Convert.ToInt32(otReader["Year"]);

                            if (otReader["Description"] != DBNull.Value)
                                ot.Quotation.Description = Convert.ToString(otReader["Description"]);

                            if (otReader["ProjectName"] != DBNull.Value)
                                ot.Quotation.ProjectName = Convert.ToString(otReader["ProjectName"]);


                            if (otReader["ProjectName"] != DBNull.Value)
                                ot.Quotation.ProjectName = Convert.ToString(otReader["ProjectName"]);

                            //Customer
                            if (otReader["IdSite"] != DBNull.Value)
                            {
                                ot.Quotation.Site = new Company();
                                ot.Quotation.Site.IdCompany = Convert.ToInt32(otReader["IdSite"]);
                                ot.Quotation.Site.SiteNameWithoutCountry = Convert.ToString(otReader["SiteName"]);

                                if (otReader["ShortName"] != DBNull.Value && !string.IsNullOrEmpty(Convert.ToString(otReader["ShortName"])))
                                {
                                    ot.Quotation.Site.Name = Convert.ToString(otReader["ShortName"]);
                                }
                                else
                                {
                                    ot.Quotation.Site.Name = Convert.ToString(otReader["Customer"]);
                                }

                                if (otReader["idCountry"] != DBNull.Value)
                                {
                                    ot.Quotation.Site.IdCountry = Convert.ToByte(otReader["idCountry"]);
                                    ot.Quotation.Site.Country = new Country();
                                    ot.Quotation.Site.Country.IdCountry = Convert.ToByte(otReader["idCountry"]);
                                    ot.Quotation.Site.Country.Name = otReader["CountryName"].ToString();
                                    ot.Quotation.Site.Country.Iso = otReader["iso"].ToString();

                                    if (otReader["EuroZone"] != DBNull.Value)
                                    {
                                        ot.Quotation.Site.Country.EuroZone = Convert.ToSByte(otReader["EuroZone"]);
                                    }

                                    if (otReader["IdCountryGroup"] != DBNull.Value)
                                    {
                                        ot.Quotation.Site.CountryGroup = new CountryGroup();
                                        ot.Quotation.Site.CountryGroup.IdCountryGroup = Convert.ToInt64(otReader["IdCountryGroup"]);

                                        if (otReader["CountryGroup"] != DBNull.Value)
                                            ot.Quotation.Site.CountryGroup.Name = Convert.ToString(otReader["CountryGroup"]);

                                        if (otReader["IsFreeTrade"] != DBNull.Value)
                                            ot.Quotation.Site.CountryGroup.IsFreeTrade = Convert.ToByte(otReader["IsFreeTrade"]);
                                    }
                                }

                                ot.Quotation.Site.Customer = new Customer();
                                ot.Quotation.Site.Customer.IdCustomer = Convert.ToInt32(otReader["IdCustomer"]);
                                ot.Quotation.Site.Customer.CustomerName = Convert.ToString(otReader["CustomerName"]);
                            }

                            //Detections Template
                            if (otReader["IdTemplate"] != DBNull.Value)
                            {
                                ot.Quotation.Template = new Template();
                                ot.Quotation.Template.IdTemplate = Convert.ToByte(otReader["IdTemplate"]);
                                ot.Quotation.Template.Name = Convert.ToString(otReader["Template"]);
                                ot.Quotation.Template.Type = Convert.ToInt64(otReader["IdTemplateType"]);
                            }

                            if (otReader["IdOffer"] != DBNull.Value)
                            {
                                ot.Quotation.IdOffer = Convert.ToInt32(otReader["IdOffer"]);

                                ot.Quotation.Offer = new Offer();
                                //ot.Quotation.Offer.Code = Convert.ToString(otReader["OfferCode"]);
                                ot.Quotation.Offer.Description = Convert.ToString(otReader["Description"]);

                                if (otReader["IdCarriageMethod"] != DBNull.Value)
                                {
                                    ot.Quotation.Offer.IdCarriageMethod = Convert.ToByte(otReader["IdCarriageMethod"]);
                                    LookupValue carriage = new LookupValue();
                                    carriage.IdLookupValue = Convert.ToInt32(ot.Quotation.Offer.IdCarriageMethod);
                                    carriage.Value = Convert.ToString(otReader["CarriageValue"]);
                                    carriage.IdImage = Convert.ToInt64(otReader["CarriageImage"]);

                                    ot.Quotation.Offer.CarriageMethod = carriage;
                                }

                                if (otReader["PODate"] != DBNull.Value)
                                    ot.Quotation.Offer.POReceivedInDate = Convert.ToDateTime(otReader["PODate"]);

                                //if (otReader["IdOffer"] != DBNull.Value)
                                //{
                                //    ot.Quotation.Offer.OfferType = new OfferType();
                                //    ot.Quotation.Offer.OfferType.IdOfferType = Convert.ToByte(otReader["IdOfferType"]);
                                //    ot.Quotation.Offer.OfferType.Name = Convert.ToString(otReader["OfferType"]);
                                //}

                                if (otReader["ProducerIdCountryGroup"] != DBNull.Value)
                                {
                                    ot.ProducerIdCountryGroup = Convert.ToInt64(otReader["ProducerIdCountryGroup"]);
                                    ot.CountryGroup = new CountryGroup();
                                    ot.CountryGroup.IdCountryGroup = Convert.ToInt64(otReader["ProducerIdCountryGroup"]);
                                    ot.CountryGroup.Name = Convert.ToString(otReader["ProducerCountryGroup"]);
                                    ot.CountryGroup.HtmlColor = Convert.ToString(otReader["ProducerCountryGroupColor"]);
                                }

                            }
                            ot.OtItems = GetOtItemsByIdOt(connectionString, idOt, warehouse.IdWarehouse);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetWorkOrderByIdOt(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2} ", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetWorkOrderByIdOt().", category: Category.Info, priority: Priority.Low);
            return ot;
        }

        /// <summary>
        /// This method is used to show ot items by idot.
        /// </summary>
        /// <param name="connectionString">The connection string of server.</param>
        /// <param name="idOt">The idot.</param>
        /// <param name="idWarehouse">The connected plant id.</param>
        /// <returns>List of otitem details</returns>
        public List<OtItem> GetOtItemsByIdOt(string connectionString, Int64 idOt, Int64 idWarehouse)
        {
            List<OtItem> otItems = new List<OtItem>();

            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetOtItemsByIdOt", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOt", idOt);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    int keyId = 0;
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OtItem otItem = new OtItem();

                            otItem.KeyId = keyId;
                            otItem.ParentId = -1;

                            otItem.IdOT = idOt;

                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);
                            otItem.IsBatch = Convert.ToByte(otItemReader["IsBatch"]);

                            if (otItemReader["AttachedFiles"] != DBNull.Value)
                                otItem.AttachedFiles = Convert.ToString(otItemReader["AttachedFiles"]);

                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);
                                otItem.RevisionItem.Quantity = Convert.ToDecimal(otItemReader["Quantity"]);
                                otItem.RevisionItem.UnitPrice = Convert.ToDecimal(otItemReader["UnitPrice"]);

                                if (otItemReader["CustomerCommentOT"] != DBNull.Value)
                                    otItem.RevisionItem.InternalComment = Convert.ToString(otItemReader["CustomerCommentOT"]);

                                if (otItemReader["CustomerCommentRevision"] != DBNull.Value)
                                    otItem.RevisionItem.CustomerComment = Convert.ToString(otItemReader["CustomerCommentRevision"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);

                                if (otItemReader["WpDescription"] != DBNull.Value)
                                    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["ArticleDescription"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["ArticleDescription"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    if (otItemReader["Weight"] != DBNull.Value)
                                        article.Weight = Convert.ToDecimal(otItemReader["Weight"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);

                                    otItem.Status = new ItemOTStatusType();
                                    otItem.Status.IdItemOtStatus = otItem.IdItemOtStatus;
                                    otItem.Status.Name = Convert.ToString(otItemReader["Status"]);
                                }

                                if (otItemReader["AssignedTo"] != DBNull.Value)
                                {
                                    otItem.AssignedTo = Convert.ToInt32(otItemReader["AssignedTo"]);

                                    otItem.AssignedToUser = new People();
                                    otItem.AssignedToUser.Name = Convert.ToString(otItemReader["AssignedName"]);
                                    otItem.AssignedToUser.Surname = Convert.ToString(otItemReader["AssignedSurname"]);
                                }

                                if (otItemReader["DownloadedQty"] != DBNull.Value)
                                    otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otItemReader["DownloadedQty"]);

                                if (otItemReader["RemainingQty"] != DBNull.Value)
                                    otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otItemReader["RemainingQty"]);

                                if ((Int64)otItem.RevisionItem.Quantity > 0)
                                {
                                    //otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;
                                    otItem.RevisionItem.Status = (Int64)((Math.Abs((double)otItem.RevisionItem.DownloadedQuantity) / (double)otItem.RevisionItem.Quantity) * 100);
                                }
                            }



                            List<OtItem> decomposedOtItems = GetArticlesForDecomposition(connectionString, idOt, idWarehouse, otItem, ref keyId);

                            if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                            {
                                otItem.RevisionItem.Status = (Int64)((Math.Abs((double)decomposedOtItems.Sum(y => y.RevisionItem.DownloadedQuantity)) / (double)decomposedOtItems.Sum(y => y.RevisionItem.Quantity)) * 100);
                                otItems.Add(otItem);
                                otItems.AddRange(decomposedOtItems);
                            }
                            else
                            {
                                otItems.Add(otItem);
                            }



                            keyId++;

                            //i = otItem.KeyId + 1;
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetOtItemsByIdOt(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                    if (otItemReader.NextResult())
                    {
                        while (otItemReader.Read())
                        {
                            try
                            {
                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    foreach (var itemotItem in otItems.Where(ot => ot.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(otItemReader["IdArticle"])))
                                    {
                                        if (otItemReader["ArticleStock"] != DBNull.Value)
                                            itemotItem.ArticleStock = Convert.ToInt64(otItemReader["ArticleStock"]);

                                        if (otItemReader["ArticleMinimumStock"] != DBNull.Value)
                                            itemotItem.ArticleMinimumStock = Convert.ToInt64(otItemReader["ArticleMinimumStock"]);
                                    }
                                }

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetOtItemsByIdOt(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            //Log4NetLogger.Logger.Log("Executed GetOtItemsByIdOt().", category: Category.Info, priority: Priority.Low);
            return otItems;
        }

        /// <summary>
        /// This method is to get articles for decomposition details
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idOt">Get id ot</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="parentOtItem">Get parent otitem</param>
        /// <param name="keyId">Get key id</param>
        /// <returns>List of otitem details</returns>
        public List<OtItem> GetArticlesForDecomposition(string connectionString, Int64 idOt, Int64 idWarehouse, OtItem parentOtItem, ref int keyId)
        {
            List<OtItem> otItems = new List<OtItem>();

            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetArticlesForDecomposition", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOTitem", parentOtItem.IdOTItem);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

            
                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            keyId++;

                         
                            OtItem otItem = new OtItem();
                            otItem.IdOT = idOt;
                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);

                            if (otItemReader["IdItemOtStatus"] != DBNull.Value)
                                otItem.IdItemOtStatus = Convert.ToByte(otItemReader["IdItemOtStatus"]);


                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);



                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);

                               
                                if (otItemReader["IdComponent"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otItemReader["IdComponent"]);
                                }

                                otItem.KeyId = keyId;

                                if (otItemReader["idParent"] != DBNull.Value)
                                {
                                    otItem.ParentId = Convert.ToInt32(otItemReader["idParent"]);
                                }

                                if (otItem.ParentId == -1)
                                {
                                    otItem.ParentId = parentOtItem.KeyId;
                                    otItem.RevisionItem.Quantity = parentOtItem.RevisionItem.Quantity * Convert.ToDecimal(otItemReader["Quantity"]);
                                }
                                else
                                {


                                    decimal qty = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).RevisionItem.Quantity;
                                    otItem.RevisionItem.Quantity = qty * Convert.ToDecimal(otItemReader["Quantity"]);
                                    otItem.ParentId = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).KeyId;
                                }



                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["Description"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["Description"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Weight"] != DBNull.Value)
                                        article.Weight = Convert.ToDecimal(otItemReader["Weight"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);

                                }

                              
                                    int downloaded = GetOtItemDownloadedQuantity(connectionString, otItem.RevisionItem.WarehouseProduct.Article.IdArticle, otItem.IdOTItem, otItem.RevisionItem.WarehouseProduct.IdComponent, idWarehouse);


                                    otItem.RevisionItem.DownloadedQuantity = downloaded;

                                    otItem.RevisionItem.RemainingQuantity = ((Int64)otItem.RevisionItem.Quantity - downloaded);



                                    if ((Int64)otItem.RevisionItem.Quantity > 0)
                                        otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;
                              
                                    otItem.RevisionItem.RemainingQuantity =(Int64)otItem.RevisionItem.Quantity;
                               
                            }


                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticlesForDecomposition(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                    if (otItemReader.NextResult())
                    {
                        while (otItemReader.Read())
                        {
                            try
                            {
                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    foreach (var itemotItem in otItems.Where(ot => ot.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(otItemReader["IdArticle"])))
                                    {
                                        if (otItemReader["ArticleStock"] != DBNull.Value)
                                            itemotItem.ArticleStock = Convert.ToInt64(otItemReader["ArticleStock"]);

                                        if (otItemReader["ArticleMinimumStock"] != DBNull.Value)
                                            itemotItem.ArticleMinimumStock = Convert.ToInt64(otItemReader["ArticleMinimumStock"]);
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetArticlesForDecomposition(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                }
            }

            return otItems;
        }

        /// <summary>
        /// This method is to get otitem downloaded quantity
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idArticle">Get id article</param>
        /// <param name="idOtItem">Get id otitem</param>
        /// <param name="idWarehouseProductComponent">Get id warehouse product component</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <returns>otitem downloaded quantity</returns>
        internal int GetOtItemDownloadedQuantity(string connectionString, int idArticle, long idOtItem, long idWarehouseProductComponent, long idWarehouse)
        {

            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetOtItemDownloadedQuantity", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;

                int dwnd = 0;

                otItemCommand.Parameters.AddWithValue("_Downloaded", dwnd);
                otItemCommand.Parameters.AddWithValue("_IdArticle", idArticle);
                otItemCommand.Parameters.AddWithValue("_IdOTItem", idOtItem);
                otItemCommand.Parameters.AddWithValue("_IdWarehouseProductComponent", idWarehouseProductComponent);
                otItemCommand.Parameters["@_Downloaded"].Direction = ParameterDirection.Output;

                otItemCommand.ExecuteNonQuery();

                dwnd = Convert.ToInt32(otItemCommand.Parameters["@_Downloaded"].Value);

                return Math.Abs(dwnd);
            }



        }

        /// <summary>
        /// This function is used to get all pending articles.
        /// </summary>
        /// <param name="connectionString">The connection string.</param>
        /// <returns>The list of articles.</returns>
        public List<Article> GetPendingArticles(string connectionString, Int64 idWarehouse)
        {
            List<Article> articles = new List<Article>();

            using (MySqlConnection connArticles = new MySqlConnection(connectionString))
            {
                connArticles.Open();

                MySqlCommand articleCommand = new MySqlCommand("warehouse_GetPendingArticles", connArticles);
                articleCommand.CommandType = CommandType.StoredProcedure;
                articleCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader articleReader = articleCommand.ExecuteReader())
                {
                    while (articleReader.Read())
                    {
                        try
                        {
                            Article article = new Article();

                            if (articleReader["IdArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(articleReader["IdArticle"]);

                            if (articleReader["Reference"] != DBNull.Value)
                                article.Reference = Convert.ToString(articleReader["Reference"]);

                            WarehousePurchaseOrder warehousePO = new WarehousePurchaseOrder();

                            warehousePO.IdWarehousePurchaseOrder = Convert.ToInt64(articleReader["IdWarehousePurchaseOrder"]);

                            if (articleReader["PurchaseOrderCode"] != DBNull.Value)
                                warehousePO.Code = Convert.ToString(articleReader["PurchaseOrderCode"]);

                            if (articleReader["WO_DeliveryDate"] != DBNull.Value)
                                warehousePO.DeliveryDate = Convert.ToDateTime(articleReader["WO_DeliveryDate"]);

                            if (articleReader["WO_Supplier"] != DBNull.Value)
                            {
                                warehousePO.ArticleSupplier = new ArticleSupplier();
                                warehousePO.ArticleSupplier.Name = Convert.ToString(articleReader["WO_Supplier"]);
                            }

                            if (articleReader["RemainingQty"] != DBNull.Value)
                                article.Quantity = Convert.ToDouble(articleReader["RemainingQty"]);

                            if (articleReader["IdWarehouse"] != DBNull.Value)
                                warehousePO.IdWarehouse = Convert.ToInt64(articleReader["IdWarehouse"]);

                            article.WarehousePurchaseOrder = warehousePO;

                            articles.Add(article);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPendingArticles(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetPendingArticles().", category: Category.Info, priority: Priority.Low);
            return articles;
        }

        /// <summary>
        /// [WAREHOUSE-M028-07] Load info by warehouse.
        /// Load warehouses by active user assigned plants. 
        /// </summary>
        /// <param name="connectionString">The connection string.</param>
        /// <param name="idActiveUser">Th id of active user.</param>
        /// <returns>The list of warehouses.</returns>
        public List<Warehouses> GetAllWarehousesByUserPermission(string connectionString, Int32 idActiveUser)
        {
            List<Warehouses> warehouses = new List<Warehouses>();

            using (MySqlConnection connWarehouse = new MySqlConnection(connectionString))
            {
                connWarehouse.Open();

                MySqlCommand warehouseCommand = new MySqlCommand("warehouse_GetAllWarehousesByUserPermission", connWarehouse);
                warehouseCommand.CommandType = CommandType.StoredProcedure;
                warehouseCommand.Parameters.AddWithValue("_idUser", idActiveUser);

                using (MySqlDataReader warehouseReader = warehouseCommand.ExecuteReader())
                {
                    while (warehouseReader.Read())
                    {
                        try
                        {
                            Warehouses warehouse = new Warehouses();

                            if (warehouseReader["IdWarehouse"] != DBNull.Value)
                                warehouse.IdWarehouse = Convert.ToInt32(warehouseReader["IdWarehouse"]);

                            if (warehouseReader["Name"] != DBNull.Value)
                                warehouse.Name = Convert.ToString(warehouseReader["Name"]);

                            if (warehouseReader["IdSite"] != DBNull.Value)
                            {
                                string connstr = "Data Source = " + Convert.ToString(warehouseReader["DatabaseIP"]) + "; Database = geos; User ID = GeosUsr; Password = GEOS; Convert Zero Datetime=True";

                                warehouse.IdSite = Convert.ToInt32(warehouseReader["IdSite"]);

                                Company company = new Company();
                                company.IdCompany = Convert.ToInt32(warehouseReader["IdSite"]);
                                company.ConnectPlantConstr = connstr;
                                company.ConnectPlantId = Convert.ToString(company.IdCompany);

                                if (warehouseReader["SiteName"] != DBNull.Value)
                                    company.Name = Convert.ToString(warehouseReader["SiteName"]);

                                if (warehouseReader["ShortName"] != DBNull.Value)
                                {
                                    company.ShortName = Convert.ToString(warehouseReader["ShortName"]);
                                    company.Alias = company.ShortName;
                                }

                                warehouse.Company = company;
                            }

                            warehouses.Add(warehouse);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetAllWarehousesByUserPermission(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetAllWarehousesByUserPermission().", category: Category.Info, priority: Priority.Low);
            return warehouses;
        }

        /// <summary>
        ///  [WMS-M028-02] Add a new section DeliveryNotes in the PO - Show pdf on click.
        /// </summary>
        /// <param name="warehouseDeliveryNote">The Warehouse delivery notes.</param>
        /// <returns>pdf in bytes.</returns>
        public byte[] GetDeliveryNotePdf(WarehouseDeliveryNote warehouseDeliveryNote)
        {
            if (warehouseDeliveryNote != null)
            {
                byte[] bytes = null;

                string fileUploadPath = warehouseDeliveryNote.PdfFilePath;

                try
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(fileUploadPath, System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;

                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }

                    return bytes;
                }
                catch (FileNotFoundException ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error GetDeliveryNotePdf() WarehouseDeliveryNote-{0}. ErrorMessage- {1}", warehouseDeliveryNote.IdWarehouseDeliveryNote, ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }
                catch (DirectoryNotFoundException ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error GetDeliveryNotePdf() WarehouseDeliveryNote-{0}. ErrorMessage- {1}", warehouseDeliveryNote.IdWarehouseDeliveryNote, ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error GetDeliveryNotePdf() WarehouseDeliveryNote-{0}. ErrorMessage- {1}", warehouseDeliveryNote.IdWarehouseDeliveryNote, ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }
            }

            return null;
        }

        /// <summary>
        /// [WMS-M028-03] Add a new section Warehouse
        /// This method is used to Get warehouse articles Stock, MinStock, MaxStock by warehouse.
        /// </summary>
        /// <param name="warehouseIds">The warehouse ids</param>
        /// <param name="warehouse">The warehouse obj which contains connection string.</param>
        /// <returns>The List of Articles.</returns>
        public List<Article> GetWarehouseArticlesStockByWarehouse(string warehouseIds, Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<Article> articles = new List<Article>();

            using (MySqlConnection connArticle = new MySqlConnection(connectionString))
            {
                connArticle.Open();

                MySqlCommand articlesCommand = new MySqlCommand("warehouse_GetWarehouseArticlesStockByWarehouse", connArticle);
                articlesCommand.CommandType = CommandType.StoredProcedure;
                articlesCommand.Parameters.AddWithValue("_IdsWarehouse", warehouseIds);

                using (MySqlDataReader articleReader = articlesCommand.ExecuteReader())
                {
                    if (articleReader.HasRows)
                    {
                        while (articleReader.Read())
                        {
                            try
                            {
                                Article article = new Article();

                                if (articleReader["IdArticle"] != DBNull.Value)
                                    article.IdArticle = Convert.ToInt32(articleReader["IdArticle"]);

                                if (articleReader["Reference"] != DBNull.Value)
                                    article.Reference = Convert.ToString(articleReader["Reference"]);

                                if (articleReader["Description"] != DBNull.Value)
                                    article.Description = Convert.ToString(articleReader["Description"]);

                                if (articleReader["Length"] != DBNull.Value)
                                    article.Length = (float)articleReader["Length"];

                                if (articleReader["Width"] != DBNull.Value)
                                    article.Width = (float)articleReader["Width"];

                                if (articleReader["Height"] != DBNull.Value)
                                    article.Height = (float)articleReader["Height"];

                                if (articleReader["Weight"] != DBNull.Value)
                                    article.Weight = Convert.ToDecimal(articleReader["Weight"]);

                                if (articleReader["IdArticleCategory"] != DBNull.Value)
                                {
                                    article.IdArticleCategory = Convert.ToInt32(articleReader["IdArticleCategory"]);

                                    article.ArticleCategory = new ArticleCategory();
                                    article.ArticleCategory.IdArticleCategory = Convert.ToInt32(articleReader["IdArticleCategory"]);
                                    article.ArticleCategory.Name = articleReader["ArticleCategory"].ToString();
                                }

                                article.MyWarehouse = new MyWarehouse();

                                if (articleReader["Location"] != DBNull.Value)
                                    article.MyWarehouse.Location = Convert.ToString(articleReader["Location"]);

                                article.MyWarehouse.IdArticle = article.IdArticle;
                                article.MyWarehouse.CurrentStock = Convert.ToInt64(articleReader["Stock"]);
                                article.MyWarehouse.MinimumStock = Convert.ToInt64(articleReader["MinimumStock"]);
                                article.MyWarehouse.MaximumStock = Convert.ToInt64(articleReader["MaximumStock"]);

                                if (articleReader["IdWarehouse"] != DBNull.Value)
                                {
                                    article.MyWarehouse.IdWarehouse = Convert.ToInt64(articleReader["IdWarehouse"]);
                                    article.MyWarehouse.Warehouse = new Warehouses();
                                    article.MyWarehouse.Warehouse.IdWarehouse = article.MyWarehouse.IdWarehouse;
                                    article.MyWarehouse.Warehouse.Name = Convert.ToString(articleReader["WarehousName"]);
                                    article.MyWarehouse.Warehouse.IdSite = Convert.ToInt64(articleReader["IdSite"]);
                                }

                                articles.Add(article);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetWarehouseArticlesStockByWarehouse() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            //Log4NetLogger.Logger.Log("Executed GetWarehouseArticlesStockByWarehouse().", category: Category.Info, priority: Priority.Low);
            return articles;
        }

        /// <summary>
        /// [WMS-M029-09] Add Incoming Material section.
        /// Generate Delivery Note - Get all pending items and its Qty and remaining MaxQty. //string ArticleVisualAidsPath,
        /// </summary>
        /// <param name="connectionString">The Connection string.</param>
        /// <param name="warehousePurchaseOrder">The IdWarehouse purchase order.</param>
        /// <returns>The new delivery note.</returns>
        public WarehouseDeliveryNote GenerateDeliveryNote(string connectionString, string ArticleVisualAidsPath, WarehousePurchaseOrder warehousePurchaseOrder)
        {
            try
            {
                string emdepAlias = GetEmdepSiteAlias(connectionString, (Int64)warehousePurchaseOrder.IdWarehouse);
                int number = GetNextOrderNumber(connectionString, warehousePurchaseOrder.ArticleSupplier.Serie, emdepAlias);

                WarehouseDeliveryNote warehouseDeliveryNote = new WarehouseDeliveryNote();
                warehouseDeliveryNote.Code = warehousePurchaseOrder.ArticleSupplier.Serie + number.ToString("000000");

                warehouseDeliveryNote.WarehouseDeliveryNoteItems = GetPendingDeliveryNoteArticlesByIdWarehousePO(connectionString, ArticleVisualAidsPath, warehousePurchaseOrder);

                return warehouseDeliveryNote;
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GenerateDeliveryNote(idWarehousePurchaseOrder-{0}). ErrorMessage- {1}", warehousePurchaseOrder.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
        }

        /// <summary>
        /// Get emdep alias by idwarehouse. - [WMS-M029-09] Add Incoming Material section.
        /// </summary>
        /// <param name="connectionString">The Connection string.</param>
        /// <param name="idWarehouse">The IdWarehouse.</param>
        /// <returns>The alias of emdep site.</returns>
        public string GetEmdepSiteAlias(string connectionString, Int64 idWarehouse)
        {
            string EmdepSiteAlias = "";

            try
            {
                using (MySqlConnection myConn = new MySqlConnection(connectionString))
                {
                    myConn.Open();
                    MySqlCommand dNItemsCommand = new MySqlCommand("warehouse_GetEmdepSiteAliasByIdWarehouse", myConn);
                    dNItemsCommand.CommandType = CommandType.StoredProcedure;
                    dNItemsCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                    using (MySqlDataReader dNReader = dNItemsCommand.ExecuteReader())
                    {
                        if (dNReader.Read())
                        {
                            EmdepSiteAlias = Convert.ToString(dNReader["Alias"]);
                        }

                        dNReader.Close();
                        myConn.Close();
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetEmdepSiteAlias(idWarehouse-{0}). ErrorMessage- {1}", idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return EmdepSiteAlias;
        }

        /// <summary>
        /// The Next Order Number for Delivery Note. - [WMS-M029-09] Add Incoming Material section.
        /// </summary>
        /// <param name="connectionString">The connection string.</param>
        /// <param name="serie">The Serie Character from db.</param>
        /// <param name="emdepAlias">Emdep alias from GetEmdepSiteAlias method</param>
        /// <returns>The number for delivery note.</returns>
        public int GetNextOrderNumber(string connectionString, char serie, string emdepAlias)
        {
            int nextOrder = 0;
            int oldCode = 0;
            int newCode = 0;

            if (emdepAlias != null)
            {
                try
                {
                    String nextOrderStr = "";

                    using (MySqlConnection myConn = new MySqlConnection(connectionString))
                    {
                        myConn.Open();

                        MySqlCommand dNItemsCommand = new MySqlCommand("warehouse_GetNextOrderNumber", myConn);
                        dNItemsCommand.CommandType = CommandType.StoredProcedure;
                        dNItemsCommand.Parameters.AddWithValue("_Serie", serie);
                        dNItemsCommand.Parameters.AddWithValue("_EmdepAlias", emdepAlias);

                        using (MySqlDataReader dNReader = dNItemsCommand.ExecuteReader())
                        {
                            if (dNReader.Read())
                            {
                                if (dNReader["NewCode"] != DBNull.Value)
                                {
                                    newCode = Convert.ToInt32(dNReader["NewCode"]);
                                    nextOrder = newCode;
                                }
                                else if (dNReader["OldCode"] != DBNull.Value)
                                {
                                    oldCode = Convert.ToInt32(dNReader["OldCode"]);
                                    nextOrderStr = oldCode.ToString().Insert(2, emdepAlias);
                                    nextOrder = Convert.ToInt32(nextOrderStr);
                                }
                                else
                                {
                                    nextOrder = Convert.ToInt32(Convert.ToInt32(dNReader["CurrentYear"]) + emdepAlias + "0001");
                                }
                            }
                            else
                            {
                                nextOrder = Convert.ToInt32(Convert.ToInt32(dNReader["CurrentYear"]) + emdepAlias + "0001");
                            }

                            dNReader.Close();
                            myConn.Close();
                        }
                    }
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error GetNextOrderNumber(serie-{0}, emdepAlias-{1}). ErrorMessage- {2}", serie, emdepAlias, ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }
            }

            return nextOrder;
        }

        /// <summary>
        /// Get Pending Delivery Note Articles - [WMS-M029-09] Add Incoming Material section.
        /// </summary>
        /// <param name="connectionString">The Connection string.</param>
        /// <param name="warehousePurchaseOrder">The Warehouse Purchase Order </param>
        /// <returns>The list of warehouse delivery notes.</returns>
        public List<WarehouseDeliveryNoteItem> GetPendingDeliveryNoteArticlesByIdWarehousePO(string connectionString, string ArticleVisualAidsPath, WarehousePurchaseOrder warehousePurchaseOrder)
        {
            List<WarehouseDeliveryNoteItem> warehouseDeliveryNoteItems = new List<WarehouseDeliveryNoteItem>();

            using (MySqlConnection connWarehousePurchaseOrderItem = new MySqlConnection(connectionString))
            {
                connWarehousePurchaseOrderItem.Open();

                MySqlCommand dNItemsCommand = new MySqlCommand("warehouse_GetPendingDeliveryNoteArticlesByIdWarehousePO", connWarehousePurchaseOrderItem);
                dNItemsCommand.CommandType = CommandType.StoredProcedure;
                dNItemsCommand.Parameters.AddWithValue("_IdWarehousePurchaseOrder", warehousePurchaseOrder.IdWarehousePurchaseOrder);

                using (MySqlDataReader dNReader = dNItemsCommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        try
                        {
                            WarehouseDeliveryNoteItem warehouseDeliveryNoteItem = new WarehouseDeliveryNoteItem();

                            if (dNReader["IdWarehousePurchaseOrderItem"] != DBNull.Value)
                                warehouseDeliveryNoteItem.IdWarehousePurchaseOrderItem = Convert.ToInt64(dNReader["IdWarehousePurchaseOrderItem"]);

                            warehouseDeliveryNoteItem.WarehousePurchaseOrderItem = new WarehousePurchaseOrderItem();
                            warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.IdWarehousePurchaseOrderItem = warehouseDeliveryNoteItem.IdWarehousePurchaseOrderItem;

                            if (dNReader["IdArticle"] != DBNull.Value)
                            {
                                Article article = new Article();

                                if (dNReader["IdArticle"] != DBNull.Value)
                                    article.IdArticle = Convert.ToInt32(dNReader["IdArticle"]);

                                if (dNReader["Reference"] != DBNull.Value)
                                    article.Reference = Convert.ToString(dNReader["Reference"]);

                                if (dNReader["RegisterSerialNumber"] != DBNull.Value)
                                {
                                    article.RegisterSerialNumber = Convert.ToByte(dNReader["RegisterSerialNumber"]);

                                    if (article.RegisterSerialNumber == 1)
                                    {
                                        warehouseDeliveryNoteItem.SerialNumbers = new List<SerialNumber>();
                                    }
                                }

                                if (dNReader["ImagePath"] != DBNull.Value)
                                {
                                    article.ImagePath = Convert.ToString(dNReader["ImagePath"]);
                                    //ArticleVisualAidsPath
                                    article.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                                }

                                if (dNReader["SupplierReference"] != DBNull.Value)
                                {
                                    warehouseDeliveryNoteItem.ArticleBySupplier = new ArticleBySupplier();
                                    warehouseDeliveryNoteItem.ArticleBySupplier.Reference = Convert.ToString(dNReader["SupplierReference"]);
                                }

                                article.MyWarehouse = new MyWarehouse();

                                if (dNReader["CurrentStock"] != DBNull.Value)
                                    article.MyWarehouse.CurrentStock = Convert.ToInt64(dNReader["CurrentStock"]);

                                if (dNReader["MinimumStock"] != DBNull.Value)
                                    article.MyWarehouse.MinimumStock = Convert.ToInt64(dNReader["MinimumStock"]);

                                if (dNReader["MaximumStock"] != DBNull.Value)
                                    article.MyWarehouse.MaximumStock = Convert.ToInt64(dNReader["MaximumStock"]);

                                if (dNReader["ArticleLocation"] != DBNull.Value)
                                    article.MyWarehouse.Location = Convert.ToString(dNReader["ArticleLocation"]);

                                warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.Article = article;
                                warehouseDeliveryNoteItem.ManufacturersByArticle = GetManufacturersByIdArticle(connectionString, article.IdArticle, warehousePurchaseOrder);
                                warehouseDeliveryNoteItem.PrevDNIdManufacturerByArticle = GetPreviousManufacturerByIdWPOItem(connectionString, warehouseDeliveryNoteItem.IdWarehousePurchaseOrderItem);
                            }

                            if (dNReader["Description"] != DBNull.Value)
                                warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.Description = Convert.ToString(dNReader["Description"]);

                            if (dNReader["Quantity"] != DBNull.Value)
                                warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.Quantity = Convert.ToDouble(dNReader["Quantity"]);

                            if (dNReader["ReceivedQty"] != DBNull.Value)
                                warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.ReceivedQuantity = Convert.ToDouble(dNReader["ReceivedQty"]);

                            if (dNReader["MAXQty"] != DBNull.Value)
                                warehouseDeliveryNoteItem.MaxQuantity = Convert.ToInt32(dNReader["MAXQty"]);

                            warehouseDeliveryNoteItems.Add(warehouseDeliveryNoteItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPendingDeliveryNoteArticlesByIdWarehousePO(idWarehousePurchaseOrder-{0}). ErrorMessage- {1}", warehousePurchaseOrder.IdWarehousePurchaseOrder, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return warehouseDeliveryNoteItems;
        }

        /// <summary>
        /// This method is to get previous manufacturer related to id warehouse purchase order item
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idWarehousePurchaseOrderItem">Get id warehouse purchase order item</param>
        /// <returns>Get IdManufacturerByArticle</returns>
        private long? GetPreviousManufacturerByIdWPOItem(string connectionString, long idWarehousePurchaseOrderItem)
        {
            using (MySqlConnection connWarehousePurchaseOrderItem = new MySqlConnection(connectionString))
            {
                connWarehousePurchaseOrderItem.Open();

                MySqlCommand dNItemsCommand = new MySqlCommand("warehouse_GetWarehouseItemLatestDNProducer", connWarehousePurchaseOrderItem);
                dNItemsCommand.CommandType = CommandType.StoredProcedure;
                dNItemsCommand.Parameters.AddWithValue("_idWarehousePurchaseOrderItem", idWarehousePurchaseOrderItem);

                using (MySqlDataReader dNReader = dNItemsCommand.ExecuteReader())
                {
                    if (dNReader.Read())
                    {
                        try
                        {
                            if (dNReader["IdManufacturerByArticle"] != DBNull.Value)
                                return Convert.ToInt64(dNReader["IdManufacturerByArticle"]);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPreviousManufacturerByIdWPOItem(idWarehousePurchaseOrderItem-{0}). ErrorMessage- {1}", idWarehousePurchaseOrderItem, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return null;
        }

        /// <summary>
        /// This method is to get articles image in bytes
        /// </summary>
        /// <param name="ArticleVisualAidsPath">Get articles image path</param>
        /// <param name="article">Get articles details</param>
        /// <returns>Article image bytes</returns>
        public byte[] GetArticleImageInBytes(string ArticleVisualAidsPath, Article article)
        {
            if (!Directory.Exists(ArticleVisualAidsPath))
            {
                return null;
            }

            string fileUploadPath = ArticleVisualAidsPath + article.ImagePath;

            if (!File.Exists(fileUploadPath))
            {
                return null;
            }

            if (article != null && !string.IsNullOrEmpty(article.ImagePath))
            {

                byte[] bytes = null;

                try
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(fileUploadPath, System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;

                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }

                    return bytes;
                }
                //catch (FileNotFoundException ex)
                //{
                //    Log4NetLogger.Logger.Log(string.Format("Error GetDeliveryNotePdf() article ImagePath-{0}. ErrorMessage- {1}", article.ImagePath, ex.Message), category: Category.Exception, priority: Priority.Low);
                //    //throw;
                //}
                //catch (DirectoryNotFoundException ex)
                //{
                //    Log4NetLogger.Logger.Log(string.Format("Error GetDeliveryNotePdf() article ImagePath-{0}. ErrorMessage- {1}", article.ImagePath, ex.Message), category: Category.Exception, priority: Priority.Low);
                //    //throw;
                //}
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error GetDeliveryNotePdf() article ImagePath-{0}. ErrorMessage- {1}", article.ImagePath, ex.Message), category: Category.Exception, priority: Priority.Low);
                    //throw;
                }
            }

            return null;
        }

        /// <summary>
        /// Get list of Manufacturers By IdArticle - [WMS-M029-09] Add Incoming Material section.
        /// </summary>
        /// <param name="connectionString"></param>
        /// <param name="idArticle"></param>
        /// <returns>The list of ManufacturersByArticle</returns>
        public List<ManufacturersByArticle> GetManufacturersByIdArticle(string connectionString, Int32 idArticle, WarehousePurchaseOrder wpo)
        {
            List<ManufacturersByArticle> manufacturersByArticles = new List<ManufacturersByArticle>();

            ManufacturersByArticle manufacturersByArticleDefault = new ManufacturersByArticle();
            manufacturersByArticleDefault.Manufacturer = new Manufacturer();
            manufacturersByArticleDefault.Manufacturer.Name = "---";
            manufacturersByArticleDefault.ManufacturerWithCountry = "---";
            manufacturersByArticleDefault.IsSameCountryGroup = true;
            manufacturersByArticles.Add(manufacturersByArticleDefault);

            using (MySqlConnection connWarehousePurchaseOrderItem = new MySqlConnection(connectionString))
            {
                connWarehousePurchaseOrderItem.Open();

                MySqlCommand dNItemsCommand = new MySqlCommand("warehouse_GetManufacturersByIdArticle", connWarehousePurchaseOrderItem);
                dNItemsCommand.CommandType = CommandType.StoredProcedure;
                dNItemsCommand.Parameters.AddWithValue("_IdArticle", idArticle);

                using (MySqlDataReader dNReader = dNItemsCommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        try
                        {
                            ManufacturersByArticle manufacturersByArticle = new ManufacturersByArticle();

                            manufacturersByArticle.IdArticle = idArticle;

                            if (dNReader["IdManufacturerByArticle"] != DBNull.Value)
                                manufacturersByArticle.IdManufacturerByArticle = Convert.ToInt64(dNReader["IdManufacturerByArticle"]);

                            if (dNReader["IdManufacturer"] != DBNull.Value)
                            {
                                manufacturersByArticle.IdManufacturer = Convert.ToInt64(dNReader["IdManufacturer"]);
                                manufacturersByArticle.Manufacturer = new Manufacturer();
                                manufacturersByArticle.Manufacturer.IdManufacturer = manufacturersByArticle.IdManufacturer;
                                manufacturersByArticle.Manufacturer.Name = Convert.ToString(dNReader["ManufacturerName"]);
                            }

                            if (dNReader["idCountry"] != DBNull.Value)
                            {
                                manufacturersByArticle.IdCountry = Convert.ToInt64(dNReader["idCountry"]);

                                manufacturersByArticle.Country = new Country();
                                manufacturersByArticle.Country.IdCountry = Convert.ToByte(manufacturersByArticle.IdCountry);
                                manufacturersByArticle.Country.Name = Convert.ToString(dNReader["CountryName"]);
                                manufacturersByArticle.Country.Iso = Convert.ToString(dNReader["Iso"]);

                                if (dNReader["EuroZone"] != DBNull.Value)
                                    manufacturersByArticle.Country.EuroZone = Convert.ToSByte(dNReader["EuroZone"]);

                                if (dNReader["IdCountryGroup"] != DBNull.Value)
                                {
                                    manufacturersByArticle.CountryGroup = new CountryGroup();
                                    manufacturersByArticle.CountryGroup.IdCountryGroup = Convert.ToInt64(dNReader["IdCountryGroup"]);

                                    if (wpo != null && wpo.ArticleSupplier != null && wpo.ArticleSupplier.Country != null
                                        && wpo.ArticleSupplier.Country.IdCountryGroup != 0
                                        && wpo.ArticleSupplier.Country.IdCountryGroup == manufacturersByArticle.CountryGroup.IdCountryGroup)
                                    {
                                        manufacturersByArticle.IsSameCountryGroup = true;
                                    }

                                    if (dNReader["CountryGroup"] != DBNull.Value)
                                        manufacturersByArticle.CountryGroup.Name = Convert.ToString(dNReader["CountryGroup"]);

                                    manufacturersByArticle.CountryGroup.IsFreeTrade = Convert.ToByte(dNReader["IsFreeTrade"]);
                                }
                            }

                            if (manufacturersByArticle.Manufacturer != null && manufacturersByArticle.Country != null)
                                manufacturersByArticle.ManufacturerWithCountry = manufacturersByArticle.Manufacturer.Name + " | " + manufacturersByArticle.Country.Name;

                            manufacturersByArticles.Add(manufacturersByArticle);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetManufacturersByIdArticle(idArticle-{0}). ErrorMessage- {1}", idArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return manufacturersByArticles;
        }

        /// <summary>
        /// This method is to add warehouse delivery note details
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="PurchaseOrdersPath">Get purchase order path</param>
        /// <param name="warehouseDeliveryNote">Get warehouse delivery note details</param>
        /// <returns>Warehouse delivery note details</returns>
        public WarehouseDeliveryNote AddWarehouseDeliveryNote(string connectionString, string PurchaseOrdersPath, WarehouseDeliveryNote warehouseDeliveryNote)
        {
            TransactionScope transactionScope = null;

            using (transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection connWDN = new MySqlConnection(connectionString))
                    {
                        connWDN.Open();

                        MySqlCommand insertWDNCommand = new MySqlCommand("warehouse_InsertWarehouseDeliveryNote", connWDN);
                        insertWDNCommand.CommandType = CommandType.StoredProcedure;

                        insertWDNCommand.Parameters.AddWithValue("_Code", warehouseDeliveryNote.Code);
                        insertWDNCommand.Parameters.AddWithValue("_DeliveryDate", warehouseDeliveryNote.DeliveryDate);
                        insertWDNCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                        insertWDNCommand.Parameters.AddWithValue("_CreatedBy", warehouseDeliveryNote.CreatedBy);
                        insertWDNCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        insertWDNCommand.Parameters.AddWithValue("_ModifiedBy", warehouseDeliveryNote.ModifiedBy);
                        insertWDNCommand.Parameters.AddWithValue("_SupplierCode", warehouseDeliveryNote.SupplierCode == null ? "" : warehouseDeliveryNote.SupplierCode);
                        insertWDNCommand.Parameters.AddWithValue("_IdWarehousePurchaseOrder", warehouseDeliveryNote.IdWarehousePurchaseOrder);
                        insertWDNCommand.Parameters.AddWithValue("_ExchangeRate", warehouseDeliveryNote.ExchangeRate);
                        insertWDNCommand.Parameters.AddWithValue("_IdCurrency", warehouseDeliveryNote.IdCurrency);
                        insertWDNCommand.Parameters.AddWithValue("_CurrentlyAccessedBy", warehouseDeliveryNote.CurrentlyAccessedBy);
                        insertWDNCommand.Parameters.AddWithValue("_ZF01", warehouseDeliveryNote.ZF01);
                        insertWDNCommand.Parameters.AddWithValue("_ImportExpenses", warehouseDeliveryNote.ImportExpenses);
                        insertWDNCommand.Parameters.AddWithValue("_IdCurrencyImportExpenses", warehouseDeliveryNote.IdCurrencyImportExpenses);

                        warehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt32(insertWDNCommand.ExecuteScalar());

                        connWDN.Close();

                        if (warehouseDeliveryNote.IdWarehouseDeliveryNote > 0)
                        {
                            AddWarehouseDeliveryNoteItems(connectionString, warehouseDeliveryNote);

                            if (warehouseDeliveryNote.PdfFileInBytes != null)
                                SaveWarehouseDeliveryNote(PurchaseOrdersPath, warehouseDeliveryNote);
                        }

                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error AddWarehouseDeliveryNote(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return warehouseDeliveryNote;
        }

        /// <summary>
        /// This method to save warehouse delivery note details
        /// </summary>
        /// <param name="PurchaseOrdersPath">Get purchase order path</param>
        /// <param name="warehouseDeliveryNote">Warehouse delivery note details</param>
        /// <returns>If true saved warehouse delivery note details otherwise false</returns>
        public bool SaveWarehouseDeliveryNote(string PurchaseOrdersPath, WarehouseDeliveryNote warehouseDeliveryNote)
        {
            if (warehouseDeliveryNote.WarehousePurchaseOrder != null)
            {
                try
                {
                    string path = PurchaseOrdersPath + "\\" + warehouseDeliveryNote.WarehousePurchaseOrder.CreatedIn.Year + "\\" + warehouseDeliveryNote.WarehousePurchaseOrder.Code + @"\02 Delivery Notes\";

                    if (!Directory.Exists(path))
                    {
                        Directory.CreateDirectory(path);
                    }

                    string pdfFile = path + @"DN_" + warehouseDeliveryNote.Code + ".pdf";

                    File.WriteAllBytes(pdfFile, warehouseDeliveryNote.PdfFileInBytes);
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error SaveWarehouseDeliveryNote()-Code - {0}. ErrorMessage- {1}", warehouseDeliveryNote.Code, ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }
            }

            return true;
        }

        /// <summary>
        /// The Warehouse delivery note items.
        /// </summary>
        /// <param name="connectionString">The Connection string.</param>
        /// <param name="warehouseDeliveryNote">The warehouse delivery note items.</param>
        /// <returns>True if added items else false.</returns>
        public bool AddWarehouseDeliveryNoteItems(string connectionString, WarehouseDeliveryNote warehouseDeliveryNote)
        {
            bool IsInserted = false;

            if (warehouseDeliveryNote.WarehouseDeliveryNoteItems != null)
            {
                foreach (WarehouseDeliveryNoteItem item in warehouseDeliveryNote.WarehouseDeliveryNoteItems)
                {
                    if (item.IdManufacturerByArticle == 0 && item.Producer.IsNew)
                    {
                        item.Producer.IdArticle = item.WarehousePurchaseOrderItem.Article.IdArticle;

                        AddManufacturerByArticle(connectionString, item.Producer);
                    }

                    using (MySqlConnection connWDNI = new MySqlConnection(connectionString))
                    {
                        connWDNI.Open();

                        try
                        {
                            MySqlCommand conWDNICommand = new MySqlCommand("warehouse_InsertWarehouseDeliveryNoteItem", connWDNI);
                            conWDNICommand.CommandType = CommandType.StoredProcedure;

                            conWDNICommand.Parameters.AddWithValue("_IdWarehousePurchaseOrderItem", item.IdWarehousePurchaseOrderItem);
                            conWDNICommand.Parameters.AddWithValue("_Quantity", item.Quantity);
                            conWDNICommand.Parameters.AddWithValue("_CustomsDuty", item.CustomsDuty);
                            conWDNICommand.Parameters.AddWithValue("_IdWarehouseDeliveryNote", warehouseDeliveryNote.IdWarehouseDeliveryNote);
                            conWDNICommand.Parameters.AddWithValue("_Uploaded", item.Uploaded);

                            if (item.IdManufacturerByArticle > 0)
                            {
                                conWDNICommand.Parameters.AddWithValue("_IdManufacturerByArticle", item.IdManufacturerByArticle);
                            }
                            else if (item.Producer != null)
                            {
                                conWDNICommand.Parameters.AddWithValue("_IdManufacturerByArticle", item.Producer.IdManufacturerByArticle);
                            }
                            else
                            {
                                conWDNICommand.Parameters.AddWithValue("_IdManufacturerByArticle", 0);
                            }

                            item.IdWarehouseDeliveryNoteItem = Convert.ToInt32(conWDNICommand.ExecuteScalar());

                            if (item.IdWarehouseDeliveryNoteItem > 0)
                            {
                                IsInserted = true;

                                if (item.WarehousePurchaseOrderItem.Article.RegisterSerialNumber == 1
                                    && item.SerialNumbers != null && item.SerialNumbers.Count > 0)
                                {
                                    AddSerialNumbers(connectionString, item);
                                }
                            }

                            connWDNI.Close();
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error AddWarehouseDeliveryNoteItems(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }

            }
            return IsInserted;
        }

        /// <summary>
        /// When user add new producer for Article then this method is called.
        /// </summary>
        /// <param name="connectionString">The Connection string</param>
        /// <param name="newProducer">The New Producer.</param>
        /// <returns>ManufacturersByArticle details</returns>
        public ManufacturersByArticle AddManufacturerByArticle(string connectionString, ManufacturersByArticle newProducer)
        {
            using (MySqlConnection connProducer = new MySqlConnection(connectionString))
            {
                connProducer.Open();

                try
                {
                    MySqlCommand connProducerCommand = new MySqlCommand("warehouse_InsertManufacturersByIdArticle", connProducer);
                    connProducerCommand.CommandType = CommandType.StoredProcedure;

                    connProducerCommand.Parameters.AddWithValue("_ManufacturerName", newProducer.Manufacturer.Name);
                    connProducerCommand.Parameters.AddWithValue("_IdArticle", newProducer.IdArticle);
                    connProducerCommand.Parameters.AddWithValue("_IdCountry", newProducer.IdCountry);

                    using (MySqlDataReader dNReader = connProducerCommand.ExecuteReader())
                    {
                        if (dNReader.HasRows)
                        {
                            while (dNReader.Read())
                            {
                                newProducer.IdArticle = newProducer.IdArticle;

                                if (dNReader["IdManufacturerByArticle"] != DBNull.Value)
                                    newProducer.IdManufacturerByArticle = Convert.ToInt64(dNReader["IdManufacturerByArticle"]);

                                if (dNReader["IdManufacturer"] != DBNull.Value)
                                {
                                    newProducer.IdManufacturer = Convert.ToInt64(dNReader["IdManufacturer"]);
                                    newProducer.Manufacturer = new Manufacturer();
                                    newProducer.Manufacturer.IdManufacturer = newProducer.IdManufacturer;
                                    newProducer.Manufacturer.Name = Convert.ToString(dNReader["ManufacturerName"]);
                                }

                                if (dNReader["idCountry"] != DBNull.Value)
                                {
                                    newProducer.IdCountry = Convert.ToInt64(dNReader["idCountry"]);

                                    newProducer.Country = new Country();
                                    newProducer.Country.IdCountry = Convert.ToByte(newProducer.IdCountry);
                                    newProducer.Country.Name = Convert.ToString(dNReader["CountryName"]);

                                    if (dNReader["EuroZone"] != DBNull.Value)
                                        newProducer.Country.EuroZone = Convert.ToSByte(dNReader["EuroZone"]);
                                }
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error AddManufacturerByArticle() Name - {0}. ErrorMessage- {1}", newProducer.Manufacturer.Name, ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }

                connProducer.Close();
            }

            return newProducer;
        }

        /// <summary>
        /// This method is used to save SerialNumbers for Article.
        /// </summary>
        /// <param name="connectionString">The Connection string.</param>
        /// <param name="warehouseDeliveryNoteItem">The Warehouse delivery note.</param>
        /// <returns>True if inserted serial number else false.</returns>
        public bool AddSerialNumbers(string connectionString, WarehouseDeliveryNoteItem warehouseDeliveryNoteItem)
        {
            foreach (SerialNumber serialNumber in warehouseDeliveryNoteItem.SerialNumbers)
            {
                using (MySqlConnection connSerialNumber = new MySqlConnection(connectionString))
                {
                    connSerialNumber.Open();

                    try
                    {
                        MySqlCommand serialNumberCommand = new MySqlCommand("warehouse_InsertSerialNumber", connSerialNumber);
                        serialNumberCommand.CommandType = CommandType.StoredProcedure;

                        serialNumberCommand.Parameters.AddWithValue("_Code", serialNumber.Code);
                        serialNumberCommand.Parameters.AddWithValue("_ExtraCode", serialNumber.ExtraCode);
                        serialNumberCommand.Parameters.AddWithValue("_IdWarehouseDeliveryNoteItem", warehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem);
                        serialNumberCommand.Parameters.AddWithValue("_IdWarehouseProduct", serialNumber.IdWarehouseProduct);
                        serialNumberCommand.Parameters.AddWithValue("_IdArticle", serialNumber.IdArticle);

                        serialNumber.IdSerialNumber = Convert.ToInt32(serialNumberCommand.ExecuteScalar());
                        connSerialNumber.Close();
                    }
                    catch (Exception ex)
                    {
                        Log4NetLogger.Logger.Log(string.Format("Error AddSerialNumbers(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                        throw;
                    }
                }
            }
            return true;
        }

        /// <summary>
        /// This method is to get all countries
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <returns>List of countries details</returns>
        public List<Country> GetAllCountries(string connectionString)
        {
            List<Country> countries = new List<Country>();

            using (MySqlConnection conCountry = new MySqlConnection(connectionString))
            {
                conCountry.Open();
                MySqlCommand conCountrycommand = new MySqlCommand("countries_GetAllCountries", conCountry);
                conCountrycommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader countryReader = conCountrycommand.ExecuteReader())
                {
                    while (countryReader.Read())
                    {
                        Country country = new Country();
                        country.IdCountry = Convert.ToByte(countryReader["IdCountry"]);
                        country.Name = Convert.ToString(countryReader["Name"]);
                        country.EuroZone = Convert.ToSByte(countryReader["EuroZone"]);

                        if (countryReader["IdCountryGroup"] != DBNull.Value)
                            country.IdCountryGroup = Convert.ToInt64(countryReader["IdCountryGroup"]);

                        countries.Add(country);
                    }
                }
            }

            return countries;
        }

        /// <summary>
        /// This method is to get all serial numbers
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <returns>List of serial number details</returns>
        public List<SerialNumber> GetAllSerialNumbers(string connectionString)
        {
            List<SerialNumber> serialNumbers = new List<SerialNumber>();

            using (MySqlConnection conCountry = new MySqlConnection(connectionString))
            {
                conCountry.Open();
                MySqlCommand conCountrycommand = new MySqlCommand("warehouse_GetAllSerialNumbers", conCountry);
                conCountrycommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader dNReader = conCountrycommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        SerialNumber serialNumber = new SerialNumber();

                        serialNumber.IdSerialNumber = Convert.ToInt64(dNReader["IdSerialNumber"]);
                        serialNumber.Code = Convert.ToString(dNReader["Code"]);

                        if (dNReader["ExtraCode"] != DBNull.Value)
                            serialNumber.ExtraCode = Convert.ToString(dNReader["ExtraCode"]);

                        if (dNReader["IdWarehouseDeliveryNoteItem"] != DBNull.Value)
                            serialNumber.IdWarehouseDeliveryNoteItem = Convert.ToInt64(dNReader["IdWarehouseDeliveryNoteItem"]);

                        if (dNReader["IdWarehouseProduct"] != DBNull.Value)
                            serialNumber.IdWarehouseProduct = Convert.ToInt64(dNReader["IdWarehouseProduct"]);

                        if (dNReader["IdArticle"] != DBNull.Value)
                            serialNumber.IdArticle = Convert.ToInt32(dNReader["IdArticle"]);

                        serialNumbers.Add(serialNumber);
                    }
                }
            }

            return serialNumbers;
        }


        /// <summary>
        /// [WMS-M029-10] Add picking option
        /// This method is used to show remaining  Workorder items information by idot.
        /// </summary>
        /// <param name="connectionString">The current plant connection string.</param>
        /// <param name="idOt">The idOt</param>
        /// <param name="idWarehouse">The current plant id.</param>
        /// <returns>List of otitem details</returns>
        public List<OtItem> GetRemainingOtItemsByIdOt(string connectionString, Int64 idOt, Int64 idWarehouse, string ArticleVisualAidsPath)
        {
            List<OtItem> otItems = new List<OtItem>();
            List<OtItemSameReference> OtItemSameReferences = new List<OtItemSameReference>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetRemainingOtItemsByIdOt", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOt", idOt);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OtItem otItem = new OtItem();

                            otItem.IdOT = idOt;

                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);



                            otItem.IsBatch = Convert.ToByte(otItemReader["IsBatch"]);

                            if (otItemReader["AttachedFiles"] != DBNull.Value)
                                otItem.AttachedFiles = Convert.ToString(otItemReader["AttachedFiles"]);

                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);
                                otItem.RevisionItem.Quantity = Convert.ToInt64(otItemReader["Quantity"]);
                                otItem.RevisionItem.UnitPrice = Convert.ToDecimal(otItemReader["UnitPrice"]);

                                if (otItemReader["CustomerCommentOT"] != DBNull.Value)
                                    otItem.RevisionItem.InternalComment = Convert.ToString(otItemReader["CustomerCommentOT"]);

                                if (otItemReader["CustomerCommentRevision"] != DBNull.Value)
                                    otItem.RevisionItem.CustomerComment = Convert.ToString(otItemReader["CustomerCommentRevision"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);

                                if (otItemReader["WpDescription"] != DBNull.Value)
                                    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["ArticleDescription"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["ArticleDescription"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    if (otItemReader["UploadedIn"] != DBNull.Value)
                                        article.UploadedIn = Convert.ToDateTime(otItemReader["UploadedIn"]);

                                    if (otItemReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                        article.IdWareHouseDeliveryNoteItem = Convert.ToInt64(otItemReader["IdWareHouseDeliveryNoteItem"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    article.MyWarehouse = new MyWarehouse();

                                    if (otItemReader["MinimumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MinimumStock"]);

                                    if (otItemReader["MaximumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MaximumStock"]);

                                    if (otItemReader["CurrentStock"] != DBNull.Value)
                                        article.MyWarehouse.CurrentStock = Convert.ToInt64(otItemReader["CurrentStock"]);


                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);

                                    otItem.Status = new ItemOTStatusType();
                                    otItem.Status.IdItemOtStatus = otItem.IdItemOtStatus;
                                    otItem.Status.Name = Convert.ToString(otItemReader["Status"]);
                                }

                                if (otItemReader["AssignedTo"] != DBNull.Value)
                                {
                                    otItem.AssignedTo = Convert.ToInt32(otItemReader["AssignedTo"]);

                                    otItem.AssignedToUser = new People();
                                    otItem.AssignedToUser.Name = Convert.ToString(otItemReader["AssignedName"]);
                                    otItem.AssignedToUser.Surname = Convert.ToString(otItemReader["AssignedSurname"]);
                                }

                                if (otItemReader["DownloadedQty"] != DBNull.Value)
                                    otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otItemReader["DownloadedQty"]);

                                if (otItemReader["RemainingQty"] != DBNull.Value)
                                    otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otItemReader["RemainingQty"]);

                                if (otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;


                                List<OtItem> decomposedOtItems = GetArticlesForDecompositionScan(connectionString, idOt, idWarehouse, otItem, ArticleVisualAidsPath, OtItemSameReferences, otItem.RevisionItem.WarehouseProduct.Article.IdArticleType);

                                //if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                //    otItems.AddRange(decomposedOtItems);



                                if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                {
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    otItem.ArticleDecomposedList = decomposedOtItems;
                                }


                                FillPickingMaterial(connectionString, otItem, idWarehouse, ArticleVisualAidsPath, otItems, OtItemSameReferences);
                            }

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRemainingOtItemsByIdOt(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetOtItemsByIdOt().", category: Category.Info, priority: Priority.Low);
            return otItems;
        }


        /// <summary>
        /// [WMS-M029-10] Add picking option
        /// Method for short article as per there quantity to download.
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="otItem">Get otitem details</param>
        /// <param name="idWarehouse">Get idwarehouse</param>
        /// <param name="ArticleVisualAidsPath">Get article image path</param>
        public void FillPickingMaterial(string connectionString, OtItem otItem, Int64 idWarehouse, string ArticleVisualAidsPath, List<OtItem> otitems, List<OtItemSameReference> otItemSameReferences)
        {
            otItem.PickingMaterialsList = new List<PickingMaterials>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("warehouse_GetArticlesStockDetailsByIdArticle", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", otItem.RevisionItem.WarehouseProduct.Article.IdArticle);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {
                    Int64 remainingQty = otItem.RevisionItem.RemainingQuantity; // download Quantity.
                    while (articlesReader.Read())
                    {
                        try
                        {

                            if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])))
                            {
                                Int64 articleCurrentStockRem = 0;
                                articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])).Sum(i => i.Qty));
                                if (articleCurrentStockRem == 0)
                                    continue;
                                else
                                    if (remainingQty == 0)
                                    return;
                            }
                            else
                            {
                                if (remainingQty == 0)
                                    return;
                            }



                            PickingMaterials pickingMaterials = new PickingMaterials();

                            pickingMaterials.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                            pickingMaterials.Article = new Article();
                            pickingMaterials.Article.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;
                            pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                            pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;
                            if (articlesReader["awlMinimumStock"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);
                            if (articlesReader["awlMaximumStock"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);
                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            pickingMaterials.IdOtitem = otItem.IdOTItem;

                            pickingMaterials.IdRevisionItem = otItem.IdRevisionItem;
                            pickingMaterials.RevisionItem = new RevisionItem();
                            pickingMaterials.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                            if (otItem.RevisionItem != null)
                                pickingMaterials.RevisionItem.NumItem = otItem.RevisionItem.NumItem;

                            if (otItem.RevisionItem != null)
                                pickingMaterials.RevisionItem.Quantity = otItem.RevisionItem.Quantity;

                            if (otItem.RevisionItem != null)
                                if (otItem.RevisionItem.WarehouseProduct != null)
                                    pickingMaterials.IdWarehouseProductComponent = otItem.RevisionItem.WarehouseProduct.IdComponent;

                            if (!string.IsNullOrEmpty(otItem.RevisionItem.WarehouseProduct.Article.Reference))
                                pickingMaterials.Reference = otItem.RevisionItem.WarehouseProduct.Article.Reference;

                            if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                                pickingMaterials.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                            if (articlesReader["CurrentStock"] != DBNull.Value)
                                pickingMaterials.CurrentStock = Convert.ToInt64(articlesReader["CurrentStock"]);

                            if (articlesReader["costprice"] != DBNull.Value)
                                pickingMaterials.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                            if (articlesReader["UnitPrice"] != DBNull.Value)
                                pickingMaterials.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            {
                                pickingMaterials.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);


                                pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                                pickingMaterials.Manufacturer = GeManufacturerByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                                pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbers(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, Convert.ToInt64(articlesReader["IdWarehouse"])));
                            }



                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.LocationFullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingMaterials.Description = articlesReader["Description"].ToString();

                            if (articlesReader["ImagePath"] != DBNull.Value)
                            {
                                pickingMaterials.ImagePath = articlesReader["ImagePath"].ToString();
                                Article article = new Article();
                                article.ImagePath = pickingMaterials.ImagePath;
                                pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                            }


                            if (articlesReader["MinimumStock"] != DBNull.Value)
                                pickingMaterials.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                            if (articlesReader["MaximumStock"] != DBNull.Value)
                                pickingMaterials.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                            pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                            if (articlesReader["UploadedIn"] != DBNull.Value)
                            {
                                pickingMaterials.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);
                                pickingMaterials.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(articlesReader["UploadedIn"]);
                            }

                            if (articlesReader["DeliveryCode"] != DBNull.Value)
                                pickingMaterials.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);

                            if (articlesReader["IdCurrency"] != DBNull.Value)
                                pickingMaterials.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                            if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])))
                            {
                                Int64 articleCurrentStockRem = 0;
                                articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])).Sum(i => i.Qty));
                                if (articleCurrentStockRem > 0)
                                {
                                    if (remainingQty > 0 && articleCurrentStockRem > 0)
                                    {
                                        if (articleCurrentStockRem > remainingQty)
                                        {
                                            pickingMaterials.DownloadQuantity = remainingQty;
                                            remainingQty = 0;
                                        }
                                        else
                                        {
                                            pickingMaterials.DownloadQuantity = articleCurrentStockRem;
                                            remainingQty = remainingQty - articleCurrentStockRem;
                                        }

                                    }
                                }
                                else
                                {
                                    if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                                    {
                                        if (pickingMaterials.ArticleCurrentStock > remainingQty)
                                        {
                                            pickingMaterials.DownloadQuantity = remainingQty;
                                            remainingQty = 0;
                                        }
                                        else
                                        {
                                            pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                                            remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                                        }

                                    }
                                }
                            }
                            else
                            {
                                if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                                {
                                    if (pickingMaterials.ArticleCurrentStock > remainingQty)
                                    {
                                        pickingMaterials.DownloadQuantity = remainingQty;
                                        remainingQty = 0;
                                    }
                                    else
                                    {
                                        pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                                        remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                                    }

                                }
                            }

                            pickingMaterials.WarehouseLocation = new WarehouseLocation();

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.HtmlColor = articlesReader["HtmlColor"].ToString();

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingMaterials.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                            pickingMaterials.PartNumberCode = GetPartNumberCode(otItem.IdOTItem, connectionString);

                            if (articlesReader["IdCountryGroup"] != DBNull.Value)
                                pickingMaterials.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);

                            //Add in otSameReferenceList
                            OtItemSameReference otItemSameReference = new OtItemSameReference();
                            otItemSameReference.IdArticle = pickingMaterials.IdArticle;
                            otItemSameReference.IdWarehouseDeliveryNoteItem = pickingMaterials.IdWareHouseDeliveryNoteItem;
                            otItemSameReference.ArticleCurrentStock = pickingMaterials.ArticleCurrentStock;
                            otItemSameReference.Qty = pickingMaterials.DownloadQuantity;
                            otItemSameReference.IdWarehouseLocation = pickingMaterials.WarehouseLocation.IdWarehouseLocation;
                            otItemSameReferences.Add(otItemSameReference);

                            otItem.PickingMaterialsList.Add(pickingMaterials);

                            //GetTotalArticleDownloadDetailByOtItem(connectionString, 1800, 35259);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error FillPickingMaterial(IdArticle-{0}, idWarehouse-{1}). ErrorMessage- {2}", otItem.RevisionItem.WarehouseProduct.Article.IdArticle, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }
        }

        /// <summary>
        /// This method is to get made in related id warehouse delivery note item 
        /// </summary>
        /// <param name="idWareHouseDeliveryNoteItem">Get id warehouse delivery note item</param>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <returns>Made in</returns>
        private string GetMadeInByIdWareHouseDeliveryNoteItem(Int64 idWareHouseDeliveryNoteItem, string connectionString)
        {
            string madeIn = null;
            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand Command = new MySqlCommand("manufacturersbyarticle_GetMadeIn", conn);
                Command.CommandType = CommandType.StoredProcedure;
                Command.Parameters.AddWithValue("_IdWareHouseDeliveryNoteItem", idWareHouseDeliveryNoteItem);


                using (MySqlDataReader Reader = Command.ExecuteReader())
                {
                    if (Reader.Read())
                    {
                        try
                        {
                            madeIn = Reader["name"].ToString();

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetMadeInByIdWareHouseDeliveryNoteItem(ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }
            return madeIn;

        }

        /// <summary>
        /// This method is to get manufacturer related to id warehouse delivery note item
        /// </summary>
        /// <param name="idWareHouseDeliveryNoteItem">Get id warehouse delivery note item</param>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <returns>Manufacturer details</returns>
        private Manufacturer GeManufacturerByIdWareHouseDeliveryNoteItem(Int64 idWareHouseDeliveryNoteItem, string connectionString)
        {
            Manufacturer manufacturer = null;
            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand Command = new MySqlCommand("manufacturersbyarticle_GetIdManufacturer", conn);
                Command.CommandType = CommandType.StoredProcedure;
                Command.Parameters.AddWithValue("_IdWareHouseDeliveryNoteItem", idWareHouseDeliveryNoteItem);


                using (MySqlDataReader Reader = Command.ExecuteReader())
                {
                    if (Reader.Read())
                    {
                        try
                        {
                            manufacturer = new Manufacturer();
                            manufacturer.IdManufacturer = Convert.ToInt64(Reader["IdManufacturer"].ToString());
                            manufacturer.Name = Reader["name"].ToString();
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GeManufacturerByIdWareHouseDeliveryNoteItem(ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }
            return manufacturer;

        }

        /// <summary>
        /// This method is to get partnumber code
        /// </summary>
        /// <param name="idOtItem">Get id otitem</param>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <returns>Get part number code</returns>
        private string GetPartNumberCode(Int64 idOtItem, string connectionString)
        {
            string code = null;
            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand Command = new MySqlCommand("partnumbers_GetPartNumberCode", conn);
                Command.CommandType = CommandType.StoredProcedure;
                Command.Parameters.AddWithValue("_IdOtItem", idOtItem);


                using (MySqlDataReader Reader = Command.ExecuteReader())
                {
                    if (Reader.Read())
                    {
                        try
                        {
                            code = Reader["Code"].ToString();

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPartNumberCode(ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }
            return code;

        }
        /// <summary>
        /// Method for insert negative quantity of  article stock, after scan for piking material. 
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="pickingMaterials">Get picking materials details</param>
        /// <returns>If true inserted record in article stock table otherwise false</returns>
        public bool InsertIntoArticleStock(string connectionString, PickingMaterials pickingMaterials)
        {
            TransactionScope transactionScope = null;

            using (transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection connWDN = new MySqlConnection(connectionString))
                    {
                        connWDN.Open();

                        MySqlCommand insertWDNCommand = new MySqlCommand("warehouse_InsertIntoArticlesStock", connWDN);
                        insertWDNCommand.CommandType = CommandType.StoredProcedure;

                        insertWDNCommand.Parameters.AddWithValue("_IdArticle", pickingMaterials.IdArticle);
                        insertWDNCommand.Parameters.AddWithValue("_IdOtitem", pickingMaterials.IdOtitem);
                        insertWDNCommand.Parameters.AddWithValue("_QTY", pickingMaterials.ScannedQty);
                        insertWDNCommand.Parameters.AddWithValue("_Price", pickingMaterials.CostPrice);
                        insertWDNCommand.Parameters.AddWithValue("_UnitPrice", pickingMaterials.UnitPrice);
                        insertWDNCommand.Parameters.AddWithValue("_Comments", pickingMaterials.Comments);
                        insertWDNCommand.Parameters.AddWithValue("_IdModifyBy", pickingMaterials.ModifiedBy);
                        //insertWDNCommand.Parameters.AddWithValue("_IDcomponent", null);
                        insertWDNCommand.Parameters.AddWithValue("_IDcomponent", pickingMaterials.IdWarehouseProductComponent);
                        insertWDNCommand.Parameters.AddWithValue("_Idwarehouse", pickingMaterials.IdWarehouse);
                        insertWDNCommand.Parameters.AddWithValue("_IdWarehouseLocation", pickingMaterials.IdWarehouseLocation);
                        insertWDNCommand.Parameters.AddWithValue("_IdWareHouseDeliveryNoteItem", pickingMaterials.IdWareHouseDeliveryNoteItem);
                        insertWDNCommand.Parameters.AddWithValue("_IdCurrency", pickingMaterials.IdCurrency);

                        int count = insertWDNCommand.ExecuteNonQuery();

                        connWDN.Close();

                    }

                    if (pickingMaterials.ScanSerialNumbers != null)
                    {
                        foreach (SerialNumber itemSN in pickingMaterials.ScanSerialNumbers)
                        {
                            UpdateSerialNumber(connectionString, itemSN);
                        }
                    }

                    if (pickingMaterials.Observation != null)
                    {
                        UpdateObservation(connectionString, pickingMaterials.Observation);
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error InsertIntoArticleStock(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }



            }

            return true;
        }


        /// <summary>
        /// This method is to get total article download details related to otitem
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="idotItem">Get id otitem</param>
        public void GetTotalArticleDownloadDetailByOtItem(string connectionString, int idWarehouse, Int64 idotItem)
        {
            int downloadedQuantity = 0;
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("warehouse_GetArticlesStockDetailsByIdOtItem", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                ArticlesCommand.Parameters.AddWithValue("_IdOtItem", idotItem);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {
                    while (articlesReader.Read())
                    {
                        try
                        {
                            if (articlesReader["Quantity"] != DBNull.Value)
                                downloadedQuantity = Convert.ToInt32(articlesReader["Quantity"]);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetTotalArticleDownloadDetailByOtItem(IdArticle-{0}, idotItem-{1}). ErrorMessage- {2}", idWarehouse, idotItem, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }

        }

        /// <summary>
        /// This method is to get articles poending storage details
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="ArticleVisualAidsPath">Get article image path</param>
        /// <returns>List of pending storage articles details</returns>
        public List<PendingStorageArticles> GetArticlesPendingStorage(string connectionString, Int64 idWarehouse, string ArticleVisualAidsPath)
        {
            List<PendingStorageArticles> pendingStorageArticlesList = new List<PendingStorageArticles>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("warehouse_GetArticlesPendingStorage", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                ArticlesCommand.CommandTimeout = 4000;

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {
                    while (articlesReader.Read())
                    {
                        try
                        {
                            PendingStorageArticles pendingStorageArticles = new PendingStorageArticles();

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pendingStorageArticles.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pendingStorageArticles.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWareHouseDeliveryNote"] != DBNull.Value)
                            {
                                pendingStorageArticles.IdWareHouseDeliveryNote = Convert.ToInt64(articlesReader["idWareHouseDeliveryNote"]);

                                pendingStorageArticles.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                pendingStorageArticles.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(articlesReader["idWareHouseDeliveryNote"]);

                                if (articlesReader["DeliveryDate"] != DBNull.Value)
                                    pendingStorageArticles.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(articlesReader["DeliveryDate"]);
                            }

                            if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                pendingStorageArticles.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                            if (articlesReader["IdArticle"] != DBNull.Value)
                                pendingStorageArticles.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["Quantity"] != DBNull.Value)
                                pendingStorageArticles.Quantity = Convert.ToInt32(articlesReader["Quantity"]);

                            if (articlesReader["MinimumStock"] != DBNull.Value)
                                pendingStorageArticles.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                            if (articlesReader["MaximumStock"] != DBNull.Value)
                                pendingStorageArticles.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                            if (articlesReader["CurrentStock"] != DBNull.Value)
                                pendingStorageArticles.CurrentStock = Convert.ToInt64(articlesReader["CurrentStock"].ToString());


                            if (articlesReader["Description"] != DBNull.Value)
                                pendingStorageArticles.Description = articlesReader["Description"].ToString();

                            if (articlesReader["Reference"] != DBNull.Value)
                                pendingStorageArticles.Reference = articlesReader["Reference"].ToString();

                            if (articlesReader["UnitPrice"] != DBNull.Value)
                                pendingStorageArticles.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"].ToString());

                            if (articlesReader["Price"] != DBNull.Value)
                                pendingStorageArticles.CostPrice = Convert.ToDouble(articlesReader["Price"].ToString());

                            if (articlesReader["UploadedIn"] != DBNull.Value)
                                pendingStorageArticles.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);

                            if (articlesReader["Code"] != DBNull.Value)
                                pendingStorageArticles.Code = articlesReader["Code"].ToString();

                            pendingStorageArticles.ArticleVisualAidsPath = ArticleVisualAidsPath;


                            if (articlesReader["ImagePath"] != DBNull.Value)
                            {
                                pendingStorageArticles.ImagePath = articlesReader["ImagePath"].ToString();

                                Article article = new Article();
                                article.ImagePath = pendingStorageArticles.ImagePath;
                                if (!string.IsNullOrEmpty(article.ImagePath))
                                    pendingStorageArticles.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                            }

                            if (articlesReader["FullName"] != DBNull.Value)
                                pendingStorageArticles.FullName = articlesReader["FullName"].ToString();

                            if (articlesReader["IdCurrency"] != DBNull.Value)
                                pendingStorageArticles.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"].ToString());

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                pendingStorageArticles.WarehouseLocation = new WarehouseLocation();
                                pendingStorageArticles.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"].ToString());
                                if (articlesReader["Postion1"] != DBNull.Value)
                                    pendingStorageArticles.WarehouseLocation.FullName = Convert.ToString(articlesReader["Postion1"].ToString());
                            }


                            pendingStorageArticlesList.Add(pendingStorageArticles);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetTotalArticleDownloadDetailByOtItem(ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }

            return pendingStorageArticlesList;
        }

        /// <summary>
        /// This method is to get articles warehouse location 
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="IdArticles">Get selected idarticles</param>
        /// <param name="IdWarehouse">Get id warehouse</param>
        /// <returns> List of articles warehouse location details</returns>
        public List<ArticleWarehouseLocations> GetArticlesWarehouseLocation(string connectionString, string IdArticles, long IdWarehouse)
        {
            List<ArticleWarehouseLocations> articleWarehouseLocationsList = new List<ArticleWarehouseLocations>();

            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("warehouse_GetArticlesLocationByIdArticle", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", IdArticles);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", IdWarehouse);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {
                    while (articlesReader.Read())
                    {
                        try
                        {
                            ArticleWarehouseLocations articleWarehouseLocations = new ArticleWarehouseLocations();

                            if (articlesReader["IdArticle"] != DBNull.Value)
                                articleWarehouseLocations.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                articleWarehouseLocations.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                articleWarehouseLocations.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdArticleWarehouseLocation"] != DBNull.Value)
                                articleWarehouseLocations.IdArticleWarehouseLocation = Convert.ToInt64(articlesReader["IdArticleWarehouseLocation"]);

                            if (articlesReader["Parent"] != DBNull.Value)
                                articleWarehouseLocations.Parent = Convert.ToInt64(articlesReader["Parent"]);

                            if (articlesReader["Position"] != DBNull.Value)
                                articleWarehouseLocations.Position = Convert.ToInt64(articlesReader["Position"]);

                            if (articlesReader["Name"] != DBNull.Value)
                                articleWarehouseLocations.Name = articlesReader["Name"].ToString();

                            if (articlesReader["FullName"] != DBNull.Value)
                                articleWarehouseLocations.FullName = articlesReader["FullName"].ToString();

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                articleWarehouseLocations.WarehouseLocation = new WarehouseLocation();

                                articleWarehouseLocations.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);
                                if (articlesReader["IdWarehouse"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);
                                if (articlesReader["Name"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Name = Convert.ToString(articlesReader["Name"]);
                                if (articlesReader["Parent"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Parent = Convert.ToInt64(articlesReader["Parent"]);
                                if (articlesReader["Position"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Position = Convert.ToInt64(articlesReader["Position"]);
                                if (articlesReader["FullName"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.FullName = Convert.ToString(articlesReader["FullName"]);
                                if (articlesReader["FileName"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);
                                if (articlesReader["Latitude"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                                if (articlesReader["Longitude"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                                if (articlesReader["Height"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                                if (articlesReader["Width"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);
                            }

                            articleWarehouseLocationsList.Add(articleWarehouseLocations);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticlesWarehouseLocation(IdArticle-{0} . ErrorMessage- {2}", IdArticles, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }

            }
            return articleWarehouseLocationsList;

        }

        /// <summary>
        /// Method for insert negative and positive quantity of  article stock, after scan for locate material.
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="pendingStorageArticles">Get pending storage article details</param>
        /// <returns>If true inserted into article stock table otherwise false</returns>
        public bool InsertIntoArticleStockForLocateMaterial(string connectionString, PendingStorageArticles pendingStorageArticles)
        {
            TransactionScope transactionScope = null;

            using (transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection connWDN = new MySqlConnection(connectionString))
                    {
                        connWDN.Open();

                        MySqlCommand insertWDNCommand = new MySqlCommand("warehouse_InsertIntoArticlesStockWithQtySuffix", connWDN);
                        insertWDNCommand.CommandType = CommandType.StoredProcedure;

                        insertWDNCommand.Parameters.AddWithValue("_IdArticle", pendingStorageArticles.IdArticle);
                        insertWDNCommand.Parameters.AddWithValue("_IdOtitem", null);
                        insertWDNCommand.Parameters.AddWithValue("_QTY", pendingStorageArticles.ScannedQty);
                        insertWDNCommand.Parameters.AddWithValue("_Price", pendingStorageArticles.CostPrice);
                        insertWDNCommand.Parameters.AddWithValue("_UnitPrice", pendingStorageArticles.UnitPrice);

                        insertWDNCommand.Parameters.AddWithValue("_Comments", pendingStorageArticles.Comments);
                        insertWDNCommand.Parameters.AddWithValue("_IdModifyBy", pendingStorageArticles.ModifiedBy);
                        insertWDNCommand.Parameters.AddWithValue("_IDcomponent", null);
                        insertWDNCommand.Parameters.AddWithValue("_Idwarehouse", pendingStorageArticles.IdWarehouse);
                        insertWDNCommand.Parameters.AddWithValue("_IdWarehouseLocation", pendingStorageArticles.IdWarehouseLocation);
                        insertWDNCommand.Parameters.AddWithValue("_IdWareHouseDeliveryNoteItem", pendingStorageArticles.IdWareHouseDeliveryNoteItem);
                        insertWDNCommand.Parameters.AddWithValue("_IdCurrency", pendingStorageArticles.IdCurrency);

                        int count = insertWDNCommand.ExecuteNonQuery();

                        connWDN.Close();
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error InsertIntoArticleStockForLocateMaterial(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return true;
        }

        /// <summary>
        /// Method for get material details by location.
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="locatioName">Location name details</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="ArticleVisualAidsPath">Get articles image path</param>
        /// <returns>List of trabsfer materials details</returns>
        public List<TransferMaterials> GetMaterialDetailsByLocationName(string connectionString, string locatioName, Int64 idWarehouse, string ArticleVisualAidsPath)
        {
            List<TransferMaterials> transferMaterialsList = new List<TransferMaterials>();

            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("warehouse_GetMaterialDetailsByLocationName", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_LocationName", locatioName);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {
                    while (articlesReader.Read())
                    {
                        try
                        {
                            TransferMaterials transferMaterial = new TransferMaterials();

                            if (articlesReader["IdArticle"] != DBNull.Value)
                                transferMaterial.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["Reference"] != DBNull.Value)
                                transferMaterial.Reference = articlesReader["Reference"].ToString();

                            if (articlesReader["CurrentStock"] != DBNull.Value)
                                transferMaterial.CurrentStock = Convert.ToInt64(articlesReader["CurrentStock"]);

                            if (articlesReader["costprice"] != DBNull.Value)
                                transferMaterial.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                            if (articlesReader["UnitPrice"] != DBNull.Value)
                                transferMaterial.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                            if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                transferMaterial.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                transferMaterial.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["Quantity"] != DBNull.Value)
                                transferMaterial.Quantity = Convert.ToInt32(articlesReader["Quantity"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                transferMaterial.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                transferMaterial.LocationFullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["Description"] != DBNull.Value)
                                transferMaterial.Description = articlesReader["Description"].ToString();

                            transferMaterial.ArticleVisualAidsPath = ArticleVisualAidsPath;
                            if (articlesReader["ImagePath"] != DBNull.Value)
                            {
                                transferMaterial.ImagePath = articlesReader["ImagePath"].ToString();
                                Article article = new Article();
                                article.ImagePath = transferMaterial.ImagePath;
                                transferMaterial.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                            }

                            if (articlesReader["MinimumStock"] != DBNull.Value)
                                transferMaterial.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                            if (articlesReader["MaximumStock"] != DBNull.Value)
                                transferMaterial.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                            if (articlesReader["UploadedIn"] != DBNull.Value)
                                transferMaterial.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);

                            if (articlesReader["IdCurrency"] != DBNull.Value)
                                transferMaterial.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                            transferMaterialsList.Add(transferMaterial);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error FillPickikngMaterial(locatioName-{0}, idWarehouse-{1}). ErrorMessage- {2}", locatioName, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }
            return transferMaterialsList;
        }

        /// <summary>
        /// Method for insert negative and positive quantity of  article stock, after scan for Transfer material. 
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="transferMaterials">Transfer material details</param>
        /// <returns>If true inserted into articles stock otherwise false</returns>
        public bool InsertIntoArticleStockForTransferMaterial(string connectionString, TransferMaterials transferMaterials)
        {
            TransactionScope transactionScope = null;

            using (transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection connWDN = new MySqlConnection(connectionString))
                    {
                        connWDN.Open();

                        MySqlCommand insertWDNCommand = new MySqlCommand("warehouse_InsertIntoArticlesStockWithQtySuffix", connWDN);
                        insertWDNCommand.CommandType = CommandType.StoredProcedure;

                        insertWDNCommand.Parameters.AddWithValue("_IdArticle", transferMaterials.IdArticle);
                        insertWDNCommand.Parameters.AddWithValue("_IdOtitem", null);
                        insertWDNCommand.Parameters.AddWithValue("_QTY", transferMaterials.ScannedQty);
                        insertWDNCommand.Parameters.AddWithValue("_Price", transferMaterials.CostPrice);
                        insertWDNCommand.Parameters.AddWithValue("_UnitPrice", transferMaterials.UnitPrice);

                        insertWDNCommand.Parameters.AddWithValue("_Comments", transferMaterials.Comments);
                        insertWDNCommand.Parameters.AddWithValue("_IdModifyBy", transferMaterials.ModifiedBy);
                        insertWDNCommand.Parameters.AddWithValue("_IDcomponent", null);
                        insertWDNCommand.Parameters.AddWithValue("_Idwarehouse", transferMaterials.IdWarehouse);
                        insertWDNCommand.Parameters.AddWithValue("_IdWarehouseLocation", transferMaterials.IdWarehouseLocation);
                        insertWDNCommand.Parameters.AddWithValue("_IdWareHouseDeliveryNoteItem", transferMaterials.IdWareHouseDeliveryNoteItem);
                        insertWDNCommand.Parameters.AddWithValue("_IdCurrency", transferMaterials.IdCurrency);

                        int count = insertWDNCommand.ExecuteNonQuery();

                        connWDN.Close();
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error InsertIntoArticleStockForTransferMaterial(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return true;
        }

        /// <summary>
        /// This method is to get  warehouse delivery note related to Id warehouse delivery note
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="articleVisualAidsPath">Get article image path</param>
        /// <param name="purchaseOrdersPath">Get purchase order path</param>
        /// <param name="idWarehouseDeliveryNote">Get id warehouse delivery note </param>
        /// <returns>Warehouse delivery note details</returns>
        public WarehouseDeliveryNote GetWarehouseDeliveryNoteById(string connectionString, string articleVisualAidsPath, string purchaseOrdersPath, Int64 idWarehouseDeliveryNote)
        {
            //string connectionString = warehouse.Company.ConnectPlantConstr;

            WarehouseDeliveryNote warehouseDeliveryNote = null;

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand poCommand = new MySqlCommand("warehouse_GetWarehouseDeliveryNote", mySqlConnection);
                poCommand.CommandType = CommandType.StoredProcedure;
                poCommand.Parameters.AddWithValue("_IdWarehouseDeliveryNote", idWarehouseDeliveryNote);

                using (MySqlDataReader reader = poCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            warehouseDeliveryNote = new WarehouseDeliveryNote();

                            if (reader["IdWarehouseDeliveryNote"] != DBNull.Value)
                                warehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["IdWarehouseDeliveryNote"]);

                            if (reader["WdnCode"] != DBNull.Value)
                                warehouseDeliveryNote.Code = Convert.ToString(reader["WdnCode"]);

                            if (reader["IdCurrencyImportExpenses"] != DBNull.Value)
                                warehouseDeliveryNote.IdCurrencyImportExpenses = Convert.ToInt64(reader["IdCurrencyImportExpenses"]);

                            if (reader["ImportExpenses"] != DBNull.Value)
                                warehouseDeliveryNote.ImportExpenses = Convert.ToDouble(reader["ImportExpenses"]);

                            if (reader["AttachedDeliveryNotes"] != DBNull.Value)
                                warehouseDeliveryNote.AttachedDeliveryNotes = Convert.ToByte(reader["AttachedDeliveryNotes"]);

                            if (reader["DeliveryDate"] != DBNull.Value)
                                warehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);

                            if (reader["WdnCreatedIn"] != DBNull.Value)
                                warehouseDeliveryNote.CreatedIn = Convert.ToDateTime(reader["WdnCreatedIn"]);

                            if (reader["ModifiedIn"] != DBNull.Value)
                                warehouseDeliveryNote.ModifiedIn = Convert.ToDateTime(reader["ModifiedIn"]);

                            if (reader["SupplierCode"] != DBNull.Value)
                                warehouseDeliveryNote.SupplierCode = Convert.ToString(reader["SupplierCode"]);

                            if (reader["LocalIdCurrency"] != DBNull.Value)
                                warehouseDeliveryNote.IdCurrency = Convert.ToByte(reader["LocalIdCurrency"]);

                            if (reader["ExchangeRate"] != DBNull.Value)
                                warehouseDeliveryNote.ExchangeRate = Convert.ToDouble(reader["ExchangeRate"]);

                            if (reader["ZF01"] != DBNull.Value)
                                warehouseDeliveryNote.ZF01 = Convert.ToString(reader["ZF01"]);

                            if (reader["CurrentlyAccessedBy"] != DBNull.Value)
                                warehouseDeliveryNote.CurrentlyAccessedBy = Convert.ToInt32(reader["CurrentlyAccessedBy"]);

                            if (reader["IdWarehousePurchaseOrder"] != DBNull.Value)
                            {
                                warehouseDeliveryNote.IdWarehousePurchaseOrder = Convert.ToInt64(reader["IdWarehousePurchaseOrder"]);

                                warehouseDeliveryNote.WarehousePurchaseOrder = new WarehousePurchaseOrder();
                                warehouseDeliveryNote.WarehousePurchaseOrder.IdWarehousePurchaseOrder = warehouseDeliveryNote.IdWarehousePurchaseOrder;

                                if (reader["WpoCode"] != DBNull.Value)
                                    warehouseDeliveryNote.WarehousePurchaseOrder.Code = Convert.ToString(reader["WpoCode"]);

                                if (reader["Idcurrency"] != DBNull.Value)
                                    warehouseDeliveryNote.WarehousePurchaseOrder.IdCurrency = Convert.ToByte(reader["Idcurrency"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    warehouseDeliveryNote.WarehousePurchaseOrder.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);


                                if (reader["WpoCreatedIn"] != DBNull.Value)
                                {
                                    warehouseDeliveryNote.WarehousePurchaseOrder.CreatedIn = Convert.ToDateTime(reader["WpoCreatedIn"]);

                                    warehouseDeliveryNote.PdfFilePath = purchaseOrdersPath + @"\" + warehouseDeliveryNote.WarehousePurchaseOrder.CreatedIn.Year + @"\" + warehouseDeliveryNote.WarehousePurchaseOrder.Code + @"\02 Delivery Notes\DN_" + warehouseDeliveryNote.Code + ".pdf"; ;
                                }

                                if (reader["IdArticleSupplier"] != DBNull.Value)
                                {
                                    warehouseDeliveryNote.WarehousePurchaseOrder.IdArticleSupplier = Convert.ToInt64(reader["IdArticleSupplier"]);

                                    warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier = new ArticleSupplier();
                                    warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.IdArticleSupplier = warehouseDeliveryNote.WarehousePurchaseOrder.IdArticleSupplier;

                                    if (reader["Supplier"] != DBNull.Value)
                                        warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Name = Convert.ToString(reader["Supplier"]);

                                    if (reader["IdCountry"] != DBNull.Value)
                                    {
                                        warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.IdCountry = Convert.ToInt64(reader["IdCountry"]);

                                        if (reader["IdCountryGroup"] != DBNull.Value)
                                        {
                                            warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Country = new Country();
                                            warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Country.IdCountryGroup = Convert.ToInt64(reader["IdCountryGroup"]);
                                        }
                                    }

                                    if (reader["IdArticleSupplierType"] != DBNull.Value)
                                    {
                                        warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.IdArticleSupplierType = Convert.ToInt32(reader["IdArticleSupplierType"]);

                                        ArticleSupplierType articleSupplierType = new ArticleSupplierType();
                                        articleSupplierType.IdArticleSupplierType = warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.IdArticleSupplierType;
                                        articleSupplierType.Name = Convert.ToString(reader["ArticleSupplierType"]);
                                        articleSupplierType.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                                        warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.ArticleSupplierType = articleSupplierType;
                                    }
                                }
                            }

                            warehouseDeliveryNote.WarehouseDeliveryNoteItems = GetWarehouseDeliveryNoteItemsByIdWDN(connectionString, articleVisualAidsPath, idWarehouseDeliveryNote, warehouseDeliveryNote.WarehousePurchaseOrder);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetWarehouseDeliveryNoteById(idWarehouseDeliveryNote-{0}). ErrorMessage-{1}", idWarehouseDeliveryNote, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return warehouseDeliveryNote;
        }

        /// <summary>
        /// This method is to get warehouse delivery note itemm related to warehouse Delivery note
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="articleVisualAidsPath">Get article image path </param>
        /// <param name="idWarehouseDeliveryNote">Get id warehouse delivery note</param>
        /// <param name="warehousePurchaseOrder">Get warehouse purchase order</param>
        /// <returns>List of warehouse delivery note item details</returns>
        public List<WarehouseDeliveryNoteItem> GetWarehouseDeliveryNoteItemsByIdWDN(string connectionString, string articleVisualAidsPath, Int64 idWarehouseDeliveryNote, WarehousePurchaseOrder warehousePurchaseOrder)
        {
            //string connectionString = warehouse.Company.ConnectPlantConstr;

            List<WarehouseDeliveryNoteItem> warehouseDeliveryNoteItems = new List<WarehouseDeliveryNoteItem>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand poCommand = new MySqlCommand("warehouse_GetWarehouseDeliveryNoteItems", mySqlConnection);
                poCommand.CommandType = CommandType.StoredProcedure;
                poCommand.Parameters.AddWithValue("_IdWarehouseDeliveryNote", idWarehouseDeliveryNote);

                using (MySqlDataReader reader = poCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            WarehouseDeliveryNoteItem warehouseDeliveryNoteItem = new WarehouseDeliveryNoteItem();

                            if (reader["IdWarehouseDeliveryNoteItem"] != DBNull.Value)
                                warehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem = Convert.ToInt64(reader["IdWarehouseDeliveryNoteItem"]);

                            if (reader["IdWarehousePurchaseOrderItem"] != DBNull.Value)
                            {
                                warehouseDeliveryNoteItem.IdWarehousePurchaseOrderItem = Convert.ToInt64(reader["IdWarehousePurchaseOrderItem"]);

                                warehouseDeliveryNoteItem.WarehousePurchaseOrderItem = new WarehousePurchaseOrderItem();
                                warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.IdWarehousePurchaseOrderItem = warehouseDeliveryNoteItem.IdWarehousePurchaseOrderItem;

                                if (reader["IdWarehousePurchaseOrder"] != DBNull.Value)
                                    warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.IdWarehousePurchaseOrder = Convert.ToInt64(reader["IdWarehousePurchaseOrder"]);

                                if (reader["Description"] != DBNull.Value)
                                    warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.Description = Convert.ToString(reader["Description"]);

                                if (reader["TotalQuantity"] != DBNull.Value)
                                    warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.Quantity = Convert.ToDouble(reader["TotalQuantity"]);

                                if (reader["UnitPrice"] != DBNull.Value)
                                    warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.UnitPrice = Convert.ToDouble(reader["UnitPrice"]);

                                if (reader["Discount"] != DBNull.Value)
                                    warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.Discount = Convert.ToDouble(reader["Discount"]);

                                if (reader["Iva"] != DBNull.Value)
                                    warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.IVA = Convert.ToInt64(reader["Iva"]);
                            }

                            if (reader["Quantity"] != DBNull.Value)
                                warehouseDeliveryNoteItem.Quantity = Convert.ToInt32(reader["Quantity"]);

                            if (reader["Uploaded"] != DBNull.Value)
                                warehouseDeliveryNoteItem.Uploaded = Convert.ToByte(reader["Uploaded"]);

                            if (reader["CustomsDuty"] != DBNull.Value)
                                warehouseDeliveryNoteItem.CustomsDuty = Convert.ToDouble(reader["CustomsDuty"]);

                            if (reader["IdManufacturerByArticle"] != DBNull.Value)
                                warehouseDeliveryNoteItem.IdManufacturerByArticle = Convert.ToInt64(reader["IdManufacturerByArticle"]);

                            if (reader["IdArticle"] != DBNull.Value)
                            {
                                Article article = new Article();
                                article.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.IdArticle = article.IdArticle;

                                if (reader["Reference"] != DBNull.Value)
                                    article.Reference = Convert.ToString(reader["Reference"]);

                                if (reader["ArticleDescription"] != DBNull.Value)
                                    article.Description = Convert.ToString(reader["ArticleDescription"]);

                                if (reader["RegisterSerialNumber"] != DBNull.Value)
                                    article.RegisterSerialNumber = Convert.ToByte(reader["RegisterSerialNumber"]);

                                article.IsGeneric = Convert.ToSByte(reader["IsGeneric"]);

                                if (reader["ImagePath"] != DBNull.Value)
                                {
                                    article.ImagePath = Convert.ToString(reader["ImagePath"]);

                                    if (!string.IsNullOrEmpty(article.ImagePath))
                                        article.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, article);
                                }

                                article.MyWarehouse = new MyWarehouse();

                                if (reader["CurrentStock"] != DBNull.Value)
                                    article.MyWarehouse.CurrentStock = Convert.ToInt64(reader["CurrentStock"]);

                                if (reader["MinimumStock"] != DBNull.Value)
                                    article.MyWarehouse.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);

                                if (reader["MaximumStock"] != DBNull.Value)
                                    article.MyWarehouse.MaximumStock = Convert.ToInt64(reader["MaximumStock"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    article.MyWarehouse.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                                //if (reader["ArticleLocation"] != DBNull.Value)
                                //    article.MyWarehouse.Location = Convert.ToString(reader["ArticleLocation"]);

                                warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.Article = article;
                                warehouseDeliveryNoteItem.ManufacturersByArticle = GetManufacturersByIdArticle(connectionString, article.IdArticle, warehousePurchaseOrder);
                            }

                            //if (reader["Description"] != DBNull.Value)
                            //    warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.Description = Convert.ToString(reader["Description"]);

                            //if (reader["Quantity"] != DBNull.Value)
                            //    warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.Quantity = Convert.ToDouble(reader["Quantity"]);

                            //if (reader["ReceivedQty"] != DBNull.Value)
                            //    warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.ReceivedQuantity = Convert.ToDouble(reader["ReceivedQty"]);

                            //if (reader["MAXQty"] != DBNull.Value)
                            //    warehouseDeliveryNoteItem.MaxQuantity = Convert.ToInt32(reader["MAXQty"]);

                            warehouseDeliveryNoteItems.Add(warehouseDeliveryNoteItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetWarehouseDeliveryNoteItemsByIdWDN(idWarehouseDeliveryNote-{0}). ErrorMessage-{1}", idWarehouseDeliveryNote, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return warehouseDeliveryNoteItems;
        }


        /// <summary>
        /// This method is to get zone related to idarticle
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idArticle">Get id article</param>
        /// <returns>Get zone</returns>
        public string GetZoneByIdArticle(string connectionString, Int64 idArticle)
        {
            //string connectionString = warehouse.Company.ConnectPlantConstr;

            string zone = null;

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand poCommand = new MySqlCommand("warehouselocation_GetZone", mySqlConnection);
                poCommand.CommandType = CommandType.StoredProcedure;
                poCommand.Parameters.AddWithValue("_IdArticle", idArticle);

                using (MySqlDataReader reader = poCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        try
                        {
                            zone = reader["FullName"].ToString();
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetZoneByIdArticle(idArticle-{0}). ErrorMessage-{1}", idArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                    else
                    {
                        zone = "";
                    }
                }
            }
            return zone;
        }
        /// <summary>
        /// [WMS-M033-11] Add View Delivery Note option with options to update stock.
        /// Same method like GWSM - internal Boolean UpdateAlbaranReception(clsArticleForAlbaran rel)
        /// </summary>
        /// <param name="connectionString"></param>
        /// <param name="warehouseDeliveryNoteItem"></param>
        /// <returns>If true updated in warehouse delivery note item otherwise false</returns>
        public Boolean UpdateWarehouseDeliveryNoteItem(string connectionString, WarehouseDeliveryNoteItem warehouseDeliveryNoteItem)
        {
            //MySqlConnection myConn = new MySqlConnection(connectionString);
            //myConn.Open();
            //String sql = "UPDATE warehousedeliverynoteitems SET uploaded = ?UPLOADED " +
            //    " WHERE idwarehousedeliverynoteitem = ?ARTICLE";
            //MySqlCommand myComm = new MySqlCommand(sql, myConn);
            //myComm.Parameters.Add("?UPLOADED", warehouseDeliveryNoteItem.Uploaded);
            //myComm.Parameters.Add("?ARTICLE", warehouseDeliveryNoteItem.WarehousePurchaseOrderItem.IdArticle);
            //bool ok = (myComm.ExecuteNonQuery() > 0);
            //myConn.Close();
            //return ok;

            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("warehouse_UpdateWarehouseDeliveryNoteItem", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdWarehouseDeliveryNoteItem", warehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem);
                        mySqlCommand.Parameters.AddWithValue("_Uploaded", warehouseDeliveryNoteItem.Uploaded);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();

                        //warehouseDeliveryNoteItem.ArticlesStock is null when article is generic.
                        if (warehouseDeliveryNoteItem.Uploaded == 1 && warehouseDeliveryNoteItem.ArticlesStock != null)
                        {
                            Boolean result = InsertStockArticle(connectionString, warehouseDeliveryNoteItem);
                        }
                        else if (warehouseDeliveryNoteItem.Uploaded == 0 && warehouseDeliveryNoteItem.ArticlesStock != null)
                        {
                            Boolean result = RemoveStockArticle(connectionString, warehouseDeliveryNoteItem);
                        }
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error UpdateWarehouseDeliveryNoteItem(). warehouseDeliveryNoteItem- {0} ErrorMessage- {1}", warehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem, ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return true;
        }

        /// <summary>
        /// This method is to insert into article stock
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="warehouseDeliveryNoteItem">Get warehouse delivery note item</param>
        /// <returns>If true inserted into article stock table otherwise false</returns>
        internal Boolean InsertStockArticle(string connectionString, WarehouseDeliveryNoteItem warehouseDeliveryNoteItem)
        {
            try
            {
                ArticlesStock articlesStock = warehouseDeliveryNoteItem.ArticlesStock;


                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("warehouse_InsertIntoArticlesStock", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;

                    mySqlCommand.Parameters.AddWithValue("_IdArticle", articlesStock.IdArticle);
                    mySqlCommand.Parameters.AddWithValue("_IdOtitem", articlesStock.IdOtItem);
                    mySqlCommand.Parameters.AddWithValue("_QTY", articlesStock.Quantity);

                    //Chek
                    mySqlCommand.Parameters.AddWithValue("_Price", articlesStock.Price);
                    mySqlCommand.Parameters.AddWithValue("_UnitPrice", articlesStock.UnitPrice);

                    //"Recibido en el albaran nº " + albaran.Reference + " [STOCK -> " + Convert.ToString(GetArticleStock(rel.Article.IdArticle, albaran.Warehouse.Id) + rel.Quantity) + "]"
                    mySqlCommand.Parameters.AddWithValue("_Comments", articlesStock.Comments);


                    mySqlCommand.Parameters.AddWithValue("_IdModifyBy", articlesStock.ModifiedBy);
                    mySqlCommand.Parameters.AddWithValue("_IDcomponent", articlesStock.IdWarehouseProductComponent);

                    mySqlCommand.Parameters.AddWithValue("_Idwarehouse", articlesStock.IdWarehouse);

                    mySqlCommand.Parameters.AddWithValue("_IdWarehouseLocation", 7);    //articlesStock.IdWarehouseLocation
                    mySqlCommand.Parameters.AddWithValue("_IdWareHouseDeliveryNoteItem", articlesStock.IdWarehouseDeliveryNoteItem);

                    //chek
                    mySqlCommand.Parameters.AddWithValue("_IdCurrency", articlesStock.IdCurrency);

                    mySqlCommand.ExecuteNonQuery();
                    mySqlConnection.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateWarehouseDeliveryNoteItemReception(). IdEmployee- {0} ErrorMessage- {1}", warehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }


            return true;
        }

        /// <summary>
        /// This method is to remove from article stock
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="warehouseDeliveryNoteItem">Get warehouse delivery note item details</param>
        /// <returns>If true removed from article stock otherwise false</returns>
        internal Boolean RemoveStockArticle(string connectionString, WarehouseDeliveryNoteItem warehouseDeliveryNoteItem)
        {

            try
            {
                ArticlesStock articlesStock = warehouseDeliveryNoteItem.ArticlesStock;

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("warehouse_InsertIntoArticlesStock", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;

                    mySqlCommand.Parameters.AddWithValue("_IdArticle", articlesStock.IdArticle);
                    mySqlCommand.Parameters.AddWithValue("_IdOtitem", articlesStock.IdOtItem);
                    mySqlCommand.Parameters.AddWithValue("_QTY", articlesStock.Quantity);

                    //Chek
                    mySqlCommand.Parameters.AddWithValue("_Price", articlesStock.Price);
                    mySqlCommand.Parameters.AddWithValue("_UnitPrice", articlesStock.UnitPrice);

                    //"Recibido en el albaran nº " + albaran.Reference + " [STOCK -> " + Convert.ToString(GetArticleStock(rel.Article.IdArticle, albaran.Warehouse.Id) + rel.Quantity) + "]"
                    mySqlCommand.Parameters.AddWithValue("_Comments", articlesStock.Comments);


                    mySqlCommand.Parameters.AddWithValue("_IdModifyBy", articlesStock.ModifiedBy);
                    mySqlCommand.Parameters.AddWithValue("_IDcomponent", articlesStock.IdWarehouseProductComponent);

                    mySqlCommand.Parameters.AddWithValue("_Idwarehouse", articlesStock.IdWarehouse);

                    mySqlCommand.Parameters.AddWithValue("_IdWarehouseLocation", 7);    //articlesStock.IdWarehouseLocation
                    mySqlCommand.Parameters.AddWithValue("_IdWareHouseDeliveryNoteItem", articlesStock.IdWarehouseDeliveryNoteItem);

                    //chek
                    mySqlCommand.Parameters.AddWithValue("_IdCurrency", articlesStock.IdCurrency);

                    mySqlCommand.ExecuteNonQuery();
                    mySqlConnection.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error UpdateWarehouseDeliveryNoteItemReception(). IdEmployee- {0} ErrorMessage- {1}", warehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }


            return true;
        }

        /// <summary>
        /// Added method to get stock of article related to Warehouse.
        /// </summary>
        /// <param name="idArticle">The article stock</param>
        /// <param name="idWarehouse">The idWarehouse.</param>
        /// <returns>Stock of article.</returns>
        public int GetArticleStockByWarehouse(string connectionString, int idArticle, int idWarehouse)
        {
            //MySqlConnection myConn = new MySqlConnection(connectionString);
            //myConn.Open();

            //String sql = "SELECT IFNULL(SUM(Quantity),0) AS qtystock " +
            //            " FROM ArticlesStock " +
            //            " WHERE NOT isDamaged AND idArticle = ?ARTICLE AND idWarehouse=?IDWAREHOUSE;";
            //MySqlCommand myComm = new MySqlCommand(sql, myConn);

            //myComm.Parameters.Add("?ARTICLE", idArticle);
            //myComm.Parameters.Add("?IDWAREHOUSE", idWarehouse);

            //int quantity = Convert.ToInt32(myComm.ExecuteScalar());

            //myConn.Close();
            //return quantity;


            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("warehouse_GetArticleStockByWarehouse", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", idArticle);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        try
                        {
                            if (reader["ArticlesStockQty"] != DBNull.Value)
                                return Convert.ToInt32(reader["ArticlesStockQty"]);

                            return 0;
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleStockByWarehouse(). idArticle- {0} idWarehouse-{1} ErrorMessage- {2}", idArticle, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return 0;
        }

        /// <summary>
        /// This method is to get artilce decomposition
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idArticle">Get id article</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <returns>List of article details</returns>
        internal List<Article> GetArticleDecomposition(String connectionString, int idArticle, int idWarehouse)
        {
            #region Commented code from GWSM

            ////Modified ByJJMG
            //MySqlConnection myConn = new MySqlConnection(connectionString);
            //myConn.Open();

            //String sql = " SELECT a2.IdArticle, a2.reference, aba.quantity, a2.RegisterSerialNumber, IFNULL(SUM(ars.Quantity), 0) AS Stock, a2.IsGeneric AS Generic" +
            //            " FROM articles a " +
            //            " INNER JOIN articlesbyarticle aba ON aba.idArticle = a.idArticle " +
            //            " INNER JOIN articles a2 ON aba.idComponent = a2.idArticle " +
            //            " LEFT JOIN articlesstock ars ON ars.idArticle = aba.idComponent AND ars.idWarehouse = ?IDWAREHOUSE " +
            //            " WHERE a.idArticle = ?IDARTICLE AND NOT IFNULL(ars.isDamaged,false) " +
            //            " GROUP BY aba.idComponent;";
            //MySqlCommand myComm = new MySqlCommand(sql, myConn);
            //myComm.Parameters.Add("?IDARTICLE", idArticle);
            //myComm.Parameters.Add("?IDWAREHOUSE", idWarehouse);//[001]

            //List<Article> articles = new List<Article>();
            //MySqlDataReader reader = myComm.ExecuteReader();

            //while (reader.Read())
            //{
            //    Article art = new Article();
            //    art.Id = Convert.ToUInt32(reader["IdArticle"]);
            //    art.Reference = Convert.ToString(reader["reference"]);
            //    art.Quantity = Convert.ToSingle(reader["quantity"]);

            //    art.StockQty = Convert.ToUInt32(reader["stock"]);


            //    art.RegisterSerialNumbers = Convert.ToBoolean(reader["RegisterSerialNumber"]);
            //    art.IsGeneric = Convert.ToBoolean(reader["Generic"]);//byJJMG (necessary to the redundant bucle when some descomposition is generic too
            //    articles.Add(art);
            //}

            //reader.Close();
            //myComm.Dispose();
            //myConn.Close();

            //return articles;

            #endregion

            List<Article> articles = new List<Article>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("warehouse_GetArticleDecomposition", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", idArticle);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            Article art = new Article();

                            if (reader["IdArticle"] != DBNull.Value)
                                art.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                            if (reader["reference"] != DBNull.Value)
                                art.Reference = Convert.ToString(reader["reference"]);

                            if (reader["quantity"] != DBNull.Value)
                                art.Quantity = Convert.ToSingle(reader["quantity"]);

                            //art.StockQty = Convert.ToUInt32(reader["stock"]);

                            if (reader["RegisterSerialNumber"] != DBNull.Value)
                                art.RegisterSerialNumber = Convert.ToByte(reader["RegisterSerialNumber"]);

                            //GWSM byJJMG (necessary to the redundant bucle when some descomposition is generic too
                            if (reader["Generic"] != DBNull.Value)
                                art.IsGeneric = Convert.ToSByte(reader["Generic"]);

                            articles.Add(art);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleDecomposition(). idArticle- {0} idWarehouse-{1} ErrorMessage- {2}", idArticle, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return articles;
        }

        /// <summary>
        /// This method is to get all warehouse location related to Id warehouse
        /// </summary>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <returns>List of warehouse location details</returns>
        public List<WarehouseLocation> GetAllWarehouseLocationById(long idWarehouse, string connectionString)
        {
            List<WarehouseLocation> warehouseLocationList = new List<WarehouseLocation>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("warehouse_GetAllWarehouseLocationById", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            WarehouseLocation warehouseLocation = new WarehouseLocation();

                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                                warehouseLocation.IdWarehouseLocation = Convert.ToInt32(reader["IdWarehouseLocation"]);

                            if (reader["IdWarehouse"] != DBNull.Value)
                                warehouseLocation.IdWarehouse = Convert.ToInt32(reader["IdWarehouse"]);

                            if (reader["Parent"] != DBNull.Value)
                                warehouseLocation.Parent = Convert.ToInt32(reader["Parent"]);

                            if (reader["Position"] != DBNull.Value)
                                warehouseLocation.Position = Convert.ToInt32(reader["Position"]);

                            if (reader["Name"] != DBNull.Value)
                                warehouseLocation.Name = Convert.ToString(reader["Name"]);

                            if (reader["FullName"] != DBNull.Value)
                                warehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                            if (reader["HtmlColor"] != DBNull.Value)
                                warehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                            if (reader["Latitude"] != DBNull.Value)
                                warehouseLocation.Latitude = Convert.ToDouble(reader["Latitude"]);

                            if (reader["Longitude"] != DBNull.Value)
                                warehouseLocation.Longitude = Convert.ToDouble(reader["Longitude"]);

                            if (reader["Height"] != DBNull.Value)
                                warehouseLocation.Height = Convert.ToDouble(reader["Height"]);

                            if (reader["Width"] != DBNull.Value)
                                warehouseLocation.Width = Convert.ToDouble(reader["Width"]);

                            warehouseLocationList.Add(warehouseLocation);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetAllWarehouseLocationById(). idWarehouse-{0} ErrorMessage- {1}", idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }
            return warehouseLocationList;
        }

        /// <summary>
        /// This method is to get warehouse stock details related to id article and id warehouse
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idArticle">Get id article</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <returns>My warehouse details</returns>
        public MyWarehouse GetWarehouseStockDetailsByArticleAndWarehouse(string connectionString, Int32 idArticle, Int64 idWarehouse)
        {
            MyWarehouse myWarehouse = new MyWarehouse();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("warehouse_GetWarehouseStockDetailsByArticleAndWarehouse", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", idArticle);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        try
                        {
                            if (reader["idArticle"] != DBNull.Value)
                                myWarehouse.IdArticle = Convert.ToInt32(reader["idArticle"]);

                            if (reader["IdWarehouse"] != DBNull.Value)
                                myWarehouse.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                            if (reader["MinimumStock"] != DBNull.Value)
                                myWarehouse.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);

                            if (reader["MaximumStock"] != DBNull.Value)
                                myWarehouse.MaximumStock = Convert.ToInt64(reader["MaximumStock"]);

                            if (reader["CurrentStock"] != DBNull.Value)
                                myWarehouse.CurrentStock = Convert.ToInt64(reader["CurrentStock"]);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleStockByWarehouse(). idArticle- {0} idWarehouse-{1} ErrorMessage- {2}", idArticle, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return myWarehouse;
        }

        /// <summary>
        /// This method is to get warehouse purchase order details related to code
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="code">Get code details</param>
        /// <returns>Warehouse purchase order details</returns>
        public WarehousePurchaseOrder GetWarehousePODetailsByCode(string connectionString, string code)
        {
            WarehousePurchaseOrder warehousePurchaseOrder = new WarehousePurchaseOrder();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("warehousepurchaseorders_GetWarehousePODetailByCode", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_Code", code);


                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        try
                        {
                            if (reader["IdWarehousePurchaseOrder"] != DBNull.Value)
                                warehousePurchaseOrder.IdWarehousePurchaseOrder = Convert.ToInt64(reader["IdWarehousePurchaseOrder"]);

                            if (reader["Code"] != DBNull.Value)
                                warehousePurchaseOrder.Code = reader["Code"].ToString();

                            if (reader["IdArticleSupplier"] != DBNull.Value)
                                warehousePurchaseOrder.IdArticleSupplier = Convert.ToInt64(reader["IdArticleSupplier"]);

                            if (reader["DeliveryDate"] != DBNull.Value)
                                warehousePurchaseOrder.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);

                            if (reader["Comments"] != DBNull.Value)
                                warehousePurchaseOrder.Comments = reader["Comments"].ToString();

                            if (reader["CreatedIn"] != DBNull.Value)
                                warehousePurchaseOrder.CreatedIn = Convert.ToDateTime(reader["CreatedIn"]);

                            if (reader["CreatedBy"] != DBNull.Value)
                                warehousePurchaseOrder.CreatedBy = Convert.ToInt64(reader["CreatedBy"]);

                            if (reader["ModifiedIn"] != DBNull.Value)
                                warehousePurchaseOrder.ModifiedIn = Convert.ToDateTime(reader["ModifiedIn"]);

                            if (reader["ModifiedBy"] != DBNull.Value)
                                warehousePurchaseOrder.ModifiedBy = Convert.ToInt64(reader["ModifiedBy"]);

                            if (reader["IsClosed"] != DBNull.Value)
                                warehousePurchaseOrder.IsClosed = Convert.ToByte(reader["IsClosed"]);

                            if (reader["IdWarehouse"] != DBNull.Value)
                                warehousePurchaseOrder.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                            if (reader["idCurrency"] != DBNull.Value)
                                warehousePurchaseOrder.IdCurrency = Convert.ToByte(reader["idCurrency"]);

                            if (reader["AttachedPO"] != DBNull.Value)
                                warehousePurchaseOrder.AttachedPO = Convert.ToByte(reader["AttachedPO"]);

                            if (reader["ReminderEmailDate"] != DBNull.Value)
                                warehousePurchaseOrder.ReminderEmailDate = Convert.ToDateTime(reader["ReminderEmailDate"]);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetWarehousePODetailsByCode(). code- {0} IdWarehousePurchaseOrder-{1} ErrorMessage- {2}", code, warehousePurchaseOrder.IdWarehousePurchaseOrder, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return warehousePurchaseOrder;
        }

        /// <summary>
        /// This method is to get article details related to reference
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="reference">Get article reference</param>
        /// <param name="articleVisualAidsPath">Get article image path</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="fromDate">Get from date</param>
        /// <param name="toDate">Get to date</param>
        /// <returns>Article details</returns>
        public Article GetArticleDetailsByReference(string connectionString, string reference, string articleVisualAidsPath, Int64 idWarehouse, DateTime? fromDate = null, DateTime? toDate = null)
        {
            Article article = new Article();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("article_GetArticleDetailsByReference", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_Reference", reference);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        try
                        {
                            if (reader["idArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(reader["idArticle"]);

                            if (reader["IdArticleCategory"] != DBNull.Value)
                            {
                                article.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory = new ArticleCategory();
                                article.ArticleCategory.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory.Name = Convert.ToString(reader["categoryName"]);
                                article.ArticleCategory.TaricCode = Convert.ToString(reader["TaricCode"]);
                            }

                            if (reader["ImagePath"] != DBNull.Value)
                            {
                                article.ImagePath = Convert.ToString(reader["ImagePath"]);

                                if (!string.IsNullOrEmpty(article.ImagePath))
                                    article.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, article);
                            }

                            if (reader["Reference"] != DBNull.Value)
                                article.Reference = reader["Reference"].ToString();

                            if (reader["IsOrientativeVisualAid"] != DBNull.Value)
                                article.IsOrientativeVisualAid = Convert.ToByte(reader["IsOrientativeVisualAid"]);

                            if (reader["IsGeneric"] != DBNull.Value)
                                article.IsGeneric = Convert.ToSByte(reader["IsGeneric"]);

                            if (reader["isObsolete"] != DBNull.Value)
                                article.IsObsolete = Convert.ToSByte(reader["isObsolete"]);

                            if (reader["isPublic"] != DBNull.Value)
                                article.IsPublic = Convert.ToSByte(reader["isPublic"]);

                            if (reader["publishOnWeb"] != DBNull.Value)
                                article.PublishOnWeb = Convert.ToSByte(reader["publishOnWeb"]);

                            if (reader["registerSerialNumber"] != DBNull.Value)
                                article.RegisterSerialNumber = Convert.ToByte(reader["registerSerialNumber"]);

                            if (reader["CreatedIn"] != DBNull.Value)
                                article.CreatedIn = Convert.ToDateTime(reader["CreatedIn"]);

                            if (reader["ModifiedIn"] != DBNull.Value)
                                article.ModifiedIn = Convert.ToDateTime(reader["ModifiedIn"]);

                            if (reader["description"] != DBNull.Value)
                                article.Description = Convert.ToString(reader["description"]);

                            if (reader["description_es"] != DBNull.Value)
                                article.Description_es = Convert.ToString(reader["description_es"]);

                            if (reader["description_fr"] != DBNull.Value)
                                article.Description_fr = Convert.ToString(reader["description_fr"]);

                            if (reader["description_pt"] != DBNull.Value)
                                article.Description_pt = Convert.ToString(reader["description_pt"]);

                            if (reader["description_ro"] != DBNull.Value)
                                article.Description_ro = Convert.ToString(reader["description_ro"]);

                            if (reader["description_ru"] != DBNull.Value)
                                article.Description_ru = Convert.ToString(reader["description_ru"]);

                            if (reader["description_zh"] != DBNull.Value)
                                article.Description_zh = Convert.ToString(reader["description_zh"]);

                            if (reader["idReplacementArticle"] != DBNull.Value)
                            {
                                article.IdReplacementArticle = Convert.ToInt32(reader["idReplacementArticle"]);
                                article.ReplacementArticle = Convert.ToString(reader["ReplacementArticle"]);
                            }

                            if (reader["isBatch"] != DBNull.Value)
                                article.IsBatch = Convert.ToByte(reader["isBatch"]);

                            if (reader["taric"] != DBNull.Value)
                                article.Taric = Convert.ToString(reader["taric"]);

                            if (reader["IdArticleType"] != DBNull.Value)
                            {
                                article.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                article.ArticlesType = new ArticleType();
                                article.ArticlesType.IdArticleType = Convert.ToInt64(reader["IdArticleType"]); ;
                            }


                            if (reader["Weight"] != DBNull.Value)
                                article.Weight = Convert.ToDecimal(reader["Weight"]);

                            if (reader["Width"] != DBNull.Value)
                                article.Width = (float)(reader["Width"]);

                            if (reader["Length"] != DBNull.Value)
                                article.Length = (float)(reader["Length"]);

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)(reader["Height"]);

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)(reader["Height"]);

                            if (reader["idCountry"] != DBNull.Value)
                            {
                                article.IdCountry = Convert.ToInt32(reader["idCountry"]);

                                article.Country = new Country();
                                article.Country.IdCountry = Convert.ToByte(reader["idCountry"]);
                                article.Country.Name = Convert.ToString(reader["CountryName"]);
                            }

                            article.MyWarehouse = new MyWarehouse();

                            if (reader["minimumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MinimumStock = Convert.ToInt64(reader["minimumStock"]);
                            }

                            if (reader["stock"] != DBNull.Value)
                            {
                                article.MyWarehouse.CurrentStock = Convert.ToInt64(reader["stock"]);
                            }

                            if (reader["maximumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MaximumStock = Convert.ToInt64(reader["maximumStock"]);
                            }

                            if (reader["idWareHouse"] != DBNull.Value)
                            {
                                article.MyWarehouse.IdWarehouse = Convert.ToInt64(reader["idWareHouse"]);
                            }

                            if (reader["location"] != DBNull.Value)
                            {
                                article.MyWarehouse.Location = Convert.ToString(reader["location"]);
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleDetailsByIdArticle(). Reference- {0} IdArticle-{1} ErrorMessage- {2}", reference, article.IdArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
                article.LstArticleBySupplier = new List<ArticleBySupplier>();
                article.LstArticleBySupplier = GetArticleSupplierDetailsByIdArticle(connectionString, article.IdArticle);

                article.LstArticleDecomposition = new List<ArticleDecomposition>();
                article.LstArticleDecomposition = GetArticleDeCompostionByIdArticle(connectionString, article.IdArticle);

                article.LstRelatedArticle = new List<RelatedArticle>();
                article.LstRelatedArticle = GetRelatedArticleDetailsByIdArticle(connectionString, article.IdArticle, idWarehouse);

                article.LstArticleDocument = new List<ArticleDocument>();
                article.LstArticleDocument = GetArticleAttachmentByIdArticle(connectionString, article.IdArticle);

                article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle(connectionString, article.IdArticle, idWarehouse);

                article.LstManufacturersByArticles = new List<ManufacturersByArticle>();
                article.LstManufacturersByArticles = GetManufacturers(connectionString, article.IdArticle);

                //if (fromDate != null && toDate != null)
                //{
                article.LstArticlesStock = new List<ArticlesStock>();
                article.LstArticlesStock = GetStockHistoryByIdArticle(connectionString, article.IdArticle, DateTime.Now, DateTime.Now, idWarehouse);
                // }

            }

            return article;
        }

        /// <summary>
        /// This method is to get article supplier details related to id article
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idArticle">Get id article</param>
        /// <returns>List of article by supplier details</returns>
        public List<ArticleBySupplier> GetArticleSupplierDetailsByIdArticle(string connectionString, Int32 idArticle)
        {
            List<ArticleBySupplier> articleBySupplierLst = new List<ArticleBySupplier>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("articlesbysupplier_GetArticleSupplierDetailsByIdArticle", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", idArticle);


                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ArticleBySupplier articleBySupplier = new ArticleBySupplier();
                        try
                        {
                            if (reader["idarticlesupplier"] != DBNull.Value)
                            {
                                articleBySupplier.IdArticleSupplier = Convert.ToInt64(reader["idarticlesupplier"]);
                                articleBySupplier.ArticleSupplier = new ArticleSupplier();
                                articleBySupplier.ArticleSupplier.IdArticleSupplier = Convert.ToInt64(reader["idarticlesupplier"]);
                            }


                            if (reader["idarticlesupplier"] != DBNull.Value)
                            {
                                articleBySupplier.ArticleSupplier = new ArticleSupplier();
                                articleBySupplier.ArticleSupplier.IdArticleSupplier = Convert.ToInt64(reader["idarticlesupplier"]);
                                //articleBySupplier.ArticleSupplier.Serie = Convert.ToChar(reader["serie"]);

                                //if (reader["idpaymenttype"] != DBNull.Value)
                                //{
                                //    articleBySupplier.ArticleSupplier.IdPaymentType = Convert.ToInt64(reader["idpaymenttype"]);
                                //}

                                if (reader["idarticlesuppliertype"] != DBNull.Value)
                                {
                                    articleBySupplier.ArticleSupplier.IdArticleSupplierType = Convert.ToInt32(reader["idarticlesuppliertype"]);

                                    articleBySupplier.ArticleSupplier.ArticleSupplierType = new ArticleSupplierType();
                                    articleBySupplier.ArticleSupplier.ArticleSupplierType.IdArticleSupplierType = Convert.ToInt32(reader["idarticlesuppliertype"]);
                                    articleBySupplier.ArticleSupplier.ArticleSupplierType.Name = Convert.ToString(reader["ArticleSupplierType"]);
                                    articleBySupplier.ArticleSupplier.ArticleSupplierType.HtmlColor = Convert.ToString(reader["htmlcolor"]);
                                }

                                articleBySupplier.ArticleSupplier.Name = Convert.ToString(reader["name"]);
                                //articleBySupplier.ArticleSupplier.Address = Convert.ToString(reader["address"]);
                                //articleBySupplier.ArticleSupplier.PostCode = Convert.ToString(reader["postcode"]);
                                //articleBySupplier.ArticleSupplier.BankName = Convert.ToString(reader["bankName"]);
                                //articleBySupplier.ArticleSupplier.AccountNumber = Convert.ToString(reader["accountNumber"]);
                                //articleBySupplier.ArticleSupplier.Iban = Convert.ToString(reader["iban"]);
                                //articleBySupplier.ArticleSupplier.Swift = Convert.ToString(reader["swift"]);
                                //articleBySupplier.ArticleSupplier.DefaultText = Convert.ToString(reader["defaultText"]);

                                //articleBySupplier.ArticleSupplier.City = Convert.ToString(reader["city"]);
                                //articleBySupplier.ArticleSupplier.Cif = Convert.ToString(reader["cif"]);

                                if (reader["idcountry"] != DBNull.Value)
                                {
                                    articleBySupplier.ArticleSupplier.IdCountry = Convert.ToInt64(reader["idcountry"]);
                                    articleBySupplier.ArticleSupplier.Country = new Country();
                                    articleBySupplier.ArticleSupplier.Country.IdCountry = Convert.ToByte(reader["idcountry"]);
                                    articleBySupplier.ArticleSupplier.Country.Name = Convert.ToString(reader["CountryName"]);

                                }

                                //if (reader["deliveryDays"] != DBNull.Value)
                                //{
                                //    articleBySupplier.ArticleSupplier.DeliveryDays = Convert.ToInt64(reader["deliveryDays"]);
                                //}

                                //if (reader["idAgency"] != DBNull.Value)
                                //{
                                //    articleBySupplier.ArticleSupplier.IdAgency = Convert.ToInt32(reader["idAgency"]);
                                //}

                                //if (reader["idTransportType"] != DBNull.Value)
                                //{
                                //    articleBySupplier.ArticleSupplier.IdTransportType = Convert.ToInt64(reader["idTransportType"]);
                                //}

                                //if (reader["isstillactive"] != DBNull.Value)
                                //{
                                //    articleBySupplier.ArticleSupplier.IsStillActive = Convert.ToSByte(reader["isstillactive"]);
                                //}

                                //articleBySupplier.ArticleSupplier.Phone1 = Convert.ToString(reader["phone1"]);
                                //articleBySupplier.ArticleSupplier.Phone2 = Convert.ToString(reader["phone2"]);
                                //articleBySupplier.ArticleSupplier.Fax = Convert.ToString(reader["fax"]);
                                //articleBySupplier.ArticleSupplier.Email = Convert.ToString(reader["email"]);
                                //articleBySupplier.ArticleSupplier.Web = Convert.ToString(reader["web"]);
                                //articleBySupplier.ArticleSupplier.Observations = Convert.ToString(reader["observations"]);
                                //articleBySupplier.ArticleSupplier.ContactPerson = Convert.ToString(reader["contactPerson"]);
                                //articleBySupplier.ArticleSupplier.ContactMobile = Convert.ToString(reader["contactMobile"]);
                                //articleBySupplier.ArticleSupplier.ContactEmail = Convert.ToString(reader["contactEmail"]);

                                //if (reader["createdIn"] != DBNull.Value)
                                //{
                                //    articleBySupplier.ArticleSupplier.CreatedIn = Convert.ToDateTime(reader["createdIn"]);
                                //}

                                //if (reader["modifiedIn"] != DBNull.Value)
                                //{
                                //    articleBySupplier.ArticleSupplier.ModifiedIn = Convert.ToDateTime(reader["modifiedIn"]);
                                //}

                                //if (reader["lastOrder"] != DBNull.Value)
                                //{
                                //    articleBySupplier.ArticleSupplier.WarehousePurchaseOrder = new WarehousePurchaseOrder();
                                //    articleBySupplier.ArticleSupplier.WarehousePurchaseOrder.CreatedIn = Convert.ToDateTime(reader["lastOrder"]);
                                //}

                                //if (reader["idsite"] != DBNull.Value)
                                //{
                                //    articleBySupplier.ArticleSupplier.SupplierBySite = new SupplierBySite();
                                //    articleBySupplier.ArticleSupplier.SupplierBySite.IdArticleSupplier = Convert.ToInt64(reader["idarticlesupplier"]);
                                //    articleBySupplier.ArticleSupplier.SupplierBySite.IdSite = Convert.ToInt32(reader["IdSite"]);
                                //}


                            }

                            //if (reader["CurrencyId"] != DBNull.Value)
                            //{
                            //    articleBySupplier.IdCurrency = Convert.ToByte(reader["CurrencyId"]);
                            //    articleBySupplier.Currency = new Currency();
                            //    articleBySupplier.Currency.IdCurrency = Convert.ToByte(reader["CurrencyId"]);
                            //    articleBySupplier.Currency.Name = Convert.ToString(reader["CurrencyName"]);
                            //    articleBySupplier.Currency.Symbol = Convert.ToString(reader["currencySymbol"]);
                            //}

                            articleBySupplier.Reference = Convert.ToString(reader["reference"]);
                            articleBySupplier.Description = Convert.ToString(reader["description"]);

                            if (reader["isthefavorite"] != DBNull.Value)
                            {
                                articleBySupplier.IsTheFavorite = Convert.ToByte(reader["isthefavorite"]);
                            }

                            if (reader["PurchaseQty"] != DBNull.Value)
                            {
                                articleBySupplier.PurchaseQty = Convert.ToInt64(reader["PurchaseQty"]);
                            }


                            //if (reader["baseprice"] != DBNull.Value)
                            //{
                            //    articleBySupplier.BasePrice = Convert.ToDouble(reader["baseprice"]);
                            //}

                            //if (reader["costprice"] != DBNull.Value)
                            //{
                            //    articleBySupplier.CostPrice = Convert.ToDouble(reader["costprice"]);
                            //}

                            //if (reader["discount"] != DBNull.Value)
                            //{
                            //    articleBySupplier.Discount = Convert.ToDouble(reader["discount"]);
                            //}

                            //if (reader["iva"] != DBNull.Value)
                            //{
                            //    articleBySupplier.IVA = Convert.ToDouble(reader["iva"]);
                            //}

                            //if (reader["purchaseqty"] != DBNull.Value)
                            //{
                            //    articleBySupplier.PurchaseQty = Convert.ToInt64(reader["purchaseqty"]);
                            //}

                            //if (reader["OverCost"] != DBNull.Value)
                            //{
                            //    articleBySupplier.OverCost = Convert.ToInt64(reader["OverCost"]);
                            //}

                            //if (reader["FixedPrice"] != DBNull.Value)
                            //{
                            //    articleBySupplier.FixedPrice = Convert.ToByte(reader["FixedPrice"]);
                            //}

                            //if (reader["ForcePurchaseQty"] != DBNull.Value)
                            //{
                            //    articleBySupplier.ForcePurchaseQty = Convert.ToByte(reader["ForcePurchaseQty"]);
                            //}


                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleSupplierDetailsByIdArticle(). IdArticle- {0} Idarticlesupplier-{1}  ErrorMessage- {2}", idArticle, articleBySupplier.IdArticleSupplier, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                        articleBySupplierLst.Add(articleBySupplier);
                    }

                }
            }

            return articleBySupplierLst;
        }

        /// <summary>
        /// This method is to get related article details related to id article
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idArticle">Get id article </param>
        /// <param name="_IdWarehouse">Get id warehouse</param>
        /// <returns>List of related article details</returns>
        public List<RelatedArticle> GetRelatedArticleDetailsByIdArticle(string connectionString, Int32 idArticle, Int64 _IdWarehouse)
        {
            List<RelatedArticle> relatedArticleLst = new List<RelatedArticle>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("articles_GetRelatedArticleDetailsByIdArticle", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", idArticle);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", _IdWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        RelatedArticle relatedArticle = new RelatedArticle();
                        try
                        {
                            if (reader["IdArticle"] != DBNull.Value)
                            {
                                relatedArticle.IdArticle = Convert.ToInt64(reader["IdArticle"]);
                                relatedArticle.Reference = Convert.ToString(reader["Reference"]);
                                relatedArticle.Description = Convert.ToString(reader["Description"]);
                            }


                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRelatedArticleDetailsByIdArticle(). Related Article Reference- {0} IdArticle-{1}  ErrorMessage- {2}", relatedArticle.Reference, relatedArticle.IdArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                        relatedArticleLst.Add(relatedArticle);
                    }

                }
            }

            return relatedArticleLst;
        }

        //public List<ArticleDecomposition> GetArticleDeCompostionByIdArticle(string connectionString, Int32 idArticle)
        //{
        //    List<ArticleDecomposition> articleDecompositionLst = new List<ArticleDecomposition>();

        //    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
        //    {
        //        mySqlConnection.Open();

        //        MySqlCommand mySqlCommand = new MySqlCommand("articles_GetArticleDeCompostionByIdArticle", mySqlConnection);
        //        mySqlCommand.CommandType = CommandType.StoredProcedure;
        //        mySqlCommand.Parameters.AddWithValue("_IdArticle", idArticle);


        //        using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
        //        {
        //            while (reader.Read())
        //            {
        //                ArticleDecomposition articleDecomposition = new ArticleDecomposition();
        //                try
        //                {
        //                    if (reader["IdArticle"] != DBNull.Value)
        //                    {
        //                        articleDecomposition.IdArticle = Convert.ToInt64(reader["IdArticle"]);
        //                        articleDecomposition.Reference = Convert.ToString(reader["Reference"]);
        //                        articleDecomposition.Description = Convert.ToString(reader["Description"]);
        //                    }


        //                }
        //                catch (Exception ex)
        //                {
        //                    Log4NetLogger.Logger.Log(string.Format("Error GetArticleDeCompostionByIdArticle(). Reference- {0} IdArticle-{1}  ErrorMessage- {2}", articleDecomposition.Reference, articleDecomposition.IdArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
        //                    throw;
        //                }
        //                articleDecompositionLst.Add(articleDecomposition);
        //            }

        //        }
        //    }

        //    return articleDecompositionLst;
        //}

        /// <summary>
        /// This method is to get article decomposed related to id article
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idArticle">Get id article</param>
        /// <returns>List of article decomposed</returns>
        public List<ArticleDecomposition> GetArticleDeCompostionByIdArticle(string connectionString, Int32 idArticle)
        {
            List<ArticleDecomposition> articleDecompositionLst = new List<ArticleDecomposition>();
            DataTable dtfinal = new DataTable();

            GetArticleDeCompostionByIdArticle(connectionString, idArticle.ToString(), dtfinal);

            foreach (DataRow item in DataTableArticleDecompostion.Rows)
            {
                ArticleDecomposition articleDecomposition = new ArticleDecomposition();

                try
                {
                    if (item["IdArticle"] != DBNull.Value)
                    {
                        articleDecomposition.IdArticle = Convert.ToInt64(item["IdArticle"]);
                        articleDecomposition.Reference = Convert.ToString(item["Reference"]);
                        articleDecomposition.Description = Convert.ToString(item["Description"]);

                        if (item["articlebyarticle"] != DBNull.Value)
                        {
                            articleDecomposition.IdParent = Convert.ToInt64(item["articlebyarticle"]);
                        }
                    }

                    if (item["quantity"] != DBNull.Value)
                    {
                        articleDecomposition.Quantity = (float)(item["quantity"]);
                    }

                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error GetArticleDeCompostionByIdArticle(). Reference- {0} IdArticle-{1}  ErrorMessage- {2}", articleDecomposition.Reference, articleDecomposition.IdArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }

                articleDecompositionLst.Add(articleDecomposition);
            }

            return articleDecompositionLst;
        }

        /// <summary>
        /// This method is to get article decompostion related to id article
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idArticle">Get selected id articles</param>
        /// <param name="dt">Datatable</param>
        public void GetArticleDeCompostionByIdArticle(string connectionString, string idArticle, DataTable dt)
        {

            List<ArticleDecomposition> articleDecompositionLst = new List<ArticleDecomposition>();
            DataTable dttemp = new DataTable();
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("articles_GetSelectedArticleDeCompostionByIdArticle", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", idArticle);

                MySqlDataAdapter da = new MySqlDataAdapter(mySqlCommand);

                da.Fill(dttemp);

            }

            if (dttemp == null || dttemp.Rows.Count == 0)
            {
                if (dt == null)
                {
                    dt = dttemp;
                }
                DataTableArticleDecompostion = new DataTable();
                DataTableArticleDecompostion = dt;
                return;
            }
            else
            {
                if (dt == null || dt.Rows.Count == 0)
                {
                    dt = dttemp;
                    List<string> starticles = new List<string>();
                    foreach (DataRow item in dttemp.Rows)
                    {
                        starticles.Add(item[0].ToString());
                    }
                    idArticle = string.Join(",", starticles);
                }
                else
                {
                    List<string> starticles = new List<string>();
                    foreach (DataRow item in dttemp.Rows)
                    {

                        DataRow dr = dt.NewRow();

                        dr[0] = item[0];
                        dr[1] = item[1];
                        dr[2] = item[2];
                        dr[3] = item[3];
                        dr[4] = item[4];

                        dt.Rows.Add(dr);

                        starticles.Add(item[0].ToString());

                    }
                    idArticle = string.Join(",", starticles);
                }

                GetArticleDeCompostionByIdArticle(connectionString, idArticle, dt);
            }
        }

        /// <summary>
        /// This method is to get artilce attachment related to id article
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idArticle">Get id article </param>
        /// <returns>List of article document details</returns>
        public List<ArticleDocument> GetArticleAttachmentByIdArticle(string connectionString, Int32 idArticle)
        {
            List<ArticleDocument> articleDocumentLst = new List<ArticleDocument>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("articledocs_GetArticleAttachmentDetailsByIdArticle", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", idArticle);


                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ArticleDocument articleDocument = new ArticleDocument();
                        try
                        {
                            if (reader["IdArticleDoc"] != DBNull.Value)
                            {
                                articleDocument.IdArticleDoc = Convert.ToInt64(reader["IdArticleDoc"]);
                            }

                            if (reader["IdArticle"] != DBNull.Value)
                            {
                                articleDocument.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                            }

                            articleDocument.OriginalFileName = Convert.ToString(reader["OriginalFileName"]);
                            articleDocument.SavedFileName = Convert.ToString(reader["SavedFileName"]);
                            articleDocument.Description = Convert.ToString(reader["Description"]);

                            if (reader["CreatedIn"] != DBNull.Value)
                            {
                                articleDocument.CreatedIn = Convert.ToDateTime(reader["CreatedIn"]);
                            }

                            if (reader["ModifiedIn"] != DBNull.Value)
                            {
                                articleDocument.ModifiedIn = Convert.ToDateTime(reader["ModifiedIn"]);
                            }

                            if (reader["ModifiedBy"] != DBNull.Value)
                            {
                                articleDocument.ModifiedBy = Convert.ToInt32(reader["ModifiedBy"]);

                                articleDocument.DocumentModifiedBy = new People();
                                articleDocument.DocumentModifiedBy.IdPerson = Convert.ToInt32(reader["ModifiedBy"]);
                                articleDocument.DocumentModifiedBy.Name = Convert.ToString(reader["ModifiedByName"]);
                                articleDocument.DocumentModifiedBy.Surname = Convert.ToString(reader["ModifiedBySurname"]);

                                if (reader["ModifiedByIdSite"] != DBNull.Value)
                                {
                                    articleDocument.DocumentModifiedBy.Company = new Company();
                                    articleDocument.DocumentModifiedBy.Company.IdCompany = Convert.ToInt32(reader["ModifiedByIdSite"]);
                                    articleDocument.DocumentModifiedBy.Company.Name = Convert.ToString(reader["ModifiedBySiteName"]);
                                }
                            }

                            if (reader["CreatedBy"] != DBNull.Value)
                            {
                                articleDocument.CreatedBy = Convert.ToInt32(reader["CreatedBy"]);

                                articleDocument.DocumentCreatedBy = new People();
                                articleDocument.DocumentCreatedBy.IdPerson = Convert.ToInt32(reader["CreatedBy"]);
                                articleDocument.DocumentCreatedBy.Name = Convert.ToString(reader["CreatedByName"]);
                                articleDocument.DocumentCreatedBy.Surname = Convert.ToString(reader["CreatedBySurname"]);

                                if (reader["CreatedByIdSite"] != DBNull.Value)
                                {
                                    articleDocument.DocumentCreatedBy.Company = new Company();
                                    articleDocument.DocumentCreatedBy.Company.IdCompany = Convert.ToInt32(reader["CreatedByIdSite"]);
                                    articleDocument.DocumentCreatedBy.Company.Name = Convert.ToString(reader["CreatedBySiteName"]);
                                }

                            }

                            if (reader["idDocType"] != DBNull.Value)
                            {
                                articleDocument.IdDocType = Convert.ToInt64(reader["idDocType"]);
                                articleDocument.ArticleDocumentType = new ArticleDocumentType();
                                articleDocument.ArticleDocumentType.IdDocType = Convert.ToInt64(reader["idDocType"]);
                                articleDocument.ArticleDocumentType.DocumentType = Convert.ToString(reader["DocumentType"]);
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleAttachmentByIdArticle(). IdArticleDoc- {0} IdArticle-{1}  ErrorMessage- {2}", articleDocument.IdArticleDoc, articleDocument.IdArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                        articleDocumentLst.Add(articleDocument);
                    }

                }
            }

            return articleDocumentLst;
        }


        /// <summary>
        /// This method is to get article warehouse location stock related to id article
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idArticle">Get id article</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <returns>List of article warehouse location details</returns>
        public List<ArticleWarehouseLocations> GetArticleWarehouseLocationStockByIdArticle(string connectionString, Int32 idArticle, Int64 idWarehouse)
        {
            List<ArticleWarehouseLocations> articleWarehouseLocationLst = new List<ArticleWarehouseLocations>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("warehouselocations_GetArticleWarehouseLocationStockByIdArticle", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", idArticle);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ArticleWarehouseLocations articleWarehouseLocation = new ArticleWarehouseLocations();
                        try
                        {
                            if (reader["ArticleWLPostion"] != DBNull.Value)
                            {
                                articleWarehouseLocation.Position = Convert.ToInt64(reader["ArticleWLPostion"]);
                            }

                            articleWarehouseLocation.IdArticle = idArticle;

                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                articleWarehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);
                                articleWarehouseLocation.WarehouseLocation = new WarehouseLocation();
                                articleWarehouseLocation.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                                if (reader["Position"] != DBNull.Value)
                                    articleWarehouseLocation.WarehouseLocation.Position = Convert.ToInt64(reader["Position"]);

                                if (reader["FullName"] != DBNull.Value)
                                    articleWarehouseLocation.WarehouseLocation.FullName = Convert.ToString(reader["FullName"]);
                            }

                            if (reader["Qty"] != DBNull.Value)
                            {
                                articleWarehouseLocation.ArticlesStock = new ArticlesStock();

                                articleWarehouseLocation.ArticlesStock.IdWarehouseLocation = Convert.ToUInt64(reader["IdWarehouseLocation"]);
                                articleWarehouseLocation.ArticlesStock.Quantity = Convert.ToInt64(reader["Qty"]);
                            }

                            if (reader["MinimumStock"] != DBNull.Value)
                            {
                                articleWarehouseLocation.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);
                            }
                            if (reader["MaximumStock"] != DBNull.Value)
                            {
                                articleWarehouseLocation.MaximumStock = Convert.ToInt64(reader["MaximumStock"]);
                            }
                            articleWarehouseLocation.WarehouseDeliveryNotes = new List<WarehouseDeliveryNote>();

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleWarehouseLocationStockByIdArticle(). IdArticle- {0} IdWarehouseLocation-{1}  ErrorMessage- {2}", articleWarehouseLocation.IdArticle, articleWarehouseLocation.IdWarehouseLocation, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                        articleWarehouseLocationLst.Add(articleWarehouseLocation);
                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                if (articleWarehouseLocationLst != null)
                                {
                                    if (articleWarehouseLocationLst.Any(i => i.IdWarehouseLocation == Convert.ToInt64(reader["IdWarehouseLocation"])))
                                    {
                                        ArticleWarehouseLocations articleWarehouseLocations = articleWarehouseLocationLst.Where(i => i.IdWarehouseLocation == Convert.ToInt64(reader["IdWarehouseLocation"])).FirstOrDefault();
                                        if (articleWarehouseLocations != null)
                                        {
                                            WarehouseDeliveryNote warehouseDeliveryNote = new WarehouseDeliveryNote();
                                            if (reader["DeliveryDate"] != DBNull.Value)
                                                warehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                            if (reader["Code"] != DBNull.Value)
                                                warehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                            if (reader["Quantity"] != DBNull.Value)
                                                warehouseDeliveryNote.Quantity = Convert.ToInt64(reader["Quantity"]);
                                            if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                                                warehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["idWarehouseDeliveryNote"]);

                                            if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                            {
                                                warehouseDeliveryNote.WarehouseDeliveryNoteItems = new List<WarehouseDeliveryNoteItem>();
                                                WarehouseDeliveryNoteItem warehouseDeliveryNoteItem = new WarehouseDeliveryNoteItem();
                                                warehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);
                                                warehouseDeliveryNote.WarehouseDeliveryNoteItems.Add(warehouseDeliveryNoteItem);
                                            }


                                            warehouseDeliveryNote.MasterItem = articleWarehouseLocations;
                                            articleWarehouseLocations.WarehouseDeliveryNotes.Add(warehouseDeliveryNote);
                                        }
                                    }
                                }
                            }
                        }
                    }

                }
            }

            return articleWarehouseLocationLst;
        }

        /// <summary>
        /// This method is to get all warehouse locations related to id warehouse
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <returns>List of warehouse location details</returns>
        public List<WarehouseLocation> GetAllWarehouseLocationsByIdWarehouse(string connectionString, Int64 idWarehouse)
        {
            List<WarehouseLocation> warehouseLocationLst = new List<WarehouseLocation>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("warehouselocations_GetAllWarehouseLocationsByIdWarehouse", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;

                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        WarehouseLocation warehouseLocation = new WarehouseLocation();
                        try
                        {
                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                warehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                                if (reader["Position"] != DBNull.Value)
                                {
                                    warehouseLocation.Position = Convert.ToInt64(reader["Position"]);
                                }

                                if (reader["IdWarehouse"] != DBNull.Value)
                                {
                                    warehouseLocation.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);
                                }

                                if (reader["Parent"] != DBNull.Value)
                                {
                                    warehouseLocation.Parent = Convert.ToInt64(reader["Parent"]);
                                }

                                if (reader["FullName"] != DBNull.Value)
                                {
                                    warehouseLocation.FullName = Convert.ToString(reader["FullName"]);
                                }

                                if (reader["IsLead"] != DBNull.Value)
                                {
                                    warehouseLocation.IsLead = Convert.ToSByte(reader["IsLead"]);
                                }

                                if (reader["HtmlColor"] != DBNull.Value)
                                {
                                    warehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);
                                }

                                if (reader["Latitude"] != DBNull.Value)
                                {
                                    warehouseLocation.Latitude = Convert.ToDouble(reader["Latitude"]);
                                }

                                if (reader["Longitude"] != DBNull.Value)
                                {
                                    warehouseLocation.Longitude = Convert.ToDouble(reader["Longitude"]);
                                }

                                if (reader["Height"] != DBNull.Value)
                                {
                                    warehouseLocation.Height = Convert.ToDouble(reader["Height"]);
                                }

                                if (reader["Width"] != DBNull.Value)
                                {
                                    warehouseLocation.Width = Convert.ToDouble(reader["Width"]);
                                }
                            }


                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error warehouselocations_GetAllWarehouseLocationsByIdWarehouse(). IdWarehouse- {0} IdWarehouseLocation-{1}  ErrorMessage- {2}", warehouseLocation.IdWarehouse, warehouseLocation.IdWarehouseLocation, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                        warehouseLocationLst.Add(warehouseLocation);
                    }

                }
            }

            return warehouseLocationLst;
        }

        /// <summary>
        /// This method is to add artilce warehouse location 
        /// </summary>
        /// <param name="mainServerConnectionString">Get main server connection string (geos db)</param>
        /// <param name="articleWarehouseLocations">Get list of article warehouse locations details</param>
        /// <returns>Added list of article warehouse locations details</returns>
        public List<ArticleWarehouseLocations> AddArticleWarehouseLocation(string mainServerConnectionString, List<ArticleWarehouseLocations> articleWarehouseLocations)
        {
            if (articleWarehouseLocations != null)
            {
                foreach (ArticleWarehouseLocations articleWarehouseLocation in articleWarehouseLocations)
                {
                    if (articleWarehouseLocation.IsLocationDeleted)
                    {
                        TransactionScope transactionScope = null;
                        try
                        {
                            using (transactionScope = new TransactionScope())
                            {
                                using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                                {
                                    mySqlConnection.Open();

                                    MySqlCommand mySqlCommand = new MySqlCommand("article_warehouse_locations_Delete", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                                    mySqlCommand.Parameters.AddWithValue("_IdWarehouseLocation", articleWarehouseLocation.IdWarehouseLocation);
                                    mySqlCommand.Parameters.AddWithValue("_IdArticle", articleWarehouseLocation.IdArticle);

                                    mySqlCommand.ExecuteNonQuery();
                                    mySqlConnection.Close();
                                }


                                transactionScope.Complete();
                            }
                        }
                        catch (Exception ex)
                        {
                            if (Transaction.Current != null)
                                Transaction.Current.Rollback();

                            if (transactionScope != null)
                                transactionScope.Dispose();

                            throw;
                        }
                    }
                    else
                    {
                        TransactionScope transactionScope = null;
                        try
                        {
                            using (transactionScope = new TransactionScope())
                            {
                                using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                                {
                                    mySqlConnection.Open();

                                    MySqlCommand mySqlCommand = new MySqlCommand("article_warehouse_locations_Insert", mySqlConnection);
                                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                                    mySqlCommand.Parameters.AddWithValue("_IdWarehouseLocation", articleWarehouseLocation.IdWarehouseLocation);
                                    mySqlCommand.Parameters.AddWithValue("_Position", articleWarehouseLocation.Position);
                                    mySqlCommand.Parameters.AddWithValue("_IdArticle", articleWarehouseLocation.IdArticle);
                                    mySqlCommand.Parameters.AddWithValue("_MinimumStock", articleWarehouseLocation.MinimumStock);
                                    mySqlCommand.Parameters.AddWithValue("_MaximumStock", articleWarehouseLocation.MaximumStock);
                                    articleWarehouseLocation.IdArticleWarehouseLocation = Convert.ToInt32(mySqlCommand.ExecuteScalar());
                                    mySqlConnection.Close();
                                }


                                transactionScope.Complete();
                            }
                        }
                        catch (Exception ex)
                        {
                            if (Transaction.Current != null)
                                Transaction.Current.Rollback();

                            if (transactionScope != null)
                                transactionScope.Dispose();

                            throw;
                        }
                    }

                }
            }


            return articleWarehouseLocations;
        }

        /// <summary>
        /// This method is to get all articles with warehouse locations
        /// </summary>
        /// <param name="connectionString">Get connection string(geos db)</param>
        /// <param name="warehouseIds">Get selected id warehouses</param>
        /// <param name="warehouse">Get warehouse details</param>
        /// <returns>List of article details</returns>
        public List<Article> GetAllArticlesWithWarehouseLocations(string connectionString, string warehouseIds, Warehouses warehouse)
        {
            string whConnectionString = warehouse.Company.ConnectPlantConstr;
            List<Article> articles = new List<Article>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(whConnectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("warehouse_GetAllArticlesWithWarehouseLocations", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouseIds);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            Article article = new Article();

                            if (reader["IdArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                            if (reader["Reference"] != DBNull.Value)
                                article.Reference = Convert.ToString(reader["Reference"]);

                            if (reader["Description"] != DBNull.Value)
                                article.Description = Convert.ToString(reader["Description"]);

                            if (reader["Weight"] != DBNull.Value)
                                article.Weight = Math.Round(Convert.ToDecimal(reader["Weight"]), 3);

                            if (reader["Length"] != DBNull.Value)
                                article.Length = (float)reader["Length"];

                            if (reader["Width"] != DBNull.Value)
                                article.Width = (float)reader["Width"];

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)reader["Height"];


                            if (reader["IdArticleCategory"] != DBNull.Value)
                            {
                                article.IdArticleCategory = Convert.ToInt32(reader["IdArticleCategory"]);

                                article.ArticleCategory = new ArticleCategory();
                                article.ArticleCategory.IdArticleCategory = Convert.ToInt32(reader["IdArticleCategory"]);
                                article.ArticleCategory.Name = Convert.ToString(reader["ArticleCategory"]);
                            }

                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                                article.ArticleWarehouseLocation.IdWarehouseLocation = Convert.ToInt32(reader["IdWarehouseLocation"]);

                                if (reader["awlPosition"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.Position = Convert.ToInt64(reader["awlPosition"]);

                                if (reader["MinimumStock"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);

                                if (reader["MaximumStock"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.MaximumStock = Convert.ToInt64(reader["MaximumStock"]);

                                article.ArticleWarehouseLocation.WarehouseLocation = new WarehouseLocation();
                                article.ArticleWarehouseLocation.WarehouseLocation.IdWarehouseLocation = article.ArticleWarehouseLocation.IdWarehouseLocation;

                                if (reader["wlPosition"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.Position = Convert.ToInt64(reader["wlPosition"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                                if (reader["Name"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.Name = Convert.ToString(reader["Name"]);

                                if (reader["Parent"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.Parent = Convert.ToInt64(reader["Parent"]);

                                if (reader["FullName"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                                if (reader["HtmlColor"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                                article.ArticleWarehouseLocation.ArticlesStock = new ArticlesStock();
                                article.ArticleWarehouseLocation.ArticlesStock.IdWarehouseLocation = Convert.ToUInt64(article.ArticleWarehouseLocation.IdWarehouseLocation);

                                if (reader["ArticleStock"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.ArticlesStock.Quantity = Convert.ToInt64(reader["ArticleStock"]);

                                articles.Add(article);
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetAllArticlesWithWarehouseLocations(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return articles;
        }

        /// <summary>
        /// This method is to get all warehouse locations
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <returns>List of warehouse location details</returns>
        public List<WarehouseLocation> GetAllWarehouseLocations(string connectionString)
        {
            List<WarehouseLocation> warehouseLocations = new List<WarehouseLocation>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("warehouse_GetAllWarehouseLocations", con);
                concommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        WarehouseLocation warehouseLocation = new WarehouseLocation();

                        if (reader["IdWarehouseLocation"] != DBNull.Value)
                            warehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                        if (reader["IdWarehouse"] != DBNull.Value)
                            warehouseLocation.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                        warehouseLocation.Name = Convert.ToString(reader["Name"]);

                        if (reader["Parent"] != DBNull.Value)
                            warehouseLocation.Parent = Convert.ToInt64(reader["Parent"]);

                        if (reader["Position"] != DBNull.Value)
                            warehouseLocation.Position = Convert.ToInt64(reader["Position"]);

                        if (reader["FullName"] != DBNull.Value)
                            warehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                        if (reader["IsLead"] != DBNull.Value)
                            warehouseLocation.IsLead = Convert.ToSByte(reader["IsLead"]);

                        if (reader["HtmlColor"] != DBNull.Value)
                            warehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                        warehouseLocations.Add(warehouseLocation);
                    }
                }
            }

            return warehouseLocations;
        }

        /// <summary>
        /// This method is to get warehouse location related to id warehouse
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="warehouseIds">Get selected warehouses id</param>
        /// <returns>List of warehouse location details</returns>
        public List<WarehouseLocation> GetWarehouseLocationsByIdWarehouse(string connectionString, string warehouseIds)
        {
            List<WarehouseLocation> warehouseLocations = new List<WarehouseLocation>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("warehouse_GetWarehouseLocationsByIdWarehouse", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWarehouse", warehouseIds);
                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        WarehouseLocation warehouseLocation = new WarehouseLocation();

                        if (reader["IdWarehouseLocation"] != DBNull.Value)
                            warehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                        if (reader["IdWarehouse"] != DBNull.Value)
                            warehouseLocation.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                        warehouseLocation.Name = Convert.ToString(reader["Name"]);

                        if (reader["Parent"] != DBNull.Value)
                            warehouseLocation.Parent = Convert.ToInt64(reader["Parent"]);

                        if (reader["Position"] != DBNull.Value)
                            warehouseLocation.Position = Convert.ToInt64(reader["Position"]);

                        if (reader["FullName"] != DBNull.Value)
                            warehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                        if (reader["IsLead"] != DBNull.Value)
                            warehouseLocation.IsLead = Convert.ToSByte(reader["IsLead"]);

                        if (reader["HtmlColor"] != DBNull.Value)
                            warehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                        if (reader["InUse"] != DBNull.Value)
                            warehouseLocation.InUse = Convert.ToBoolean(reader["InUse"]);

                        if (reader["IdDirection"] != DBNull.Value)
                        {
                            warehouseLocation.IdDirection = Convert.ToInt32(reader["IdDirection"]);

                            warehouseLocation.Direction = new LookupValue();
                            warehouseLocation.Direction.IdLookupValue = Convert.ToInt32(reader["IdDirection"]);
                            warehouseLocation.Direction.Value = Convert.ToString(reader["Value"]);
                            warehouseLocation.Direction.HtmlColor = Convert.ToString(reader["DirectionHtmlColor"]);
                            if (reader["IdImage"] != DBNull.Value)
                                warehouseLocation.Direction.IdImage = Convert.ToInt64(reader["IdImage"]);
                        }
                        if (reader["Width"] != DBNull.Value)
                            warehouseLocation.Width = Convert.ToDouble(reader["Width"]);
                        if (reader["Height"] != DBNull.Value)
                            warehouseLocation.Height = Convert.ToDouble(reader["Height"]);
                        if (reader["FileName"] != DBNull.Value)
                            warehouseLocation.FileName = Convert.ToString(reader["FileName"]);
                        if (reader["Latitude"] != DBNull.Value)
                            warehouseLocation.Latitude = Convert.ToDouble(reader["Latitude"]);
                        if (reader["Longitude"] != DBNull.Value)
                            warehouseLocation.Longitude = Convert.ToDouble(reader["Longitude"]);

                        warehouseLocations.Add(warehouseLocation);
                    }
                }
            }

            return warehouseLocations;
        }

        /// <summary>
        /// This method upadte article details
        /// </summary>
        /// <param name="mainServerConnectionString">Get main server connection string (geos db)</param>
        /// <param name="article">Get article details</param>
        /// <param name="articleVisualAidsPath">Get article image path</param>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <returns>If true updated article details otherwise false</returns>
        public bool UpdateArticleDetails(string mainServerConnectionString, Article article, string articleVisualAidsPath, string connectionString)
        {
            bool isInserted = false;
            if (article.LstArticleWarehouseLocations != null)
            {
                AddArticleWarehouseLocation(mainServerConnectionString, article.LstArticleWarehouseLocations);
                isInserted = true;
            }
            if (article.MyWarehouse != null)
            {
                TransactionScope transactionScope = null;
                try
                {
                    using (transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("mywarehouse_Update", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;
                            mySqlCommand.Parameters.AddWithValue("_IdWarehouse", article.MyWarehouse.IdWarehouse);
                            mySqlCommand.Parameters.AddWithValue("_IdArticle", article.MyWarehouse.IdArticle);
                            mySqlCommand.Parameters.AddWithValue("_MaximumStock", article.MyWarehouse.MaximumStock);
                            mySqlCommand.Parameters.AddWithValue("_MinimumStock", article.MyWarehouse.MinimumStock);

                            mySqlCommand.ExecuteNonQuery();
                            mySqlConnection.Close();


                        }


                        transactionScope.Complete();
                        transactionScope.Dispose();
                    }
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();
                    isInserted = false;
                    throw;
                }
                isInserted = true;
            }
            if (article.IsAddedArticleImage)
            {
                if (article.ImagePath != null)
                {
                    TransactionScope transactionScope = null;
                    try
                    {
                        using (transactionScope = new TransactionScope())
                        {
                            using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                            {
                                mySqlConnection.Open();

                                MySqlCommand mySqlCommand = new MySqlCommand("articles_Update", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;

                                mySqlCommand.Parameters.AddWithValue("_IdArticle", article.IdArticle);
                                mySqlCommand.Parameters.AddWithValue("_ImagePath", @"\" + article.Reference + @"\" + article.Reference + article.ImagePath);
                                mySqlCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                mySqlCommand.Parameters.AddWithValue("_ModifiedBy", article.ModifiedBy);

                                mySqlCommand.ExecuteNonQuery();
                                mySqlConnection.Close();


                            }


                            transactionScope.Complete();
                            transactionScope.Dispose();
                        }
                    }
                    catch (Exception ex)
                    {
                        if (Transaction.Current != null)
                            Transaction.Current.Rollback();

                        if (transactionScope != null)
                            transactionScope.Dispose();
                        isInserted = false;
                        throw;
                    }
                    isInserted = true;
                }
                isInserted = SaveArticleImage(articleVisualAidsPath, article);

            }
            else if (article.IsDeletedArticleImage)
            {
                if (article.ImagePath != null)
                {
                    TransactionScope transactionScope = null;
                    try
                    {
                        using (transactionScope = new TransactionScope())
                        {
                            using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                            {
                                mySqlConnection.Open();

                                MySqlCommand mySqlCommand = new MySqlCommand("articles_Update", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;

                                mySqlCommand.Parameters.AddWithValue("_IdArticle", article.IdArticle);
                                mySqlCommand.Parameters.AddWithValue("_ImagePath", string.Empty);
                                mySqlCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                mySqlCommand.Parameters.AddWithValue("_ModifiedBy", article.ModifiedBy);

                                mySqlCommand.ExecuteNonQuery();
                                mySqlConnection.Close();


                            }


                            transactionScope.Complete();
                            transactionScope.Dispose();
                        }
                    }
                    catch (Exception ex)
                    {
                        if (Transaction.Current != null)
                            Transaction.Current.Rollback();

                        if (transactionScope != null)
                            transactionScope.Dispose();
                        isInserted = false;
                        throw;
                    }
                    isInserted = true;
                }
                isInserted = DeleteArticleImage(articleVisualAidsPath, article);
            }
            if (article.LogEntriesByArticles != null)
            {
                AddLogArticle(mainServerConnectionString, article.LogEntriesByArticles);
                isInserted = true;
            }

            return isInserted;
        }

        /// <summary>
        /// This method is to saved article image details
        /// </summary>
        /// <param name="articleVisualAidsPath">Get article image path </param>
        /// <param name="article">Get article details</param>
        /// <returns>If true saved article image otherwise false</returns>
        public bool SaveArticleImage(string articleVisualAidsPath, Article article)
        {
            if (article.ArticleImageInBytes != null)
            {
                try
                {
                    string fileUploadPath = articleVisualAidsPath + @"\" + article.Reference + @"\" + article.Reference + article.ImagePath;

                    if (!Directory.Exists(articleVisualAidsPath + @"\" + article.Reference))
                    {
                        Directory.CreateDirectory(articleVisualAidsPath + @"\" + article.Reference);
                    }

                    File.WriteAllBytes(fileUploadPath, article.ArticleImageInBytes);
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error SaveArticleImage()-Filename - {0}. ErrorMessage- {1}", article.ImagePath, ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }
            }

            return true;
        }

        /// <summary>
        /// This method is to delete article image
        /// </summary>
        /// <param name="articleVisualAidsPath">Get article image path</param>
        /// <param name="article">Get article details</param>
        /// <returns>If true deleted article image otherwise false</returns>
        public bool DeleteArticleImage(string articleVisualAidsPath, Article article)
        {
            TxFileManager fileMgr = new TxFileManager();
            if (article.ArticleImageInBytes != null)
            {
                try
                {
                    string fileUploadPath = articleVisualAidsPath + @"\" + article.Reference + @"\" + article.Reference + article.ImagePath;

                    if (!Directory.Exists(articleVisualAidsPath + @"\" + article.Reference))
                    {
                        return false;
                    }

                    else
                    {

                        if (fileMgr.FileExists(fileUploadPath))
                        {
                            fileMgr.Delete(fileUploadPath);
                        }
                    }
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error DeleteArticleImage()-Filename - {0}. ErrorMessage- {1}", article.ImagePath, ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }
            }

            return true;
        }

        /// <summary>
        /// This method to add log article
        /// </summary>
        /// <param name="mainServerConnectionString">Get main server connection string (geos db)</param>
        /// <param name="LogEntriesByArticles">List of log entries related to articles</param>
        public void AddLogArticle(string mainServerConnectionString, List<LogEntriesByArticle> LogEntriesByArticles)
        {
            foreach (LogEntriesByArticle itemlogentry in LogEntriesByArticles)
            {
                TransactionScope transactionScope = null;
                try
                {
                    using (transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("logentriesbyarticle_Insert", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;
                            mySqlCommand.Parameters.AddWithValue("_IdArticle", itemlogentry.IdArticle);
                            mySqlCommand.Parameters.AddWithValue("_idLogEntryType", itemlogentry.IdLogEntryType);
                            mySqlCommand.Parameters.AddWithValue("_IdUser", itemlogentry.IdUser);
                            mySqlCommand.Parameters.AddWithValue("_LogDateTime", DateTime.Now);
                            mySqlCommand.Parameters.AddWithValue("_Comments", itemlogentry.Comments);

                            mySqlCommand.ExecuteNonQuery();
                            mySqlConnection.Close();
                        }


                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }
        }

        /// <summary>
        /// This method to update otitem status and stage
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idOtItem">Get id otitem</param>
        /// <param name="idItemOtStatus">Get is item otstatus</param>
        /// <param name="idOperator">Get id operator</param>
        /// <returns>If true updated otitem status and stage otherwise false</returns>
        public bool UpdateItemStatusAndStage(string connectionString, Int64 idOtItem, byte idItemOtStatus, Int32 idOperator)
        {
            bool isUpdated = false;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("otitems_StatusAndStageUpdate", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdOTItem", idOtItem);
                        mySqlCommand.Parameters.AddWithValue("_IdItemOtStatus", idItemOtStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdOperator", idOperator);
                        mySqlCommand.Parameters.AddWithValue("_CurrentDateTime", DateTime.Now);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }


                    transactionScope.Complete();
                    isUpdated = true;
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isUpdated = false;
                throw;
            }
            return isUpdated;
        }


        /// <summary>
        /// This method is to add warehouse location
        /// </summary>
        /// <param name="mainServerConnectionString">Get main server connection string (geos db)</param>
        /// <param name="warehouseLocation">Warehouse location details</param>
        /// <returns>Warehouse location details</returns>
        public WarehouseLocation AddWarehouseLocation(string mainServerConnectionString, WarehouseLocation warehouseLocation)
        {
            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("warehouselocations_Insert", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_Position", warehouseLocation.Position);
                        mySqlCommand.Parameters.AddWithValue("_Parent", warehouseLocation.Parent);
                        mySqlCommand.Parameters.AddWithValue("_Name", warehouseLocation.Name);
                        mySqlCommand.Parameters.AddWithValue("_IsLead", warehouseLocation.IsLead);
                        mySqlCommand.Parameters.AddWithValue("_InUse", warehouseLocation.InUse);
                        mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouseLocation.IdWarehouse);
                        mySqlCommand.Parameters.AddWithValue("_HtmlColor", warehouseLocation.HtmlColor);
                        mySqlCommand.Parameters.AddWithValue("_FullName", warehouseLocation.FullName);
                        mySqlCommand.Parameters.AddWithValue("_IdDirection", warehouseLocation.IdDirection);
                        mySqlCommand.Parameters.AddWithValue("_Latitude", warehouseLocation.Latitude);
                        mySqlCommand.Parameters.AddWithValue("_Longitude", warehouseLocation.Longitude);
                        mySqlCommand.Parameters.AddWithValue("_FileNameWithExtension", warehouseLocation.FileName);
                        mySqlCommand.Parameters.AddWithValue("_Height", warehouseLocation.Height);
                        mySqlCommand.Parameters.AddWithValue("_Width", warehouseLocation.Width);

                        warehouseLocation.IdWarehouseLocation = Convert.ToInt32(mySqlCommand.ExecuteScalar());
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    bool isupdateReIndex = UpdateReIndexWarehouselocation(warehouseLocation.IdWarehouseLocation, warehouseLocation.IdWarehouse, warehouseLocation.Parent, mainServerConnectionString);
                    warehouseLocation = GetWarehouseLocationsByIdWarehouse(mainServerConnectionString, warehouseLocation.IdWarehouseLocation);
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error AddWarehouseLocation(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return warehouseLocation;
        }

        /// <summary>
        /// This method is to update warehose location
        /// </summary>
        /// <param name="mainServerConnectionString">Get main server connection string (geos db)</param>
        /// <param name="warehouseLocation">Get warehouse location details</param>
        /// <returns>updated warehouse location details</returns>
        public WarehouseLocation UpdateWarehouseLocation(string mainServerConnectionString, WarehouseLocation warehouseLocation)
        {

            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("warehouselocations_Update", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_Position", warehouseLocation.Position);
                        mySqlCommand.Parameters.AddWithValue("_Parent", warehouseLocation.Parent);
                        mySqlCommand.Parameters.AddWithValue("_Name", warehouseLocation.Name);
                        mySqlCommand.Parameters.AddWithValue("_IsLead", warehouseLocation.IsLead);
                        mySqlCommand.Parameters.AddWithValue("_InUse", warehouseLocation.InUse);
                        mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouseLocation.IdWarehouse);
                        mySqlCommand.Parameters.AddWithValue("_HtmlColor", warehouseLocation.HtmlColor);
                        mySqlCommand.Parameters.AddWithValue("_FullName", warehouseLocation.FullName);
                        mySqlCommand.Parameters.AddWithValue("_IdWarehouseLocation", warehouseLocation.IdWarehouseLocation);
                        mySqlCommand.Parameters.AddWithValue("_IdDirection", warehouseLocation.IdDirection);
                        mySqlCommand.Parameters.AddWithValue("_Latitude", warehouseLocation.Latitude);
                        mySqlCommand.Parameters.AddWithValue("_Longitude", warehouseLocation.Longitude);
                        mySqlCommand.Parameters.AddWithValue("_FileNameWithExtension", warehouseLocation.FileName);
                        mySqlCommand.Parameters.AddWithValue("_Height", warehouseLocation.Height);
                        mySqlCommand.Parameters.AddWithValue("_Width", warehouseLocation.Width);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                    bool isupdateReIndex = UpdateReIndexWarehouselocation(warehouseLocation.IdWarehouseLocation, warehouseLocation.IdWarehouse, warehouseLocation.Parent, mainServerConnectionString);
                    warehouseLocation = GetWarehouseLocationsByIdWarehouse(mainServerConnectionString, warehouseLocation.IdWarehouseLocation);
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error UpdateWarehouseLocation(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return warehouseLocation;
        }

        /// <summary>
        /// This method is to get warehouse location related to id warehouse
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idWarehouseLocation">Get id warehouse location</param>
        /// <returns>Warehouse location details</returns>
        public WarehouseLocation GetWarehouseLocationsByIdWarehouse(string connectionString, Int64 idWarehouseLocation)
        {

            WarehouseLocation warehouseLocation = new WarehouseLocation();
            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("warehouselocations_GetWarehouselocationById", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWarehouseLocation", idWarehouseLocation);
                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {

                        if (reader["IdWarehouseLocation"] != DBNull.Value)
                            warehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                        if (reader["IdWarehouse"] != DBNull.Value)
                            warehouseLocation.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                        warehouseLocation.Name = Convert.ToString(reader["Name"]);

                        if (reader["Parent"] != DBNull.Value)
                            warehouseLocation.Parent = Convert.ToInt64(reader["Parent"]);

                        if (reader["Position"] != DBNull.Value)
                            warehouseLocation.Position = Convert.ToInt64(reader["Position"]);

                        if (reader["FullName"] != DBNull.Value)
                            warehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                        if (reader["IsLead"] != DBNull.Value)
                            warehouseLocation.IsLead = Convert.ToSByte(reader["IsLead"]);

                        if (reader["HtmlColor"] != DBNull.Value)
                            warehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                        if (reader["InUse"] != DBNull.Value)
                            warehouseLocation.InUse = Convert.ToBoolean(reader["InUse"]);

                        if (reader["IdDirection"] != DBNull.Value)
                        {
                            warehouseLocation.IdDirection = Convert.ToInt32(reader["IdDirection"]);

                            warehouseLocation.Direction = new LookupValue();
                            warehouseLocation.Direction.IdLookupValue = Convert.ToInt32(reader["IdDirection"]);
                            warehouseLocation.Direction.Value = Convert.ToString(reader["Value"]);
                            warehouseLocation.Direction.HtmlColor = Convert.ToString(reader["DirectionHtmlColor"]);
                            if (reader["IdImage"] != DBNull.Value)
                                warehouseLocation.Direction.IdImage = Convert.ToInt64(reader["IdImage"]);

                        }

                        if (reader["Latitude"] != DBNull.Value)
                            warehouseLocation.Latitude = Convert.ToDouble(reader["Latitude"]);

                        if (reader["Longitude"] != DBNull.Value)
                            warehouseLocation.Longitude = Convert.ToDouble(reader["Longitude"]);

                        if (reader["Width"] != DBNull.Value)
                            warehouseLocation.Width = Convert.ToDouble(reader["Width"]);

                        if (reader["Height"] != DBNull.Value)
                            warehouseLocation.Height = Convert.ToDouble(reader["Height"]);

                        if (reader["FileName"] != DBNull.Value)
                            warehouseLocation.FileName = Convert.ToString(reader["FileName"]);

                    }
                }
            }

            return warehouseLocation;
        }

        /// <summary>
        /// This method is to check exist warehouse location name
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="name">Get name</param>
        /// <param name="parent">Get parent</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <returns>If true exist in warehouse location name otherwise false</returns>
        public bool IsExistWarehouseLocationName(string connectionString, string name, Int64 parent, Int64 idWarehouse)
        {

            bool isexist = false;
            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("warehouselocations_IsExistWarehouseLocationName", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_Name", name);
                concommand.Parameters.AddWithValue("_Parent", parent);
                concommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    if (reader.Read())
                    {

                        if (reader["result"].ToString() == "1")
                            isexist = true;
                        else
                            isexist = false;

                    }
                }
            }

            return isexist;
        }

        /// <summary>
        /// This method is to update revision item comments
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idRevisionItem">Get id revision item</param>
        /// <param name="idDeliveryNoteItem">Get id delivery note item</param>
        /// <returns>If true updated revision comments otherwise false</returns>
        public bool UpdateRevisionItemComments(string connectionString, Int64 idRevisionItem, Int64 idDeliveryNoteItem)
        {
            TransactionScope transactionScope = null;

            using (transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection connWDN = new MySqlConnection(connectionString))
                    {
                        connWDN.Open();

                        MySqlCommand insertWDNCommand = new MySqlCommand("revisionitems_UpdateComments", connWDN);
                        insertWDNCommand.CommandType = CommandType.StoredProcedure;

                        insertWDNCommand.Parameters.AddWithValue("_IdRevisionItem", idRevisionItem);
                        insertWDNCommand.Parameters.AddWithValue("_IdWarehouseDeliveryNoteItem", idDeliveryNoteItem);


                        insertWDNCommand.ExecuteNonQuery();

                        connWDN.Close();
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error UpdateRevisionItemComments(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return true;
        }

        /// <summary>
        /// This method is to get warehouse location related to selected warehouse
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <returns>List of warehouse location details</returns>
        public List<WarehouseLocation> GetWarehouseLocationBySelectedWarehouse(string connectionString, Int64 idWarehouse)
        {
            List<WarehouseLocation> warehouseLocations = new List<WarehouseLocation>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("warehouse_GetWarehouseLocationBySelectedWarehouse", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        WarehouseLocation warehouseLocation = new WarehouseLocation();

                        if (reader["IdWarehouseLocation"] != DBNull.Value)
                            warehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                        if (reader["IdWarehouse"] != DBNull.Value)
                            warehouseLocation.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                        warehouseLocation.Name = Convert.ToString(reader["Name"]);

                        if (reader["Parent"] != DBNull.Value)
                            warehouseLocation.Parent = Convert.ToInt64(reader["Parent"]);

                        if (reader["Position"] != DBNull.Value)
                            warehouseLocation.Position = Convert.ToInt64(reader["Position"]);

                        if (reader["FullName"] != DBNull.Value)
                            warehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                        if (reader["IsLead"] != DBNull.Value)
                            warehouseLocation.IsLead = Convert.ToSByte(reader["IsLead"]);

                        if (reader["HtmlColor"] != DBNull.Value)
                            warehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                        warehouseLocations.Add(warehouseLocation);
                    }
                }
            }

            return warehouseLocations;
        }

        /// <summary>
        /// This method is to get manufacturer
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idArticle">Get id article </param>
        /// <returns>List of manufacturerBy Article</returns>
        public List<ManufacturersByArticle> GetManufacturers(string connectionString, Int32 idArticle)
        {
            List<ManufacturersByArticle> manufacturersByArticles = new List<ManufacturersByArticle>();


            using (MySqlConnection connWarehousePurchaseOrderItem = new MySqlConnection(connectionString))
            {
                connWarehousePurchaseOrderItem.Open();

                MySqlCommand dNItemsCommand = new MySqlCommand("manufacturersbyarticle_GetManufacturers", connWarehousePurchaseOrderItem);
                dNItemsCommand.CommandType = CommandType.StoredProcedure;
                dNItemsCommand.Parameters.AddWithValue("_IdArticle", idArticle);

                using (MySqlDataReader dNReader = dNItemsCommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        try
                        {
                            ManufacturersByArticle manufacturersByArticle = new ManufacturersByArticle();

                            manufacturersByArticle.IdArticle = idArticle;

                            if (dNReader["IdManufacturerByArticle"] != DBNull.Value)
                                manufacturersByArticle.IdManufacturerByArticle = Convert.ToInt64(dNReader["IdManufacturerByArticle"]);

                            if (dNReader["IdManufacturer"] != DBNull.Value)
                            {
                                manufacturersByArticle.IdManufacturer = Convert.ToInt64(dNReader["IdManufacturer"]);
                                manufacturersByArticle.Manufacturer = new Manufacturer();
                                manufacturersByArticle.Manufacturer.IdManufacturer = manufacturersByArticle.IdManufacturer;
                                manufacturersByArticle.Manufacturer.Name = Convert.ToString(dNReader["Manufacturer"]);
                            }

                            if (dNReader["IdCountry"] != DBNull.Value)
                            {
                                manufacturersByArticle.IdCountry = Convert.ToInt64(dNReader["IdCountry"]);

                                manufacturersByArticle.Country = new Country();
                                manufacturersByArticle.Country.IdCountry = Convert.ToByte(manufacturersByArticle.IdCountry);
                                manufacturersByArticle.Country.Name = Convert.ToString(dNReader["Country"]);

                            }

                            manufacturersByArticles.Add(manufacturersByArticle);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetManufacturers(idArticle-{0}). ErrorMessage- {1}", idArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return manufacturersByArticles;
        }

        /// <summary>
        /// This method is to get stock history related to id article
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idArticle">Get id article</param>
        /// <param name="fromDate">Get fromdate</param>
        /// <param name="toDate">Get to date</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <returns>List of article stock details</returns>
        public List<ArticlesStock> GetStockHistoryByIdArticle(string connectionString, Int32 idArticle, DateTime fromDate, DateTime toDate, Int64 idWarehouse)
        {
            List<ArticlesStock> articlesStocks = new List<ArticlesStock>();


            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("articlesstock_GetStockHistoryByIdArticle", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdArticle", idArticle);
                command.Parameters.AddWithValue("_FromDate", fromDate);
                command.Parameters.AddWithValue("_ToDate", toDate);
                command.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            ArticlesStock articlesStock = new ArticlesStock();

                            if (reader["IdArticleStock"] != DBNull.Value)
                                articlesStock.IdArticleStock = Convert.ToUInt64(reader["IdArticleStock"]);
                            if (reader["quantity"] != DBNull.Value)
                                articlesStock.Quantity = Convert.ToInt64(reader["quantity"]);
                            if (reader["price"] != DBNull.Value)
                                articlesStock.Price = Convert.ToDouble(reader["price"]);
                            if (reader["uploadedIn"] != DBNull.Value)
                                articlesStock.UploadedIn = Convert.ToDateTime(reader["uploadedIn"]);
                            if (reader["comments"] != DBNull.Value)
                                articlesStock.Comments = Convert.ToString(reader["comments"]);
                            if (reader["isDamaged"] != DBNull.Value)
                                articlesStock.IsDamaged = Convert.ToByte(reader["isDamaged"]);
                            articlesStock.PeopleModifiedBy = new People();
                            if (reader["FirstName"] != DBNull.Value)
                                articlesStock.PeopleModifiedBy.Name = Convert.ToString(reader["FirstName"]);
                            if (reader["LastName"] != DBNull.Value)
                                articlesStock.PeopleModifiedBy.Surname = Convert.ToString(reader["LastName"]);


                            articlesStocks.Add(articlesStock);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetStockHistoryByIdArticle(idArticle-{0}). ErrorMessage- {1}", idArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return articlesStocks;
        }

        /// <summary>
        /// This method is to get is leaf warehouse location
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="warehouseIds"></param>
        /// <returns></returns>
        public List<WarehouseLocation> GetIsLeafWarehouseLocations(string connectionString, string warehouseIds)
        {
            List<WarehouseLocation> warehouseLocations = new List<WarehouseLocation>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("warehouse_GetISLeafWarehouseLocations", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWarehouse", warehouseIds);
                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        WarehouseLocation warehouseLocation = new WarehouseLocation();

                        if (reader["IdWarehouseLocation"] != DBNull.Value)
                            warehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                        if (reader["IdWarehouse"] != DBNull.Value)
                            warehouseLocation.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                        warehouseLocation.Name = Convert.ToString(reader["Name"]);

                        if (reader["Parent"] != DBNull.Value)
                            warehouseLocation.Parent = Convert.ToInt64(reader["Parent"]);

                        if (reader["Position"] != DBNull.Value)
                            warehouseLocation.Position = Convert.ToInt64(reader["Position"]);

                        if (reader["FullName"] != DBNull.Value)
                            warehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                        if (reader["IsLead"] != DBNull.Value)
                            warehouseLocation.IsLead = Convert.ToSByte(reader["IsLead"]);

                        if (reader["HtmlColor"] != DBNull.Value)
                            warehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                        if (reader["InUse"] != DBNull.Value)
                            warehouseLocation.InUse = Convert.ToBoolean(reader["InUse"]);

                        if (reader["IdDirection"] != DBNull.Value)
                        {
                            warehouseLocation.IdDirection = Convert.ToInt32(reader["IdDirection"]);

                            warehouseLocation.Direction = new LookupValue();
                            warehouseLocation.Direction.IdLookupValue = Convert.ToInt32(reader["IdDirection"]);
                            warehouseLocation.Direction.Value = Convert.ToString(reader["Value"]);
                            warehouseLocation.Direction.HtmlColor = Convert.ToString(reader["DirectionHtmlColor"]);
                            if (reader["IdImage"] != DBNull.Value)
                                warehouseLocation.Direction.IdImage = Convert.ToInt64(reader["IdImage"]);
                        }
                        if (reader["Width"] != DBNull.Value)
                            warehouseLocation.Width = Convert.ToDouble(reader["Width"]);
                        if (reader["Height"] != DBNull.Value)
                            warehouseLocation.Height = Convert.ToDouble(reader["Height"]);
                        if (reader["FileName"] != DBNull.Value)
                            warehouseLocation.FileName = Convert.ToString(reader["FileName"]);
                        if (reader["Latitude"] != DBNull.Value)
                            warehouseLocation.Latitude = Convert.ToDouble(reader["Latitude"]);
                        if (reader["Longitude"] != DBNull.Value)
                            warehouseLocation.Longitude = Convert.ToDouble(reader["Longitude"]);

                        warehouseLocations.Add(warehouseLocation);
                    }
                }
            }

            return warehouseLocations;
        }


        /// <summary>
        /// This method is to get serial number
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idWareHouseDeliveryNoteItem">Get id warehouse delivery note item</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <returns>List of serial number details</returns>
        public List<SerialNumber> GetSerialNumbers(string connectionString, Int64 idWareHouseDeliveryNoteItem, Int64 idWarehouse)
        {
            List<SerialNumber> serialNumbers = new List<SerialNumber>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("serialnumbers_GetSerialNumbers", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWareHouseDeliveryNoteItem", idWareHouseDeliveryNoteItem);
                concommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader dNReader = concommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        SerialNumber serialNumber = new SerialNumber();

                        serialNumber.IdSerialNumber = Convert.ToInt64(dNReader["IdSerialNumber"]);
                        serialNumber.Code = Convert.ToString(dNReader["Code"]);

                        if (dNReader["ExtraCode"] != DBNull.Value)
                            serialNumber.ExtraCode = Convert.ToString(dNReader["ExtraCode"]);

                        if (dNReader["IdWarehouseDeliveryNoteItem"] != DBNull.Value)
                            serialNumber.IdWarehouseDeliveryNoteItem = Convert.ToInt64(dNReader["IdWarehouseDeliveryNoteItem"]);

                        if (dNReader["IdWarehouseProduct"] != DBNull.Value)
                            serialNumber.IdWarehouseProduct = Convert.ToInt64(dNReader["IdWarehouseProduct"]);

                        if (dNReader["IdArticle"] != DBNull.Value)
                            serialNumber.IdArticle = Convert.ToInt32(dNReader["IdArticle"]);

                        serialNumbers.Add(serialNumber);
                    }
                }
            }

            return serialNumbers;
        }

        /// <summary>
        /// This method is to update serial number
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="serialNumber">Get serial number details</param>
        /// <returns>If true updated serial number otherwise false</returns>
        public bool UpdateSerialNumber(string connectionString, SerialNumber serialNumber)
        {
            TransactionScope transactionScope = null;

            using (transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection conn = new MySqlConnection(connectionString))
                    {
                        conn.Open();

                        MySqlCommand insertCommand = new MySqlCommand("serialnumber_Update", conn);
                        insertCommand.CommandType = CommandType.StoredProcedure;

                        insertCommand.Parameters.AddWithValue("_idserialnumber", serialNumber.IdSerialNumber);
                        insertCommand.Parameters.AddWithValue("_code", serialNumber.Code);
                        insertCommand.Parameters.AddWithValue("_idWarehouseProduct", serialNumber.IdWarehouseProduct);
                        insertCommand.Parameters.AddWithValue("_idWarehouse", serialNumber.IdWarehouse);
                        insertCommand.Parameters.AddWithValue("_idWarehouseDeliveryNoteItem", serialNumber.IdWarehouseDeliveryNoteItem);


                        int count = insertCommand.ExecuteNonQuery();

                        conn.Close();
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error UpdateSerialNumber(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return true;
        }


        /// <summary>
        /// This method is to get refill to list
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idWarehouse">Get warehouse id</param>
        /// <returns>List of location refill details</returns>
        public List<LocationRefill> GetRefillToList(string connectionString, string idWarehouse)
        {
            List<LocationRefill> locationRefills = new List<LocationRefill>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("warehouse_GetRefillToList", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdsWarehouse", idWarehouse);


                using (MySqlDataReader dNReader = concommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        LocationRefill locationRefill = new LocationRefill();
                        if (dNReader["IdWarehouseLocation"] != DBNull.Value)
                            locationRefill.IdWarehouseLocation = Convert.ToInt64(dNReader["IdWarehouseLocation"]);
                        if (dNReader["Position"] != DBNull.Value)
                            locationRefill.Position = Convert.ToInt64(dNReader["Position"]);

                        if (dNReader["IdArticle"] != DBNull.Value)
                            locationRefill.IdArticle = Convert.ToInt32(dNReader["IdArticle"]);

                        if (dNReader["MinimumStock"] != DBNull.Value)
                            locationRefill.MinimumStock = Convert.ToInt64(dNReader["MinimumStock"]);

                        if (dNReader["FullName"] != DBNull.Value)
                            locationRefill.FullName = Convert.ToString(dNReader["FullName"]);

                        if (dNReader["CurrentStock"] != DBNull.Value)
                            locationRefill.CurrenStock = Convert.ToInt64(dNReader["CurrentStock"]);

                        if (dNReader["MaximumStock"] != DBNull.Value)
                            locationRefill.MaximumStock = Convert.ToInt64(dNReader["MaximumStock"]);

                        locationRefills.Add(locationRefill);
                    }
                }
            }

            return locationRefills;
        }

        /// <summary>
        /// This method is to get  article warehouse location
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idArticle">Get id article</param>
        /// <param name="position">Get position</param>
        /// <returns>Location refill details</returns>
        public LocationRefill GetArticleWarehouseLocation(string connectionString, Int32 idArticle, Int64 position)
        {
            LocationRefill locationRefill = new LocationRefill();
            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("warehouse_GetarticleWarehouseLocation", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdArticle", idArticle);
                concommand.Parameters.AddWithValue("_Position", position);

                using (MySqlDataReader dNReader = concommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {

                        if (dNReader["IdWarehouseLocation"] != DBNull.Value)
                            locationRefill.IdWarehouseLocation = Convert.ToInt64(dNReader["IdWarehouseLocation"]);
                        if (dNReader["Position"] != DBNull.Value)
                            locationRefill.Position = Convert.ToInt64(dNReader["Position"]);

                        if (dNReader["IdArticle"] != DBNull.Value)
                            locationRefill.IdArticle = Convert.ToInt32(dNReader["IdArticle"]);

                        if (dNReader["MinimumStock"] != DBNull.Value)
                            locationRefill.MinimumStock = Convert.ToInt64(dNReader["MinimumStock"]);

                        if (dNReader["FullName"] != DBNull.Value)
                            locationRefill.FullName = Convert.ToString(dNReader["FullName"]);

                    }
                }
            }

            return locationRefill;
        }

        /// <summary>
        /// This method is to get article warehouse location transfer
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="IdArticles">Get selected idarticles</param>
        /// <param name="IdWarehouse">Get id warehouse</param>
        /// <returns>List of article warehouse locations</returns>
        public List<ArticleWarehouseLocations> GetArticlesWarehouseLocationTransfer(string connectionString, string IdArticles, long IdWarehouse)
        {
            List<ArticleWarehouseLocations> articleWarehouseLocationsList = new List<ArticleWarehouseLocations>();

            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("warehouse_GetArticlesLocationTransfer", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", IdArticles);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", IdWarehouse);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {
                    while (articlesReader.Read())
                    {
                        try
                        {
                            ArticleWarehouseLocations articleWarehouseLocations = new ArticleWarehouseLocations();

                            if (articlesReader["IdArticle"] != DBNull.Value)
                                articleWarehouseLocations.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                articleWarehouseLocations.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                articleWarehouseLocations.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdArticleWarehouseLocation"] != DBNull.Value)
                                articleWarehouseLocations.IdArticleWarehouseLocation = Convert.ToInt64(articlesReader["IdArticleWarehouseLocation"]);

                            if (articlesReader["Parent"] != DBNull.Value)
                                articleWarehouseLocations.Parent = Convert.ToInt64(articlesReader["Parent"]);

                            if (articlesReader["Position"] != DBNull.Value)
                                articleWarehouseLocations.Position = Convert.ToInt64(articlesReader["Position"]);

                            if (articlesReader["Name"] != DBNull.Value)
                                articleWarehouseLocations.Name = articlesReader["Name"].ToString();

                            if (articlesReader["FullName"] != DBNull.Value)
                                articleWarehouseLocations.FullName = articlesReader["FullName"].ToString();

                            if (articlesReader["MinimumStock"] != DBNull.Value)
                                articleWarehouseLocations.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                            if (articlesReader["MaximumStock"] != DBNull.Value)
                                articleWarehouseLocations.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                articleWarehouseLocations.WarehouseLocation = new WarehouseLocation();

                                articleWarehouseLocations.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);
                                if (articlesReader["IdWarehouse"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);
                                if (articlesReader["Name"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Name = Convert.ToString(articlesReader["Name"]);
                                if (articlesReader["Parent"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Parent = Convert.ToInt64(articlesReader["Parent"]);
                                if (articlesReader["Position"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Position = Convert.ToInt64(articlesReader["Position"]);
                                if (articlesReader["FullName"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.FullName = Convert.ToString(articlesReader["FullName"]);
                                if (articlesReader["FileName"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);
                                if (articlesReader["Latitude"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                                if (articlesReader["Longitude"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                                if (articlesReader["Height"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                                if (articlesReader["Width"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);
                            }

                            articleWarehouseLocationsList.Add(articleWarehouseLocations);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error warehouse_GetArticlesLocationTransfer(IdArticle-{0} . ErrorMessage- {2}", IdArticles, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }

            }
            return articleWarehouseLocationsList;

        }

        /// <summary>
        /// This method is to update observation 
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="observation">Get observation details</param>
        /// <returns>If true updated observation otherwise false</returns>
        public bool UpdateObservation(string connectionString, Observation observation)
        {
            TransactionScope transactionScope = null;

            using (transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection conn = new MySqlConnection(connectionString))
                    {
                        conn.Open();

                        MySqlCommand insertCommand = new MySqlCommand("Observations_Update", conn);
                        insertCommand.CommandType = CommandType.StoredProcedure;

                        insertCommand.Parameters.AddWithValue("_IdRevisionItem", observation.IdRevisionItem);
                        insertCommand.Parameters.AddWithValue("_CreationDate", DateTime.Now);
                        insertCommand.Parameters.AddWithValue("_IdUser", observation.IdUser);
                        insertCommand.Parameters.AddWithValue("_Text", observation.Text);


                        int count = insertCommand.ExecuteNonQuery();

                        conn.Close();
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error UpdateObservation(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return true;
        }

        /// <summary>
        /// This method is to get refill material details
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="fromLocationName">Get From location name</param>
        /// <param name="toLocationName">Get to location name</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="ArticleVisualAidsPath">Get article image path</param>
        /// <param name="toLocationRefill">Get to location refill</param>
        /// <returns>List of transfer material details</returns>
        public List<TransferMaterials> GetRefillMaterialDetails(string connectionString, string fromLocationName, string toLocationName, Int64 idWarehouse, string ArticleVisualAidsPath, LocationRefill toLocationRefill)
        {
            List<TransferMaterials> transferMaterialsList = new List<TransferMaterials>();

            Int64 remainingQTY = 0;
            if (toLocationRefill != null)
            {
                if (toLocationRefill.MaximumStock != 0)
                    remainingQTY = toLocationRefill.MaximumStock - toLocationRefill.CurrenStock;
            }


            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("warehouse_GetRefillMaterialDetails", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_FromLocationName", fromLocationName);
                ArticlesCommand.Parameters.AddWithValue("_ToLocationName", toLocationName);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {
                    while (articlesReader.Read())
                    {

                        try
                        {
                            if (toLocationRefill != null && toLocationRefill.MaximumStock != 0)
                            {
                                if (remainingQTY == 0)
                                    break;
                            }

                            TransferMaterials transferMaterial = new TransferMaterials();

                            if (articlesReader["IdArticle"] != DBNull.Value)
                            {
                                transferMaterial.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);
                                transferMaterial.Article = new Article();
                                transferMaterial.Article.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);
                                if (articlesReader["Reference"] != DBNull.Value)
                                    transferMaterial.Article.Reference = articlesReader["Reference"].ToString();

                                transferMaterial.Article.MyWarehouse = new MyWarehouse();

                                if (articlesReader["WarehouseMinStock"] != DBNull.Value)
                                    transferMaterial.Article.MyWarehouse.MinimumStock = Convert.ToInt64(articlesReader["WarehouseMinStock"]);

                                if (articlesReader["WarehouseMaxStock"] != DBNull.Value)
                                    transferMaterial.Article.MyWarehouse.MaximumStock = Convert.ToInt64(articlesReader["WarehouseMaxStock"]);

                            }


                            if (articlesReader["Reference"] != DBNull.Value)
                                transferMaterial.Reference = articlesReader["Reference"].ToString();

                            //if (articlesReader["CurrentStock"] != DBNull.Value)
                            //    transferMaterial.CurrentStock = Convert.ToInt64(articlesReader["CurrentStock"]);

                            if (articlesReader["costprice"] != DBNull.Value)
                                transferMaterial.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                            if (articlesReader["UnitPrice"] != DBNull.Value)
                                transferMaterial.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                            if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                transferMaterial.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                transferMaterial.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (toLocationRefill != null && toLocationRefill.MaximumStock != 0)
                            {
                                if (articlesReader["Quantity"] != DBNull.Value)
                                {
                                    transferMaterial.Quantity = Convert.ToInt32(articlesReader["Quantity"]);
                                    if (transferMaterial.Quantity > remainingQTY)
                                    {
                                        transferMaterial.Quantity = remainingQTY;
                                        remainingQTY = 0;
                                    }
                                    else
                                    {
                                        remainingQTY = remainingQTY - transferMaterial.Quantity;
                                    }
                                }
                            }

                            else
                            {
                                if (articlesReader["Quantity"] != DBNull.Value)
                                {
                                    transferMaterial.Quantity = Convert.ToInt32(articlesReader["Quantity"]);
                                }
                            }

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                transferMaterial.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                transferMaterial.LocationFullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["Description"] != DBNull.Value)
                                transferMaterial.Description = articlesReader["Description"].ToString();

                            transferMaterial.ArticleVisualAidsPath = ArticleVisualAidsPath;
                            if (articlesReader["ImagePath"] != DBNull.Value)
                            {
                                transferMaterial.ImagePath = articlesReader["ImagePath"].ToString();
                                Article article = new Article();
                                article.ImagePath = transferMaterial.ImagePath;
                                transferMaterial.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                            }

                            //if (articlesReader["MinimumStock"] != DBNull.Value)
                            //    transferMaterial.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                            //if (articlesReader["MaximumStock"] != DBNull.Value)
                            //    transferMaterial.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                            if (articlesReader["UploadedIn"] != DBNull.Value)
                                transferMaterial.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);

                            if (articlesReader["IdCurrency"] != DBNull.Value)
                                transferMaterial.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                            if (articlesReader["DeliveryNoteCode"] != DBNull.Value)
                            {
                                transferMaterial.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                transferMaterial.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryNoteCode"]);
                            }


                            transferMaterialsList.Add(transferMaterial);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRefillMaterialDetails(FromLocationName-{0}, idWarehouse-{1}). ErrorMessage- {2}", fromLocationName, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }
            return transferMaterialsList;
        }

        /// <summary>
        /// This method is to add article warehouse location related to fullname
        /// </summary>
        /// <param name="mainServerConnectionString">Get main server connection string (geos db)</param>
        /// <param name="articleWarehouseLocation">Get article warehouse location details</param>
        /// <returns>Get article warehouse location details</returns>
        public ArticleWarehouseLocations AddArticleWarehouseLocationByFullName(string mainServerConnectionString, ArticleWarehouseLocations articleWarehouseLocation)
        {
            if (articleWarehouseLocation != null)
            {
                TransactionScope transactionScope = null;
                try
                {
                    using (transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("article_warehouse_locations_InsertByFullName", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;
                            mySqlCommand.Parameters.AddWithValue("_WarehouseLocationFullName", articleWarehouseLocation.WarehouseLocation.FullName);
                            mySqlCommand.Parameters.AddWithValue("_Position", articleWarehouseLocation.Position);
                            mySqlCommand.Parameters.AddWithValue("_IdArticle", articleWarehouseLocation.IdArticle);
                            mySqlCommand.Parameters.AddWithValue("_MinimumStock", articleWarehouseLocation.MinimumStock);
                            mySqlCommand.Parameters.AddWithValue("_IdWarehouse", articleWarehouseLocation.WarehouseLocation.IdWarehouse);
                            articleWarehouseLocation.IdArticleWarehouseLocation = Convert.ToInt32(mySqlCommand.ExecuteScalar());
                            mySqlConnection.Close();
                        }


                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return articleWarehouseLocation;
        }

        /// <summary>
        /// This method is to check is exist warehouse location full name
        /// </summary>
        /// <param name="fullName">Fullname warehouse location</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <returns>If true exist warehouse location full name otherwise false</returns>
        public bool IsExistWarehouseLocationFullName(string fullName, long idWarehouse, string connectionString)
        {
            bool isExist = false;
            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("warehouse_locations_IsExistFullName", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_FullName", fullName);
                    mySqlCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        if (reader.Read())
                        {
                            if (reader["FullName"] != DBNull.Value)
                                isExist = true;
                            else
                                isExist = false;
                        }
                        else
                        {
                            isExist = false;
                        }

                    }
                    mySqlConnection.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error IsExistWarehouseLocationName(FullName-{0}, idWarehouse-{1}). ErrorMessage- {2}", fullName, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return isExist;
        }

        /// <summary>
        /// This method is to get articles for decomposition scan
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idOt">Get id ot</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="parentOtItem">Get parent otitem</param>
        /// <param name="ArticleVisualAidsPath">Get article image path</param>
        /// <param name="otItemSameReferences">Get otitem same reference</param>
        /// <param name="idArticleType">Get id article type</param>
        /// <returns>List of otitem details</returns>
        public List<OtItem> GetArticlesForDecompositionScan(string connectionString, Int64 idOt, Int64 idWarehouse, OtItem parentOtItem, string ArticleVisualAidsPath, List<OtItemSameReference> otItemSameReferences, Int64 idArticleType)
        {
            List<OtItem> otItems = new List<OtItem>();


            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetArticlesForDecomposition", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOTitem", parentOtItem.IdOTItem);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            // keyId++;

                            OtItem otItem = new OtItem();
                            otItem.IdOT = idOt;
                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);

                            if (otItemReader["IdItemOtStatus"] != DBNull.Value)
                                otItem.IdItemOtStatus = Convert.ToByte(otItemReader["IdItemOtStatus"]);


                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);



                                if (otItemReader["IdComponent"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otItemReader["IdComponent"]);
                                }

                                //   otItem.KeyId = keyId;

                                if (otItemReader["idParent"] != DBNull.Value)
                                {
                                    otItem.ParentId = Convert.ToInt32(otItemReader["idParent"]);
                                }

                                if (otItem.ParentId == -1)
                                {
                                    otItem.ParentId = parentOtItem.KeyId;
                                    otItem.RevisionItem.Quantity = parentOtItem.RevisionItem.Quantity * Convert.ToDecimal(otItemReader["Quantity"]);
                                }
                                else
                                {
                                    //OtItem otItem213 = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId);

                                    decimal qty = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).RevisionItem.Quantity;
                                    otItem.RevisionItem.Quantity = qty * Convert.ToDecimal(otItemReader["Quantity"]);
                                    otItem.ParentId = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).KeyId;
                                }

                                //if (otItemReader["WpDescription"] != DBNull.Value)
                                //    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["Description"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["Description"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Weight"] != DBNull.Value)
                                        article.Weight = Convert.ToDecimal(otItemReader["Weight"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);
                                }


                                int downloaded = GetOtItemDownloadedQuantity(connectionString, otItem.RevisionItem.WarehouseProduct.Article.IdArticle, otItem.IdOTItem, otItem.RevisionItem.WarehouseProduct.IdComponent, idWarehouse);


                                otItem.RevisionItem.DownloadedQuantity = downloaded;

                                otItem.RevisionItem.RemainingQuantity = ((Int64)otItem.RevisionItem.Quantity - downloaded);

                                if ((Int64)otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;
                            }
                            otItem.PickingMaterialsList = new List<PickingMaterials>();
                            if (idArticleType != 2)
                                FillPickingMaterial_V2030(connectionString, otItem, idWarehouse, ArticleVisualAidsPath, otItems, otItemSameReferences);

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticlesForDecompositionScan(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }

            return otItems;
        }

        /// <summary>
        /// This method is to get work order status
        /// </summary>
        /// <param name="idOT">Get id ot</param>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <returns>Status</returns>
        public Int16 GetWorkorderStatus(Int64 idOT, string connectionString)
        {
            Int16 status = 0;
            double actualQuantity = 0;
            double downloadedQuantity = 0;
            double remainingQuantity = 0;
            Ots ot = new Ots();
            ot.IdOT = idOT;
            ot.OtItems = new List<OtItem>();
            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("otitems_GetWorkorderStatus", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdOT", idOT);
                    mySqlCommand.CommandTimeout = 8000;
                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {

                        while (reader.Read())
                        {

                            OtItem otItem = new OtItem();
                            if (reader["IdOT"] != DBNull.Value)
                                otItem.IdOT = Convert.ToInt64(reader["IdOT"]);
                            if (reader["IdOtItem"] != DBNull.Value)
                                otItem.IdOTItem = Convert.ToInt64(reader["IdOtItem"]);
                            if (reader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(reader["IdRevisionItem"]);
                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = Convert.ToInt64(reader["IdRevisionItem"]);
                                otItem.RevisionItem.Quantity = Convert.ToDecimal(reader["Quantity"]);
                                if (reader["DownloadedQty"] != DBNull.Value)
                                    otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(reader["DownloadedQty"]);

                                if (reader["RemainingQty"] != DBNull.Value)
                                    otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(reader["RemainingQty"]);
                            }
                            otItem.ArticleDecomposedList = new List<OtItem>();
                            ot.OtItems.Add(otItem);

                        }

                        if (reader.NextResult())
                        {
                            while (reader.Read())
                            {
                                try
                                {

                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(reader["idotitem"])).FirstOrDefault();

                                    OtItem decomposed = new OtItem();
                                    if (otitem != null)
                                    {

                                        decomposed.IdOT = ot.IdOT;
                                        decomposed.IdOTItem = Convert.ToInt64(reader["IdOtItem"]);

                                        if (reader["idParent"] != DBNull.Value)
                                        {
                                            decomposed.ParentId = Convert.ToInt32(reader["idParent"]);
                                        }
                                        decomposed.RevisionItem = new RevisionItem();
                                        decomposed.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                        decomposed.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(reader["IdWarehouseproduct"]);



                                        if (reader["IdComponent"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(reader["IdComponent"]);
                                        }
                                        if (decomposed.ParentId == -1)
                                        {
                                            if (reader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = otitem.RevisionItem.Quantity * Convert.ToDecimal(reader["Quantity"]);
                                        }
                                        else
                                        {
                                            decimal qty = 0;
                                            if (otitem.ArticleDecomposedList != null)
                                            {
                                                if (otitem.ArticleDecomposedList.Any(x => x.RevisionItem.WarehouseProduct.IdComponent == decomposed.ParentId))
                                                    qty = otitem.ArticleDecomposedList.FirstOrDefault(x => x.RevisionItem.WarehouseProduct.IdComponent == decomposed.ParentId).RevisionItem.Quantity;
                                            }

                                            if (reader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = qty * Convert.ToDecimal(reader["Quantity"]);
                                        }

                                        if (reader["IdArticle"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                        }

                                        // int downloaded = GetOtItemDownloadedQuantity(connectionString, decomposed.RevisionItem.WarehouseProduct.IdArticle, decomposed.IdOTItem, decomposed.RevisionItem.WarehouseProduct.IdComponent, Convert.ToInt64(warehouseIds));


                                        decomposed.RevisionItem.DownloadedQuantity = 0;

                                        //  decomposed.RevisionItem.RemainingQuantity = ((Int64)decomposed.RevisionItem.Quantity - downloaded);




                                        otitem.ArticleDecomposedList.Add(decomposed);

                                    }
                                }

                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrders() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                    throw;
                                }
                            }
                            // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                        }

                        if (reader.NextResult())
                        {
                            while (reader.Read())
                            {
                                try
                                {

                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(reader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {
                                        if (otitem.ArticleDecomposedList != null)
                                        {
                                            if (otitem.ArticleDecomposedList.Count > 0)
                                            {
                                                OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(reader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(reader["idarticle"]) && i.RevisionItem.WarehouseProduct.IdComponent == Convert.ToInt64(reader["idwarehouseproductcomponent"])).FirstOrDefault();
                                                if (otitemad != null)
                                                {
                                                    if (reader["downloadedQty"] != DBNull.Value)
                                                        otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(reader["downloadedQty"]);
                                                }
                                            }
                                        }

                                    }
                                }

                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrders() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                    throw;
                                }
                            }
                        }

                        if (reader.NextResult())
                        {
                            while (reader.Read())
                            {
                                try
                                {

                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(reader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {
                                        if (otitem.ArticleDecomposedList != null)
                                        {
                                            if (otitem.ArticleDecomposedList.Count > 0)
                                            {
                                                OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(reader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(reader["idarticle"])).FirstOrDefault();
                                                if (otitemad != null)
                                                {
                                                    if (reader["downloadedQty"] != DBNull.Value)
                                                        otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(reader["downloadedQty"]);
                                                }
                                            }
                                        }
                                    }
                                }

                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrders() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                    throw;
                                }
                            }
                        }

                        Int64 downloadedQty = 0;
                        decimal Qty = 0;
                        foreach (OtItem itemOtitem in ot.OtItems)
                        {
                            if (itemOtitem.ArticleDecomposedList != null)
                            {

                                if (itemOtitem.ArticleDecomposedList.Count > 0)
                                {
                                    downloadedQty = downloadedQty + Math.Abs(itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.DownloadedQuantity));
                                    Qty = Qty + itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.Quantity);
                                    // ot.Status = (Int16)((Math.Abs(ot.DownloadedQuantity) / ot.ActualQuantity) * 100);

                                }
                                else
                                {
                                    downloadedQty = downloadedQty + Math.Abs(itemOtitem.RevisionItem.DownloadedQuantity);
                                    Qty = Qty + itemOtitem.RevisionItem.Quantity;
                                }
                            }
                            else
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.RevisionItem.DownloadedQuantity);
                                Qty = Qty + itemOtitem.RevisionItem.Quantity;
                            }

                        }
                        status = (Int16)((Math.Abs(downloadedQty) / Qty) * 100);

                    }
                    mySqlConnection.Close();
                }

            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetWorkorderStatus(IdOT-{0}). ErrorMessage- {1}", idOT, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return status;
        }

        /// <summary>
        /// This method is to get max position 
        /// </summary>
        /// <param name="idParent">Get id parent</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <returns>Get max position</returns>
        public Int64 GetMaxPosition(Int64 idParent, Int64 idWarehouse, string connectionString)
        {
            Int64 Pos = 0;
            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("warehouselocations_GetMaxPosition", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_Parent", idParent);
                    mySqlCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        if (reader.Read())
                        {
                            if (reader["pos"] != DBNull.Value)
                                Pos = Convert.ToInt64(reader["pos"]);
                        }

                    }
                    mySqlConnection.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetMaxPosition(Parent-{0}, idWarehouse-{1}). ErrorMessage- {2}", idParent, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return Pos;
        }

        /// <summary>
        /// This method is to update reindex warehouse location
        /// </summary>
        /// <param name="idWarehouseLocation">Get id warehouse location</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="idParent">Get id parent</param>
        /// <param name="mainConnectionString">Get main server connection string (geos db)</param>
        /// <returns>If true updated reindex warehouse location otherwise false</returns>
        public bool UpdateReIndexWarehouselocation(Int64 idWarehouseLocation, Int64 idWarehouse, Int64 idParent, string mainConnectionString)
        {
            List<WarehouseLocation> warehouseLocationLst = new List<WarehouseLocation>();
            Int64 position = 0;
            bool isUpdated = false;


            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(mainConnectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("warehouselocation_GetWarehouseLocationByParent", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_Parent", idParent);
                    mySqlCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            WarehouseLocation warehouseLocation = new WarehouseLocation();
                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                                warehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);
                            if (reader["IdWarehouse"] != DBNull.Value)
                                warehouseLocation.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);
                            if (reader["Parent"] != DBNull.Value)
                                warehouseLocation.Parent = Convert.ToInt64(reader["Parent"]);
                            if (reader["Position"] != DBNull.Value)
                                warehouseLocation.Position = Convert.ToInt64(reader["Position"]);
                            if (reader["FullName"] != DBNull.Value)
                                warehouseLocation.FullName = Convert.ToString(reader["FullName"]);
                            warehouseLocationLst.Add(warehouseLocation);

                        }

                    }
                    mySqlConnection.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetAllWarehouselocation(idParent-{0}, idWarehouse-{1}). ErrorMessage- {2}", idParent, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            Int64 AddedPosition = warehouseLocationLst.Where(i => i.IdWarehouseLocation == idWarehouseLocation).FirstOrDefault().Position;


            position = 1;
            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {


                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainConnectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("warehouselocations_UpdatePosition", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        bool IsChecked = false;
                        foreach (WarehouseLocation item in warehouseLocationLst.Where(i => i.Position > 0 && i.IdWarehouseLocation != idWarehouseLocation).OrderBy(wl => wl.Position))
                        {

                            if (position == AddedPosition)
                            {
                                position = position + 1;
                            }

                            mySqlCommand.Parameters.Clear();
                            mySqlCommand.Parameters.AddWithValue("_IdWarehouseLocation", item.IdWarehouseLocation);
                            mySqlCommand.Parameters.AddWithValue("_Position", position);
                            mySqlCommand.ExecuteNonQuery();
                            item.Position = position;
                            position = position + 1;
                        }


                        Dictionary<Int64, Int64> dict = new Dictionary<Int64, Int64>();
                        foreach (WarehouseLocation item in warehouseLocationLst.Where(i => i.Position > 0).OrderBy(wl => wl.Position))
                        {
                            dict.Add(item.IdWarehouseLocation, item.Position);
                        }

                        position = 0;
                        //  position = warehouseLocationLst.Where(i => i.Position > 0).Count();
                        foreach (WarehouseLocation item in warehouseLocationLst.Where(i => i.Position == 0).OrderBy(wl => wl.IdWarehouseLocation))
                        {
                            isCheckedPosition = false;
                            //if(dict.Any(i=>i.Value==position))
                            //{
                            if (position == 0)
                            {
                                position = position + 1;
                            }

                            checkPosition(position, dict);
                            position = addedPosition;
                            //position = position + 1;
                            //  }

                            mySqlCommand.Parameters.Clear();
                            mySqlCommand.Parameters.AddWithValue("_IdWarehouseLocation", item.IdWarehouseLocation);
                            mySqlCommand.Parameters.AddWithValue("_Position", position);
                            mySqlCommand.ExecuteNonQuery();
                            item.Position = position;
                            position = position + 1;


                        }

                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error UpdateReIndexWarehouselocation(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }
            return isUpdated;
        }

        /// <summary>
        /// This method is to check position
        /// </summary>
        /// <param name="position">Position</param>
        /// <param name="dict">Dictionary to check</param>
        private void checkPosition(Int64 position, Dictionary<Int64, Int64> dict)
        {
            if (isCheckedPosition == false)
            {
                if (!dict.Any(i => i.Value == position))
                {
                    isCheckedPosition = true;
                    addedPosition = position;
                    return;
                }
                else
                {
                    position = position + 1;
                    if (isCheckedPosition == false)
                    {
                        checkPosition(position, dict);
                    }
                    else
                    {
                        return;
                    }


                }
            }
            else
            {
                return;
            }

        }

        /// <summary>
        /// This method is to get warehouse location to place article
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="reference">Get reference</param>
        /// <returns>List of warehouse location details</returns>
        public List<WarehouseLocation> GetWarehouseLocationToPlaceArticle(string connectionString, Int64 idWarehouse, string reference)
        {
            List<WarehouseLocation> warehouseLocationLst = new List<WarehouseLocation>();

            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("warehouselocation_GetWarehouseLocationToPlaceArticle", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                    mySqlCommand.Parameters.AddWithValue("_Reference", reference);
                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            WarehouseLocation warehouseLocation = new WarehouseLocation();
                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                                warehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                            if (reader["FullName"] != DBNull.Value)
                                warehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                            if (reader["qty"] != DBNull.Value)
                                warehouseLocation.Quantity = Convert.ToInt64(reader["qty"]);

                            warehouseLocationLst.Add(warehouseLocation);

                        }

                    }
                    mySqlConnection.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetWarehouseLocationToPlaceArticle(idWarehouse-{0}, reference-{1}). ErrorMessage- {2}", idWarehouse, reference, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return warehouseLocationLst;
        }

        /// <summary>
        /// This method is to get warehouse location related to fullname
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="fullName">Get fullname</param>
        /// <returns> warehouse location details</returns>
        public WarehouseLocation GetWarehouseLocationByFullName(string connectionString, Int64 idWarehouse, string fullName)
        {
            WarehouseLocation warehouseLocation = new WarehouseLocation();
            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("warehouselocation_GetWarehouseLocationByFullName", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                    mySqlCommand.Parameters.AddWithValue("_FullName", fullName);
                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        if (reader.Read())
                        {

                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                                warehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                            if (reader["FullName"] != DBNull.Value)
                                warehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                            if (reader["Position"] != DBNull.Value)
                                warehouseLocation.Position = Convert.ToInt64(reader["Position"]);

                            if (reader["Parent"] != DBNull.Value)
                                warehouseLocation.Parent = Convert.ToInt64(reader["Parent"]);

                            if (reader["IdWarehouse"] != DBNull.Value)
                                warehouseLocation.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                            if (reader["FileName"] != DBNull.Value)
                                warehouseLocation.FileName = Convert.ToString(reader["FileName"]);

                            if (reader["Latitude"] != DBNull.Value)
                                warehouseLocation.Latitude = Convert.ToDouble(reader["Latitude"]);

                            if (reader["Longitude"] != DBNull.Value)
                                warehouseLocation.Longitude = Convert.ToDouble(reader["Longitude"]);

                            if (reader["Width"] != DBNull.Value)
                                warehouseLocation.Width = Convert.ToDouble(reader["Width"]);

                            if (reader["Height"] != DBNull.Value)
                                warehouseLocation.Height = Convert.ToDouble(reader["Height"]);

                        }

                    }
                    mySqlConnection.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetWarehouseLocationByFullName(idWarehouse-{0}, FullName-{1}). ErrorMessage- {2}", idWarehouse, fullName, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return warehouseLocation;
        }

        /// <summary>
        /// This method is to get idot related to barcode
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="barcode">Get barcode details</param>
        /// <returns>Get IdOT</returns>
        public Int64 GetIdOtByBarcode(string connectionString, string barcode)
        {
            Int64 idOT = 0;
            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("ots_GetIdOtByBarcode", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_barcode", barcode);

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        if (reader.Read())
                        {

                            if (reader["IdOT"] != DBNull.Value)
                                idOT = Convert.ToInt64(reader["IdOT"]);


                        }

                    }
                    mySqlConnection.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetIdOtByBarCode( IdOT-{0}). ErrorMessage- {1}", idOT, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return idOT;
        }

        /// <summary>
        /// This method is to get all articles related to warehouse location fullname
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="warehouseIds">Get selected warehouses ids</param>
        /// <param name="warehouse">Get warehouse details</param>
        /// <param name="fullName">Get fullname </param>
        /// <returns>List of articles details</returns>
        public List<Article> GetAllArticlesByWLFullName(string connectionString, string warehouseIds, Warehouses warehouse, string fullName)
        {
            string whConnectionString = warehouse.Company.ConnectPlantConstr;
            List<Article> articles = new List<Article>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(whConnectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("warehouse_GetAllArticlesByWLFullName", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouseIds);
                mySqlCommand.Parameters.AddWithValue("_FullName", fullName);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            Article article = new Article();

                            if (reader["IdArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                            if (reader["Reference"] != DBNull.Value)
                                article.Reference = Convert.ToString(reader["Reference"]);

                            if (reader["Description"] != DBNull.Value)
                                article.Description = Convert.ToString(reader["Description"]);

                            if (reader["Weight"] != DBNull.Value)
                                article.Weight = Math.Round(Convert.ToDecimal(reader["Weight"]), 3);

                            if (reader["Length"] != DBNull.Value)
                                article.Length = (float)reader["Length"];

                            if (reader["Width"] != DBNull.Value)
                                article.Width = (float)reader["Width"];

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)reader["Height"];


                            if (reader["IdArticleCategory"] != DBNull.Value)
                            {
                                article.IdArticleCategory = Convert.ToInt32(reader["IdArticleCategory"]);

                                article.ArticleCategory = new ArticleCategory();
                                article.ArticleCategory.IdArticleCategory = Convert.ToInt32(reader["IdArticleCategory"]);
                                article.ArticleCategory.Name = Convert.ToString(reader["ArticleCategory"]);
                            }



                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                                article.ArticleWarehouseLocation.IdWarehouseLocation = Convert.ToInt32(reader["IdWarehouseLocation"]);

                                if (reader["awlPosition"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.Position = Convert.ToInt64(reader["awlPosition"]);

                                if (reader["MinimumStock"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);

                                if (reader["MaximumStock"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.MaximumStock = Convert.ToInt64(reader["MaximumStock"]);

                                article.ArticleWarehouseLocation.WarehouseLocation = new WarehouseLocation();
                                article.ArticleWarehouseLocation.WarehouseLocation.IdWarehouseLocation = article.ArticleWarehouseLocation.IdWarehouseLocation;

                                if (reader["wlPosition"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.Position = Convert.ToInt64(reader["wlPosition"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                                if (reader["Name"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.Name = Convert.ToString(reader["Name"]);

                                if (reader["Parent"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.Parent = Convert.ToInt64(reader["Parent"]);

                                if (reader["FullName"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                                if (reader["HtmlColor"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                                article.ArticleWarehouseLocation.ArticlesStock = new ArticlesStock();
                                article.ArticleWarehouseLocation.ArticlesStock.IdWarehouseLocation = Convert.ToUInt64(article.ArticleWarehouseLocation.IdWarehouseLocation);

                                if (reader["ArticleStock"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.ArticlesStock.Quantity = Convert.ToInt64(reader["ArticleStock"]);

                                articles.Add(article);
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetAllArticlesByWLFullName(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return articles;
        }

        /// <summary>
        /// This method is to get refill to list related to fullname
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="fullName">Get fullname</param>
        /// <returns>List of location refill details</returns>
        public List<LocationRefill> GetRefillToListByFullName(string connectionString, string idWarehouse, string fullName)
        {
            List<LocationRefill> locationRefills = new List<LocationRefill>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("warehouse_GetRefillToListByFullName", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdsWarehouse", idWarehouse);
                concommand.Parameters.AddWithValue("_FullName", fullName);


                using (MySqlDataReader dNReader = concommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        LocationRefill locationRefill = new LocationRefill();
                        if (dNReader["IdWarehouseLocation"] != DBNull.Value)
                            locationRefill.IdWarehouseLocation = Convert.ToInt64(dNReader["IdWarehouseLocation"]);
                        if (dNReader["Position"] != DBNull.Value)
                            locationRefill.Position = Convert.ToInt64(dNReader["Position"]);

                        if (dNReader["IdArticle"] != DBNull.Value)
                            locationRefill.IdArticle = Convert.ToInt32(dNReader["IdArticle"]);

                        if (dNReader["MinimumStock"] != DBNull.Value)
                            locationRefill.MinimumStock = Convert.ToInt64(dNReader["MinimumStock"]);

                        if (dNReader["FullName"] != DBNull.Value)
                            locationRefill.FullName = Convert.ToString(dNReader["FullName"]);

                        if (dNReader["CurrentStock"] != DBNull.Value)
                            locationRefill.CurrenStock = Convert.ToInt64(dNReader["CurrentStock"]);

                        if (dNReader["MaximumStock"] != DBNull.Value)
                            locationRefill.MaximumStock = Convert.ToInt64(dNReader["MaximumStock"]);

                        locationRefills.Add(locationRefill);
                    }
                }
            }

            return locationRefills;
        }


        /// <summary>
        /// This method is to get supplier complaints
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <returns>List of supplier complaints</returns>
        public List<SupplierComplaint> GetSupplierComplaints(string connectionString, string idWarehouse)
        {
            List<SupplierComplaint> supplierComplaints = new List<SupplierComplaint>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("suppliercomplaints_GetSupplierComplaints", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdsWarehouse", idWarehouse);

                using (MySqlDataReader dNReader = concommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        SupplierComplaint supplierComplaint = new SupplierComplaint();

                        if (dNReader["IdSupplierComplaint"] != DBNull.Value)
                            supplierComplaint.IdSupplierComplaint = Convert.ToInt64(dNReader["IdSupplierComplaint"]);

                        if (dNReader["Code"] != DBNull.Value)
                            supplierComplaint.Code = Convert.ToString(dNReader["Code"]);

                        if (dNReader["Supplier"] != DBNull.Value)
                        {
                            supplierComplaint.Supplier = new ArticleSupplier();
                            supplierComplaint.Supplier.Name = Convert.ToString(dNReader["Supplier"]);
                        }

                        if (dNReader["ComplaintStatus"] != DBNull.Value)
                        {
                            supplierComplaint.ComplaintStatus = new ComplaintStatus();
                            supplierComplaint.ComplaintStatus.Name = Convert.ToString(dNReader["ComplaintStatus"]);
                        }

                        //if (dNReader["ActualQty"] != DBNull.Value)
                        //    supplierComplaint.ActualQuantity = Convert.ToInt64(dNReader["ActualQty"]);

                        //if (dNReader["DownloadedQty"] != DBNull.Value)
                        //    supplierComplaint.DownloadedQuantity = Convert.ToInt64(dNReader["DownloadedQty"]);

                        //supplierComplaint.RemainingQuantity = supplierComplaint.ActualQuantity + supplierComplaint.DownloadedQuantity;
                        //if(supplierComplaint.RemainingQuantity==0)
                        //{
                        //    supplierComplaint.Progress = 0;
                        //}

                        //if (supplierComplaint.ActualQuantity > 0)
                        //{
                        //    //supplierComplaint.Progress = (Int16)((Math.Abs(supplierComplaint.DownloadedQuantity) / supplierComplaint.ActualQuantity) * 100);
                        //    supplierComplaint.Progress = (Int16)(((supplierComplaint.ActualQuantity + (supplierComplaint.DownloadedQuantity)) / supplierComplaint.ActualQuantity) * 100);
                        //}

                        supplierComplaints.Add(supplierComplaint);
                    }
                }
            }

            return supplierComplaints;
        }


        /// <summary>
        /// This method is to get supplier complaints details
        /// </summary>
        /// <param name="idSupplierComplaint">Get id supplier complaint</param>
        /// <param name="warehouse">Get warehouse details</param>
        /// <returns>Supplier complaint details</returns>
        public SupplierComplaint GetSupplierComplaintDetails(Int64 idSupplierComplaint, Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            SupplierComplaint supplierComplaint = null;

            using (MySqlConnection connSC = new MySqlConnection(connectionString))
            {
                connSC.Open();

                MySqlCommand stCommand = new MySqlCommand("suppliercomplaints_GetMaterialSCInformationByIdSC", connSC);
                stCommand.CommandType = CommandType.StoredProcedure;
                stCommand.Parameters.AddWithValue("_IdSupplierComplaint", idSupplierComplaint);

                using (MySqlDataReader scReader = stCommand.ExecuteReader())
                {
                    if (scReader.Read())
                    {
                        try
                        {
                            supplierComplaint = new SupplierComplaint();
                            supplierComplaint.IdSupplierComplaint = idSupplierComplaint;

                            if (scReader["Code"] != DBNull.Value)
                                supplierComplaint.Code = Convert.ToString(scReader["Code"]);

                            if (scReader["Comments"] != DBNull.Value)
                                supplierComplaint.Comments = Convert.ToString(scReader["Comments"]);

                            if (scReader["CreatedBy"] != DBNull.Value)
                            {
                                supplierComplaint.CreatedBy = Convert.ToInt32(scReader["CreatedBy"]);

                                supplierComplaint.CreatedByPerson = new People();
                                supplierComplaint.CreatedByPerson.IdPerson = Convert.ToInt32(supplierComplaint.CreatedBy);
                                supplierComplaint.CreatedByPerson.Name = Convert.ToString(scReader["CreatedByName"]);
                                supplierComplaint.CreatedByPerson.Surname = Convert.ToString(scReader["CreatedBySurname"]);
                            }


                            if (scReader["CreationIn"] != DBNull.Value)
                                supplierComplaint.CreatedIn = Convert.ToDateTime(scReader["CreationIn"]);

                            //ModifiedBy
                            if (scReader["ModifiedBy"] != DBNull.Value)
                            {
                                supplierComplaint.ModifiedBy = Convert.ToInt32(scReader["ModifiedBy"]);

                                supplierComplaint.ModifiedByPerson = new People();
                                supplierComplaint.ModifiedByPerson.IdPerson = Convert.ToInt32(supplierComplaint.ModifiedBy);
                                supplierComplaint.ModifiedByPerson.Name = Convert.ToString(scReader["ModifiedByName"]);
                                supplierComplaint.ModifiedByPerson.Surname = Convert.ToString(scReader["ModifiedBySurname"]);
                            }

                            if (scReader["ModifiedIn"] != DBNull.Value)
                                supplierComplaint.ModifiedIn = Convert.ToDateTime(scReader["ModifiedIn"]);

                            if (scReader["ExpectedDate"] != DBNull.Value)
                                supplierComplaint.ExpectedDate = Convert.ToDateTime(scReader["ExpectedDate"]);

                            if (scReader["SupplierName"] != DBNull.Value)
                            {
                                supplierComplaint.Supplier = new ArticleSupplier();
                                supplierComplaint.Supplier.Name = Convert.ToString(scReader["SupplierName"]);
                            }





                            supplierComplaint.SupplierComplaintItems = GetSCItemsByIdSC(connectionString, idSupplierComplaint, warehouse.IdWarehouse);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetSupplierComplaint(idSupplierComplaint-{0}, idWarehouse-{1}). ErrorMessage- {2} ", idSupplierComplaint, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetSupplierComplaint().", category: Category.Info, priority: Priority.Low);
            return supplierComplaint;
        }

        /// <summary>
        /// This method is used to show ot items by idot.
        /// </summary>
        /// <param name="connectionString">The connection string of server.</param>
        /// <param name="idOt">The idot.</param>
        /// <param name="idWarehouse">The connected plant id.</param>
        /// <returns>List of supplier complaint item details</returns>
        public List<SupplierComplaintItem> GetSCItemsByIdSC(string connectionString, Int64 idSupplierComplaint, Int64 idWarehouse)
        {
            List<SupplierComplaintItem> scItems = new List<SupplierComplaintItem>();

            using (MySqlConnection connscItem = new MySqlConnection(connectionString))
            {
                connscItem.Open();

                MySqlCommand scItemCommand = new MySqlCommand("suppliercomplaintsitems_GetSCItemsByIdSC", connscItem);
                scItemCommand.CommandType = CommandType.StoredProcedure;
                scItemCommand.Parameters.AddWithValue("_IdSupplierComplaint", idSupplierComplaint);
                scItemCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader scItemReader = scItemCommand.ExecuteReader())
                {
                    int keyId = 0;
                    while (scItemReader.Read())
                    {
                        try
                        {
                            SupplierComplaintItem scitem = new SupplierComplaintItem();

                            scitem.KeyId = keyId;
                            scitem.ParentId = -1;

                            scitem.IdSupplierComplaint = idSupplierComplaint;

                            scitem.IdSupplierComplaintItem = Convert.ToInt64(scItemReader["IdSupplierComplaintItem"]);

                            if (scItemReader["Quantity"] != DBNull.Value)
                                scitem.Quantity = Convert.ToInt64(scItemReader["Quantity"]);

                            if (scItemReader["UnitPrice"] != DBNull.Value)
                                scitem.UnitPrice = Convert.ToDouble(scItemReader["UnitPrice"]);


                            if (scItemReader["IdArticle"] != DBNull.Value)
                            {
                                scitem.IdArticle = Convert.ToInt32(scItemReader["IdArticle"]);

                                Article article = new Article();
                                article.IdArticle = Convert.ToInt32(scItemReader["IdArticle"]);
                                article.IsGeneric = Convert.ToSByte(scItemReader["IsGeneric"]);
                                article.Reference = Convert.ToString(scItemReader["Reference"]);
                                article.IsObsolete = Convert.ToSByte(scItemReader["IsObsolete"]);

                                if (scItemReader["ArticleDescription"] != DBNull.Value)
                                    article.Description = Convert.ToString(scItemReader["ArticleDescription"]);

                                if (scItemReader["Description_es"] != DBNull.Value)
                                    article.Description_es = Convert.ToString(scItemReader["Description_es"]);

                                if (scItemReader["Description_fr"] != DBNull.Value)
                                    article.Description_fr = Convert.ToString(scItemReader["Description_fr"]);

                                article.ImagePath = Convert.ToString(scItemReader["ImagePath"]);
                                article.RegisterSerialNumber = Convert.ToByte(scItemReader["RegisterSerialNumber"]);


                                if (scItemReader["Weight"] != DBNull.Value)
                                    article.Weight = Convert.ToDecimal(scItemReader["Weight"]);

                                scitem.Article = article;
                            }


                            if (scItemReader["DownloadedQty"] != DBNull.Value)
                                scitem.DownloadedQuantity = Convert.ToInt64(scItemReader["DownloadedQty"]);

                            if (scItemReader["RemainingQty"] != DBNull.Value)
                                scitem.RemainingQuantity = Convert.ToInt64(scItemReader["RemainingQty"]);

                            if ((scitem.Quantity + scitem.DownloadedQuantity) == 0)
                            {
                                scitem.Progress = 0;
                            }
                            else if ((Int64)scitem.Quantity > 0)
                            {
                                scitem.Progress = (Int64)((Math.Abs(scitem.DownloadedQuantity) / scitem.Quantity) * 100);
                            }


                            scItems.Add(scitem);

                            keyId++;


                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetSCItemsByIdSC(idSupplierComplaint-{0}, idWarehouse-{1}). ErrorMessage- {2}", idSupplierComplaint, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }


            return scItems;
        }

        /// <summary>
        /// This method is to get remaining supplier complaint items related to Id supplier complaint
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idSupplierComplaint">Get id supplier complaint</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="ArticleVisualAidsPath">Get article image path</param>
        /// <returns>List of supplier complaint item details</returns>
        public List<SupplierComplaintItem> GetRemainingSCItemsByIdSC(string connectionString, Int64 idSupplierComplaint, Int64 idWarehouse, string ArticleVisualAidsPath)
        {
            List<SupplierComplaintItem> supplierComplaintItems = new List<SupplierComplaintItem>();

            using (MySqlConnection connSCItem = new MySqlConnection(connectionString))
            {
                connSCItem.Open();

                MySqlCommand scItemCommand = new MySqlCommand("warehouse_GetRemainingSCItemsByIdSC", connSCItem);
                scItemCommand.CommandType = CommandType.StoredProcedure;
                scItemCommand.Parameters.AddWithValue("_IdSupplierComplaint", idSupplierComplaint);
                scItemCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader scItemReader = scItemCommand.ExecuteReader())
                {
                    while (scItemReader.Read())
                    {
                        try
                        {
                            SupplierComplaintItem scItem = new SupplierComplaintItem();

                            scItem.IdSupplierComplaint = idSupplierComplaint;

                            if (scItemReader["IdSupplierComplaintItem"] != DBNull.Value)
                                scItem.IdSupplierComplaintItem = Convert.ToInt64(scItemReader["IdSupplierComplaintItem"]);

                            if (scItemReader["Quantity"] != DBNull.Value)
                                scItem.Quantity = Convert.ToInt64(scItemReader["Quantity"]);

                            if (scItemReader["UnitPrice"] != DBNull.Value)
                                scItem.UnitPrice = Convert.ToDouble(scItemReader["UnitPrice"]);

                            if (scItemReader["IdArticle"] != DBNull.Value)
                            {
                                scItem.IdArticle = Convert.ToInt32(scItemReader["IdArticle"]);

                                Article article = new Article();
                                article.IdArticle = Convert.ToInt32(scItemReader["IdArticle"]);
                                article.IsGeneric = Convert.ToSByte(scItemReader["IsGeneric"]);
                                article.Reference = Convert.ToString(scItemReader["Reference"]);
                                article.IsObsolete = Convert.ToSByte(scItemReader["IsObsolete"]);

                                if (scItemReader["ArticleDescription"] != DBNull.Value)
                                    article.Description = Convert.ToString(scItemReader["ArticleDescription"]);

                                //if (scItemReader["Description_es"] != DBNull.Value)
                                //    article.Description_es = Convert.ToString(scItemReader["Description_es"]);

                                //if (scItemReader["Description_fr"] != DBNull.Value)
                                //    article.Description_fr = Convert.ToString(scItemReader["Description_fr"]);

                                article.ImagePath = Convert.ToString(scItemReader["ImagePath"]);
                                article.RegisterSerialNumber = Convert.ToByte(scItemReader["RegisterSerialNumber"]);

                                //if (scItemReader["Weight"] != DBNull.Value)
                                //    article.Weight = Convert.ToDecimal(scItemReader["Weight"]);

                                article.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);

                                scItem.Article = article;
                            }

                            if (scItemReader["DownloadedQty"] != DBNull.Value)
                                scItem.DownloadedQuantity = Convert.ToInt64(scItemReader["DownloadedQty"]);

                            if (scItemReader["RemainingQty"] != DBNull.Value)
                                scItem.RemainingQuantity = Convert.ToInt64(scItemReader["RemainingQty"]);

                            //if ((Int64)scItem.Quantity > 0)
                            //{
                            //    //scItem.Progress = (Int64)((Math.Abs(scItem.DownloadedQuantity) / scItem.Quantity) * 100);

                            //    scItem.Progress = (Int64)(((scItem.Quantity + (scItem.DownloadedQuantity)) / scItem.Quantity) * 100);
                            //}

                            //FillPickingMaterialSC(connectionString, scItem, idWarehouse, ArticleVisualAidsPath);

                            supplierComplaintItems.Add(scItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRemainingSCItemsByIdSC(IdSupplierComplaint-{0}, idWarehouse-{1}). ErrorMessage- {2}", idSupplierComplaint, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return supplierComplaintItems;
        }

        /// <summary>
        /// This method is to fill picking material supplier complaint
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="scItem">Get supplier complaint Item details</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <param name="ArticleVisualAidsPath">Get article image path</param>
        public void FillPickingMaterialSC(string connectionString, SupplierComplaintItem scItem, Int64 idWarehouse, string ArticleVisualAidsPath)
        {

            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("warehouse_GetArticlesStockDetailsByIdArticleSC", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", scItem.IdArticle);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {
                    scItem.PickingMaterialsSCList = new List<PickingMaterialsSC>();
                    Int64 remainingQty = scItem.RemainingQuantity; // download Quantity.
                    while (articlesReader.Read())
                    {
                        try
                        {
                            if (remainingQty == 0)
                                return;

                            PickingMaterialsSC pickingMaterials = new PickingMaterialsSC();

                            pickingMaterials.IdArticle = scItem.IdArticle;
                            pickingMaterials.IdSCitem = scItem.IdSupplierComplaintItem;



                            if (!string.IsNullOrEmpty(scItem.Article.Reference))
                                pickingMaterials.Reference = scItem.Article.Reference;

                            if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                                pickingMaterials.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                            if (articlesReader["MinimumStock"] != DBNull.Value)
                                pickingMaterials.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"]);

                            if (articlesReader["costprice"] != DBNull.Value)
                                pickingMaterials.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                            if (articlesReader["UnitPrice"] != DBNull.Value)
                                pickingMaterials.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            {
                                pickingMaterials.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);


                                pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                                pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbers(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, Convert.ToInt64(articlesReader["IdWarehouse"])));
                            }


                            //if (articlesReader["IdArticleWarehouseLocation"] != DBNull.Value)
                            //    pickingMaterials.IdArticleWarehouseLocation = Convert.ToInt64(articlesReader["IdArticleWarehouseLocation"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.LocationFullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingMaterials.Description = articlesReader["Description"].ToString();

                            if (articlesReader["ImagePath"] != DBNull.Value)
                            {
                                pickingMaterials.ImagePath = articlesReader["ImagePath"].ToString();
                                Article article = new Article();
                                article.ImagePath = pickingMaterials.ImagePath;
                                pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                            }




                            pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                            if (articlesReader["UploadedIn"] != DBNull.Value)
                            {
                                pickingMaterials.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);
                                pickingMaterials.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(articlesReader["UploadedIn"]);
                            }

                            if (articlesReader["DeliveryCode"] != DBNull.Value)
                                pickingMaterials.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);

                            if (articlesReader["IdCurrency"] != DBNull.Value)
                                pickingMaterials.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                            // code for separate article quantity by available quantity as pe warehose delivery note item.
                            if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                            {
                                if (pickingMaterials.ArticleCurrentStock > remainingQty)
                                {
                                    pickingMaterials.DownloadQuantity = remainingQty;
                                    remainingQty = 0;
                                }
                                else
                                {
                                    pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                                    remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                                }
                            }

                            pickingMaterials.WarehouseLocation = new WarehouseLocation();

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.HtmlColor = articlesReader["HtmlColor"].ToString();

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingMaterials.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                            pickingMaterials.PartNumberCode = GetPartNumberCode(scItem.IdSupplierComplaintItem, connectionString);

                            if (articlesReader["IdCountryGroup"] != DBNull.Value)
                                pickingMaterials.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);

                            scItem.PickingMaterialsSCList.Add(pickingMaterials);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error FillPickikngMaterialSC(IdArticle-{0}, idWarehouse-{1}). ErrorMessage- {2}", scItem.IdArticle, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }
        }

        /// <summary>
        /// This method is to insert article stock
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="pickingMaterialsSc">Get picking material supplier complaint</param>
        /// <returns>If true inserted into article stock for supplier complaint otherwise false</returns>
        public bool InsertIntoArticleStockSC(string connectionString, PickingMaterialsSC pickingMaterialsSc)
        {
            TransactionScope transactionScope = null;

            using (transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection connWDN = new MySqlConnection(connectionString))
                    {
                        connWDN.Open();

                        MySqlCommand insertWDNCommand = new MySqlCommand("warehouse_InsertIntoArticlesStockSC", connWDN);
                        insertWDNCommand.CommandType = CommandType.StoredProcedure;

                        insertWDNCommand.Parameters.AddWithValue("_IdArticle", pickingMaterialsSc.IdArticle);
                        insertWDNCommand.Parameters.AddWithValue("_IdOtitem", null);
                        insertWDNCommand.Parameters.AddWithValue("_QTY", pickingMaterialsSc.ScannedQty);
                        insertWDNCommand.Parameters.AddWithValue("_Price", pickingMaterialsSc.CostPrice);
                        insertWDNCommand.Parameters.AddWithValue("_UnitPrice", pickingMaterialsSc.UnitPrice);
                        insertWDNCommand.Parameters.AddWithValue("_Comments", pickingMaterialsSc.Comments);
                        insertWDNCommand.Parameters.AddWithValue("_IdModifyBy", pickingMaterialsSc.ModifiedBy);
                        //insertWDNCommand.Parameters.AddWithValue("_IDcomponent", null);
                        insertWDNCommand.Parameters.AddWithValue("_IDcomponent", pickingMaterialsSc.IdWarehouseProductComponent);
                        insertWDNCommand.Parameters.AddWithValue("_Idwarehouse", pickingMaterialsSc.IdWarehouse);
                        insertWDNCommand.Parameters.AddWithValue("_IdWarehouseLocation", pickingMaterialsSc.IdWarehouseLocation);
                        insertWDNCommand.Parameters.AddWithValue("_IdWareHouseDeliveryNoteItem", pickingMaterialsSc.IdWareHouseDeliveryNoteItem);
                        insertWDNCommand.Parameters.AddWithValue("_IdCurrency", pickingMaterialsSc.IdCurrency);
                        insertWDNCommand.Parameters.AddWithValue("_IdSupplierComplaintItem", pickingMaterialsSc.IdSCitem);

                        int count = insertWDNCommand.ExecuteNonQuery();

                        connWDN.Close();

                    }


                    transactionScope.Complete();
                    transactionScope.Dispose();
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error InsertIntoArticleStockSC(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return true;
        }

        /// <summary>
        /// This method is to get warehouse location related to id article
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="IdArticles">Get selected idarticles</param>
        /// <param name="IdWarehouse">Get id warehouse</param>
        /// <returns>List of warehouse location details</returns>
        public List<WarehouseLocation> GetWarehouseLocationsByIdArticles(string connectionString, string IdArticles, Int64 IdWarehouse)
        {
            List<WarehouseLocation> warehouseLocations = new List<WarehouseLocation>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("warehouselocations_GetWarehouseLocationsByIdArticles", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", IdArticles);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", IdWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        WarehouseLocation warehouseLocation = new WarehouseLocation();

                        if (reader["IdWarehouseLocation"] != DBNull.Value)
                            warehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                        if (reader["FullName"] != DBNull.Value)
                            warehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                        if (reader["HtmlColor"] != DBNull.Value)
                            warehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                        if (reader["Width"] != DBNull.Value)
                            warehouseLocation.Width = Convert.ToDouble(reader["Width"]);

                        if (reader["Height"] != DBNull.Value)
                            warehouseLocation.Height = Convert.ToDouble(reader["Height"]);

                        if (reader["FileName"] != DBNull.Value)
                            warehouseLocation.FileName = Convert.ToString(reader["FileName"]);

                        if (reader["Latitude"] != DBNull.Value)
                            warehouseLocation.Latitude = Convert.ToDouble(reader["Latitude"]);

                        if (reader["Longitude"] != DBNull.Value)
                            warehouseLocation.Longitude = Convert.ToDouble(reader["Longitude"]);

                        warehouseLocations.Add(warehouseLocation);
                    }
                }
            }

            return warehouseLocations;
        }

        /// <summary>
        /// This method is to get picking items for supplier complaint item articles related to location
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="IdArticles">Get selected id articles</param>
        /// <param name="IdWarehouse">Get id warehouse</param>
        /// <param name="IdWarehouseLocation">Get id warehouse location</param>
        /// <returns>List of picking material supplier complaint</returns>
        public List<PickingMaterialsSC> GetPickingItemsForSupplierComplaintItemArticlesAndLocation(string connectionString, string IdArticles, Int64 IdWarehouse, Int64 IdWarehouseLocation)
        {
            List<PickingMaterialsSC> pickingMaterialForSCIList = new List<PickingMaterialsSC>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("warehouse_GetPickingItemsForSCIArticlesAndLocation", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticles", IdArticles);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", IdWarehouse);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouseLocation", IdWarehouseLocation);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        PickingMaterialsSC pickingMaterialSCI = new PickingMaterialsSC();

                        //if (reader["IdArticleStock"] != DBNull.Value)
                        //    pickingMaterialSCI.IdArticleStock = Convert.ToInt64(reader["IdArticleStock"]);

                        if (reader["IdArticle"] != DBNull.Value)
                            pickingMaterialSCI.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                        if (reader["Reference"] != DBNull.Value)
                            pickingMaterialSCI.Reference = Convert.ToString(reader["Reference"]);

                        if (reader["Description"] != DBNull.Value)
                            pickingMaterialSCI.Description = Convert.ToString(reader["Description"]);

                        if (reader["RegisterSerialNumber"] != DBNull.Value)
                            pickingMaterialSCI.RegisterSerialNumber = Convert.ToByte(reader["RegisterSerialNumber"]);

                        if (reader["Quantity"] != DBNull.Value)
                            pickingMaterialSCI.DownloadQuantity = Convert.ToInt64(reader["Quantity"]);

                        if (reader["IdWarehouseLocation"] != DBNull.Value)
                            pickingMaterialSCI.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                        if (reader["IdWarehouse"] != DBNull.Value)
                            pickingMaterialSCI.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                        if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            pickingMaterialSCI.IdWareHouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);

                        if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                        {
                            pickingMaterialSCI.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                            pickingMaterialSCI.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["idWarehouseDeliveryNote"]);

                            if (reader["Code"] != DBNull.Value)
                                pickingMaterialSCI.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);

                            if (reader["DeliveryDate"] != DBNull.Value)
                                pickingMaterialSCI.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                        }

                        if (reader["idWarehouseProductComponent"] != DBNull.Value)
                            pickingMaterialSCI.IdWarehouseProductComponent = Convert.ToInt64(reader["idWarehouseProductComponent"]);

                        if (reader["IdSupplierComplaintItem"] != DBNull.Value)
                            pickingMaterialSCI.IdSupplierComplaintItem = Convert.ToInt64(reader["IdSupplierComplaintItem"]);

                        if (reader["Comments"] != DBNull.Value)
                            pickingMaterialSCI.Comments = Convert.ToString(reader["Comments"]);

                        if (reader["UploadedIn"] != DBNull.Value)
                            pickingMaterialSCI.UploadedIn = Convert.ToDateTime(reader["UploadedIn"]);

                        if (reader["UnitPrice"] != DBNull.Value)
                            pickingMaterialSCI.UnitPrice = Convert.ToDouble(reader["UnitPrice"]);

                        if (reader["costprice"] != DBNull.Value)
                            pickingMaterialSCI.CostPrice = Convert.ToDouble(reader["costprice"]);

                        if (reader["MinimumStock"] != DBNull.Value)
                            pickingMaterialSCI.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);

                        if (reader["MaximumStock"] != DBNull.Value)
                            pickingMaterialSCI.MaximumStock = Convert.ToInt64(reader["MaximumStock"]);

                        if (reader["idCurrency"] != DBNull.Value)
                            pickingMaterialSCI.IdCurrency = Convert.ToInt16(reader["idCurrency"]);

                        pickingMaterialForSCIList.Add(pickingMaterialSCI);
                    }
                }
            }

            return pickingMaterialForSCIList;
        }

        /// <summary>
        /// This method is to get articlestock related to warehouse location 
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="IdArticle">Get id article</param>
        /// <param name="IdWarehouseLocation">Get id warehouse location</param>
        /// <param name="IdWarehouse">Get id warehouse</param>
        /// <returns>Get article warehouse location details</returns>
        public ArticleWarehouseLocations GetArticleStockByWarehouseLocation(string connectionString, Int32 IdArticle, Int64 IdWarehouseLocation, Int64 IdWarehouse)
        {
            ArticleWarehouseLocations articleWarehouseLocation = new ArticleWarehouseLocations();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("warehouse_GetArticleStockByWarehouseLocation", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", IdArticle);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouseLocation", IdWarehouseLocation);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", IdWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        if (reader["IdArticleWarehouseLocation"] != DBNull.Value)
                            articleWarehouseLocation.IdArticleWarehouseLocation = Convert.ToInt64(reader["IdArticleWarehouseLocation"]);

                        if (reader["IdArticle"] != DBNull.Value)
                            articleWarehouseLocation.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                        if (reader["IdWarehouseLocation"] != DBNull.Value)
                            articleWarehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                        if (reader["MinimumStock"] != DBNull.Value)
                            articleWarehouseLocation.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);

                        if (reader["MaximumStock"] != DBNull.Value)
                            articleWarehouseLocation.MaximumStock = Convert.ToInt64(reader["MaximumStock"]);

                        if (reader["LocationStock"] != DBNull.Value)
                            articleWarehouseLocation.LocationStock = Convert.ToInt64(reader["LocationStock"]);
                    }
                }
            }

            return articleWarehouseLocation;
        }

        /// <summary>
        /// This method is to get average stock related to id article
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="IdArticle">Get id articles</param>
        /// <param name="IdWarehouse">Get idwarehouse</param>
        /// <returns>Get article warehouse location details</returns>
        public ArticleWarehouseLocations GetAVGStockByIdArticle(string connectionString, Int32 IdArticle, Int64 IdWarehouse)
        {
            ArticleWarehouseLocations articleWarehouseLocation = new ArticleWarehouseLocations();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("warehouse_GetAVGStockByIdArticle", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", IdArticle);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", IdWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        if (reader["AvgStock"] != DBNull.Value)
                            articleWarehouseLocation.AvgStock = Convert.ToDecimal(reader["AvgStock"]);

                        if (reader["IdArticle"] != DBNull.Value)
                            articleWarehouseLocation.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                        if (reader["articleStock"] != DBNull.Value)
                            articleWarehouseLocation.ArticleStockForAllLocation = Convert.ToInt64(reader["articleStock"]);

                    }
                }
            }

            return articleWarehouseLocation;
        }

        /// <summary>
        /// This method is to get label print details
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="IdArticle">Get id article</param>
        /// <param name="IdWarehouse">Get id warehouse</param>
        /// <param name="IdWarehouseDeliveryNote">Get id warehouse delivery note</param>
        /// <returns>Get warehouse delivery note details</returns>
        public WarehouseDeliveryNote GetLabelPrintDetails(string connectionString, Int32 IdArticle, Int64 IdWarehouse, Int64 IdWarehouseDeliveryNote)
        {
            WarehouseDeliveryNote warehouseDeliveryNote = new WarehouseDeliveryNote();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("warehousedeliverynotes_GetLabelPrintDetails", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouseDeliveryNote", IdWarehouseDeliveryNote);
                mySqlCommand.Parameters.AddWithValue("_IdArticle", IdArticle);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", IdWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                            warehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["idWarehouseDeliveryNote"]);

                        if (reader["DeliveryDate"] != DBNull.Value)
                            warehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);

                        warehouseDeliveryNote.WarehousePurchaseOrder = new WarehousePurchaseOrder();

                        if (reader["IdWarehouse"] != DBNull.Value)
                            warehouseDeliveryNote.WarehousePurchaseOrder.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                        if (reader["IdArticleSupplier"] != DBNull.Value)
                        {
                            warehouseDeliveryNote.WarehousePurchaseOrder.IdArticleSupplier = Convert.ToInt64(reader["IdArticleSupplier"]);
                            warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier = new ArticleSupplier();
                            warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.IdArticleSupplier = Convert.ToInt64(reader["IdArticleSupplier"]);
                            warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Name = Convert.ToString(reader["Supplier"]);
                            if (reader["SuppCountryGroup"] != DBNull.Value)
                            {
                                warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Country = new Country();
                                warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Country.CountryGroup = new CountryGroup();
                                warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Country.CountryGroup.Name = Convert.ToString(reader["SuppCountryGroup"]);
                            }
                        }

                        warehouseDeliveryNote.WarehouseDeliveryNoteItems = new List<WarehouseDeliveryNoteItem>();
                        WarehouseDeliveryNoteItem WarehouseDeliveryNoteItem = new WarehouseDeliveryNoteItem();
                        if (reader["IdManufacturerByArticle"] != DBNull.Value)
                        {
                            WarehouseDeliveryNoteItem.IdManufacturerByArticle = Convert.ToInt64(reader["IdManufacturerByArticle"]);
                            WarehouseDeliveryNoteItem.ManufacturersByArticle = new List<ManufacturersByArticle>();
                            ManufacturersByArticle ManufacturersByArticle = new ManufacturersByArticle();
                            if (reader["CountryName"] != DBNull.Value)
                            {
                                ManufacturersByArticle.Country = new Country();
                                ManufacturersByArticle.Country.Name = Convert.ToString(reader["CountryName"]);
                                if (reader["CountryGroup"] != DBNull.Value)
                                {
                                    ManufacturersByArticle.Country.CountryGroup = new CountryGroup();
                                    ManufacturersByArticle.Country.CountryGroup.Name = Convert.ToString(reader["CountryGroup"]);
                                    if (reader["IsFreeTrade"] != DBNull.Value)
                                        ManufacturersByArticle.Country.CountryGroup.IsFreeTrade = Convert.ToByte(reader["IsFreeTrade"]);
                                }

                            }
                            if (reader["Manufacturer"] != DBNull.Value)
                            {
                                ManufacturersByArticle.Manufacturer = new Manufacturer();
                                ManufacturersByArticle.Manufacturer.Name = Convert.ToString(reader["Manufacturer"]);
                            }
                            WarehouseDeliveryNoteItem.ManufacturersByArticle.Add(ManufacturersByArticle);


                        }
                        warehouseDeliveryNote.WarehouseDeliveryNoteItems.Add(WarehouseDeliveryNoteItem);



                    }
                }
            }

            return warehouseDeliveryNote;
        }

        /// <summary>
        /// This method is to get article stock detail for refund
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idOT">Get idot</param>
        /// <param name="idWarehouse">Get idwarehouse</param>
        /// <param name="articleVisualAidsPath">Get article image path</param>
        /// <returns>List of picking material details</returns>
        public List<PickingMaterials> GetArticleStockDetailForRefund(string connectionString, Int64 idOT, Int64 idWarehouse, string articleVisualAidsPath)
        {
            List<PickingMaterials> PickingMaterialsList = new List<PickingMaterials>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("warehouse_GetArticleStockDetailForRefund", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdOT", idOT);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {


                    while (articlesReader.Read())
                    {
                        try
                        {

                            PickingMaterials pickingMaterials = new PickingMaterials();

                            if (articlesReader["IdArticle"] != DBNull.Value)
                                pickingMaterials.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            pickingMaterials.Article = new Article();
                            pickingMaterials.Article.IdArticle = pickingMaterials.IdArticle;
                            pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                            pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = pickingMaterials.IdArticle;

                            if (articlesReader["awlMinimumStock"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);

                            if (articlesReader["awlMaximumStock"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["IdOtItem"] != DBNull.Value)
                                pickingMaterials.IdOtitem = Convert.ToInt64(articlesReader["IdOtItem"]);

                            if (articlesReader["IdRevisionItem"] != DBNull.Value)
                            {
                                pickingMaterials.IdRevisionItem = Convert.ToInt64(articlesReader["IdRevisionItem"]);

                                pickingMaterials.RevisionItem = new RevisionItem();
                                pickingMaterials.RevisionItem.IdRevisionItem = pickingMaterials.IdRevisionItem;

                                if (articlesReader["NumItem"] != DBNull.Value)
                                    pickingMaterials.RevisionItem.NumItem = Convert.ToString(articlesReader["NumItem"]);

                                if (articlesReader["Quantity"] != DBNull.Value)
                                    pickingMaterials.RevisionItem.Quantity = Convert.ToDecimal(articlesReader["Quantity"]);
                                if (articlesReader["IdProduct"] != DBNull.Value)
                                    pickingMaterials.RevisionItem.IdProduct = Convert.ToInt64(articlesReader["IdProduct"]);
                            }



                            if (articlesReader["idWarehouseProductComponent"] != DBNull.Value)
                                pickingMaterials.IdWarehouseProductComponent = Convert.ToInt64(articlesReader["idWarehouseProductComponent"]);

                            if (articlesReader["Reference"] != DBNull.Value)
                                pickingMaterials.Reference = Convert.ToString(articlesReader["Reference"]);

                            if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                                pickingMaterials.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                            if (articlesReader["CurrentStock"] != DBNull.Value)
                                pickingMaterials.CurrentStock = Convert.ToInt64(articlesReader["CurrentStock"]);

                            if (articlesReader["costprice"] != DBNull.Value)
                                pickingMaterials.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                            if (articlesReader["UnitPrice"] != DBNull.Value)
                                pickingMaterials.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            {
                                pickingMaterials.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);


                                pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                                if (pickingMaterials.RevisionItem != null)
                                {
                                    pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbersForRefund(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, Convert.ToInt64(articlesReader["IdWarehouse"]), pickingMaterials.RevisionItem.IdProduct));
                                }
                                else
                                {
                                    pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbersForRefund(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, Convert.ToInt64(articlesReader["IdWarehouse"]), pickingMaterials.RevisionItem.IdProduct));
                                }

                            }


                            //if (articlesReader["IdArticleWarehouseLocation"] != DBNull.Value)
                            //    pickingMaterials.IdArticleWarehouseLocation = Convert.ToInt64(articlesReader["IdArticleWarehouseLocation"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.LocationFullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingMaterials.Description = articlesReader["Description"].ToString();

                            if (articlesReader["ImagePath"] != DBNull.Value)
                            {
                                pickingMaterials.ImagePath = articlesReader["ImagePath"].ToString();
                                Article article = new Article();
                                article.ImagePath = pickingMaterials.ImagePath;
                                pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, article);
                            }


                            if (articlesReader["MinimumStock"] != DBNull.Value)
                                pickingMaterials.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                            if (articlesReader["MaximumStock"] != DBNull.Value)
                                pickingMaterials.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                            pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                            if (articlesReader["UploadedIn"] != DBNull.Value)
                            {
                                pickingMaterials.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);
                                pickingMaterials.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(articlesReader["UploadedIn"]);
                            }

                            if (articlesReader["DeliveryCode"] != DBNull.Value)
                                pickingMaterials.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);

                            if (articlesReader["IdCurrency"] != DBNull.Value)
                                pickingMaterials.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                            if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                                pickingMaterials.DownloadQuantity = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                            pickingMaterials.WarehouseLocation = new WarehouseLocation();

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.HtmlColor = articlesReader["HtmlColor"].ToString();

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingMaterials.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                            pickingMaterials.PartNumberCode = GetPartNumberCode(pickingMaterials.IdOtitem, connectionString);

                            if (articlesReader["IdCountryGroup"] != DBNull.Value)
                                pickingMaterials.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);



                            PickingMaterialsList.Add(pickingMaterials);


                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleStockDetailForRefund(IdOT-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOT, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }
            return PickingMaterialsList;
        }

        /// <summary>
        /// This method is to get made in partnumber detail
        /// </summary>
        /// <param name="connectionString">Get connection string (geos db)</param>
        /// <param name="idOTItem">Get id otitem</param>
        /// <param name="idWarehouse">Get id warehouse</param>
        /// <returns>picking material details</returns>
        public PickingMaterials GetMadeInPartNumberDetail(string connectionString, Int64 idOTItem, Int64 idWarehouse)
        {
            PickingMaterials pickingMaterials = new PickingMaterials();
            pickingMaterials.PartNumberCode = GetPartNumberCode(idOTItem, connectionString);
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("warehouse_GetMadeInPartNumberDetail", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdOTItem", idOTItem);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {

                    if (articlesReader.Read())
                    {
                        try
                        {

                            if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            {
                                pickingMaterials.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                                pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);

                            }

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetMadeInPartNumberDetail(IdOTItem-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOTItem, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }
            return pickingMaterials;
        }

        public bool UpdateRevisionItemComments_Sprint59(string connectionString, Int64 idRevisionItem, Int64 idDeliveryNoteItem)
        {
            TransactionScope transactionScope = null;

            using (transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection connWDN = new MySqlConnection(connectionString))
                    {
                        connWDN.Open();

                        MySqlCommand insertWDNCommand = new MySqlCommand("revisionitems_UpdateComments_Sprint59", connWDN);
                        insertWDNCommand.CommandType = CommandType.StoredProcedure;

                        insertWDNCommand.Parameters.AddWithValue("_IdRevisionItem", idRevisionItem);
                        insertWDNCommand.Parameters.AddWithValue("_IdWarehouseDeliveryNoteItem", idDeliveryNoteItem);


                        insertWDNCommand.ExecuteNonQuery();

                        connWDN.Close();
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error UpdateRevisionItemComments(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return true;
        }


        public Int64 GetRefundIdOtByBarcode(string connectionString, string barcode)
        {
            Int64 idOT = 0;
            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("ots_GetRefundIdOtByBarcode", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_barcode", barcode);

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        if (reader.Read())
                        {

                            if (reader["IdOT"] != DBNull.Value)
                                idOT = Convert.ToInt64(reader["IdOT"]);


                        }

                    }
                    mySqlConnection.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetRefundIdOtByBarcode( IdOT-{0}). ErrorMessage- {1}", idOT, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return idOT;
        }


        public List<SerialNumber> GetSerialNumbersForRefund(string connectionString, Int64 idWareHouseDeliveryNoteItem, Int64 idWarehouse, Int64? idWarehouseProduct)
        {
            List<SerialNumber> serialNumbers = new List<SerialNumber>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("serialnumbers_GetSerialNumbersForRefund", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWareHouseDeliveryNoteItem", idWareHouseDeliveryNoteItem);
                concommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                concommand.Parameters.AddWithValue("_IdWarehouseProduct", idWarehouseProduct);

                using (MySqlDataReader dNReader = concommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        SerialNumber serialNumber = new SerialNumber();

                        serialNumber.IdSerialNumber = Convert.ToInt64(dNReader["IdSerialNumber"]);
                        serialNumber.Code = Convert.ToString(dNReader["Code"]);

                        if (dNReader["ExtraCode"] != DBNull.Value)
                            serialNumber.ExtraCode = Convert.ToString(dNReader["ExtraCode"]);

                        if (dNReader["IdWarehouseDeliveryNoteItem"] != DBNull.Value)
                            serialNumber.IdWarehouseDeliveryNoteItem = Convert.ToInt64(dNReader["IdWarehouseDeliveryNoteItem"]);

                        if (dNReader["IdWarehouseProduct"] != DBNull.Value)
                            serialNumber.IdWarehouseProduct = Convert.ToInt64(dNReader["IdWarehouseProduct"]);

                        if (dNReader["IdArticle"] != DBNull.Value)
                            serialNumber.IdArticle = Convert.ToInt32(dNReader["IdArticle"]);

                        serialNumbers.Add(serialNumber);
                    }
                }
            }

            return serialNumbers;
        }

        public Int64 GetStockForScanItem(string connectionString, Int64 idArticle, Int64 idWarehouse, Int64 idWarehouseDeliveryNoteItem, Int64 idWarehouseLocation)
        {
            Int64 qty = 0;
            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("warehouse_GetStockForScanItem", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdArticle", idArticle);
                concommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                concommand.Parameters.AddWithValue("_IdWareHouseDeliveryNoteItem", idWarehouseDeliveryNoteItem);
                concommand.Parameters.AddWithValue("_IdWarehouseLocation", idWarehouseLocation);

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        if (reader["QTY"] != DBNull.Value)
                            qty = Convert.ToInt64(reader["QTY"]);
                    }
                }
            }
            return qty;
        }




        public List<PickingMaterials> GetRevisionItemDetails(Int64 idOt, Warehouses warehouse, Int64 idWarehouseLocation, string ArticleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<PickingMaterials> pickingMaterialList = new List<PickingMaterials>();
            List<OtItem> otItems = new List<OtItem>();
            List<OtItemSameReference> OtItemSameReferences = new List<OtItemSameReference>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetRevisionItemDetails", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOt", idOt);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                otItemCommand.Parameters.AddWithValue("_IdWarehouseLocation", idWarehouseLocation);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OtItem otItem = new OtItem();

                            otItem.IdOT = idOt;

                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);
                                otItem.RevisionItem.Quantity = Convert.ToInt64(otItemReader["Quantity"]);


                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["DownloadedQty"] != DBNull.Value)
                                    otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otItemReader["DownloadedQty"]);

                                if (otItemReader["RemainingQty"] != DBNull.Value)
                                    otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otItemReader["RemainingQty"]);

                                if (otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;


                                pickingMaterialList.AddRange(GetDecompositionArticleDetail(idOt, warehouse, idWarehouseLocation, otItem, ArticleVisualAidsPath, OtItemSameReferences, otItem.RevisionItem.WarehouseProduct.Article.IdArticleType));

                                pickingMaterialList.AddRange(FillPickingMaterialByIdWarehouselocation(otItem, warehouse, idWarehouseLocation, ArticleVisualAidsPath, otItems, OtItemSameReferences));
                            }

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRevisionItemDetails(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetRevisionItemDetails().", category: Category.Info, priority: Priority.Low);
            return pickingMaterialList;
        }




        public List<PickingMaterials> GetDecompositionArticleDetail(Int64 idOt, Warehouses warehouse, Int64 idWarehouseLocation, OtItem parentOtItem, string ArticleVisualAidsPath, List<OtItemSameReference> otItemSameReferences, Int64 idArticleType)
        {
            List<OtItem> otItems = new List<OtItem>();
            List<PickingMaterials> pickingMaterialsList = new List<PickingMaterials>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetDecompositionArticleDetail", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOTitem", parentOtItem.IdOTItem);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                otItemCommand.Parameters.AddWithValue("_IdWarehouseLocation", idWarehouseLocation);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            // keyId++;

                            OtItem otItem = new OtItem();
                            otItem.IdOT = idOt;
                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);



                                if (otItemReader["IdComponent"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otItemReader["IdComponent"]);
                                }


                                if (otItemReader["idParent"] != DBNull.Value)
                                {
                                    otItem.ParentId = Convert.ToInt32(otItemReader["idParent"]);
                                }

                                if (otItem.ParentId == -1)
                                {
                                    otItem.ParentId = parentOtItem.KeyId;
                                    otItem.RevisionItem.Quantity = parentOtItem.RevisionItem.Quantity * Convert.ToDecimal(otItemReader["Quantity"]);
                                }
                                else
                                {
                                    //OtItem otItem213 = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId);
                                    decimal qty = 0;
                                    if (otItems.Any(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId))
                                    {
                                        qty = otItems.Where(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).FirstOrDefault().RevisionItem.Quantity;
                                        otItem.RevisionItem.Quantity = qty * Convert.ToDecimal(otItemReader["Quantity"]);
                                        otItem.ParentId = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).KeyId;
                                    }


                                }

                                //if (otItemReader["WpDescription"] != DBNull.Value)
                                //    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);


                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }


                                int downloaded = GetOtItemDownloadedQuantity(connectionString, otItem.RevisionItem.WarehouseProduct.Article.IdArticle, otItem.IdOTItem, otItem.RevisionItem.WarehouseProduct.IdComponent, warehouse.IdWarehouse);


                                otItem.RevisionItem.DownloadedQuantity = downloaded;

                                otItem.RevisionItem.RemainingQuantity = ((Int64)otItem.RevisionItem.Quantity - downloaded);

                                //if ((Int64)otItem.RevisionItem.Quantity > 0)
                                //    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;
                            }
                            otItem.PickingMaterialsList = new List<PickingMaterials>();
                            if (idArticleType != 2)
                                pickingMaterialsList.AddRange(FillPickingMaterialByIdWarehouselocation(otItem, warehouse, idWarehouseLocation, ArticleVisualAidsPath, otItems, otItemSameReferences));

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetDecompositionArticleDetail(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }

            return pickingMaterialsList;
        }

        public List<PickingMaterials> FillPickingMaterialByIdWarehouselocation(OtItem otItem, Warehouses warehouse, Int64 idWarehouseLocation, string ArticleVisualAidsPath, List<OtItem> otitems, List<OtItemSameReference> otItemSameReferences)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<PickingMaterials> pickingMaterialsList = new List<PickingMaterials>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("warehouse_GetArticlesStockDetailsByIdWarehouseLocation", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", otItem.RevisionItem.WarehouseProduct.Article.IdArticle);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouseLocation", idWarehouseLocation);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {
                    Int64 remainingQty = otItem.RevisionItem.RemainingQuantity; // download Quantity.
                    while (articlesReader.Read())
                    {
                        try
                        {

                            if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])))
                            {
                                Int64 articleCurrentStockRem = 0;
                                articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])).Sum(i => i.Qty));
                                if (articleCurrentStockRem == 0)
                                    continue;
                                else
                                    if (remainingQty == 0)
                                    return pickingMaterialsList;
                            }
                            else
                            {
                                if (remainingQty == 0)
                                    return pickingMaterialsList;
                            }



                            PickingMaterials pickingMaterials = new PickingMaterials();

                            pickingMaterials.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                            pickingMaterials.Article = new Article();
                            pickingMaterials.Article.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;
                            pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                            pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;
                            if (articlesReader["awlMinimumStock"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);
                            if (articlesReader["awlMaximumStock"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);
                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            pickingMaterials.IdOtitem = otItem.IdOTItem;

                            pickingMaterials.IdRevisionItem = otItem.IdRevisionItem;
                            pickingMaterials.RevisionItem = new RevisionItem();
                            pickingMaterials.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                            if (otItem.RevisionItem != null)
                                pickingMaterials.RevisionItem.NumItem = otItem.RevisionItem.NumItem;

                            if (otItem.RevisionItem != null)
                                pickingMaterials.RevisionItem.Quantity = otItem.RevisionItem.Quantity;

                            if (otItem.RevisionItem != null)
                                if (otItem.RevisionItem.WarehouseProduct != null)
                                    pickingMaterials.IdWarehouseProductComponent = otItem.RevisionItem.WarehouseProduct.IdComponent;

                            if (articlesReader["Reference"] != DBNull.Value)
                                pickingMaterials.Reference = Convert.ToString(articlesReader["Reference"]);

                            if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                                pickingMaterials.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                            if (articlesReader["CurrentStock"] != DBNull.Value)
                                pickingMaterials.CurrentStock = Convert.ToInt64(articlesReader["CurrentStock"]);

                            if (articlesReader["costprice"] != DBNull.Value)
                                pickingMaterials.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                            if (articlesReader["UnitPrice"] != DBNull.Value)
                                pickingMaterials.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            {
                                pickingMaterials.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);


                                pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                                pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbers(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, Convert.ToInt64(articlesReader["IdWarehouse"])));
                            }



                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.LocationFullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingMaterials.Description = articlesReader["Description"].ToString();

                            if (articlesReader["ImagePath"] != DBNull.Value)
                            {
                                pickingMaterials.ImagePath = articlesReader["ImagePath"].ToString();
                                Article article = new Article();
                                article.ImagePath = pickingMaterials.ImagePath;
                                pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                            }


                            if (articlesReader["MinimumStock"] != DBNull.Value)
                                pickingMaterials.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                            if (articlesReader["MaximumStock"] != DBNull.Value)
                                pickingMaterials.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                            pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                            if (articlesReader["UploadedIn"] != DBNull.Value)
                            {
                                pickingMaterials.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);
                                pickingMaterials.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(articlesReader["UploadedIn"]);
                            }

                            if (articlesReader["DeliveryCode"] != DBNull.Value)
                                pickingMaterials.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);

                            if (articlesReader["IdCurrency"] != DBNull.Value)
                                pickingMaterials.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                            if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])))
                            {
                                Int64 articleCurrentStockRem = 0;
                                articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])).Sum(i => i.Qty));
                                if (articleCurrentStockRem > 0)
                                {
                                    if (remainingQty > 0 && articleCurrentStockRem > 0)
                                    {
                                        if (articleCurrentStockRem > remainingQty)
                                        {
                                            pickingMaterials.DownloadQuantity = remainingQty;
                                            remainingQty = 0;
                                        }
                                        else
                                        {
                                            pickingMaterials.DownloadQuantity = articleCurrentStockRem;
                                            remainingQty = remainingQty - articleCurrentStockRem;
                                        }

                                    }
                                }
                                else
                                {
                                    if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                                    {
                                        if (pickingMaterials.ArticleCurrentStock > remainingQty)
                                        {
                                            pickingMaterials.DownloadQuantity = remainingQty;
                                            remainingQty = 0;
                                        }
                                        else
                                        {
                                            pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                                            remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                                        }

                                    }
                                }
                            }
                            else
                            {
                                if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                                {
                                    if (pickingMaterials.ArticleCurrentStock > remainingQty)
                                    {
                                        pickingMaterials.DownloadQuantity = remainingQty;
                                        remainingQty = 0;
                                    }
                                    else
                                    {
                                        pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                                        remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                                    }

                                }
                            }

                            pickingMaterials.WarehouseLocation = new WarehouseLocation();

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.HtmlColor = articlesReader["HtmlColor"].ToString();

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingMaterials.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                            pickingMaterials.PartNumberCode = GetPartNumberCode(otItem.IdOTItem, connectionString);

                            if (articlesReader["IdCountryGroup"] != DBNull.Value)
                                pickingMaterials.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);

                            //Add in otSameReferenceList
                            OtItemSameReference otItemSameReference = new OtItemSameReference();
                            otItemSameReference.IdArticle = pickingMaterials.IdArticle;
                            otItemSameReference.IdWarehouseDeliveryNoteItem = pickingMaterials.IdWareHouseDeliveryNoteItem;
                            otItemSameReference.ArticleCurrentStock = pickingMaterials.ArticleCurrentStock;
                            otItemSameReference.Qty = pickingMaterials.DownloadQuantity;
                            otItemSameReference.IdWarehouseLocation = pickingMaterials.WarehouseLocation.IdWarehouseLocation;
                            otItemSameReferences.Add(otItemSameReference);

                            pickingMaterialsList.Add(pickingMaterials);

                            //GetTotalArticleDownloadDetailByOtItem(connectionString, 1800, 35259);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error FillPickingMaterialByIdWarehouselocation(IdArticle-{0}, idWarehouse-{1}). ErrorMessage- {2}", otItem.RevisionItem.WarehouseProduct.Article.IdArticle, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }
            return pickingMaterialsList;
        }


        public List<ArticleWarehouseLocations> GetArticleWarehouseLocationStockByIdArticle_V2030(string connectionString, Int32 idArticle, Int64 idWarehouse)
        {
            List<ArticleWarehouseLocations> articleWarehouseLocationLst = new List<ArticleWarehouseLocations>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetArticleWarehouseLocationStockByIdArticle_V2030", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", idArticle);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ArticleWarehouseLocations articleWarehouseLocation = new ArticleWarehouseLocations();
                        try
                        {
                            if (reader["ArticleWLPostion"] != DBNull.Value)
                            {
                                articleWarehouseLocation.Position = Convert.ToInt64(reader["ArticleWLPostion"]);
                            }

                            articleWarehouseLocation.IdArticle = idArticle;

                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                articleWarehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);
                                articleWarehouseLocation.WarehouseLocation = new WarehouseLocation();
                                articleWarehouseLocation.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                                if (reader["Position"] != DBNull.Value)
                                    articleWarehouseLocation.WarehouseLocation.Position = Convert.ToInt64(reader["Position"]);

                                if (reader["FullName"] != DBNull.Value)
                                    articleWarehouseLocation.WarehouseLocation.FullName = Convert.ToString(reader["FullName"]);
                            }

                            if (reader["Qty"] != DBNull.Value)
                            {
                                articleWarehouseLocation.ArticlesStock = new ArticlesStock();

                                articleWarehouseLocation.ArticlesStock.IdWarehouseLocation = Convert.ToUInt64(reader["IdWarehouseLocation"]);
                                articleWarehouseLocation.ArticlesStock.Quantity = Convert.ToInt64(reader["Qty"]);
                            }

                            if (reader["MinimumStock"] != DBNull.Value)
                            {
                                articleWarehouseLocation.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);
                            }
                            if (reader["MaximumStock"] != DBNull.Value)
                            {
                                articleWarehouseLocation.MaximumStock = Convert.ToInt64(reader["MaximumStock"]);
                            }
                            articleWarehouseLocation.WarehouseDeliveryNotes = new List<WarehouseDeliveryNote>();

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleWarehouseLocationStockByIdArticle(). IdArticle- {0} IdWarehouseLocation-{1}  ErrorMessage- {2}", articleWarehouseLocation.IdArticle, articleWarehouseLocation.IdWarehouseLocation, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                        articleWarehouseLocationLst.Add(articleWarehouseLocation);
                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                if (articleWarehouseLocationLst != null)
                                {
                                    if (articleWarehouseLocationLst.Any(i => i.IdWarehouseLocation == Convert.ToInt64(reader["IdWarehouseLocation"])))
                                    {
                                        ArticleWarehouseLocations articleWarehouseLocations = articleWarehouseLocationLst.Where(i => i.IdWarehouseLocation == Convert.ToInt64(reader["IdWarehouseLocation"])).FirstOrDefault();
                                        if (articleWarehouseLocations != null)
                                        {
                                            WarehouseDeliveryNote warehouseDeliveryNote = new WarehouseDeliveryNote();
                                            if (reader["DeliveryDate"] != DBNull.Value)
                                                warehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                            if (reader["Code"] != DBNull.Value)
                                                warehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                            if (reader["Quantity"] != DBNull.Value)
                                                warehouseDeliveryNote.Quantity = Convert.ToInt64(reader["Quantity"]);
                                            if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                                                warehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["idWarehouseDeliveryNote"]);

                                            if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                            {
                                                warehouseDeliveryNote.WarehouseDeliveryNoteItems = new List<WarehouseDeliveryNoteItem>();
                                                WarehouseDeliveryNoteItem warehouseDeliveryNoteItem = new WarehouseDeliveryNoteItem();
                                                warehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);
                                                warehouseDeliveryNote.WarehouseDeliveryNoteItems.Add(warehouseDeliveryNoteItem);
                                            }


                                            warehouseDeliveryNote.MasterItem = articleWarehouseLocations;
                                            articleWarehouseLocations.WarehouseDeliveryNotes.Add(warehouseDeliveryNote);
                                        }
                                    }
                                }
                            }
                        }
                    }

                }
            }

            return articleWarehouseLocationLst;
        }


        public Article GetArticleDetailsByReference_V2030(string reference, string articleVisualAidsPath, Warehouses warehouse, DateTime? fromDate = null, DateTime? toDate = null)
        {
            Article article = new Article();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("article_GetArticleDetailsByReference", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_Reference", reference);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        try
                        {
                            if (reader["idArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(reader["idArticle"]);

                            if (reader["IdArticleCategory"] != DBNull.Value)
                            {
                                article.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory = new ArticleCategory();
                                article.ArticleCategory.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory.Name = Convert.ToString(reader["categoryName"]);
                                article.ArticleCategory.TaricCode = Convert.ToString(reader["TaricCode"]);
                            }

                            if (reader["ImagePath"] != DBNull.Value)
                            {
                                article.ImagePath = Convert.ToString(reader["ImagePath"]);

                                if (!string.IsNullOrEmpty(article.ImagePath))
                                    article.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, article);
                            }

                            if (reader["Reference"] != DBNull.Value)
                                article.Reference = reader["Reference"].ToString();

                            if (reader["IsOrientativeVisualAid"] != DBNull.Value)
                                article.IsOrientativeVisualAid = Convert.ToByte(reader["IsOrientativeVisualAid"]);

                            if (reader["IsGeneric"] != DBNull.Value)
                                article.IsGeneric = Convert.ToSByte(reader["IsGeneric"]);

                            if (reader["isObsolete"] != DBNull.Value)
                                article.IsObsolete = Convert.ToSByte(reader["isObsolete"]);

                            if (reader["isPublic"] != DBNull.Value)
                                article.IsPublic = Convert.ToSByte(reader["isPublic"]);

                            if (reader["publishOnWeb"] != DBNull.Value)
                                article.PublishOnWeb = Convert.ToSByte(reader["publishOnWeb"]);

                            if (reader["registerSerialNumber"] != DBNull.Value)
                                article.RegisterSerialNumber = Convert.ToByte(reader["registerSerialNumber"]);

                            if (reader["CreatedIn"] != DBNull.Value)
                                article.CreatedIn = Convert.ToDateTime(reader["CreatedIn"]);

                            if (reader["ModifiedIn"] != DBNull.Value)
                                article.ModifiedIn = Convert.ToDateTime(reader["ModifiedIn"]);

                            if (reader["description"] != DBNull.Value)
                                article.Description = Convert.ToString(reader["description"]);

                            if (reader["description_es"] != DBNull.Value)
                                article.Description_es = Convert.ToString(reader["description_es"]);

                            if (reader["description_fr"] != DBNull.Value)
                                article.Description_fr = Convert.ToString(reader["description_fr"]);

                            if (reader["description_pt"] != DBNull.Value)
                                article.Description_pt = Convert.ToString(reader["description_pt"]);

                            if (reader["description_ro"] != DBNull.Value)
                                article.Description_ro = Convert.ToString(reader["description_ro"]);

                            if (reader["description_ru"] != DBNull.Value)
                                article.Description_ru = Convert.ToString(reader["description_ru"]);

                            if (reader["description_zh"] != DBNull.Value)
                                article.Description_zh = Convert.ToString(reader["description_zh"]);

                            if (reader["idReplacementArticle"] != DBNull.Value)
                            {
                                article.IdReplacementArticle = Convert.ToInt32(reader["idReplacementArticle"]);
                                article.ReplacementArticle = Convert.ToString(reader["ReplacementArticle"]);
                            }

                            if (reader["isBatch"] != DBNull.Value)
                                article.IsBatch = Convert.ToByte(reader["isBatch"]);

                            if (reader["taric"] != DBNull.Value)
                                article.Taric = Convert.ToString(reader["taric"]);

                            if (reader["IdArticleType"] != DBNull.Value)
                            {
                                article.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                article.ArticlesType = new ArticleType();
                                article.ArticlesType.IdArticleType = Convert.ToInt64(reader["IdArticleType"]); ;
                            }


                            if (reader["Weight"] != DBNull.Value)
                                article.Weight = Convert.ToDecimal(reader["Weight"]);

                            if (reader["Width"] != DBNull.Value)
                                article.Width = (float)(reader["Width"]);

                            if (reader["Length"] != DBNull.Value)
                                article.Length = (float)(reader["Length"]);

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)(reader["Height"]);

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)(reader["Height"]);

                            if (reader["idCountry"] != DBNull.Value)
                            {
                                article.IdCountry = Convert.ToInt32(reader["idCountry"]);

                                article.Country = new Country();
                                article.Country.IdCountry = Convert.ToByte(reader["idCountry"]);
                                article.Country.Name = Convert.ToString(reader["CountryName"]);
                            }

                            article.MyWarehouse = new MyWarehouse();

                            if (reader["minimumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MinimumStock = Convert.ToInt64(reader["minimumStock"]);
                            }

                            if (reader["stock"] != DBNull.Value)
                            {
                                article.MyWarehouse.CurrentStock = Convert.ToInt64(reader["stock"]);
                            }

                            if (reader["maximumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MaximumStock = Convert.ToInt64(reader["maximumStock"]);
                            }

                            if (reader["idWareHouse"] != DBNull.Value)
                            {
                                article.MyWarehouse.IdWarehouse = Convert.ToInt64(reader["idWareHouse"]);
                            }

                            if (reader["location"] != DBNull.Value)
                            {
                                article.MyWarehouse.Location = Convert.ToString(reader["location"]);
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleDetailsByIdArticle(). Reference- {0} IdArticle-{1} ErrorMessage- {2}", reference, article.IdArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
                article.LstArticleBySupplier = new List<ArticleBySupplier>();
                article.LstArticleBySupplier = GetArticleSupplierDetailsByIdArticle(connectionString, article.IdArticle);

                article.LstArticleDecomposition = new List<ArticleDecomposition>();
                article.LstArticleDecomposition = GetArticleDeCompostionByIdArticle(connectionString, article.IdArticle);

                article.LstRelatedArticle = new List<RelatedArticle>();
                article.LstRelatedArticle = GetRelatedArticleDetailsByIdArticle(connectionString, article.IdArticle, warehouse.IdWarehouse);

                article.LstArticleDocument = new List<ArticleDocument>();
                article.LstArticleDocument = GetArticleAttachmentByIdArticle(connectionString, article.IdArticle);

                article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle_V2030(connectionString, article.IdArticle, warehouse.IdWarehouse);

                article.LstManufacturersByArticles = new List<ManufacturersByArticle>();
                article.LstManufacturersByArticles = GetManufacturers(connectionString, article.IdArticle);

                //if (fromDate != null && toDate != null)
                //{
                article.LstArticlesStock = new List<ArticlesStock>();
                article.LstArticlesStock = GetStockHistoryByIdArticle(connectionString, article.IdArticle, DateTime.Now, DateTime.Now, warehouse.IdWarehouse);
                // }

            }

            return article;
        }


        public List<ArticlesStock> GetWarehouseDeliveryNoteCode(Int64 idOTItem, Warehouses warehouse, Int64? idWarehouseProductComponent)
        {
            List<ArticlesStock> articleStockLst = new List<ArticlesStock>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetWarehouseDeliveryNoteCode", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdOTItem", idOTItem);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouseProductComponent", idWarehouseProductComponent);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            ArticlesStock articlesStock = new ArticlesStock();

                            if (reader["IdOtItem"] != DBNull.Value)
                                articlesStock.IdOtItem = Convert.ToUInt64(reader["IdOtItem"]);

                            if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            {
                                articlesStock.IdWarehouseDeliveryNoteItem = Convert.ToUInt64(reader["IdWareHouseDeliveryNoteItem"]);
                                articlesStock.WarehouseDeliveryNoteItem = new WarehouseDeliveryNoteItem();
                                articlesStock.WarehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);
                                articlesStock.WarehouseDeliveryNoteItem.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                articlesStock.WarehouseDeliveryNoteItem.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                articlesStock.WarehouseDeliveryNoteItem.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                            }

                            if (reader["qty"] != DBNull.Value)
                            {
                                articlesStock.Quantity = Convert.ToInt64(reader["qty"]);
                            }

                            if (reader["idWarehouseProductComponent"] != DBNull.Value)
                                articlesStock.IdWarehouseProductComponent = Convert.ToUInt64(reader["idWarehouseProductComponent"]);

                            articleStockLst.Add(articlesStock);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetWarehouseDeliveryNoteCode(). IdOtItem- {0} _IdWarehouse-{1} ErrorMessage- {2}", idOTItem, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }

            }

            return articleStockLst;
        }


        public List<OtItem> GetPendingMaterialArticles(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OtItem> otItems = new List<OtItem>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetPendingMaterialArticles", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OtItem otItem = new OtItem();
                                if (reader["IdOTItem"] != DBNull.Value)
                                {
                                    otItem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                                    if (reader["IdOT"] != DBNull.Value)
                                        otItem.IdOT = Convert.ToInt64(reader["IdOT"]);

                                    otItem.RevisionItem = new RevisionItem();

                                    if (reader["ActualQty"] != DBNull.Value)
                                        otItem.RevisionItem.Quantity = Convert.ToInt64(reader["ActualQty"]);

                                    if (reader["DownloadedQty"] != DBNull.Value)
                                        otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(reader["DownloadedQty"]);

                                    if (reader["RemainingQty"] != DBNull.Value)
                                        otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(reader["RemainingQty"]);

                                    if (reader["IdArticle"] != DBNull.Value)
                                    {
                                        otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                        otItem.RevisionItem.WarehouseProduct.Article = new Article();
                                        otItem.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                        otItem.RevisionItem.WarehouseProduct.Article.Reference = Convert.ToString(reader["Reference"]);
                                    }

                                    otItem.Ot = new Ots();
                                    if (reader["MergeCode"] != DBNull.Value)
                                        otItem.Ot.Code = Convert.ToString(reader["MergeCode"]);

                                    if (reader["IdSite"] != DBNull.Value)
                                    {
                                        otItem.Ot.Quotation = new Quotation();

                                        otItem.Ot.Quotation.Site = new Company();
                                        otItem.Ot.Quotation.Site.Name = Convert.ToString(reader["SiteName"]);

                                        otItem.Ot.Quotation.Site.Country = new Country();
                                        otItem.Ot.Quotation.Site.Country.Name = Convert.ToString(reader["Country"]);

                                        otItem.Ot.Quotation.Site.Customer = new Customer();
                                        otItem.Ot.Quotation.Site.Customer.CustomerName = Convert.ToString(reader["CustomerGroup"]);

                                        otItem.Ot.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                    }

                                }

                                otItems.Add(otItem);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialArticles() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return otItems;
        }


        public void FillPickingMaterial_V2030(string connectionString, OtItem otItem, Int64 idWarehouse, string ArticleVisualAidsPath, List<OtItem> otitems, List<OtItemSameReference> otItemSameReferences)
        {
            otItem.PickingMaterialsList = new List<PickingMaterials>();
            List<PickingArticleStockDetail> pickingArticleStockDetails = new List<PickingArticleStockDetail>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetArticlesStockDetailsByIdArticle_V2030", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", otItem.RevisionItem.WarehouseProduct.Article.IdArticle);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                #region
                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {

                    while (articlesReader.Read())
                    {
                        PickingArticleStockDetail pickingArticleStockDetail = new PickingArticleStockDetail();

                        pickingArticleStockDetail.Article = new Article();
                        if (articlesReader["IdArticle"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            pickingArticleStockDetail.Article.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingArticleStockDetail.Article.Description = Convert.ToString(articlesReader["Description"]);

                            if (articlesReader["ImagePath"] != DBNull.Value)
                                pickingArticleStockDetail.Article.ImagePath = Convert.ToString(articlesReader["ImagePath"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingArticleStockDetail.Article.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                        }

                        if (articlesReader["awlMinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);

                        if (articlesReader["awlMaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);

                        if (articlesReader["ArticleLocationPosition"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationPosition = Convert.ToInt64(articlesReader["ArticleLocationPosition"]);

                        if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                        if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            pickingArticleStockDetail.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                        pickingArticleStockDetail.WarehouseLocation = new WarehouseLocation();
                        if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);


                            pickingArticleStockDetail.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);
                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FullName = Convert.ToString(articlesReader["Fullname"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.HtmlColor = Convert.ToString(articlesReader["HtmlColor"]);

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);
                        }


                        if (articlesReader["UnitPrice"] != DBNull.Value)
                            pickingArticleStockDetail.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                        if (articlesReader["IdCurrency"] != DBNull.Value)
                            pickingArticleStockDetail.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                        if (articlesReader["costprice"] != DBNull.Value)
                            pickingArticleStockDetail.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                        if (articlesReader["MinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                        if (articlesReader["MaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                        pickingArticleStockDetail.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (articlesReader["UploadedIn"] != DBNull.Value)
                            pickingArticleStockDetail.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);

                        if (articlesReader["DeliveryCode"] != DBNull.Value)
                        {

                            pickingArticleStockDetail.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);
                        }


                        if (articlesReader["IdCountryGroup"] != DBNull.Value)
                            pickingArticleStockDetail.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);

                        pickingArticleStockDetails.Add(pickingArticleStockDetail);
                    }
                }
                List<PickingArticleStockDetail> PickingArticleStockDetailSort = new List<PickingArticleStockDetail>();

                foreach (var itemPASD in pickingArticleStockDetails.GroupBy(i => Convert.ToDateTime(i.UploadedIn.Value.ToShortDateString())))
                {
                    foreach (var item in itemPASD.OrderBy(i => i.ArticleLocationPosition).ToList())
                    {
                        PickingArticleStockDetailSort.Add(item);
                    }
                }

                pickingArticleStockDetails = PickingArticleStockDetailSort;

                Int64 remainingQty = otItem.RevisionItem.RemainingQuantity; // download Quantity.
                foreach (PickingArticleStockDetail itemArticleStock in pickingArticleStockDetails)
                {

                    try
                    {

                        if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        {
                            Int64 articleCurrentStockRem = 0;
                            articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                            if (articleCurrentStockRem == 0)
                                continue;
                            else
                                if (remainingQty == 0)
                                return;
                        }
                        else
                        {
                            if (remainingQty == 0)
                                return;
                        }



                        PickingMaterials pickingMaterials = new PickingMaterials();

                        pickingMaterials.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        pickingMaterials.Article = new Article();
                        pickingMaterials.Article.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;
                        pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                        pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        if (itemArticleStock.ArticleLocationMinimumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = itemArticleStock.ArticleLocationMinimumStock.Value;
                        if (itemArticleStock.ArticleLocationMaximumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = itemArticleStock.ArticleLocationMaximumStock.Value;

                        pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.IdOtitem = otItem.IdOTItem;

                        pickingMaterials.IdRevisionItem = otItem.IdRevisionItem;
                        pickingMaterials.RevisionItem = new RevisionItem();
                        pickingMaterials.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.NumItem = otItem.RevisionItem.NumItem;

                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.Quantity = otItem.RevisionItem.Quantity;

                        if (otItem.RevisionItem != null)
                            if (otItem.RevisionItem.WarehouseProduct != null)
                                pickingMaterials.IdWarehouseProductComponent = otItem.RevisionItem.WarehouseProduct.IdComponent;

                        if (!string.IsNullOrEmpty(otItem.RevisionItem.WarehouseProduct.Article.Reference))
                            pickingMaterials.Reference = otItem.RevisionItem.WarehouseProduct.Article.Reference;

                        if (itemArticleStock.ArticleCurrentStock != null)
                            pickingMaterials.ArticleCurrentStock = itemArticleStock.ArticleCurrentStock.Value;

                        if (itemArticleStock.CurrentStock != null)
                            pickingMaterials.CurrentStock = itemArticleStock.CurrentStock.Value;

                        if (itemArticleStock.CostPrice != null)
                            pickingMaterials.CostPrice = itemArticleStock.CostPrice.Value;

                        if (itemArticleStock.UnitPrice != null)
                            pickingMaterials.UnitPrice = itemArticleStock.UnitPrice.Value;


                        pickingMaterials.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        if (pickingMaterials.IdWareHouseDeliveryNoteItem != null)
                        {
                            pickingMaterials.IdWareHouseDeliveryNoteItem = itemArticleStock.IdWareHouseDeliveryNoteItem.Value;


                            pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.Manufacturer = GeManufacturerByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbers(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, itemArticleStock.WarehouseLocation.IdWarehouse));
                        }


                        pickingMaterials.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;


                        pickingMaterials.LocationFullName = itemArticleStock.WarehouseLocation.FullName;


                        pickingMaterials.Description = itemArticleStock.Article.Description;

                        if (!string.IsNullOrEmpty(itemArticleStock.Article.ImagePath))
                        {
                            pickingMaterials.ImagePath = itemArticleStock.Article.ImagePath;
                            Article article = new Article();
                            article.ImagePath = pickingMaterials.ImagePath;
                            pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                        }


                        if (itemArticleStock.MinimumStock != null)
                            pickingMaterials.MinimumStock = itemArticleStock.MinimumStock.Value;

                        if (itemArticleStock.MaximumStock != null)
                            pickingMaterials.MaximumStock = itemArticleStock.MaximumStock.Value;

                        pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (itemArticleStock.UploadedIn != null)
                        {
                            pickingMaterials.UploadedIn = itemArticleStock.UploadedIn;
                            pickingMaterials.WarehouseDeliveryNote.DeliveryDate = itemArticleStock.UploadedIn.Value;
                        }


                        pickingMaterials.WarehouseDeliveryNote.Code = itemArticleStock.WarehouseDeliveryNote.Code;


                        pickingMaterials.IdCurrency = itemArticleStock.IdCurrency;

                        if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        {
                            Int64 articleCurrentStockRem = 0;
                            articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                            if (articleCurrentStockRem > 0)
                            {
                                if (remainingQty > 0 && articleCurrentStockRem > 0)
                                {
                                    if (articleCurrentStockRem > remainingQty)
                                    {
                                        pickingMaterials.DownloadQuantity = remainingQty;
                                        remainingQty = 0;
                                    }
                                    else
                                    {
                                        pickingMaterials.DownloadQuantity = articleCurrentStockRem;
                                        remainingQty = remainingQty - articleCurrentStockRem;
                                    }

                                }
                            }
                            else
                            {
                                if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                                {
                                    if (pickingMaterials.ArticleCurrentStock > remainingQty)
                                    {
                                        pickingMaterials.DownloadQuantity = remainingQty;
                                        remainingQty = 0;
                                    }
                                    else
                                    {
                                        pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                                        remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                                    }

                                }
                            }
                        }
                        else
                        {
                            if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                            {
                                if (pickingMaterials.ArticleCurrentStock > remainingQty)
                                {
                                    pickingMaterials.DownloadQuantity = remainingQty;
                                    remainingQty = 0;
                                }
                                else
                                {
                                    pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                                    remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                                }

                            }
                        }

                        pickingMaterials.WarehouseLocation = new WarehouseLocation();

                        pickingMaterials.WarehouseLocation.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        pickingMaterials.WarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.WarehouseLocation.FullName = itemArticleStock.WarehouseLocation.FullName;

                        pickingMaterials.WarehouseLocation.HtmlColor = itemArticleStock.WarehouseLocation.HtmlColor;

                        pickingMaterials.WarehouseLocation.Latitude = itemArticleStock.WarehouseLocation.Latitude;

                        pickingMaterials.WarehouseLocation.Longitude = itemArticleStock.WarehouseLocation.Longitude;

                        pickingMaterials.WarehouseLocation.Width = itemArticleStock.WarehouseLocation.Width;

                        pickingMaterials.WarehouseLocation.Height = itemArticleStock.WarehouseLocation.Height;

                        pickingMaterials.WarehouseLocation.FileName = itemArticleStock.WarehouseLocation.FileName;

                        pickingMaterials.RegisterSerialNumber = itemArticleStock.Article.RegisterSerialNumber;

                        pickingMaterials.PartNumberCode = GetPartNumberCode(otItem.IdOTItem, connectionString);

                        if (itemArticleStock.IdCountryGroup != null)
                            pickingMaterials.IdCountryGroup = itemArticleStock.IdCountryGroup.Value;

                        //Add in otSameReferenceList
                        OtItemSameReference otItemSameReference = new OtItemSameReference();
                        otItemSameReference.IdArticle = pickingMaterials.IdArticle;
                        otItemSameReference.IdWarehouseDeliveryNoteItem = pickingMaterials.IdWareHouseDeliveryNoteItem;
                        otItemSameReference.ArticleCurrentStock = pickingMaterials.ArticleCurrentStock;
                        otItemSameReference.Qty = pickingMaterials.DownloadQuantity;
                        otItemSameReference.IdWarehouseLocation = pickingMaterials.WarehouseLocation.IdWarehouseLocation;
                        otItemSameReferences.Add(otItemSameReference);

                        otItem.PickingMaterialsList.Add(pickingMaterials);

                        //GetTotalArticleDownloadDetailByOtItem(connectionString, 1800, 35259);

                    }
                    catch (Exception ex)
                    {
                        Log4NetLogger.Logger.Log(string.Format("Error FillPickingMaterial_V2030(IdArticle-{0}, idWarehouse-{1}). ErrorMessage- {2}", otItem.RevisionItem.WarehouseProduct.Article.IdArticle, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                        throw;
                    }
                }
                #endregion

            }

        }



        public List<OtItem> GetRemainingOtItemsByIdOt_V2030(string connectionString, Int64 idOt, Int64 idWarehouse, string ArticleVisualAidsPath)
        {
            List<OtItem> otItems = new List<OtItem>();
            List<OtItemSameReference> OtItemSameReferences = new List<OtItemSameReference>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetRemainingOtItemsByIdOt", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOt", idOt);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OtItem otItem = new OtItem();

                            otItem.IdOT = idOt;

                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);



                            otItem.IsBatch = Convert.ToByte(otItemReader["IsBatch"]);

                            if (otItemReader["AttachedFiles"] != DBNull.Value)
                                otItem.AttachedFiles = Convert.ToString(otItemReader["AttachedFiles"]);

                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);
                                otItem.RevisionItem.Quantity = Convert.ToInt64(otItemReader["Quantity"]);
                                otItem.RevisionItem.UnitPrice = Convert.ToDecimal(otItemReader["UnitPrice"]);

                                if (otItemReader["CustomerCommentOT"] != DBNull.Value)
                                    otItem.RevisionItem.InternalComment = Convert.ToString(otItemReader["CustomerCommentOT"]);

                                if (otItemReader["CustomerCommentRevision"] != DBNull.Value)
                                    otItem.RevisionItem.CustomerComment = Convert.ToString(otItemReader["CustomerCommentRevision"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);

                                if (otItemReader["WpDescription"] != DBNull.Value)
                                    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["ArticleDescription"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["ArticleDescription"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    if (otItemReader["UploadedIn"] != DBNull.Value)
                                        article.UploadedIn = Convert.ToDateTime(otItemReader["UploadedIn"]);

                                    if (otItemReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                        article.IdWareHouseDeliveryNoteItem = Convert.ToInt64(otItemReader["IdWareHouseDeliveryNoteItem"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    article.MyWarehouse = new MyWarehouse();

                                    if (otItemReader["MinimumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MinimumStock"]);

                                    if (otItemReader["MaximumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MaximumStock"]);

                                    if (otItemReader["CurrentStock"] != DBNull.Value)
                                        article.MyWarehouse.CurrentStock = Convert.ToInt64(otItemReader["CurrentStock"]);


                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);

                                    otItem.Status = new ItemOTStatusType();
                                    otItem.Status.IdItemOtStatus = otItem.IdItemOtStatus;
                                    otItem.Status.Name = Convert.ToString(otItemReader["Status"]);
                                }

                                if (otItemReader["AssignedTo"] != DBNull.Value)
                                {
                                    otItem.AssignedTo = Convert.ToInt32(otItemReader["AssignedTo"]);

                                    otItem.AssignedToUser = new People();
                                    otItem.AssignedToUser.Name = Convert.ToString(otItemReader["AssignedName"]);
                                    otItem.AssignedToUser.Surname = Convert.ToString(otItemReader["AssignedSurname"]);
                                }

                                if (otItemReader["DownloadedQty"] != DBNull.Value)
                                    otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otItemReader["DownloadedQty"]);

                                if (otItemReader["RemainingQty"] != DBNull.Value)
                                    otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otItemReader["RemainingQty"]);

                                if (otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;


                                List<OtItem> decomposedOtItems = GetArticlesForDecompositionScan(connectionString, idOt, idWarehouse, otItem, ArticleVisualAidsPath, OtItemSameReferences, otItem.RevisionItem.WarehouseProduct.Article.IdArticleType);

                                //if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                //    otItems.AddRange(decomposedOtItems);



                                if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                {
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    otItem.ArticleDecomposedList = decomposedOtItems;
                                }


                                FillPickingMaterial_V2030(connectionString, otItem, idWarehouse, ArticleVisualAidsPath, otItems, OtItemSameReferences);
                            }

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRemainingOtItemsByIdOt(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetOtItemsByIdOt().", category: Category.Info, priority: Priority.Low);
            return otItems;
        }



        public List<Ots> GetPackingWorkOrdersByWarehouse(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<Ots> ots = new List<Ots>();
            //object geosAppSetting = null;
            //UserManager usermgr = new UserManager();

            //geosAppSetting = usermgr.GetSelectedGeosAppSettings(workbenchConnectionString, "14,15,16,17");



            using (MySqlConnection connOts = new MySqlConnection(connectionString))
            {
                connOts.Open();

                MySqlCommand otsCommand = new MySqlCommand("WMS_GetPackingWorkOrders", connOts);
                otsCommand.CommandType = CommandType.StoredProcedure;
                otsCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                otsCommand.CommandTimeout = 6000;

                using (MySqlDataReader otReader = otsCommand.ExecuteReader())
                {
                    if (otReader.HasRows)
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = new Ots();
                                // ot.GeosAppSettings = geosAppSetting;
                                ot.IdOT = Convert.ToInt64(otReader["IdOT"]);
                                ot.NumOT = Convert.ToByte(otReader["NumOT"]);

                                if (otReader["OtCode"] != DBNull.Value)
                                {
                                    ot.Code = Convert.ToString(otReader["OtCode"]);
                                    ot.MergeCode = Convert.ToString(otReader["MergeCode"]);
                                }

                                if (otReader["DeliveryDate"] != DBNull.Value)
                                {
                                    ot.DeliveryDate = Convert.ToDateTime(otReader["DeliveryDate"]);
                                    ot.Delay = (int)(ot.DeliveryDate.Value.Date - DateTime.Now.Date).TotalDays;
                                }

                                ot.Quotation = new Quotation();

                                if (otReader["IdQuotation"] != DBNull.Value)
                                {
                                    ot.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                                    ot.Quotation.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                                    ot.Quotation.Code = Convert.ToString(otReader["QuotationCode"]);
                                }

                                if (otReader["IdTemplate"] != DBNull.Value)
                                {
                                    ot.Quotation.IdDetectionsTemplate = Convert.ToByte(otReader["IdTemplate"]);

                                    ot.Quotation.Template = new Template();
                                    ot.Quotation.Template.IdTemplate = ot.Quotation.IdDetectionsTemplate;
                                    ot.Quotation.Template.Name = Convert.ToString(otReader["Template"]);
                                    ot.Quotation.Template.IdTemplate = Convert.ToByte(otReader["TemplateType"]);
                                }

                                if (otReader["IdOffer"] != DBNull.Value)
                                {
                                    ot.Quotation.IdOffer = Convert.ToInt64(otReader["IdOffer"]);
                                    ot.Quotation.Offer = new Offer();
                                    ot.Quotation.Offer.IdOffer = ot.Quotation.IdOffer;

                                    if (otReader["IsCritical"] != DBNull.Value)
                                        ot.Quotation.Offer.IsCritical = Convert.ToByte(otReader["IsCritical"]);

                                    if (otReader["IdStatus"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdStatus = Convert.ToInt64(otReader["IdStatus"]);
                                        ot.Quotation.Offer.GeosStatus = new GeosStatus();
                                        ot.Quotation.Offer.GeosStatus.IdOfferStatusType = Convert.ToInt64(otReader["IdStatus"]);
                                        ot.Quotation.Offer.GeosStatus.Name = Convert.ToString(otReader["OfferStatus"]);
                                        ot.Quotation.Offer.GeosStatus.HtmlColor = Convert.ToString(otReader["OfferStatusHtmlColor"]);

                                        if (otReader["IdSalesStatusType"] != DBNull.Value)
                                        {
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType = new SalesStatusType();
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.IdSalesStatusType = Convert.ToInt64(otReader["IdSalesStatusType"]);
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.Name = Convert.ToString(otReader["SalesStatusType"]);
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.HtmlColor = Convert.ToString(otReader["SalesStatusHtmlColor"]);
                                            if (otReader["SalesStatusIdImage"] != DBNull.Value)
                                                ot.Quotation.Offer.GeosStatus.SalesStatusType.IdImage = Convert.ToInt64(otReader["SalesStatusIdImage"]);
                                        }
                                    }

                                    ot.Quotation.Offer.Code = Convert.ToString(otReader["OfferCode"]);
                                    ot.Quotation.Offer.Description = Convert.ToString(otReader["Description"]);

                                    if (otReader["POCloseDate"] != DBNull.Value)
                                        ot.Quotation.Offer.DeliveryDate = Convert.ToDateTime(otReader["POCloseDate"]);

                                    if (otReader["IdOfferType"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdOfferType = Convert.ToByte(otReader["IdOfferType"]);

                                        ot.Quotation.Offer.OfferType = new OfferType();
                                        ot.Quotation.Offer.OfferType.IdOfferType = Convert.ToByte(ot.Quotation.Offer.IdOfferType);
                                        ot.Quotation.Offer.OfferType.Name = Convert.ToString(otReader["OfferType"]);

                                        //ot.MergeCode = ot.Quotation.Code + " " + ot.Quotation.Offer.OfferType.Name + " " + ot.NumOT;
                                    }

                                    if (otReader["IdCarriageMethod"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdCarriageMethod = Convert.ToByte(otReader["IdCarriageMethod"]);
                                        ot.Quotation.Offer.CarriageMethod = new LookupValue();
                                        ot.Quotation.Offer.CarriageMethod.IdLookupValue = Convert.ToByte(ot.Quotation.Offer.IdCarriageMethod);
                                        ot.Quotation.Offer.CarriageMethod.Value = Convert.ToString(otReader["CarriageMethod"]);

                                        if (otReader["CarriageImage"] != DBNull.Value)
                                            ot.Quotation.Offer.CarriageMethod.IdImage = Convert.ToInt64(otReader["CarriageImage"]);
                                    }
                                }

                                if (otReader["IdWarehouse"] != DBNull.Value)
                                {
                                    ot.Quotation.IdWarehouse = Convert.ToInt64(otReader["IdWarehouse"]);
                                }

                                if (otReader["IdSite"] != DBNull.Value)
                                {
                                    ot.Quotation.IdCustomer = Convert.ToInt32(otReader["IdSite"]);
                                    ot.Quotation.Site = new Company();
                                    ot.Quotation.Site.IdCompany = ot.Quotation.IdCustomer;
                                    ot.Quotation.Site.SiteNameWithoutCountry = Convert.ToString(otReader["SiteName"]);

                                    if (otReader["ShortName"] != DBNull.Value && !string.IsNullOrEmpty(Convert.ToString(otReader["ShortName"])))
                                    {
                                        ot.Quotation.Site.ShortName = Convert.ToString(otReader["ShortName"]);
                                        ot.Quotation.Site.Name = ot.Quotation.Site.ShortName;
                                    }
                                    else
                                    {
                                        ot.Quotation.Site.ShortName = null;
                                        ot.Quotation.Site.Name = Convert.ToString(otReader["SiteName"]);
                                    }

                                    ot.Quotation.Site.Customer = new Customer();
                                    ot.Quotation.Site.Customer.IdCustomer = Convert.ToInt32(otReader["IdCustomer"]);
                                    ot.Quotation.Site.Customer.CustomerName = Convert.ToString(otReader["CustomerName"]);

                                    if (otReader["IdCountry"] != DBNull.Value)
                                    {
                                        ot.Quotation.Site.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country = new Country();
                                        ot.Quotation.Site.Country.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country.Name = Convert.ToString(otReader["CountryName"]);
                                    }
                                }

                                if (otReader["ActualQty"] != DBNull.Value)
                                    ot.ActualQuantity = Convert.ToInt64(otReader["ActualQty"]);



                                if (otReader["PODate"] != DBNull.Value)
                                    ot.PoDate = Convert.ToDateTime(otReader["PODate"]);

                                if (otReader["ProducerCountryGroupName"] != DBNull.Value)
                                {
                                    ot.CountryGroup = new CountryGroup();
                                    ot.CountryGroup.Name = otReader["ProducerCountryGroupName"].ToString();
                                    if (otReader["ProducerCountryGroupHTMLColor"] != DBNull.Value)
                                        ot.CountryGroup.HtmlColor = otReader["ProducerCountryGroupHTMLColor"].ToString();
                                }


                                ots.Add(ot);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPackingWorkOrdersByWarehouse() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetPackingWorkOrdersByWarehouse().", category: Category.Info, priority: Priority.Low);
                    return ots;
                }


            }
        }


        public List<InventoryMaterial> GetInventoryArticleByIdWarehouseLocation(Warehouses warehouse, Int64 idWarehouseLocation, string articleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<InventoryMaterial> inventoryMaterials = new List<InventoryMaterial>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetInventoryArticleByIdWarehouseLocation", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouseLocation", idWarehouseLocation);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.CommandTimeout = 6000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                InventoryMaterial inventoryMaterial = new InventoryMaterial();
                                if (reader["IdArticle"] != DBNull.Value)
                                    inventoryMaterial.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                if (reader["AvailableQty"] != DBNull.Value)
                                    inventoryMaterial.AvailableQty = Convert.ToInt64(reader["AvailableQty"]);

                                if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                    inventoryMaterial.IdWareHouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);

                                if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                                {
                                    inventoryMaterial.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                    inventoryMaterial.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["IdWarehouseDeliveryNote"]);
                                    if (reader["Code"] != DBNull.Value)
                                        inventoryMaterial.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                    if (reader["DeliveryDate"] != DBNull.Value)
                                        inventoryMaterial.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                }

                                if (reader["Reference"] != DBNull.Value)
                                    inventoryMaterial.Reference = Convert.ToString(reader["Reference"]);

                                if (reader["Description"] != DBNull.Value)
                                    inventoryMaterial.Description = Convert.ToString(reader["Description"]);

                                if (reader["ImagePath"] != DBNull.Value)
                                {
                                    inventoryMaterial.ImagePath = Convert.ToString(reader["ImagePath"]);
                                    inventoryMaterial.ArticleImageInBytes = GetArticleImageInBytesByImagePath(articleVisualAidsPath, inventoryMaterial.ImagePath);
                                }

                                if (reader["IdWarehouseLocation"] != DBNull.Value)
                                    inventoryMaterial.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    inventoryMaterial.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                                if (reader["ArticleWarehouseMinStock"] != DBNull.Value)
                                    inventoryMaterial.AwlMinimumStock = Convert.ToInt64(reader["ArticleWarehouseMinStock"]);

                                if (reader["WarehouseMinimumStock"] != DBNull.Value)
                                    inventoryMaterial.MinimumStock = Convert.ToInt64(reader["WarehouseMinimumStock"]);

                                if (reader["Price"] != DBNull.Value)
                                    inventoryMaterial.CostPrice = Convert.ToDouble(reader["Price"]);

                                if (reader["UnitPrice"] != DBNull.Value)
                                    inventoryMaterial.UnitPrice = Convert.ToDouble(reader["UnitPrice"]);

                                if (reader["IdOtItem"] != DBNull.Value)
                                    inventoryMaterial.IdOtitem = Convert.ToInt64(reader["IdOtItem"]);

                                if (reader["idCurrency"] != DBNull.Value)
                                    inventoryMaterial.IdCurrency = Convert.ToInt16(reader["idCurrency"]);

                                if (reader["idWarehouseProductComponent"] != DBNull.Value)
                                    inventoryMaterial.IdWarehouseProductComponent = Convert.ToInt64(reader["idWarehouseProductComponent"]);

                                inventoryMaterials.Add(inventoryMaterial);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetInventoryArticleByIdWarehouseLocation() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    Log4NetLogger.Logger.Log("Executed GetInventoryArticleByIdWarehouseLocation().", category: Category.Info, priority: Priority.Low);
                    return inventoryMaterials;
                }
            }
        }


        //public List<InventoryMaterial> GetInventoryArticleByIdWarehouseLocation_V2038(Warehouses warehouse, Int64 idWarehouseLocation, WarehouseInventoryAudit warehouseInventoryAudit, string articleVisualAidsPath)
        //{
        //    List<InventoryMaterial> inventoryMaterials = new List<InventoryMaterial>();

        //    using (MySqlConnection conn = new MySqlConnection(warehouse.Company.ConnectPlantConstr))
        //    {
        //        conn.Open();

        //        MySqlCommand command = new MySqlCommand("WMS_GetInventoryArticleByIdWarehouseLocation", conn);
        //        command.CommandType = CommandType.StoredProcedure;
        //        command.Parameters.AddWithValue("_IdWarehouseLocation", idWarehouseLocation);
        //        command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
        //        command.CommandTimeout = 8000;

        //        using (MySqlDataReader reader = command.ExecuteReader())
        //        {
        //            if (reader.HasRows)
        //            {
        //                while (reader.Read())
        //                {
        //                    try
        //                    {
        //                        InventoryMaterial inventoryMaterial = new InventoryMaterial();

        //                        if (reader["IdArticle"] != DBNull.Value)
        //                            inventoryMaterial.IdArticle = Convert.ToInt32(reader["IdArticle"]);

        //                        if (reader["AvailableQty"] != DBNull.Value)
        //                            inventoryMaterial.AvailableQty = Convert.ToInt64(reader["AvailableQty"]);

        //                        if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
        //                            inventoryMaterial.IdWareHouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);

        //                        if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
        //                        {
        //                            inventoryMaterial.WarehouseDeliveryNote = new WarehouseDeliveryNote();
        //                            inventoryMaterial.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["IdWarehouseDeliveryNote"]);

        //                            if (reader["Code"] != DBNull.Value)
        //                                inventoryMaterial.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);

        //                            if (reader["DeliveryDate"] != DBNull.Value)
        //                                inventoryMaterial.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
        //                        }

        //                        if (reader["Reference"] != DBNull.Value)
        //                            inventoryMaterial.Reference = Convert.ToString(reader["Reference"]);

        //                        if (reader["Description"] != DBNull.Value)
        //                            inventoryMaterial.Description = Convert.ToString(reader["Description"]);

        //                        if (reader["ImagePath"] != DBNull.Value)
        //                        {
        //                            inventoryMaterial.ImagePath = Convert.ToString(reader["ImagePath"]);
        //                            inventoryMaterial.ArticleImageInBytes = GetArticleImageInBytesByImagePath(articleVisualAidsPath, inventoryMaterial.ImagePath);
        //                        }

        //                        if (reader["IdWarehouseLocation"] != DBNull.Value)
        //                            inventoryMaterial.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

        //                        if (reader["IdWarehouse"] != DBNull.Value)
        //                            inventoryMaterial.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

        //                        if (reader["ArticleWarehouseMinStock"] != DBNull.Value)
        //                            inventoryMaterial.AwlMinimumStock = Convert.ToInt64(reader["ArticleWarehouseMinStock"]);

        //                        if (reader["WarehouseMinimumStock"] != DBNull.Value)
        //                            inventoryMaterial.MinimumStock = Convert.ToInt64(reader["WarehouseMinimumStock"]);

        //                        if (reader["Price"] != DBNull.Value)
        //                            inventoryMaterial.CostPrice = Convert.ToDouble(reader["Price"]);

        //                        if (reader["UnitPrice"] != DBNull.Value)
        //                            inventoryMaterial.UnitPrice = Convert.ToDouble(reader["UnitPrice"]);

        //                        if (reader["IdOtItem"] != DBNull.Value)
        //                            inventoryMaterial.IdOtitem = Convert.ToInt64(reader["IdOtItem"]);

        //                        if (reader["idCurrency"] != DBNull.Value)
        //                            inventoryMaterial.IdCurrency = Convert.ToInt16(reader["idCurrency"]);

        //                        if (reader["idWarehouseProductComponent"] != DBNull.Value)
        //                            inventoryMaterial.IdWarehouseProductComponent = Convert.ToInt64(reader["idWarehouseProductComponent"]);

        //                        inventoryMaterial.WarehouseInventoryAuditItem = GetWarehouseInventoryAuditItem(warehouse, inventoryMaterial.IdWareHouseDeliveryNoteItem, inventoryMaterial.IdArticle, inventoryMaterial.IdWarehouseLocation, warehouseInventoryAudit);

        //                        inventoryMaterials.Add(inventoryMaterial);
        //                    }
        //                    catch (Exception ex)
        //                    {
        //                        Log4NetLogger.Logger.Log(string.Format("Error GetInventoryArticleByIdWarehouseLocation() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
        //                        throw;
        //                    }
        //                }
        //            }

        //            Log4NetLogger.Logger.Log("Executed GetInventoryArticleByIdWarehouseLocation().", category: Category.Info, priority: Priority.Low);
        //            return inventoryMaterials;
        //        }
        //    }
        //}

        //private WarehouseInventoryAuditItem GetWarehouseInventoryAuditItem(Warehouses warehouse, Int64 idWareHouseDeliveryNoteItem, int idArticle, Int64 idWarehouseLocation, WarehouseInventoryAudit warehouseInventoryAudit)
        //{
        //    using (MySqlConnection conn = new MySqlConnection(warehouse.Company.ConnectPlantConstr))
        //    {
        //        conn.Open();

        //        MySqlCommand command = new MySqlCommand("WMS_GetWarehouseInventoryAudit", conn);
        //        command.CommandType = CommandType.StoredProcedure;
        //        command.Parameters.AddWithValue("_IdWarehouseInventoryAudit", warehouseInventoryAudit.IdWarehouseInventoryAudit);
        //        command.Parameters.AddWithValue("_IdWarehouseDeliveryNoteItem", idWareHouseDeliveryNoteItem);
        //        command.Parameters.AddWithValue("_IdArticle", idArticle);
        //        command.Parameters.AddWithValue("_IdWarehouseLocation", idWarehouseLocation);

        //        using (MySqlDataReader reader = command.ExecuteReader())
        //        {
        //            if (reader.Read())
        //            {
        //                WarehouseInventoryAuditItem warehouseInventoryAuditItem = new WarehouseInventoryAuditItem();

        //                warehouseInventoryAuditItem.IdWarehouseInventoryAudit = warehouseInventoryAudit.IdWarehouseInventoryAudit;
        //                warehouseInventoryAuditItem.IdWarehouseDeliveryNoteItem = idWareHouseDeliveryNoteItem;
        //                warehouseInventoryAuditItem.IdArticle = idArticle;
        //                warehouseInventoryAuditItem.IdWarehouseLocation = idWarehouseLocation;

        //                warehouseInventoryAuditItem.IdWarehouseInventoryAuditItem = Convert.ToInt64(reader["IdWarehouseInventoryAuditItem"]);

        //                if (reader["ExpectedQuantity"] != DBNull.Value)
        //                    warehouseInventoryAuditItem.ExpectedQuantity = Convert.ToInt64(reader["ExpectedQuantity"]);

        //                if (reader["CurrentQuantity"] != DBNull.Value)
        //                    warehouseInventoryAuditItem.CurrentQuantity = Convert.ToInt64(reader["CurrentQuantity"]);

        //                if (reader["IsOK"] != DBNull.Value)
        //                    warehouseInventoryAuditItem.IsOK = Convert.ToByte(reader["IsOK"]);

        //                if (reader["IdReason"] != DBNull.Value)
        //                    warehouseInventoryAuditItem.IdReason = Convert.ToInt32(reader["IdReason"]);

        //                if (reader["IdReporter"] != DBNull.Value)
        //                    warehouseInventoryAuditItem.IdReporter = Convert.ToInt32(reader["IdReporter"]);

        //                if (reader["IdApprover"] != DBNull.Value)
        //                    warehouseInventoryAuditItem.IdApprover = Convert.ToInt32(reader["IdApprover"]);

        //                return warehouseInventoryAuditItem;
        //            }
        //        }

        //        return null;
        //    }
        //}

        public List<WarehouseInventoryAuditItem> GetWarehouseInventoryAuditItemsByInventoryAudit(Warehouses warehouse, WarehouseInventoryAudit warehouseInventoryAudit, WarehouseLocation warehouseLocation)
        {
            List<WarehouseInventoryAuditItem> warehouseInventoryAuditItems = new List<WarehouseInventoryAuditItem>();

            using (MySqlConnection conn = new MySqlConnection(warehouse.Company.ConnectPlantConstr))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetWarehouseInventoryAuditByIdInventoryAudit", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouseInventoryAudit", warehouseInventoryAudit.IdWarehouseInventoryAudit);
                command.Parameters.AddWithValue("_IdWarehouseLocation", warehouseLocation.IdWarehouseLocation);

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        WarehouseInventoryAuditItem warehouseInventoryAuditItem = new WarehouseInventoryAuditItem();
                        warehouseInventoryAuditItem.IdWarehouseInventoryAudit = warehouseInventoryAudit.IdWarehouseInventoryAudit;
                        warehouseInventoryAuditItem.IdWarehouseInventoryAuditItem = Convert.ToInt64(reader["IdWarehouseInventoryAuditItem"]);

                        if (reader["IdWarehouseDeliveryNoteItem"] != DBNull.Value)
                        {
                            warehouseInventoryAuditItem.IdWarehouseDeliveryNoteItem = Convert.ToInt64(reader["IdWarehouseDeliveryNoteItem"]);

                            warehouseInventoryAuditItem.WarehouseDeliveryNoteItem = new WarehouseDeliveryNoteItem();
                            warehouseInventoryAuditItem.WarehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem = warehouseInventoryAuditItem.IdWarehouseDeliveryNoteItem;

                            warehouseInventoryAuditItem.WarehouseDeliveryNoteItem.WarehouseDeliveryNote = new WarehouseDeliveryNote();

                            if (reader["Code"] != DBNull.Value)
                                warehouseInventoryAuditItem.WarehouseDeliveryNoteItem.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);

                            if (reader["DeliveryDate"] != DBNull.Value)
                                warehouseInventoryAuditItem.WarehouseDeliveryNoteItem.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                        }

                        if (reader["IdArticle"] != DBNull.Value)
                        {
                            warehouseInventoryAuditItem.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                            warehouseInventoryAuditItem.Article = new Article();
                            warehouseInventoryAuditItem.Article.IdArticle = warehouseInventoryAuditItem.IdArticle;

                            if (reader["Reference"] != DBNull.Value)
                                warehouseInventoryAuditItem.Article.Reference = Convert.ToString(reader["Reference"]);

                            if (reader["ImagePath"] != DBNull.Value)
                                warehouseInventoryAuditItem.Article.ImagePath = Convert.ToString(reader["ImagePath"]);

                            warehouseInventoryAuditItem.Article.ArticlesStock = new ArticlesStock();

                            if (reader["UnitPrice"] != DBNull.Value)
                                warehouseInventoryAuditItem.Article.ArticlesStock.UnitPrice = Convert.ToDouble(reader["UnitPrice"]);

                            if (reader["Price"] != DBNull.Value)
                                warehouseInventoryAuditItem.Article.ArticlesStock.Price = Convert.ToDouble(reader["Price"]);

                            if (reader["idCurrency"] != DBNull.Value)
                                warehouseInventoryAuditItem.Article.ArticlesStock.IdCurrency = Convert.ToInt16(reader["idCurrency"]);
                        }

                        if (reader["IdWarehouseLocation"] != DBNull.Value)
                        {
                            warehouseInventoryAuditItem.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);
                        }

                        if (reader["ExpectedQuantity"] != DBNull.Value)
                            warehouseInventoryAuditItem.ExpectedQuantity = Convert.ToInt64(reader["ExpectedQuantity"]);

                        if (reader["CurrentQuantity"] != DBNull.Value)
                            warehouseInventoryAuditItem.CurrentQuantity = Convert.ToInt64(reader["CurrentQuantity"]);

                        if (reader["IsOK"] != DBNull.Value)
                            warehouseInventoryAuditItem.IsOK = Convert.ToByte(reader["IsOK"]);

                        if (reader["IdReason"] != DBNull.Value)
                            warehouseInventoryAuditItem.IdReason = Convert.ToInt32(reader["IdReason"]);

                        if (reader["IdReporter"] != DBNull.Value)
                            warehouseInventoryAuditItem.IdReporter = Convert.ToInt32(reader["IdReporter"]);

                        if (reader["IdApprover"] != DBNull.Value)
                            warehouseInventoryAuditItem.IdApprover = Convert.ToInt32(reader["IdApprover"]);

                        warehouseInventoryAuditItems.Add(warehouseInventoryAuditItem);
                    }
                }

                return warehouseInventoryAuditItems;
            }
        }

        public PendingStorageArticles GetArticleDetailByIdWarehouseDeliveryNoteItem(Warehouses warehouse, Int64 idWarehouseDeliveryNoteItem, string articleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            PendingStorageArticles pendingStorageArticle = null;

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetArticleDetailByIdWarehouseDeliveryNoteItem", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouseDeliveryNoteItem", idWarehouseDeliveryNoteItem);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.CommandTimeout = 6000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        if (reader.Read())
                        {
                            try
                            {
                                pendingStorageArticle = new PendingStorageArticles();

                                if (reader["IdArticle"] != DBNull.Value)
                                    pendingStorageArticle.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                if (reader["StockQty"] != DBNull.Value)
                                    pendingStorageArticle.Quantity = Convert.ToInt64(reader["StockQty"]);

                                if (reader["idCurrency"] != DBNull.Value)
                                    pendingStorageArticle.IdCurrency = Convert.ToInt16(reader["idCurrency"]);

                                if (reader["Price"] != DBNull.Value)
                                    pendingStorageArticle.CostPrice = Convert.ToDouble(reader["Price"]);

                                if (reader["UnitPrice"] != DBNull.Value)
                                    pendingStorageArticle.UnitPrice = Convert.ToDouble(reader["UnitPrice"]);

                                if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                    pendingStorageArticle.IdWareHouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);

                                if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                                {
                                    pendingStorageArticle.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                    pendingStorageArticle.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["IdWarehouseDeliveryNote"]);
                                    if (reader["Code"] != DBNull.Value)
                                        pendingStorageArticle.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                    if (reader["DeliveryDate"] != DBNull.Value)
                                        pendingStorageArticle.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                }

                                if (reader["Reference"] != DBNull.Value)
                                    pendingStorageArticle.Reference = Convert.ToString(reader["Reference"]);

                                if (reader["Description"] != DBNull.Value)
                                    pendingStorageArticle.Description = Convert.ToString(reader["Description"]);

                                if (reader["ImagePath"] != DBNull.Value)
                                {
                                    pendingStorageArticle.ImagePath = Convert.ToString(reader["ImagePath"]);
                                    pendingStorageArticle.ArticleImageInBytes = GetArticleImageInBytesByImagePath(articleVisualAidsPath, pendingStorageArticle.ImagePath);
                                }


                                if (reader["IdWarehouseLocation"] != DBNull.Value)
                                    pendingStorageArticle.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    pendingStorageArticle.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);



                                if (reader["WarehouseMinimumStock"] != DBNull.Value)
                                    pendingStorageArticle.MinimumStock = Convert.ToInt64(reader["WarehouseMinimumStock"]);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetArticleDetailByIdWarehouseDeliveryNoteItem() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetArticleDetailByIdWarehouseDeliveryNoteItem().", category: Category.Info, priority: Priority.Low);
                    return pendingStorageArticle;
                }


            }
        }

        public byte[] GetArticleImageInBytesByImagePath(string ArticleVisualAidsPath, string imagePath)
        {
            if (!Directory.Exists(ArticleVisualAidsPath))
            {
                return null;
            }

            string fileUploadPath = ArticleVisualAidsPath + imagePath;

            if (!File.Exists(fileUploadPath))
            {
                return null;
            }

            if (!string.IsNullOrEmpty(imagePath))
            {

                byte[] bytes = null;

                try
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(fileUploadPath, System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;

                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }

                    return bytes;
                }
                //catch (FileNotFoundException ex)
                //{
                //    Log4NetLogger.Logger.Log(string.Format("Error GetDeliveryNotePdf() article ImagePath-{0}. ErrorMessage- {1}", article.ImagePath, ex.Message), category: Category.Exception, priority: Priority.Low);
                //    //throw;
                //}
                //catch (DirectoryNotFoundException ex)
                //{
                //    Log4NetLogger.Logger.Log(string.Format("Error GetDeliveryNotePdf() article ImagePath-{0}. ErrorMessage- {1}", article.ImagePath, ex.Message), category: Category.Exception, priority: Priority.Low);
                //    //throw;
                //}
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error GetArticleImageInBytesByImagePath() article ImagePath-{0}. ErrorMessage- {1}", imagePath, ex.Message), category: Category.Exception, priority: Priority.Low);
                    //throw;
                }
            }

            return null;
        }


        public List<PickingMaterials> GetArticleStockDetailForRefund_V2031(string connectionString, Int64 idOT, Int64 idWarehouse, string articleVisualAidsPath)
        {
            List<PickingMaterials> PickingMaterialsList = new List<PickingMaterials>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("warehouse_GetArticleStockDetailForRefund_V2031", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdOT", idOT);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {


                    while (articlesReader.Read())
                    {
                        try
                        {

                            PickingMaterials pickingMaterials = new PickingMaterials();

                            if (articlesReader["IdArticle"] != DBNull.Value)
                                pickingMaterials.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            pickingMaterials.Article = new Article();
                            pickingMaterials.Article.IdArticle = pickingMaterials.IdArticle;
                            pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                            pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = pickingMaterials.IdArticle;

                            if (articlesReader["awlMinimumStock"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);

                            if (articlesReader["awlMaximumStock"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["IdOtItem"] != DBNull.Value)
                                pickingMaterials.IdOtitem = Convert.ToInt64(articlesReader["IdOtItem"]);

                            if (articlesReader["IdRevisionItem"] != DBNull.Value)
                            {
                                pickingMaterials.IdRevisionItem = Convert.ToInt64(articlesReader["IdRevisionItem"]);

                                pickingMaterials.RevisionItem = new RevisionItem();
                                pickingMaterials.RevisionItem.IdRevisionItem = pickingMaterials.IdRevisionItem;

                                if (articlesReader["NumItem"] != DBNull.Value)
                                {
                                    pickingMaterials.RevisionItem.NumItem = Convert.ToString(articlesReader["NumItem"]);
                                }


                                if (articlesReader["Quantity"] != DBNull.Value)
                                    pickingMaterials.RevisionItem.Quantity = Convert.ToDecimal(articlesReader["Quantity"]);
                                if (articlesReader["IdProduct"] != DBNull.Value)
                                    pickingMaterials.RevisionItem.IdProduct = Convert.ToInt64(articlesReader["IdProduct"]);
                            }



                            if (articlesReader["idWarehouseProductComponent"] != DBNull.Value)
                            {
                                pickingMaterials.IdWarehouseProductComponent = Convert.ToInt64(articlesReader["idWarehouseProductComponent"]);
                                if (articlesReader["ProductComponentNumber"] != DBNull.Value)
                                    pickingMaterials.ProductComponentNumber = Convert.ToString(articlesReader["ProductComponentNumber"]);
                            }


                            if (articlesReader["Reference"] != DBNull.Value)
                                pickingMaterials.Reference = Convert.ToString(articlesReader["Reference"]);

                            if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                                pickingMaterials.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                            if (articlesReader["CurrentStock"] != DBNull.Value)
                                pickingMaterials.CurrentStock = Convert.ToInt64(articlesReader["CurrentStock"]);

                            if (articlesReader["costprice"] != DBNull.Value)
                                pickingMaterials.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                            if (articlesReader["UnitPrice"] != DBNull.Value)
                                pickingMaterials.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            {
                                pickingMaterials.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);


                                pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                                if (pickingMaterials.RevisionItem != null)
                                {
                                    pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbersForRefund(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, Convert.ToInt64(articlesReader["IdWarehouse"]), pickingMaterials.RevisionItem.IdProduct));
                                }
                                else
                                {
                                    pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbersForRefund(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, Convert.ToInt64(articlesReader["IdWarehouse"]), pickingMaterials.RevisionItem.IdProduct));
                                }

                            }


                            //if (articlesReader["IdArticleWarehouseLocation"] != DBNull.Value)
                            //    pickingMaterials.IdArticleWarehouseLocation = Convert.ToInt64(articlesReader["IdArticleWarehouseLocation"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.LocationFullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingMaterials.Description = articlesReader["Description"].ToString();

                            if (articlesReader["ImagePath"] != DBNull.Value)
                            {
                                pickingMaterials.ImagePath = articlesReader["ImagePath"].ToString();
                                Article article = new Article();
                                article.ImagePath = pickingMaterials.ImagePath;
                                pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, article);
                            }


                            if (articlesReader["MinimumStock"] != DBNull.Value)
                                pickingMaterials.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                            if (articlesReader["MaximumStock"] != DBNull.Value)
                                pickingMaterials.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                            pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                            if (articlesReader["UploadedIn"] != DBNull.Value)
                            {
                                pickingMaterials.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);
                                pickingMaterials.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(articlesReader["UploadedIn"]);
                            }

                            if (articlesReader["DeliveryCode"] != DBNull.Value)
                                pickingMaterials.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);

                            if (articlesReader["IdCurrency"] != DBNull.Value)
                                pickingMaterials.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                            if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                                pickingMaterials.DownloadQuantity = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                            pickingMaterials.WarehouseLocation = new WarehouseLocation();

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.HtmlColor = articlesReader["HtmlColor"].ToString();

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingMaterials.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                            pickingMaterials.PartNumberCode = GetPartNumberCode(pickingMaterials.IdOtitem, connectionString);

                            if (articlesReader["IdCountryGroup"] != DBNull.Value)
                                pickingMaterials.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);



                            PickingMaterialsList.Add(pickingMaterials);


                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleStockDetailForRefund(IdOT-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOT, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }
            return PickingMaterialsList;
        }

        public List<InventoryMaterial> InsertInventoryMaterialIntoArticleStock(string connectionString, List<InventoryMaterial> inventoryMaterials)
        {
            List<InventoryMaterial> NotReguralizedLst = new List<InventoryMaterial>();
            if (inventoryMaterials != null && inventoryMaterials.Count > 0)
            {
                TransactionScope transactionScope = null;
                try
                {
                    using (transactionScope = new TransactionScope())
                    {
                        foreach (InventoryMaterial inventoryMaterial in inventoryMaterials)
                        {
                            inventoryMaterial.ArticleTotalStock = GetArticleStockByWarehouse(connectionString, inventoryMaterial.IdArticle, Convert.ToInt32(inventoryMaterial.IdWarehouse));

                            Int64 updatedStock = inventoryMaterial.ArticleTotalStock + inventoryMaterial.RemainingQty;

                            inventoryMaterial.Comments = string.Format("STOCK REGULARIZATION WMS [STOCK -> {0} ]", updatedStock);

                            if (updatedStock >= 0)
                            {

                                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                                {
                                    mySqlConnection.Open();

                                    MySqlCommand insertCommand = new MySqlCommand("WMS_InsertInventoryMaterialIntoArticlesStock", mySqlConnection);
                                    insertCommand.CommandType = CommandType.StoredProcedure;

                                    insertCommand.Parameters.AddWithValue("_IdArticle", inventoryMaterial.IdArticle);
                                    insertCommand.Parameters.AddWithValue("_IdOtitem", null);
                                    insertCommand.Parameters.AddWithValue("_QTY", inventoryMaterial.RemainingQty);
                                    insertCommand.Parameters.AddWithValue("_Price", inventoryMaterial.CostPrice);
                                    insertCommand.Parameters.AddWithValue("_UnitPrice", inventoryMaterial.UnitPrice);
                                    insertCommand.Parameters.AddWithValue("_Comments", inventoryMaterial.Comments);
                                    insertCommand.Parameters.AddWithValue("_IdModifiedBy", inventoryMaterial.ModifiedBy);
                                    insertCommand.Parameters.AddWithValue("_IDcomponent", null);
                                    insertCommand.Parameters.AddWithValue("_Idwarehouse", inventoryMaterial.IdWarehouse);
                                    insertCommand.Parameters.AddWithValue("_IdWarehouseLocation", inventoryMaterial.IdWarehouseLocation);
                                    insertCommand.Parameters.AddWithValue("_IdWareHouseDeliveryNoteItem", inventoryMaterial.IdWareHouseDeliveryNoteItem);
                                    insertCommand.Parameters.AddWithValue("_IdCurrency", inventoryMaterial.IdCurrency);

                                    int count = insertCommand.ExecuteNonQuery();
                                    // inventoryMaterial.IsInserted = true;
                                    mySqlConnection.Close();
                                }
                            }
                            else
                            {
                                NotReguralizedLst.Add(inventoryMaterial);
                            }

                        }

                        transactionScope.Complete();
                        transactionScope.Dispose();
                    }
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    Log4NetLogger.Logger.Log(string.Format("Error InsertInventoryMaterialIntoArticleStock(). ErrorMessage- ", ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }

            }


            return NotReguralizedLst;
        }


        public Int64 GetMinimumStockByLocationFullName(Warehouses warehouse, string fullName, Int64 idArticle)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            Int64 minimumStock = 0;
            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetMinimumStockByLocationFullName", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                    mySqlCommand.Parameters.AddWithValue("_FullName", fullName);
                    mySqlCommand.Parameters.AddWithValue("_IdArticle", idArticle);
                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        if (reader.Read())
                        {

                            if (reader["MinimumStock"] != DBNull.Value)
                                minimumStock = Convert.ToInt64(reader["MinimumStock"]);

                        }

                    }
                    mySqlConnection.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetMinimumStockByLocationFullName(idWarehouse-{0}, FullName-{1}, IdArticle-{2}). ErrorMessage- {3}", warehouse.IdWarehouse, fullName, idArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return minimumStock;
        }


        public List<ArticleWarehouseLocations> GetArticleWarehouseLocationByIdArticle(Warehouses warehouse, Int64 idArticle)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<ArticleWarehouseLocations> ArticleWarehouseLocationsLst = new List<ArticleWarehouseLocations>();
            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetArticleWarehouseLocationByIdArticle", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdArticle", idArticle);
                    // mySqlCommand.Parameters.AddWithValue("_IdWarehouseLocation", idWarehouseLocation);
                    mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            ArticleWarehouseLocations articleWarehouseLocations = new ArticleWarehouseLocations();
                            if (reader["IdArticle"] != DBNull.Value)
                                articleWarehouseLocations.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                articleWarehouseLocations.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);
                                articleWarehouseLocations.WarehouseLocation = new WarehouseLocation();
                                articleWarehouseLocations.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);
                                articleWarehouseLocations.WarehouseLocation.FullName = reader["FullName"].ToString();
                            }

                            ArticleWarehouseLocationsLst.Add(articleWarehouseLocations);



                        }

                    }
                    mySqlConnection.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetArticleWarehouseLocationByIdArticle(IdArticle-{0}). ErrorMessage- {1}", idArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return ArticleWarehouseLocationsLst;
        }


        public List<ArticlesStock> GetWarehouseDeliveryNoteCode_V2032(Int64 idOTItem, Warehouses warehouse, Int64? idWarehouseProductComponent)
        {
            List<ArticlesStock> articleStockLst = new List<ArticlesStock>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetWarehouseDeliveryNoteCode_V2032", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdOTItem", idOTItem);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouseProductComponent", idWarehouseProductComponent);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            ArticlesStock articlesStock = new ArticlesStock();

                            if (reader["IdOtItem"] != DBNull.Value)
                                articlesStock.IdOtItem = Convert.ToUInt64(reader["IdOtItem"]);

                            if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            {
                                articlesStock.IdWarehouseDeliveryNoteItem = Convert.ToUInt64(reader["IdWareHouseDeliveryNoteItem"]);
                                articlesStock.WarehouseDeliveryNoteItem = new WarehouseDeliveryNoteItem();
                                articlesStock.WarehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);
                                articlesStock.WarehouseDeliveryNoteItem.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                articlesStock.WarehouseDeliveryNoteItem.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                articlesStock.WarehouseDeliveryNoteItem.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);

                                articlesStock.WarehouseDeliveryNoteItem.Producer = new ManufacturersByArticle();
                                if (reader["IdManufacturer"] != DBNull.Value)
                                {

                                    articlesStock.WarehouseDeliveryNoteItem.Producer.IdManufacturer = Convert.ToInt64(reader["IdManufacturer"]);
                                    articlesStock.WarehouseDeliveryNoteItem.Producer.Manufacturer = new Manufacturer();
                                    articlesStock.WarehouseDeliveryNoteItem.Producer.Manufacturer.IdManufacturer = Convert.ToInt64(reader["IdManufacturer"]);
                                    articlesStock.WarehouseDeliveryNoteItem.Producer.Manufacturer.Name = reader["ManufacturerName"].ToString();
                                }
                                if (reader["IdCountry"] != DBNull.Value)
                                {
                                    articlesStock.WarehouseDeliveryNoteItem.Producer.IdCountry = Convert.ToInt64(reader["IdCountry"]);
                                    articlesStock.WarehouseDeliveryNoteItem.Producer.Country = new Country();
                                    articlesStock.WarehouseDeliveryNoteItem.Producer.Country.IdCountry = Convert.ToByte(reader["IdCountry"]);
                                    articlesStock.WarehouseDeliveryNoteItem.Producer.Country.Name = Convert.ToString(reader["CountryName"]);
                                }



                            }

                            if (reader["qty"] != DBNull.Value)
                            {
                                articlesStock.Quantity = Convert.ToInt64(reader["qty"]);
                            }

                            if (reader["idWarehouseProductComponent"] != DBNull.Value)
                                articlesStock.IdWarehouseProductComponent = Convert.ToUInt64(reader["idWarehouseProductComponent"]);

                            articleStockLst.Add(articlesStock);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetWarehouseDeliveryNoteCode_V2032(). IdOtItem- {0} _IdWarehouse-{1} ErrorMessage- {2}", idOTItem, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }

            }

            return articleStockLst;
        }

        public List<ArticleWarehouseLocations> GetArticlesWarehouseLocation_V2032(string IdArticles, Warehouses warehouse)
        {
            List<ArticleWarehouseLocations> articleWarehouseLocationsList = new List<ArticleWarehouseLocations>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("warehouse_GetArticlesLocationByIdArticle_V2032", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", IdArticles);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {
                    while (articlesReader.Read())
                    {
                        try
                        {
                            ArticleWarehouseLocations articleWarehouseLocations = new ArticleWarehouseLocations();

                            if (articlesReader["IdArticle"] != DBNull.Value)
                                articleWarehouseLocations.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                articleWarehouseLocations.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                articleWarehouseLocations.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdArticleWarehouseLocation"] != DBNull.Value)
                                articleWarehouseLocations.IdArticleWarehouseLocation = Convert.ToInt64(articlesReader["IdArticleWarehouseLocation"]);

                            if (articlesReader["Parent"] != DBNull.Value)
                                articleWarehouseLocations.Parent = Convert.ToInt64(articlesReader["Parent"]);

                            if (articlesReader["Position"] != DBNull.Value)
                                articleWarehouseLocations.Position = Convert.ToInt64(articlesReader["Position"]);

                            if (articlesReader["Name"] != DBNull.Value)
                                articleWarehouseLocations.Name = articlesReader["Name"].ToString();

                            if (articlesReader["FullName"] != DBNull.Value)
                                articleWarehouseLocations.FullName = articlesReader["FullName"].ToString();

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                articleWarehouseLocations.WarehouseLocation = new WarehouseLocation();

                                articleWarehouseLocations.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);
                                if (articlesReader["IdWarehouse"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);
                                if (articlesReader["Name"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Name = Convert.ToString(articlesReader["Name"]);
                                if (articlesReader["Parent"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Parent = Convert.ToInt64(articlesReader["Parent"]);
                                if (articlesReader["Position"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Position = Convert.ToInt64(articlesReader["Position"]);
                                if (articlesReader["FullName"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.FullName = Convert.ToString(articlesReader["FullName"]);
                                if (articlesReader["FileName"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);
                                if (articlesReader["Latitude"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                                if (articlesReader["Longitude"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                                if (articlesReader["Height"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                                if (articlesReader["Width"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                                if (articlesReader["LocationStock"] != DBNull.Value)
                                    articleWarehouseLocations.LocationStock = Convert.ToInt64(articlesReader["LocationStock"]);
                            }

                            articleWarehouseLocationsList.Add(articleWarehouseLocations);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticlesWarehouseLocation_V2032(IdArticle-{0} . ErrorMessage- {2}", IdArticles, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }

            }

            List<ArticleWarehouseLocations> finalList = new List<ArticleWarehouseLocations>();

            foreach (var itemArticle in articleWarehouseLocationsList.OrderBy(i => i.Position).GroupBy(i => i.IdArticle))
            {
                if (itemArticle.Any(i => i.LocationStock != 0))
                {
                    ArticleWarehouseLocations articleWarehouseLocations = new ArticleWarehouseLocations();
                    articleWarehouseLocations = itemArticle.LastOrDefault();
                    finalList.Add(articleWarehouseLocations);

                    //foreach (ArticleWarehouseLocations itemArticleWarehouseLocations in itemArticle)
                    //{
                    //    if (itemArticleWarehouseLocations.LocationStock == 0)
                    //    {
                    //       finalList.Add(itemArticleWarehouseLocations);
                    //        break;
                    //    }
                    //}
                }
                else
                {
                    finalList.Add(itemArticle.FirstOrDefault());
                }
            }
            return finalList;

        }

        public string GetMadeInByIdWareHouseDeliveryNoteItem(Int64 idWareHouseDeliveryNoteItem, Warehouses warehouse)
        {
            string madeIn = null;
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand Command = new MySqlCommand("manufacturersbyarticle_GetMadeIn", conn);
                Command.CommandType = CommandType.StoredProcedure;
                Command.Parameters.AddWithValue("_IdWareHouseDeliveryNoteItem", idWareHouseDeliveryNoteItem);


                using (MySqlDataReader Reader = Command.ExecuteReader())
                {
                    if (Reader.Read())
                    {
                        try
                        {
                            madeIn = Reader["name"].ToString();

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetMadeInByIdWareHouseDeliveryNoteItem(ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }
            return madeIn;

        }


        public List<string> GetReadMeEntriesTitle(Int64 idQuotation, Warehouses warehouse)
        {
            List<string> titles = new List<string>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand Command = new MySqlCommand("WMS_GetReadMeEntriesTitle", conn);
                Command.CommandType = CommandType.StoredProcedure;
                Command.Parameters.AddWithValue("_IdQuotation", idQuotation);


                using (MySqlDataReader Reader = Command.ExecuteReader())
                {
                    while (Reader.Read())
                    {
                        try
                        {
                            string title = Reader["Title"].ToString();
                            titles.Add(title);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetReadMeEntriesTitle(ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }
            return titles;

        }


        public void FillPickingMaterialDisbaledFIFO(string connectionString, OtItem otItem, Int64 idWarehouse, string ArticleVisualAidsPath, List<OtItem> otitems)
        {
            otItem.PickingMaterialsList = new List<PickingMaterials>();
            List<PickingArticleStockDetail> pickingArticleStockDetails = new List<PickingArticleStockDetail>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetArticlesStockDetailsByIdArticleDisbaledFIFO", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", otItem.RevisionItem.WarehouseProduct.Article.IdArticle);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                #region
                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {

                    while (articlesReader.Read())
                    {
                        PickingArticleStockDetail pickingArticleStockDetail = new PickingArticleStockDetail();

                        pickingArticleStockDetail.Article = new Article();
                        if (articlesReader["IdArticle"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            pickingArticleStockDetail.Article.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingArticleStockDetail.Article.Description = Convert.ToString(articlesReader["Description"]);

                            if (articlesReader["ImagePath"] != DBNull.Value)
                                pickingArticleStockDetail.Article.ImagePath = Convert.ToString(articlesReader["ImagePath"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingArticleStockDetail.Article.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                        }

                        if (articlesReader["awlMinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);

                        if (articlesReader["awlMaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);

                        if (articlesReader["ArticleLocationPosition"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationPosition = Convert.ToInt64(articlesReader["ArticleLocationPosition"]);

                        if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                        if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            pickingArticleStockDetail.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                        pickingArticleStockDetail.WarehouseLocation = new WarehouseLocation();
                        if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);


                            pickingArticleStockDetail.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);
                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FullName = Convert.ToString(articlesReader["Fullname"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.HtmlColor = Convert.ToString(articlesReader["HtmlColor"]);

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);
                        }


                        if (articlesReader["UnitPrice"] != DBNull.Value)
                            pickingArticleStockDetail.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                        if (articlesReader["IdCurrency"] != DBNull.Value)
                            pickingArticleStockDetail.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                        if (articlesReader["costprice"] != DBNull.Value)
                            pickingArticleStockDetail.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                        if (articlesReader["MinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                        if (articlesReader["MaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                        pickingArticleStockDetail.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (articlesReader["UploadedIn"] != DBNull.Value)
                            pickingArticleStockDetail.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);

                        if (articlesReader["DeliveryCode"] != DBNull.Value)
                        {

                            pickingArticleStockDetail.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);
                        }


                        if (articlesReader["IdCountryGroup"] != DBNull.Value)
                            pickingArticleStockDetail.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);

                        pickingArticleStockDetails.Add(pickingArticleStockDetail);
                    }
                }
                List<PickingArticleStockDetail> PickingArticleStockDetailSort = new List<PickingArticleStockDetail>();

                foreach (var itemPASD in pickingArticleStockDetails.GroupBy(i => Convert.ToDateTime(i.UploadedIn.Value.ToShortDateString())))
                {
                    foreach (var item in itemPASD.OrderBy(i => i.ArticleLocationPosition).ToList())
                    {
                        PickingArticleStockDetailSort.Add(item);
                    }
                }

                pickingArticleStockDetails = PickingArticleStockDetailSort;

                // Int64 remainingQty = otItem.RevisionItem.RemainingQuantity; // download Quantity.
                foreach (PickingArticleStockDetail itemArticleStock in pickingArticleStockDetails)
                {

                    try
                    {

                        //if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        //{
                        //    Int64 articleCurrentStockRem = 0;
                        //    articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                        //    if (articleCurrentStockRem == 0)
                        //        continue;
                        //    else
                        //        if (remainingQty == 0)
                        //        return;
                        //}
                        //else
                        //{
                        //    if (remainingQty == 0)
                        //        return;
                        //}



                        PickingMaterials pickingMaterials = new PickingMaterials();

                        pickingMaterials.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        pickingMaterials.Article = new Article();
                        pickingMaterials.Article.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;
                        pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                        pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        if (itemArticleStock.ArticleLocationMinimumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = itemArticleStock.ArticleLocationMinimumStock.Value;
                        if (itemArticleStock.ArticleLocationMaximumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = itemArticleStock.ArticleLocationMaximumStock.Value;

                        pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.IdOtitem = otItem.IdOTItem;

                        pickingMaterials.IdRevisionItem = otItem.IdRevisionItem;
                        pickingMaterials.RevisionItem = new RevisionItem();
                        pickingMaterials.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.NumItem = otItem.RevisionItem.NumItem;

                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.Quantity = otItem.RevisionItem.Quantity;

                        if (otItem.RevisionItem != null)
                            if (otItem.RevisionItem.WarehouseProduct != null)
                                pickingMaterials.IdWarehouseProductComponent = otItem.RevisionItem.WarehouseProduct.IdComponent;

                        if (!string.IsNullOrEmpty(otItem.RevisionItem.WarehouseProduct.Article.Reference))
                            pickingMaterials.Reference = otItem.RevisionItem.WarehouseProduct.Article.Reference;

                        if (itemArticleStock.ArticleCurrentStock != null)
                            pickingMaterials.ArticleCurrentStock = itemArticleStock.ArticleCurrentStock.Value;

                        if (itemArticleStock.CurrentStock != null)
                            pickingMaterials.CurrentStock = itemArticleStock.CurrentStock.Value;

                        if (itemArticleStock.CostPrice != null)
                            pickingMaterials.CostPrice = itemArticleStock.CostPrice.Value;

                        if (itemArticleStock.UnitPrice != null)
                            pickingMaterials.UnitPrice = itemArticleStock.UnitPrice.Value;


                        pickingMaterials.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        if (pickingMaterials.IdWareHouseDeliveryNoteItem != null)
                        {
                            pickingMaterials.IdWareHouseDeliveryNoteItem = itemArticleStock.IdWareHouseDeliveryNoteItem.Value;


                            pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.Manufacturer = GeManufacturerByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbers(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, itemArticleStock.WarehouseLocation.IdWarehouse));
                        }


                        pickingMaterials.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;


                        pickingMaterials.LocationFullName = itemArticleStock.WarehouseLocation.FullName;


                        pickingMaterials.Description = itemArticleStock.Article.Description;

                        if (!string.IsNullOrEmpty(itemArticleStock.Article.ImagePath))
                        {
                            pickingMaterials.ImagePath = itemArticleStock.Article.ImagePath;
                            Article article = new Article();
                            article.ImagePath = pickingMaterials.ImagePath;
                            pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                        }


                        if (itemArticleStock.MinimumStock != null)
                            pickingMaterials.MinimumStock = itemArticleStock.MinimumStock.Value;

                        if (itemArticleStock.MaximumStock != null)
                            pickingMaterials.MaximumStock = itemArticleStock.MaximumStock.Value;

                        pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (itemArticleStock.UploadedIn != null)
                        {
                            pickingMaterials.UploadedIn = itemArticleStock.UploadedIn;
                            pickingMaterials.WarehouseDeliveryNote.DeliveryDate = itemArticleStock.UploadedIn.Value;
                        }


                        pickingMaterials.WarehouseDeliveryNote.Code = itemArticleStock.WarehouseDeliveryNote.Code;


                        pickingMaterials.IdCurrency = itemArticleStock.IdCurrency;

                        pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;

                        //if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        //{
                        //    Int64 articleCurrentStockRem = 0;
                        //    articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                        //    if (articleCurrentStockRem > 0)
                        //    {
                        //        if (remainingQty > 0 && articleCurrentStockRem > 0)
                        //        {
                        //            if (articleCurrentStockRem > remainingQty)
                        //            {
                        //                pickingMaterials.DownloadQuantity = remainingQty;
                        //                remainingQty = 0;
                        //            }
                        //            else
                        //            {
                        //                pickingMaterials.DownloadQuantity = articleCurrentStockRem;
                        //                remainingQty = remainingQty - articleCurrentStockRem;
                        //            }

                        //        }
                        //    }
                        //    else
                        //    {
                        //        if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                        //        {
                        //            if (pickingMaterials.ArticleCurrentStock > remainingQty)
                        //            {
                        //                pickingMaterials.DownloadQuantity = remainingQty;
                        //                remainingQty = 0;
                        //            }
                        //            else
                        //            {
                        //                pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                        //                remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                        //            }

                        //        }
                        //    }
                        //}
                        //else
                        //{
                        //    if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                        //    {
                        //        if (pickingMaterials.ArticleCurrentStock > remainingQty)
                        //        {
                        //            pickingMaterials.DownloadQuantity = remainingQty;
                        //            remainingQty = 0;
                        //        }
                        //        else
                        //        {
                        //            pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                        //            remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                        //        }

                        //    }
                        //}

                        pickingMaterials.WarehouseLocation = new WarehouseLocation();

                        pickingMaterials.WarehouseLocation.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        pickingMaterials.WarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.WarehouseLocation.FullName = itemArticleStock.WarehouseLocation.FullName;

                        pickingMaterials.WarehouseLocation.HtmlColor = itemArticleStock.WarehouseLocation.HtmlColor;

                        pickingMaterials.WarehouseLocation.Latitude = itemArticleStock.WarehouseLocation.Latitude;

                        pickingMaterials.WarehouseLocation.Longitude = itemArticleStock.WarehouseLocation.Longitude;

                        pickingMaterials.WarehouseLocation.Width = itemArticleStock.WarehouseLocation.Width;

                        pickingMaterials.WarehouseLocation.Height = itemArticleStock.WarehouseLocation.Height;

                        pickingMaterials.WarehouseLocation.FileName = itemArticleStock.WarehouseLocation.FileName;

                        pickingMaterials.RegisterSerialNumber = itemArticleStock.Article.RegisterSerialNumber;

                        pickingMaterials.PartNumberCode = GetPartNumberCode(otItem.IdOTItem, connectionString);

                        if (itemArticleStock.IdCountryGroup != null)
                            pickingMaterials.IdCountryGroup = itemArticleStock.IdCountryGroup.Value;

                        ////Add in otSameReferenceList
                        //OtItemSameReference otItemSameReference = new OtItemSameReference();
                        //otItemSameReference.IdArticle = pickingMaterials.IdArticle;
                        //otItemSameReference.IdWarehouseDeliveryNoteItem = pickingMaterials.IdWareHouseDeliveryNoteItem;
                        //otItemSameReference.ArticleCurrentStock = pickingMaterials.ArticleCurrentStock;
                        //otItemSameReference.Qty = pickingMaterials.DownloadQuantity;
                        //otItemSameReference.IdWarehouseLocation = pickingMaterials.WarehouseLocation.IdWarehouseLocation;
                        //otItemSameReferences.Add(otItemSameReference);

                        otItem.PickingMaterialsList.Add(pickingMaterials);

                        //GetTotalArticleDownloadDetailByOtItem(connectionString, 1800, 35259);

                    }
                    catch (Exception ex)
                    {
                        Log4NetLogger.Logger.Log(string.Format("Error FillPickingMaterial_V2030(IdArticle-{0}, idWarehouse-{1}). ErrorMessage- {2}", otItem.RevisionItem.WarehouseProduct.Article.IdArticle, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                        throw;
                    }
                }
                #endregion

            }

        }


        public List<OtItem> GetRemainingOtItemsByIdOtDisbaledFIFO(Int64 idOt, Warehouses warehouse, string ArticleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OtItem> otItems = new List<OtItem>();
            List<OtItemSameReference> OtItemSameReferences = new List<OtItemSameReference>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetRemainingOtItemsByIdOt", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOt", idOt);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OtItem otItem = new OtItem();

                            otItem.IdOT = idOt;

                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);



                            otItem.IsBatch = Convert.ToByte(otItemReader["IsBatch"]);

                            if (otItemReader["AttachedFiles"] != DBNull.Value)
                                otItem.AttachedFiles = Convert.ToString(otItemReader["AttachedFiles"]);

                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);
                                otItem.RevisionItem.Quantity = Convert.ToInt64(otItemReader["Quantity"]);
                                otItem.RevisionItem.UnitPrice = Convert.ToDecimal(otItemReader["UnitPrice"]);

                                if (otItemReader["CustomerCommentOT"] != DBNull.Value)
                                    otItem.RevisionItem.InternalComment = Convert.ToString(otItemReader["CustomerCommentOT"]);

                                if (otItemReader["CustomerCommentRevision"] != DBNull.Value)
                                    otItem.RevisionItem.CustomerComment = Convert.ToString(otItemReader["CustomerCommentRevision"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);

                                if (otItemReader["WpDescription"] != DBNull.Value)
                                    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["ArticleDescription"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["ArticleDescription"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    if (otItemReader["UploadedIn"] != DBNull.Value)
                                        article.UploadedIn = Convert.ToDateTime(otItemReader["UploadedIn"]);

                                    if (otItemReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                        article.IdWareHouseDeliveryNoteItem = Convert.ToInt64(otItemReader["IdWareHouseDeliveryNoteItem"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    article.MyWarehouse = new MyWarehouse();

                                    if (otItemReader["MinimumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MinimumStock"]);

                                    if (otItemReader["MaximumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MaximumStock"]);

                                    if (otItemReader["CurrentStock"] != DBNull.Value)
                                        article.MyWarehouse.CurrentStock = Convert.ToInt64(otItemReader["CurrentStock"]);


                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);

                                    otItem.Status = new ItemOTStatusType();
                                    otItem.Status.IdItemOtStatus = otItem.IdItemOtStatus;
                                    otItem.Status.Name = Convert.ToString(otItemReader["Status"]);
                                }

                                if (otItemReader["AssignedTo"] != DBNull.Value)
                                {
                                    otItem.AssignedTo = Convert.ToInt32(otItemReader["AssignedTo"]);

                                    otItem.AssignedToUser = new People();
                                    otItem.AssignedToUser.Name = Convert.ToString(otItemReader["AssignedName"]);
                                    otItem.AssignedToUser.Surname = Convert.ToString(otItemReader["AssignedSurname"]);
                                }

                                if (otItemReader["DownloadedQty"] != DBNull.Value)
                                    otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otItemReader["DownloadedQty"]);

                                if (otItemReader["RemainingQty"] != DBNull.Value)
                                    otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otItemReader["RemainingQty"]);

                                if (otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;


                                List<OtItem> decomposedOtItems = GetArticlesForDecompositionScanDisabledFIFO(connectionString, idOt, warehouse.IdWarehouse, otItem, ArticleVisualAidsPath, OtItemSameReferences, otItem.RevisionItem.WarehouseProduct.Article.IdArticleType);

                                //if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                //    otItems.AddRange(decomposedOtItems);



                                if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                {
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    otItem.ArticleDecomposedList = decomposedOtItems;
                                }


                                FillPickingMaterialDisbaledFIFO(connectionString, otItem, warehouse.IdWarehouse, ArticleVisualAidsPath, otItems);
                            }

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRemainingOtItemsByIdOtDisbaledFIFO(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetOtItemsByIdOt().", category: Category.Info, priority: Priority.Low);
            return otItems;
        }


        public List<OtItem> GetArticlesForDecompositionScanDisabledFIFO(string connectionString, Int64 idOt, Int64 idWarehouse, OtItem parentOtItem, string ArticleVisualAidsPath, List<OtItemSameReference> otItemSameReferences, Int64 idArticleType)
        {
            List<OtItem> otItems = new List<OtItem>();


            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetArticlesForDecomposition", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOTitem", parentOtItem.IdOTItem);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            // keyId++;

                            OtItem otItem = new OtItem();
                            otItem.IdOT = idOt;
                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);

                            if (otItemReader["IdItemOtStatus"] != DBNull.Value)
                                otItem.IdItemOtStatus = Convert.ToByte(otItemReader["IdItemOtStatus"]);


                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);



                                if (otItemReader["IdComponent"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otItemReader["IdComponent"]);
                                }

                                //   otItem.KeyId = keyId;

                                if (otItemReader["idParent"] != DBNull.Value)
                                {
                                    otItem.ParentId = Convert.ToInt32(otItemReader["idParent"]);
                                }

                                if (otItem.ParentId == -1)
                                {
                                    otItem.ParentId = parentOtItem.KeyId;
                                    otItem.RevisionItem.Quantity = parentOtItem.RevisionItem.Quantity * Convert.ToDecimal(otItemReader["Quantity"]);
                                }
                                else
                                {
                                    //OtItem otItem213 = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId);

                                    decimal qty = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).RevisionItem.Quantity;
                                    otItem.RevisionItem.Quantity = qty * Convert.ToDecimal(otItemReader["Quantity"]);
                                    otItem.ParentId = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).KeyId;
                                }

                                //if (otItemReader["WpDescription"] != DBNull.Value)
                                //    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["Description"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["Description"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Weight"] != DBNull.Value)
                                        article.Weight = Convert.ToDecimal(otItemReader["Weight"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);
                                }


                                int downloaded = GetOtItemDownloadedQuantity(connectionString, otItem.RevisionItem.WarehouseProduct.Article.IdArticle, otItem.IdOTItem, otItem.RevisionItem.WarehouseProduct.IdComponent, idWarehouse);


                                otItem.RevisionItem.DownloadedQuantity = downloaded;

                                otItem.RevisionItem.RemainingQuantity = ((Int64)otItem.RevisionItem.Quantity - downloaded);

                                if ((Int64)otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;
                            }
                            otItem.PickingMaterialsList = new List<PickingMaterials>();
                            if (idArticleType != 2)
                                FillPickingMaterialDisbaledFIFO(connectionString, otItem, idWarehouse, ArticleVisualAidsPath, otItems);

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticlesForDecompositionScanDisabledFIFO(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }

            return otItems;
        }


        public bool AddObservation(string connectionString, Observation observation)
        {
            TransactionScope transactionScope = null;

            using (transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection conn = new MySqlConnection(connectionString))
                    {
                        conn.Open();

                        MySqlCommand insertCommand = new MySqlCommand("Observations_Insert", conn);
                        insertCommand.CommandType = CommandType.StoredProcedure;

                        insertCommand.Parameters.AddWithValue("_IdRevisionItem", observation.IdRevisionItem);
                        insertCommand.Parameters.AddWithValue("_CreationDate", DateTime.Now);
                        insertCommand.Parameters.AddWithValue("_IdUser", observation.IdUser);
                        insertCommand.Parameters.AddWithValue("_Text", observation.Text);


                        int count = insertCommand.ExecuteNonQuery();

                        conn.Close();
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error UpdateObservation(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return true;
        }


        public List<InventoryMaterial> GetInventoryArticleByIdWarehouseDeliveryNoteItem(Warehouses warehouse, Int64 idWarehouseDeliveryNoteItem, string articleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<InventoryMaterial> inventoryMaterials = new List<InventoryMaterial>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetInventoryArticleByIdWarehouseDeliveryNoteItem", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouseDeliveryNoteItem", idWarehouseDeliveryNoteItem);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.CommandTimeout = 6000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                InventoryMaterial inventoryMaterial = new InventoryMaterial();
                                if (reader["IdArticle"] != DBNull.Value)
                                    inventoryMaterial.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                if (reader["AvailableQty"] != DBNull.Value)
                                    inventoryMaterial.AvailableQty = Convert.ToInt64(reader["AvailableQty"]);

                                if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                    inventoryMaterial.IdWareHouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);


                                if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                                {
                                    inventoryMaterial.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                    inventoryMaterial.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["IdWarehouseDeliveryNote"]);
                                    if (reader["Code"] != DBNull.Value)
                                        inventoryMaterial.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                    if (reader["DeliveryDate"] != DBNull.Value)
                                        inventoryMaterial.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                }

                                if (reader["Reference"] != DBNull.Value)
                                    inventoryMaterial.Reference = Convert.ToString(reader["Reference"]);

                                if (reader["Description"] != DBNull.Value)
                                    inventoryMaterial.Description = Convert.ToString(reader["Description"]);

                                if (reader["ImagePath"] != DBNull.Value)
                                {
                                    inventoryMaterial.ImagePath = Convert.ToString(reader["ImagePath"]);
                                    inventoryMaterial.ArticleImageInBytes = GetArticleImageInBytesByImagePath(articleVisualAidsPath, inventoryMaterial.ImagePath);
                                }


                                if (reader["IdWarehouseLocation"] != DBNull.Value)
                                    inventoryMaterial.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    inventoryMaterial.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                                if (reader["ArticleWarehouseMinStock"] != DBNull.Value)
                                    inventoryMaterial.AwlMinimumStock = Convert.ToInt64(reader["ArticleWarehouseMinStock"]);

                                if (reader["WarehouseMinimumStock"] != DBNull.Value)
                                    inventoryMaterial.MinimumStock = Convert.ToInt64(reader["WarehouseMinimumStock"]);

                                if (reader["Price"] != DBNull.Value)
                                    inventoryMaterial.CostPrice = Convert.ToDouble(reader["Price"]);

                                if (reader["UnitPrice"] != DBNull.Value)
                                    inventoryMaterial.UnitPrice = Convert.ToDouble(reader["UnitPrice"]);

                                if (reader["IdOtItem"] != DBNull.Value)
                                    inventoryMaterial.IdOtitem = Convert.ToInt64(reader["IdOtItem"]);

                                if (reader["idCurrency"] != DBNull.Value)
                                    inventoryMaterial.IdCurrency = Convert.ToInt16(reader["idCurrency"]);

                                if (reader["idWarehouseProductComponent"] != DBNull.Value)
                                    inventoryMaterial.IdWarehouseProductComponent = Convert.ToInt64(reader["idWarehouseProductComponent"]);

                                inventoryMaterials.Add(inventoryMaterial);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetInventoryArticleByIdWarehouseDeliveryNoteItem() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetInventoryArticleByIdWarehouseDeliveryNoteItem().", category: Category.Info, priority: Priority.Low);
                    return inventoryMaterials;
                }


            }
        }

        public List<ArticleWarehouseLocations> AddArticleWarehouseLocationIFNotExist(string mainServerConnectionString, List<ArticleWarehouseLocations> articleWarehouseLocations)
        {
            List<ArticleWarehouseLocations> addedArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
            if (articleWarehouseLocations != null && articleWarehouseLocations.Count > 0)
            {
                TransactionScope transactionScope = null;
                try
                {
                    using (transactionScope = new TransactionScope())
                    {
                        foreach (ArticleWarehouseLocations articleWarehouseLocation in articleWarehouseLocations)
                        {
                            using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                            {
                                mySqlConnection.Open();

                                MySqlCommand mySqlCommand = new MySqlCommand("WMS_AddArticleWarehouseLocationIFNotExist", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;
                                mySqlCommand.Parameters.AddWithValue("_IdWarehouseLocation", articleWarehouseLocation.IdWarehouseLocation);
                                mySqlCommand.Parameters.AddWithValue("_Position", articleWarehouseLocation.Position);
                                mySqlCommand.Parameters.AddWithValue("_IdArticle", articleWarehouseLocation.IdArticle);
                                mySqlCommand.Parameters.AddWithValue("_MinimumStock", articleWarehouseLocation.MinimumStock);
                                mySqlCommand.Parameters.AddWithValue("_MaximumStock", articleWarehouseLocation.MaximumStock);

                                articleWarehouseLocation.IdArticleWarehouseLocation = Convert.ToInt32(mySqlCommand.ExecuteScalar());

                                if (articleWarehouseLocation.IdArticleWarehouseLocation > 0)
                                    addedArticleWarehouseLocations.Add(articleWarehouseLocation);

                                mySqlConnection.Close();
                            }
                        }

                        transactionScope.Complete();
                        transactionScope.Dispose();
                    }
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();
                    Log4NetLogger.Logger.Log(string.Format("Error AddArticleWarehouseLocationIFNotExist(). ErrorMessage- ", ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }
            }

            return addedArticleWarehouseLocations;
        }


        public List<Ots> GetPendingMaterialWorkOrdersByWarehouse_V2032(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<Ots> ots = new List<Ots>();

            using (MySqlConnection connOts = new MySqlConnection(connectionString))
            {
                connOts.Open();

                MySqlCommand otsCommand = new MySqlCommand("WMS_GetPendingMaterialWorkOrdersByWarehouse_V2032", connOts);
                otsCommand.CommandType = CommandType.StoredProcedure;
                otsCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                otsCommand.CommandTimeout = 8000;

                using (MySqlDataReader otReader = otsCommand.ExecuteReader())
                {
                    if (otReader.HasRows)
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = new Ots();
                                ot.IdOT = Convert.ToInt64(otReader["IdOT"]);
                                ot.NumOT = Convert.ToByte(otReader["NumOT"]);

                                if (otReader["OtCode"] != DBNull.Value)
                                {
                                    ot.Code = Convert.ToString(otReader["OtCode"]);
                                    ot.MergeCode = Convert.ToString(otReader["MergeCode"]);
                                }

                                if (otReader["DeliveryDate"] != DBNull.Value)
                                {
                                    ot.DeliveryDate = Convert.ToDateTime(otReader["DeliveryDate"]);
                                    ot.Delay = (int)(ot.DeliveryDate.Value.Date - DateTime.Now.Date).TotalDays;
                                }

                                ot.Quotation = new Quotation();

                                if (otReader["IdQuotation"] != DBNull.Value)
                                {
                                    ot.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                                    ot.Quotation.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                                    ot.Quotation.Code = Convert.ToString(otReader["QuotationCode"]);
                                }

                                if (otReader["IdTemplate"] != DBNull.Value)
                                {
                                    ot.Quotation.IdDetectionsTemplate = Convert.ToByte(otReader["IdTemplate"]);

                                    ot.Quotation.Template = new Template();
                                    ot.Quotation.Template.IdTemplate = ot.Quotation.IdDetectionsTemplate;
                                    ot.Quotation.Template.Name = Convert.ToString(otReader["Template"]);
                                    ot.Quotation.Template.IdTemplate = Convert.ToByte(otReader["TemplateType"]);
                                }

                                if (otReader["IdOffer"] != DBNull.Value)
                                {
                                    ot.Quotation.IdOffer = Convert.ToInt64(otReader["IdOffer"]);
                                    ot.Quotation.Offer = new Offer();
                                    ot.Quotation.Offer.IdOffer = ot.Quotation.IdOffer;

                                    if (otReader["IsCritical"] != DBNull.Value)
                                        ot.Quotation.Offer.IsCritical = Convert.ToByte(otReader["IsCritical"]);

                                    if (otReader["IdStatus"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdStatus = Convert.ToInt64(otReader["IdStatus"]);
                                        ot.Quotation.Offer.GeosStatus = new GeosStatus();
                                        ot.Quotation.Offer.GeosStatus.IdOfferStatusType = Convert.ToInt64(otReader["IdStatus"]);
                                        ot.Quotation.Offer.GeosStatus.Name = Convert.ToString(otReader["OfferStatus"]);
                                        ot.Quotation.Offer.GeosStatus.HtmlColor = Convert.ToString(otReader["OfferStatusHtmlColor"]);

                                        if (otReader["IdSalesStatusType"] != DBNull.Value)
                                        {
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType = new SalesStatusType();
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.IdSalesStatusType = Convert.ToInt64(otReader["IdSalesStatusType"]);
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.Name = Convert.ToString(otReader["SalesStatusType"]);
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.HtmlColor = Convert.ToString(otReader["SalesStatusHtmlColor"]);
                                            if (otReader["SalesStatusIdImage"] != DBNull.Value)
                                                ot.Quotation.Offer.GeosStatus.SalesStatusType.IdImage = Convert.ToInt64(otReader["SalesStatusIdImage"]);
                                        }
                                    }

                                    ot.Quotation.Offer.Code = Convert.ToString(otReader["OfferCode"]);
                                    ot.Quotation.Offer.Description = Convert.ToString(otReader["Description"]);

                                    if (otReader["POCloseDate"] != DBNull.Value)
                                        ot.Quotation.Offer.DeliveryDate = Convert.ToDateTime(otReader["POCloseDate"]);

                                    if (otReader["IdOfferType"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdOfferType = Convert.ToByte(otReader["IdOfferType"]);

                                        ot.Quotation.Offer.OfferType = new OfferType();
                                        ot.Quotation.Offer.OfferType.IdOfferType = Convert.ToByte(ot.Quotation.Offer.IdOfferType);
                                        ot.Quotation.Offer.OfferType.Name = Convert.ToString(otReader["OfferType"]);

                                        //ot.MergeCode = ot.Quotation.Code + " " + ot.Quotation.Offer.OfferType.Name + " " + ot.NumOT;
                                    }

                                    if (otReader["IdCarriageMethod"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdCarriageMethod = Convert.ToByte(otReader["IdCarriageMethod"]);
                                        ot.Quotation.Offer.CarriageMethod = new LookupValue();
                                        ot.Quotation.Offer.CarriageMethod.IdLookupValue = Convert.ToByte(ot.Quotation.Offer.IdCarriageMethod);
                                        ot.Quotation.Offer.CarriageMethod.Value = Convert.ToString(otReader["CarriageMethod"]);

                                        if (otReader["CarriageImage"] != DBNull.Value)
                                            ot.Quotation.Offer.CarriageMethod.IdImage = Convert.ToInt64(otReader["CarriageImage"]);
                                    }
                                }

                                if (otReader["IdWarehouse"] != DBNull.Value)
                                {
                                    ot.Quotation.IdWarehouse = Convert.ToInt64(otReader["IdWarehouse"]);
                                }

                                if (otReader["IdSite"] != DBNull.Value)
                                {
                                    ot.Quotation.IdCustomer = Convert.ToInt32(otReader["IdSite"]);
                                    ot.Quotation.Site = new Company();
                                    ot.Quotation.Site.IdCompany = ot.Quotation.IdCustomer;
                                    ot.Quotation.Site.SiteNameWithoutCountry = Convert.ToString(otReader["SiteName"]);

                                    if (otReader["ShortName"] != DBNull.Value && !string.IsNullOrEmpty(Convert.ToString(otReader["ShortName"])))
                                    {
                                        ot.Quotation.Site.ShortName = Convert.ToString(otReader["ShortName"]);
                                        ot.Quotation.Site.Name = ot.Quotation.Site.ShortName;
                                    }
                                    else
                                    {
                                        ot.Quotation.Site.ShortName = null;
                                        ot.Quotation.Site.Name = Convert.ToString(otReader["SiteName"]);
                                    }

                                    ot.Quotation.Site.Customer = new Customer();
                                    ot.Quotation.Site.Customer.IdCustomer = Convert.ToInt32(otReader["IdCustomer"]);
                                    ot.Quotation.Site.Customer.CustomerName = Convert.ToString(otReader["CustomerName"]);

                                    if (otReader["IdCountry"] != DBNull.Value)
                                    {
                                        ot.Quotation.Site.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country = new Country();
                                        ot.Quotation.Site.Country.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country.Name = Convert.ToString(otReader["CountryName"]);
                                    }
                                }

                                if (otReader["ActualQty"] != DBNull.Value)
                                    ot.ActualQuantity = Convert.ToInt64(otReader["ActualQty"]);

                                if (otReader["DownloadedQty"] != DBNull.Value)
                                    ot.DownloadedQuantity = Convert.ToInt64(otReader["DownloadedQty"]);

                                if (otReader["PODate"] != DBNull.Value)
                                    ot.PoDate = Convert.ToDateTime(otReader["PODate"]);

                                if (otReader["ProducerCountryGroupName"] != DBNull.Value)
                                {
                                    ot.CountryGroup = new CountryGroup();
                                    ot.CountryGroup.Name = otReader["ProducerCountryGroupName"].ToString();
                                    if (otReader["ProducerCountryGroupHTMLColor"] != DBNull.Value)
                                        ot.CountryGroup.HtmlColor = otReader["ProducerCountryGroupHTMLColor"].ToString();
                                }

                                if (otReader["OtItemsCount"] != DBNull.Value)
                                    ot.OtItemCount = Convert.ToInt64(otReader["OtItemsCount"].ToString());

                                ot.RemainingQuantity = ot.ActualQuantity + ot.DownloadedQuantity;
                                if (ot.ActualQuantity > 0)
                                {
                                    ot.Status = (Int16)((Math.Abs(ot.DownloadedQuantity) / ot.ActualQuantity) * 100);
                                }
                                ot.OtItems = new List<OtItem>();
                                ots.Add(ot);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2032() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otItem = new OtItem();
                                    if (otReader["IdOT"] != DBNull.Value)
                                        otItem.IdOT = Convert.ToInt64(otReader["IdOT"]);
                                    if (otReader["IdOtItem"] != DBNull.Value)
                                        otItem.IdOTItem = Convert.ToInt64(otReader["IdOtItem"]);
                                    if (otReader["IdRevisionItem"] != DBNull.Value)
                                    {
                                        otItem.IdRevisionItem = Convert.ToInt64(otReader["IdRevisionItem"]);
                                        otItem.RevisionItem = new RevisionItem();
                                        otItem.RevisionItem.IdRevisionItem = Convert.ToInt64(otReader["IdRevisionItem"]);
                                        otItem.RevisionItem.Quantity = Convert.ToDecimal(otReader["Quantity"]);
                                        if (otReader["DownloadedQty"] != DBNull.Value)
                                            otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otReader["DownloadedQty"]);

                                        if (otReader["RemainingQty"] != DBNull.Value)
                                            otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otReader["RemainingQty"]);
                                    }
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    ot.OtItems.Add(otItem);
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2032() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }


                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(otReader["idotitem"])).FirstOrDefault();

                                    OtItem decomposed = new OtItem();
                                    if (otitem != null)
                                    {
                                        decomposed.IdOT = ot.IdOT;
                                        decomposed.IdOTItem = Convert.ToInt64(otReader["IdOtItem"]);

                                        if (otReader["idParent"] != DBNull.Value)
                                        {
                                            decomposed.ParentId = Convert.ToInt32(otReader["idParent"]);
                                        }
                                        decomposed.RevisionItem = new RevisionItem();
                                        decomposed.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                        decomposed.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otReader["IdWarehouseproduct"]);



                                        if (otReader["IdComponent"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otReader["IdComponent"]);
                                        }
                                        if (decomposed.ParentId == -1)
                                        {
                                            if (otReader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = otitem.RevisionItem.Quantity * Convert.ToDecimal(otReader["Quantity"]);
                                        }
                                        else
                                        {
                                            decimal qty = otitem.ArticleDecomposedList.First(x => x.RevisionItem.WarehouseProduct.IdComponent == decomposed.ParentId).RevisionItem.Quantity;
                                            if (otReader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = qty * Convert.ToDecimal(otReader["Quantity"]);
                                        }

                                        if (otReader["IdArticle"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otReader["IdArticle"]);
                                        }

                                        // int downloaded = GetOtItemDownloadedQuantity(connectionString, decomposed.RevisionItem.WarehouseProduct.IdArticle, decomposed.IdOTItem, decomposed.RevisionItem.WarehouseProduct.IdComponent, Convert.ToInt64(warehouseIds));


                                        decomposed.RevisionItem.DownloadedQuantity = 0;

                                        //  decomposed.RevisionItem.RemainingQuantity = ((Int64)decomposed.RevisionItem.Quantity - downloaded);




                                        otitem.ArticleDecomposedList.Add(decomposed);

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2032() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(otReader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(otReader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(otReader["idarticle"]) && i.RevisionItem.WarehouseProduct.IdComponent == Convert.ToInt64(otReader["idwarehouseproductcomponent"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (otReader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(otReader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2032() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(otReader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(otReader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(otReader["idarticle"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (otReader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(otReader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2032() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }




                    foreach (Ots itemOT in ots)
                    {
                        Int64 downloadedQty = 0;
                        decimal Qty = 0;
                        foreach (OtItem itemOtitem in itemOT.OtItems)
                        {
                            if (itemOtitem.ArticleDecomposedList.Count > 0)
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.DownloadedQuantity));
                                Qty = Qty + itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.Quantity);
                                // ot.Status = (Int16)((Math.Abs(ot.DownloadedQuantity) / ot.ActualQuantity) * 100);

                            }
                            else
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.RevisionItem.DownloadedQuantity);
                                Qty = Qty + itemOtitem.RevisionItem.Quantity;
                            }

                        }
                        if (Qty > 0)
                        {
                            itemOT.Status = (Int16)((Math.Abs(downloadedQty) / Qty) * 100);
                        }
                    }
                }
            }

            ots = ots.Where(x => x.Status < 100).ToList();
            Log4NetLogger.Logger.Log("Executed GetPendingMaterialWorkOrdersByWarehouse_V2032().", category: Category.Info, priority: Priority.Low);
            return ots;
        }

        public List<User> GetAllAdminUsers(string connectionstring)
        {
            List<User> users = new List<User>();
            try
            {
                using (MySqlConnection consite = new MySqlConnection(connectionstring))
                {
                    consite.Open();
                    MySqlCommand consitecommand = new MySqlCommand("WMS_GetAllAdminUsers", consite);
                    consitecommand.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                    {
                        while (sitereader.Read())
                        {
                            User user = new User();
                            user.IdUser = Convert.ToInt32(sitereader["IdUser"].ToString());
                            user.FirstName = sitereader["FirstName"].ToString();
                            user.LastName = sitereader["LastName"].ToString();
                            user.CompanyEmail = sitereader["CompanyEmail"].ToString();
                            users.Add(user);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log("Executed GetAllAdminUsers().", category: Category.Info, priority: Priority.Low);
                throw;
            }
            return users;
        }

        public Notification AddNotification(Notification notification, string mainconnectionstring, string workbenchConnectionString)
        {
            try
            {
                List<User> users = GetAllAdminUsers(workbenchConnectionString);

                foreach (User user in users)
                {
                    //if (user.IdUser != notification.FromUser)   // If same user then no need to add notification.
                    //{
                    using (MySqlConnection concompany = new MySqlConnection(mainconnectionstring))
                    {
                        concompany.Open();
                        using (MySqlTransaction trans = concompany.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand concompanycommand = new MySqlCommand("notifications_Insert", concompany);
                                concompanycommand.CommandType = CommandType.StoredProcedure;

                                concompanycommand.Parameters.AddWithValue("_Time", DateTime.Now);
                                concompanycommand.Parameters.AddWithValue("_FromUser", notification.FromUser);
                                concompanycommand.Parameters.AddWithValue("_ToUser", user.IdUser); // notification.ToUser);
                                concompanycommand.Parameters.AddWithValue("_Message", notification.Message.Trim());
                                concompanycommand.Parameters.AddWithValue("_Title", notification.Title.Trim());
                                concompanycommand.Parameters.AddWithValue("_IdModule", notification.IdModule);
                                concompanycommand.Parameters.AddWithValue("_Status", notification.Status);
                                concompanycommand.Parameters.AddWithValue("_IsNew", notification.IsNew);
                                concompanycommand.Transaction = trans;
                                notification.Id = Convert.ToInt64(concompanycommand.ExecuteScalar());

                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                Log4NetLogger.Logger.Log("Executed AddNotification().", category: Category.Info, priority: Priority.Low);

                                throw;
                            }
                        }
                        //}


                    }
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log("Executed AddNotification().", category: Category.Info, priority: Priority.Low);
                throw;
            }

            return notification;
        }


        public bool AddOTWorkingTime(Warehouses warehouse, OTWorkingTime otWorkingTime)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            bool isAdded = false;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_InsertOTWorkingTime", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdOT", otWorkingTime.IdOT);
                        mySqlCommand.Parameters.AddWithValue("_IdOperator", otWorkingTime.IdOperator);
                        mySqlCommand.Parameters.AddWithValue("_IdStage", otWorkingTime.IdStage);
                        mySqlCommand.Parameters.AddWithValue("_StartDate", DateTime.Now);
                        mySqlCommand.Parameters.AddWithValue("_EndDate", DateTime.Now);

                        mySqlCommand.ExecuteNonQuery();
                        isAdded = true;
                        mySqlConnection.Close();
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isAdded = false;
                throw;
            }

            return isAdded;
        }

        public TimeSpan GetOTTotalWorkingTime(Int64 idOT, byte idStage, Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            TimeSpan totalTimeDiff = new TimeSpan();
            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetOTTotalWorkingTime", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdOT", idOT);
                    mySqlCommand.Parameters.AddWithValue("_IdStage", idStage);
                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        if (reader.Read())
                        {
                            if (reader["TotalTimeDiff"] != DBNull.Value)
                                totalTimeDiff = (TimeSpan)reader["TotalTimeDiff"];
                        }

                    }
                    mySqlConnection.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetOTTotalWorkingTime(IdOT-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOT, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return totalTimeDiff;
        }


        public WarehouseDeliveryNote GetLabelPrintDetails_V2032(string connectionString, Int32 IdArticle, Int64 IdWarehouse, Int64 IdWarehouseDeliveryNote)
        {
            WarehouseDeliveryNote warehouseDeliveryNote = new WarehouseDeliveryNote();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("warehousedeliverynotes_GetLabelPrintDetails_V2032", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouseDeliveryNote", IdWarehouseDeliveryNote);
                mySqlCommand.Parameters.AddWithValue("_IdArticle", IdArticle);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", IdWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                            warehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["idWarehouseDeliveryNote"]);

                        if (reader["DeliveryDate"] != DBNull.Value)
                            warehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);

                        warehouseDeliveryNote.WarehousePurchaseOrder = new WarehousePurchaseOrder();

                        if (reader["IdWarehouse"] != DBNull.Value)
                            warehouseDeliveryNote.WarehousePurchaseOrder.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                        if (reader["IdArticleSupplier"] != DBNull.Value)
                        {
                            warehouseDeliveryNote.WarehousePurchaseOrder.IdArticleSupplier = Convert.ToInt64(reader["IdArticleSupplier"]);
                            warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier = new ArticleSupplier();
                            warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.IdArticleSupplier = Convert.ToInt64(reader["IdArticleSupplier"]);
                            warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Name = Convert.ToString(reader["Supplier"]);
                            if (reader["SuppCountryGroup"] != DBNull.Value)
                            {
                                warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Country = new Country();
                                warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Country.CountryGroup = new CountryGroup();
                                warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Country.CountryGroup.Name = Convert.ToString(reader["SuppCountryGroup"]);
                            }
                        }

                        warehouseDeliveryNote.WarehouseDeliveryNoteItems = new List<WarehouseDeliveryNoteItem>();
                        WarehouseDeliveryNoteItem WarehouseDeliveryNoteItem = new WarehouseDeliveryNoteItem();
                        if (reader["IdManufacturerByArticle"] != DBNull.Value)
                        {
                            WarehouseDeliveryNoteItem.IdManufacturerByArticle = Convert.ToInt64(reader["IdManufacturerByArticle"]);
                            WarehouseDeliveryNoteItem.ManufacturersByArticle = new List<ManufacturersByArticle>();
                            ManufacturersByArticle ManufacturersByArticle = new ManufacturersByArticle();
                            if (reader["CountryName"] != DBNull.Value)
                            {
                                ManufacturersByArticle.Country = new Country();
                                ManufacturersByArticle.Country.Name = Convert.ToString(reader["CountryName"]);
                                if (reader["CountryGroup"] != DBNull.Value)
                                {
                                    ManufacturersByArticle.Country.CountryGroup = new CountryGroup();
                                    ManufacturersByArticle.Country.CountryGroup.Name = Convert.ToString(reader["CountryGroup"]);
                                    if (reader["IsFreeTrade"] != DBNull.Value)
                                        ManufacturersByArticle.Country.CountryGroup.IsFreeTrade = Convert.ToByte(reader["IsFreeTrade"]);
                                }

                            }
                            if (reader["Manufacturer"] != DBNull.Value)
                            {
                                ManufacturersByArticle.Manufacturer = new Manufacturer();
                                ManufacturersByArticle.Manufacturer.Name = Convert.ToString(reader["Manufacturer"]);
                            }
                            WarehouseDeliveryNoteItem.ManufacturersByArticle.Add(ManufacturersByArticle);


                        }
                        warehouseDeliveryNote.WarehouseDeliveryNoteItems.Add(WarehouseDeliveryNoteItem);



                    }
                }
            }

            return warehouseDeliveryNote;
        }

        public Article GetArticleDetailsByReference_V2033(string reference, string articleVisualAidsPath, Warehouses warehouse, DateTime? fromDate = null, DateTime? toDate = null)
        {
            Article article = new Article();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("article_GetArticleDetailsByReference", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_Reference", reference);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 8000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        try
                        {
                            if (reader["idArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(reader["idArticle"]);

                            if (reader["IdArticleCategory"] != DBNull.Value)
                            {
                                article.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory = new ArticleCategory();
                                article.ArticleCategory.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory.Name = Convert.ToString(reader["categoryName"]);
                                article.ArticleCategory.TaricCode = Convert.ToString(reader["TaricCode"]);
                            }

                            if (reader["ImagePath"] != DBNull.Value)
                            {
                                article.ImagePath = Convert.ToString(reader["ImagePath"]);

                                if (!string.IsNullOrEmpty(article.ImagePath))
                                    article.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, article);
                            }

                            if (reader["Reference"] != DBNull.Value)
                                article.Reference = reader["Reference"].ToString();

                            if (reader["IsOrientativeVisualAid"] != DBNull.Value)
                                article.IsOrientativeVisualAid = Convert.ToByte(reader["IsOrientativeVisualAid"]);

                            if (reader["IsGeneric"] != DBNull.Value)
                                article.IsGeneric = Convert.ToSByte(reader["IsGeneric"]);

                            if (reader["isObsolete"] != DBNull.Value)
                                article.IsObsolete = Convert.ToSByte(reader["isObsolete"]);

                            if (reader["isPublic"] != DBNull.Value)
                                article.IsPublic = Convert.ToSByte(reader["isPublic"]);

                            if (reader["publishOnWeb"] != DBNull.Value)
                                article.PublishOnWeb = Convert.ToSByte(reader["publishOnWeb"]);

                            if (reader["registerSerialNumber"] != DBNull.Value)
                                article.RegisterSerialNumber = Convert.ToByte(reader["registerSerialNumber"]);

                            if (reader["CreatedIn"] != DBNull.Value)
                                article.CreatedIn = Convert.ToDateTime(reader["CreatedIn"]);

                            if (reader["ModifiedIn"] != DBNull.Value)
                                article.ModifiedIn = Convert.ToDateTime(reader["ModifiedIn"]);

                            if (reader["description"] != DBNull.Value)
                                article.Description = Convert.ToString(reader["description"]);

                            if (reader["description_es"] != DBNull.Value)
                                article.Description_es = Convert.ToString(reader["description_es"]);

                            if (reader["description_fr"] != DBNull.Value)
                                article.Description_fr = Convert.ToString(reader["description_fr"]);

                            if (reader["description_pt"] != DBNull.Value)
                                article.Description_pt = Convert.ToString(reader["description_pt"]);

                            if (reader["description_ro"] != DBNull.Value)
                                article.Description_ro = Convert.ToString(reader["description_ro"]);

                            if (reader["description_ru"] != DBNull.Value)
                                article.Description_ru = Convert.ToString(reader["description_ru"]);

                            if (reader["description_zh"] != DBNull.Value)
                                article.Description_zh = Convert.ToString(reader["description_zh"]);

                            if (reader["idReplacementArticle"] != DBNull.Value)
                            {
                                article.IdReplacementArticle = Convert.ToInt32(reader["idReplacementArticle"]);
                                article.ReplacementArticle = Convert.ToString(reader["ReplacementArticle"]);
                            }

                            if (reader["isBatch"] != DBNull.Value)
                                article.IsBatch = Convert.ToByte(reader["isBatch"]);

                            if (reader["taric"] != DBNull.Value)
                                article.Taric = Convert.ToString(reader["taric"]);

                            if (reader["IdArticleType"] != DBNull.Value)
                            {
                                article.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                article.ArticlesType = new ArticleType();
                                article.ArticlesType.IdArticleType = Convert.ToInt64(reader["IdArticleType"]); ;
                            }


                            if (reader["Weight"] != DBNull.Value)
                                article.Weight = Convert.ToDecimal(reader["Weight"]);

                            if (reader["Width"] != DBNull.Value)
                                article.Width = (float)(reader["Width"]);

                            if (reader["Length"] != DBNull.Value)
                                article.Length = (float)(reader["Length"]);

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)(reader["Height"]);

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)(reader["Height"]);

                            if (reader["idCountry"] != DBNull.Value)
                            {
                                article.IdCountry = Convert.ToInt32(reader["idCountry"]);

                                article.Country = new Country();
                                article.Country.IdCountry = Convert.ToByte(reader["idCountry"]);
                                article.Country.Name = Convert.ToString(reader["CountryName"]);
                            }

                            article.MyWarehouse = new MyWarehouse();

                            if (reader["minimumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MinimumStock = Convert.ToInt64(reader["minimumStock"]);
                            }

                            if (reader["stock"] != DBNull.Value)
                            {
                                article.MyWarehouse.CurrentStock = Convert.ToInt64(reader["stock"]);
                            }

                            if (reader["maximumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MaximumStock = Convert.ToInt64(reader["maximumStock"]);
                            }

                            if (reader["idWareHouse"] != DBNull.Value)
                            {
                                article.MyWarehouse.IdWarehouse = Convert.ToInt64(reader["idWareHouse"]);
                            }

                            if (reader["location"] != DBNull.Value)
                            {
                                article.MyWarehouse.Location = Convert.ToString(reader["location"]);
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleDetailsByIdArticle(). Reference- {0} IdArticle-{1} ErrorMessage- {2}", reference, article.IdArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
                article.LstArticleBySupplier = new List<ArticleBySupplier>();
                article.LstArticleBySupplier = GetArticleSupplierDetailsByIdArticle(connectionString, article.IdArticle);

                article.LstArticleDecomposition = new List<ArticleDecomposition>();
                article.LstArticleDecomposition = GetArticleDeCompostionByIdArticle(connectionString, article.IdArticle);

                article.LstRelatedArticle = new List<RelatedArticle>();
                article.LstRelatedArticle = GetRelatedArticleDetailsByIdArticle(connectionString, article.IdArticle, warehouse.IdWarehouse);

                article.LstArticleDocument = new List<ArticleDocument>();
                article.LstArticleDocument = GetArticleAttachmentByIdArticle(connectionString, article.IdArticle);

                article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle_V2030(connectionString, article.IdArticle, warehouse.IdWarehouse);

                article.LstManufacturersByArticles = new List<ManufacturersByArticle>();
                article.LstManufacturersByArticles = GetManufacturers(connectionString, article.IdArticle);

                //if (fromDate != null && toDate != null)
                //{
                article.LstArticlesStock = new List<ArticlesStock>();
                article.LstArticlesStock = GetStockHistoryByIdArticle_V2033(connectionString, article.IdArticle, DateTime.Now, DateTime.Now, warehouse.IdWarehouse);
                // }


                article.LstArticleForecast = new List<ArticleForecast>();
                article.LstArticleForecast = GetArticleForecast(connectionString, article.IdArticle, warehouse.IdWarehouse);

            }

            return article;
        }


        public List<ArticleForecast> GetArticleForecast(string connectionString, Int32 idArticle, Int64 idWarehouse)
        {
            List<ArticleForecast> articleForecasts = new List<ArticleForecast>();


            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetArticleForecast", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdArticle", idArticle);
                command.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                command.CommandTimeout = 8000;
                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            ArticleForecast articleForecast = new ArticleForecast();


                            articleForecast.Type = "OT";
                            if (reader["IdOT"] != DBNull.Value)
                                articleForecast.Id = Convert.ToInt64(reader["IdOT"]);

                            if (reader["Customer"] != DBNull.Value)
                                articleForecast.CustomerORSupplier = Convert.ToString(reader["Customer"]);
                            if (reader["OTCode"] != DBNull.Value)
                                articleForecast.Code = Convert.ToString(reader["OTCode"]);
                            if (reader["DeliveryDate"] != DBNull.Value)
                                articleForecast.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                            if (reader["RemainingQty"] != DBNull.Value)
                                articleForecast.Quantity = Convert.ToInt64(reader["RemainingQty"]);



                            articleForecasts.Add(articleForecast);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleForecast(idArticle-{0}). ErrorMessage- {1}", idArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                ArticleForecast articleForecast = new ArticleForecast();


                                articleForecast.Type = "PO";

                                if (reader["IdWarehousePurchaseOrder"] != DBNull.Value)
                                    articleForecast.Id = Convert.ToInt64(reader["IdWarehousePurchaseOrder"]);

                                if (reader["Supplier"] != DBNull.Value)
                                    articleForecast.CustomerORSupplier = Convert.ToString(reader["Supplier"]);
                                if (reader["POCode"] != DBNull.Value)
                                    articleForecast.Code = Convert.ToString(reader["POCode"]);
                                if (reader["DeliveryDate"] != DBNull.Value)
                                    articleForecast.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                if (reader["RemainingQty"] != DBNull.Value)
                                    articleForecast.Quantity = Convert.ToInt64(reader["RemainingQty"]);

                                articleForecasts.Add(articleForecast);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetArticleForecast(idArticle-{0}). ErrorMessage- {1}", idArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return articleForecasts.OrderBy(i => i.DeliveryDate).ToList();
        }

        public List<ArticlesStock> GetStockHistoryByIdArticle_V2033(string connectionString, Int32 idArticle, DateTime fromDate, DateTime toDate, Int64 idWarehouse)
        {
            List<ArticlesStock> articlesStocks = new List<ArticlesStock>();


            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("articlesstock_GetStockHistoryByIdArticle_V2033", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdArticle", idArticle);
                command.Parameters.AddWithValue("_FromDate", fromDate);
                command.Parameters.AddWithValue("_ToDate", toDate);
                command.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                command.CommandTimeout = 8000;
                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            ArticlesStock articlesStock = new ArticlesStock();

                            if (reader["IdArticleStock"] != DBNull.Value)
                                articlesStock.IdArticleStock = Convert.ToUInt64(reader["IdArticleStock"]);
                            if (reader["quantity"] != DBNull.Value)
                                articlesStock.Quantity = Convert.ToInt64(reader["quantity"]);
                            if (reader["price"] != DBNull.Value)
                                articlesStock.Price = Convert.ToDouble(reader["price"]);
                            if (reader["uploadedIn"] != DBNull.Value)
                                articlesStock.UploadedIn = Convert.ToDateTime(reader["uploadedIn"]);
                            if (reader["comments"] != DBNull.Value)
                                articlesStock.Comments = Convert.ToString(reader["comments"]);
                            if (reader["isDamaged"] != DBNull.Value)
                                articlesStock.IsDamaged = Convert.ToByte(reader["isDamaged"]);
                            articlesStock.PeopleModifiedBy = new People();
                            if (reader["FirstName"] != DBNull.Value)
                                articlesStock.PeopleModifiedBy.Name = Convert.ToString(reader["FirstName"]);
                            if (reader["LastName"] != DBNull.Value)
                                articlesStock.PeopleModifiedBy.Surname = Convert.ToString(reader["LastName"]);

                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                articlesStock.WarehouseLocation = new WarehouseLocation();
                                articlesStock.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);
                                articlesStock.WarehouseLocation.FullName = Convert.ToString(reader["Location"]);
                            }
                            if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            {
                                articlesStock.IdWarehouseDeliveryNoteItem = Convert.ToUInt64(reader["IdWarehouseDeliveryNoteItem"]);
                                articlesStock.WarehouseDeliveryNoteItem = new WarehouseDeliveryNoteItem();
                                articlesStock.WarehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem = Convert.ToInt64(reader["IdWarehouseDeliveryNoteItem"]);
                                if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                                {
                                    articlesStock.WarehouseDeliveryNoteItem.IdWarehouseDeliveryNote = Convert.ToInt64(reader["idWarehouseDeliveryNote"]);
                                    articlesStock.WarehouseDeliveryNoteItem.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                    articlesStock.WarehouseDeliveryNoteItem.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["idWarehouseDeliveryNote"]);
                                    articlesStock.WarehouseDeliveryNoteItem.WarehouseDeliveryNote.Code = Convert.ToString(reader["DeliveryNote"]);
                                }

                            }


                            articlesStocks.Add(articlesStock);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetStockHistoryByIdArticle_V2033(idArticle-{0}). ErrorMessage- {1}", idArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return articlesStocks;
        }


        public bool UpdateGeosAppSetting(string mainServerConnectionString, Int32 idAppSetting, bool isON, Int64 idWarehouse, string workbenchConnectionString)
        {
            bool isUpdated = false;
            List<GeosAppSetting> lstappsettings = new List<GeosAppSetting>();
            List<string> strLst = new List<string>();
            UserManager usrmgr = new UserManager();
            lstappsettings = usrmgr.GetSelectedGeosAppSettings(workbenchConnectionString, idAppSetting.ToString());
            if (isON)
            {
                string[] strArray = lstappsettings.FirstOrDefault().DefaultValue.Split(',');
                strLst = strArray.ToList();
                if (!strLst.Any(i => i == idWarehouse.ToString()))
                    strLst.Add(idWarehouse.ToString());
            }
            else
            {
                string[] strArray = lstappsettings.FirstOrDefault().DefaultValue.Split(',');
                strLst = strArray.ToList();
                if (strLst.Any(i => i == idWarehouse.ToString()))
                    strLst.Remove(idWarehouse.ToString());
            }


            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("geos_app_setting_update", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_idAppSetting", idAppSetting);
                        mySqlCommand.Parameters.AddWithValue("_DefaultValue", string.Join(",", strLst.ToArray()));

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                        isUpdated = true;
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();

                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error UpdateGeosAppSetting(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                    isUpdated = false;
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return isUpdated;
        }


        public List<ArticleWarehouseLocations> GetArticlesWarehouseLocationTransfer_V2033(string IdArticles, Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<ArticleWarehouseLocations> articleWarehouseLocationsList = new List<ArticleWarehouseLocations>();

            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetArticlesLocationTransfer_V2033", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", IdArticles);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {
                    while (articlesReader.Read())
                    {
                        try
                        {
                            ArticleWarehouseLocations articleWarehouseLocations = new ArticleWarehouseLocations();

                            if (articlesReader["IdArticle"] != DBNull.Value)
                                articleWarehouseLocations.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                articleWarehouseLocations.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                articleWarehouseLocations.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdArticleWarehouseLocation"] != DBNull.Value)
                                articleWarehouseLocations.IdArticleWarehouseLocation = Convert.ToInt64(articlesReader["IdArticleWarehouseLocation"]);

                            if (articlesReader["Parent"] != DBNull.Value)
                                articleWarehouseLocations.Parent = Convert.ToInt64(articlesReader["Parent"]);

                            if (articlesReader["Position"] != DBNull.Value)
                                articleWarehouseLocations.Position = Convert.ToInt64(articlesReader["Position"]);

                            if (articlesReader["Name"] != DBNull.Value)
                                articleWarehouseLocations.Name = articlesReader["Name"].ToString();

                            if (articlesReader["FullName"] != DBNull.Value)
                                articleWarehouseLocations.FullName = articlesReader["FullName"].ToString();

                            if (articlesReader["MinimumStock"] != DBNull.Value)
                                articleWarehouseLocations.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                            if (articlesReader["MaximumStock"] != DBNull.Value)
                                articleWarehouseLocations.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                articleWarehouseLocations.WarehouseLocation = new WarehouseLocation();

                                articleWarehouseLocations.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);
                                if (articlesReader["IdWarehouse"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);
                                if (articlesReader["Name"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Name = Convert.ToString(articlesReader["Name"]);
                                if (articlesReader["Parent"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Parent = Convert.ToInt64(articlesReader["Parent"]);
                                if (articlesReader["Position"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Position = Convert.ToInt64(articlesReader["Position"]);
                                if (articlesReader["FullName"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.FullName = Convert.ToString(articlesReader["FullName"]);
                                if (articlesReader["FileName"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);
                                if (articlesReader["Latitude"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                                if (articlesReader["Longitude"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                                if (articlesReader["Height"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                                if (articlesReader["Width"] != DBNull.Value)
                                    articleWarehouseLocations.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);
                            }

                            articleWarehouseLocationsList.Add(articleWarehouseLocations);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticlesWarehouseLocationTransfer_V2033(IdArticle-{0} . ErrorMessage- {1}", IdArticles, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }

            }
            return articleWarehouseLocationsList;

        }


        public bool IsOUTSupplierComplaintItem(Int64 IdSupplierComplaint, Warehouses warehouse)
        {
            bool isOut = false;
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetAllSupplierComplaintItem", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdSupplierComplaint", IdSupplierComplaint);

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {

                            if (reader["ReplacementType"] != DBNull.Value)
                            {
                                if (Convert.ToSByte(reader["ReplacementType"]) == 1)
                                {
                                    isOut = true;
                                }
                                else
                                {
                                    isOut = false;
                                    break;
                                }
                            }
                            else
                            {
                                isOut = false;
                                break;
                            }

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error IsOUTSupplierComplaintItem(IdSupplierComplaint-{0} . ErrorMessage- {1}", IdSupplierComplaint, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }

            }
            return isOut;

        }


        public bool IsClosedSupplierComplaint(Int64 IdSupplierComplaint, Warehouses Warehouse)
        {
            bool isClosed = false;
            string connectionString = Warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_IsClosedSupplierComplaint", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdSupplierComplaint", IdSupplierComplaint);
                command.Parameters.AddWithValue("_IdWarehouse", Warehouse.IdWarehouse);

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {

                            if (reader["RemainingStock"] != DBNull.Value)
                            {
                                if (Convert.ToInt64(reader["RemainingStock"]) == 0)
                                {
                                    isClosed = true;
                                }
                                else
                                {
                                    isClosed = false;
                                    break;
                                }
                            }
                            else
                            {
                                isClosed = false;
                                break;
                            }

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error IsClosedSupplierComplaint(IdSupplierComplaint-{0} . ErrorMessage- {1}", IdSupplierComplaint, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }

            }
            return isClosed;

        }


        public bool UpdateSupplierComplaint(Int64 idSupplierComplaint, Warehouses warehouse)
        {
            bool isUpdated = false;
            bool isClosed = false;
            string connectionString = warehouse.Company.ConnectPlantConstr;
            isClosed = IsClosedSupplierComplaint(idSupplierComplaint, warehouse);
            if (isClosed)
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    try
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("WMS_UpdateSupplierComplaint", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;
                            mySqlCommand.Parameters.AddWithValue("_IdSupplierComplaint", idSupplierComplaint);

                            mySqlCommand.ExecuteNonQuery();
                            mySqlConnection.Close();
                            isUpdated = true;
                        }

                        transactionScope.Complete();
                        transactionScope.Dispose();

                    }
                    catch (Exception ex)
                    {
                        Log4NetLogger.Logger.Log(string.Format("Error UpdateSupplierComplaint(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                        isUpdated = false;
                        if (Transaction.Current != null)
                            Transaction.Current.Rollback();

                        if (transactionScope != null)
                            transactionScope.Dispose();

                        throw;
                    }
                }
            }

            return isUpdated;
        }


        public List<PlanningSimulator> GetPlanningSimulator(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<PlanningSimulator> planningSimulatorList = new List<PlanningSimulator>();
            List<Int32> LstIdArticles = new List<Int32>();
            List<CurrentArticleStock> articleStockLst = new List<CurrentArticleStock>();
            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetPlanningSimulator", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.CommandTimeout = 8000;
                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    // for parent otitems and decomposed articles
                    while (reader.Read())
                    {
                        try
                        {
                            PlanningSimulator planningSimulator = new PlanningSimulator();

                            if (reader["IdArticle"] != DBNull.Value)
                                planningSimulator.IdArticle = Convert.ToInt32(reader["IdArticle"]);


                            if (reader["Reference"] != DBNull.Value)
                                planningSimulator.Reference = Convert.ToString(reader["Reference"]);

                            if (reader["IdOT"] != DBNull.Value)
                                planningSimulator.IdOT = Convert.ToInt64(reader["IdOT"]);

                            if (reader["OTCode"] != DBNull.Value)
                                planningSimulator.OTCode = Convert.ToString(reader["OTCode"]);

                            if (reader["Customer"] != DBNull.Value)
                                planningSimulator.Customer = Convert.ToString(reader["Customer"]);

                            if (reader["OTWeek"] != DBNull.Value)
                                planningSimulator.Week = Convert.ToString(reader["OTWeek"]);

                            if (reader["DeliveryDate"] != DBNull.Value)
                                planningSimulator.OTDeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);

                            if (reader["DownloadedQty"] != DBNull.Value)
                                planningSimulator.DownloadedQty = Convert.ToInt64(reader["DownloadedQty"]);

                            if (reader["ActualQty"] != DBNull.Value)
                                planningSimulator.ActualQty = Convert.ToInt64(reader["ActualQty"]);

                            if (reader["RemainingQty"] != DBNull.Value)
                                planningSimulator.OTRemainingQty = Convert.ToInt64(reader["RemainingQty"]);

                            planningSimulator.IsOut = true;

                            planningSimulatorList.Add(planningSimulator);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPlanningSimulator ErrorMessage- ", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                    // for order
                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                PlanningSimulator planningSimulator = new PlanningSimulator();

                                if (reader["IdArticle"] != DBNull.Value)
                                    planningSimulator.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                if (reader["Reference"] != DBNull.Value)
                                    planningSimulator.Reference = Convert.ToString(reader["Reference"]);

                                if (reader["IdWarehousePurchaseOrder"] != DBNull.Value)
                                    planningSimulator.IdWarehousePurchaseOrder = Convert.ToInt64(reader["IdWarehousePurchaseOrder"]);

                                if (reader["POCode"] != DBNull.Value)
                                    planningSimulator.POCode = Convert.ToString(reader["POCode"]);

                                if (reader["Supplier"] != DBNull.Value)
                                    planningSimulator.Supplier = Convert.ToString(reader["Supplier"]);

                                if (reader["POWeek"] != DBNull.Value)
                                    planningSimulator.Week = Convert.ToString(reader["POWeek"]);

                                if (reader["DeliveryDate"] != DBNull.Value)
                                    planningSimulator.PODeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);

                                if (reader["OrderQty"] != DBNull.Value)
                                    planningSimulator.OrderQty = Convert.ToInt64(reader["OrderQty"]);

                                if (reader["ReceivedQuantity"] != DBNull.Value)
                                    planningSimulator.ReceivedQuantity = Convert.ToInt64(reader["ReceivedQuantity"]);

                                if (reader["RemainingQty"] != DBNull.Value)
                                    planningSimulator.PORemainingQty = Convert.ToInt64(reader["RemainingQty"]);


                                planningSimulator.IsOut = false;

                                planningSimulatorList.Add(planningSimulator);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPlanningSimulator ErrorMessage- ", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                    // for articlestock IdWarehouseLocation is not null
                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                if (reader["IdArticle"] != DBNull.Value)
                                {
                                    CurrentArticleStock currentArticleStock = new CurrentArticleStock();

                                    currentArticleStock.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                    currentArticleStock.ArticleStock = Convert.ToInt64(reader["ArticlesStockQty"]);


                                    articleStockLst.Add(currentArticleStock);
                                }

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPlanningSimulator ErrorMessage- ", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    // for articlestock IdWarehouseLocation is null
                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                if (reader["IdArticle"] != DBNull.Value)
                                {
                                    if (articleStockLst.Any(i => i.IdArticle == Convert.ToInt32(reader["IdArticle"])))
                                    {
                                        CurrentArticleStock currentArticleStock = articleStockLst.Where(i => i.IdArticle == Convert.ToInt32(reader["IdArticle"])).FirstOrDefault();
                                        currentArticleStock.ArticleStock = currentArticleStock.ArticleStock + Convert.ToInt64(reader["ArticlesStockQty"]);

                                    }
                                    else
                                    {
                                        CurrentArticleStock currentArticleStock = new CurrentArticleStock();

                                        currentArticleStock.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                        currentArticleStock.ArticleStock = Convert.ToInt64(reader["ArticlesStockQty"]);


                                        articleStockLst.Add(currentArticleStock);
                                    }

                                }

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPlanningSimulator ErrorMessage- ", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                }
            }

            Int64 expectedStock = 0;
            planningSimulatorList = planningSimulatorList.OrderBy(ob => ob.IdArticle).ThenBy(tb => (tb.OTDeliveryDate == null) ? tb.PODeliveryDate : tb.OTDeliveryDate).ThenBy(tb => (tb.PODeliveryDate == null) ? tb.OTDeliveryDate : tb.PODeliveryDate).ToList();
            Int64 rowPointer = 0;
            foreach (PlanningSimulator itemPlanningSimulator in planningSimulatorList)
            {
                rowPointer = rowPointer + 1;
                itemPlanningSimulator.RowPointer = rowPointer;
                if (LstIdArticles.Any(i => i == itemPlanningSimulator.IdArticle))
                {
                    if (itemPlanningSimulator.IsOut)
                    {
                        if (planningSimulatorList.Any(i => i.IdArticle == itemPlanningSimulator.IdArticle && i.RowPointer == itemPlanningSimulator.RowPointer - 1 && i.IsOut == true))
                        {
                            PlanningSimulator planningSimulator = planningSimulatorList.Where(i => i.IdArticle == itemPlanningSimulator.IdArticle && i.RowPointer == itemPlanningSimulator.RowPointer - 1 && i.IsOut == true).FirstOrDefault();
                            planningSimulator.NextOtItemPickingStock = itemPlanningSimulator.OTRemainingQty.Value;
                        }

                        itemPlanningSimulator.CurrentArticleStock = expectedStock;
                        expectedStock = expectedStock - itemPlanningSimulator.OTRemainingQty.Value;
                    }
                    else
                    {
                        itemPlanningSimulator.CurrentArticleStock = expectedStock;
                        expectedStock = expectedStock + itemPlanningSimulator.PORemainingQty.Value;
                    }
                }
                else
                {
                    LstIdArticles.Add(itemPlanningSimulator.IdArticle);
                    if (articleStockLst.Any(i => i.IdArticle == itemPlanningSimulator.IdArticle))
                    {
                        expectedStock = articleStockLst.Where(i => i.IdArticle == itemPlanningSimulator.IdArticle).FirstOrDefault().ArticleStock;
                    }
                    else
                    {
                        expectedStock = 0;
                    }

                    if (itemPlanningSimulator.IsOut)
                    {
                        if (planningSimulatorList.Any(i => i.IdArticle == itemPlanningSimulator.IdArticle && i.RowPointer == itemPlanningSimulator.RowPointer - 1 && i.IsOut == true))
                        {
                            PlanningSimulator planningSimulator = planningSimulatorList.Where(i => i.IdArticle == itemPlanningSimulator.IdArticle && i.RowPointer == itemPlanningSimulator.RowPointer - 1 && i.IsOut == true).FirstOrDefault();
                            planningSimulator.NextOtItemPickingStock = itemPlanningSimulator.OTRemainingQty.Value;
                        }
                        itemPlanningSimulator.CurrentArticleStock = expectedStock;
                        expectedStock = expectedStock - itemPlanningSimulator.OTRemainingQty.Value;
                    }
                    else
                    {
                        itemPlanningSimulator.CurrentArticleStock = expectedStock;
                        expectedStock = expectedStock + itemPlanningSimulator.PORemainingQty.Value;
                    }

                }
                itemPlanningSimulator.ExpectedStock = expectedStock;
            }

            return planningSimulatorList;

        }


        public List<Article> GetPendingArticles_V2033(Warehouses warehouse)
        {
            List<Article> articles = new List<Article>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection connArticles = new MySqlConnection(connectionString))
            {
                connArticles.Open();

                MySqlCommand articleCommand = new MySqlCommand("warehouse_GetPendingArticles_V2033", connArticles);
                articleCommand.CommandType = CommandType.StoredProcedure;
                articleCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader articleReader = articleCommand.ExecuteReader())
                {
                    while (articleReader.Read())
                    {
                        try
                        {
                            Article article = new Article();

                            if (articleReader["IdArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(articleReader["IdArticle"]);

                            if (articleReader["Reference"] != DBNull.Value)
                                article.Reference = Convert.ToString(articleReader["Reference"]);

                            if (articleReader["Description"] != DBNull.Value)
                                article.Description = Convert.ToString(articleReader["Description"]);

                            WarehousePurchaseOrder warehousePO = new WarehousePurchaseOrder();

                            warehousePO.IdWarehousePurchaseOrder = Convert.ToInt64(articleReader["IdWarehousePurchaseOrder"]);

                            if (articleReader["PurchaseOrderCode"] != DBNull.Value)
                                warehousePO.Code = Convert.ToString(articleReader["PurchaseOrderCode"]);

                            if (articleReader["WO_DeliveryDate"] != DBNull.Value)
                                warehousePO.DeliveryDate = Convert.ToDateTime(articleReader["WO_DeliveryDate"]);

                            if (articleReader["WO_Supplier"] != DBNull.Value)
                            {
                                warehousePO.ArticleSupplier = new ArticleSupplier();
                                warehousePO.ArticleSupplier.Name = Convert.ToString(articleReader["WO_Supplier"]);
                            }

                            if (articleReader["RemainingQty"] != DBNull.Value)
                                article.Quantity = Convert.ToDouble(articleReader["RemainingQty"]);

                            if (articleReader["IdWarehouse"] != DBNull.Value)
                                warehousePO.IdWarehouse = Convert.ToInt64(articleReader["IdWarehouse"]);

                            article.WarehousePurchaseOrder = warehousePO;

                            articles.Add(article);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPendingArticles_V2033(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetPendingArticles_V2033().", category: Category.Info, priority: Priority.Low);
            return articles;
        }


        public List<OtItem> GetPendingMaterialArticles_V2033(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OtItem> otItems = new List<OtItem>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetPendingMaterialArticles_V2033", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OtItem otItem = new OtItem();
                                if (reader["IdOTItem"] != DBNull.Value)
                                {
                                    otItem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                                    if (reader["IdOT"] != DBNull.Value)
                                        otItem.IdOT = Convert.ToInt64(reader["IdOT"]);

                                    otItem.RevisionItem = new RevisionItem();

                                    if (reader["ActualQty"] != DBNull.Value)
                                        otItem.RevisionItem.Quantity = Convert.ToInt64(reader["ActualQty"]);

                                    if (reader["DownloadedQty"] != DBNull.Value)
                                        otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(reader["DownloadedQty"]);

                                    if (reader["RemainingQty"] != DBNull.Value)
                                        otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(reader["RemainingQty"]);

                                    if (reader["IdArticle"] != DBNull.Value)
                                    {
                                        otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                        otItem.RevisionItem.WarehouseProduct.Article = new Article();
                                        otItem.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                        otItem.RevisionItem.WarehouseProduct.Article.Reference = Convert.ToString(reader["Reference"]);
                                        otItem.RevisionItem.WarehouseProduct.Article.Description = Convert.ToString(reader["Description"]);
                                    }

                                    otItem.Ot = new Ots();
                                    if (reader["MergeCode"] != DBNull.Value)
                                        otItem.Ot.Code = Convert.ToString(reader["MergeCode"]);

                                    if (reader["IdSite"] != DBNull.Value)
                                    {
                                        otItem.Ot.Quotation = new Quotation();

                                        otItem.Ot.Quotation.Site = new Company();
                                        otItem.Ot.Quotation.Site.Name = Convert.ToString(reader["SiteName"]);

                                        otItem.Ot.Quotation.Site.Country = new Country();
                                        otItem.Ot.Quotation.Site.Country.Name = Convert.ToString(reader["Country"]);

                                        otItem.Ot.Quotation.Site.Customer = new Customer();
                                        otItem.Ot.Quotation.Site.Customer.CustomerName = Convert.ToString(reader["CustomerGroup"]);

                                        otItem.Ot.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                    }

                                }

                                otItems.Add(otItem);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialArticles_V2033() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return otItems;
        }


        public List<OrderProcessing> GetOrderInProcessing(Warehouses warehouse, string userProfileImageFilePath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OrderProcessing> orderProcessings = new List<OrderProcessing>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetOrderInProcessing", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OrderProcessing orderProcessing = new OrderProcessing();
                                if (reader["idoffer"] != DBNull.Value)
                                    orderProcessing.IdOffer = Convert.ToInt64(reader["idoffer"]);

                                if (reader["IdStatus"] != DBNull.Value)
                                    orderProcessing.IdStatus = Convert.ToInt64(reader["IdStatus"]);

                                if (reader["StatusColor"] != DBNull.Value)
                                    orderProcessing.StatusColor = Convert.ToString(reader["StatusColor"]);

                                if (reader["code"] != DBNull.Value)
                                    orderProcessing.OfferCode = Convert.ToString(reader["code"]);

                                if (reader["Customer"] != DBNull.Value)
                                    orderProcessing.Customer = Convert.ToString(reader["Customer"]);

                                if (reader["PODate"] != DBNull.Value)
                                    orderProcessing.POReceivedDate = Convert.ToDateTime(Convert.ToDateTime(reader["PODate"]).ToString("yyyy-MM-dd"));

                                if (reader["Login"] != DBNull.Value)
                                {
                                    orderProcessing.AssignedLoginName = Convert.ToString(reader["Login"]);

                                    if (reader["IdUserGender"] != DBNull.Value)
                                        orderProcessing.IdUserGender = Convert.ToByte(reader["IdUserGender"]);

                                    if (reader["UserName"] != DBNull.Value)
                                        orderProcessing.UserName = Convert.ToString(reader["UserName"]);

                                    orderProcessing.AssignedToImageInBytes = GetUserProfileImageInBytes(orderProcessing.AssignedLoginName, userProfileImageFilePath);
                                }


                                orderProcessings.Add(orderProcessing);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetOrderInProcessing() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return orderProcessings;
        }




        private byte[] GetUserProfileImageInBytes(string LoginName, string filePath)
        {
            byte[] bytes = null;
            string fileUploadPath = "";

            if (File.Exists(filePath + LoginName + ".png"))
            {
                fileUploadPath = filePath + LoginName + ".png";
            }
            else
            {
                fileUploadPath = filePath + LoginName + ".jpg";
            }
            if (File.Exists(fileUploadPath))
            {
                using (System.IO.FileStream stream = new System.IO.FileStream(fileUploadPath, System.IO.FileMode.Open, System.IO.FileAccess.Read))
                {
                    bytes = new byte[stream.Length];
                    int numBytesToRead = (int)stream.Length;
                    int numBytesRead = 0;
                    while (numBytesToRead > 0)
                    {
                        // Read may return anything from 0 to numBytesToRead.
                        int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                        // Break when the end of the file is reached.
                        if (n == 0)
                            break;

                        numBytesRead += n;
                        numBytesToRead -= n;
                    }
                }

                return bytes;
            }
            else
            {
                return null;
            }

        }

        public TotalWeekOrder GetTotalofWeekOrders(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            TotalWeekOrder totalWeekOrder = new TotalWeekOrder();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetTotalOfWeekOrders", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 8000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        if (reader.Read())
                        {
                            try
                            {
                                if (reader["ComplaintOrders"] != DBNull.Value)
                                {
                                    totalWeekOrder.ComplaintsOrder = new WorkOrderType();
                                    totalWeekOrder.ComplaintsOrder.TypeCount = Convert.ToInt64(reader["ComplaintOrders"]);
                                    if (reader["HtmlColor"] != DBNull.Value)
                                        totalWeekOrder.ComplaintsOrder.HtmlColor = Convert.ToString(reader["HtmlColor"]);
                                }

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetTotalofWeekOrders() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        if (reader.NextResult())
                        {
                            if (reader.Read())
                            {
                                try
                                {
                                    if (reader["UrgentOrders"] != DBNull.Value)
                                    {
                                        totalWeekOrder.UrgentOrder = new WorkOrderType();
                                        totalWeekOrder.UrgentOrder.TypeCount = Convert.ToInt64(reader["UrgentOrders"]);
                                        if (reader["HtmlColor"] != DBNull.Value)
                                            totalWeekOrder.UrgentOrder.HtmlColor = Convert.ToString(reader["HtmlColor"]);
                                    }

                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetTotalofWeekOrders() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                    throw;
                                }
                            }
                        }
                        if (reader.NextResult())
                        {
                            if (reader.Read())
                            {
                                try
                                {
                                    if (reader["IncomingOrders"] != DBNull.Value)
                                    {
                                        totalWeekOrder.IncomingOrder = new WorkOrderType();
                                        totalWeekOrder.IncomingOrder.TypeCount = Convert.ToInt64(reader["IncomingOrders"]);
                                        if (reader["HtmlColor"] != DBNull.Value)
                                            totalWeekOrder.IncomingOrder.HtmlColor = Convert.ToString(reader["HtmlColor"]);
                                    }

                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetTotalofWeekOrders() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                    throw;
                                }
                            }
                        }
                        if (reader.NextResult())
                        {
                            if (reader.Read())
                            {
                                try
                                {
                                    if (reader["FutureOrders"] != DBNull.Value)
                                    {
                                        totalWeekOrder.FutureOrder = new WorkOrderType();
                                        totalWeekOrder.FutureOrder.TypeCount = Convert.ToInt64(reader["FutureOrders"]);
                                        if (reader["HtmlColor"] != DBNull.Value)
                                            totalWeekOrder.FutureOrder.HtmlColor = Convert.ToString(reader["HtmlColor"]);
                                    }

                                }
                                catch (Exception ex)
                                {
                                    Log4NetLogger.Logger.Log(string.Format("Error GetTotalofWeekOrders() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                    throw;
                                }
                            }
                        }
                    }
                }
            }

            return totalWeekOrder;
        }


        public List<MyWarehouse> GetWarehouseArticleDetails(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<MyWarehouse> myWarehouses = new List<MyWarehouse>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetWarehouseArticleDetails", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 8000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {

                    while (reader.Read())
                    {
                        try
                        {
                            MyWarehouse myWarehouse = new MyWarehouse();
                            if (reader["idArticle"] != DBNull.Value)
                                myWarehouse.IdArticle = Convert.ToInt32(reader["idArticle"]);

                            if (reader["MinimumStock"] != DBNull.Value)
                                myWarehouse.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);

                            if (reader["CurrentStock"] != DBNull.Value)
                                myWarehouse.CurrentStock = Convert.ToInt64(reader["CurrentStock"]);

                            myWarehouses.Add(myWarehouse);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetWarehouseArticleDetails() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return myWarehouses;
        }



        public DashboardInventory GetTotalItemsToLocate(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            DashboardInventory dashboardInventory = new DashboardInventory();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetTotalItemsToLocate", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        if (reader.Read())
                        {
                            try
                            {

                                if (reader["TotalItemsToLocate"] != DBNull.Value)
                                    dashboardInventory.Count = Convert.ToInt64(reader["TotalItemsToLocate"]);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetTotalItemsToLocate() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return dashboardInventory;
        }

        private Int64 GetTotalWarehouseLocation(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            Int64 LocationCount = 0;

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetTotalWarehouseLocation", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        if (reader.Read())
                        {
                            try
                            {

                                if (reader["LocationCount"] != DBNull.Value)
                                    LocationCount = Convert.ToInt64(reader["LocationCount"]);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetTotalWarehouseLocation() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return LocationCount;
        }

        public DashboardInventory GetTotalItemsToRefill(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            DashboardInventory dashboardInventory = new DashboardInventory();
            Int64 LocationCount = GetTotalWarehouseLocation(warehouse);
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetTotalItemsToRefill", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        if (reader.Read())
                        {
                            try
                            {

                                if (reader["TotalItemsToRefill"] != DBNull.Value)
                                {
                                    dashboardInventory.Count = Convert.ToInt64(reader["TotalItemsToRefill"]);
                                    if (LocationCount > 0)
                                        dashboardInventory.Progress = (Int16)((dashboardInventory.Count / LocationCount) * 100);
                                    else
                                        dashboardInventory.Progress = 0;

                                }

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetTotalItemsToRefill() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return dashboardInventory;
        }


        public Int64 GetTotalStockForProgress(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            Int64 ItemsStockCount = 0;
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetTotalStockForProgress", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        if (reader.Read())
                        {
                            try
                            {

                                if (reader["ItemsStockCount"] != DBNull.Value)
                                    ItemsStockCount = Convert.ToInt64(reader["ItemsStockCount"]);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetTotalStockForProgress() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return ItemsStockCount;
        }




        public List<TransferMaterials> GetMaterialDetailsByLocationName_V2034(string locatioName, Warehouses warehouse, string ArticleVisualAidsPath)
        {
            List<TransferMaterials> transferMaterialsList = new List<TransferMaterials>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetMaterialDetailsByLocationName_V2034", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_LocationName", locatioName);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {
                    while (articlesReader.Read())
                    {
                        try
                        {
                            TransferMaterials transferMaterial = new TransferMaterials();

                            if (articlesReader["IdArticle"] != DBNull.Value)
                                transferMaterial.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["Reference"] != DBNull.Value)
                                transferMaterial.Reference = articlesReader["Reference"].ToString();

                            if (articlesReader["CurrentStock"] != DBNull.Value)
                                transferMaterial.CurrentStock = Convert.ToInt64(articlesReader["CurrentStock"]);

                            if (articlesReader["costprice"] != DBNull.Value)
                                transferMaterial.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                            if (articlesReader["UnitPrice"] != DBNull.Value)
                                transferMaterial.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                            if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                transferMaterial.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                transferMaterial.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["Quantity"] != DBNull.Value)
                                transferMaterial.Quantity = Convert.ToInt32(articlesReader["Quantity"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                transferMaterial.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                transferMaterial.LocationFullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["Description"] != DBNull.Value)
                                transferMaterial.Description = articlesReader["Description"].ToString();

                            transferMaterial.ArticleVisualAidsPath = ArticleVisualAidsPath;
                            if (articlesReader["ImagePath"] != DBNull.Value)
                            {
                                transferMaterial.ImagePath = articlesReader["ImagePath"].ToString();
                                Article article = new Article();
                                article.ImagePath = transferMaterial.ImagePath;
                                transferMaterial.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                            }

                            if (articlesReader["MinimumStock"] != DBNull.Value)
                                transferMaterial.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                            if (articlesReader["MaximumStock"] != DBNull.Value)
                                transferMaterial.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                            if (articlesReader["UploadedIn"] != DBNull.Value)
                                transferMaterial.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);

                            if (articlesReader["IdCurrency"] != DBNull.Value)
                                transferMaterial.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                            if (articlesReader["DeliveryCode"] != DBNull.Value)
                            {
                                transferMaterial.WarehouseDeliveryNote = new WarehouseDeliveryNote();

                                transferMaterial.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);
                            }


                            transferMaterialsList.Add(transferMaterial);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetMaterialDetailsByLocationName_V2034(locatioName-{0}, idWarehouse-{1}). ErrorMessage- {2}", locatioName, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }
            return transferMaterialsList;
        }


        public List<LocationRefill> GetRefillToListByFullNameSortByStock(string connectionString, Int64 idWarehouse, string fullName)
        {
            List<LocationRefill> locationRefills = new List<LocationRefill>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("WMS_GetRefillToListByFullNameSortByStock", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                concommand.Parameters.AddWithValue("_FullName", fullName);


                using (MySqlDataReader dNReader = concommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        LocationRefill locationRefill = new LocationRefill();
                        if (dNReader["IdWarehouseLocation"] != DBNull.Value)
                            locationRefill.IdWarehouseLocation = Convert.ToInt64(dNReader["IdWarehouseLocation"]);
                        if (dNReader["Position"] != DBNull.Value)
                            locationRefill.Position = Convert.ToInt64(dNReader["Position"]);

                        if (dNReader["IdArticle"] != DBNull.Value)
                            locationRefill.IdArticle = Convert.ToInt32(dNReader["IdArticle"]);

                        if (dNReader["MinimumStock"] != DBNull.Value)
                            locationRefill.MinimumStock = Convert.ToInt64(dNReader["MinimumStock"]);

                        if (dNReader["FullName"] != DBNull.Value)
                            locationRefill.FullName = Convert.ToString(dNReader["FullName"]);

                        if (dNReader["CurrentStock"] != DBNull.Value)
                            locationRefill.CurrenStock = Convert.ToInt64(dNReader["CurrentStock"]);

                        if (dNReader["MaximumStock"] != DBNull.Value)
                            locationRefill.MaximumStock = Convert.ToInt64(dNReader["MaximumStock"]);

                        locationRefills.Add(locationRefill);
                    }
                }
            }

            return locationRefills;
        }

        public List<LocationRefill> GetRefillToListSortByStock(string connectionString, Int64 idWarehouse)
        {
            List<LocationRefill> locationRefills = new List<LocationRefill>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("WMS_GetRefillToListSortByStock", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);


                using (MySqlDataReader dNReader = concommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        LocationRefill locationRefill = new LocationRefill();
                        if (dNReader["IdWarehouseLocation"] != DBNull.Value)
                            locationRefill.IdWarehouseLocation = Convert.ToInt64(dNReader["IdWarehouseLocation"]);
                        if (dNReader["Position"] != DBNull.Value)
                            locationRefill.Position = Convert.ToInt64(dNReader["Position"]);

                        if (dNReader["IdArticle"] != DBNull.Value)
                            locationRefill.IdArticle = Convert.ToInt32(dNReader["IdArticle"]);

                        if (dNReader["MinimumStock"] != DBNull.Value)
                            locationRefill.MinimumStock = Convert.ToInt64(dNReader["MinimumStock"]);

                        if (dNReader["FullName"] != DBNull.Value)
                            locationRefill.FullName = Convert.ToString(dNReader["FullName"]);

                        if (dNReader["CurrentStock"] != DBNull.Value)
                            locationRefill.CurrenStock = Convert.ToInt64(dNReader["CurrentStock"]);

                        if (dNReader["MaximumStock"] != DBNull.Value)
                            locationRefill.MaximumStock = Convert.ToInt64(dNReader["MaximumStock"]);

                        locationRefills.Add(locationRefill);
                    }
                }
            }

            return locationRefills;
        }


        public List<OrderPreparation> GetPendingWorkOrders(Warehouses warehouse, string userProfileImageFilePath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<UserShortDetail> userShortDetails = new List<UserShortDetail>();
            List<OrderPreparation> orderPreparations = new List<OrderPreparation>();

            using (MySqlConnection connOts = new MySqlConnection(connectionString))
            {
                connOts.Open();

                MySqlCommand otsCommand = new MySqlCommand("WMS_GetPendingWorkOrders", connOts);
                otsCommand.CommandType = CommandType.StoredProcedure;
                otsCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                otsCommand.CommandTimeout = 8000;

                using (MySqlDataReader reader = otsCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {

                                OrderPreparation orderPreparation = new OrderPreparation();

                                if (reader["IdOT"] != DBNull.Value)
                                    orderPreparation.IdOT = Convert.ToInt64(reader["IdOT"]);

                                if (reader["StatusColor"] != DBNull.Value)
                                    orderPreparation.StatusColor = Convert.ToString(reader["StatusColor"]);

                                if (reader["idOfferType"] != DBNull.Value)
                                    orderPreparation.IdOfferType = Convert.ToByte(reader["idOfferType"]);

                                if (reader["Code"] != DBNull.Value)
                                    orderPreparation.OTCode = Convert.ToString(reader["Code"]);

                                if (reader["Customer"] != DBNull.Value)
                                    orderPreparation.Customer = Convert.ToString(reader["Customer"]);

                                if (reader["DeliveryDate"] != DBNull.Value)
                                    orderPreparation.OTDeliveryDate = Convert.ToDateTime(Convert.ToDateTime(reader["DeliveryDate"]).ToString("yyyy-MM-dd"));


                                if (reader["OTDeliveryDateWeek"] != DBNull.Value)
                                    orderPreparation.OtDeliveryDateWeek = Convert.ToInt64(reader["OTDeliveryDateWeek"]);

                                if (reader["CurrentDateWeek"] != DBNull.Value)
                                    orderPreparation.CurrentDateWeek = Convert.ToInt64(reader["CurrentDateWeek"]);

                                if (orderPreparation.OtDeliveryDateWeek == orderPreparation.CurrentDateWeek)
                                {

                                    if (reader["StockModifiedByLogin"] != DBNull.Value)
                                    {
                                        orderPreparation.ArticleStockModifiedBy = Convert.ToString(reader["StockModifiedByLogin"]);
                                        orderPreparation.UserShortDetails = new List<UserShortDetail>();

                                        foreach (string itemLogin in orderPreparation.ArticleStockModifiedBy.Split(','))
                                        {
                                            if (!orderPreparation.UserShortDetails.Any(i => i.Login == itemLogin))
                                            {
                                                UserShortDetail usd = new UserShortDetail();
                                                usd.Login = itemLogin;
                                                orderPreparation.UserShortDetails.Add(usd);
                                                if (!userShortDetails.Any(i => i.Login == itemLogin))
                                                {
                                                    userShortDetails.Add(usd);
                                                }

                                                // usd.UserImageInBytes = GetUserProfileImageInBytes(itemLogin, userProfileImageFilePath);

                                            }

                                        }


                                    }
                                }

                                if (reader["ActualQty"] != DBNull.Value)
                                    orderPreparation.ActualQty = Convert.ToInt64(reader["ActualQty"]);

                                if (reader["DownloadedQty"] != DBNull.Value)
                                    orderPreparation.DownloadedQty = Convert.ToInt64(reader["DownloadedQty"]);



                                orderPreparation.RemainingQty = orderPreparation.ActualQty + orderPreparation.DownloadedQty;
                                if (orderPreparation.ActualQty > 0)
                                {
                                    orderPreparation.Progress = (Int16)((Math.Abs(orderPreparation.DownloadedQty) / orderPreparation.ActualQty) * 100);
                                }
                                orderPreparation.OtItems = new List<OtItem>();
                                orderPreparations.Add(orderPreparation);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetOrderInPreparation() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OrderPreparation orderPreparation = orderPreparations.FirstOrDefault(x => x.IdOT == Convert.ToInt64(reader["IdOT"]));
                                if (orderPreparation != null)
                                {
                                    OtItem otItem = new OtItem();
                                    if (reader["IdOT"] != DBNull.Value)
                                        otItem.IdOT = Convert.ToInt64(reader["IdOT"]);
                                    if (reader["IdOtItem"] != DBNull.Value)
                                        otItem.IdOTItem = Convert.ToInt64(reader["IdOtItem"]);
                                    if (reader["IdRevisionItem"] != DBNull.Value)
                                    {
                                        otItem.IdRevisionItem = Convert.ToInt64(reader["IdRevisionItem"]);
                                        otItem.RevisionItem = new RevisionItem();
                                        otItem.RevisionItem.IdRevisionItem = Convert.ToInt64(reader["IdRevisionItem"]);
                                        otItem.RevisionItem.Quantity = Convert.ToDecimal(reader["Quantity"]);
                                        if (reader["DownloadedQty"] != DBNull.Value)
                                            otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(reader["DownloadedQty"]);

                                        if (reader["RemainingQty"] != DBNull.Value)
                                            otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(reader["RemainingQty"]);
                                    }
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    orderPreparation.OtItems.Add(otItem);
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetOrderInPreparation() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }


                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OrderPreparation orderPreparation = orderPreparations.FirstOrDefault(x => x.IdOT == Convert.ToInt64(reader["IdOT"]));
                                if (orderPreparation != null)
                                {
                                    OtItem otitem = orderPreparation.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(reader["idotitem"])).FirstOrDefault();

                                    OtItem decomposed = new OtItem();
                                    if (otitem != null)
                                    {
                                        decomposed.IdOT = orderPreparation.IdOT;
                                        decomposed.IdOTItem = Convert.ToInt64(reader["IdOtItem"]);

                                        if (reader["idParent"] != DBNull.Value)
                                        {
                                            decomposed.ParentId = Convert.ToInt32(reader["idParent"]);
                                        }
                                        decomposed.RevisionItem = new RevisionItem();
                                        decomposed.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                        decomposed.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(reader["IdWarehouseproduct"]);



                                        if (reader["IdComponent"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(reader["IdComponent"]);
                                        }
                                        if (decomposed.ParentId == -1)
                                        {
                                            if (reader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = otitem.RevisionItem.Quantity * Convert.ToDecimal(reader["Quantity"]);
                                        }
                                        else
                                        {
                                            decimal qty = otitem.ArticleDecomposedList.First(x => x.RevisionItem.WarehouseProduct.IdComponent == decomposed.ParentId).RevisionItem.Quantity;
                                            if (reader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = qty * Convert.ToDecimal(reader["Quantity"]);
                                        }

                                        if (reader["IdArticle"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                        }

                                        decomposed.RevisionItem.DownloadedQuantity = 0;


                                        otitem.ArticleDecomposedList.Add(decomposed);

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetOrderInPreparation() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OrderPreparation orderPreparation = orderPreparations.FirstOrDefault(x => x.IdOT == Convert.ToInt64(reader["IdOT"]));
                                if (orderPreparation != null)
                                {
                                    OtItem otitem = orderPreparation.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(reader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(reader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(reader["idarticle"]) && i.RevisionItem.WarehouseProduct.IdComponent == Convert.ToInt64(reader["idwarehouseproductcomponent"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (reader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(reader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetOrderInPreparation() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OrderPreparation orderPreparation = orderPreparations.FirstOrDefault(x => x.IdOT == Convert.ToInt64(reader["IdOT"]));
                                if (orderPreparation != null)
                                {
                                    OtItem otitem = orderPreparation.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(reader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(reader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(reader["idarticle"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (reader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(reader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetOrderInPreparation() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }




                    foreach (OrderPreparation itemOP in orderPreparations)
                    {
                        Int64 downloadedQty = 0;
                        decimal Qty = 0;
                        foreach (OtItem itemOtitem in itemOP.OtItems)
                        {
                            if (itemOtitem.ArticleDecomposedList.Count > 0)
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.DownloadedQuantity));
                                Qty = Qty + itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.Quantity);
                                // ot.Status = (Int16)((Math.Abs(ot.DownloadedQuantity) / ot.ActualQuantity) * 100);

                            }
                            else
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.RevisionItem.DownloadedQuantity);
                                Qty = Qty + itemOtitem.RevisionItem.Quantity;
                            }

                        }
                        if (Qty > 0)
                        {
                            itemOP.Progress = (Int16)((Math.Abs(downloadedQty) / Qty) * 100);
                        }
                    }
                }
            }

            orderPreparations = orderPreparations.Where(x => x.Progress < 100).ToList();
            orderPreparations.AddRange(orderPreparations.Where(x => x.Progress == 100 && x.OtDeliveryDateWeek == x.CurrentDateWeek).ToList());
            Log4NetLogger.Logger.Log("Executed GetOrderInPreparation().", category: Category.Info, priority: Priority.Low);

            //Get userImage And UserName
            string getLogins = string.Join(",", userShortDetails.Select(i => i.Login).ToList());
            userShortDetails = GetUserShortDetail(getLogins, connectionString);
            foreach (OrderPreparation itemOP in orderPreparations)
            {
                if (itemOP.UserShortDetails != null)
                {
                    foreach (UserShortDetail itemOPUSD in itemOP.UserShortDetails)
                    {
                        if (userShortDetails.Any(usd => usd.Login == itemOPUSD.Login))
                        {
                            UserShortDetail usdItem = userShortDetails.Where(usd => usd.Login == itemOPUSD.Login).FirstOrDefault();
                            itemOPUSD.IdUserGender = usdItem.IdUserGender;
                            itemOPUSD.UserName = usdItem.UserName;
                            itemOPUSD.UserImageInBytes = GetUserProfileImageInBytes(itemOPUSD.Login, userProfileImageFilePath);
                        }
                    }
                }

            }

            return orderPreparations.OrderBy(op => op.OTDeliveryDate).ToList();
        }
        private List<UserShortDetail> GetUserShortDetail(string getLogins, string connectionString)
        {
            List<UserShortDetail> userShortDetails = new List<UserShortDetail>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("WMS_GetUserShortDetail", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_Logins", getLogins);
                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        UserShortDetail userShortDetail = new UserShortDetail();

                        if (reader["Login"] != DBNull.Value)
                            userShortDetail.Login = Convert.ToString(reader["Login"]);

                        if (reader["UserName"] != DBNull.Value)
                            userShortDetail.UserName = Convert.ToString(reader["UserName"]);

                        if (reader["IdUserGender"] != DBNull.Value)
                            userShortDetail.IdUserGender = Convert.ToByte(reader["IdUserGender"]);


                        userShortDetails.Add(userShortDetail);
                    }
                }
            }
            return userShortDetails;
        }

        public WarehouseDeliveryNote GetLabelPrintDetails_V2034(Int32 IdArticle, Warehouses warehouse, Int64 IdWarehouseDeliveryNoteItem)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            WarehouseDeliveryNote warehouseDeliveryNote = new WarehouseDeliveryNote();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("warehousedeliverynotes_GetLabelPrintDetails_V2034", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouseDeliveryNoteItem", IdWarehouseDeliveryNoteItem);
                mySqlCommand.Parameters.AddWithValue("_IdArticle", IdArticle);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                            warehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["idWarehouseDeliveryNote"]);

                        if (reader["DeliveryDate"] != DBNull.Value)
                            warehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);

                        if (reader["IdWarehousePurchaseOrder"] != DBNull.Value)
                        {
                            if (Convert.ToInt64(reader["IdWarehousePurchaseOrder"]) > 0)
                            {
                                warehouseDeliveryNote.WarehousePurchaseOrder = new WarehousePurchaseOrder();
                                warehouseDeliveryNote.WarehousePurchaseOrder.IdWarehousePurchaseOrder = Convert.ToInt64(reader["IdWarehousePurchaseOrder"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    warehouseDeliveryNote.WarehousePurchaseOrder.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                                if (reader["IdArticleSupplier"] != DBNull.Value)
                                {
                                    warehouseDeliveryNote.WarehousePurchaseOrder.IdArticleSupplier = Convert.ToInt64(reader["IdArticleSupplier"]);
                                    warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier = new ArticleSupplier();
                                    warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.IdArticleSupplier = Convert.ToInt64(reader["IdArticleSupplier"]);
                                    warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Name = Convert.ToString(reader["Supplier"]);
                                    warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Code = "SUPL" + warehouseDeliveryNote.WarehousePurchaseOrder.IdArticleSupplier.ToString().PadLeft(6, '0');
                                    if (reader["SuppCountryGroup"] != DBNull.Value)
                                    {
                                        warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Country = new Country();
                                        warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Country.CountryGroup = new CountryGroup();
                                        warehouseDeliveryNote.WarehousePurchaseOrder.ArticleSupplier.Country.CountryGroup.Name = Convert.ToString(reader["SuppCountryGroup"]);
                                    }
                                }
                            }
                        }


                        if (reader["IdSupplierComplaint"] != DBNull.Value)
                        {
                            if (Convert.ToInt64(reader["IdSupplierComplaint"]) > 0)
                            {
                                warehouseDeliveryNote.SupplierComplaint = new SupplierComplaint();
                                warehouseDeliveryNote.SupplierComplaint.IdSupplierComplaint = Convert.ToInt64(reader["IdSupplierComplaint"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    warehouseDeliveryNote.SupplierComplaint.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                                if (reader["IdArticleSupplier"] != DBNull.Value)
                                {
                                    warehouseDeliveryNote.SupplierComplaint.IdArticleSupplier = Convert.ToInt64(reader["IdArticleSupplier"]);
                                    warehouseDeliveryNote.SupplierComplaint.Supplier = new ArticleSupplier();
                                    warehouseDeliveryNote.SupplierComplaint.Supplier.IdArticleSupplier = Convert.ToInt64(reader["IdArticleSupplier"]);
                                    warehouseDeliveryNote.SupplierComplaint.Supplier.Name = Convert.ToString(reader["Supplier"]);
                                    warehouseDeliveryNote.SupplierComplaint.Supplier.Code = "SUPL" + warehouseDeliveryNote.SupplierComplaint.Supplier.IdArticleSupplier.ToString().PadLeft(6, '0');



                                    if (reader["SuppCountryGroup"] != DBNull.Value)
                                    {
                                        warehouseDeliveryNote.SupplierComplaint.Supplier.Country = new Country();
                                        warehouseDeliveryNote.SupplierComplaint.Supplier.Country.CountryGroup = new CountryGroup();
                                        warehouseDeliveryNote.SupplierComplaint.Supplier.Country.CountryGroup.Name = Convert.ToString(reader["SuppCountryGroup"]);
                                    }
                                }
                            }
                        }


                        warehouseDeliveryNote.WarehouseDeliveryNoteItems = new List<WarehouseDeliveryNoteItem>();
                        WarehouseDeliveryNoteItem WarehouseDeliveryNoteItem = new WarehouseDeliveryNoteItem();
                        if (reader["IdManufacturerByArticle"] != DBNull.Value)
                        {
                            WarehouseDeliveryNoteItem.IdManufacturerByArticle = Convert.ToInt64(reader["IdManufacturerByArticle"]);
                            WarehouseDeliveryNoteItem.ManufacturersByArticle = new List<ManufacturersByArticle>();
                            ManufacturersByArticle ManufacturersByArticle = new ManufacturersByArticle();
                            if (reader["CountryName"] != DBNull.Value)
                            {
                                ManufacturersByArticle.Country = new Country();
                                ManufacturersByArticle.Country.Name = Convert.ToString(reader["CountryName"]);
                                if (reader["CountryGroup"] != DBNull.Value)
                                {
                                    ManufacturersByArticle.Country.CountryGroup = new CountryGroup();
                                    ManufacturersByArticle.Country.CountryGroup.Name = Convert.ToString(reader["CountryGroup"]);
                                    if (reader["IsFreeTrade"] != DBNull.Value)
                                        ManufacturersByArticle.Country.CountryGroup.IsFreeTrade = Convert.ToByte(reader["IsFreeTrade"]);
                                }

                            }
                            if (reader["IdManufacturer"] != DBNull.Value)
                            {
                                ManufacturersByArticle.IdManufacturer = Convert.ToInt64(reader["IdManufacturer"]);

                                ManufacturersByArticle.Manufacturer = new Manufacturer();
                                ManufacturersByArticle.Manufacturer.IdManufacturer = Convert.ToInt64(reader["IdManufacturer"]);
                                ManufacturersByArticle.Manufacturer.Name = Convert.ToString(reader["Manufacturer"]);

                                ManufacturersByArticle.Manufacturer.Code = "PROD" + Convert.ToInt64(reader["IdManufacturer"]).ToString().PadLeft(6, '0');
                            }
                            WarehouseDeliveryNoteItem.ManufacturersByArticle.Add(ManufacturersByArticle);


                        }
                        warehouseDeliveryNote.WarehouseDeliveryNoteItems.Add(WarehouseDeliveryNoteItem);



                    }
                }
            }

            return warehouseDeliveryNote;
        }



        public List<WarehouseLocation> GetWarehouseLocationBySelectedWarehouse_V2034(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<WarehouseLocation> warehouseLocations = new List<WarehouseLocation>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("WMS_GetWarehouseLocationBySelectedWarehouse_V2034", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        WarehouseLocation warehouseLocation = new WarehouseLocation();

                        if (reader["IdWarehouseLocation"] != DBNull.Value)
                            warehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                        if (reader["IdWarehouse"] != DBNull.Value)
                            warehouseLocation.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                        warehouseLocation.Name = Convert.ToString(reader["Name"]);

                        if (reader["Parent"] != DBNull.Value)
                            warehouseLocation.Parent = Convert.ToInt64(reader["Parent"]);

                        if (reader["Position"] != DBNull.Value)
                            warehouseLocation.Position = Convert.ToInt64(reader["Position"]);

                        if (reader["FullName"] != DBNull.Value)
                            warehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                        if (reader["IsLead"] != DBNull.Value)
                            warehouseLocation.IsLead = Convert.ToSByte(reader["IsLead"]);

                        if (reader["HtmlColor"] != DBNull.Value)
                            warehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                        warehouseLocations.Add(warehouseLocation);
                    }
                }
            }

            return warehouseLocations;
        }


        public List<Article> GetAllArticlesWithWarehouseLocations_V2034(Warehouses warehouse)
        {
            string whConnectionString = warehouse.Company.ConnectPlantConstr;
            List<Article> articles = new List<Article>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(whConnectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetAllArticlesWithWarehouseLocations_V2034", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            Article article = new Article();

                            if (reader["IdArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                            if (reader["Reference"] != DBNull.Value)
                                article.Reference = Convert.ToString(reader["Reference"]);

                            if (reader["Description"] != DBNull.Value)
                                article.Description = Convert.ToString(reader["Description"]);

                            if (reader["Weight"] != DBNull.Value)
                                article.Weight = Math.Round(Convert.ToDecimal(reader["Weight"]), 3);

                            if (reader["Length"] != DBNull.Value)
                                article.Length = (float)reader["Length"];

                            if (reader["Width"] != DBNull.Value)
                                article.Width = (float)reader["Width"];

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)reader["Height"];


                            if (reader["IdArticleCategory"] != DBNull.Value)
                            {
                                article.IdArticleCategory = Convert.ToInt32(reader["IdArticleCategory"]);

                                article.ArticleCategory = new ArticleCategory();
                                article.ArticleCategory.IdArticleCategory = Convert.ToInt32(reader["IdArticleCategory"]);
                                article.ArticleCategory.Name = Convert.ToString(reader["ArticleCategory"]);
                            }

                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                                article.ArticleWarehouseLocation.IdWarehouseLocation = Convert.ToInt32(reader["IdWarehouseLocation"]);

                                if (reader["awlPosition"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.Position = Convert.ToInt64(reader["awlPosition"]);

                                if (reader["MinimumStock"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);

                                if (reader["MaximumStock"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.MaximumStock = Convert.ToInt64(reader["MaximumStock"]);

                                article.ArticleWarehouseLocation.WarehouseLocation = new WarehouseLocation();
                                article.ArticleWarehouseLocation.WarehouseLocation.IdWarehouseLocation = article.ArticleWarehouseLocation.IdWarehouseLocation;

                                if (reader["wlPosition"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.Position = Convert.ToInt64(reader["wlPosition"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                                if (reader["Name"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.Name = Convert.ToString(reader["Name"]);

                                if (reader["Parent"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.Parent = Convert.ToInt64(reader["Parent"]);

                                if (reader["FullName"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                                if (reader["HtmlColor"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                                article.ArticleWarehouseLocation.ArticlesStock = new ArticlesStock();
                                article.ArticleWarehouseLocation.ArticlesStock.IdWarehouseLocation = Convert.ToUInt64(article.ArticleWarehouseLocation.IdWarehouseLocation);

                                if (reader["ArticleStock"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.ArticlesStock.Quantity = Convert.ToInt64(reader["ArticleStock"]);

                                articles.Add(article);
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetAllArticlesWithWarehouseLocations_V2034(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return articles;
        }


        public List<WarehouseLocation> GetWarehouseLocationsByIdWarehouse_V2034(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<WarehouseLocation> warehouseLocations = new List<WarehouseLocation>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("WMS_GetWarehouseLocationsByIdWarehouse_V2034", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        WarehouseLocation warehouseLocation = new WarehouseLocation();

                        if (reader["IdWarehouseLocation"] != DBNull.Value)
                            warehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                        if (reader["IdWarehouse"] != DBNull.Value)
                            warehouseLocation.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                        warehouseLocation.Name = Convert.ToString(reader["Name"]);

                        if (reader["Parent"] != DBNull.Value)
                            warehouseLocation.Parent = Convert.ToInt64(reader["Parent"]);

                        if (reader["Position"] != DBNull.Value)
                            warehouseLocation.Position = Convert.ToInt64(reader["Position"]);

                        if (reader["FullName"] != DBNull.Value)
                            warehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                        if (reader["IsLead"] != DBNull.Value)
                            warehouseLocation.IsLead = Convert.ToSByte(reader["IsLead"]);

                        if (reader["HtmlColor"] != DBNull.Value)
                            warehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                        if (reader["InUse"] != DBNull.Value)
                            warehouseLocation.InUse = Convert.ToBoolean(reader["InUse"]);

                        if (reader["IdDirection"] != DBNull.Value)
                        {
                            warehouseLocation.IdDirection = Convert.ToInt32(reader["IdDirection"]);

                            warehouseLocation.Direction = new LookupValue();
                            warehouseLocation.Direction.IdLookupValue = Convert.ToInt32(reader["IdDirection"]);
                            warehouseLocation.Direction.Value = Convert.ToString(reader["Value"]);
                            warehouseLocation.Direction.HtmlColor = Convert.ToString(reader["DirectionHtmlColor"]);
                            if (reader["IdImage"] != DBNull.Value)
                                warehouseLocation.Direction.IdImage = Convert.ToInt64(reader["IdImage"]);
                        }
                        if (reader["Width"] != DBNull.Value)
                            warehouseLocation.Width = Convert.ToDouble(reader["Width"]);
                        if (reader["Height"] != DBNull.Value)
                            warehouseLocation.Height = Convert.ToDouble(reader["Height"]);
                        if (reader["FileName"] != DBNull.Value)
                            warehouseLocation.FileName = Convert.ToString(reader["FileName"]);
                        if (reader["Latitude"] != DBNull.Value)
                            warehouseLocation.Latitude = Convert.ToDouble(reader["Latitude"]);
                        if (reader["Longitude"] != DBNull.Value)
                            warehouseLocation.Longitude = Convert.ToDouble(reader["Longitude"]);

                        warehouseLocations.Add(warehouseLocation);
                    }
                }
            }

            return warehouseLocations;
        }


        public void FillPickingMaterial_V2034(OtItem otItem, Warehouses warehouse, string ArticleVisualAidsPath, List<OtItem> otitems, List<OtItemSameReference> otItemSameReferences)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            otItem.PickingMaterialsList = new List<PickingMaterials>();
            List<PickingArticleStockDetail> pickingArticleStockDetails = new List<PickingArticleStockDetail>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetArticlesStockDetailsByIdArticle_V2034", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", otItem.RevisionItem.WarehouseProduct.Article.IdArticle);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                #region
                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {

                    while (articlesReader.Read())
                    {
                        PickingArticleStockDetail pickingArticleStockDetail = new PickingArticleStockDetail();

                        pickingArticleStockDetail.Article = new Article();
                        if (articlesReader["IdArticle"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            pickingArticleStockDetail.Article.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingArticleStockDetail.Article.Description = Convert.ToString(articlesReader["Description"]);

                            if (articlesReader["ImagePath"] != DBNull.Value)
                                pickingArticleStockDetail.Article.ImagePath = Convert.ToString(articlesReader["ImagePath"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingArticleStockDetail.Article.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                        }

                        if (articlesReader["awlMinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);

                        if (articlesReader["awlMaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);

                        if (articlesReader["ArticleLocationPosition"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationPosition = Convert.ToInt64(articlesReader["ArticleLocationPosition"]);

                        if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                        if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            pickingArticleStockDetail.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                        pickingArticleStockDetail.WarehouseLocation = new WarehouseLocation();
                        if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);


                            pickingArticleStockDetail.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);
                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FullName = Convert.ToString(articlesReader["Fullname"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.HtmlColor = Convert.ToString(articlesReader["HtmlColor"]);

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);
                        }


                        if (articlesReader["UnitPrice"] != DBNull.Value)
                            pickingArticleStockDetail.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                        if (articlesReader["IdCurrency"] != DBNull.Value)
                            pickingArticleStockDetail.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                        if (articlesReader["costprice"] != DBNull.Value)
                            pickingArticleStockDetail.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                        if (articlesReader["MinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                        if (articlesReader["MaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                        pickingArticleStockDetail.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (articlesReader["UploadedIn"] != DBNull.Value)
                            pickingArticleStockDetail.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);

                        if (articlesReader["DeliveryCode"] != DBNull.Value)
                        {

                            pickingArticleStockDetail.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);
                        }


                        if (articlesReader["IdCountryGroup"] != DBNull.Value)
                            pickingArticleStockDetail.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);

                        pickingArticleStockDetails.Add(pickingArticleStockDetail);
                    }
                }
                List<PickingArticleStockDetail> PickingArticleStockDetailSort = new List<PickingArticleStockDetail>();

                foreach (var itemPASD in pickingArticleStockDetails.GroupBy(i => Convert.ToDateTime(i.UploadedIn.Value.ToShortDateString())))
                {
                    foreach (var item in itemPASD.OrderBy(i => i.ArticleLocationPosition).ToList())
                    {
                        PickingArticleStockDetailSort.Add(item);
                    }
                }

                pickingArticleStockDetails = PickingArticleStockDetailSort;

                Int64 remainingQty = otItem.RevisionItem.RemainingQuantity; // download Quantity.
                foreach (PickingArticleStockDetail itemArticleStock in pickingArticleStockDetails)
                {

                    try
                    {

                        if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        {
                            Int64 articleCurrentStockRem = 0;
                            articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                            if (articleCurrentStockRem == 0)
                                continue;
                            else
                                if (remainingQty == 0)
                                return;
                        }
                        else
                        {
                            if (remainingQty == 0)
                                return;
                        }



                        PickingMaterials pickingMaterials = new PickingMaterials();

                        pickingMaterials.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        pickingMaterials.Article = new Article();
                        pickingMaterials.Article.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;
                        pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                        pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        if (itemArticleStock.ArticleLocationMinimumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = itemArticleStock.ArticleLocationMinimumStock.Value;
                        if (itemArticleStock.ArticleLocationMaximumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = itemArticleStock.ArticleLocationMaximumStock.Value;

                        pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.IdOtitem = otItem.IdOTItem;

                        pickingMaterials.IdRevisionItem = otItem.IdRevisionItem;
                        pickingMaterials.RevisionItem = new RevisionItem();
                        pickingMaterials.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.NumItem = otItem.RevisionItem.NumItem;

                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.Quantity = otItem.RevisionItem.Quantity;

                        if (otItem.RevisionItem != null)
                            if (otItem.RevisionItem.WarehouseProduct != null)
                                pickingMaterials.IdWarehouseProductComponent = otItem.RevisionItem.WarehouseProduct.IdComponent;

                        if (!string.IsNullOrEmpty(otItem.RevisionItem.WarehouseProduct.Article.Reference))
                            pickingMaterials.Reference = otItem.RevisionItem.WarehouseProduct.Article.Reference;

                        if (itemArticleStock.ArticleCurrentStock != null)
                            pickingMaterials.ArticleCurrentStock = itemArticleStock.ArticleCurrentStock.Value;

                        if (itemArticleStock.CurrentStock != null)
                            pickingMaterials.CurrentStock = itemArticleStock.CurrentStock.Value;

                        if (itemArticleStock.CostPrice != null)
                            pickingMaterials.CostPrice = itemArticleStock.CostPrice.Value;

                        if (itemArticleStock.UnitPrice != null)
                            pickingMaterials.UnitPrice = itemArticleStock.UnitPrice.Value;


                        pickingMaterials.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        if (pickingMaterials.IdWareHouseDeliveryNoteItem != null)
                        {
                            pickingMaterials.IdWareHouseDeliveryNoteItem = itemArticleStock.IdWareHouseDeliveryNoteItem.Value;


                            pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.Manufacturer = GeManufacturerByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbers(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, itemArticleStock.WarehouseLocation.IdWarehouse));
                        }


                        pickingMaterials.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;


                        pickingMaterials.LocationFullName = itemArticleStock.WarehouseLocation.FullName;


                        pickingMaterials.Description = itemArticleStock.Article.Description;

                        if (!string.IsNullOrEmpty(itemArticleStock.Article.ImagePath))
                        {
                            pickingMaterials.ImagePath = itemArticleStock.Article.ImagePath;
                            Article article = new Article();
                            article.ImagePath = pickingMaterials.ImagePath;
                            pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                        }


                        if (itemArticleStock.MinimumStock != null)
                            pickingMaterials.MinimumStock = itemArticleStock.MinimumStock.Value;

                        if (itemArticleStock.MaximumStock != null)
                            pickingMaterials.MaximumStock = itemArticleStock.MaximumStock.Value;

                        pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (itemArticleStock.UploadedIn != null)
                        {
                            pickingMaterials.UploadedIn = itemArticleStock.UploadedIn;
                            pickingMaterials.WarehouseDeliveryNote.DeliveryDate = itemArticleStock.UploadedIn.Value;
                        }


                        pickingMaterials.WarehouseDeliveryNote.Code = itemArticleStock.WarehouseDeliveryNote.Code;


                        pickingMaterials.IdCurrency = itemArticleStock.IdCurrency;

                        if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        {
                            Int64 articleCurrentStockRem = 0;
                            articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                            if (articleCurrentStockRem > 0)
                            {
                                if (remainingQty > 0 && articleCurrentStockRem > 0)
                                {
                                    if (articleCurrentStockRem > remainingQty)
                                    {
                                        pickingMaterials.DownloadQuantity = remainingQty;
                                        remainingQty = 0;
                                    }
                                    else
                                    {
                                        pickingMaterials.DownloadQuantity = articleCurrentStockRem;
                                        remainingQty = remainingQty - articleCurrentStockRem;
                                    }

                                }
                            }
                            else
                            {
                                if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                                {
                                    if (pickingMaterials.ArticleCurrentStock > remainingQty)
                                    {
                                        pickingMaterials.DownloadQuantity = remainingQty;
                                        remainingQty = 0;
                                    }
                                    else
                                    {
                                        pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                                        remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                                    }

                                }
                            }
                        }
                        else
                        {
                            if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                            {
                                if (pickingMaterials.ArticleCurrentStock > remainingQty)
                                {
                                    pickingMaterials.DownloadQuantity = remainingQty;
                                    remainingQty = 0;
                                }
                                else
                                {
                                    pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                                    remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                                }

                            }
                        }

                        pickingMaterials.WarehouseLocation = new WarehouseLocation();

                        pickingMaterials.WarehouseLocation.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        pickingMaterials.WarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.WarehouseLocation.FullName = itemArticleStock.WarehouseLocation.FullName;

                        pickingMaterials.WarehouseLocation.HtmlColor = itemArticleStock.WarehouseLocation.HtmlColor;

                        pickingMaterials.WarehouseLocation.Latitude = itemArticleStock.WarehouseLocation.Latitude;

                        pickingMaterials.WarehouseLocation.Longitude = itemArticleStock.WarehouseLocation.Longitude;

                        pickingMaterials.WarehouseLocation.Width = itemArticleStock.WarehouseLocation.Width;

                        pickingMaterials.WarehouseLocation.Height = itemArticleStock.WarehouseLocation.Height;

                        pickingMaterials.WarehouseLocation.FileName = itemArticleStock.WarehouseLocation.FileName;

                        pickingMaterials.RegisterSerialNumber = itemArticleStock.Article.RegisterSerialNumber;

                        pickingMaterials.PartNumberCode = GetPartNumberCode(otItem.IdOTItem, connectionString);

                        if (itemArticleStock.IdCountryGroup != null)
                            pickingMaterials.IdCountryGroup = itemArticleStock.IdCountryGroup.Value;

                        //Add in otSameReferenceList
                        OtItemSameReference otItemSameReference = new OtItemSameReference();
                        otItemSameReference.IdArticle = pickingMaterials.IdArticle;
                        otItemSameReference.IdWarehouseDeliveryNoteItem = pickingMaterials.IdWareHouseDeliveryNoteItem;
                        otItemSameReference.ArticleCurrentStock = pickingMaterials.ArticleCurrentStock;
                        otItemSameReference.Qty = pickingMaterials.DownloadQuantity;
                        otItemSameReference.IdWarehouseLocation = pickingMaterials.WarehouseLocation.IdWarehouseLocation;
                        otItemSameReferences.Add(otItemSameReference);

                        otItem.PickingMaterialsList.Add(pickingMaterials);

                        //GetTotalArticleDownloadDetailByOtItem(connectionString, 1800, 35259);

                    }
                    catch (Exception ex)
                    {
                        Log4NetLogger.Logger.Log(string.Format("Error FillPickingMaterial_V2034(IdArticle-{0}, idWarehouse-{1}). ErrorMessage- {2}", otItem.RevisionItem.WarehouseProduct.Article.IdArticle, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                        throw;
                    }
                }
                #endregion

            }

        }


        public List<OtItem> GetRemainingOtItemsByIdOt_V2034(Int64 idOt, Warehouses warehouse, string ArticleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OtItem> otItems = new List<OtItem>();
            List<OtItemSameReference> OtItemSameReferences = new List<OtItemSameReference>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetRemainingOtItemsByIdOt", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOt", idOt);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OtItem otItem = new OtItem();

                            otItem.IdOT = idOt;

                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);



                            otItem.IsBatch = Convert.ToByte(otItemReader["IsBatch"]);

                            if (otItemReader["AttachedFiles"] != DBNull.Value)
                                otItem.AttachedFiles = Convert.ToString(otItemReader["AttachedFiles"]);

                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);
                                otItem.RevisionItem.Quantity = Convert.ToInt64(otItemReader["Quantity"]);
                                otItem.RevisionItem.UnitPrice = Convert.ToDecimal(otItemReader["UnitPrice"]);

                                if (otItemReader["CustomerCommentOT"] != DBNull.Value)
                                    otItem.RevisionItem.InternalComment = Convert.ToString(otItemReader["CustomerCommentOT"]);

                                if (otItemReader["CustomerCommentRevision"] != DBNull.Value)
                                    otItem.RevisionItem.CustomerComment = Convert.ToString(otItemReader["CustomerCommentRevision"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);

                                if (otItemReader["WpDescription"] != DBNull.Value)
                                    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["ArticleDescription"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["ArticleDescription"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    if (otItemReader["UploadedIn"] != DBNull.Value)
                                        article.UploadedIn = Convert.ToDateTime(otItemReader["UploadedIn"]);

                                    if (otItemReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                        article.IdWareHouseDeliveryNoteItem = Convert.ToInt64(otItemReader["IdWareHouseDeliveryNoteItem"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    article.MyWarehouse = new MyWarehouse();

                                    if (otItemReader["MinimumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MinimumStock"]);

                                    if (otItemReader["MaximumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MaximumStock"]);

                                    if (otItemReader["CurrentStock"] != DBNull.Value)
                                        article.MyWarehouse.CurrentStock = Convert.ToInt64(otItemReader["CurrentStock"]);


                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);

                                    otItem.Status = new ItemOTStatusType();
                                    otItem.Status.IdItemOtStatus = otItem.IdItemOtStatus;
                                    otItem.Status.Name = Convert.ToString(otItemReader["Status"]);
                                }

                                if (otItemReader["AssignedTo"] != DBNull.Value)
                                {
                                    otItem.AssignedTo = Convert.ToInt32(otItemReader["AssignedTo"]);

                                    otItem.AssignedToUser = new People();
                                    otItem.AssignedToUser.Name = Convert.ToString(otItemReader["AssignedName"]);
                                    otItem.AssignedToUser.Surname = Convert.ToString(otItemReader["AssignedSurname"]);
                                }

                                if (otItemReader["DownloadedQty"] != DBNull.Value)
                                    otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otItemReader["DownloadedQty"]);

                                if (otItemReader["RemainingQty"] != DBNull.Value)
                                    otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otItemReader["RemainingQty"]);

                                if (otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;


                                List<OtItem> decomposedOtItems = GetArticlesForDecompositionScan_V2035(warehouse, idOt, otItem, ArticleVisualAidsPath, OtItemSameReferences, otItem.RevisionItem.WarehouseProduct.Article.IdArticleType);

                                //if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                //    otItems.AddRange(decomposedOtItems);



                                if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                {
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    otItem.ArticleDecomposedList = decomposedOtItems;
                                }


                                FillPickingMaterial_V2034(otItem, warehouse, ArticleVisualAidsPath, otItems, OtItemSameReferences);
                            }

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRemainingOtItemsByIdOt_V2034(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetRemainingOtItemsByIdOt_V2034().", category: Category.Info, priority: Priority.Low);
            return otItems;
        }


        public void FillPickingMaterialDisbaledFIFO_V2034(OtItem otItem, Warehouses warehouse, string ArticleVisualAidsPath, List<OtItem> otitems)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            otItem.PickingMaterialsList = new List<PickingMaterials>();
            List<PickingArticleStockDetail> pickingArticleStockDetails = new List<PickingArticleStockDetail>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetArticlesStockDetailsByIdArticleDisbaledFIFO_V2034", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", otItem.RevisionItem.WarehouseProduct.Article.IdArticle);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                #region
                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {

                    while (articlesReader.Read())
                    {
                        PickingArticleStockDetail pickingArticleStockDetail = new PickingArticleStockDetail();

                        pickingArticleStockDetail.Article = new Article();
                        if (articlesReader["IdArticle"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            pickingArticleStockDetail.Article.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingArticleStockDetail.Article.Description = Convert.ToString(articlesReader["Description"]);

                            if (articlesReader["ImagePath"] != DBNull.Value)
                                pickingArticleStockDetail.Article.ImagePath = Convert.ToString(articlesReader["ImagePath"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingArticleStockDetail.Article.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                        }

                        if (articlesReader["awlMinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);

                        if (articlesReader["awlMaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);

                        if (articlesReader["ArticleLocationPosition"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationPosition = Convert.ToInt64(articlesReader["ArticleLocationPosition"]);

                        if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                        if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            pickingArticleStockDetail.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                        pickingArticleStockDetail.WarehouseLocation = new WarehouseLocation();
                        if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);


                            pickingArticleStockDetail.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);
                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FullName = Convert.ToString(articlesReader["Fullname"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.HtmlColor = Convert.ToString(articlesReader["HtmlColor"]);

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);
                        }


                        if (articlesReader["UnitPrice"] != DBNull.Value)
                            pickingArticleStockDetail.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                        if (articlesReader["IdCurrency"] != DBNull.Value)
                            pickingArticleStockDetail.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                        if (articlesReader["costprice"] != DBNull.Value)
                            pickingArticleStockDetail.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                        if (articlesReader["MinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                        if (articlesReader["MaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                        pickingArticleStockDetail.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (articlesReader["UploadedIn"] != DBNull.Value)
                            pickingArticleStockDetail.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);

                        if (articlesReader["DeliveryCode"] != DBNull.Value)
                        {

                            pickingArticleStockDetail.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);
                        }


                        if (articlesReader["IdCountryGroup"] != DBNull.Value)
                            pickingArticleStockDetail.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);

                        pickingArticleStockDetails.Add(pickingArticleStockDetail);
                    }
                }
                List<PickingArticleStockDetail> PickingArticleStockDetailSort = new List<PickingArticleStockDetail>();

                foreach (var itemPASD in pickingArticleStockDetails.GroupBy(i => Convert.ToDateTime(i.UploadedIn.Value.ToShortDateString())))
                {
                    foreach (var item in itemPASD.OrderBy(i => i.ArticleLocationPosition).ToList())
                    {
                        PickingArticleStockDetailSort.Add(item);
                    }
                }

                pickingArticleStockDetails = PickingArticleStockDetailSort;

                // Int64 remainingQty = otItem.RevisionItem.RemainingQuantity; // download Quantity.
                foreach (PickingArticleStockDetail itemArticleStock in pickingArticleStockDetails)
                {

                    try
                    {

                        //if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        //{
                        //    Int64 articleCurrentStockRem = 0;
                        //    articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                        //    if (articleCurrentStockRem == 0)
                        //        continue;
                        //    else
                        //        if (remainingQty == 0)
                        //        return;
                        //}
                        //else
                        //{
                        //    if (remainingQty == 0)
                        //        return;
                        //}



                        PickingMaterials pickingMaterials = new PickingMaterials();

                        pickingMaterials.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        pickingMaterials.Article = new Article();
                        pickingMaterials.Article.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;
                        pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                        pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        if (itemArticleStock.ArticleLocationMinimumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = itemArticleStock.ArticleLocationMinimumStock.Value;
                        if (itemArticleStock.ArticleLocationMaximumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = itemArticleStock.ArticleLocationMaximumStock.Value;

                        pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.IdOtitem = otItem.IdOTItem;

                        pickingMaterials.IdRevisionItem = otItem.IdRevisionItem;
                        pickingMaterials.RevisionItem = new RevisionItem();
                        pickingMaterials.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.NumItem = otItem.RevisionItem.NumItem;

                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.Quantity = otItem.RevisionItem.Quantity;

                        if (otItem.RevisionItem != null)
                            if (otItem.RevisionItem.WarehouseProduct != null)
                                pickingMaterials.IdWarehouseProductComponent = otItem.RevisionItem.WarehouseProduct.IdComponent;

                        if (!string.IsNullOrEmpty(otItem.RevisionItem.WarehouseProduct.Article.Reference))
                            pickingMaterials.Reference = otItem.RevisionItem.WarehouseProduct.Article.Reference;

                        if (itemArticleStock.ArticleCurrentStock != null)
                            pickingMaterials.ArticleCurrentStock = itemArticleStock.ArticleCurrentStock.Value;

                        if (itemArticleStock.CurrentStock != null)
                            pickingMaterials.CurrentStock = itemArticleStock.CurrentStock.Value;

                        if (itemArticleStock.CostPrice != null)
                            pickingMaterials.CostPrice = itemArticleStock.CostPrice.Value;

                        if (itemArticleStock.UnitPrice != null)
                            pickingMaterials.UnitPrice = itemArticleStock.UnitPrice.Value;


                        pickingMaterials.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        if (pickingMaterials.IdWareHouseDeliveryNoteItem != null)
                        {
                            pickingMaterials.IdWareHouseDeliveryNoteItem = itemArticleStock.IdWareHouseDeliveryNoteItem.Value;


                            pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.Manufacturer = GeManufacturerByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbers(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, itemArticleStock.WarehouseLocation.IdWarehouse));
                        }


                        pickingMaterials.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;


                        pickingMaterials.LocationFullName = itemArticleStock.WarehouseLocation.FullName;


                        pickingMaterials.Description = itemArticleStock.Article.Description;

                        if (!string.IsNullOrEmpty(itemArticleStock.Article.ImagePath))
                        {
                            pickingMaterials.ImagePath = itemArticleStock.Article.ImagePath;
                            Article article = new Article();
                            article.ImagePath = pickingMaterials.ImagePath;
                            pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                        }


                        if (itemArticleStock.MinimumStock != null)
                            pickingMaterials.MinimumStock = itemArticleStock.MinimumStock.Value;

                        if (itemArticleStock.MaximumStock != null)
                            pickingMaterials.MaximumStock = itemArticleStock.MaximumStock.Value;

                        pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (itemArticleStock.UploadedIn != null)
                        {
                            pickingMaterials.UploadedIn = itemArticleStock.UploadedIn;
                            pickingMaterials.WarehouseDeliveryNote.DeliveryDate = itemArticleStock.UploadedIn.Value;
                        }


                        pickingMaterials.WarehouseDeliveryNote.Code = itemArticleStock.WarehouseDeliveryNote.Code;


                        pickingMaterials.IdCurrency = itemArticleStock.IdCurrency;

                        pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;

                        //if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        //{
                        //    Int64 articleCurrentStockRem = 0;
                        //    articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                        //    if (articleCurrentStockRem > 0)
                        //    {
                        //        if (remainingQty > 0 && articleCurrentStockRem > 0)
                        //        {
                        //            if (articleCurrentStockRem > remainingQty)
                        //            {
                        //                pickingMaterials.DownloadQuantity = remainingQty;
                        //                remainingQty = 0;
                        //            }
                        //            else
                        //            {
                        //                pickingMaterials.DownloadQuantity = articleCurrentStockRem;
                        //                remainingQty = remainingQty - articleCurrentStockRem;
                        //            }

                        //        }
                        //    }
                        //    else
                        //    {
                        //        if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                        //        {
                        //            if (pickingMaterials.ArticleCurrentStock > remainingQty)
                        //            {
                        //                pickingMaterials.DownloadQuantity = remainingQty;
                        //                remainingQty = 0;
                        //            }
                        //            else
                        //            {
                        //                pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                        //                remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                        //            }

                        //        }
                        //    }
                        //}
                        //else
                        //{
                        //    if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                        //    {
                        //        if (pickingMaterials.ArticleCurrentStock > remainingQty)
                        //        {
                        //            pickingMaterials.DownloadQuantity = remainingQty;
                        //            remainingQty = 0;
                        //        }
                        //        else
                        //        {
                        //            pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                        //            remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                        //        }

                        //    }
                        //}

                        pickingMaterials.WarehouseLocation = new WarehouseLocation();

                        pickingMaterials.WarehouseLocation.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        pickingMaterials.WarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.WarehouseLocation.FullName = itemArticleStock.WarehouseLocation.FullName;

                        pickingMaterials.WarehouseLocation.HtmlColor = itemArticleStock.WarehouseLocation.HtmlColor;

                        pickingMaterials.WarehouseLocation.Latitude = itemArticleStock.WarehouseLocation.Latitude;

                        pickingMaterials.WarehouseLocation.Longitude = itemArticleStock.WarehouseLocation.Longitude;

                        pickingMaterials.WarehouseLocation.Width = itemArticleStock.WarehouseLocation.Width;

                        pickingMaterials.WarehouseLocation.Height = itemArticleStock.WarehouseLocation.Height;

                        pickingMaterials.WarehouseLocation.FileName = itemArticleStock.WarehouseLocation.FileName;

                        pickingMaterials.RegisterSerialNumber = itemArticleStock.Article.RegisterSerialNumber;

                        pickingMaterials.PartNumberCode = GetPartNumberCode(otItem.IdOTItem, connectionString);

                        if (itemArticleStock.IdCountryGroup != null)
                            pickingMaterials.IdCountryGroup = itemArticleStock.IdCountryGroup.Value;

                        ////Add in otSameReferenceList
                        //OtItemSameReference otItemSameReference = new OtItemSameReference();
                        //otItemSameReference.IdArticle = pickingMaterials.IdArticle;
                        //otItemSameReference.IdWarehouseDeliveryNoteItem = pickingMaterials.IdWareHouseDeliveryNoteItem;
                        //otItemSameReference.ArticleCurrentStock = pickingMaterials.ArticleCurrentStock;
                        //otItemSameReference.Qty = pickingMaterials.DownloadQuantity;
                        //otItemSameReference.IdWarehouseLocation = pickingMaterials.WarehouseLocation.IdWarehouseLocation;
                        //otItemSameReferences.Add(otItemSameReference);

                        otItem.PickingMaterialsList.Add(pickingMaterials);

                        //GetTotalArticleDownloadDetailByOtItem(connectionString, 1800, 35259);

                    }
                    catch (Exception ex)
                    {
                        Log4NetLogger.Logger.Log(string.Format("Error FillPickingMaterialDisbaledFIFO_V2034(IdArticle-{0}, idWarehouse-{1}). ErrorMessage- {2}", otItem.RevisionItem.WarehouseProduct.Article.IdArticle, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                        throw;
                    }
                }
                #endregion

            }
        }


        public List<OtItem> GetRemainingOtItemsByIdOtDisbaledFIFO_V2034(Int64 idOt, Warehouses warehouse, string ArticleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OtItem> otItems = new List<OtItem>();
            List<OtItemSameReference> OtItemSameReferences = new List<OtItemSameReference>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetRemainingOtItemsByIdOt", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOt", idOt);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OtItem otItem = new OtItem();

                            otItem.IdOT = idOt;

                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);



                            otItem.IsBatch = Convert.ToByte(otItemReader["IsBatch"]);

                            if (otItemReader["AttachedFiles"] != DBNull.Value)
                                otItem.AttachedFiles = Convert.ToString(otItemReader["AttachedFiles"]);

                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);
                                otItem.RevisionItem.Quantity = Convert.ToInt64(otItemReader["Quantity"]);
                                otItem.RevisionItem.UnitPrice = Convert.ToDecimal(otItemReader["UnitPrice"]);

                                if (otItemReader["CustomerCommentOT"] != DBNull.Value)
                                    otItem.RevisionItem.InternalComment = Convert.ToString(otItemReader["CustomerCommentOT"]);

                                if (otItemReader["CustomerCommentRevision"] != DBNull.Value)
                                    otItem.RevisionItem.CustomerComment = Convert.ToString(otItemReader["CustomerCommentRevision"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);

                                if (otItemReader["WpDescription"] != DBNull.Value)
                                    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["ArticleDescription"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["ArticleDescription"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    if (otItemReader["UploadedIn"] != DBNull.Value)
                                        article.UploadedIn = Convert.ToDateTime(otItemReader["UploadedIn"]);

                                    if (otItemReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                        article.IdWareHouseDeliveryNoteItem = Convert.ToInt64(otItemReader["IdWareHouseDeliveryNoteItem"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    article.MyWarehouse = new MyWarehouse();

                                    if (otItemReader["MinimumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MinimumStock"]);

                                    if (otItemReader["MaximumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MaximumStock"]);

                                    if (otItemReader["CurrentStock"] != DBNull.Value)
                                        article.MyWarehouse.CurrentStock = Convert.ToInt64(otItemReader["CurrentStock"]);


                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);

                                    otItem.Status = new ItemOTStatusType();
                                    otItem.Status.IdItemOtStatus = otItem.IdItemOtStatus;
                                    otItem.Status.Name = Convert.ToString(otItemReader["Status"]);
                                }

                                if (otItemReader["AssignedTo"] != DBNull.Value)
                                {
                                    otItem.AssignedTo = Convert.ToInt32(otItemReader["AssignedTo"]);

                                    otItem.AssignedToUser = new People();
                                    otItem.AssignedToUser.Name = Convert.ToString(otItemReader["AssignedName"]);
                                    otItem.AssignedToUser.Surname = Convert.ToString(otItemReader["AssignedSurname"]);
                                }

                                if (otItemReader["DownloadedQty"] != DBNull.Value)
                                    otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otItemReader["DownloadedQty"]);

                                if (otItemReader["RemainingQty"] != DBNull.Value)
                                    otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otItemReader["RemainingQty"]);

                                if (otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;


                                List<OtItem> decomposedOtItems = GetArticlesForDecompositionScanDisabledFIFO(connectionString, idOt, warehouse.IdWarehouse, otItem, ArticleVisualAidsPath, OtItemSameReferences, otItem.RevisionItem.WarehouseProduct.Article.IdArticleType);

                                //if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                //    otItems.AddRange(decomposedOtItems);



                                if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                {
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    otItem.ArticleDecomposedList = decomposedOtItems;
                                }


                                FillPickingMaterialDisbaledFIFO_V2034(otItem, warehouse, ArticleVisualAidsPath, otItems);
                            }

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRemainingOtItemsByIdOtDisbaledFIFO_V2034(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetRemainingOtItemsByIdOtDisbaledFIFO_V2034().", category: Category.Info, priority: Priority.Low);
            return otItems;
        }


        public List<PendingStorageArticles> GetArticlesPendingStorage_V2034(Warehouses warehouse, string ArticleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<PendingStorageArticles> pendingStorageArticlesList = new List<PendingStorageArticles>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetArticlesPendingStorage_V2034", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                ArticlesCommand.CommandTimeout = 4000;

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {
                    while (articlesReader.Read())
                    {
                        try
                        {
                            PendingStorageArticles pendingStorageArticles = new PendingStorageArticles();

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pendingStorageArticles.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pendingStorageArticles.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWareHouseDeliveryNote"] != DBNull.Value)
                            {
                                pendingStorageArticles.IdWareHouseDeliveryNote = Convert.ToInt64(articlesReader["idWareHouseDeliveryNote"]);

                                pendingStorageArticles.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                pendingStorageArticles.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(articlesReader["idWareHouseDeliveryNote"]);

                                if (articlesReader["DeliveryDate"] != DBNull.Value)
                                    pendingStorageArticles.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(articlesReader["DeliveryDate"]);
                            }

                            if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                pendingStorageArticles.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                            if (articlesReader["IdArticle"] != DBNull.Value)
                                pendingStorageArticles.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["Quantity"] != DBNull.Value)
                                pendingStorageArticles.Quantity = Convert.ToInt32(articlesReader["Quantity"]);

                            if (articlesReader["MinimumStock"] != DBNull.Value)
                                pendingStorageArticles.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                            if (articlesReader["MaximumStock"] != DBNull.Value)
                                pendingStorageArticles.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                            if (articlesReader["CurrentStock"] != DBNull.Value)
                                pendingStorageArticles.CurrentStock = Convert.ToInt64(articlesReader["CurrentStock"].ToString());


                            if (articlesReader["Description"] != DBNull.Value)
                                pendingStorageArticles.Description = articlesReader["Description"].ToString();

                            if (articlesReader["Reference"] != DBNull.Value)
                                pendingStorageArticles.Reference = articlesReader["Reference"].ToString();

                            if (articlesReader["UnitPrice"] != DBNull.Value)
                                pendingStorageArticles.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"].ToString());

                            if (articlesReader["Price"] != DBNull.Value)
                                pendingStorageArticles.CostPrice = Convert.ToDouble(articlesReader["Price"].ToString());

                            if (articlesReader["UploadedIn"] != DBNull.Value)
                                pendingStorageArticles.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);

                            if (articlesReader["Code"] != DBNull.Value)
                                pendingStorageArticles.Code = articlesReader["Code"].ToString();

                            pendingStorageArticles.ArticleVisualAidsPath = ArticleVisualAidsPath;


                            if (articlesReader["ImagePath"] != DBNull.Value)
                            {
                                pendingStorageArticles.ImagePath = articlesReader["ImagePath"].ToString();

                                Article article = new Article();
                                article.ImagePath = pendingStorageArticles.ImagePath;
                                if (!string.IsNullOrEmpty(article.ImagePath))
                                    pendingStorageArticles.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                            }

                            if (articlesReader["FullName"] != DBNull.Value)
                                pendingStorageArticles.FullName = articlesReader["FullName"].ToString();

                            if (articlesReader["IdCurrency"] != DBNull.Value)
                                pendingStorageArticles.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"].ToString());

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                pendingStorageArticles.WarehouseLocation = new WarehouseLocation();
                                pendingStorageArticles.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"].ToString());
                                if (articlesReader["Postion1"] != DBNull.Value)
                                    pendingStorageArticles.WarehouseLocation.FullName = Convert.ToString(articlesReader["Postion1"].ToString());
                            }


                            pendingStorageArticlesList.Add(pendingStorageArticles);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticlesPendingStorage_V2034(ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }

            return pendingStorageArticlesList;
        }

        public List<WarehouseLocation> GetAllWarehouseLocationById_V2034(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<WarehouseLocation> warehouseLocationList = new List<WarehouseLocation>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetAllWarehouseLocationById_V2034", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            WarehouseLocation warehouseLocation = new WarehouseLocation();

                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                                warehouseLocation.IdWarehouseLocation = Convert.ToInt32(reader["IdWarehouseLocation"]);

                            if (reader["IdWarehouse"] != DBNull.Value)
                                warehouseLocation.IdWarehouse = Convert.ToInt32(reader["IdWarehouse"]);

                            if (reader["Parent"] != DBNull.Value)
                                warehouseLocation.Parent = Convert.ToInt32(reader["Parent"]);

                            if (reader["Position"] != DBNull.Value)
                                warehouseLocation.Position = Convert.ToInt32(reader["Position"]);

                            if (reader["Name"] != DBNull.Value)
                                warehouseLocation.Name = Convert.ToString(reader["Name"]);

                            if (reader["FullName"] != DBNull.Value)
                                warehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                            if (reader["HtmlColor"] != DBNull.Value)
                                warehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                            if (reader["Latitude"] != DBNull.Value)
                                warehouseLocation.Latitude = Convert.ToDouble(reader["Latitude"]);

                            if (reader["Longitude"] != DBNull.Value)
                                warehouseLocation.Longitude = Convert.ToDouble(reader["Longitude"]);

                            if (reader["Height"] != DBNull.Value)
                                warehouseLocation.Height = Convert.ToDouble(reader["Height"]);

                            if (reader["Width"] != DBNull.Value)
                                warehouseLocation.Width = Convert.ToDouble(reader["Width"]);

                            warehouseLocationList.Add(warehouseLocation);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetAllWarehouseLocationById_V2034(). idWarehouse-{0} ErrorMessage- {1}", warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }
            return warehouseLocationList;
        }


        public string GetZoneByIdArticle_V2034(Warehouses warehouse, Int64 idArticle)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            string zone = null;

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand poCommand = new MySqlCommand("WMS_GetZone_V2034", mySqlConnection);
                poCommand.CommandType = CommandType.StoredProcedure;
                poCommand.Parameters.AddWithValue("_IdArticle", idArticle);
                poCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader reader = poCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        try
                        {
                            zone = reader["FullName"].ToString();
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetZoneByIdArticle_V2034(idArticle-{0}). ErrorMessage-{1}", idArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                    else
                    {
                        zone = "";
                    }
                }
            }
            return zone;
        }

        public List<WarehouseLocation> GetIsLeafWarehouseLocations_V2034(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            List<WarehouseLocation> warehouseLocations = new List<WarehouseLocation>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("WMS_GetIsLeafWarehouseLocations_V2034", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            WarehouseLocation warehouseLocation = new WarehouseLocation();

                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                                warehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                            if (reader["IdWarehouse"] != DBNull.Value)
                                warehouseLocation.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                            warehouseLocation.Name = Convert.ToString(reader["Name"]);

                            if (reader["Parent"] != DBNull.Value)
                                warehouseLocation.Parent = Convert.ToInt64(reader["Parent"]);

                            if (reader["Position"] != DBNull.Value)
                                warehouseLocation.Position = Convert.ToInt64(reader["Position"]);

                            if (reader["FullName"] != DBNull.Value)
                                warehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                            if (reader["IsLead"] != DBNull.Value)
                                warehouseLocation.IsLead = Convert.ToSByte(reader["IsLead"]);

                            if (reader["HtmlColor"] != DBNull.Value)
                                warehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                            if (reader["InUse"] != DBNull.Value)
                                warehouseLocation.InUse = Convert.ToBoolean(reader["InUse"]);

                            if (reader["IdDirection"] != DBNull.Value)
                            {
                                warehouseLocation.IdDirection = Convert.ToInt32(reader["IdDirection"]);

                                warehouseLocation.Direction = new LookupValue();
                                warehouseLocation.Direction.IdLookupValue = Convert.ToInt32(reader["IdDirection"]);
                                warehouseLocation.Direction.Value = Convert.ToString(reader["Value"]);
                                warehouseLocation.Direction.HtmlColor = Convert.ToString(reader["DirectionHtmlColor"]);
                                if (reader["IdImage"] != DBNull.Value)
                                    warehouseLocation.Direction.IdImage = Convert.ToInt64(reader["IdImage"]);
                            }
                            if (reader["Width"] != DBNull.Value)
                                warehouseLocation.Width = Convert.ToDouble(reader["Width"]);
                            if (reader["Height"] != DBNull.Value)
                                warehouseLocation.Height = Convert.ToDouble(reader["Height"]);
                            if (reader["FileName"] != DBNull.Value)
                                warehouseLocation.FileName = Convert.ToString(reader["FileName"]);
                            if (reader["Latitude"] != DBNull.Value)
                                warehouseLocation.Latitude = Convert.ToDouble(reader["Latitude"]);
                            if (reader["Longitude"] != DBNull.Value)
                                warehouseLocation.Longitude = Convert.ToDouble(reader["Longitude"]);

                            warehouseLocations.Add(warehouseLocation);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetIsLeafWarehouseLocations_V2034(IdWarehouse-{0}). ErrorMessage-{1}", warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return warehouseLocations;
        }

        public List<LocationRefill> GetRefillToList_V2034(Warehouses warehouse)
        {
            List<LocationRefill> locationRefills = new List<LocationRefill>();

            string connectionString = warehouse.Company.ConnectPlantConstr;

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("WMS_GetRefillToList_V2034", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);


                using (MySqlDataReader dNReader = concommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        try
                        {
                            LocationRefill locationRefill = new LocationRefill();
                            if (dNReader["IdWarehouseLocation"] != DBNull.Value)
                                locationRefill.IdWarehouseLocation = Convert.ToInt64(dNReader["IdWarehouseLocation"]);
                            if (dNReader["Position"] != DBNull.Value)
                                locationRefill.Position = Convert.ToInt64(dNReader["Position"]);

                            if (dNReader["IdArticle"] != DBNull.Value)
                                locationRefill.IdArticle = Convert.ToInt32(dNReader["IdArticle"]);

                            if (dNReader["MinimumStock"] != DBNull.Value)
                                locationRefill.MinimumStock = Convert.ToInt64(dNReader["MinimumStock"]);

                            if (dNReader["FullName"] != DBNull.Value)
                                locationRefill.FullName = Convert.ToString(dNReader["FullName"]);

                            if (dNReader["CurrentStock"] != DBNull.Value)
                                locationRefill.CurrenStock = Convert.ToInt64(dNReader["CurrentStock"]);

                            if (dNReader["MaximumStock"] != DBNull.Value)
                                locationRefill.MaximumStock = Convert.ToInt64(dNReader["MaximumStock"]);

                            locationRefills.Add(locationRefill);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRefillToList_V2034(IdWarehouse-{0}). ErrorMessage-{1}", warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return locationRefills;
        }


        public LocationRefill GetArticleWarehouseLocation_V2034(Warehouses warehouse, Int32 idArticle, Int64 position)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            LocationRefill locationRefill = new LocationRefill();
            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("WMS_GetarticleWarehouseLocation_V2034", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdArticle", idArticle);
                concommand.Parameters.AddWithValue("_Position", position);
                concommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader dNReader = concommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {

                        if (dNReader["IdWarehouseLocation"] != DBNull.Value)
                            locationRefill.IdWarehouseLocation = Convert.ToInt64(dNReader["IdWarehouseLocation"]);
                        if (dNReader["Position"] != DBNull.Value)
                            locationRefill.Position = Convert.ToInt64(dNReader["Position"]);

                        if (dNReader["IdArticle"] != DBNull.Value)
                            locationRefill.IdArticle = Convert.ToInt32(dNReader["IdArticle"]);

                        if (dNReader["MinimumStock"] != DBNull.Value)
                            locationRefill.MinimumStock = Convert.ToInt64(dNReader["MinimumStock"]);

                        if (dNReader["FullName"] != DBNull.Value)
                            locationRefill.FullName = Convert.ToString(dNReader["FullName"]);

                    }
                }
            }

            return locationRefill;
        }


        public List<TransferMaterials> GetRefillMaterialDetails_V2034(Warehouses warehouse, string fromLocationName, string toLocationName, string ArticleVisualAidsPath, LocationRefill toLocationRefill)
        {
            List<TransferMaterials> transferMaterialsList = new List<TransferMaterials>();
            string connectionString = warehouse.Company.ConnectPlantConstr;

            Int64 remainingQTY = 0;
            if (toLocationRefill != null)
            {
                if (toLocationRefill.MaximumStock != 0)
                    remainingQTY = toLocationRefill.MaximumStock - toLocationRefill.CurrenStock;
            }


            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetRefillMaterialDetails_V2034", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_FromLocationName", fromLocationName);
                ArticlesCommand.Parameters.AddWithValue("_ToLocationName", toLocationName);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {
                    while (articlesReader.Read())
                    {

                        try
                        {
                            if (toLocationRefill != null && toLocationRefill.MaximumStock != 0)
                            {
                                if (remainingQTY == 0)
                                    break;
                            }

                            TransferMaterials transferMaterial = new TransferMaterials();

                            if (articlesReader["IdArticle"] != DBNull.Value)
                            {
                                transferMaterial.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);
                                transferMaterial.Article = new Article();
                                transferMaterial.Article.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);
                                if (articlesReader["Reference"] != DBNull.Value)
                                    transferMaterial.Article.Reference = articlesReader["Reference"].ToString();

                                transferMaterial.Article.MyWarehouse = new MyWarehouse();

                                if (articlesReader["WarehouseMinStock"] != DBNull.Value)
                                    transferMaterial.Article.MyWarehouse.MinimumStock = Convert.ToInt64(articlesReader["WarehouseMinStock"]);

                                if (articlesReader["WarehouseMaxStock"] != DBNull.Value)
                                    transferMaterial.Article.MyWarehouse.MaximumStock = Convert.ToInt64(articlesReader["WarehouseMaxStock"]);

                            }


                            if (articlesReader["Reference"] != DBNull.Value)
                                transferMaterial.Reference = articlesReader["Reference"].ToString();

                            //if (articlesReader["CurrentStock"] != DBNull.Value)
                            //    transferMaterial.CurrentStock = Convert.ToInt64(articlesReader["CurrentStock"]);

                            if (articlesReader["costprice"] != DBNull.Value)
                                transferMaterial.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                            if (articlesReader["UnitPrice"] != DBNull.Value)
                                transferMaterial.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                            if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                transferMaterial.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                transferMaterial.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (toLocationRefill != null && toLocationRefill.MaximumStock != 0)
                            {
                                if (articlesReader["Quantity"] != DBNull.Value)
                                {
                                    transferMaterial.Quantity = Convert.ToInt32(articlesReader["Quantity"]);
                                    if (transferMaterial.Quantity > remainingQTY)
                                    {
                                        transferMaterial.Quantity = remainingQTY;
                                        remainingQTY = 0;
                                    }
                                    else
                                    {
                                        remainingQTY = remainingQTY - transferMaterial.Quantity;
                                    }
                                }
                            }

                            else
                            {
                                if (articlesReader["Quantity"] != DBNull.Value)
                                {
                                    transferMaterial.Quantity = Convert.ToInt32(articlesReader["Quantity"]);
                                }
                            }

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                transferMaterial.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                transferMaterial.LocationFullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["Description"] != DBNull.Value)
                                transferMaterial.Description = articlesReader["Description"].ToString();

                            transferMaterial.ArticleVisualAidsPath = ArticleVisualAidsPath;
                            if (articlesReader["ImagePath"] != DBNull.Value)
                            {
                                transferMaterial.ImagePath = articlesReader["ImagePath"].ToString();
                                Article article = new Article();
                                article.ImagePath = transferMaterial.ImagePath;
                                transferMaterial.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                            }

                            //if (articlesReader["MinimumStock"] != DBNull.Value)
                            //    transferMaterial.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                            //if (articlesReader["MaximumStock"] != DBNull.Value)
                            //    transferMaterial.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                            if (articlesReader["UploadedIn"] != DBNull.Value)
                                transferMaterial.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);

                            if (articlesReader["IdCurrency"] != DBNull.Value)
                                transferMaterial.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                            if (articlesReader["DeliveryNoteCode"] != DBNull.Value)
                            {
                                transferMaterial.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                transferMaterial.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryNoteCode"]);
                            }


                            transferMaterialsList.Add(transferMaterial);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRefillMaterialDetails_V2034(FromLocationName-{0}, idWarehouse-{1}). ErrorMessage- {2}", fromLocationName, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }
            return transferMaterialsList;
        }


        public List<WarehouseLocation> GetWarehouseLocationToPlaceArticle_V2034(Warehouses warehouse, string reference)
        {
            List<WarehouseLocation> warehouseLocationLst = new List<WarehouseLocation>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetWarehouseLocationToPlaceArticle_V2034", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                    mySqlCommand.Parameters.AddWithValue("_Reference", reference);
                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            WarehouseLocation warehouseLocation = new WarehouseLocation();
                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                                warehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                            if (reader["FullName"] != DBNull.Value)
                                warehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                            if (reader["qty"] != DBNull.Value)
                                warehouseLocation.Quantity = Convert.ToInt64(reader["qty"]);

                            warehouseLocationLst.Add(warehouseLocation);

                        }

                    }
                    mySqlConnection.Close();
                }
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetWarehouseLocationToPlaceArticle_V2034(idWarehouse-{0}, reference-{1}). ErrorMessage- {2}", warehouse.IdWarehouse, reference, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return warehouseLocationLst;
        }


        public List<LocationRefill> GetRefillToListByFullName_V2034(Warehouses warehouse, string fullName)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            List<LocationRefill> locationRefills = new List<LocationRefill>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("WMS_GetRefillToListByFullName_V2034", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                concommand.Parameters.AddWithValue("_FullName", fullName);


                using (MySqlDataReader dNReader = concommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        try
                        {
                            LocationRefill locationRefill = new LocationRefill();
                            if (dNReader["IdWarehouseLocation"] != DBNull.Value)
                                locationRefill.IdWarehouseLocation = Convert.ToInt64(dNReader["IdWarehouseLocation"]);
                            if (dNReader["Position"] != DBNull.Value)
                                locationRefill.Position = Convert.ToInt64(dNReader["Position"]);

                            if (dNReader["IdArticle"] != DBNull.Value)
                                locationRefill.IdArticle = Convert.ToInt32(dNReader["IdArticle"]);

                            if (dNReader["MinimumStock"] != DBNull.Value)
                                locationRefill.MinimumStock = Convert.ToInt64(dNReader["MinimumStock"]);

                            if (dNReader["FullName"] != DBNull.Value)
                                locationRefill.FullName = Convert.ToString(dNReader["FullName"]);

                            if (dNReader["CurrentStock"] != DBNull.Value)
                                locationRefill.CurrenStock = Convert.ToInt64(dNReader["CurrentStock"]);

                            if (dNReader["MaximumStock"] != DBNull.Value)
                                locationRefill.MaximumStock = Convert.ToInt64(dNReader["MaximumStock"]);

                            locationRefills.Add(locationRefill);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRefillToListByFullName_V2034(idWarehouse-{0}, fullName-{1}). ErrorMessage- {2}", warehouse.IdWarehouse, fullName, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return locationRefills;
        }


        public List<PickingMaterialsSC> GetPickingItemsForSupplierComplaintItemArticlesAndLocation_V2034(Warehouses warehouse, string IdArticles, Int64 IdWarehouseLocation)
        {

            string connectionString = warehouse.Company.ConnectPlantConstr;

            List<PickingMaterialsSC> pickingMaterialForSCIList = new List<PickingMaterialsSC>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetPickingItemsForSCIArticlesAndLocation_V2034", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticles", IdArticles);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouseLocation", IdWarehouseLocation);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            PickingMaterialsSC pickingMaterialSCI = new PickingMaterialsSC();

                            //if (reader["IdArticleStock"] != DBNull.Value)
                            //    pickingMaterialSCI.IdArticleStock = Convert.ToInt64(reader["IdArticleStock"]);

                            if (reader["IdArticle"] != DBNull.Value)
                                pickingMaterialSCI.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                            if (reader["Reference"] != DBNull.Value)
                                pickingMaterialSCI.Reference = Convert.ToString(reader["Reference"]);

                            if (reader["Description"] != DBNull.Value)
                                pickingMaterialSCI.Description = Convert.ToString(reader["Description"]);

                            if (reader["RegisterSerialNumber"] != DBNull.Value)
                                pickingMaterialSCI.RegisterSerialNumber = Convert.ToByte(reader["RegisterSerialNumber"]);

                            if (reader["Quantity"] != DBNull.Value)
                                pickingMaterialSCI.DownloadQuantity = Convert.ToInt64(reader["Quantity"]);

                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterialSCI.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                            if (reader["IdWarehouse"] != DBNull.Value)
                                pickingMaterialSCI.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                            if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                pickingMaterialSCI.IdWareHouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);

                            if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                            {
                                pickingMaterialSCI.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                pickingMaterialSCI.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["idWarehouseDeliveryNote"]);

                                if (reader["Code"] != DBNull.Value)
                                    pickingMaterialSCI.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);

                                if (reader["DeliveryDate"] != DBNull.Value)
                                    pickingMaterialSCI.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                            }

                            if (reader["idWarehouseProductComponent"] != DBNull.Value)
                                pickingMaterialSCI.IdWarehouseProductComponent = Convert.ToInt64(reader["idWarehouseProductComponent"]);

                            if (reader["IdSupplierComplaintItem"] != DBNull.Value)
                                pickingMaterialSCI.IdSupplierComplaintItem = Convert.ToInt64(reader["IdSupplierComplaintItem"]);

                            if (reader["Comments"] != DBNull.Value)
                                pickingMaterialSCI.Comments = Convert.ToString(reader["Comments"]);

                            if (reader["UploadedIn"] != DBNull.Value)
                                pickingMaterialSCI.UploadedIn = Convert.ToDateTime(reader["UploadedIn"]);

                            if (reader["UnitPrice"] != DBNull.Value)
                                pickingMaterialSCI.UnitPrice = Convert.ToDouble(reader["UnitPrice"]);

                            if (reader["costprice"] != DBNull.Value)
                                pickingMaterialSCI.CostPrice = Convert.ToDouble(reader["costprice"]);

                            if (reader["MinimumStock"] != DBNull.Value)
                                pickingMaterialSCI.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);

                            if (reader["MaximumStock"] != DBNull.Value)
                                pickingMaterialSCI.MaximumStock = Convert.ToInt64(reader["MaximumStock"]);

                            if (reader["idCurrency"] != DBNull.Value)
                                pickingMaterialSCI.IdCurrency = Convert.ToInt16(reader["idCurrency"]);

                            pickingMaterialForSCIList.Add(pickingMaterialSCI);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPickingItemsForSupplierComplaintItemArticlesAndLocation_V2034(idWarehouse-{0}). ErrorMessage- {1}", warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return pickingMaterialForSCIList;
        }


        public ArticleWarehouseLocations GetAVGStockByIdArticle_V2034(Int32 IdArticle, Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            ArticleWarehouseLocations articleWarehouseLocation = new ArticleWarehouseLocations();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetAVGStockByIdArticle_V2034", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", IdArticle);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        if (reader["AvgStock"] != DBNull.Value)
                            articleWarehouseLocation.AvgStock = Convert.ToDecimal(reader["AvgStock"]);

                        if (reader["IdArticle"] != DBNull.Value)
                            articleWarehouseLocation.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                        if (reader["articleStock"] != DBNull.Value)
                            articleWarehouseLocation.ArticleStockForAllLocation = Convert.ToInt64(reader["articleStock"]);

                    }
                }
            }

            return articleWarehouseLocation;
        }


        public List<PickingMaterials> GetArticleStockDetailForRefund_V2034(Warehouses warehouse, Int64 idOT, string articleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<PickingMaterials> PickingMaterialsList = new List<PickingMaterials>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetArticleStockDetailForRefund_V2034", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdOT", idOT);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {


                    while (articlesReader.Read())
                    {
                        try
                        {

                            PickingMaterials pickingMaterials = new PickingMaterials();

                            if (articlesReader["IdArticle"] != DBNull.Value)
                                pickingMaterials.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            pickingMaterials.Article = new Article();
                            pickingMaterials.Article.IdArticle = pickingMaterials.IdArticle;
                            pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                            pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = pickingMaterials.IdArticle;

                            if (articlesReader["awlMinimumStock"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);

                            if (articlesReader["awlMaximumStock"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["IdOtItem"] != DBNull.Value)
                                pickingMaterials.IdOtitem = Convert.ToInt64(articlesReader["IdOtItem"]);

                            if (articlesReader["IdRevisionItem"] != DBNull.Value)
                            {
                                pickingMaterials.IdRevisionItem = Convert.ToInt64(articlesReader["IdRevisionItem"]);

                                pickingMaterials.RevisionItem = new RevisionItem();
                                pickingMaterials.RevisionItem.IdRevisionItem = pickingMaterials.IdRevisionItem;

                                if (articlesReader["NumItem"] != DBNull.Value)
                                {
                                    pickingMaterials.RevisionItem.NumItem = Convert.ToString(articlesReader["NumItem"]);
                                }


                                if (articlesReader["Quantity"] != DBNull.Value)
                                    pickingMaterials.RevisionItem.Quantity = Convert.ToDecimal(articlesReader["Quantity"]);
                                if (articlesReader["IdProduct"] != DBNull.Value)
                                    pickingMaterials.RevisionItem.IdProduct = Convert.ToInt64(articlesReader["IdProduct"]);
                            }



                            if (articlesReader["idWarehouseProductComponent"] != DBNull.Value)
                            {
                                pickingMaterials.IdWarehouseProductComponent = Convert.ToInt64(articlesReader["idWarehouseProductComponent"]);
                                if (articlesReader["ProductComponentNumber"] != DBNull.Value)
                                    pickingMaterials.ProductComponentNumber = Convert.ToString(articlesReader["ProductComponentNumber"]);
                            }


                            if (articlesReader["Reference"] != DBNull.Value)
                                pickingMaterials.Reference = Convert.ToString(articlesReader["Reference"]);

                            if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                                pickingMaterials.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                            if (articlesReader["CurrentStock"] != DBNull.Value)
                                pickingMaterials.CurrentStock = Convert.ToInt64(articlesReader["CurrentStock"]);

                            if (articlesReader["costprice"] != DBNull.Value)
                                pickingMaterials.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                            if (articlesReader["UnitPrice"] != DBNull.Value)
                                pickingMaterials.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            {
                                pickingMaterials.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);


                                pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                                if (pickingMaterials.RevisionItem != null)
                                {
                                    pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbersForRefund(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, Convert.ToInt64(articlesReader["IdWarehouse"]), pickingMaterials.RevisionItem.IdProduct));
                                }
                                else
                                {
                                    pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbersForRefund(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, Convert.ToInt64(articlesReader["IdWarehouse"]), pickingMaterials.RevisionItem.IdProduct));
                                }

                            }


                            //if (articlesReader["IdArticleWarehouseLocation"] != DBNull.Value)
                            //    pickingMaterials.IdArticleWarehouseLocation = Convert.ToInt64(articlesReader["IdArticleWarehouseLocation"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.LocationFullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingMaterials.Description = articlesReader["Description"].ToString();

                            if (articlesReader["ImagePath"] != DBNull.Value)
                            {
                                pickingMaterials.ImagePath = articlesReader["ImagePath"].ToString();
                                Article article = new Article();
                                article.ImagePath = pickingMaterials.ImagePath;
                                pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, article);
                            }


                            if (articlesReader["MinimumStock"] != DBNull.Value)
                                pickingMaterials.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                            if (articlesReader["MaximumStock"] != DBNull.Value)
                                pickingMaterials.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                            pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                            if (articlesReader["UploadedIn"] != DBNull.Value)
                            {
                                pickingMaterials.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);
                                pickingMaterials.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(articlesReader["UploadedIn"]);
                            }

                            if (articlesReader["DeliveryCode"] != DBNull.Value)
                                pickingMaterials.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);

                            if (articlesReader["IdCurrency"] != DBNull.Value)
                                pickingMaterials.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                            if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                                pickingMaterials.DownloadQuantity = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                            pickingMaterials.WarehouseLocation = new WarehouseLocation();

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.HtmlColor = articlesReader["HtmlColor"].ToString();

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingMaterials.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                            pickingMaterials.PartNumberCode = GetPartNumberCode(pickingMaterials.IdOtitem, connectionString);

                            if (articlesReader["IdCountryGroup"] != DBNull.Value)
                                pickingMaterials.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);



                            PickingMaterialsList.Add(pickingMaterials);


                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleStockDetailForRefund_V2034(IdOT-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOT, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }
            return PickingMaterialsList;
        }


        public List<PickingMaterials> FillPickingMaterialByIdWarehouselocation_V2034(OtItem otItem, Warehouses warehouse, Int64 idWarehouseLocation, string ArticleVisualAidsPath, List<OtItem> otitems, List<OtItemSameReference> otItemSameReferences)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<PickingMaterials> pickingMaterialsList = new List<PickingMaterials>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetArticlesStockDetailsByIdWarehouseLocation_V2034", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", otItem.RevisionItem.WarehouseProduct.Article.IdArticle);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouseLocation", idWarehouseLocation);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {
                    Int64 remainingQty = otItem.RevisionItem.RemainingQuantity; // download Quantity.
                    while (articlesReader.Read())
                    {
                        try
                        {

                            if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])))
                            {
                                Int64 articleCurrentStockRem = 0;
                                articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])).Sum(i => i.Qty));
                                if (articleCurrentStockRem == 0)
                                    continue;
                                else
                                    if (remainingQty == 0)
                                    return pickingMaterialsList;
                            }
                            else
                            {
                                if (remainingQty == 0)
                                    return pickingMaterialsList;
                            }



                            PickingMaterials pickingMaterials = new PickingMaterials();

                            pickingMaterials.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                            pickingMaterials.Article = new Article();
                            pickingMaterials.Article.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;
                            pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                            pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;
                            if (articlesReader["awlMinimumStock"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);
                            if (articlesReader["awlMaximumStock"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);
                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            pickingMaterials.IdOtitem = otItem.IdOTItem;

                            pickingMaterials.IdRevisionItem = otItem.IdRevisionItem;
                            pickingMaterials.RevisionItem = new RevisionItem();
                            pickingMaterials.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                            if (otItem.RevisionItem != null)
                                pickingMaterials.RevisionItem.NumItem = otItem.RevisionItem.NumItem;

                            if (otItem.RevisionItem != null)
                                pickingMaterials.RevisionItem.Quantity = otItem.RevisionItem.Quantity;

                            if (otItem.RevisionItem != null)
                                if (otItem.RevisionItem.WarehouseProduct != null)
                                    pickingMaterials.IdWarehouseProductComponent = otItem.RevisionItem.WarehouseProduct.IdComponent;

                            if (articlesReader["Reference"] != DBNull.Value)
                                pickingMaterials.Reference = Convert.ToString(articlesReader["Reference"]);

                            if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                                pickingMaterials.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                            if (articlesReader["CurrentStock"] != DBNull.Value)
                                pickingMaterials.CurrentStock = Convert.ToInt64(articlesReader["CurrentStock"]);

                            if (articlesReader["costprice"] != DBNull.Value)
                                pickingMaterials.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                            if (articlesReader["UnitPrice"] != DBNull.Value)
                                pickingMaterials.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            {
                                pickingMaterials.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);


                                pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                                pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbers(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, Convert.ToInt64(articlesReader["IdWarehouse"])));
                            }



                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.LocationFullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingMaterials.Description = articlesReader["Description"].ToString();

                            if (articlesReader["ImagePath"] != DBNull.Value)
                            {
                                pickingMaterials.ImagePath = articlesReader["ImagePath"].ToString();
                                Article article = new Article();
                                article.ImagePath = pickingMaterials.ImagePath;
                                pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                            }


                            if (articlesReader["MinimumStock"] != DBNull.Value)
                                pickingMaterials.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                            if (articlesReader["MaximumStock"] != DBNull.Value)
                                pickingMaterials.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                            pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                            if (articlesReader["UploadedIn"] != DBNull.Value)
                            {
                                pickingMaterials.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);
                                pickingMaterials.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(articlesReader["UploadedIn"]);
                            }

                            if (articlesReader["DeliveryCode"] != DBNull.Value)
                                pickingMaterials.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);

                            if (articlesReader["IdCurrency"] != DBNull.Value)
                                pickingMaterials.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                            if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])))
                            {
                                Int64 articleCurrentStockRem = 0;
                                articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]) && oisr.IdWarehouseLocation == Convert.ToInt64(articlesReader["IdWarehouseLocation"])).Sum(i => i.Qty));
                                if (articleCurrentStockRem > 0)
                                {
                                    if (remainingQty > 0 && articleCurrentStockRem > 0)
                                    {
                                        if (articleCurrentStockRem > remainingQty)
                                        {
                                            pickingMaterials.DownloadQuantity = remainingQty;
                                            remainingQty = 0;
                                        }
                                        else
                                        {
                                            pickingMaterials.DownloadQuantity = articleCurrentStockRem;
                                            remainingQty = remainingQty - articleCurrentStockRem;
                                        }

                                    }
                                }
                                else
                                {
                                    if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                                    {
                                        if (pickingMaterials.ArticleCurrentStock > remainingQty)
                                        {
                                            pickingMaterials.DownloadQuantity = remainingQty;
                                            remainingQty = 0;
                                        }
                                        else
                                        {
                                            pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                                            remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                                        }

                                    }
                                }
                            }
                            else
                            {
                                if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                                {
                                    if (pickingMaterials.ArticleCurrentStock > remainingQty)
                                    {
                                        pickingMaterials.DownloadQuantity = remainingQty;
                                        remainingQty = 0;
                                    }
                                    else
                                    {
                                        pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                                        remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                                    }

                                }
                            }

                            pickingMaterials.WarehouseLocation = new WarehouseLocation();

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.HtmlColor = articlesReader["HtmlColor"].ToString();

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingMaterials.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                            pickingMaterials.PartNumberCode = GetPartNumberCode(otItem.IdOTItem, connectionString);

                            if (articlesReader["IdCountryGroup"] != DBNull.Value)
                                pickingMaterials.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);

                            //Add in otSameReferenceList
                            OtItemSameReference otItemSameReference = new OtItemSameReference();
                            otItemSameReference.IdArticle = pickingMaterials.IdArticle;
                            otItemSameReference.IdWarehouseDeliveryNoteItem = pickingMaterials.IdWareHouseDeliveryNoteItem;
                            otItemSameReference.ArticleCurrentStock = pickingMaterials.ArticleCurrentStock;
                            otItemSameReference.Qty = pickingMaterials.DownloadQuantity;
                            otItemSameReference.IdWarehouseLocation = pickingMaterials.WarehouseLocation.IdWarehouseLocation;
                            otItemSameReferences.Add(otItemSameReference);

                            pickingMaterialsList.Add(pickingMaterials);

                            //GetTotalArticleDownloadDetailByOtItem(connectionString, 1800, 35259);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error FillPickingMaterialByIdWarehouselocation_V2034(IdArticle-{0}, idWarehouse-{1}). ErrorMessage- {2}", otItem.RevisionItem.WarehouseProduct.Article.IdArticle, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }
            return pickingMaterialsList;
        }


        public List<PickingMaterials> GetRevisionItemDetails_V2034(Int64 idOt, Warehouses warehouse, Int64 idWarehouseLocation, string ArticleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<PickingMaterials> pickingMaterialList = new List<PickingMaterials>();
            List<OtItem> otItems = new List<OtItem>();
            List<OtItemSameReference> OtItemSameReferences = new List<OtItemSameReference>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetRevisionItemDetails", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOt", idOt);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                otItemCommand.Parameters.AddWithValue("_IdWarehouseLocation", idWarehouseLocation);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OtItem otItem = new OtItem();

                            otItem.IdOT = idOt;

                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);
                                otItem.RevisionItem.Quantity = Convert.ToInt64(otItemReader["Quantity"]);


                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["DownloadedQty"] != DBNull.Value)
                                    otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otItemReader["DownloadedQty"]);

                                if (otItemReader["RemainingQty"] != DBNull.Value)
                                    otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otItemReader["RemainingQty"]);

                                if (otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;


                                pickingMaterialList.AddRange(GetDecompositionArticleDetail_V2034(idOt, warehouse, idWarehouseLocation, otItem, ArticleVisualAidsPath, OtItemSameReferences, otItem.RevisionItem.WarehouseProduct.Article.IdArticleType));

                                pickingMaterialList.AddRange(FillPickingMaterialByIdWarehouselocation_V2034(otItem, warehouse, idWarehouseLocation, ArticleVisualAidsPath, otItems, OtItemSameReferences));
                            }

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRevisionItemDetails_V2034(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetRevisionItemDetails_V2034().", category: Category.Info, priority: Priority.Low);
            return pickingMaterialList;
        }


        public List<PickingMaterials> GetDecompositionArticleDetail_V2034(Int64 idOt, Warehouses warehouse, Int64 idWarehouseLocation, OtItem parentOtItem, string ArticleVisualAidsPath, List<OtItemSameReference> otItemSameReferences, Int64 idArticleType)
        {
            List<OtItem> otItems = new List<OtItem>();
            List<PickingMaterials> pickingMaterialsList = new List<PickingMaterials>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetDecompositionArticleDetail", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOTitem", parentOtItem.IdOTItem);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                otItemCommand.Parameters.AddWithValue("_IdWarehouseLocation", idWarehouseLocation);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            // keyId++;

                            OtItem otItem = new OtItem();
                            otItem.IdOT = idOt;
                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);



                                if (otItemReader["IdComponent"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otItemReader["IdComponent"]);
                                }


                                if (otItemReader["idParent"] != DBNull.Value)
                                {
                                    otItem.ParentId = Convert.ToInt32(otItemReader["idParent"]);
                                }

                                if (otItem.ParentId == -1)
                                {
                                    otItem.ParentId = parentOtItem.KeyId;
                                    otItem.RevisionItem.Quantity = parentOtItem.RevisionItem.Quantity * Convert.ToDecimal(otItemReader["Quantity"]);
                                }
                                else
                                {
                                    //OtItem otItem213 = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId);
                                    decimal qty = 0;
                                    if (otItems.Any(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId))
                                    {
                                        qty = otItems.Where(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).FirstOrDefault().RevisionItem.Quantity;
                                        otItem.RevisionItem.Quantity = qty * Convert.ToDecimal(otItemReader["Quantity"]);
                                        otItem.ParentId = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).KeyId;
                                    }


                                }

                                //if (otItemReader["WpDescription"] != DBNull.Value)
                                //    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);


                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }


                                int downloaded = GetOtItemDownloadedQuantity(connectionString, otItem.RevisionItem.WarehouseProduct.Article.IdArticle, otItem.IdOTItem, otItem.RevisionItem.WarehouseProduct.IdComponent, warehouse.IdWarehouse);


                                otItem.RevisionItem.DownloadedQuantity = downloaded;

                                otItem.RevisionItem.RemainingQuantity = ((Int64)otItem.RevisionItem.Quantity - downloaded);

                                //if ((Int64)otItem.RevisionItem.Quantity > 0)
                                //    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;
                            }
                            otItem.PickingMaterialsList = new List<PickingMaterials>();
                            if (idArticleType != 2)
                                pickingMaterialsList.AddRange(FillPickingMaterialByIdWarehouselocation_V2034(otItem, warehouse, idWarehouseLocation, ArticleVisualAidsPath, otItems, otItemSameReferences));

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetDecompositionArticleDetail_V2034(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }

            return pickingMaterialsList;
        }


        public List<ArticleWarehouseLocations> GetArticleWarehouseLocationStockByIdArticle_V2034(string connectionString, Int32 idArticle, Int64 idWarehouse)
        {
            List<ArticleWarehouseLocations> articleWarehouseLocationLst = new List<ArticleWarehouseLocations>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetArticleWarehouseLocationStockByIdArticle_V2034", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", idArticle);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ArticleWarehouseLocations articleWarehouseLocation = new ArticleWarehouseLocations();
                        try
                        {
                            if (reader["ArticleWLPostion"] != DBNull.Value)
                            {
                                articleWarehouseLocation.Position = Convert.ToInt64(reader["ArticleWLPostion"]);
                            }

                            articleWarehouseLocation.IdArticle = idArticle;

                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                articleWarehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);
                                articleWarehouseLocation.WarehouseLocation = new WarehouseLocation();
                                articleWarehouseLocation.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                                if (reader["Position"] != DBNull.Value)
                                    articleWarehouseLocation.WarehouseLocation.Position = Convert.ToInt64(reader["Position"]);

                                if (reader["FullName"] != DBNull.Value)
                                    articleWarehouseLocation.WarehouseLocation.FullName = Convert.ToString(reader["FullName"]);
                            }

                            if (reader["Qty"] != DBNull.Value)
                            {
                                articleWarehouseLocation.ArticlesStock = new ArticlesStock();

                                articleWarehouseLocation.ArticlesStock.IdWarehouseLocation = Convert.ToUInt64(reader["IdWarehouseLocation"]);
                                articleWarehouseLocation.ArticlesStock.Quantity = Convert.ToInt64(reader["Qty"]);
                            }

                            if (reader["MinimumStock"] != DBNull.Value)
                            {
                                articleWarehouseLocation.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);
                            }
                            if (reader["MaximumStock"] != DBNull.Value)
                            {
                                articleWarehouseLocation.MaximumStock = Convert.ToInt64(reader["MaximumStock"]);
                            }
                            articleWarehouseLocation.WarehouseDeliveryNotes = new List<WarehouseDeliveryNote>();

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleWarehouseLocationStockByIdArticle_V2034(). IdArticle- {0} IdWarehouseLocation-{1}  ErrorMessage- {2}", articleWarehouseLocation.IdArticle, articleWarehouseLocation.IdWarehouseLocation, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                        articleWarehouseLocationLst.Add(articleWarehouseLocation);
                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                if (articleWarehouseLocationLst != null)
                                {
                                    if (articleWarehouseLocationLst.Any(i => i.IdWarehouseLocation == Convert.ToInt64(reader["IdWarehouseLocation"])))
                                    {
                                        ArticleWarehouseLocations articleWarehouseLocations = articleWarehouseLocationLst.Where(i => i.IdWarehouseLocation == Convert.ToInt64(reader["IdWarehouseLocation"])).FirstOrDefault();
                                        if (articleWarehouseLocations != null)
                                        {
                                            WarehouseDeliveryNote warehouseDeliveryNote = new WarehouseDeliveryNote();
                                            if (reader["DeliveryDate"] != DBNull.Value)
                                                warehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                            if (reader["Code"] != DBNull.Value)
                                                warehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                            if (reader["Quantity"] != DBNull.Value)
                                                warehouseDeliveryNote.Quantity = Convert.ToInt64(reader["Quantity"]);
                                            if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                                                warehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["idWarehouseDeliveryNote"]);

                                            if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                            {
                                                warehouseDeliveryNote.WarehouseDeliveryNoteItems = new List<WarehouseDeliveryNoteItem>();
                                                WarehouseDeliveryNoteItem warehouseDeliveryNoteItem = new WarehouseDeliveryNoteItem();
                                                warehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);
                                                warehouseDeliveryNote.WarehouseDeliveryNoteItems.Add(warehouseDeliveryNoteItem);
                                            }


                                            warehouseDeliveryNote.MasterItem = articleWarehouseLocations;
                                            articleWarehouseLocations.WarehouseDeliveryNotes.Add(warehouseDeliveryNote);
                                        }
                                    }
                                }
                            }
                        }
                    }

                }
            }

            return articleWarehouseLocationLst;
        }

        public Article GetArticleDetailsByReference_V2034(string reference, string articleVisualAidsPath, Warehouses warehouse, DateTime? fromDate = null, DateTime? toDate = null)
        {
            Article article = new Article();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("article_GetArticleDetailsByReference", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_Reference", reference);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 8000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        try
                        {
                            if (reader["idArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(reader["idArticle"]);

                            if (reader["IdArticleCategory"] != DBNull.Value)
                            {
                                article.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory = new ArticleCategory();
                                article.ArticleCategory.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory.Name = Convert.ToString(reader["categoryName"]);
                                article.ArticleCategory.TaricCode = Convert.ToString(reader["TaricCode"]);
                            }

                            if (reader["ImagePath"] != DBNull.Value)
                            {
                                article.ImagePath = Convert.ToString(reader["ImagePath"]);

                                if (!string.IsNullOrEmpty(article.ImagePath))
                                    article.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, article);
                            }

                            if (reader["Reference"] != DBNull.Value)
                                article.Reference = reader["Reference"].ToString();

                            if (reader["IsOrientativeVisualAid"] != DBNull.Value)
                                article.IsOrientativeVisualAid = Convert.ToByte(reader["IsOrientativeVisualAid"]);

                            if (reader["IsGeneric"] != DBNull.Value)
                                article.IsGeneric = Convert.ToSByte(reader["IsGeneric"]);

                            if (reader["isObsolete"] != DBNull.Value)
                                article.IsObsolete = Convert.ToSByte(reader["isObsolete"]);

                            if (reader["isPublic"] != DBNull.Value)
                                article.IsPublic = Convert.ToSByte(reader["isPublic"]);

                            if (reader["publishOnWeb"] != DBNull.Value)
                                article.PublishOnWeb = Convert.ToSByte(reader["publishOnWeb"]);

                            if (reader["registerSerialNumber"] != DBNull.Value)
                                article.RegisterSerialNumber = Convert.ToByte(reader["registerSerialNumber"]);

                            if (reader["CreatedIn"] != DBNull.Value)
                                article.CreatedIn = Convert.ToDateTime(reader["CreatedIn"]);

                            if (reader["ModifiedIn"] != DBNull.Value)
                                article.ModifiedIn = Convert.ToDateTime(reader["ModifiedIn"]);

                            if (reader["description"] != DBNull.Value)
                                article.Description = Convert.ToString(reader["description"]);

                            if (reader["description_es"] != DBNull.Value)
                                article.Description_es = Convert.ToString(reader["description_es"]);

                            if (reader["description_fr"] != DBNull.Value)
                                article.Description_fr = Convert.ToString(reader["description_fr"]);

                            if (reader["description_pt"] != DBNull.Value)
                                article.Description_pt = Convert.ToString(reader["description_pt"]);

                            if (reader["description_ro"] != DBNull.Value)
                                article.Description_ro = Convert.ToString(reader["description_ro"]);

                            if (reader["description_ru"] != DBNull.Value)
                                article.Description_ru = Convert.ToString(reader["description_ru"]);

                            if (reader["description_zh"] != DBNull.Value)
                                article.Description_zh = Convert.ToString(reader["description_zh"]);

                            if (reader["idReplacementArticle"] != DBNull.Value)
                            {
                                article.IdReplacementArticle = Convert.ToInt32(reader["idReplacementArticle"]);
                                article.ReplacementArticle = Convert.ToString(reader["ReplacementArticle"]);
                            }

                            if (reader["isBatch"] != DBNull.Value)
                                article.IsBatch = Convert.ToByte(reader["isBatch"]);

                            if (reader["taric"] != DBNull.Value)
                                article.Taric = Convert.ToString(reader["taric"]);

                            if (reader["IdArticleType"] != DBNull.Value)
                            {
                                article.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                article.ArticlesType = new ArticleType();
                                article.ArticlesType.IdArticleType = Convert.ToInt64(reader["IdArticleType"]); ;
                            }


                            if (reader["Weight"] != DBNull.Value)
                                article.Weight = Convert.ToDecimal(reader["Weight"]);

                            if (reader["Width"] != DBNull.Value)
                                article.Width = (float)(reader["Width"]);

                            if (reader["Length"] != DBNull.Value)
                                article.Length = (float)(reader["Length"]);

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)(reader["Height"]);

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)(reader["Height"]);

                            if (reader["idCountry"] != DBNull.Value)
                            {
                                article.IdCountry = Convert.ToInt32(reader["idCountry"]);

                                article.Country = new Country();
                                article.Country.IdCountry = Convert.ToByte(reader["idCountry"]);
                                article.Country.Name = Convert.ToString(reader["CountryName"]);
                            }

                            article.MyWarehouse = new MyWarehouse();

                            if (reader["minimumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MinimumStock = Convert.ToInt64(reader["minimumStock"]);
                            }

                            if (reader["stock"] != DBNull.Value)
                            {
                                article.MyWarehouse.CurrentStock = Convert.ToInt64(reader["stock"]);
                            }

                            if (reader["maximumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MaximumStock = Convert.ToInt64(reader["maximumStock"]);
                            }

                            if (reader["idWareHouse"] != DBNull.Value)
                            {
                                article.MyWarehouse.IdWarehouse = Convert.ToInt64(reader["idWareHouse"]);
                            }

                            if (reader["location"] != DBNull.Value)
                            {
                                article.MyWarehouse.Location = Convert.ToString(reader["location"]);
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleDetailsByIdArticle(). Reference- {0} IdArticle-{1} ErrorMessage- {2}", reference, article.IdArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
                article.LstArticleBySupplier = new List<ArticleBySupplier>();
                article.LstArticleBySupplier = GetArticleSupplierDetailsByIdArticle(connectionString, article.IdArticle);

                article.LstArticleDecomposition = new List<ArticleDecomposition>();
                article.LstArticleDecomposition = GetArticleDeCompostionByIdArticle(connectionString, article.IdArticle);

                article.LstRelatedArticle = new List<RelatedArticle>();
                article.LstRelatedArticle = GetRelatedArticleDetailsByIdArticle(connectionString, article.IdArticle, warehouse.IdWarehouse);

                article.LstArticleDocument = new List<ArticleDocument>();
                article.LstArticleDocument = GetArticleAttachmentByIdArticle(connectionString, article.IdArticle);

                article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle_V2034(connectionString, article.IdArticle, warehouse.IdWarehouse);

                article.LstManufacturersByArticles = new List<ManufacturersByArticle>();
                article.LstManufacturersByArticles = GetManufacturers(connectionString, article.IdArticle);

                //if (fromDate != null && toDate != null)
                //{
                article.LstArticlesStock = new List<ArticlesStock>();
                article.LstArticlesStock = GetStockHistoryByIdArticle_V2033(connectionString, article.IdArticle, DateTime.Now, DateTime.Now, warehouse.IdWarehouse);
                // }


                article.LstArticleForecast = new List<ArticleForecast>();
                article.LstArticleForecast = GetArticleForecast(connectionString, article.IdArticle, warehouse.IdWarehouse);

            }

            return article;
        }


        public PendingStorageArticles GetArticleDetailByIdWarehouseDeliveryNoteItem_V2034(Warehouses warehouse, Int64 idWarehouseDeliveryNoteItem, string articleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            PendingStorageArticles pendingStorageArticle = null;

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetArticleDetailByIdWarehouseDeliveryNoteItem_V2034", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouseDeliveryNoteItem", idWarehouseDeliveryNoteItem);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.CommandTimeout = 6000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        if (reader.Read())
                        {
                            try
                            {
                                pendingStorageArticle = new PendingStorageArticles();

                                if (reader["IdArticle"] != DBNull.Value)
                                    pendingStorageArticle.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                if (reader["StockQty"] != DBNull.Value)
                                    pendingStorageArticle.Quantity = Convert.ToInt64(reader["StockQty"]);

                                if (reader["idCurrency"] != DBNull.Value)
                                    pendingStorageArticle.IdCurrency = Convert.ToInt16(reader["idCurrency"]);

                                if (reader["Price"] != DBNull.Value)
                                    pendingStorageArticle.CostPrice = Convert.ToDouble(reader["Price"]);

                                if (reader["UnitPrice"] != DBNull.Value)
                                    pendingStorageArticle.UnitPrice = Convert.ToDouble(reader["UnitPrice"]);

                                if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                    pendingStorageArticle.IdWareHouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);

                                if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                                {
                                    pendingStorageArticle.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                    pendingStorageArticle.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["IdWarehouseDeliveryNote"]);
                                    if (reader["Code"] != DBNull.Value)
                                        pendingStorageArticle.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                    if (reader["DeliveryDate"] != DBNull.Value)
                                        pendingStorageArticle.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                }

                                if (reader["Reference"] != DBNull.Value)
                                    pendingStorageArticle.Reference = Convert.ToString(reader["Reference"]);

                                if (reader["Description"] != DBNull.Value)
                                    pendingStorageArticle.Description = Convert.ToString(reader["Description"]);

                                if (reader["ImagePath"] != DBNull.Value)
                                {
                                    pendingStorageArticle.ImagePath = Convert.ToString(reader["ImagePath"]);
                                    pendingStorageArticle.ArticleImageInBytes = GetArticleImageInBytesByImagePath(articleVisualAidsPath, pendingStorageArticle.ImagePath);
                                }


                                if (reader["IdWarehouseLocation"] != DBNull.Value)
                                    pendingStorageArticle.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    pendingStorageArticle.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);



                                if (reader["WarehouseMinimumStock"] != DBNull.Value)
                                    pendingStorageArticle.MinimumStock = Convert.ToInt64(reader["WarehouseMinimumStock"]);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetArticleDetailByIdWarehouseDeliveryNoteItem() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetArticleDetailByIdWarehouseDeliveryNoteItem_V2034().", category: Category.Info, priority: Priority.Low);
                    return pendingStorageArticle;
                }


            }
        }

        public List<InventoryMaterial> GetInventoryArticleByIdWarehouseDeliveryNoteItem_V2034(Warehouses warehouse, Int64 idWarehouseDeliveryNoteItem, string articleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<InventoryMaterial> inventoryMaterials = new List<InventoryMaterial>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetInventoryArticleByIdWarehouseDeliveryNoteItem_V2034", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouseDeliveryNoteItem", idWarehouseDeliveryNoteItem);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.CommandTimeout = 6000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                InventoryMaterial inventoryMaterial = new InventoryMaterial();
                                if (reader["IdArticle"] != DBNull.Value)
                                    inventoryMaterial.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                if (reader["AvailableQty"] != DBNull.Value)
                                    inventoryMaterial.AvailableQty = Convert.ToInt64(reader["AvailableQty"]);

                                if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                    inventoryMaterial.IdWareHouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);


                                if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                                {
                                    inventoryMaterial.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                    inventoryMaterial.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["IdWarehouseDeliveryNote"]);
                                    if (reader["Code"] != DBNull.Value)
                                        inventoryMaterial.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                    if (reader["DeliveryDate"] != DBNull.Value)
                                        inventoryMaterial.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                }

                                if (reader["Reference"] != DBNull.Value)
                                    inventoryMaterial.Reference = Convert.ToString(reader["Reference"]);

                                if (reader["Description"] != DBNull.Value)
                                    inventoryMaterial.Description = Convert.ToString(reader["Description"]);

                                if (reader["ImagePath"] != DBNull.Value)
                                {
                                    inventoryMaterial.ImagePath = Convert.ToString(reader["ImagePath"]);
                                    inventoryMaterial.ArticleImageInBytes = GetArticleImageInBytesByImagePath(articleVisualAidsPath, inventoryMaterial.ImagePath);
                                }


                                if (reader["IdWarehouseLocation"] != DBNull.Value)
                                    inventoryMaterial.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    inventoryMaterial.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                                if (reader["ArticleWarehouseMinStock"] != DBNull.Value)
                                    inventoryMaterial.AwlMinimumStock = Convert.ToInt64(reader["ArticleWarehouseMinStock"]);

                                if (reader["WarehouseMinimumStock"] != DBNull.Value)
                                    inventoryMaterial.MinimumStock = Convert.ToInt64(reader["WarehouseMinimumStock"]);

                                if (reader["Price"] != DBNull.Value)
                                    inventoryMaterial.CostPrice = Convert.ToDouble(reader["Price"]);

                                if (reader["UnitPrice"] != DBNull.Value)
                                    inventoryMaterial.UnitPrice = Convert.ToDouble(reader["UnitPrice"]);

                                if (reader["IdOtItem"] != DBNull.Value)
                                    inventoryMaterial.IdOtitem = Convert.ToInt64(reader["IdOtItem"]);

                                if (reader["idCurrency"] != DBNull.Value)
                                    inventoryMaterial.IdCurrency = Convert.ToInt16(reader["idCurrency"]);

                                if (reader["idWarehouseProductComponent"] != DBNull.Value)
                                    inventoryMaterial.IdWarehouseProductComponent = Convert.ToInt64(reader["idWarehouseProductComponent"]);

                                inventoryMaterials.Add(inventoryMaterial);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetInventoryArticleByIdWarehouseDeliveryNoteItem_V2034() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetInventoryArticleByIdWarehouseDeliveryNoteItem_V2034().", category: Category.Info, priority: Priority.Low);
                    return inventoryMaterials;
                }


            }
        }


        public List<LocationRefill> GetRefillToListSortByStock_V2034(Warehouses warehouse)
        {
            List<LocationRefill> locationRefills = new List<LocationRefill>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("WMS_GetRefillToListSortByStock_V2034", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);


                using (MySqlDataReader dNReader = concommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        LocationRefill locationRefill = new LocationRefill();
                        if (dNReader["IdWarehouseLocation"] != DBNull.Value)
                            locationRefill.IdWarehouseLocation = Convert.ToInt64(dNReader["IdWarehouseLocation"]);
                        if (dNReader["Position"] != DBNull.Value)
                            locationRefill.Position = Convert.ToInt64(dNReader["Position"]);

                        if (dNReader["IdArticle"] != DBNull.Value)
                            locationRefill.IdArticle = Convert.ToInt32(dNReader["IdArticle"]);

                        if (dNReader["MinimumStock"] != DBNull.Value)
                            locationRefill.MinimumStock = Convert.ToInt64(dNReader["MinimumStock"]);

                        if (dNReader["FullName"] != DBNull.Value)
                            locationRefill.FullName = Convert.ToString(dNReader["FullName"]);

                        if (dNReader["CurrentStock"] != DBNull.Value)
                            locationRefill.CurrenStock = Convert.ToInt64(dNReader["CurrentStock"]);

                        if (dNReader["MaximumStock"] != DBNull.Value)
                            locationRefill.MaximumStock = Convert.ToInt64(dNReader["MaximumStock"]);

                        locationRefills.Add(locationRefill);
                    }
                }
            }

            return locationRefills;
        }


        public List<LocationRefill> GetRefillToListByFullNameSortByStock_V2034(Warehouses warehouse, string fullName)
        {
            List<LocationRefill> locationRefills = new List<LocationRefill>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("WMS_GetRefillToListByFullNameSortByStock_V2034", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                concommand.Parameters.AddWithValue("_FullName", fullName);


                using (MySqlDataReader dNReader = concommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        LocationRefill locationRefill = new LocationRefill();
                        if (dNReader["IdWarehouseLocation"] != DBNull.Value)
                            locationRefill.IdWarehouseLocation = Convert.ToInt64(dNReader["IdWarehouseLocation"]);
                        if (dNReader["Position"] != DBNull.Value)
                            locationRefill.Position = Convert.ToInt64(dNReader["Position"]);

                        if (dNReader["IdArticle"] != DBNull.Value)
                            locationRefill.IdArticle = Convert.ToInt32(dNReader["IdArticle"]);

                        if (dNReader["MinimumStock"] != DBNull.Value)
                            locationRefill.MinimumStock = Convert.ToInt64(dNReader["MinimumStock"]);

                        if (dNReader["FullName"] != DBNull.Value)
                            locationRefill.FullName = Convert.ToString(dNReader["FullName"]);

                        if (dNReader["CurrentStock"] != DBNull.Value)
                            locationRefill.CurrenStock = Convert.ToInt64(dNReader["CurrentStock"]);

                        if (dNReader["MaximumStock"] != DBNull.Value)
                            locationRefill.MaximumStock = Convert.ToInt64(dNReader["MaximumStock"]);

                        locationRefills.Add(locationRefill);
                    }
                }
            }

            return locationRefills;
        }


        public List<PackingBoxType> GetPackingBoxType(Warehouses warehouse)
        {
            List<PackingBoxType> packingBoxTypes = new List<PackingBoxType>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("WMS_GetPackingBoxTypes", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        PackingBoxType packingBoxType = new PackingBoxType();
                        if (reader["IdPackingBoxType"] != DBNull.Value)
                            packingBoxType.IdPackingBoxType = Convert.ToInt64(reader["IdPackingBoxType"]);

                        if (reader["Code"] != DBNull.Value)
                            packingBoxType.Code = Convert.ToString(reader["Code"]);

                        if (reader["Length"] != DBNull.Value)
                            packingBoxType.Length = Convert.ToDouble(reader["Length"]);

                        if (reader["Width"] != DBNull.Value)
                            packingBoxType.Width = Convert.ToDouble(reader["Width"]);

                        if (reader["Height"] != DBNull.Value)
                            packingBoxType.Height = Convert.ToDouble(reader["Height"]);

                        if (reader["NetWeight"] != DBNull.Value)
                            packingBoxType.NetWeight = Convert.ToInt64(reader["NetWeight"]);

                        if (reader["SizeMeasurementUnit"] != DBNull.Value)
                            packingBoxType.SizeMeasurementUnit = Convert.ToString(reader["SizeMeasurementUnit"]);

                        if (reader["WeightMeasurementUnit"] != DBNull.Value)
                            packingBoxType.WeightMeasurementUnit = Convert.ToString(reader["WeightMeasurementUnit"]);

                        if (reader["SortOrder"] != DBNull.Value)
                            packingBoxType.SortOrder = Convert.ToInt64(reader["SortOrder"]);

                        packingBoxTypes.Add(packingBoxType);
                    }
                }
            }

            return packingBoxTypes;
        }

        public PackingBox AddPackingBox(Warehouses warehouse, PackingBox packingBox)
        {

            string connectionString = warehouse.Company.ConnectPlantConstr;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_Packingboxes_Insert", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_Width", packingBox.Width);
                        mySqlCommand.Parameters.AddWithValue("_WeightMeasurementUnit", packingBox.WeightMeasurementUnit);
                        mySqlCommand.Parameters.AddWithValue("_SizeMeasurementUnit", packingBox.SizeMeasurementUnit);
                        mySqlCommand.Parameters.AddWithValue("_NetWeight", packingBox.NetWeight);
                        mySqlCommand.Parameters.AddWithValue("_Length", packingBox.Length);
                        mySqlCommand.Parameters.AddWithValue("_IsClosed", packingBox.IsClosed);
                        mySqlCommand.Parameters.AddWithValue("_IdSite", packingBox.IdSite);
                        mySqlCommand.Parameters.AddWithValue("_IdShipment", packingBox.IdShipment);
                        mySqlCommand.Parameters.AddWithValue("_IdPackingBoxType", packingBox.IdPackingBoxType);
                        mySqlCommand.Parameters.AddWithValue("_Height", packingBox.Height);
                        mySqlCommand.Parameters.AddWithValue("_GrossWeight", packingBox.GrossWeight);
                        mySqlCommand.Parameters.AddWithValue("_Comments", packingBox.Comments);
                        mySqlCommand.Parameters.AddWithValue("_BoxNumber", packingBox.BoxNumber);

                        packingBox.IdPackingBox = Convert.ToInt64(mySqlCommand.ExecuteScalar());
                        mySqlConnection.Close();

                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                packingBox.IdPackingBox = 0;
                throw;
            }



            return packingBox;
        }

        public List<WOItem> GetRevisionItemPackingWorkOrders(Warehouses warehouse, Int32 idCompany, string articleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<WOItem> unPackedItems = new List<WOItem>();
            Dictionary<Int64, byte[]> articleDetails = new Dictionary<Int64, byte[]>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetRevisionItemPackingWorkOrders", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.Parameters.AddWithValue("_IdCompany", idCompany);
                command.CommandTimeout = 8000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                WOItem unPackedItem = new WOItem();

                                if (reader["IdOT"] != DBNull.Value)
                                    unPackedItem.IdOT = Convert.ToInt64(reader["IdOT"]);

                                if (reader["MergeCode"] != DBNull.Value)
                                {
                                    unPackedItem.WorkOrder = Convert.ToString(reader["MergeCode"]);
                                }

                                if (reader["OtCode"] != DBNull.Value)
                                {
                                    unPackedItem.WorkOrderCode = Convert.ToString(reader["OtCode"]);
                                }

                                if (reader["NumItem"] != DBNull.Value)
                                {
                                    unPackedItem.Item = Convert.ToInt32(reader["NumItem"]);
                                }

                                if (reader["ActualQty"] != DBNull.Value)
                                {
                                    unPackedItem.Qty = Convert.ToInt64(reader["ActualQty"]);
                                    unPackedItem.OriginalQty = unPackedItem.Qty;
                                }


                                if (reader["IdArticle"] != DBNull.Value)
                                {
                                    unPackedItem.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                    if (reader["reference"] != DBNull.Value)
                                        unPackedItem.Reference = Convert.ToString(reader["reference"]);

                                    if (reader["Description"] != DBNull.Value)
                                        unPackedItem.Description = Convert.ToString(reader["Description"]);

                                    if (reader["ArticleWeight"] != DBNull.Value)
                                        unPackedItem.ArticleWeight = Convert.ToDouble(reader["ArticleWeight"]);

                                    if (articleDetails.Any(ad => ad.Key == unPackedItem.IdArticle))
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            unPackedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(unPackedItem.ImagePath))
                                                unPackedItem.ArticleImageInBytes = articleDetails.Where(ad => ad.Key == unPackedItem.IdArticle).Select(ad => ad.Value).FirstOrDefault();
                                        }
                                    }
                                    else
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            unPackedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(unPackedItem.ImagePath))
                                                unPackedItem.ArticleImageInBytes = GetArticleImageInBytes_V2034(articleVisualAidsPath, unPackedItem.ImagePath);

                                            articleDetails.Add(unPackedItem.IdArticle, unPackedItem.ArticleImageInBytes);
                                        }
                                    }
                                }


                                if (reader["PartNumberCode"] != DBNull.Value)
                                    unPackedItem.PartNumberCode = Convert.ToString(reader["PartNumberCode"]);


                                if (reader["idPartNumber"] != DBNull.Value)
                                    unPackedItem.IdPartNumber = Convert.ToInt64(reader["idPartNumber"]);

                                if (reader["IdOTItem"] != DBNull.Value)
                                    unPackedItem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                                unPackedItems.Add(unPackedItem);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetRevisionItemPackingWorkOrders() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    return unPackedItems;
                }


            }
        }


        public List<PackingCompany> GetCompanyPackingWorkOrders(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<PackingCompany> packingCompanies = new List<PackingCompany>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetCompanyPackingWorkOrders", conn);
                command.CommandType = CommandType.StoredProcedure;

                command.CommandTimeout = 8000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                if (reader["IdSite"] != DBNull.Value)
                                {
                                    if (packingCompanies.Any(pc => pc.IdCompany == Convert.ToInt32(reader["IdSite"])))
                                    {
                                        PackingCompany packingCompany = packingCompanies.Where(pc => pc.IdCompany == Convert.ToInt32(reader["IdSite"])).FirstOrDefault();

                                        PackingBox packingBox = new PackingBox();

                                        if (reader["IdPackingBox"] != DBNull.Value)
                                            packingBox.IdPackingBox = Convert.ToInt64(reader["IdPackingBox"]);


                                        if (reader["IdSite"] != DBNull.Value)
                                            packingBox.IdSite = Convert.ToInt32(reader["IdSite"]);

                                        if (reader["BoxNumber"] != DBNull.Value)
                                            packingBox.BoxNumber = Convert.ToString(reader["BoxNumber"]);

                                        if (reader["Length"] != DBNull.Value)
                                            packingBox.Length = Convert.ToDouble(reader["Length"]);

                                        if (reader["Width"] != DBNull.Value)
                                            packingBox.Width = Convert.ToDouble(reader["Width"]);

                                        if (reader["SizeMeasurementUnit"] != DBNull.Value)
                                            packingBox.SizeMeasurementUnit = Convert.ToString(reader["SizeMeasurementUnit"]);

                                        if (reader["Height"] != DBNull.Value)
                                            packingBox.Height = Convert.ToDouble(reader["Height"]);

                                        if (reader["WeightMeasurementUnit"] != DBNull.Value)
                                            packingBox.WeightMeasurementUnit = Convert.ToString(reader["WeightMeasurementUnit"]);

                                        if (reader["IdPackingBoxType"] != DBNull.Value)
                                            packingBox.IdPackingBoxType = Convert.ToInt64(reader["IdPackingBoxType"]);

                                        if (reader["NetWeight"] != DBNull.Value)
                                            packingBox.NetWeight = Convert.ToDouble(reader["NetWeight"]);


                                        if (reader["GrossWeight"] != DBNull.Value)
                                            packingBox.GrossWeight = Convert.ToDouble(reader["GrossWeight"]);

                                        if (reader["IsClosed"] != DBNull.Value)
                                            packingBox.IsClosed = Convert.ToSByte(reader["IsClosed"]);

                                        if (reader["Comments"] != DBNull.Value)
                                            packingBox.Comments = Convert.ToString(reader["Comments"]);

                                        if (reader["IdShipment"] != DBNull.Value)
                                            packingBox.IdShipment = Convert.ToInt64(reader["IdShipment"]);


                                        packingCompany.PackingBoxes.Add(packingBox);

                                    }
                                    else
                                    {
                                        PackingCompany packingCompany = new PackingCompany();

                                        if (reader["IdSite"] != DBNull.Value)
                                            packingCompany.IdCompany = Convert.ToInt32(reader["IdSite"]);

                                        if (reader["ShortName"] != DBNull.Value)
                                            packingCompany.ShortName = Convert.ToString(reader["ShortName"]);

                                        packingCompany.PackingBoxes = new ObservableCollection<PackingBox>();

                                        PackingBox packingBox = new PackingBox();

                                        if (reader["IdPackingBox"] != DBNull.Value)
                                            packingBox.IdPackingBox = Convert.ToInt64(reader["IdPackingBox"]);


                                        if (reader["IdSite"] != DBNull.Value)
                                            packingBox.IdSite = Convert.ToInt32(reader["IdSite"]);

                                        if (reader["BoxNumber"] != DBNull.Value)
                                            packingBox.BoxNumber = Convert.ToString(reader["BoxNumber"]);

                                        if (reader["Length"] != DBNull.Value)
                                            packingBox.Length = Convert.ToDouble(reader["Length"]);

                                        if (reader["Width"] != DBNull.Value)
                                            packingBox.Width = Convert.ToDouble(reader["Width"]);

                                        if (reader["SizeMeasurementUnit"] != DBNull.Value)
                                            packingBox.SizeMeasurementUnit = Convert.ToString(reader["SizeMeasurementUnit"]);

                                        if (reader["Height"] != DBNull.Value)
                                            packingBox.Height = Convert.ToDouble(reader["Height"]);

                                        if (reader["WeightMeasurementUnit"] != DBNull.Value)
                                            packingBox.WeightMeasurementUnit = Convert.ToString(reader["WeightMeasurementUnit"]);

                                        if (reader["IdPackingBoxType"] != DBNull.Value)
                                            packingBox.IdPackingBoxType = Convert.ToInt64(reader["IdPackingBoxType"]);

                                        if (reader["NetWeight"] != DBNull.Value)
                                            packingBox.NetWeight = Convert.ToDouble(reader["NetWeight"]);

                                        if (reader["GrossWeight"] != DBNull.Value)
                                            packingBox.GrossWeight = Convert.ToDouble(reader["GrossWeight"]);

                                        if (reader["IsClosed"] != DBNull.Value)
                                            packingBox.IsClosed = Convert.ToSByte(reader["IsClosed"]);

                                        if (reader["Comments"] != DBNull.Value)
                                            packingBox.Comments = Convert.ToString(reader["Comments"]);

                                        if (reader["IdShipment"] != DBNull.Value)
                                            packingBox.IdShipment = Convert.ToInt64(reader["IdShipment"]);


                                        packingCompany.PackingBoxes.Add(packingBox);

                                        packingCompanies.Add(packingCompany);
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetCompanyPackingWorkOrders() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    return packingCompanies;
                }



            }
        }

        public byte[] GetArticleImageInBytes_V2034(string ArticleVisualAidsPath, string ImagePath)
        {
            if (!Directory.Exists(ArticleVisualAidsPath))
            {
                return null;
            }

            string fileUploadPath = ArticleVisualAidsPath + ImagePath;

            if (!File.Exists(fileUploadPath))
            {
                return null;
            }

            if (!string.IsNullOrEmpty(ImagePath))
            {

                byte[] bytes = null;

                try
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(fileUploadPath, System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;

                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }

                    return bytes;
                }

                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error GetArticleImageInBytes_V2034() article ImagePath-{0}. ErrorMessage- {1}", ImagePath, ex.Message), category: Category.Exception, priority: Priority.Low);
                    //throw;
                }
            }

            return null;
        }

        public bool UpdatePackingBox(Warehouses warehouse, PackingBox packingBox)
        {
            bool isUpdated = false;
            string connectionString = warehouse.Company.ConnectPlantConstr;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_Packingboxes_Update", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_Width", packingBox.Width);
                        mySqlCommand.Parameters.AddWithValue("_WeightMeasurementUnit", packingBox.WeightMeasurementUnit);
                        mySqlCommand.Parameters.AddWithValue("_SizeMeasurementUnit", packingBox.SizeMeasurementUnit);
                        mySqlCommand.Parameters.AddWithValue("_NetWeight", packingBox.NetWeight);
                        mySqlCommand.Parameters.AddWithValue("_Length", packingBox.Length);
                        mySqlCommand.Parameters.AddWithValue("_IsClosed", packingBox.IsClosed);
                        mySqlCommand.Parameters.AddWithValue("_IdSite", packingBox.IdSite);
                        mySqlCommand.Parameters.AddWithValue("_IdShipment", packingBox.IdShipment);
                        mySqlCommand.Parameters.AddWithValue("_IdPackingBoxType", packingBox.IdPackingBoxType);
                        mySqlCommand.Parameters.AddWithValue("_Height", packingBox.Height);
                        mySqlCommand.Parameters.AddWithValue("_GrossWeight", packingBox.GrossWeight);
                        mySqlCommand.Parameters.AddWithValue("_Comments", packingBox.Comments);
                        mySqlCommand.Parameters.AddWithValue("_BoxNumber", packingBox.BoxNumber);
                        mySqlCommand.Parameters.AddWithValue("_IdPackingBox", packingBox.IdPackingBox);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                        isUpdated = true;
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isUpdated = false;
                throw;
            }



            return isUpdated;
        }

        public List<Warehouses> GetAllWarehousesByUserPermission_V2034(string connectionString, Int32 idActiveUser)
        {
            List<Warehouses> warehouses = new List<Warehouses>();

            using (MySqlConnection connWarehouse = new MySqlConnection(connectionString))
            {
                connWarehouse.Open();

                MySqlCommand warehouseCommand = new MySqlCommand("warehouse_GetAllWarehousesByUserPermission_V2034", connWarehouse);
                warehouseCommand.CommandType = CommandType.StoredProcedure;
                warehouseCommand.Parameters.AddWithValue("_idUser", idActiveUser);

                using (MySqlDataReader warehouseReader = warehouseCommand.ExecuteReader())
                {
                    while (warehouseReader.Read())
                    {
                        try
                        {
                            Warehouses warehouse = new Warehouses();

                            if (warehouseReader["IdWarehouse"] != DBNull.Value)
                                warehouse.IdWarehouse = Convert.ToInt32(warehouseReader["IdWarehouse"]);

                            if (warehouseReader["Name"] != DBNull.Value)
                                warehouse.Name = Convert.ToString(warehouseReader["Name"]);

                            if (warehouseReader["IdTransitLocation"] != DBNull.Value)
                                warehouse.IdTransitLocation = Convert.ToInt64(warehouseReader["IdTransitLocation"]);

                            if (warehouseReader["IdSite"] != DBNull.Value)
                            {
                                string connstr = "Data Source = " + Convert.ToString(warehouseReader["DatabaseIP"]) + "; Database = geos; User ID = GeosUsr; Password = GEOS; Convert Zero Datetime=True";

                                warehouse.IdSite = Convert.ToInt32(warehouseReader["IdSite"]);

                                Company company = new Company();
                                company.IdCompany = Convert.ToInt32(warehouseReader["IdSite"]);
                                company.ConnectPlantConstr = connstr;
                                company.ConnectPlantId = Convert.ToString(company.IdCompany);

                                if (warehouseReader["SiteName"] != DBNull.Value)
                                    company.Name = Convert.ToString(warehouseReader["SiteName"]);

                                if (warehouseReader["ShortName"] != DBNull.Value)
                                {
                                    company.ShortName = Convert.ToString(warehouseReader["ShortName"]);
                                    company.Alias = company.ShortName;
                                }

                                warehouse.Company = company;
                            }

                            warehouses.Add(warehouse);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetAllWarehousesByUserPermission(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetAllWarehousesByUserPermission().", category: Category.Info, priority: Priority.Low);
            return warehouses;
        }

        public List<OTWorkingTime> GetOTWorkingTimeDetails(Int64 idOT, Warehouses warehouse, String userProfileImageFilePath)
        {
            List<OTWorkingTime> LstOTWorkingTime = new List<OTWorkingTime>();
            List<UserShortDetail> UserShortDetailForbytes = new List<UserShortDetail>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection connWarehouse = new MySqlConnection(connectionString))
            {
                connWarehouse.Open();

                MySqlCommand warehouseCommand = new MySqlCommand("WMS_GetOTWorkingTimeDetails", connWarehouse);
                warehouseCommand.CommandType = CommandType.StoredProcedure;
                warehouseCommand.Parameters.AddWithValue("_IdOT", idOT);
                warehouseCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader warehouseReader = warehouseCommand.ExecuteReader())
                {
                    while (warehouseReader.Read())
                    {
                        try
                        {
                            OTWorkingTime otWorkingTime = new OTWorkingTime();

                            if (warehouseReader["IdOT"] != DBNull.Value)
                                otWorkingTime.IdOT = Convert.ToInt64(warehouseReader["IdOT"]);

                            if (warehouseReader["IdStage"] != DBNull.Value)
                                otWorkingTime.IdStage = Convert.ToByte(warehouseReader["IdStage"]);

                            if (warehouseReader["StartDate"] != DBNull.Value)
                                otWorkingTime.StartTime = Convert.ToDateTime(Convert.ToDateTime(warehouseReader["StartDate"]).ToString("dd/MM/yyyy HH:mm"));

                            //if (warehouseReader["StartTime"] != DBNull.Value)
                            //    otWorkingTime.StartTimeInHoursAndMinutes = warehouseReader["StartTime"].ToString();

                            if (warehouseReader["EndDate"] != DBNull.Value)
                                otWorkingTime.EndTime = Convert.ToDateTime(Convert.ToDateTime(warehouseReader["EndDate"]).ToString("dd/MM/yyyy HH:mm"));

                            if (warehouseReader["TotalTime"] != DBNull.Value)
                            {
                                otWorkingTime.TotalTime = (TimeSpan)warehouseReader["TotalTime"];
                                otWorkingTime.TotalTime = new TimeSpan(otWorkingTime.TotalTime.Hours, otWorkingTime.TotalTime.Minutes, 00);
                            }

                            //if (warehouseReader["EndTime"] != DBNull.Value)
                            //    otWorkingTime.EndTimeInHoursAndMinutes =warehouseReader["EndTime"].ToString();

                            if (warehouseReader["IdOperator"] != DBNull.Value)
                            {
                                otWorkingTime.IdOperator = Convert.ToInt32(warehouseReader["IdOperator"]);

                                otWorkingTime.UserShortDetail = new UserShortDetail();
                                otWorkingTime.UserShortDetail.IdUser = Convert.ToInt32(warehouseReader["IdOperator"]);
                                otWorkingTime.UserShortDetail.Login = Convert.ToString(warehouseReader["Login"]);
                                otWorkingTime.UserShortDetail.UserName = Convert.ToString(warehouseReader["UserName"]);

                                if (warehouseReader["IdUserGender"] != DBNull.Value)
                                    otWorkingTime.UserShortDetail.IdUserGender = Convert.ToByte(warehouseReader["IdUserGender"]);

                                if (UserShortDetailForbytes.Any(usd => usd.Login == otWorkingTime.UserShortDetail.Login))
                                {
                                    otWorkingTime.UserShortDetail.UserImageInBytes = UserShortDetailForbytes.Where(usd => usd.Login == otWorkingTime.UserShortDetail.Login).FirstOrDefault().UserImageInBytes;
                                }
                                else
                                {
                                    otWorkingTime.UserShortDetail.UserImageInBytes = GetUserProfileImageInBytes(otWorkingTime.UserShortDetail.Login, userProfileImageFilePath);
                                    UserShortDetail userShortDetail = new UserShortDetail();
                                    userShortDetail.IdUser = otWorkingTime.UserShortDetail.IdUser;
                                    userShortDetail.IdUserGender = otWorkingTime.UserShortDetail.IdUserGender;
                                    userShortDetail.Login = otWorkingTime.UserShortDetail.Login;
                                    userShortDetail.UserName = otWorkingTime.UserShortDetail.UserName;

                                    userShortDetail.UserImageInBytes = otWorkingTime.UserShortDetail.UserImageInBytes;
                                    UserShortDetailForbytes.Add(userShortDetail);
                                }
                            }


                            LstOTWorkingTime.Add(otWorkingTime);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetOTWorkingTimeDetails(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }



            return LstOTWorkingTime;
        }

        public List<PlanningSimulator> GetPlanningSimulator_V2034(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<PlanningSimulator> planningSimulatorList = new List<PlanningSimulator>();
            List<Int32> LstIdArticles = new List<Int32>();
            List<CurrentArticleStock> articleStockLst = new List<CurrentArticleStock>();
            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetPlanningSimulator_V2034", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.CommandTimeout = 8000;
                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    // for parent otitems and decomposed articles
                    while (reader.Read())
                    {
                        try
                        {
                            PlanningSimulator planningSimulator = new PlanningSimulator();

                            if (reader["IdArticle"] != DBNull.Value)
                                planningSimulator.IdArticle = Convert.ToInt32(reader["IdArticle"]);


                            if (reader["Reference"] != DBNull.Value)
                                planningSimulator.Reference = Convert.ToString(reader["Reference"]);

                            if (reader["IdOT"] != DBNull.Value)
                                planningSimulator.IdOT = Convert.ToInt64(reader["IdOT"]);

                            if (reader["OTCode"] != DBNull.Value)
                                planningSimulator.OTCode = Convert.ToString(reader["OTCode"]);

                            if (reader["Customer"] != DBNull.Value)
                                planningSimulator.Customer = Convert.ToString(reader["Customer"]);

                            if (reader["OTWeek"] != DBNull.Value)
                                planningSimulator.Week = Convert.ToString(reader["OTWeek"]);

                            if (reader["DeliveryDate"] != DBNull.Value)
                                planningSimulator.OTDeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);

                            if (reader["DownloadedQty"] != DBNull.Value)
                                planningSimulator.DownloadedQty = Convert.ToInt64(reader["DownloadedQty"]);

                            if (reader["ActualQty"] != DBNull.Value)
                                planningSimulator.ActualQty = Convert.ToInt64(reader["ActualQty"]);

                            if (reader["RemainingQty"] != DBNull.Value)
                                planningSimulator.OTRemainingQty = Convert.ToInt64(reader["RemainingQty"]);

                            planningSimulator.IsOut = true;

                            planningSimulatorList.Add(planningSimulator);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPlanningSimulator ErrorMessage- ", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                    // for order
                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                PlanningSimulator planningSimulator = new PlanningSimulator();

                                if (reader["IdArticle"] != DBNull.Value)
                                    planningSimulator.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                if (reader["Reference"] != DBNull.Value)
                                    planningSimulator.Reference = Convert.ToString(reader["Reference"]);

                                if (reader["IdWarehousePurchaseOrder"] != DBNull.Value)
                                    planningSimulator.IdWarehousePurchaseOrder = Convert.ToInt64(reader["IdWarehousePurchaseOrder"]);

                                if (reader["POCode"] != DBNull.Value)
                                    planningSimulator.POCode = Convert.ToString(reader["POCode"]);

                                if (reader["Supplier"] != DBNull.Value)
                                    planningSimulator.Supplier = Convert.ToString(reader["Supplier"]);

                                if (reader["POWeek"] != DBNull.Value)
                                    planningSimulator.Week = Convert.ToString(reader["POWeek"]);

                                if (reader["DeliveryDate"] != DBNull.Value)
                                    planningSimulator.PODeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);

                                if (reader["OrderQty"] != DBNull.Value)
                                    planningSimulator.OrderQty = Convert.ToInt64(reader["OrderQty"]);

                                if (reader["ReceivedQuantity"] != DBNull.Value)
                                    planningSimulator.ReceivedQuantity = Convert.ToInt64(reader["ReceivedQuantity"]);

                                if (reader["RemainingQty"] != DBNull.Value)
                                    planningSimulator.PORemainingQty = Convert.ToInt64(reader["RemainingQty"]);


                                planningSimulator.IsOut = false;

                                planningSimulatorList.Add(planningSimulator);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPlanningSimulator ErrorMessage- ", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                    // for articlestock IdWarehouseLocation is not null
                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                if (reader["IdArticle"] != DBNull.Value)
                                {
                                    CurrentArticleStock currentArticleStock = new CurrentArticleStock();

                                    currentArticleStock.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                    currentArticleStock.ArticleStock = Convert.ToInt64(reader["ArticlesStockQty"]);


                                    articleStockLst.Add(currentArticleStock);
                                }

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPlanningSimulator ErrorMessage- ", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    // for articlestock IdWarehouseLocation is null
                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                if (reader["IdArticle"] != DBNull.Value)
                                {
                                    if (articleStockLst.Any(i => i.IdArticle == Convert.ToInt32(reader["IdArticle"])))
                                    {
                                        CurrentArticleStock currentArticleStock = articleStockLst.Where(i => i.IdArticle == Convert.ToInt32(reader["IdArticle"])).FirstOrDefault();
                                        currentArticleStock.ArticleStock = currentArticleStock.ArticleStock + Convert.ToInt64(reader["ArticlesStockQty"]);

                                    }
                                    else
                                    {
                                        CurrentArticleStock currentArticleStock = new CurrentArticleStock();

                                        currentArticleStock.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                        currentArticleStock.ArticleStock = Convert.ToInt64(reader["ArticlesStockQty"]);


                                        articleStockLst.Add(currentArticleStock);
                                    }

                                }

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPlanningSimulator ErrorMessage- ", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                }
            }

            Int64 expectedStock = 0;
            planningSimulatorList = planningSimulatorList.OrderBy(ob => ob.IdArticle).ThenBy(tb => (tb.OTDeliveryDate == null) ? tb.PODeliveryDate : tb.OTDeliveryDate).ThenBy(tb => (tb.PODeliveryDate == null) ? tb.OTDeliveryDate : tb.PODeliveryDate).ToList();
            Int64 rowPointer = 0;
            foreach (PlanningSimulator itemPlanningSimulator in planningSimulatorList)
            {
                rowPointer = rowPointer + 1;
                itemPlanningSimulator.RowPointer = rowPointer;
                if (LstIdArticles.Any(i => i == itemPlanningSimulator.IdArticle))
                {
                    if (itemPlanningSimulator.IsOut)
                    {
                        if (planningSimulatorList.Any(i => i.IdArticle == itemPlanningSimulator.IdArticle && i.RowPointer == itemPlanningSimulator.RowPointer - 1 && i.IsOut == true))
                        {
                            PlanningSimulator planningSimulator = planningSimulatorList.Where(i => i.IdArticle == itemPlanningSimulator.IdArticle && i.RowPointer == itemPlanningSimulator.RowPointer - 1 && i.IsOut == true).FirstOrDefault();
                            planningSimulator.NextOtItemPickingStock = itemPlanningSimulator.OTRemainingQty.Value;
                        }

                        itemPlanningSimulator.CurrentArticleStock = expectedStock;
                        expectedStock = expectedStock - itemPlanningSimulator.OTRemainingQty.Value;
                    }
                    else
                    {
                        itemPlanningSimulator.CurrentArticleStock = expectedStock;
                        expectedStock = expectedStock + itemPlanningSimulator.PORemainingQty.Value;
                    }
                }
                else
                {
                    LstIdArticles.Add(itemPlanningSimulator.IdArticle);
                    if (articleStockLst.Any(i => i.IdArticle == itemPlanningSimulator.IdArticle))
                    {
                        expectedStock = articleStockLst.Where(i => i.IdArticle == itemPlanningSimulator.IdArticle).FirstOrDefault().ArticleStock;
                    }
                    else
                    {
                        expectedStock = 0;
                    }

                    if (itemPlanningSimulator.IsOut)
                    {
                        if (planningSimulatorList.Any(i => i.IdArticle == itemPlanningSimulator.IdArticle && i.RowPointer == itemPlanningSimulator.RowPointer - 1 && i.IsOut == true))
                        {
                            PlanningSimulator planningSimulator = planningSimulatorList.Where(i => i.IdArticle == itemPlanningSimulator.IdArticle && i.RowPointer == itemPlanningSimulator.RowPointer - 1 && i.IsOut == true).FirstOrDefault();
                            planningSimulator.NextOtItemPickingStock = itemPlanningSimulator.OTRemainingQty.Value;
                        }
                        itemPlanningSimulator.CurrentArticleStock = expectedStock;
                        expectedStock = expectedStock - itemPlanningSimulator.OTRemainingQty.Value;
                    }
                    else
                    {
                        itemPlanningSimulator.CurrentArticleStock = expectedStock;
                        expectedStock = expectedStock + itemPlanningSimulator.PORemainingQty.Value;
                    }

                }
                itemPlanningSimulator.ExpectedStock = expectedStock;
            }

            return planningSimulatorList;

        }

        public List<OtItem> GetPendingMaterialArticles_V2034(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OtItem> otItems = new List<OtItem>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetPendingMaterialArticles_V2034", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OtItem otItem = new OtItem();
                                if (reader["IdOTItem"] != DBNull.Value)
                                {
                                    otItem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                                    if (reader["IdOT"] != DBNull.Value)
                                        otItem.IdOT = Convert.ToInt64(reader["IdOT"]);

                                    otItem.RevisionItem = new RevisionItem();

                                    if (reader["ActualQty"] != DBNull.Value)
                                        otItem.RevisionItem.Quantity = Convert.ToInt64(reader["ActualQty"]);

                                    if (reader["DownloadedQty"] != DBNull.Value)
                                        otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(reader["DownloadedQty"]);

                                    if (reader["RemainingQty"] != DBNull.Value)
                                        otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(reader["RemainingQty"]);

                                    if (reader["IdArticle"] != DBNull.Value)
                                    {
                                        otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                        otItem.RevisionItem.WarehouseProduct.Article = new Article();
                                        otItem.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                        otItem.RevisionItem.WarehouseProduct.Article.Reference = Convert.ToString(reader["Reference"]);
                                        otItem.RevisionItem.WarehouseProduct.Article.Description = Convert.ToString(reader["Description"]);
                                    }

                                    otItem.Ot = new Ots();
                                    if (reader["MergeCode"] != DBNull.Value)
                                        otItem.Ot.Code = Convert.ToString(reader["MergeCode"]);

                                    if (reader["IdSite"] != DBNull.Value)
                                    {
                                        otItem.Ot.Quotation = new Quotation();

                                        otItem.Ot.Quotation.Site = new Company();
                                        otItem.Ot.Quotation.Site.Name = Convert.ToString(reader["SiteName"]);

                                        otItem.Ot.Quotation.Site.Country = new Country();
                                        otItem.Ot.Quotation.Site.Country.Name = Convert.ToString(reader["Country"]);

                                        otItem.Ot.Quotation.Site.Customer = new Customer();
                                        otItem.Ot.Quotation.Site.Customer.CustomerName = Convert.ToString(reader["CustomerGroup"]);

                                        otItem.Ot.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                    }

                                }

                                otItems.Add(otItem);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialArticles_V2034() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return otItems;
        }

        public List<InventoryMaterial> InsertInventoryMaterialIntoArticleStock_V2034(string connectionString, List<InventoryMaterial> inventoryMaterials)
        {
            List<InventoryMaterial> NotReguralizedLst = new List<InventoryMaterial>();
            if (inventoryMaterials != null && inventoryMaterials.Count > 0)
            {
                TransactionScope transactionScope = null;
                try
                {
                    using (transactionScope = new TransactionScope())
                    {
                        foreach (InventoryMaterial inventoryMaterial in inventoryMaterials)
                        {
                            inventoryMaterial.ArticleTotalStock = GetArticleStockByWarehouse(connectionString, inventoryMaterial.IdArticle, Convert.ToInt32(inventoryMaterial.IdWarehouse));

                            Int64 updatedStock = inventoryMaterial.ArticleTotalStock + inventoryMaterial.RemainingQty;

                            inventoryMaterial.Comments = string.Format("STOCK REGULARIZATION WMS - {0} [STOCK -> {1} ]", inventoryMaterial.Reason.Value, updatedStock);

                            if (updatedStock >= 0)
                            {

                                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                                {
                                    mySqlConnection.Open();

                                    MySqlCommand insertCommand = new MySqlCommand("WMS_InsertInventoryMaterialIntoArticlesStock", mySqlConnection);
                                    insertCommand.CommandType = CommandType.StoredProcedure;

                                    insertCommand.Parameters.AddWithValue("_IdArticle", inventoryMaterial.IdArticle);
                                    insertCommand.Parameters.AddWithValue("_IdOtitem", null);
                                    insertCommand.Parameters.AddWithValue("_QTY", inventoryMaterial.RemainingQty);
                                    insertCommand.Parameters.AddWithValue("_Price", inventoryMaterial.CostPrice);
                                    insertCommand.Parameters.AddWithValue("_UnitPrice", inventoryMaterial.UnitPrice);
                                    insertCommand.Parameters.AddWithValue("_Comments", inventoryMaterial.Comments);
                                    insertCommand.Parameters.AddWithValue("_IdModifiedBy", inventoryMaterial.ModifiedBy);
                                    insertCommand.Parameters.AddWithValue("_IDcomponent", null);
                                    insertCommand.Parameters.AddWithValue("_Idwarehouse", inventoryMaterial.IdWarehouse);
                                    insertCommand.Parameters.AddWithValue("_IdWarehouseLocation", inventoryMaterial.IdWarehouseLocation);
                                    insertCommand.Parameters.AddWithValue("_IdWareHouseDeliveryNoteItem", inventoryMaterial.IdWareHouseDeliveryNoteItem);
                                    insertCommand.Parameters.AddWithValue("_IdCurrency", inventoryMaterial.IdCurrency);

                                    int count = insertCommand.ExecuteNonQuery();
                                    // inventoryMaterial.IsInserted = true;
                                    mySqlConnection.Close();
                                }
                            }
                            else
                            {
                                NotReguralizedLst.Add(inventoryMaterial);
                            }

                        }

                        transactionScope.Complete();
                        transactionScope.Dispose();
                    }
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    Log4NetLogger.Logger.Log(string.Format("Error InsertInventoryMaterialIntoArticleStock(). ErrorMessage- ", ex.Message), category: Category.Exception, priority: Priority.Low);
                    throw;
                }

            }


            return NotReguralizedLst;
        }


        public List<Article> GetPendingArticles_V2034(Warehouses warehouse)
        {
            List<Article> articles = new List<Article>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection connArticles = new MySqlConnection(connectionString))
            {
                connArticles.Open();

                MySqlCommand articleCommand = new MySqlCommand("WMS_GetPendingArticles_V2034", connArticles);
                articleCommand.CommandType = CommandType.StoredProcedure;
                articleCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader articleReader = articleCommand.ExecuteReader())
                {
                    while (articleReader.Read())
                    {
                        try
                        {
                            Article article = new Article();

                            if (articleReader["IdArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(articleReader["IdArticle"]);

                            if (articleReader["Reference"] != DBNull.Value)
                                article.Reference = Convert.ToString(articleReader["Reference"]);

                            if (articleReader["Description"] != DBNull.Value)
                                article.Description = Convert.ToString(articleReader["Description"]);

                            WarehousePurchaseOrder warehousePO = new WarehousePurchaseOrder();

                            warehousePO.IdWarehousePurchaseOrder = Convert.ToInt64(articleReader["IdWarehousePurchaseOrder"]);

                            if (articleReader["PurchaseOrderCode"] != DBNull.Value)
                                warehousePO.Code = Convert.ToString(articleReader["PurchaseOrderCode"]);

                            if (articleReader["WO_DeliveryDate"] != DBNull.Value)
                                warehousePO.DeliveryDate = Convert.ToDateTime(articleReader["WO_DeliveryDate"]);

                            if (articleReader["WO_Supplier"] != DBNull.Value)
                            {
                                warehousePO.ArticleSupplier = new ArticleSupplier();
                                warehousePO.ArticleSupplier.Name = Convert.ToString(articleReader["WO_Supplier"]);
                            }

                            if (articleReader["RemainingQty"] != DBNull.Value)
                                article.Quantity = Convert.ToDouble(articleReader["RemainingQty"]);

                            if (articleReader["IdWarehouse"] != DBNull.Value)
                                warehousePO.IdWarehouse = Convert.ToInt64(articleReader["IdWarehouse"]);

                            article.WarehousePurchaseOrder = warehousePO;

                            articles.Add(article);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPendingArticles_V2034(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetPendingArticles_V2034().", category: Category.Info, priority: Priority.Low);
            return articles;
        }


        public bool UpdatePackingBoxInPartnumber(Warehouses warehouse, Int64 idPackingBox, Int64 idPartNumber)
        {
            bool isUpdated = false;
            string connectionString = warehouse.Company.ConnectPlantConstr;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_Partnumbers_Update", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdPackingBox", idPackingBox);
                        mySqlCommand.Parameters.AddWithValue("_IdPartNumber", idPartNumber);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                        isUpdated = true;
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isUpdated = false;
                throw;
            }



            return isUpdated;
        }


        public List<BoxPrint> GetWorkorderByIdPackingBox(Warehouses warehouse, Int64 idPackingBox)
        {
            List<BoxPrint> boxPrints = new List<BoxPrint>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetWorkorderByIdPackingBox", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdPackingBox", idPackingBox);

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            BoxPrint boxPrint = new BoxPrint();

                            if (reader["IdPackingBox"] != DBNull.Value)
                                boxPrint.IdPackingBox = Convert.ToInt32(reader["IdPackingBox"]);

                            if (reader["Code"] != DBNull.Value)
                                boxPrint.OtCode = Convert.ToString(reader["Code"]);

                            if (reader["IdCarriageMethod"] != DBNull.Value)
                                boxPrint.IdCarriageMethod = Convert.ToInt32(reader["IdCarriageMethod"]);

                            if (reader["CarriageMethodValue"] != DBNull.Value)
                                boxPrint.CarriageMethodValue = Convert.ToString(reader["CarriageMethodValue"]);

                            if (reader["CarriageMethodAbbreviation"] != DBNull.Value)
                                boxPrint.CarriageMethodAbbreviation = Convert.ToString(reader["CarriageMethodAbbreviation"]);

                            if (reader["SiteName"] != DBNull.Value)
                                boxPrint.SiteName = Convert.ToString(reader["SiteName"]);

                            if (reader["BoxNumber"] != DBNull.Value)
                                boxPrint.BoxNumber = Convert.ToString(reader["BoxNumber"]);

                            if (reader["GrossWeight"] != DBNull.Value)
                                boxPrint.GrossWeight = Convert.ToDouble(reader["GrossWeight"]);

                            if (reader["IdOT"] != DBNull.Value)
                                boxPrint.IdOT = Convert.ToInt64(reader["IdOT"]);

                            if (reader["SiteNameWithCountry"] != DBNull.Value)
                                boxPrint.SiteNameWithCountry = Convert.ToString(reader["SiteNameWithCountry"]);

                            if (reader["CustomerName"] != DBNull.Value)
                                boxPrint.CustomerName = Convert.ToString(reader["CustomerName"]);

                            boxPrints.Add(boxPrint);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetWorkorderByIdPackingBox(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetWorkorderByIdPackingBox().", category: Category.Info, priority: Priority.Low);
            return boxPrints;
        }

        public bool UpdateOTItemStatus(Warehouses warehouse, Int64 idotitem)
        {
            bool isUpdated = false;
            string connectionString = warehouse.Company.ConnectPlantConstr;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_UpdateOTItemStatus", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_Idotitem", idotitem);
                        mySqlCommand.Parameters.AddWithValue("_EndDate", DateTime.Now);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                        isUpdated = true;
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isUpdated = false;
                throw;
            }



            return isUpdated;
        }


        public bool UpdateUnPackingBoxInPartnumber(Warehouses warehouse, Int64 idPackingBox, Int64 idPartNumber)
        {
            bool isUpdated = false;
            string connectionString = warehouse.Company.ConnectPlantConstr;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_Partnumbers_Update", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdPackingBox", null);
                        mySqlCommand.Parameters.AddWithValue("_IdPartNumber", idPartNumber);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                        isUpdated = true;
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isUpdated = false;
                throw;
            }



            return isUpdated;
        }


        public bool UpdateOTItemStatusToFinished(Warehouses warehouse, Int64 idotitem)
        {
            bool isUpdated = false;
            string connectionString = warehouse.Company.ConnectPlantConstr;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_UpdateOTItemStatusToFinished", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_Idotitem", idotitem);
                        mySqlCommand.Parameters.AddWithValue("_EndDate", DateTime.Now);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                        isUpdated = true;
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isUpdated = false;
                throw;
            }



            return isUpdated;
        }


        public List<ArticlesStock> GetStockHistoryByIdOT(string connectionString, Int64 idOT, Int64 idWarehouse)
        {
            List<ArticlesStock> articlesStocks = new List<ArticlesStock>();


            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("articlesstock_GetStockHistoryByIdot", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idOT", idOT);
                command.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                command.CommandTimeout = 8000;
                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            ArticlesStock articlesStock = new ArticlesStock();

                            if (reader["IdArticleStock"] != DBNull.Value)
                                articlesStock.IdArticleStock = Convert.ToUInt64(reader["IdArticleStock"]);
                            if (reader["quantity"] != DBNull.Value)
                                articlesStock.Quantity = Convert.ToInt64(reader["quantity"]);
                            if (reader["price"] != DBNull.Value)
                                articlesStock.Price = Convert.ToDouble(reader["price"]);
                            if (reader["uploadedIn"] != DBNull.Value)
                                articlesStock.UploadedIn = Convert.ToDateTime(reader["uploadedIn"]);
                            if (reader["comments"] != DBNull.Value)
                                articlesStock.Comments = Convert.ToString(reader["comments"]);
                            if (reader["isDamaged"] != DBNull.Value)
                                articlesStock.IsDamaged = Convert.ToByte(reader["isDamaged"]);
                            articlesStock.PeopleModifiedBy = new People();
                            if (reader["FirstName"] != DBNull.Value)
                                articlesStock.PeopleModifiedBy.Name = Convert.ToString(reader["FirstName"]);
                            if (reader["LastName"] != DBNull.Value)
                                articlesStock.PeopleModifiedBy.Surname = Convert.ToString(reader["LastName"]);

                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                articlesStock.WarehouseLocation = new WarehouseLocation();
                                articlesStock.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);
                                articlesStock.WarehouseLocation.FullName = Convert.ToString(reader["Location"]);
                            }
                            if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            {
                                articlesStock.IdWarehouseDeliveryNoteItem = Convert.ToUInt64(reader["IdWarehouseDeliveryNoteItem"]);
                                articlesStock.WarehouseDeliveryNoteItem = new WarehouseDeliveryNoteItem();
                                articlesStock.WarehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem = Convert.ToInt64(reader["IdWarehouseDeliveryNoteItem"]);
                                if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                                {
                                    articlesStock.WarehouseDeliveryNoteItem.IdWarehouseDeliveryNote = Convert.ToInt64(reader["idWarehouseDeliveryNote"]);
                                    articlesStock.WarehouseDeliveryNoteItem.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                    articlesStock.WarehouseDeliveryNoteItem.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["idWarehouseDeliveryNote"]);
                                    articlesStock.WarehouseDeliveryNoteItem.WarehouseDeliveryNote.Code = Convert.ToString(reader["DeliveryNote"]);
                                }

                            }


                            articlesStocks.Add(articlesStock);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetStockHistoryByIdOT(idOT-{0}). ErrorMessage- {1}", idOT, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return articlesStocks;
        }


        /// <summary>
        /// [WAREHOUSE-M027-04] Add the Work Order section information
        /// This method is used to show Workorder information by idot.
        /// </summary>
        /// <param name="connectionString">The current plant connection string.</param>
        /// <param name="idOt">The idOt</param>
        /// <param name="idWarehouse">The current plant id.</param>
        /// <returns>ots details</returns>
        public Ots GetWorkOrderByIdOt_V2035(Int64 idOt, Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            Ots ot = null;

            using (MySqlConnection connOT = new MySqlConnection(connectionString))
            {
                connOT.Open();

                MySqlCommand otCommand = new MySqlCommand("warehouse_GetMaterialOtInformationByIdOt", connOT);
                otCommand.CommandType = CommandType.StoredProcedure;
                otCommand.Parameters.AddWithValue("_IdOt", idOt);

                using (MySqlDataReader otReader = otCommand.ExecuteReader())
                {
                    if (otReader.Read())
                    {
                        try
                        {
                            ot = new Ots();
                            ot.IdOT = idOt;

                            if (otReader["OtCode"] != DBNull.Value)
                                ot.Code = Convert.ToString(otReader["OtCode"]);

                            ot.NumOT = Convert.ToByte(otReader["NumOT"]);

                            if (otReader["Comments"] != DBNull.Value)
                                ot.Comments = Convert.ToString(otReader["Comments"]);

                            if (otReader["CreatedBy"] != DBNull.Value)
                            {
                                ot.CreatedBy = Convert.ToInt32(otReader["CreatedBy"]);

                                ot.CreatedByPerson = new People();
                                ot.CreatedByPerson.IdPerson = ot.CreatedBy;
                                ot.CreatedByPerson.Name = Convert.ToString(otReader["CreatedByName"]);
                                ot.CreatedByPerson.Surname = Convert.ToString(otReader["CreatedBySurname"]);
                            }

                            ot.ReviewedBy = Convert.ToInt32(otReader["ReviewedBy"]);

                            //CreatedBy
                            if (otReader["CreatedBy"] != DBNull.Value)
                            {
                                ot.CreatedBy = Convert.ToInt32(otReader["CreatedBy"]);

                                ot.CreatedByPerson = new People();
                                ot.CreatedByPerson.IdPerson = ot.CreatedBy;
                                ot.CreatedByPerson.Name = Convert.ToString(otReader["CreatedByName"]);
                                ot.CreatedByPerson.Surname = Convert.ToString(otReader["CreatedBySurname"]);
                            }

                            if (otReader["CreationDate"] != DBNull.Value)
                                ot.CreationDate = Convert.ToDateTime(otReader["CreationDate"]);

                            //ModifiedBy
                            if (otReader["ModifiedBy"] != DBNull.Value)
                            {
                                ot.ModifiedBy = Convert.ToInt32(otReader["ModifiedBy"]);

                                ot.ModifiedByPerson = new People();
                                ot.ModifiedByPerson.IdPerson = ot.ModifiedBy;
                                ot.ModifiedByPerson.Name = Convert.ToString(otReader["ModifiedByName"]);
                                ot.ModifiedByPerson.Surname = Convert.ToString(otReader["ModifiedBySurname"]);
                            }

                            if (otReader["ModifiedIn"] != DBNull.Value)
                                ot.ModifiedIn = Convert.ToDateTime(otReader["ModifiedIn"]);

                            if (otReader["DeliveryDate"] != DBNull.Value)
                                ot.DeliveryDate = Convert.ToDateTime(otReader["DeliveryDate"]);

                            if (otReader["WareHouseLockSession"] != DBNull.Value)
                                ot.WareHouseLockSession = Convert.ToString(otReader["WareHouseLockSession"]);

                            if (otReader["AttachedFiles"] != DBNull.Value)
                                ot.AttachedFiles = Convert.ToString(otReader["AttachedFiles"]);

                            if (otReader["IdShippingAddress"] != DBNull.Value)
                                ot.IdShippingAddress = Convert.ToInt64(otReader["IdShippingAddress"]);

                            ot.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                            ot.Quotation = new Quotation();
                            ot.Quotation.Code = Convert.ToString(otReader["QuotationCode"]);

                            if (otReader["Year"] != DBNull.Value)
                                ot.Quotation.Year = Convert.ToInt32(otReader["Year"]);

                            if (otReader["Description"] != DBNull.Value)
                                ot.Quotation.Description = Convert.ToString(otReader["Description"]);

                            if (otReader["ProjectName"] != DBNull.Value)
                                ot.Quotation.ProjectName = Convert.ToString(otReader["ProjectName"]);


                            if (otReader["ProjectName"] != DBNull.Value)
                                ot.Quotation.ProjectName = Convert.ToString(otReader["ProjectName"]);

                            //Customer
                            if (otReader["IdSite"] != DBNull.Value)
                            {
                                ot.Quotation.Site = new Company();
                                ot.Quotation.Site.IdCompany = Convert.ToInt32(otReader["IdSite"]);
                                ot.Quotation.Site.SiteNameWithoutCountry = Convert.ToString(otReader["SiteName"]);

                                if (otReader["ShortName"] != DBNull.Value && !string.IsNullOrEmpty(Convert.ToString(otReader["ShortName"])))
                                {
                                    ot.Quotation.Site.Name = Convert.ToString(otReader["ShortName"]);
                                }
                                else
                                {
                                    ot.Quotation.Site.Name = Convert.ToString(otReader["Customer"]);
                                }

                                if (otReader["idCountry"] != DBNull.Value)
                                {
                                    ot.Quotation.Site.IdCountry = Convert.ToByte(otReader["idCountry"]);
                                    ot.Quotation.Site.Country = new Country();
                                    ot.Quotation.Site.Country.IdCountry = Convert.ToByte(otReader["idCountry"]);
                                    ot.Quotation.Site.Country.Name = otReader["CountryName"].ToString();
                                    ot.Quotation.Site.Country.Iso = otReader["iso"].ToString();

                                    if (otReader["EuroZone"] != DBNull.Value)
                                    {
                                        ot.Quotation.Site.Country.EuroZone = Convert.ToSByte(otReader["EuroZone"]);
                                    }

                                    if (otReader["IdCountryGroup"] != DBNull.Value)
                                    {
                                        ot.Quotation.Site.CountryGroup = new CountryGroup();
                                        ot.Quotation.Site.CountryGroup.IdCountryGroup = Convert.ToInt64(otReader["IdCountryGroup"]);

                                        if (otReader["CountryGroup"] != DBNull.Value)
                                            ot.Quotation.Site.CountryGroup.Name = Convert.ToString(otReader["CountryGroup"]);

                                        if (otReader["IsFreeTrade"] != DBNull.Value)
                                            ot.Quotation.Site.CountryGroup.IsFreeTrade = Convert.ToByte(otReader["IsFreeTrade"]);
                                    }
                                }

                                ot.Quotation.Site.Customer = new Customer();
                                ot.Quotation.Site.Customer.IdCustomer = Convert.ToInt32(otReader["IdCustomer"]);
                                ot.Quotation.Site.Customer.CustomerName = Convert.ToString(otReader["CustomerName"]);
                            }

                            //Detections Template
                            if (otReader["IdTemplate"] != DBNull.Value)
                            {
                                ot.Quotation.Template = new Template();
                                ot.Quotation.Template.IdTemplate = Convert.ToByte(otReader["IdTemplate"]);
                                ot.Quotation.Template.Name = Convert.ToString(otReader["Template"]);
                                ot.Quotation.Template.Type = Convert.ToInt64(otReader["IdTemplateType"]);
                            }

                            if (otReader["IdOffer"] != DBNull.Value)
                            {
                                ot.Quotation.IdOffer = Convert.ToInt32(otReader["IdOffer"]);

                                ot.Quotation.Offer = new Offer();
                                //ot.Quotation.Offer.Code = Convert.ToString(otReader["OfferCode"]);
                                ot.Quotation.Offer.Description = Convert.ToString(otReader["Description"]);

                                if (otReader["IdCarriageMethod"] != DBNull.Value)
                                {
                                    ot.Quotation.Offer.IdCarriageMethod = Convert.ToByte(otReader["IdCarriageMethod"]);
                                    LookupValue carriage = new LookupValue();
                                    carriage.IdLookupValue = Convert.ToInt32(ot.Quotation.Offer.IdCarriageMethod);
                                    carriage.Value = Convert.ToString(otReader["CarriageValue"]);
                                    carriage.IdImage = Convert.ToInt64(otReader["CarriageImage"]);

                                    ot.Quotation.Offer.CarriageMethod = carriage;
                                }

                                if (otReader["PODate"] != DBNull.Value)
                                    ot.Quotation.Offer.POReceivedInDate = Convert.ToDateTime(otReader["PODate"]);

                                //if (otReader["IdOffer"] != DBNull.Value)
                                //{
                                //    ot.Quotation.Offer.OfferType = new OfferType();
                                //    ot.Quotation.Offer.OfferType.IdOfferType = Convert.ToByte(otReader["IdOfferType"]);
                                //    ot.Quotation.Offer.OfferType.Name = Convert.ToString(otReader["OfferType"]);
                                //}

                                if (otReader["ProducerIdCountryGroup"] != DBNull.Value)
                                {
                                    ot.ProducerIdCountryGroup = Convert.ToInt64(otReader["ProducerIdCountryGroup"]);
                                    ot.CountryGroup = new CountryGroup();
                                    ot.CountryGroup.IdCountryGroup = Convert.ToInt64(otReader["ProducerIdCountryGroup"]);
                                    ot.CountryGroup.Name = Convert.ToString(otReader["ProducerCountryGroup"]);
                                    ot.CountryGroup.HtmlColor = Convert.ToString(otReader["ProducerCountryGroupColor"]);
                                }

                            }
                            ot.OtItems = GetOtItemsByIdOt(connectionString, idOt, warehouse.IdWarehouse);
                            ot.ArticleStocks = GetStockHistoryByIdOT(connectionString, idOt, warehouse.IdWarehouse);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetWorkOrderByIdOt_V2035(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2} ", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetWorkOrderByIdOt_V2035().", category: Category.Info, priority: Priority.Low);
            return ot;
        }


        public void FillPickingMaterialDisbaledFIFO_V2035(OtItem otItem, Warehouses warehouse, string ArticleVisualAidsPath, List<OtItem> otitems)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            otItem.PickingMaterialsList = new List<PickingMaterials>();
            List<PickingArticleStockDetail> pickingArticleStockDetails = new List<PickingArticleStockDetail>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetArticlesStockDetailsByIdArticleDisbaledFIFO_V2035", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", otItem.RevisionItem.WarehouseProduct.Article.IdArticle);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                #region
                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {

                    while (articlesReader.Read())
                    {
                        PickingArticleStockDetail pickingArticleStockDetail = new PickingArticleStockDetail();

                        pickingArticleStockDetail.Article = new Article();
                        if (articlesReader["IdArticle"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            pickingArticleStockDetail.Article.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingArticleStockDetail.Article.Description = Convert.ToString(articlesReader["Description"]);

                            if (articlesReader["ImagePath"] != DBNull.Value)
                                pickingArticleStockDetail.Article.ImagePath = Convert.ToString(articlesReader["ImagePath"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingArticleStockDetail.Article.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                        }

                        if (articlesReader["awlMinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);

                        if (articlesReader["awlMaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);

                        if (articlesReader["ArticleLocationPosition"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationPosition = Convert.ToInt64(articlesReader["ArticleLocationPosition"]);

                        if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                        if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            pickingArticleStockDetail.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                        pickingArticleStockDetail.WarehouseLocation = new WarehouseLocation();
                        if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);


                            pickingArticleStockDetail.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);
                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FullName = Convert.ToString(articlesReader["Fullname"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.HtmlColor = Convert.ToString(articlesReader["HtmlColor"]);

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);
                        }


                        if (articlesReader["UnitPrice"] != DBNull.Value)
                            pickingArticleStockDetail.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                        if (articlesReader["IdCurrency"] != DBNull.Value)
                            pickingArticleStockDetail.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                        if (articlesReader["costprice"] != DBNull.Value)
                            pickingArticleStockDetail.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                        if (articlesReader["MinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                        if (articlesReader["MaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                        pickingArticleStockDetail.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (articlesReader["UploadedIn"] != DBNull.Value)
                            pickingArticleStockDetail.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);

                        if (articlesReader["DeliveryCode"] != DBNull.Value)
                        {

                            pickingArticleStockDetail.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);
                        }


                        if (articlesReader["IdCountryGroup"] != DBNull.Value)
                            pickingArticleStockDetail.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);

                        pickingArticleStockDetails.Add(pickingArticleStockDetail);
                    }
                }
                List<PickingArticleStockDetail> PickingArticleStockDetailSort = new List<PickingArticleStockDetail>();

                foreach (var itemPASD in pickingArticleStockDetails.GroupBy(i => Convert.ToDateTime(i.UploadedIn.Value.ToShortDateString())))
                {
                    foreach (var item in itemPASD.OrderBy(i => i.ArticleLocationPosition).ToList())
                    {
                        PickingArticleStockDetailSort.Add(item);
                    }
                }

                pickingArticleStockDetails = PickingArticleStockDetailSort;

                // Int64 remainingQty = otItem.RevisionItem.RemainingQuantity; // download Quantity.
                foreach (PickingArticleStockDetail itemArticleStock in pickingArticleStockDetails)
                {

                    try
                    {

                        //if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        //{
                        //    Int64 articleCurrentStockRem = 0;
                        //    articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                        //    if (articleCurrentStockRem == 0)
                        //        continue;
                        //    else
                        //        if (remainingQty == 0)
                        //        return;
                        //}
                        //else
                        //{
                        //    if (remainingQty == 0)
                        //        return;
                        //}



                        PickingMaterials pickingMaterials = new PickingMaterials();

                        pickingMaterials.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        pickingMaterials.Article = new Article();
                        pickingMaterials.Article.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;
                        pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                        pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        if (itemArticleStock.ArticleLocationMinimumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = itemArticleStock.ArticleLocationMinimumStock.Value;
                        if (itemArticleStock.ArticleLocationMaximumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = itemArticleStock.ArticleLocationMaximumStock.Value;

                        pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.IdOtitem = otItem.IdOTItem;

                        pickingMaterials.IdRevisionItem = otItem.IdRevisionItem;
                        pickingMaterials.RevisionItem = new RevisionItem();
                        pickingMaterials.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.NumItem = otItem.RevisionItem.NumItem;

                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.Quantity = otItem.RevisionItem.Quantity;

                        if (otItem.RevisionItem != null)
                            if (otItem.RevisionItem.WarehouseProduct != null)
                                pickingMaterials.IdWarehouseProductComponent = otItem.RevisionItem.WarehouseProduct.IdComponent;

                        if (!string.IsNullOrEmpty(otItem.RevisionItem.WarehouseProduct.Article.Reference))
                            pickingMaterials.Reference = otItem.RevisionItem.WarehouseProduct.Article.Reference;

                        if (itemArticleStock.ArticleCurrentStock != null)
                            pickingMaterials.ArticleCurrentStock = itemArticleStock.ArticleCurrentStock.Value;

                        if (itemArticleStock.CurrentStock != null)
                            pickingMaterials.CurrentStock = itemArticleStock.CurrentStock.Value;

                        if (itemArticleStock.CostPrice != null)
                            pickingMaterials.CostPrice = itemArticleStock.CostPrice.Value;

                        if (itemArticleStock.UnitPrice != null)
                            pickingMaterials.UnitPrice = itemArticleStock.UnitPrice.Value;


                        pickingMaterials.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        if (pickingMaterials.IdWareHouseDeliveryNoteItem != null)
                        {
                            pickingMaterials.IdWareHouseDeliveryNoteItem = itemArticleStock.IdWareHouseDeliveryNoteItem.Value;


                            pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.Manufacturer = GeManufacturerByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbers(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, itemArticleStock.WarehouseLocation.IdWarehouse));
                        }


                        pickingMaterials.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;


                        pickingMaterials.LocationFullName = itemArticleStock.WarehouseLocation.FullName;


                        pickingMaterials.Description = itemArticleStock.Article.Description;

                        if (!string.IsNullOrEmpty(itemArticleStock.Article.ImagePath))
                        {
                            pickingMaterials.ImagePath = itemArticleStock.Article.ImagePath;
                            Article article = new Article();
                            article.ImagePath = pickingMaterials.ImagePath;
                            pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                        }


                        if (itemArticleStock.MinimumStock != null)
                            pickingMaterials.MinimumStock = itemArticleStock.MinimumStock.Value;

                        if (itemArticleStock.MaximumStock != null)
                            pickingMaterials.MaximumStock = itemArticleStock.MaximumStock.Value;

                        pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (itemArticleStock.UploadedIn != null)
                        {
                            pickingMaterials.UploadedIn = itemArticleStock.UploadedIn;
                            pickingMaterials.WarehouseDeliveryNote.DeliveryDate = itemArticleStock.UploadedIn.Value;
                        }


                        pickingMaterials.WarehouseDeliveryNote.Code = itemArticleStock.WarehouseDeliveryNote.Code;


                        pickingMaterials.IdCurrency = itemArticleStock.IdCurrency;

                        pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;

                        //if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        //{
                        //    Int64 articleCurrentStockRem = 0;
                        //    articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                        //    if (articleCurrentStockRem > 0)
                        //    {
                        //        if (remainingQty > 0 && articleCurrentStockRem > 0)
                        //        {
                        //            if (articleCurrentStockRem > remainingQty)
                        //            {
                        //                pickingMaterials.DownloadQuantity = remainingQty;
                        //                remainingQty = 0;
                        //            }
                        //            else
                        //            {
                        //                pickingMaterials.DownloadQuantity = articleCurrentStockRem;
                        //                remainingQty = remainingQty - articleCurrentStockRem;
                        //            }

                        //        }
                        //    }
                        //    else
                        //    {
                        //        if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                        //        {
                        //            if (pickingMaterials.ArticleCurrentStock > remainingQty)
                        //            {
                        //                pickingMaterials.DownloadQuantity = remainingQty;
                        //                remainingQty = 0;
                        //            }
                        //            else
                        //            {
                        //                pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                        //                remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                        //            }

                        //        }
                        //    }
                        //}
                        //else
                        //{
                        //    if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                        //    {
                        //        if (pickingMaterials.ArticleCurrentStock > remainingQty)
                        //        {
                        //            pickingMaterials.DownloadQuantity = remainingQty;
                        //            remainingQty = 0;
                        //        }
                        //        else
                        //        {
                        //            pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                        //            remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                        //        }

                        //    }
                        //}

                        pickingMaterials.WarehouseLocation = new WarehouseLocation();

                        pickingMaterials.WarehouseLocation.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        pickingMaterials.WarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.WarehouseLocation.FullName = itemArticleStock.WarehouseLocation.FullName;

                        pickingMaterials.WarehouseLocation.HtmlColor = itemArticleStock.WarehouseLocation.HtmlColor;

                        pickingMaterials.WarehouseLocation.Latitude = itemArticleStock.WarehouseLocation.Latitude;

                        pickingMaterials.WarehouseLocation.Longitude = itemArticleStock.WarehouseLocation.Longitude;

                        pickingMaterials.WarehouseLocation.Width = itemArticleStock.WarehouseLocation.Width;

                        pickingMaterials.WarehouseLocation.Height = itemArticleStock.WarehouseLocation.Height;

                        pickingMaterials.WarehouseLocation.FileName = itemArticleStock.WarehouseLocation.FileName;

                        pickingMaterials.RegisterSerialNumber = itemArticleStock.Article.RegisterSerialNumber;

                        pickingMaterials.PartNumberCode = GetPartNumberCode(otItem.IdOTItem, connectionString);

                        if (itemArticleStock.IdCountryGroup != null)
                            pickingMaterials.IdCountryGroup = itemArticleStock.IdCountryGroup.Value;

                        ////Add in otSameReferenceList
                        //OtItemSameReference otItemSameReference = new OtItemSameReference();
                        //otItemSameReference.IdArticle = pickingMaterials.IdArticle;
                        //otItemSameReference.IdWarehouseDeliveryNoteItem = pickingMaterials.IdWareHouseDeliveryNoteItem;
                        //otItemSameReference.ArticleCurrentStock = pickingMaterials.ArticleCurrentStock;
                        //otItemSameReference.Qty = pickingMaterials.DownloadQuantity;
                        //otItemSameReference.IdWarehouseLocation = pickingMaterials.WarehouseLocation.IdWarehouseLocation;
                        //otItemSameReferences.Add(otItemSameReference);

                        otItem.PickingMaterialsList.Add(pickingMaterials);

                        //GetTotalArticleDownloadDetailByOtItem(connectionString, 1800, 35259);

                    }
                    catch (Exception ex)
                    {
                        Log4NetLogger.Logger.Log(string.Format("Error FillPickingMaterialDisbaledFIFO_V2035(IdArticle-{0}, idWarehouse-{1}). ErrorMessage- {2}", otItem.RevisionItem.WarehouseProduct.Article.IdArticle, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                        throw;
                    }
                }
                #endregion

            }
        }

        public List<OtItem> GetRemainingOtItemsByIdOtDisbaledFIFO_V2035(Int64 idOt, Warehouses warehouse, string ArticleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OtItem> otItems = new List<OtItem>();
            List<OtItemSameReference> OtItemSameReferences = new List<OtItemSameReference>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetRemainingOtItemsByIdOt", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOt", idOt);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OtItem otItem = new OtItem();

                            otItem.IdOT = idOt;

                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);



                            otItem.IsBatch = Convert.ToByte(otItemReader["IsBatch"]);

                            if (otItemReader["AttachedFiles"] != DBNull.Value)
                                otItem.AttachedFiles = Convert.ToString(otItemReader["AttachedFiles"]);

                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);
                                otItem.RevisionItem.Quantity = Convert.ToInt64(otItemReader["Quantity"]);
                                otItem.RevisionItem.UnitPrice = Convert.ToDecimal(otItemReader["UnitPrice"]);

                                if (otItemReader["CustomerCommentOT"] != DBNull.Value)
                                    otItem.RevisionItem.InternalComment = Convert.ToString(otItemReader["CustomerCommentOT"]);

                                if (otItemReader["CustomerCommentRevision"] != DBNull.Value)
                                    otItem.RevisionItem.CustomerComment = Convert.ToString(otItemReader["CustomerCommentRevision"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);

                                if (otItemReader["WpDescription"] != DBNull.Value)
                                    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["ArticleDescription"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["ArticleDescription"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    if (otItemReader["UploadedIn"] != DBNull.Value)
                                        article.UploadedIn = Convert.ToDateTime(otItemReader["UploadedIn"]);

                                    if (otItemReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                        article.IdWareHouseDeliveryNoteItem = Convert.ToInt64(otItemReader["IdWareHouseDeliveryNoteItem"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    article.MyWarehouse = new MyWarehouse();

                                    if (otItemReader["MinimumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MinimumStock"]);

                                    if (otItemReader["MaximumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MaximumStock"]);

                                    if (otItemReader["CurrentStock"] != DBNull.Value)
                                        article.MyWarehouse.CurrentStock = Convert.ToInt64(otItemReader["CurrentStock"]);


                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);

                                    otItem.Status = new ItemOTStatusType();
                                    otItem.Status.IdItemOtStatus = otItem.IdItemOtStatus;
                                    otItem.Status.Name = Convert.ToString(otItemReader["Status"]);
                                }

                                if (otItemReader["AssignedTo"] != DBNull.Value)
                                {
                                    otItem.AssignedTo = Convert.ToInt32(otItemReader["AssignedTo"]);

                                    otItem.AssignedToUser = new People();
                                    otItem.AssignedToUser.Name = Convert.ToString(otItemReader["AssignedName"]);
                                    otItem.AssignedToUser.Surname = Convert.ToString(otItemReader["AssignedSurname"]);
                                }

                                if (otItemReader["DownloadedQty"] != DBNull.Value)
                                    otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otItemReader["DownloadedQty"]);

                                if (otItemReader["RemainingQty"] != DBNull.Value)
                                    otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otItemReader["RemainingQty"]);

                                if (otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;


                                List<OtItem> decomposedOtItems = GetArticlesForDecompositionScanDisabledFIFO_V2035(idOt, warehouse, otItem, ArticleVisualAidsPath, OtItemSameReferences, otItem.RevisionItem.WarehouseProduct.Article.IdArticleType);

                                //if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                //    otItems.AddRange(decomposedOtItems);



                                if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                {
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    otItem.ArticleDecomposedList = decomposedOtItems;
                                }


                                FillPickingMaterialDisbaledFIFO_V2035(otItem, warehouse, ArticleVisualAidsPath, otItems);
                            }

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRemainingOtItemsByIdOtDisbaledFIFO_V2035(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetRemainingOtItemsByIdOtDisbaledFIFO_V2035).", category: Category.Info, priority: Priority.Low);
            return otItems;
        }


        /// <summary>
        /// [WAREHOUSE-M028-07] Load info by warehouse - Load PurchaseOrders PendingReception by warehouse 
        /// </summary>
        /// <param name="warehouse">The warehouse for connection string</param>
        /// <returns>List of warehouse purchase order details</returns>
        public List<WarehousePurchaseOrder> GetPurchaseOrdersPendingReceptionByWarehouse_V2035(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<WarehousePurchaseOrder> warehousePurchaseOrders = new List<WarehousePurchaseOrder>();

            using (MySqlConnection connPurchaseOrders = new MySqlConnection(connectionString))
            {
                connPurchaseOrders.Open();

                MySqlCommand poCommand = new MySqlCommand("WMS_GetPurchaseOrdersPendingReceptionByWarehouse_V2035", connPurchaseOrders);
                poCommand.CommandType = CommandType.StoredProcedure;
                poCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader poReader = poCommand.ExecuteReader())
                {
                    double totalQuantity = 0;
                    double receivedQuantity = 0;

                    while (poReader.Read())
                    {
                        try
                        {
                            totalQuantity = 0;
                            receivedQuantity = 0;

                            WarehousePurchaseOrder warehousePurchaseOrder = new WarehousePurchaseOrder();

                            warehousePurchaseOrder.IdWarehousePurchaseOrder = Convert.ToInt64(poReader["idWarehousepurchaseorder"]);

                            if (poReader["Code"] != DBNull.Value)
                                warehousePurchaseOrder.Code = Convert.ToString(poReader["Code"]);

                            if (poReader["IdArticleSupplier"] != DBNull.Value)
                            {
                                ArticleSupplier articleSupplier = new ArticleSupplier();

                                articleSupplier.IdArticleSupplier = Convert.ToInt64(poReader["IdArticleSupplier"]);

                                if (poReader["Supplier"] != DBNull.Value)
                                    articleSupplier.Name = Convert.ToString(poReader["Supplier"]);

                                if (poReader["IdCountry"] != DBNull.Value)
                                {
                                    articleSupplier.IdCountry = Convert.ToInt64(poReader["IdCountry"]);

                                    articleSupplier.Country = new Country();
                                    articleSupplier.Country.IdCountry = Convert.ToByte(poReader["IdCountry"]);
                                    articleSupplier.Country.Name = Convert.ToString(poReader["CountryName"]);
                                }

                                warehousePurchaseOrder.ArticleSupplier = articleSupplier;
                            }

                            if (poReader["DeliveryDate"] != DBNull.Value && Convert.ToDateTime(poReader["deliveryDate"]) != DateTime.MinValue)
                            {
                                warehousePurchaseOrder.DeliveryDate = Convert.ToDateTime(poReader["deliveryDate"]);
                                warehousePurchaseOrder.Delay = (int)(warehousePurchaseOrder.DeliveryDate.Value.Date - DateTime.Now.Date).TotalDays;
                            }

                            if (poReader["AttachedPO"] != DBNull.Value)
                                warehousePurchaseOrder.AttachedPO = Convert.ToByte(poReader["AttachedPO"]);

                            if (poReader["Deliveries"] != DBNull.Value)
                            {
                                warehousePurchaseOrder.Deliveries = Convert.ToInt32(poReader["Deliveries"]);

                                if (warehousePurchaseOrder.Deliveries > 0)
                                {
                                    warehousePurchaseOrder.IsPartialPending = true;
                                }
                            }

                            if (poReader["LatestDeliveryDate"] != DBNull.Value)
                                warehousePurchaseOrder.LatestDeliveryDate = Convert.ToDateTime(poReader["LatestDeliveryDate"]);

                            if (poReader["IdWarehouse"] != DBNull.Value)
                                warehousePurchaseOrder.IdWarehouse = Convert.ToInt64(poReader["IdWarehouse"]);

                            if (poReader["OrderQty"] != DBNull.Value)
                                totalQuantity = Convert.ToDouble(poReader["OrderQty"]);

                            if (poReader["ReceivedQuantity"] != DBNull.Value)
                                receivedQuantity = Convert.ToDouble(poReader["ReceivedQuantity"]);

                            if (totalQuantity > 0)
                                warehousePurchaseOrder.Status = (Int16)((receivedQuantity / totalQuantity) * 100);

                            //warehousePurchaseOrder.WarehousePurchaseOrderItems = GetArticlesByIdWarehousePurchaseOrder(connectionString, warehousePurchaseOrder.IdWarehousePurchaseOrder);

                            //if (warehousePurchaseOrder.WarehousePurchaseOrderItems.Count > 0)
                            //{
                            //    double totalQuantity = warehousePurchaseOrder.WarehousePurchaseOrderItems.Sum(x => Convert.ToInt32(x.Quantity));
                            //    double receivedQuantity = warehousePurchaseOrder.WarehousePurchaseOrderItems.Sum(x => Convert.ToInt32(x.ReceivedQuantity));

                            //    if (totalQuantity > 0)
                            //        warehousePurchaseOrder.Status = (Int16)((receivedQuantity / totalQuantity) * 100);
                            //}

                            warehousePurchaseOrders.Add(warehousePurchaseOrder);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPurchaseOrdersPendingReception(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetPurchaseOrdersPendingReception().", category: Category.Info, priority: Priority.Low);
            return warehousePurchaseOrders;
        }



        public List<Ots> GetPendingMaterialWorkOrdersByWarehouse_V2035(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<Ots> ots = new List<Ots>();

            using (MySqlConnection connOts = new MySqlConnection(connectionString))
            {
                connOts.Open();

                MySqlCommand otsCommand = new MySqlCommand("WMS_GetPendingMaterialWorkOrdersByWarehouse_V2035", connOts);
                otsCommand.CommandType = CommandType.StoredProcedure;
                otsCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                otsCommand.CommandTimeout = 8000;

                using (MySqlDataReader otReader = otsCommand.ExecuteReader())
                {
                    if (otReader.HasRows)
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = new Ots();
                                ot.IdOT = Convert.ToInt64(otReader["IdOT"]);
                                ot.NumOT = Convert.ToByte(otReader["NumOT"]);

                                if (otReader["OtCode"] != DBNull.Value)
                                {
                                    ot.Code = Convert.ToString(otReader["OtCode"]);
                                    ot.MergeCode = Convert.ToString(otReader["MergeCode"]);
                                }

                                if (otReader["DeliveryDate"] != DBNull.Value)
                                {
                                    ot.DeliveryDate = Convert.ToDateTime(otReader["DeliveryDate"]);
                                    ot.Delay = (int)(ot.DeliveryDate.Value.Date - DateTime.Now.Date).TotalDays;
                                }

                                ot.Quotation = new Quotation();

                                if (otReader["IdQuotation"] != DBNull.Value)
                                {
                                    ot.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                                    ot.Quotation.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                                    ot.Quotation.Code = Convert.ToString(otReader["QuotationCode"]);
                                }

                                if (otReader["IdTemplate"] != DBNull.Value)
                                {
                                    ot.Quotation.IdDetectionsTemplate = Convert.ToByte(otReader["IdTemplate"]);

                                    ot.Quotation.Template = new Template();
                                    ot.Quotation.Template.IdTemplate = ot.Quotation.IdDetectionsTemplate;
                                    ot.Quotation.Template.Name = Convert.ToString(otReader["Template"]);
                                    ot.Quotation.Template.IdTemplate = Convert.ToByte(otReader["TemplateType"]);
                                }

                                if (otReader["IdOffer"] != DBNull.Value)
                                {
                                    ot.Quotation.IdOffer = Convert.ToInt64(otReader["IdOffer"]);
                                    ot.Quotation.Offer = new Offer();
                                    ot.Quotation.Offer.IdOffer = ot.Quotation.IdOffer;

                                    if (otReader["IsCritical"] != DBNull.Value)
                                        ot.Quotation.Offer.IsCritical = Convert.ToByte(otReader["IsCritical"]);

                                    if (otReader["IdStatus"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdStatus = Convert.ToInt64(otReader["IdStatus"]);
                                        ot.Quotation.Offer.GeosStatus = new GeosStatus();
                                        ot.Quotation.Offer.GeosStatus.IdOfferStatusType = Convert.ToInt64(otReader["IdStatus"]);
                                        ot.Quotation.Offer.GeosStatus.Name = Convert.ToString(otReader["OfferStatus"]);
                                        ot.Quotation.Offer.GeosStatus.HtmlColor = Convert.ToString(otReader["OfferStatusHtmlColor"]);

                                        if (otReader["IdSalesStatusType"] != DBNull.Value)
                                        {
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType = new SalesStatusType();
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.IdSalesStatusType = Convert.ToInt64(otReader["IdSalesStatusType"]);
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.Name = Convert.ToString(otReader["SalesStatusType"]);
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.HtmlColor = Convert.ToString(otReader["SalesStatusHtmlColor"]);
                                            if (otReader["SalesStatusIdImage"] != DBNull.Value)
                                                ot.Quotation.Offer.GeosStatus.SalesStatusType.IdImage = Convert.ToInt64(otReader["SalesStatusIdImage"]);
                                        }
                                    }

                                    ot.Quotation.Offer.Code = Convert.ToString(otReader["OfferCode"]);
                                    ot.Quotation.Offer.Description = Convert.ToString(otReader["Description"]);


                                    if (otReader["IdOfferType"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdOfferType = Convert.ToByte(otReader["IdOfferType"]);

                                        ot.Quotation.Offer.OfferType = new OfferType();
                                        ot.Quotation.Offer.OfferType.IdOfferType = Convert.ToByte(ot.Quotation.Offer.IdOfferType);
                                        ot.Quotation.Offer.OfferType.Name = Convert.ToString(otReader["OfferType"]);

                                        //ot.MergeCode = ot.Quotation.Code + " " + ot.Quotation.Offer.OfferType.Name + " " + ot.NumOT;
                                    }

                                    if (otReader["IdCarriageMethod"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdCarriageMethod = Convert.ToByte(otReader["IdCarriageMethod"]);
                                        ot.Quotation.Offer.CarriageMethod = new LookupValue();
                                        ot.Quotation.Offer.CarriageMethod.IdLookupValue = Convert.ToByte(ot.Quotation.Offer.IdCarriageMethod);
                                        ot.Quotation.Offer.CarriageMethod.Value = Convert.ToString(otReader["CarriageMethod"]);

                                        if (otReader["CarriageImage"] != DBNull.Value)
                                            ot.Quotation.Offer.CarriageMethod.IdImage = Convert.ToInt64(otReader["CarriageImage"]);
                                    }
                                }

                                if (otReader["IdWarehouse"] != DBNull.Value)
                                {
                                    ot.Quotation.IdWarehouse = Convert.ToInt64(otReader["IdWarehouse"]);
                                }

                                if (otReader["IdSite"] != DBNull.Value)
                                {
                                    ot.Quotation.IdCustomer = Convert.ToInt32(otReader["IdSite"]);
                                    ot.Quotation.Site = new Company();
                                    ot.Quotation.Site.IdCompany = ot.Quotation.IdCustomer;
                                    ot.Quotation.Site.SiteNameWithoutCountry = Convert.ToString(otReader["SiteName"]);

                                    if (otReader["ShortName"] != DBNull.Value && !string.IsNullOrEmpty(Convert.ToString(otReader["ShortName"])))
                                    {
                                        ot.Quotation.Site.ShortName = Convert.ToString(otReader["ShortName"]);
                                        ot.Quotation.Site.Name = ot.Quotation.Site.ShortName;
                                    }
                                    else
                                    {
                                        ot.Quotation.Site.ShortName = null;
                                        ot.Quotation.Site.Name = Convert.ToString(otReader["SiteName"]);
                                    }

                                    ot.Quotation.Site.Customer = new Customer();
                                    ot.Quotation.Site.Customer.IdCustomer = Convert.ToInt32(otReader["IdCustomer"]);
                                    ot.Quotation.Site.Customer.CustomerName = Convert.ToString(otReader["CustomerName"]);

                                    if (otReader["IdCountry"] != DBNull.Value)
                                    {
                                        ot.Quotation.Site.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country = new Country();
                                        ot.Quotation.Site.Country.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country.Name = Convert.ToString(otReader["CountryName"]);
                                    }
                                }

                                if (otReader["ActualQty"] != DBNull.Value)
                                    ot.ActualQuantity = Convert.ToInt64(otReader["ActualQty"]);

                                if (otReader["DownloadedQty"] != DBNull.Value)
                                    ot.DownloadedQuantity = Convert.ToInt64(otReader["DownloadedQty"]);

                                if (otReader["PODate"] != DBNull.Value)
                                    ot.PoDate = Convert.ToDateTime(otReader["PODate"]);

                                if (otReader["ProducerCountryGroupName"] != DBNull.Value)
                                {
                                    ot.CountryGroup = new CountryGroup();
                                    ot.CountryGroup.Name = otReader["ProducerCountryGroupName"].ToString();
                                    if (otReader["ProducerCountryGroupHTMLColor"] != DBNull.Value)
                                        ot.CountryGroup.HtmlColor = otReader["ProducerCountryGroupHTMLColor"].ToString();
                                }

                                if (otReader["OtItemsCount"] != DBNull.Value)
                                    ot.OtItemCount = Convert.ToInt64(otReader["OtItemsCount"].ToString());

                                ot.RemainingQuantity = ot.ActualQuantity + ot.DownloadedQuantity;
                                if (ot.ActualQuantity > 0)
                                {
                                    ot.Status = (Int16)((Math.Abs(ot.DownloadedQuantity) / ot.ActualQuantity) * 100);
                                }
                                ot.OtItems = new List<OtItem>();
                                ots.Add(ot);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2032() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otItem = new OtItem();
                                    if (otReader["IdOT"] != DBNull.Value)
                                        otItem.IdOT = Convert.ToInt64(otReader["IdOT"]);
                                    if (otReader["IdOtItem"] != DBNull.Value)
                                        otItem.IdOTItem = Convert.ToInt64(otReader["IdOtItem"]);
                                    if (otReader["IdRevisionItem"] != DBNull.Value)
                                    {
                                        otItem.IdRevisionItem = Convert.ToInt64(otReader["IdRevisionItem"]);
                                        otItem.RevisionItem = new RevisionItem();
                                        otItem.RevisionItem.IdRevisionItem = Convert.ToInt64(otReader["IdRevisionItem"]);
                                        otItem.RevisionItem.Quantity = Convert.ToDecimal(otReader["Quantity"]);
                                        if (otReader["DownloadedQty"] != DBNull.Value)
                                            otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otReader["DownloadedQty"]);

                                        if (otReader["RemainingQty"] != DBNull.Value)
                                            otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otReader["RemainingQty"]);
                                    }
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    ot.OtItems.Add(otItem);
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2032() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }


                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(otReader["idotitem"])).FirstOrDefault();

                                    OtItem decomposed = new OtItem();
                                    if (otitem != null)
                                    {
                                        decomposed.IdOT = ot.IdOT;
                                        decomposed.IdOTItem = Convert.ToInt64(otReader["IdOtItem"]);

                                        if (otReader["idParent"] != DBNull.Value)
                                        {
                                            decomposed.ParentId = Convert.ToInt32(otReader["idParent"]);
                                        }
                                        decomposed.RevisionItem = new RevisionItem();
                                        decomposed.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                        decomposed.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otReader["IdWarehouseproduct"]);



                                        if (otReader["IdComponent"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otReader["IdComponent"]);
                                        }
                                        if (decomposed.ParentId == -1)
                                        {
                                            if (otReader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = otitem.RevisionItem.Quantity * Convert.ToDecimal(otReader["Quantity"]);
                                        }
                                        else
                                        {
                                            decimal qty = otitem.ArticleDecomposedList.First(x => x.RevisionItem.WarehouseProduct.IdComponent == decomposed.ParentId).RevisionItem.Quantity;
                                            if (otReader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = qty * Convert.ToDecimal(otReader["Quantity"]);
                                        }

                                        if (otReader["IdArticle"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otReader["IdArticle"]);
                                        }

                                        // int downloaded = GetOtItemDownloadedQuantity(connectionString, decomposed.RevisionItem.WarehouseProduct.IdArticle, decomposed.IdOTItem, decomposed.RevisionItem.WarehouseProduct.IdComponent, Convert.ToInt64(warehouseIds));


                                        decomposed.RevisionItem.DownloadedQuantity = 0;

                                        //  decomposed.RevisionItem.RemainingQuantity = ((Int64)decomposed.RevisionItem.Quantity - downloaded);




                                        otitem.ArticleDecomposedList.Add(decomposed);

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2032() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(otReader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(otReader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(otReader["idarticle"]) && i.RevisionItem.WarehouseProduct.IdComponent == Convert.ToInt64(otReader["idwarehouseproductcomponent"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (otReader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(otReader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2032() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(otReader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(otReader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(otReader["idarticle"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (otReader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(otReader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2032() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }




                    foreach (Ots itemOT in ots)
                    {
                        Int64 downloadedQty = 0;
                        decimal Qty = 0;
                        foreach (OtItem itemOtitem in itemOT.OtItems)
                        {
                            if (itemOtitem.ArticleDecomposedList.Count > 0)
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.DownloadedQuantity));
                                Qty = Qty + itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.Quantity);
                                // ot.Status = (Int16)((Math.Abs(ot.DownloadedQuantity) / ot.ActualQuantity) * 100);

                            }
                            else
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.RevisionItem.DownloadedQuantity);
                                Qty = Qty + itemOtitem.RevisionItem.Quantity;
                            }

                        }
                        if (Qty > 0)
                        {
                            itemOT.Status = (Int16)((Math.Abs(downloadedQty) / Qty) * 100);
                        }
                    }
                }
            }

            ots = ots.Where(x => x.Status < 100).ToList();
            Log4NetLogger.Logger.Log("Executed GetPendingMaterialWorkOrdersByWarehouse_V2032().", category: Category.Info, priority: Priority.Low);
            return ots;
        }


        public List<Ots> GetPackingWorkOrdersByWarehouse_V2035(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<Ots> ots = new List<Ots>();
            //object geosAppSetting = null;
            //UserManager usermgr = new UserManager();

            //geosAppSetting = usermgr.GetSelectedGeosAppSettings(workbenchConnectionString, "14,15,16,17");



            using (MySqlConnection connOts = new MySqlConnection(connectionString))
            {
                connOts.Open();

                MySqlCommand otsCommand = new MySqlCommand("WMS_GetPackingWorkOrders_V2035", connOts);
                otsCommand.CommandType = CommandType.StoredProcedure;
                otsCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                otsCommand.CommandTimeout = 6000;

                using (MySqlDataReader otReader = otsCommand.ExecuteReader())
                {
                    if (otReader.HasRows)
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = new Ots();
                                // ot.GeosAppSettings = geosAppSetting;
                                ot.IdOT = Convert.ToInt64(otReader["IdOT"]);
                                ot.NumOT = Convert.ToByte(otReader["NumOT"]);

                                if (otReader["OtCode"] != DBNull.Value)
                                {
                                    ot.Code = Convert.ToString(otReader["OtCode"]);
                                    ot.MergeCode = Convert.ToString(otReader["MergeCode"]);
                                }

                                if (otReader["DeliveryDate"] != DBNull.Value)
                                {
                                    ot.DeliveryDate = Convert.ToDateTime(otReader["DeliveryDate"]);
                                    ot.Delay = (int)(ot.DeliveryDate.Value.Date - DateTime.Now.Date).TotalDays;
                                }

                                ot.Quotation = new Quotation();

                                if (otReader["IdQuotation"] != DBNull.Value)
                                {
                                    ot.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                                    ot.Quotation.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                                    ot.Quotation.Code = Convert.ToString(otReader["QuotationCode"]);
                                }

                                if (otReader["IdTemplate"] != DBNull.Value)
                                {
                                    ot.Quotation.IdDetectionsTemplate = Convert.ToByte(otReader["IdTemplate"]);

                                    ot.Quotation.Template = new Template();
                                    ot.Quotation.Template.IdTemplate = ot.Quotation.IdDetectionsTemplate;
                                    ot.Quotation.Template.Name = Convert.ToString(otReader["Template"]);
                                    ot.Quotation.Template.IdTemplate = Convert.ToByte(otReader["TemplateType"]);
                                }

                                if (otReader["IdOffer"] != DBNull.Value)
                                {
                                    ot.Quotation.IdOffer = Convert.ToInt64(otReader["IdOffer"]);
                                    ot.Quotation.Offer = new Offer();
                                    ot.Quotation.Offer.IdOffer = ot.Quotation.IdOffer;

                                    if (otReader["IsCritical"] != DBNull.Value)
                                        ot.Quotation.Offer.IsCritical = Convert.ToByte(otReader["IsCritical"]);

                                    if (otReader["IdStatus"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdStatus = Convert.ToInt64(otReader["IdStatus"]);
                                        ot.Quotation.Offer.GeosStatus = new GeosStatus();
                                        ot.Quotation.Offer.GeosStatus.IdOfferStatusType = Convert.ToInt64(otReader["IdStatus"]);
                                        ot.Quotation.Offer.GeosStatus.Name = Convert.ToString(otReader["OfferStatus"]);
                                        ot.Quotation.Offer.GeosStatus.HtmlColor = Convert.ToString(otReader["OfferStatusHtmlColor"]);

                                        if (otReader["IdSalesStatusType"] != DBNull.Value)
                                        {
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType = new SalesStatusType();
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.IdSalesStatusType = Convert.ToInt64(otReader["IdSalesStatusType"]);
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.Name = Convert.ToString(otReader["SalesStatusType"]);
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.HtmlColor = Convert.ToString(otReader["SalesStatusHtmlColor"]);
                                            if (otReader["SalesStatusIdImage"] != DBNull.Value)
                                                ot.Quotation.Offer.GeosStatus.SalesStatusType.IdImage = Convert.ToInt64(otReader["SalesStatusIdImage"]);
                                        }
                                    }

                                    ot.Quotation.Offer.Code = Convert.ToString(otReader["OfferCode"]);
                                    ot.Quotation.Offer.Description = Convert.ToString(otReader["Description"]);

                                    //if (otReader["POCloseDate"] != DBNull.Value)
                                    //    ot.Quotation.Offer.DeliveryDate = Convert.ToDateTime(otReader["POCloseDate"]);

                                    if (otReader["IdOfferType"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdOfferType = Convert.ToByte(otReader["IdOfferType"]);

                                        ot.Quotation.Offer.OfferType = new OfferType();
                                        ot.Quotation.Offer.OfferType.IdOfferType = Convert.ToByte(ot.Quotation.Offer.IdOfferType);
                                        ot.Quotation.Offer.OfferType.Name = Convert.ToString(otReader["OfferType"]);

                                        //ot.MergeCode = ot.Quotation.Code + " " + ot.Quotation.Offer.OfferType.Name + " " + ot.NumOT;
                                    }

                                    if (otReader["IdCarriageMethod"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdCarriageMethod = Convert.ToByte(otReader["IdCarriageMethod"]);
                                        ot.Quotation.Offer.CarriageMethod = new LookupValue();
                                        ot.Quotation.Offer.CarriageMethod.IdLookupValue = Convert.ToByte(ot.Quotation.Offer.IdCarriageMethod);
                                        ot.Quotation.Offer.CarriageMethod.Value = Convert.ToString(otReader["CarriageMethod"]);

                                        if (otReader["CarriageImage"] != DBNull.Value)
                                            ot.Quotation.Offer.CarriageMethod.IdImage = Convert.ToInt64(otReader["CarriageImage"]);
                                    }
                                }

                                if (otReader["IdWarehouse"] != DBNull.Value)
                                {
                                    ot.Quotation.IdWarehouse = Convert.ToInt64(otReader["IdWarehouse"]);
                                }

                                if (otReader["IdSite"] != DBNull.Value)
                                {
                                    ot.Quotation.IdCustomer = Convert.ToInt32(otReader["IdSite"]);
                                    ot.Quotation.Site = new Company();
                                    ot.Quotation.Site.IdCompany = ot.Quotation.IdCustomer;
                                    ot.Quotation.Site.SiteNameWithoutCountry = Convert.ToString(otReader["SiteName"]);

                                    if (otReader["ShortName"] != DBNull.Value && !string.IsNullOrEmpty(Convert.ToString(otReader["ShortName"])))
                                    {
                                        ot.Quotation.Site.ShortName = Convert.ToString(otReader["ShortName"]);
                                        ot.Quotation.Site.Name = ot.Quotation.Site.ShortName;
                                    }
                                    else
                                    {
                                        ot.Quotation.Site.ShortName = null;
                                        ot.Quotation.Site.Name = Convert.ToString(otReader["SiteName"]);
                                    }

                                    ot.Quotation.Site.Customer = new Customer();
                                    ot.Quotation.Site.Customer.IdCustomer = Convert.ToInt32(otReader["IdCustomer"]);
                                    ot.Quotation.Site.Customer.CustomerName = Convert.ToString(otReader["CustomerName"]);

                                    if (otReader["IdCountry"] != DBNull.Value)
                                    {
                                        ot.Quotation.Site.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country = new Country();
                                        ot.Quotation.Site.Country.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country.Name = Convert.ToString(otReader["CountryName"]);
                                    }
                                }

                                if (otReader["ActualQty"] != DBNull.Value)
                                    ot.ActualQuantity = Convert.ToInt64(otReader["ActualQty"]);



                                if (otReader["PODate"] != DBNull.Value)
                                    ot.PoDate = Convert.ToDateTime(otReader["PODate"]);

                                if (otReader["ProducerCountryGroupName"] != DBNull.Value)
                                {
                                    ot.CountryGroup = new CountryGroup();
                                    ot.CountryGroup.Name = otReader["ProducerCountryGroupName"].ToString();
                                    if (otReader["ProducerCountryGroupHTMLColor"] != DBNull.Value)
                                        ot.CountryGroup.HtmlColor = otReader["ProducerCountryGroupHTMLColor"].ToString();
                                }


                                ots.Add(ot);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPackingWorkOrdersByWarehouse() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetPackingWorkOrdersByWarehouse().", category: Category.Info, priority: Priority.Low);
                    return ots;
                }


            }
        }

        public List<OtItem> GetArticlesForDecompositionScanDisabledFIFO_V2035(Int64 idOt, Warehouses warehouse, OtItem parentOtItem, string ArticleVisualAidsPath, List<OtItemSameReference> otItemSameReferences, Int64 idArticleType)
        {
            List<OtItem> otItems = new List<OtItem>();

            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetArticlesForDecomposition", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOTitem", parentOtItem.IdOTItem);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            // keyId++;

                            OtItem otItem = new OtItem();
                            otItem.IdOT = idOt;
                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);

                            if (otItemReader["IdItemOtStatus"] != DBNull.Value)
                                otItem.IdItemOtStatus = Convert.ToByte(otItemReader["IdItemOtStatus"]);


                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);



                                if (otItemReader["IdComponent"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otItemReader["IdComponent"]);
                                }

                                //   otItem.KeyId = keyId;

                                if (otItemReader["idParent"] != DBNull.Value)
                                {
                                    otItem.ParentId = Convert.ToInt32(otItemReader["idParent"]);
                                }

                                if (otItem.ParentId == -1)
                                {
                                    otItem.ParentId = parentOtItem.KeyId;
                                    otItem.RevisionItem.Quantity = parentOtItem.RevisionItem.Quantity * Convert.ToDecimal(otItemReader["Quantity"]);
                                }
                                else
                                {
                                    //OtItem otItem213 = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId);

                                    decimal qty = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).RevisionItem.Quantity;
                                    otItem.RevisionItem.Quantity = qty * Convert.ToDecimal(otItemReader["Quantity"]);
                                    otItem.ParentId = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).KeyId;
                                }

                                //if (otItemReader["WpDescription"] != DBNull.Value)
                                //    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["Description"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["Description"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Weight"] != DBNull.Value)
                                        article.Weight = Convert.ToDecimal(otItemReader["Weight"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);
                                }


                                int downloaded = GetOtItemDownloadedQuantity(connectionString, otItem.RevisionItem.WarehouseProduct.Article.IdArticle, otItem.IdOTItem, otItem.RevisionItem.WarehouseProduct.IdComponent, warehouse.IdWarehouse);


                                otItem.RevisionItem.DownloadedQuantity = downloaded;

                                otItem.RevisionItem.RemainingQuantity = ((Int64)otItem.RevisionItem.Quantity - downloaded);

                                if ((Int64)otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;
                            }
                            otItem.PickingMaterialsList = new List<PickingMaterials>();
                            if (idArticleType != 2)
                                FillPickingMaterialDisbaledFIFO_V2035(otItem, warehouse, ArticleVisualAidsPath, otItems);

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticlesForDecompositionScanDisabledFIFO_V2035(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }

            return otItems;
        }


        public List<WOItem> GetPackedItemByIdPackingBox(Warehouses warehouse, string articleVisualAidsPath, Int64 idPackingBox)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<WOItem> packedItems = new List<WOItem>();
            Dictionary<Int64, byte[]> articleDetails = new Dictionary<Int64, byte[]>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetPackedItemByIdPackingBox", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.Parameters.AddWithValue("_IdPackingBox", idPackingBox);
                command.CommandTimeout = 8000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                WOItem packedItem = new WOItem();

                                if (reader["IdOT"] != DBNull.Value)
                                    packedItem.IdOT = Convert.ToInt64(reader["IdOT"]);

                                if (reader["MergeCode"] != DBNull.Value)
                                {
                                    packedItem.WorkOrder = Convert.ToString(reader["MergeCode"]);
                                }

                                if (reader["OtCode"] != DBNull.Value)
                                {
                                    packedItem.WorkOrderCode = Convert.ToString(reader["OtCode"]);
                                }

                                if (reader["NumItem"] != DBNull.Value)
                                {
                                    packedItem.Item = Convert.ToInt32(reader["NumItem"]);
                                }

                                if (reader["ActualQty"] != DBNull.Value)
                                {
                                    packedItem.Qty = Convert.ToInt64(reader["ActualQty"]);
                                    packedItem.OriginalQty = packedItem.Qty;
                                }


                                if (reader["IdArticle"] != DBNull.Value)
                                {
                                    packedItem.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                    if (reader["reference"] != DBNull.Value)
                                        packedItem.Reference = Convert.ToString(reader["reference"]);

                                    if (reader["Description"] != DBNull.Value)
                                        packedItem.Description = Convert.ToString(reader["Description"]);

                                    if (reader["ArticleWeight"] != DBNull.Value)
                                        packedItem.ArticleWeight = Convert.ToDouble(reader["ArticleWeight"]);

                                    if (articleDetails.Any(ad => ad.Key == packedItem.IdArticle))
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            packedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(packedItem.ImagePath))
                                                packedItem.ArticleImageInBytes = articleDetails.Where(ad => ad.Key == packedItem.IdArticle).Select(ad => ad.Value).FirstOrDefault();
                                        }
                                    }
                                    else
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            packedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(packedItem.ImagePath))
                                                packedItem.ArticleImageInBytes = GetArticleImageInBytes_V2034(articleVisualAidsPath, packedItem.ImagePath);

                                            articleDetails.Add(packedItem.IdArticle, packedItem.ArticleImageInBytes);
                                        }
                                    }
                                }


                                if (reader["PartNumberCode"] != DBNull.Value)
                                    packedItem.PartNumberCode = Convert.ToString(reader["PartNumberCode"]);


                                if (reader["idPartNumber"] != DBNull.Value)
                                    packedItem.IdPartNumber = Convert.ToInt64(reader["idPartNumber"]);

                                if (reader["IdOTItem"] != DBNull.Value)
                                    packedItem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                                packedItems.Add(packedItem);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPackedItemByIdPackingBox() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    return packedItems;
                }


            }
        }


        public List<MyWarehouse> GetWarehouseArticleDetails_V2035(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<MyWarehouse> myWarehouses = new List<MyWarehouse>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetWarehouseArticleDetails_V2035", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 8000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {

                    while (reader.Read())
                    {
                        try
                        {
                            MyWarehouse myWarehouse = new MyWarehouse();
                            if (reader["IdArticle"] != DBNull.Value)
                                myWarehouse.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                            if (reader["MinimumStock"] != DBNull.Value)
                                myWarehouse.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);

                            if (reader["CurrentStock"] != DBNull.Value)
                                myWarehouse.CurrentStock = Convert.ToInt64(reader["CurrentStock"]);

                            myWarehouses.Add(myWarehouse);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetWarehouseArticleDetails_V2035() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return myWarehouses;
        }


        public List<OtItem> GetArticlesForDecompositionScan_V2035(Warehouses warehouse, Int64 idOt, OtItem parentOtItem, string ArticleVisualAidsPath, List<OtItemSameReference> otItemSameReferences, Int64 idArticleType)
        {
            List<OtItem> otItems = new List<OtItem>();

            string connectionString = warehouse.Company.ConnectPlantConstr;

            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetArticlesForDecomposition", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOTitem", parentOtItem.IdOTItem);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            // keyId++;

                            OtItem otItem = new OtItem();
                            otItem.IdOT = idOt;
                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);

                            if (otItemReader["IdItemOtStatus"] != DBNull.Value)
                                otItem.IdItemOtStatus = Convert.ToByte(otItemReader["IdItemOtStatus"]);


                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);



                                if (otItemReader["IdComponent"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otItemReader["IdComponent"]);
                                }

                                //   otItem.KeyId = keyId;

                                if (otItemReader["idParent"] != DBNull.Value)
                                {
                                    otItem.ParentId = Convert.ToInt32(otItemReader["idParent"]);
                                }

                                if (otItem.ParentId == -1)
                                {
                                    otItem.ParentId = parentOtItem.KeyId;
                                    otItem.RevisionItem.Quantity = parentOtItem.RevisionItem.Quantity * Convert.ToDecimal(otItemReader["Quantity"]);
                                }
                                else
                                {
                                    //OtItem otItem213 = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId);

                                    decimal qty = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).RevisionItem.Quantity;
                                    otItem.RevisionItem.Quantity = qty * Convert.ToDecimal(otItemReader["Quantity"]);
                                    otItem.ParentId = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).KeyId;
                                }

                                //if (otItemReader["WpDescription"] != DBNull.Value)
                                //    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["Description"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["Description"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Weight"] != DBNull.Value)
                                        article.Weight = Convert.ToDecimal(otItemReader["Weight"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);
                                }


                                int downloaded = GetOtItemDownloadedQuantity(connectionString, otItem.RevisionItem.WarehouseProduct.Article.IdArticle, otItem.IdOTItem, otItem.RevisionItem.WarehouseProduct.IdComponent, warehouse.IdWarehouse);


                                otItem.RevisionItem.DownloadedQuantity = downloaded;

                                otItem.RevisionItem.RemainingQuantity = ((Int64)otItem.RevisionItem.Quantity - downloaded);

                                if ((Int64)otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;
                            }
                            otItem.PickingMaterialsList = new List<PickingMaterials>();
                            if (idArticleType != 2)
                                FillPickingMaterial_V2034(otItem, warehouse, ArticleVisualAidsPath, otItems, otItemSameReferences);

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticlesForDecompositionScan_V2035(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }

            return otItems;
        }


        public bool UpdateOTItemStatusToFinished_V2035(Warehouses warehouse, Int64 idotitem, Int32 idOperator)
        {
            bool isUpdated = false;
            string connectionString = warehouse.Company.ConnectPlantConstr;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_UpdateOTItemStatusToFinished_V2035", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_Idotitem", idotitem);
                        mySqlCommand.Parameters.AddWithValue("_EndDate", DateTime.Now);
                        mySqlCommand.Parameters.AddWithValue("_IdOperator", idOperator);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                        isUpdated = true;
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isUpdated = false;
                throw;
            }



            return isUpdated;
        }


        public bool UpdateOTItemStatus_V2035(Warehouses warehouse, Int64 idotitem, Int32 idOperator)
        {
            bool isUpdated = false;
            string connectionString = warehouse.Company.ConnectPlantConstr;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_UpdateOTItemStatus_V2035", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_Idotitem", idotitem);
                        mySqlCommand.Parameters.AddWithValue("_EndDate", DateTime.Now);
                        mySqlCommand.Parameters.AddWithValue("_IdOperator", idOperator);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                        isUpdated = true;
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isUpdated = false;
                throw;
            }



            return isUpdated;
        }



        public bool AddCancelledOTWorkingTime(Warehouses warehouse, OTWorkingTime otWorkingTime)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            bool isCancelled = false;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_CancelledOTWorkingTime", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdOT", otWorkingTime.IdOT);
                        mySqlCommand.Parameters.AddWithValue("_IdOperator", otWorkingTime.IdOperator);
                        mySqlCommand.Parameters.AddWithValue("_IdStage", otWorkingTime.IdStage);
                        mySqlCommand.Parameters.AddWithValue("_StartDate", DateTime.Now);
                        mySqlCommand.Parameters.AddWithValue("_EndDate", DateTime.Now);

                        mySqlCommand.ExecuteNonQuery();
                        isCancelled = true;
                        mySqlConnection.Close();
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isCancelled = false;
                throw;
            }

            return isCancelled;
        }


        public bool UpdateItemStatusAndStage_V2035(Warehouses warehouse, Int64 idOtItem, byte idItemOtStatus, Int32 idOperator)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            bool isUpdated = false;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_StatusAndStageUpdate_V2035", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdOTItem", idOtItem);
                        mySqlCommand.Parameters.AddWithValue("_IdItemOtStatus", idItemOtStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdOperator", idOperator);
                        mySqlCommand.Parameters.AddWithValue("_CurrentDateTime", DateTime.Now);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }


                    transactionScope.Complete();
                    isUpdated = true;
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isUpdated = false;
                throw;
            }
            return isUpdated;
        }


        public bool UpdateRevisionItemComments_V2035(Warehouses warehouse, Int64 idRevisionItem, Int64 idDeliveryNoteItem)
        {
            TransactionScope transactionScope = null;

            string connectionString = warehouse.Company.ConnectPlantConstr;

            using (transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection connWDN = new MySqlConnection(connectionString))
                    {
                        connWDN.Open();

                        MySqlCommand insertWDNCommand = new MySqlCommand("revisionitems_UpdateComments_Sprint59", connWDN);
                        insertWDNCommand.CommandType = CommandType.StoredProcedure;

                        insertWDNCommand.Parameters.AddWithValue("_IdRevisionItem", idRevisionItem);
                        insertWDNCommand.Parameters.AddWithValue("_IdWarehouseDeliveryNoteItem", idDeliveryNoteItem);


                        insertWDNCommand.ExecuteNonQuery();

                        connWDN.Close();
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error UpdateRevisionItemComments_V2035(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return true;
        }


        public bool UpdatePackingBoxInPartnumber_V2035(Warehouses warehouse, Int64 idPackingBox, Int64 idotitem)
        {
            bool isUpdated = false;
            string connectionString = warehouse.Company.ConnectPlantConstr;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_PartnumbersUpdate_V2035", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdPackingBox", idPackingBox);
                        mySqlCommand.Parameters.AddWithValue("_Idotitem", idotitem);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                        isUpdated = true;
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isUpdated = false;
                throw;
            }



            return isUpdated;
        }

        public bool UpdateUnPackingBoxInPartnumber_V2035(Warehouses warehouse, Int64 idPackingBox, Int64 idotitem)
        {
            bool isUpdated = false;
            string connectionString = warehouse.Company.ConnectPlantConstr;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_PartnumbersUpdate_V2035", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdPackingBox", null);
                        mySqlCommand.Parameters.AddWithValue("_Idotitem", idotitem);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                        isUpdated = true;
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isUpdated = false;
                throw;
            }



            return isUpdated;
        }

        public List<PackingCompany> GetCompanyPackingWorkOrders_V2035(Warehouses warehouse, string siteIds)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<PackingCompany> packingCompanies = new List<PackingCompany>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetCompanyPackingWorkOrders_V2035", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.Parameters.AddWithValue("_siteIds", siteIds);
                command.CommandTimeout = 8000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {

                    while (reader.Read())
                    {
                        try
                        {
                            if (reader["IdSite"] != DBNull.Value)
                            {
                                if (packingCompanies.Any(pc => pc.IdCompany == Convert.ToInt32(reader["IdSite"])))
                                {
                                    PackingCompany packingCompany = packingCompanies.Where(pc => pc.IdCompany == Convert.ToInt32(reader["IdSite"])).FirstOrDefault();

                                    PackingBox packingBox = new PackingBox();

                                    if (reader["IdPackingBox"] != DBNull.Value)
                                        packingBox.IdPackingBox = Convert.ToInt64(reader["IdPackingBox"]);


                                    if (reader["IdSite"] != DBNull.Value)
                                        packingBox.IdSite = Convert.ToInt32(reader["IdSite"]);

                                    if (reader["BoxNumber"] != DBNull.Value)
                                        packingBox.BoxNumber = Convert.ToString(reader["BoxNumber"]);

                                    if (reader["Length"] != DBNull.Value)
                                        packingBox.Length = Convert.ToDouble(reader["Length"]);

                                    if (reader["Width"] != DBNull.Value)
                                        packingBox.Width = Convert.ToDouble(reader["Width"]);

                                    if (reader["SizeMeasurementUnit"] != DBNull.Value)
                                        packingBox.SizeMeasurementUnit = Convert.ToString(reader["SizeMeasurementUnit"]);

                                    if (reader["Height"] != DBNull.Value)
                                        packingBox.Height = Convert.ToDouble(reader["Height"]);

                                    if (reader["WeightMeasurementUnit"] != DBNull.Value)
                                        packingBox.WeightMeasurementUnit = Convert.ToString(reader["WeightMeasurementUnit"]);

                                    if (reader["IdPackingBoxType"] != DBNull.Value)
                                        packingBox.IdPackingBoxType = Convert.ToInt64(reader["IdPackingBoxType"]);

                                    if (reader["NetWeight"] != DBNull.Value)
                                        packingBox.NetWeight = Convert.ToDouble(reader["NetWeight"]);


                                    if (reader["GrossWeight"] != DBNull.Value)
                                        packingBox.GrossWeight = Convert.ToDouble(reader["GrossWeight"]);

                                    if (reader["IsClosed"] != DBNull.Value)
                                        packingBox.IsClosed = Convert.ToSByte(reader["IsClosed"]);

                                    if (reader["Comments"] != DBNull.Value)
                                        packingBox.Comments = Convert.ToString(reader["Comments"]);

                                    if (reader["IdShipment"] != DBNull.Value)
                                        packingBox.IdShipment = Convert.ToInt64(reader["IdShipment"]);


                                    packingCompany.PackingBoxes.Add(packingBox);

                                }
                                else
                                {
                                    PackingCompany packingCompany = new PackingCompany();

                                    if (reader["IdSite"] != DBNull.Value)
                                        packingCompany.IdCompany = Convert.ToInt32(reader["IdSite"]);

                                    if (reader["ShortName"] != DBNull.Value)
                                        packingCompany.ShortName = Convert.ToString(reader["ShortName"]);

                                    packingCompany.PackingBoxes = new ObservableCollection<PackingBox>();

                                    PackingBox packingBox = new PackingBox();

                                    if (reader["IdPackingBox"] != DBNull.Value)
                                        packingBox.IdPackingBox = Convert.ToInt64(reader["IdPackingBox"]);


                                    if (reader["IdSite"] != DBNull.Value)
                                        packingBox.IdSite = Convert.ToInt32(reader["IdSite"]);

                                    if (reader["BoxNumber"] != DBNull.Value)
                                        packingBox.BoxNumber = Convert.ToString(reader["BoxNumber"]);

                                    if (reader["Length"] != DBNull.Value)
                                        packingBox.Length = Convert.ToDouble(reader["Length"]);

                                    if (reader["Width"] != DBNull.Value)
                                        packingBox.Width = Convert.ToDouble(reader["Width"]);

                                    if (reader["SizeMeasurementUnit"] != DBNull.Value)
                                        packingBox.SizeMeasurementUnit = Convert.ToString(reader["SizeMeasurementUnit"]);

                                    if (reader["Height"] != DBNull.Value)
                                        packingBox.Height = Convert.ToDouble(reader["Height"]);

                                    if (reader["WeightMeasurementUnit"] != DBNull.Value)
                                        packingBox.WeightMeasurementUnit = Convert.ToString(reader["WeightMeasurementUnit"]);

                                    if (reader["IdPackingBoxType"] != DBNull.Value)
                                        packingBox.IdPackingBoxType = Convert.ToInt64(reader["IdPackingBoxType"]);

                                    if (reader["NetWeight"] != DBNull.Value)
                                        packingBox.NetWeight = Convert.ToDouble(reader["NetWeight"]);

                                    if (reader["GrossWeight"] != DBNull.Value)
                                        packingBox.GrossWeight = Convert.ToDouble(reader["GrossWeight"]);

                                    if (reader["IsClosed"] != DBNull.Value)
                                        packingBox.IsClosed = Convert.ToSByte(reader["IsClosed"]);

                                    if (reader["Comments"] != DBNull.Value)
                                        packingBox.Comments = Convert.ToString(reader["Comments"]);

                                    if (reader["IdShipment"] != DBNull.Value)
                                        packingBox.IdShipment = Convert.ToInt64(reader["IdShipment"]);


                                    packingCompany.PackingBoxes.Add(packingBox);

                                    packingCompanies.Add(packingCompany);
                                }
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetCompanyPackingWorkOrders() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                    if (reader.NextResult())
                    {
                        try
                        {
                            while (reader.Read())
                            {
                                if (reader["IdPackingBox"] != DBNull.Value)
                                {
                                    foreach (PackingCompany itemPackingCompany in packingCompanies)
                                    {
                                        if (itemPackingCompany.PackingBoxes.Any(pb => pb.IdPackingBox == Convert.ToInt64(reader["IdPackingBox"])))
                                        {
                                            PackingBox packingBox = itemPackingCompany.PackingBoxes.Where(pb => pb.IdPackingBox == Convert.ToInt64(reader["IdPackingBox"])).FirstOrDefault();
                                            if (reader["ItemsInBox"] != DBNull.Value)
                                                packingBox.ItemsInBox = Convert.ToInt64(reader["ItemsInBox"]);

                                            break;
                                        }
                                    }
                                }
                            }

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetCompanyPackingWorkOrders() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }

                    }


                    return packingCompanies;
                }



            }
        }


        public List<BoxPrint> GetWorkorderByIdPackingBox_V2036(Warehouses warehouse, Int64 idPackingBox)
        {
            List<BoxPrint> boxPrints = new List<BoxPrint>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetWorkorderByIdPackingBox_V2036", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdPackingBox", idPackingBox);

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            BoxPrint boxPrint = new BoxPrint();

                            if (reader["IdPackingBox"] != DBNull.Value)
                                boxPrint.IdPackingBox = Convert.ToInt32(reader["IdPackingBox"]);

                            if (reader["Code"] != DBNull.Value)
                                boxPrint.OtCode = Convert.ToString(reader["Code"]);

                            if (reader["IdCarriageMethod"] != DBNull.Value)
                                boxPrint.IdCarriageMethod = Convert.ToInt32(reader["IdCarriageMethod"]);

                            if (reader["CarriageMethodValue"] != DBNull.Value)
                                boxPrint.CarriageMethodValue = Convert.ToString(reader["CarriageMethodValue"]);

                            if (reader["CarriageMethodAbbreviation"] != DBNull.Value)
                                boxPrint.CarriageMethodAbbreviation = Convert.ToString(reader["CarriageMethodAbbreviation"]);

                            if (reader["SiteName"] != DBNull.Value)
                                boxPrint.SiteName = Convert.ToString(reader["SiteName"]);

                            if (reader["BoxNumber"] != DBNull.Value)
                                boxPrint.BoxNumber = Convert.ToString(reader["BoxNumber"]);

                            if (reader["GrossWeight"] != DBNull.Value)
                                boxPrint.GrossWeight = Convert.ToDouble(reader["GrossWeight"]);

                            if (reader["IdOT"] != DBNull.Value)
                                boxPrint.IdOT = Convert.ToInt64(reader["IdOT"]);

                            if (reader["SiteNameWithCountry"] != DBNull.Value)
                                boxPrint.SiteNameWithCountry = Convert.ToString(reader["SiteNameWithCountry"]);

                            if (reader["CustomerName"] != DBNull.Value)
                                boxPrint.CustomerName = Convert.ToString(reader["CustomerName"]);

                            boxPrints.Add(boxPrint);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetWorkorderByIdPackingBox_V2036(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetWorkorderByIdPackingBox_V2036().", category: Category.Info, priority: Priority.Low);
            return boxPrints;
        }


        public Article GetArticleDetailsByReference_V2036(string reference, string articleVisualAidsPath, Warehouses warehouse, DateTime? fromDate = null, DateTime? toDate = null)
        {
            Article article = new Article();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetArticleDetailsByReference_V2036", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_Reference", reference);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 8000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        try
                        {
                            if (reader["idArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(reader["idArticle"]);

                            if (reader["IdArticleCategory"] != DBNull.Value)
                            {
                                article.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory = new ArticleCategory();
                                article.ArticleCategory.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory.Name = Convert.ToString(reader["categoryName"]);
                                article.ArticleCategory.TaricCode = Convert.ToString(reader["TaricCode"]);
                            }

                            if (reader["ImagePath"] != DBNull.Value)
                            {
                                article.ImagePath = Convert.ToString(reader["ImagePath"]);

                                if (!string.IsNullOrEmpty(article.ImagePath))
                                    article.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, article);
                            }

                            if (reader["Reference"] != DBNull.Value)
                                article.Reference = reader["Reference"].ToString();

                            if (reader["IsOrientativeVisualAid"] != DBNull.Value)
                                article.IsOrientativeVisualAid = Convert.ToByte(reader["IsOrientativeVisualAid"]);

                            if (reader["IsGeneric"] != DBNull.Value)
                                article.IsGeneric = Convert.ToSByte(reader["IsGeneric"]);

                            if (reader["isObsolete"] != DBNull.Value)
                                article.IsObsolete = Convert.ToSByte(reader["isObsolete"]);

                            if (reader["isPublic"] != DBNull.Value)
                                article.IsPublic = Convert.ToSByte(reader["isPublic"]);

                            if (reader["publishOnWeb"] != DBNull.Value)
                                article.PublishOnWeb = Convert.ToSByte(reader["publishOnWeb"]);

                            if (reader["registerSerialNumber"] != DBNull.Value)
                                article.RegisterSerialNumber = Convert.ToByte(reader["registerSerialNumber"]);

                            if (reader["CreatedIn"] != DBNull.Value)
                                article.CreatedIn = Convert.ToDateTime(reader["CreatedIn"]);

                            if (reader["ModifiedIn"] != DBNull.Value)
                                article.ModifiedIn = Convert.ToDateTime(reader["ModifiedIn"]);

                            if (reader["description"] != DBNull.Value)
                                article.Description = Convert.ToString(reader["description"]);

                            if (reader["description_es"] != DBNull.Value)
                                article.Description_es = Convert.ToString(reader["description_es"]);

                            if (reader["description_fr"] != DBNull.Value)
                                article.Description_fr = Convert.ToString(reader["description_fr"]);

                            if (reader["description_pt"] != DBNull.Value)
                                article.Description_pt = Convert.ToString(reader["description_pt"]);

                            if (reader["description_ro"] != DBNull.Value)
                                article.Description_ro = Convert.ToString(reader["description_ro"]);

                            if (reader["description_ru"] != DBNull.Value)
                                article.Description_ru = Convert.ToString(reader["description_ru"]);

                            if (reader["description_zh"] != DBNull.Value)
                                article.Description_zh = Convert.ToString(reader["description_zh"]);

                            if (reader["idReplacementArticle"] != DBNull.Value)
                            {
                                article.IdReplacementArticle = Convert.ToInt32(reader["idReplacementArticle"]);
                                article.ReplacementArticle = Convert.ToString(reader["ReplacementArticle"]);
                            }

                            if (reader["isBatch"] != DBNull.Value)
                                article.IsBatch = Convert.ToByte(reader["isBatch"]);

                            if (reader["taric"] != DBNull.Value)
                                article.Taric = Convert.ToString(reader["taric"]);

                            if (reader["IdArticleType"] != DBNull.Value)
                            {
                                article.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                article.ArticlesType = new ArticleType();
                                article.ArticlesType.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                if (reader["ArticleTypeName"] != DBNull.Value)
                                    article.ArticlesType.Name = Convert.ToString(reader["ArticleTypeName"]);
                            }


                            if (reader["Weight"] != DBNull.Value)
                                article.Weight = Convert.ToDecimal(reader["Weight"]);

                            if (reader["Width"] != DBNull.Value)
                                article.Width = (float)(reader["Width"]);

                            if (reader["Length"] != DBNull.Value)
                                article.Length = (float)(reader["Length"]);

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)(reader["Height"]);


                            if (reader["idCountry"] != DBNull.Value)
                            {
                                article.IdCountry = Convert.ToInt32(reader["idCountry"]);

                                article.Country = new Country();
                                article.Country.IdCountry = Convert.ToByte(reader["idCountry"]);
                                article.Country.Name = Convert.ToString(reader["CountryName"]);
                            }

                            if (reader["articleSleepDate"] != DBNull.Value)
                            {
                                article.ArticleSleepDate = Convert.ToDateTime(reader["articleSleepDate"]);
                                article.ArticleSleepDays = (Int32)(DateTime.Now - article.ArticleSleepDate.Value.Date).TotalDays;
                            }

                            article.MyWarehouse = new MyWarehouse();

                            if (reader["minimumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MinimumStock = Convert.ToInt64(reader["minimumStock"]);
                            }

                            if (reader["stock"] != DBNull.Value)
                            {
                                article.MyWarehouse.CurrentStock = Convert.ToInt64(reader["stock"]);
                            }

                            if (reader["maximumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MaximumStock = Convert.ToInt64(reader["maximumStock"]);
                            }

                            if (reader["idWareHouse"] != DBNull.Value)
                            {
                                article.MyWarehouse.IdWarehouse = Convert.ToInt64(reader["idWareHouse"]);
                            }

                            if (reader["location"] != DBNull.Value)
                            {
                                article.MyWarehouse.Location = Convert.ToString(reader["location"]);
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleDetailsByReference_V2036(). Reference- {0} IdArticle-{1} ErrorMessage- {2}", reference, article.IdArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
                article.LstArticleBySupplier = new List<ArticleBySupplier>();
                article.LstArticleBySupplier = GetArticleSupplierDetailsByIdArticle(connectionString, article.IdArticle);

                article.LstArticleDecomposition = new List<ArticleDecomposition>();
                article.LstArticleDecomposition = GetArticleDeCompostionByIdArticle(connectionString, article.IdArticle);

                article.LstRelatedArticle = new List<RelatedArticle>();
                article.LstRelatedArticle = GetRelatedArticleDetailsByIdArticle(connectionString, article.IdArticle, warehouse.IdWarehouse);

                article.LstArticleDocument = new List<ArticleDocument>();
                article.LstArticleDocument = GetArticleAttachmentByIdArticle(connectionString, article.IdArticle);

                if (article.RegisterSerialNumber == 1)
                {
                    article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                    article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockIncludingSerialNumber(connectionString, article.IdArticle, warehouse.IdWarehouse);
                    // article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle_V2034(connectionString, article.IdArticle, warehouse.IdWarehouse);
                }
                else
                {
                    article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                    article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle_V2034(connectionString, article.IdArticle, warehouse.IdWarehouse);
                }

                article.LstManufacturersByArticles = new List<ManufacturersByArticle>();
                article.LstManufacturersByArticles = GetManufacturers(connectionString, article.IdArticle);

                //if (fromDate != null && toDate != null)
                //{
                article.LstArticlesStock = new List<ArticlesStock>();
                article.LstArticlesStock = GetStockHistoryByIdArticle_V2033(connectionString, article.IdArticle, DateTime.Now, DateTime.Now, warehouse.IdWarehouse);
                // }


                article.LstArticleForecast = new List<ArticleForecast>();
                article.LstArticleForecast = GetArticleForecast(connectionString, article.IdArticle, warehouse.IdWarehouse);

            }

            return article;
        }


        public List<ArticleType> GetArticleTypes(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            List<ArticleType> articleTypes = new List<ArticleType>();


            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetArticleTypes", conn);
                command.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            ArticleType articleType = new ArticleType();

                            if (reader["IdArticleType"] != DBNull.Value)
                                articleType.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                            if (reader["ArticleTypeName"] != DBNull.Value)
                                articleType.ArticleTypeName = Convert.ToString(reader["ArticleTypeName"]);

                            if (reader["SortOrder"] != DBNull.Value)
                                articleType.SortOrder = Convert.ToInt64(reader["SortOrder"]);

                            articleTypes.Add(articleType);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleTypes(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }

            return articleTypes;
        }


        public bool UpdateOTWorkingTime(Warehouses warehouse, OTWorkingTime otWorkingTime)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            bool isUpdated = false;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_UpdateOTWorkingTime", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdOTWorkingTime", otWorkingTime.IdOTWorkingTime);
                        mySqlCommand.Parameters.AddWithValue("_StartDate", otWorkingTime.StartTime);
                        mySqlCommand.Parameters.AddWithValue("_EndDate", otWorkingTime.EndTime);


                        mySqlCommand.ExecuteNonQuery();
                        isUpdated = true;
                        mySqlConnection.Close();
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isUpdated = false;
                throw;
            }

            return isUpdated;
        }


        public bool DeleteOTWorkingTime(Warehouses warehouse, OTWorkingTime otWorkingTime)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            bool isDeleted = false;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_DeleteOTWorkingTime", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdOTWorkingTime", otWorkingTime.IdOTWorkingTime);

                        mySqlCommand.ExecuteNonQuery();
                        isDeleted = true;
                        mySqlConnection.Close();
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isDeleted = false;
                throw;
            }

            return isDeleted;
        }


        public bool UpdateGeosAppSettingById(string mainServerConnectionString, GeosAppSetting geosAppSetting)
        {
            bool isUpdated = false;


            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("geos_app_setting_update", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_idAppSetting", geosAppSetting.IdAppSetting);
                        mySqlCommand.Parameters.AddWithValue("_DefaultValue", geosAppSetting.DefaultValue);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                        isUpdated = true;
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();

                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error UpdateGeosAppSettingById(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                    isUpdated = false;
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return isUpdated;
        }
                


      


        public List<OTWorkingTime> GetOTWorkingTimeDetails_V2036(Int64 idOT, Warehouses warehouse, String userProfileImageFilePath)
        {
            List<OTWorkingTime> LstOTWorkingTime = new List<OTWorkingTime>();
            List<UserShortDetail> UserShortDetailForbytes = new List<UserShortDetail>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection connWarehouse = new MySqlConnection(connectionString))
            {
                connWarehouse.Open();

                MySqlCommand warehouseCommand = new MySqlCommand("WMS_GetOTWorkingTimeDetails_V2036", connWarehouse);
                warehouseCommand.CommandType = CommandType.StoredProcedure;
                warehouseCommand.Parameters.AddWithValue("_IdOT", idOT);
                warehouseCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader warehouseReader = warehouseCommand.ExecuteReader())
                {
                    while (warehouseReader.Read())
                    {
                        try
                        {
                            OTWorkingTime otWorkingTime = new OTWorkingTime();

                            if (warehouseReader["IdOTWorkingTime"] != DBNull.Value)
                                otWorkingTime.IdOTWorkingTime = Convert.ToInt64(warehouseReader["IdOTWorkingTime"]);

                            if (warehouseReader["IdOT"] != DBNull.Value)
                                otWorkingTime.IdOT = Convert.ToInt64(warehouseReader["IdOT"]);

                            if (warehouseReader["IdStage"] != DBNull.Value)
                                otWorkingTime.IdStage = Convert.ToByte(warehouseReader["IdStage"]);

                            if (warehouseReader["StartDate"] != DBNull.Value)
                                otWorkingTime.StartTime = Convert.ToDateTime(Convert.ToDateTime(warehouseReader["StartDate"]).ToString("dd/MM/yyyy HH:mm"));

                            //if (warehouseReader["StartTime"] != DBNull.Value)
                            //    otWorkingTime.StartTimeInHoursAndMinutes = warehouseReader["StartTime"].ToString();

                            if (warehouseReader["EndDate"] != DBNull.Value)
                                otWorkingTime.EndTime = Convert.ToDateTime(Convert.ToDateTime(warehouseReader["EndDate"]).ToString("dd/MM/yyyy HH:mm"));

                            if (warehouseReader["TotalTime"] != DBNull.Value)
                            {
                                otWorkingTime.TotalTime = (TimeSpan)warehouseReader["TotalTime"];
                                otWorkingTime.TotalTime = new TimeSpan(otWorkingTime.TotalTime.Days, otWorkingTime.TotalTime.Hours, otWorkingTime.TotalTime.Minutes, 00);
                            }

                            //if (warehouseReader["EndTime"] != DBNull.Value)
                            //    otWorkingTime.EndTimeInHoursAndMinutes =warehouseReader["EndTime"].ToString();

                            if (warehouseReader["IdOperator"] != DBNull.Value)
                            {
                                otWorkingTime.IdOperator = Convert.ToInt32(warehouseReader["IdOperator"]);

                                otWorkingTime.UserShortDetail = new UserShortDetail();
                                otWorkingTime.UserShortDetail.IdUser = Convert.ToInt32(warehouseReader["IdOperator"]);
                                otWorkingTime.UserShortDetail.Login = Convert.ToString(warehouseReader["Login"]);
                                otWorkingTime.UserShortDetail.UserName = Convert.ToString(warehouseReader["UserName"]);

                                if (warehouseReader["IdUserGender"] != DBNull.Value)
                                    otWorkingTime.UserShortDetail.IdUserGender = Convert.ToByte(warehouseReader["IdUserGender"]);

                                if (UserShortDetailForbytes.Any(usd => usd.Login == otWorkingTime.UserShortDetail.Login))
                                {
                                    otWorkingTime.UserShortDetail.UserImageInBytes = UserShortDetailForbytes.Where(usd => usd.Login == otWorkingTime.UserShortDetail.Login).FirstOrDefault().UserImageInBytes;
                                }
                                else
                                {
                                    otWorkingTime.UserShortDetail.UserImageInBytes = GetUserProfileImageInBytes(otWorkingTime.UserShortDetail.Login, userProfileImageFilePath);
                                    UserShortDetail userShortDetail = new UserShortDetail();
                                    userShortDetail.IdUser = otWorkingTime.UserShortDetail.IdUser;
                                    userShortDetail.IdUserGender = otWorkingTime.UserShortDetail.IdUserGender;
                                    userShortDetail.Login = otWorkingTime.UserShortDetail.Login;
                                    userShortDetail.UserName = otWorkingTime.UserShortDetail.UserName;

                                    userShortDetail.UserImageInBytes = otWorkingTime.UserShortDetail.UserImageInBytes;
                                    UserShortDetailForbytes.Add(userShortDetail);
                                }
                            }


                            LstOTWorkingTime.Add(otWorkingTime);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetOTWorkingTimeDetails_V2036(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }



            return LstOTWorkingTime;
        }

        public bool UpdateItemStatusAndStageForRefund(Warehouses warehouse, Int64 idOtItem, byte idItemOtStatus, Int32 idOperator)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            bool isUpdated = false;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_StatusAndStageUpdateForRefund", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdOTItem", idOtItem);
                        mySqlCommand.Parameters.AddWithValue("_IdItemOtStatus", idItemOtStatus);
                        mySqlCommand.Parameters.AddWithValue("_IdOperator", idOperator);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }


                    transactionScope.Complete();
                    isUpdated = true;
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isUpdated = false;
                throw;
            }
            return isUpdated;
        }


        public bool UpdateRevisionItemCommentsForRefund(Warehouses warehouse, Int64 idRevisionItem, Int64 idDeliveryNoteItem)
        {
            TransactionScope transactionScope = null;

            string connectionString = warehouse.Company.ConnectPlantConstr;

            using (transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection connWDN = new MySqlConnection(connectionString))
                    {
                        connWDN.Open();

                        MySqlCommand insertWDNCommand = new MySqlCommand("WMS_revisionitemsUpdateCommentsForRefund", connWDN);
                        insertWDNCommand.CommandType = CommandType.StoredProcedure;

                        insertWDNCommand.Parameters.AddWithValue("_IdRevisionItem", idRevisionItem);
                        insertWDNCommand.Parameters.AddWithValue("_IdWarehouseDeliveryNoteItem", idDeliveryNoteItem);


                        insertWDNCommand.ExecuteNonQuery();

                        connWDN.Close();
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error UpdateRevisionItemComments_V2035(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return true;
        }


        public List<Ots> GetPendingMaterialWorkOrdersByWarehouse_V2036(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<Ots> ots = new List<Ots>();

            using (MySqlConnection connOts = new MySqlConnection(connectionString))
            {
                connOts.Open();

                MySqlCommand otsCommand = new MySqlCommand("WMS_GetPendingMaterialWorkOrdersByWarehouse_V2036", connOts);
                otsCommand.CommandType = CommandType.StoredProcedure;
                otsCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                otsCommand.CommandTimeout = 8000;

                using (MySqlDataReader otReader = otsCommand.ExecuteReader())
                {
                    if (otReader.HasRows)
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = new Ots();
                                ot.IdOT = Convert.ToInt64(otReader["IdOT"]);
                                ot.NumOT = Convert.ToByte(otReader["NumOT"]);

                                if (otReader["OtCode"] != DBNull.Value)
                                {
                                    ot.Code = Convert.ToString(otReader["OtCode"]);
                                    ot.MergeCode = Convert.ToString(otReader["MergeCode"]);
                                }

                                if (otReader["DeliveryDate"] != DBNull.Value)
                                {
                                    ot.DeliveryDate = Convert.ToDateTime(otReader["DeliveryDate"]);
                                    ot.Delay = (int)(ot.DeliveryDate.Value.Date - DateTime.Now.Date).TotalDays;
                                }

                                ot.Quotation = new Quotation();

                                if (otReader["IdQuotation"] != DBNull.Value)
                                {
                                    ot.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                                    ot.Quotation.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                                    ot.Quotation.Code = Convert.ToString(otReader["QuotationCode"]);
                                }

                                if (otReader["IdTemplate"] != DBNull.Value)
                                {
                                    ot.Quotation.IdDetectionsTemplate = Convert.ToByte(otReader["IdTemplate"]);

                                    ot.Quotation.Template = new Template();
                                    ot.Quotation.Template.IdTemplate = ot.Quotation.IdDetectionsTemplate;
                                    ot.Quotation.Template.Name = Convert.ToString(otReader["Template"]);
                                    ot.Quotation.Template.IdTemplate = Convert.ToByte(otReader["TemplateType"]);
                                }

                                if (otReader["IdOffer"] != DBNull.Value)
                                {
                                    ot.Quotation.IdOffer = Convert.ToInt64(otReader["IdOffer"]);
                                    ot.Quotation.Offer = new Offer();
                                    ot.Quotation.Offer.IdOffer = ot.Quotation.IdOffer;

                                    if (otReader["IsCritical"] != DBNull.Value)
                                        ot.Quotation.Offer.IsCritical = Convert.ToByte(otReader["IsCritical"]);

                                    if (otReader["IdStatus"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdStatus = Convert.ToInt64(otReader["IdStatus"]);
                                        ot.Quotation.Offer.GeosStatus = new GeosStatus();
                                        ot.Quotation.Offer.GeosStatus.IdOfferStatusType = Convert.ToInt64(otReader["IdStatus"]);
                                        ot.Quotation.Offer.GeosStatus.Name = Convert.ToString(otReader["OfferStatus"]);
                                        ot.Quotation.Offer.GeosStatus.HtmlColor = Convert.ToString(otReader["OfferStatusHtmlColor"]);

                                        if (otReader["IdSalesStatusType"] != DBNull.Value)
                                        {
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType = new SalesStatusType();
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.IdSalesStatusType = Convert.ToInt64(otReader["IdSalesStatusType"]);
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.Name = Convert.ToString(otReader["SalesStatusType"]);
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.HtmlColor = Convert.ToString(otReader["SalesStatusHtmlColor"]);
                                            if (otReader["SalesStatusIdImage"] != DBNull.Value)
                                                ot.Quotation.Offer.GeosStatus.SalesStatusType.IdImage = Convert.ToInt64(otReader["SalesStatusIdImage"]);
                                        }
                                    }

                                    ot.Quotation.Offer.Code = Convert.ToString(otReader["OfferCode"]);
                                    ot.Quotation.Offer.Description = Convert.ToString(otReader["Description"]);


                                    if (otReader["IdOfferType"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdOfferType = Convert.ToByte(otReader["IdOfferType"]);

                                        ot.Quotation.Offer.OfferType = new OfferType();
                                        ot.Quotation.Offer.OfferType.IdOfferType = Convert.ToByte(ot.Quotation.Offer.IdOfferType);
                                        ot.Quotation.Offer.OfferType.Name = Convert.ToString(otReader["OfferType"]);

                                        //ot.MergeCode = ot.Quotation.Code + " " + ot.Quotation.Offer.OfferType.Name + " " + ot.NumOT;
                                    }

                                    if (otReader["IdCarriageMethod"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdCarriageMethod = Convert.ToByte(otReader["IdCarriageMethod"]);
                                        ot.Quotation.Offer.CarriageMethod = new LookupValue();
                                        ot.Quotation.Offer.CarriageMethod.IdLookupValue = Convert.ToByte(ot.Quotation.Offer.IdCarriageMethod);
                                        ot.Quotation.Offer.CarriageMethod.Value = Convert.ToString(otReader["CarriageMethod"]);

                                        if (otReader["CarriageImage"] != DBNull.Value)
                                            ot.Quotation.Offer.CarriageMethod.IdImage = Convert.ToInt64(otReader["CarriageImage"]);
                                    }
                                }

                                if (otReader["IdWarehouse"] != DBNull.Value)
                                {
                                    ot.Quotation.IdWarehouse = Convert.ToInt64(otReader["IdWarehouse"]);
                                }

                                if (otReader["IdSite"] != DBNull.Value)
                                {
                                    ot.Quotation.IdCustomer = Convert.ToInt32(otReader["IdSite"]);
                                    ot.Quotation.Site = new Company();
                                    ot.Quotation.Site.IdCompany = ot.Quotation.IdCustomer;
                                    ot.Quotation.Site.SiteNameWithoutCountry = Convert.ToString(otReader["SiteName"]);

                                    if (otReader["ShortName"] != DBNull.Value && !string.IsNullOrEmpty(Convert.ToString(otReader["ShortName"])))
                                    {
                                        ot.Quotation.Site.ShortName = Convert.ToString(otReader["ShortName"]);
                                        ot.Quotation.Site.Name = ot.Quotation.Site.ShortName;
                                    }
                                    else
                                    {
                                        ot.Quotation.Site.ShortName = null;
                                        ot.Quotation.Site.Name = Convert.ToString(otReader["SiteName"]);
                                    }

                                    ot.Quotation.Site.Customer = new Customer();
                                    ot.Quotation.Site.Customer.IdCustomer = Convert.ToInt32(otReader["IdCustomer"]);
                                    ot.Quotation.Site.Customer.CustomerName = Convert.ToString(otReader["CustomerName"]);

                                    if (otReader["IdCountry"] != DBNull.Value)
                                    {
                                        ot.Quotation.Site.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country = new Country();
                                        ot.Quotation.Site.Country.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country.Name = Convert.ToString(otReader["CountryName"]);
                                    }
                                }

                                if (otReader["ActualQty"] != DBNull.Value)
                                    ot.ActualQuantity = Convert.ToInt64(otReader["ActualQty"]);

                                if (otReader["DownloadedQty"] != DBNull.Value)
                                    ot.DownloadedQuantity = Convert.ToInt64(otReader["DownloadedQty"]);

                                if (otReader["PODate"] != DBNull.Value)
                                    ot.PoDate = Convert.ToDateTime(otReader["PODate"]);

                                if (otReader["ProducerCountryGroupName"] != DBNull.Value)
                                {
                                    ot.CountryGroup = new CountryGroup();
                                    ot.CountryGroup.Name = otReader["ProducerCountryGroupName"].ToString();
                                    if (otReader["ProducerCountryGroupHTMLColor"] != DBNull.Value)
                                        ot.CountryGroup.HtmlColor = otReader["ProducerCountryGroupHTMLColor"].ToString();
                                }



                                ot.RemainingQuantity = ot.ActualQuantity + ot.DownloadedQuantity;
                                if (ot.ActualQuantity > 0)
                                {
                                    ot.Status = (Int16)((Math.Abs(ot.DownloadedQuantity) / ot.ActualQuantity) * 100);
                                }
                                ot.OtItems = new List<OtItem>();
                                ots.Add(ot);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2036() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otItem = new OtItem();
                                    if (otReader["IdOT"] != DBNull.Value)
                                        otItem.IdOT = Convert.ToInt64(otReader["IdOT"]);
                                    if (otReader["IdOtItem"] != DBNull.Value)
                                        otItem.IdOTItem = Convert.ToInt64(otReader["IdOtItem"]);
                                    if (otReader["IdRevisionItem"] != DBNull.Value)
                                    {
                                        otItem.IdRevisionItem = Convert.ToInt64(otReader["IdRevisionItem"]);
                                        otItem.RevisionItem = new RevisionItem();
                                        otItem.RevisionItem.IdRevisionItem = Convert.ToInt64(otReader["IdRevisionItem"]);
                                        otItem.RevisionItem.Quantity = Convert.ToDecimal(otReader["Quantity"]);
                                        if (otReader["DownloadedQty"] != DBNull.Value)
                                            otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otReader["DownloadedQty"]);

                                        if (otReader["RemainingQty"] != DBNull.Value)
                                            otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otReader["RemainingQty"]);


                                        if (otReader["IdArticle"] != DBNull.Value)
                                        {
                                            otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();

                                            otItem.RevisionItem.WarehouseProduct.Article = new Article();
                                            otItem.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(otReader["IdArticle"]);
                                            if (otReader["IdArticleType"] != DBNull.Value)
                                            {
                                                otItem.RevisionItem.WarehouseProduct.Article.IdArticleType = Convert.ToInt64(otReader["IdArticleType"]);
                                            }
                                            if (otReader["ArticleCurrentStock"] != DBNull.Value)
                                                otItem.RevisionItem.WarehouseProduct.Article.ArticleCurrentStock = Convert.ToInt64(otReader["ArticleCurrentStock"]);

                                            if (otReader["ArticleWarehouseLocationIdArticle"] != DBNull.Value)
                                            {
                                                otItem.RevisionItem.WarehouseProduct.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                                                otItem.RevisionItem.WarehouseProduct.Article.ArticleWarehouseLocation.IdArticle = Convert.ToInt32(otReader["ArticleWarehouseLocationIdArticle"]);

                                            }
                                        }
                                    }
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    ot.OtItems.Add(otItem);
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2036() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }


                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(otReader["idotitem"])).FirstOrDefault();

                                    OtItem decomposed = new OtItem();
                                    if (otitem != null)
                                    {
                                        decomposed.IdOT = ot.IdOT;
                                        decomposed.IdOTItem = Convert.ToInt64(otReader["IdOtItem"]);

                                        if (otReader["idParent"] != DBNull.Value)
                                        {
                                            decomposed.ParentId = Convert.ToInt32(otReader["idParent"]);
                                        }
                                        decomposed.RevisionItem = new RevisionItem();
                                        decomposed.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                        decomposed.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otReader["IdWarehouseproduct"]);



                                        if (otReader["IdComponent"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otReader["IdComponent"]);
                                        }

                                        if (otReader["ParentIdArticleType"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.ParentIdArticleType = Convert.ToInt64(otReader["ParentIdArticleType"]);
                                        }

                                        if (decomposed.ParentId == -1)
                                        {
                                            if (otReader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = otitem.RevisionItem.Quantity * Convert.ToDecimal(otReader["Quantity"]);
                                        }
                                        else
                                        {
                                            decimal qty = otitem.ArticleDecomposedList.First(x => x.RevisionItem.WarehouseProduct.IdComponent == decomposed.ParentId).RevisionItem.Quantity;
                                            if (otReader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = qty * Convert.ToDecimal(otReader["Quantity"]);
                                        }

                                        if (otReader["IdArticle"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otReader["IdArticle"]);
                                            decomposed.RevisionItem.WarehouseProduct.Article = new Article();
                                            decomposed.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(otReader["IdArticle"]);
                                            if (otReader["IdArticleType"] != DBNull.Value)
                                                decomposed.RevisionItem.WarehouseProduct.Article.IdArticleType = Convert.ToInt64(otReader["IdArticleType"]);
                                            if (otReader["ArticleWarehouseLocationIdArticle"] != DBNull.Value)
                                            {
                                                decomposed.RevisionItem.WarehouseProduct.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                                                decomposed.RevisionItem.WarehouseProduct.Article.ArticleWarehouseLocation.IdArticle = Convert.ToInt32(otReader["ArticleWarehouseLocationIdArticle"]);
                                            }
                                            if (otReader["ArticleCurrentStock"] != DBNull.Value)
                                                decomposed.RevisionItem.WarehouseProduct.Article.ArticleCurrentStock = Convert.ToInt64(otReader["ArticleCurrentStock"]);
                                        }

                                        // int downloaded = GetOtItemDownloadedQuantity(connectionString, decomposed.RevisionItem.WarehouseProduct.IdArticle, decomposed.IdOTItem, decomposed.RevisionItem.WarehouseProduct.IdComponent, Convert.ToInt64(warehouseIds));


                                        decomposed.RevisionItem.DownloadedQuantity = 0;

                                        //  decomposed.RevisionItem.RemainingQuantity = ((Int64)decomposed.RevisionItem.Quantity - downloaded);




                                        otitem.ArticleDecomposedList.Add(decomposed);

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2036() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(otReader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(otReader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(otReader["idarticle"]) && i.RevisionItem.WarehouseProduct.IdComponent == Convert.ToInt64(otReader["idwarehouseproductcomponent"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (otReader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(otReader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2036() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(otReader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(otReader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(otReader["idarticle"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (otReader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(otReader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2036() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }




                    foreach (Ots itemOT in ots)
                    {

                        Int64 downloadedQty = 0;
                        decimal Qty = 0;
                        foreach (OtItem itemOtitem in itemOT.OtItems)
                        {
                            if (itemOtitem.RevisionItem.WarehouseProduct.Article.IdArticleType == 4)
                            {
                                foreach (OtItem itemArticleDecomposed in itemOtitem.ArticleDecomposedList)
                                {

                                    if (itemArticleDecomposed.RevisionItem.WarehouseProduct.ParentIdArticleType != 2)
                                    {
                                        if (itemArticleDecomposed.RevisionItem.WarehouseProduct.Article.IdArticleType != 4)
                                        {
                                            if (itemArticleDecomposed.RevisionItem.WarehouseProduct.Article.ArticleWarehouseLocation != null)
                                            {
                                                itemOT.OtItemCount = itemOT.OtItemCount + 1;
                                                if (itemArticleDecomposed.RevisionItem.WarehouseProduct.Article.ArticleCurrentStock == 0)
                                                {
                                                    itemOT.OutOfStockItemCount = itemOT.OutOfStockItemCount + 1;
                                                }
                                            }

                                        }
                                    }
                                }
                            }
                            else
                            {
                                if (itemOtitem.RevisionItem.WarehouseProduct.Article.ArticleWarehouseLocation != null)
                                {
                                    itemOT.OtItemCount = itemOT.OtItemCount + 1;
                                    if (itemOtitem.RevisionItem.WarehouseProduct.Article.ArticleCurrentStock == 0)
                                    {
                                        itemOT.OutOfStockItemCount = itemOT.OutOfStockItemCount + 1;
                                    }
                                }

                            }

                            if (itemOtitem.ArticleDecomposedList.Count > 0)
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.DownloadedQuantity));
                                Qty = Qty + itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.Quantity);
                                // ot.Status = (Int16)((Math.Abs(ot.DownloadedQuantity) / ot.ActualQuantity) * 100);

                            }
                            else
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.RevisionItem.DownloadedQuantity);
                                Qty = Qty + itemOtitem.RevisionItem.Quantity;
                            }

                        }
                        if (Qty > 0)
                        {
                            itemOT.Status = (Int16)((Math.Abs(downloadedQty) / Qty) * 100);
                        }
                    }
                }
            }

            ots = ots.Where(x => x.Status < 100).ToList();
            Log4NetLogger.Logger.Log("Executed GetPendingMaterialWorkOrdersByWarehouse_V2036().", category: Category.Info, priority: Priority.Low);
            return ots;
        }


        public List<Article> GetWarehouseArticlesStockByWarehouse_V2036(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<Article> articles = new List<Article>();

            using (MySqlConnection connArticle = new MySqlConnection(connectionString))
            {
                connArticle.Open();

                MySqlCommand articlesCommand = new MySqlCommand("WMS_GetWarehouseArticlesStockByWarehouse_V2036", connArticle);
                articlesCommand.CommandType = CommandType.StoredProcedure;
                articlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                articlesCommand.CommandTimeout = 8000;
                using (MySqlDataReader articleReader = articlesCommand.ExecuteReader())
                {
                    if (articleReader.HasRows)
                    {
                        while (articleReader.Read())
                        {
                            try
                            {
                                Article article = new Article();

                                if (articleReader["IdArticle"] != DBNull.Value)
                                    article.IdArticle = Convert.ToInt32(articleReader["IdArticle"]);

                                if (articleReader["Reference"] != DBNull.Value)
                                    article.Reference = Convert.ToString(articleReader["Reference"]);

                                if (articleReader["ArticleImagePath"] != DBNull.Value)
                                    article.ImagePath = Convert.ToString(articleReader["ArticleImagePath"]);

                                if (articleReader["Description"] != DBNull.Value)
                                    article.Description = Convert.ToString(articleReader["Description"]);

                                if (articleReader["Length"] != DBNull.Value)
                                    article.Length = (float)articleReader["Length"];

                                if (articleReader["Width"] != DBNull.Value)
                                    article.Width = (float)articleReader["Width"];

                                if (articleReader["Height"] != DBNull.Value)
                                    article.Height = (float)articleReader["Height"];

                                if (articleReader["Weight"] != DBNull.Value)
                                    article.Weight = Convert.ToDecimal(articleReader["Weight"]);

                                if (articleReader["articleSleepDate"] != DBNull.Value)
                                {
                                    article.ArticleSleepDate = Convert.ToDateTime(articleReader["articleSleepDate"]);
                                    article.ArticleSleepDays = (Int32)(DateTime.Now - article.ArticleSleepDate.Value.Date).TotalDays;
                                }


                                if (articleReader["IdArticleCategory"] != DBNull.Value)
                                {
                                    article.IdArticleCategory = Convert.ToInt32(articleReader["IdArticleCategory"]);

                                    article.ArticleCategory = new ArticleCategory();
                                    article.ArticleCategory.IdArticleCategory = Convert.ToInt32(articleReader["IdArticleCategory"]);
                                    article.ArticleCategory.Name = articleReader["ArticleCategory"].ToString();
                                }

                                article.MyWarehouse = new MyWarehouse();

                                if (articleReader["Location"] != DBNull.Value)
                                    article.MyWarehouse.Location = Convert.ToString(articleReader["Location"]);

                                article.MyWarehouse.IdArticle = article.IdArticle;
                                article.MyWarehouse.CurrentStock = Convert.ToInt64(articleReader["Stock"]);
                                article.MyWarehouse.MinimumStock = Convert.ToInt64(articleReader["MinimumStock"]);
                                article.MyWarehouse.MaximumStock = Convert.ToInt64(articleReader["MaximumStock"]);

                                if (articleReader["IdWarehouse"] != DBNull.Value)
                                {
                                    article.MyWarehouse.IdWarehouse = Convert.ToInt64(articleReader["IdWarehouse"]);
                                    article.MyWarehouse.Warehouse = new Warehouses();
                                    article.MyWarehouse.Warehouse.IdWarehouse = article.MyWarehouse.IdWarehouse;
                                    article.MyWarehouse.Warehouse.Name = Convert.ToString(articleReader["WarehousName"]);
                                    article.MyWarehouse.Warehouse.IdSite = Convert.ToInt64(articleReader["IdSite"]);
                                }

                                articles.Add(article);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetWarehouseArticlesStockByWarehouse_V2036() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return articles;
        }

        public List<PickingMaterials> GetArticleStockDetailForRefund_V2036(Warehouses warehouse, Int64 idOT, string articleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<PickingMaterials> PickingMaterialsList = new List<PickingMaterials>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetArticleStockDetailForRefund_V2036", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdOT", idOT);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {


                    while (articlesReader.Read())
                    {
                        try
                        {

                            PickingMaterials pickingMaterials = new PickingMaterials();

                            if (articlesReader["IdArticle"] != DBNull.Value)
                                pickingMaterials.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            pickingMaterials.Article = new Article();
                            pickingMaterials.Article.IdArticle = pickingMaterials.IdArticle;
                            pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                            pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = pickingMaterials.IdArticle;

                            if (articlesReader["awlMinimumStock"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);

                            if (articlesReader["awlMaximumStock"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["IdOtItem"] != DBNull.Value)
                                pickingMaterials.IdOtitem = Convert.ToInt64(articlesReader["IdOtItem"]);

                            if (articlesReader["IdRevisionItem"] != DBNull.Value)
                            {
                                pickingMaterials.IdRevisionItem = Convert.ToInt64(articlesReader["IdRevisionItem"]);

                                pickingMaterials.RevisionItem = new RevisionItem();
                                pickingMaterials.RevisionItem.IdRevisionItem = pickingMaterials.IdRevisionItem;

                                if (articlesReader["NumItem"] != DBNull.Value)
                                {
                                    pickingMaterials.RevisionItem.NumItem = Convert.ToString(articlesReader["NumItem"]);
                                }


                                if (articlesReader["Quantity"] != DBNull.Value)
                                    pickingMaterials.RevisionItem.Quantity = Convert.ToDecimal(articlesReader["Quantity"]);
                                if (articlesReader["IdProduct"] != DBNull.Value)
                                    pickingMaterials.RevisionItem.IdProduct = Convert.ToInt64(articlesReader["IdProduct"]);
                            }



                            if (articlesReader["idWarehouseProductComponent"] != DBNull.Value)
                            {
                                pickingMaterials.IdWarehouseProductComponent = Convert.ToInt64(articlesReader["idWarehouseProductComponent"]);
                                if (articlesReader["ProductComponentNumber"] != DBNull.Value)
                                    pickingMaterials.ProductComponentNumber = Convert.ToString(articlesReader["ProductComponentNumber"]);
                            }


                            if (articlesReader["Reference"] != DBNull.Value)
                                pickingMaterials.Reference = Convert.ToString(articlesReader["Reference"]);

                            if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                                pickingMaterials.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                            if (articlesReader["CurrentStock"] != DBNull.Value)
                                pickingMaterials.CurrentStock = Convert.ToInt64(articlesReader["CurrentStock"]);

                            if (articlesReader["costprice"] != DBNull.Value)
                                pickingMaterials.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                            if (articlesReader["UnitPrice"] != DBNull.Value)
                                pickingMaterials.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            {
                                pickingMaterials.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);


                                pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                                if (pickingMaterials.RevisionItem != null)
                                {
                                    pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbersForRefund(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, Convert.ToInt64(articlesReader["IdWarehouse"]), pickingMaterials.RevisionItem.IdProduct));
                                }
                                else
                                {
                                    pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbersForRefund(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, Convert.ToInt64(articlesReader["IdWarehouse"]), pickingMaterials.RevisionItem.IdProduct));
                                }

                            }


                            //if (articlesReader["IdArticleWarehouseLocation"] != DBNull.Value)
                            //    pickingMaterials.IdArticleWarehouseLocation = Convert.ToInt64(articlesReader["IdArticleWarehouseLocation"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.LocationFullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingMaterials.Description = articlesReader["Description"].ToString();

                            if (articlesReader["ImagePath"] != DBNull.Value)
                            {
                                pickingMaterials.ImagePath = articlesReader["ImagePath"].ToString();
                                Article article = new Article();
                                article.ImagePath = pickingMaterials.ImagePath;
                                pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, article);
                            }


                            if (articlesReader["MinimumStock"] != DBNull.Value)
                                pickingMaterials.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                            if (articlesReader["MaximumStock"] != DBNull.Value)
                                pickingMaterials.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                            pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                            if (articlesReader["UploadedIn"] != DBNull.Value)
                            {
                                pickingMaterials.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);
                                pickingMaterials.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(articlesReader["UploadedIn"]);
                            }

                            if (articlesReader["DeliveryCode"] != DBNull.Value)
                                pickingMaterials.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);

                            if (articlesReader["IdCurrency"] != DBNull.Value)
                                pickingMaterials.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                            if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                                pickingMaterials.DownloadQuantity = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                            pickingMaterials.WarehouseLocation = new WarehouseLocation();

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);

                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FullName = articlesReader["Fullname"].ToString();

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.HtmlColor = articlesReader["HtmlColor"].ToString();

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingMaterials.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingMaterials.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                            pickingMaterials.PartNumberCode = GetPartNumberCode(pickingMaterials.IdOtitem, connectionString);

                            if (articlesReader["IdCountryGroup"] != DBNull.Value)
                                pickingMaterials.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);



                            PickingMaterialsList.Add(pickingMaterials);


                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleStockDetailForRefund_V2036(IdOT-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOT, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }
            return PickingMaterialsList;
        }


        public List<OrderProcessing> GetOrderInProcessing_V2036(Warehouses warehouse, string userProfileImageFilePath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OrderProcessing> orderProcessings = new List<OrderProcessing>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetOrderInProcessing_V2036", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OrderProcessing orderProcessing = new OrderProcessing();
                                if (reader["idoffer"] != DBNull.Value)
                                    orderProcessing.IdOffer = Convert.ToInt64(reader["idoffer"]);

                                if (reader["IdStatus"] != DBNull.Value)
                                    orderProcessing.IdStatus = Convert.ToInt64(reader["IdStatus"]);

                                if (reader["StatusColor"] != DBNull.Value)
                                    orderProcessing.StatusColor = Convert.ToString(reader["StatusColor"]);

                                if (reader["code"] != DBNull.Value)
                                    orderProcessing.OfferCode = Convert.ToString(reader["code"]);

                                if (reader["Customer"] != DBNull.Value)
                                    orderProcessing.Customer = Convert.ToString(reader["Customer"]);

                                if (reader["PODate"] != DBNull.Value)
                                    orderProcessing.POReceivedDate = Convert.ToDateTime(Convert.ToDateTime(reader["PODate"]).ToString("yyyy-MM-dd"));

                                if (reader["Login"] != DBNull.Value)
                                {
                                    orderProcessing.AssignedLoginName = Convert.ToString(reader["Login"]);

                                    if (reader["IdUserGender"] != DBNull.Value)
                                        orderProcessing.IdUserGender = Convert.ToByte(reader["IdUserGender"]);

                                    if (reader["UserName"] != DBNull.Value)
                                        orderProcessing.UserName = Convert.ToString(reader["UserName"]);

                                    orderProcessing.AssignedToImageInBytes = GetUserProfileImageInBytes(orderProcessing.AssignedLoginName, userProfileImageFilePath);
                                }

                                if (reader["POCode"] != DBNull.Value)
                                    orderProcessing.POCode = Convert.ToString(reader["POCode"]);


                                orderProcessings.Add(orderProcessing);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetOrderInProcessing_V2036() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return orderProcessings;
        }



        public List<OrderPreparation> GetPendingWorkOrders_V2036(Warehouses warehouse, string userProfileImageFilePath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<UserShortDetail> userShortDetails = new List<UserShortDetail>();
            List<OrderPreparation> orderPreparations = new List<OrderPreparation>();

            using (MySqlConnection connOts = new MySqlConnection(connectionString))
            {
                connOts.Open();

                MySqlCommand otsCommand = new MySqlCommand("WMS_GetPendingWorkOrders_V2036", connOts);
                otsCommand.CommandType = CommandType.StoredProcedure;
                otsCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                otsCommand.CommandTimeout = 8000;

                using (MySqlDataReader reader = otsCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {

                                OrderPreparation orderPreparation = new OrderPreparation();

                                if (reader["IdOT"] != DBNull.Value)
                                    orderPreparation.IdOT = Convert.ToInt64(reader["IdOT"]);

                                if (reader["StatusColor"] != DBNull.Value)
                                    orderPreparation.StatusColor = Convert.ToString(reader["StatusColor"]);

                                if (reader["idOfferType"] != DBNull.Value)
                                    orderPreparation.IdOfferType = Convert.ToByte(reader["idOfferType"]);

                                if (reader["Code"] != DBNull.Value)
                                    orderPreparation.OTCode = Convert.ToString(reader["Code"]);

                                if (reader["Customer"] != DBNull.Value)
                                    orderPreparation.Customer = Convert.ToString(reader["Customer"]);

                                if (reader["DeliveryDate"] != DBNull.Value)
                                    orderPreparation.OTDeliveryDate = Convert.ToDateTime(Convert.ToDateTime(reader["DeliveryDate"]).ToString("yyyy-MM-dd"));


                                if (reader["IdCarriageMethod"] != DBNull.Value)
                                {
                                    orderPreparation.IdCarriageMethod = Convert.ToInt32(reader["IdCarriageMethod"]);
                                    orderPreparation.CarriageMethod = new LookupValue();
                                    orderPreparation.CarriageMethod.IdLookupValue = Convert.ToInt32(reader["IdCarriageMethod"]);
                                    if (reader["CarriageValue"] != DBNull.Value)
                                        orderPreparation.CarriageMethod.Value = Convert.ToString(reader["CarriageValue"]);
                                    if (reader["CarriageIdImage"] != DBNull.Value)
                                        orderPreparation.CarriageMethod.IdImage = Convert.ToInt64(reader["CarriageIdImage"]);
                                }



                                if (reader["OTDeliveryDateWeek"] != DBNull.Value)
                                    orderPreparation.OtDeliveryDateWeek = Convert.ToInt64(reader["OTDeliveryDateWeek"]);

                                if (reader["CurrentDateWeek"] != DBNull.Value)
                                    orderPreparation.CurrentDateWeek = Convert.ToInt64(reader["CurrentDateWeek"]);

                                if (orderPreparation.OtDeliveryDateWeek == orderPreparation.CurrentDateWeek)
                                {

                                    if (reader["StockModifiedByLogin"] != DBNull.Value)
                                    {
                                        orderPreparation.ArticleStockModifiedBy = Convert.ToString(reader["StockModifiedByLogin"]);
                                        orderPreparation.UserShortDetails = new List<UserShortDetail>();

                                        foreach (string itemLogin in orderPreparation.ArticleStockModifiedBy.Split(','))
                                        {
                                            if (!orderPreparation.UserShortDetails.Any(i => i.Login == itemLogin))
                                            {
                                                UserShortDetail usd = new UserShortDetail();
                                                usd.Login = itemLogin;
                                                orderPreparation.UserShortDetails.Add(usd);
                                                if (!userShortDetails.Any(i => i.Login == itemLogin))
                                                {
                                                    userShortDetails.Add(usd);
                                                }

                                                // usd.UserImageInBytes = GetUserProfileImageInBytes(itemLogin, userProfileImageFilePath);

                                            }

                                        }


                                    }
                                }

                                if (reader["ActualQty"] != DBNull.Value)
                                    orderPreparation.ActualQty = Convert.ToInt64(reader["ActualQty"]);

                                if (reader["DownloadedQty"] != DBNull.Value)
                                    orderPreparation.DownloadedQty = Convert.ToInt64(reader["DownloadedQty"]);



                                orderPreparation.RemainingQty = orderPreparation.ActualQty + orderPreparation.DownloadedQty;
                                if (orderPreparation.ActualQty > 0)
                                {
                                    orderPreparation.Progress = (Int16)((Math.Abs(orderPreparation.DownloadedQty) / orderPreparation.ActualQty) * 100);
                                }
                                orderPreparation.OtItems = new List<OtItem>();
                                orderPreparations.Add(orderPreparation);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingWorkOrders_V2036() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OrderPreparation orderPreparation = orderPreparations.FirstOrDefault(x => x.IdOT == Convert.ToInt64(reader["IdOT"]));
                                if (orderPreparation != null)
                                {
                                    OtItem otItem = new OtItem();
                                    if (reader["IdOT"] != DBNull.Value)
                                        otItem.IdOT = Convert.ToInt64(reader["IdOT"]);
                                    if (reader["IdOtItem"] != DBNull.Value)
                                        otItem.IdOTItem = Convert.ToInt64(reader["IdOtItem"]);
                                    if (reader["IdRevisionItem"] != DBNull.Value)
                                    {
                                        otItem.IdRevisionItem = Convert.ToInt64(reader["IdRevisionItem"]);
                                        otItem.RevisionItem = new RevisionItem();
                                        otItem.RevisionItem.IdRevisionItem = Convert.ToInt64(reader["IdRevisionItem"]);
                                        otItem.RevisionItem.Quantity = Convert.ToDecimal(reader["Quantity"]);
                                        if (reader["DownloadedQty"] != DBNull.Value)
                                            otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(reader["DownloadedQty"]);

                                        if (reader["RemainingQty"] != DBNull.Value)
                                            otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(reader["RemainingQty"]);
                                    }
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    orderPreparation.OtItems.Add(otItem);
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingWorkOrders_V2036() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }


                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OrderPreparation orderPreparation = orderPreparations.FirstOrDefault(x => x.IdOT == Convert.ToInt64(reader["IdOT"]));
                                if (orderPreparation != null)
                                {
                                    OtItem otitem = orderPreparation.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(reader["idotitem"])).FirstOrDefault();

                                    OtItem decomposed = new OtItem();
                                    if (otitem != null)
                                    {
                                        decomposed.IdOT = orderPreparation.IdOT;
                                        decomposed.IdOTItem = Convert.ToInt64(reader["IdOtItem"]);

                                        if (reader["idParent"] != DBNull.Value)
                                        {
                                            decomposed.ParentId = Convert.ToInt32(reader["idParent"]);
                                        }
                                        decomposed.RevisionItem = new RevisionItem();
                                        decomposed.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                        decomposed.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(reader["IdWarehouseproduct"]);



                                        if (reader["IdComponent"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(reader["IdComponent"]);
                                        }
                                        if (decomposed.ParentId == -1)
                                        {
                                            if (reader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = otitem.RevisionItem.Quantity * Convert.ToDecimal(reader["Quantity"]);
                                        }
                                        else
                                        {
                                            decimal qty = otitem.ArticleDecomposedList.First(x => x.RevisionItem.WarehouseProduct.IdComponent == decomposed.ParentId).RevisionItem.Quantity;
                                            if (reader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = qty * Convert.ToDecimal(reader["Quantity"]);
                                        }

                                        if (reader["IdArticle"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                        }

                                        decomposed.RevisionItem.DownloadedQuantity = 0;


                                        otitem.ArticleDecomposedList.Add(decomposed);

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingWorkOrders_V2036() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OrderPreparation orderPreparation = orderPreparations.FirstOrDefault(x => x.IdOT == Convert.ToInt64(reader["IdOT"]));
                                if (orderPreparation != null)
                                {
                                    OtItem otitem = orderPreparation.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(reader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(reader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(reader["idarticle"]) && i.RevisionItem.WarehouseProduct.IdComponent == Convert.ToInt64(reader["idwarehouseproductcomponent"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (reader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(reader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingWorkOrders_V2036() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OrderPreparation orderPreparation = orderPreparations.FirstOrDefault(x => x.IdOT == Convert.ToInt64(reader["IdOT"]));
                                if (orderPreparation != null)
                                {
                                    OtItem otitem = orderPreparation.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(reader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(reader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(reader["idarticle"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (reader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(reader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingWorkOrders_V2036() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }




                    foreach (OrderPreparation itemOP in orderPreparations)
                    {
                        Int64 downloadedQty = 0;
                        decimal Qty = 0;
                        foreach (OtItem itemOtitem in itemOP.OtItems)
                        {
                            if (itemOtitem.ArticleDecomposedList.Count > 0)
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.DownloadedQuantity));
                                Qty = Qty + itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.Quantity);
                                // ot.Status = (Int16)((Math.Abs(ot.DownloadedQuantity) / ot.ActualQuantity) * 100);

                            }
                            else
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.RevisionItem.DownloadedQuantity);
                                Qty = Qty + itemOtitem.RevisionItem.Quantity;
                            }

                        }
                        if (Qty > 0)
                        {
                            itemOP.Progress = (Int16)((Math.Abs(downloadedQty) / Qty) * 100);
                        }
                    }
                }
            }

            orderPreparations = orderPreparations.Where(x => x.Progress < 100).ToList();
            orderPreparations.AddRange(orderPreparations.Where(x => x.Progress == 100 && x.OtDeliveryDateWeek == x.CurrentDateWeek).ToList());
            Log4NetLogger.Logger.Log("Executed GetPendingWorkOrders_V2036().", category: Category.Info, priority: Priority.Low);

            //Get userImage And UserName
            string getLogins = string.Join(",", userShortDetails.Select(i => i.Login).ToList());
            userShortDetails = GetUserShortDetail(getLogins, connectionString);
            foreach (OrderPreparation itemOP in orderPreparations)
            {
                if (itemOP.UserShortDetails != null)
                {
                    foreach (UserShortDetail itemOPUSD in itemOP.UserShortDetails)
                    {
                        if (userShortDetails.Any(usd => usd.Login == itemOPUSD.Login))
                        {
                            UserShortDetail usdItem = userShortDetails.Where(usd => usd.Login == itemOPUSD.Login).FirstOrDefault();
                            itemOPUSD.IdUserGender = usdItem.IdUserGender;
                            itemOPUSD.UserName = usdItem.UserName;
                            itemOPUSD.UserImageInBytes = GetUserProfileImageInBytes(itemOPUSD.Login, userProfileImageFilePath);
                        }
                    }
                }

            }

            return orderPreparations.OrderBy(op => op.OTDeliveryDate).ToList();
        }


        public Int64 GetCountOfRefillWithNoStock(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            Int64 refillWithNoStock = 0;

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetCountOfRefillWithNoStock", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {

                                if (reader["RefillWithNoStock"] != DBNull.Value)
                                    refillWithNoStock = Convert.ToInt64(reader["RefillWithNoStock"]);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetCountOfRefillWithNoStock() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return refillWithNoStock;
        }


        public List<Article> GetSelectedArticleImageInBytes(List<Article> articles, string articleVisualAidsPath)
        {

            try
            {
                if (articles != null)
                {
                    foreach (Article itemArticle in articles)
                    {
                        if (!string.IsNullOrEmpty(itemArticle.ImagePath))
                            itemArticle.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, itemArticle);
                    }
                }
            }

            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetSelectedArticleImageInBytes() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return articles;
        }

        public List<ArticleWarehouseLocations> GetArticleWarehouseLocationStockIncludingSerialNumber(string connectionString, Int32 idArticle, Int64 idWarehouse)
        {
            List<ArticleWarehouseLocations> articleWarehouseLocationLst = new List<ArticleWarehouseLocations>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetArticleWarehouseLocationStockIncludingSerialNumber", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", idArticle);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ArticleWarehouseLocations articleWarehouseLocation = new ArticleWarehouseLocations();
                        try
                        {
                            if (reader["ArticleWLPostion"] != DBNull.Value)
                            {
                                articleWarehouseLocation.Position = Convert.ToInt64(reader["ArticleWLPostion"]);
                            }

                            articleWarehouseLocation.IdArticle = idArticle;

                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                articleWarehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);
                                articleWarehouseLocation.WarehouseLocation = new WarehouseLocation();
                                articleWarehouseLocation.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                                if (reader["Position"] != DBNull.Value)
                                    articleWarehouseLocation.WarehouseLocation.Position = Convert.ToInt64(reader["Position"]);

                                if (reader["FullName"] != DBNull.Value)
                                    articleWarehouseLocation.WarehouseLocation.FullName = Convert.ToString(reader["FullName"]);
                            }

                            if (reader["Qty"] != DBNull.Value)
                            {
                                articleWarehouseLocation.ArticlesStock = new ArticlesStock();

                                articleWarehouseLocation.ArticlesStock.IdWarehouseLocation = Convert.ToUInt64(reader["IdWarehouseLocation"]);
                                articleWarehouseLocation.ArticlesStock.Quantity = Convert.ToInt64(reader["Qty"]);
                            }

                            if (reader["MinimumStock"] != DBNull.Value)
                            {
                                articleWarehouseLocation.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);
                            }
                            if (reader["MaximumStock"] != DBNull.Value)
                            {
                                articleWarehouseLocation.MaximumStock = Convert.ToInt64(reader["MaximumStock"]);
                            }
                            articleWarehouseLocation.WarehouseDeliveryNotes = new List<WarehouseDeliveryNote>();

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleWarehouseLocationStockIncludingSerialNumber(). IdArticle- {0} IdWarehouseLocation-{1}  ErrorMessage- {2}", articleWarehouseLocation.IdArticle, articleWarehouseLocation.IdWarehouseLocation, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                        articleWarehouseLocationLst.Add(articleWarehouseLocation);
                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                if (articleWarehouseLocationLst != null)
                                {
                                    if (articleWarehouseLocationLst.Any(i => i.IdWarehouseLocation == Convert.ToInt64(reader["IdWarehouseLocation"])))
                                    {
                                        ArticleWarehouseLocations articleWarehouseLocations = articleWarehouseLocationLst.Where(i => i.IdWarehouseLocation == Convert.ToInt64(reader["IdWarehouseLocation"])).FirstOrDefault();
                                        if (articleWarehouseLocations != null)
                                        {
                                            WarehouseDeliveryNote warehouseDeliveryNote = new WarehouseDeliveryNote();
                                            if (reader["DeliveryDate"] != DBNull.Value)
                                                warehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                            if (reader["Code"] != DBNull.Value)
                                                warehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                            if (reader["Quantity"] != DBNull.Value)
                                                warehouseDeliveryNote.Quantity = Convert.ToInt64(reader["Quantity"]);
                                            if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                                                warehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["idWarehouseDeliveryNote"]);

                                            if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                            {
                                                warehouseDeliveryNote.WarehouseDeliveryNoteItems = new List<WarehouseDeliveryNoteItem>();
                                                WarehouseDeliveryNoteItem warehouseDeliveryNoteItem = new WarehouseDeliveryNoteItem();
                                                warehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);
                                                warehouseDeliveryNote.WarehouseDeliveryNoteItems.Add(warehouseDeliveryNoteItem);
                                            }

                                            if (reader["SerialCodes"] != DBNull.Value)
                                            {
                                                warehouseDeliveryNote.SerialCodes = Convert.ToString(reader["SerialCodes"]).Split(',').ToList<string>();
                                            }


                                            warehouseDeliveryNote.MasterItem = articleWarehouseLocations;
                                            articleWarehouseLocations.WarehouseDeliveryNotes.Add(warehouseDeliveryNote);
                                        }
                                    }
                                }
                            }
                        }
                    }

                }
            }

            return articleWarehouseLocationLst;
        }

        public bool RemovePackingBox(Warehouses warehouse, Int64 idPackingBox)
        {
            bool isDeleted = false;
            string connectionString = warehouse.Company.ConnectPlantConstr;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_Packingboxes_Delete", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdPackingBox", idPackingBox);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();

                    }

                    transactionScope.Complete();
                    isDeleted = true;
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isDeleted = false;
                throw;
            }

            return isDeleted;
        }


        public DashboardInventory GetTotalItemsToRefill_V2037(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            DashboardInventory dashboardInventory = new DashboardInventory();
            // Int64 LocationCount = GetTotalWarehouseLocation(warehouse);
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetTotalItemsToRefill_V2037", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        if (reader.Read())
                        {
                            try
                            {

                                if (reader["TotalItemsToRefill"] != DBNull.Value)
                                {
                                    dashboardInventory.TotalItemsToRefill = Convert.ToInt64(reader["TotalItemsToRefill"]);
                                    //if (LocationCount > 0)
                                    //    dashboardInventory.Progress = (Int16)((dashboardInventory.Count / LocationCount) * 100);
                                    //else
                                    //    dashboardInventory.Progress = 0;

                                }

                                if (reader["TotalItemsToRefillOutOfStock"] != DBNull.Value)
                                {
                                    dashboardInventory.TotalItemsToRefillOutOfStock = Convert.ToInt64(reader["TotalItemsToRefillOutOfStock"]);
                                    //if (LocationCount > 0)
                                    //    dashboardInventory.Progress = (Int16)((dashboardInventory.Count / LocationCount) * 100);
                                    //else
                                    //    dashboardInventory.Progress = 0;

                                }

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetTotalItemsToRefill_V2037() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }

                    }
                }
            }

            return dashboardInventory;
        }


        public DashboardInventory GetTotalItemsToLocate_V2037(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            DashboardInventory dashboardInventory = new DashboardInventory();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetTotalItemsToLocate_V2037", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        if (reader.Read())
                        {
                            try
                            {

                                if (reader["TotalItemsToLocate"] != DBNull.Value)
                                    dashboardInventory.Count = Convert.ToInt64(reader["TotalItemsToLocate"]);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetTotalItemsToLocate_V2037() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return dashboardInventory;
        }


        public List<ArticleForecast> GetArticleForecast_V2037(string connectionString, Int32 idArticle, Int64 idWarehouse)
        {
            List<ArticleForecast> articleForecasts = new List<ArticleForecast>();


            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetArticleForecast_V2037", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdArticle", idArticle);
                command.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                command.CommandTimeout = 8000;
                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            ArticleForecast articleForecast = new ArticleForecast();


                            articleForecast.Type = "OT";
                            if (reader["IdOT"] != DBNull.Value)
                                articleForecast.Id = Convert.ToInt64(reader["IdOT"]);

                            if (reader["Customer"] != DBNull.Value)
                                articleForecast.CustomerORSupplier = Convert.ToString(reader["Customer"]);
                            if (reader["OTCode"] != DBNull.Value)
                                articleForecast.Code = Convert.ToString(reader["OTCode"]);
                            if (reader["DeliveryDate"] != DBNull.Value)
                                articleForecast.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                            if (reader["RemainingQty"] != DBNull.Value)
                                articleForecast.Quantity = Convert.ToInt64(reader["RemainingQty"]);



                            articleForecasts.Add(articleForecast);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleForecast_V2037(idArticle-{0}). ErrorMessage- {1}", idArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                ArticleForecast articleForecast = new ArticleForecast();


                                articleForecast.Type = "PO";

                                if (reader["IdWarehousePurchaseOrder"] != DBNull.Value)
                                    articleForecast.Id = Convert.ToInt64(reader["IdWarehousePurchaseOrder"]);

                                if (reader["Supplier"] != DBNull.Value)
                                    articleForecast.CustomerORSupplier = Convert.ToString(reader["Supplier"]);
                                if (reader["POCode"] != DBNull.Value)
                                    articleForecast.Code = Convert.ToString(reader["POCode"]);
                                if (reader["DeliveryDate"] != DBNull.Value)
                                    articleForecast.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                if (reader["RemainingQty"] != DBNull.Value)
                                    articleForecast.Quantity = Convert.ToInt64(reader["RemainingQty"]);

                                articleForecasts.Add(articleForecast);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetArticleForecast_V2037(idArticle-{0}). ErrorMessage- {1}", idArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return articleForecasts.OrderBy(i => i.DeliveryDate).ToList();
        }


        public Article GetArticleDetailsByReference_V2037(string reference, string articleVisualAidsPath, Warehouses warehouse, DateTime? fromDate = null, DateTime? toDate = null)
        {
            Article article = new Article();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetArticleDetailsByReference_V2037", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_Reference", reference);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 8000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        try
                        {
                            if (reader["idArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(reader["idArticle"]);

                            if (reader["IdArticleCategory"] != DBNull.Value)
                            {
                                article.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory = new ArticleCategory();
                                article.ArticleCategory.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory.Name = Convert.ToString(reader["categoryName"]);
                                article.ArticleCategory.TaricCode = Convert.ToString(reader["TaricCode"]);
                            }

                            if (reader["ImagePath"] != DBNull.Value)
                            {
                                article.ImagePath = Convert.ToString(reader["ImagePath"]);

                                if (!string.IsNullOrEmpty(article.ImagePath))
                                    article.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, article);
                            }

                            if (reader["Reference"] != DBNull.Value)
                                article.Reference = reader["Reference"].ToString();

                            if (reader["IsOrientativeVisualAid"] != DBNull.Value)
                                article.IsOrientativeVisualAid = Convert.ToByte(reader["IsOrientativeVisualAid"]);

                            if (reader["IsGeneric"] != DBNull.Value)
                                article.IsGeneric = Convert.ToSByte(reader["IsGeneric"]);

                            if (reader["isObsolete"] != DBNull.Value)
                                article.IsObsolete = Convert.ToSByte(reader["isObsolete"]);

                            if (reader["isPublic"] != DBNull.Value)
                                article.IsPublic = Convert.ToSByte(reader["isPublic"]);

                            if (reader["publishOnWeb"] != DBNull.Value)
                                article.PublishOnWeb = Convert.ToSByte(reader["publishOnWeb"]);

                            if (reader["registerSerialNumber"] != DBNull.Value)
                                article.RegisterSerialNumber = Convert.ToByte(reader["registerSerialNumber"]);

                            if (reader["CreatedIn"] != DBNull.Value)
                                article.CreatedIn = Convert.ToDateTime(reader["CreatedIn"]);

                            if (reader["ModifiedIn"] != DBNull.Value)
                                article.ModifiedIn = Convert.ToDateTime(reader["ModifiedIn"]);

                            if (reader["description"] != DBNull.Value)
                                article.Description = Convert.ToString(reader["description"]);

                            if (reader["description_es"] != DBNull.Value)
                                article.Description_es = Convert.ToString(reader["description_es"]);

                            if (reader["description_fr"] != DBNull.Value)
                                article.Description_fr = Convert.ToString(reader["description_fr"]);

                            if (reader["description_pt"] != DBNull.Value)
                                article.Description_pt = Convert.ToString(reader["description_pt"]);

                            if (reader["description_ro"] != DBNull.Value)
                                article.Description_ro = Convert.ToString(reader["description_ro"]);

                            if (reader["description_ru"] != DBNull.Value)
                                article.Description_ru = Convert.ToString(reader["description_ru"]);

                            if (reader["description_zh"] != DBNull.Value)
                                article.Description_zh = Convert.ToString(reader["description_zh"]);

                            if (reader["idReplacementArticle"] != DBNull.Value)
                            {
                                article.IdReplacementArticle = Convert.ToInt32(reader["idReplacementArticle"]);
                                article.ReplacementArticle = Convert.ToString(reader["ReplacementArticle"]);
                            }

                            if (reader["isBatch"] != DBNull.Value)
                                article.IsBatch = Convert.ToByte(reader["isBatch"]);

                            if (reader["taric"] != DBNull.Value)
                                article.Taric = Convert.ToString(reader["taric"]);

                            if (reader["IdArticleType"] != DBNull.Value)
                            {
                                article.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                article.ArticlesType = new ArticleType();
                                article.ArticlesType.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                if (reader["ArticleTypeName"] != DBNull.Value)
                                    article.ArticlesType.Name = Convert.ToString(reader["ArticleTypeName"]);
                            }


                            if (reader["Weight"] != DBNull.Value)
                                article.Weight = Convert.ToDecimal(reader["Weight"]);

                            if (reader["Width"] != DBNull.Value)
                                article.Width = (float)(reader["Width"]);

                            if (reader["Length"] != DBNull.Value)
                                article.Length = (float)(reader["Length"]);

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)(reader["Height"]);


                            if (reader["idCountry"] != DBNull.Value)
                            {
                                article.IdCountry = Convert.ToInt32(reader["idCountry"]);

                                article.Country = new Country();
                                article.Country.IdCountry = Convert.ToByte(reader["idCountry"]);
                                article.Country.Name = Convert.ToString(reader["CountryName"]);
                            }

                            if (reader["articleSleepDate"] != DBNull.Value)
                            {
                                article.ArticleSleepDate = Convert.ToDateTime(reader["articleSleepDate"]);
                                article.ArticleSleepDays = (Int32)(DateTime.Now - article.ArticleSleepDate.Value.Date).TotalDays;
                            }

                            article.MyWarehouse = new MyWarehouse();

                            if (reader["minimumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MinimumStock = Convert.ToInt64(reader["minimumStock"]);
                            }

                            if (reader["stock"] != DBNull.Value)
                            {
                                article.MyWarehouse.CurrentStock = Convert.ToInt64(reader["stock"]);
                            }

                            if (reader["maximumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MaximumStock = Convert.ToInt64(reader["maximumStock"]);
                            }

                            if (reader["idWareHouse"] != DBNull.Value)
                            {
                                article.MyWarehouse.IdWarehouse = Convert.ToInt64(reader["idWareHouse"]);
                            }

                            if (reader["location"] != DBNull.Value)
                            {
                                article.MyWarehouse.Location = Convert.ToString(reader["location"]);
                            }

                            if (reader["MaterialType"] != DBNull.Value)
                                article.MaterialType = Convert.ToInt64(reader["MaterialType"].ToString());
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleDetailsByReference_V2036(). Reference- {0} IdArticle-{1} ErrorMessage- {2}", reference, article.IdArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
                article.LstArticleBySupplier = new List<ArticleBySupplier>();
                article.LstArticleBySupplier = GetArticleSupplierDetailsByIdArticle(connectionString, article.IdArticle);

                article.LstArticleDecomposition = new List<ArticleDecomposition>();
                article.LstArticleDecomposition = GetArticleDeCompostionByIdArticle(connectionString, article.IdArticle);

                article.LstRelatedArticle = new List<RelatedArticle>();
                article.LstRelatedArticle = GetRelatedArticleDetailsByIdArticle(connectionString, article.IdArticle, warehouse.IdWarehouse);

                article.LstArticleDocument = new List<ArticleDocument>();
                article.LstArticleDocument = GetArticleAttachmentByIdArticle(connectionString, article.IdArticle);

                if (article.RegisterSerialNumber == 1)
                {
                    article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                    article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockIncludingSerialNumber(connectionString, article.IdArticle, warehouse.IdWarehouse);
                    // article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle_V2034(connectionString, article.IdArticle, warehouse.IdWarehouse);
                }
                else
                {
                    article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                    article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle_V2034(connectionString, article.IdArticle, warehouse.IdWarehouse);
                }

                article.LstManufacturersByArticles = new List<ManufacturersByArticle>();
                article.LstManufacturersByArticles = GetManufacturers(connectionString, article.IdArticle);

                //if (fromDate != null && toDate != null)
                //{
                article.LstArticlesStock = new List<ArticlesStock>();
                article.LstArticlesStock = GetStockHistoryByIdArticle_V2033(connectionString, article.IdArticle, DateTime.Now, DateTime.Now, warehouse.IdWarehouse);
                // }


                article.LstArticleForecast = new List<ArticleForecast>();
                article.LstArticleForecast = GetArticleForecast_V2037(connectionString, article.IdArticle, warehouse.IdWarehouse);

            }

            return article;
        }

        public bool UpdateIsClosedInPackingBox(Warehouses warehouse, Int64 idPackingBox, sbyte isClosed)
        {
            bool isUpdated = false;
            string connectionString = warehouse.Company.ConnectPlantConstr;
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_Packingboxes_UpdateIsClosed", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdPackingBox", idPackingBox);
                        mySqlCommand.Parameters.AddWithValue("_IsClosed", isClosed);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();

                    }

                    transactionScope.Complete();
                    isUpdated = true;
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();
                isUpdated = false;
                throw;
            }

            return isUpdated;
        }

        public List<Article> GetArticlesByLocation(Warehouses warehouse, Int64 idFromWarehouseLocation, Int64 idToWarehouseLocation)
        {
            List<Article> lstArticles = new List<Article>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            Int64 articleCountInFromLocation = 0;
            try
            {

                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetArticlesByLocation", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;

                    mySqlCommand.Parameters.AddWithValue("_IdFromWarehouseLocation", idFromWarehouseLocation);
                    mySqlCommand.Parameters.AddWithValue("_IdToWarehouseLocation", idToWarehouseLocation);
                    mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        if (reader.Read())
                        {
                            if (reader["articleCountInFromLocation"] != DBNull.Value)
                                articleCountInFromLocation = Convert.ToInt64(reader["articleCountInFromLocation"]);

                        }
                        if (articleCountInFromLocation > 1)
                        {
                            if (reader.NextResult())
                            {
                                while (reader.Read())
                                {
                                    Article article = new Article();

                                    if (reader["idArticle"] != DBNull.Value)
                                    {
                                        article.IdArticle = Convert.ToInt32(reader["idArticle"]);

                                        if (reader["Reference"] != DBNull.Value)
                                            article.Reference = Convert.ToString(reader["Reference"]);

                                        if (reader["ArticleCurrentStock"] != DBNull.Value)
                                            article.ArticleCurrentStock = Convert.ToInt64(reader["ArticleCurrentStock"]);

                                        if (reader["IsArticleInRefillExistInAnotherLocation"] != DBNull.Value)
                                            article.IsArticleInRefillExistInAnotherLocation = Convert.ToBoolean(reader["IsArticleInRefillExistInAnotherLocation"]);

                                        if (reader["IdFromWarehouseLocation"] != DBNull.Value)
                                        {
                                            article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                                            article.ArticleWarehouseLocation.IdArticleWarehouseLocation = Convert.ToInt64(reader["IdFromWarehouseLocation"]);
                                            if (reader["MaximumStock"] != DBNull.Value)
                                                article.ArticleWarehouseLocation.MaximumStock = Convert.ToInt64(reader["MaximumStock"]);
                                            if (reader["MinimumStock"] != DBNull.Value)
                                                article.ArticleWarehouseLocation.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);
                                        }

                                        if (reader["IdToWarehouseLocation"] != DBNull.Value)
                                        {
                                            article.ToWarehouseLocation = new WarehouseLocation();
                                            article.ToWarehouseLocation.IdWarehouseLocation = Convert.ToInt64(reader["IdToWarehouseLocation"]);

                                            if (reader["ToWarehouseLocationFullName"] != DBNull.Value)
                                                article.ToWarehouseLocation.FullName = Convert.ToString(reader["ToWarehouseLocationFullName"]);
                                            if (reader["Latitude"] != DBNull.Value)
                                                article.ToWarehouseLocation.Latitude = Convert.ToDouble(reader["Latitude"]);
                                            if (reader["Longitude"] != DBNull.Value)
                                                article.ToWarehouseLocation.Longitude = Convert.ToDouble(reader["Longitude"]);
                                            if (reader["Width"] != DBNull.Value)
                                                article.ToWarehouseLocation.Width = Convert.ToDouble(reader["Width"]);
                                            if (reader["Height"] != DBNull.Value)
                                                article.ToWarehouseLocation.Height = Convert.ToDouble(reader["Height"]);
                                        }
                                    }
                                    lstArticles.Add(article);
                                }
                            }
                        }
                    }

                    mySqlConnection.Close();

                }




            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetArticlesByLocation(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }

            return lstArticles;
        }


        public List<OrderPreparation> GetPendingWorkOrders_V2037(Warehouses warehouse, string userProfileImageFilePath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<UserShortDetail> userShortDetails = new List<UserShortDetail>();
            List<OrderPreparation> orderPreparations = new List<OrderPreparation>();

            using (MySqlConnection connOts = new MySqlConnection(connectionString))
            {
                connOts.Open();

                MySqlCommand otsCommand = new MySqlCommand("WMS_GetPendingWorkOrders_V2037", connOts);
                otsCommand.CommandType = CommandType.StoredProcedure;
                otsCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                otsCommand.CommandTimeout = 8000;

                using (MySqlDataReader reader = otsCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {

                                OrderPreparation orderPreparation = new OrderPreparation();

                                if (reader["IdOT"] != DBNull.Value)
                                    orderPreparation.IdOT = Convert.ToInt64(reader["IdOT"]);

                                if (reader["StatusColor"] != DBNull.Value)
                                    orderPreparation.StatusColor = Convert.ToString(reader["StatusColor"]);

                                if (reader["idOfferType"] != DBNull.Value)
                                    orderPreparation.IdOfferType = Convert.ToByte(reader["idOfferType"]);

                                if (reader["Code"] != DBNull.Value)
                                    orderPreparation.OTCode = Convert.ToString(reader["Code"]);

                                if (reader["Customer"] != DBNull.Value)
                                    orderPreparation.Customer = Convert.ToString(reader["Customer"]);

                                if (reader["DeliveryDate"] != DBNull.Value)
                                    orderPreparation.OTDeliveryDate = Convert.ToDateTime(Convert.ToDateTime(reader["DeliveryDate"]).ToString("yyyy-MM-dd"));


                                if (reader["IdCarriageMethod"] != DBNull.Value)
                                {
                                    orderPreparation.IdCarriageMethod = Convert.ToInt32(reader["IdCarriageMethod"]);
                                    orderPreparation.CarriageMethod = new LookupValue();
                                    orderPreparation.CarriageMethod.IdLookupValue = Convert.ToInt32(reader["IdCarriageMethod"]);
                                    if (reader["CarriageValue"] != DBNull.Value)
                                        orderPreparation.CarriageMethod.Value = Convert.ToString(reader["CarriageValue"]);
                                    if (reader["CarriageIdImage"] != DBNull.Value)
                                        orderPreparation.CarriageMethod.IdImage = Convert.ToInt64(reader["CarriageIdImage"]);
                                }



                                if (reader["OTDeliveryDateWeek"] != DBNull.Value)
                                    orderPreparation.OtDeliveryDateWeek = Convert.ToInt64(reader["OTDeliveryDateWeek"]);

                                if (reader["CurrentDateWeek"] != DBNull.Value)
                                    orderPreparation.CurrentDateWeek = Convert.ToInt64(reader["CurrentDateWeek"]);

                                if (reader["IsCritical"] != DBNull.Value)
                                    orderPreparation.IsCritical = Convert.ToByte(reader["IsCritical"]);

                                if (orderPreparation.OtDeliveryDateWeek == orderPreparation.CurrentDateWeek)
                                {

                                    if (reader["StockModifiedByLogin"] != DBNull.Value)
                                    {
                                        orderPreparation.ArticleStockModifiedBy = Convert.ToString(reader["StockModifiedByLogin"]);
                                        orderPreparation.UserShortDetails = new List<UserShortDetail>();

                                        foreach (string itemLogin in orderPreparation.ArticleStockModifiedBy.Split(','))
                                        {
                                            if (!orderPreparation.UserShortDetails.Any(i => i.Login == itemLogin))
                                            {
                                                UserShortDetail usd = new UserShortDetail();
                                                usd.Login = itemLogin;
                                                orderPreparation.UserShortDetails.Add(usd);
                                                if (!userShortDetails.Any(i => i.Login == itemLogin))
                                                {
                                                    userShortDetails.Add(usd);
                                                }

                                                // usd.UserImageInBytes = GetUserProfileImageInBytes(itemLogin, userProfileImageFilePath);

                                            }

                                        }


                                    }
                                }

                                if (reader["ActualQty"] != DBNull.Value)
                                    orderPreparation.ActualQty = Convert.ToInt64(reader["ActualQty"]);

                                if (reader["DownloadedQty"] != DBNull.Value)
                                    orderPreparation.DownloadedQty = Convert.ToInt64(reader["DownloadedQty"]);



                                orderPreparation.RemainingQty = orderPreparation.ActualQty + orderPreparation.DownloadedQty;
                                if (orderPreparation.ActualQty > 0)
                                {
                                    orderPreparation.Progress = (Int16)((Math.Abs(orderPreparation.DownloadedQty) / orderPreparation.ActualQty) * 100);
                                }
                                orderPreparation.OtItems = new List<OtItem>();
                                orderPreparations.Add(orderPreparation);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingWorkOrders_V2037() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OrderPreparation orderPreparation = orderPreparations.FirstOrDefault(x => x.IdOT == Convert.ToInt64(reader["IdOT"]));
                                if (orderPreparation != null)
                                {
                                    OtItem otItem = new OtItem();
                                    if (reader["IdOT"] != DBNull.Value)
                                        otItem.IdOT = Convert.ToInt64(reader["IdOT"]);
                                    if (reader["IdOtItem"] != DBNull.Value)
                                        otItem.IdOTItem = Convert.ToInt64(reader["IdOtItem"]);
                                    if (reader["IdRevisionItem"] != DBNull.Value)
                                    {
                                        otItem.IdRevisionItem = Convert.ToInt64(reader["IdRevisionItem"]);
                                        otItem.RevisionItem = new RevisionItem();
                                        otItem.RevisionItem.IdRevisionItem = Convert.ToInt64(reader["IdRevisionItem"]);
                                        otItem.RevisionItem.Quantity = Convert.ToDecimal(reader["Quantity"]);
                                        if (reader["DownloadedQty"] != DBNull.Value)
                                            otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(reader["DownloadedQty"]);

                                        if (reader["RemainingQty"] != DBNull.Value)
                                            otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(reader["RemainingQty"]);
                                    }
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    orderPreparation.OtItems.Add(otItem);
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingWorkOrders_V2037() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }


                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OrderPreparation orderPreparation = orderPreparations.FirstOrDefault(x => x.IdOT == Convert.ToInt64(reader["IdOT"]));
                                if (orderPreparation != null)
                                {
                                    OtItem otitem = orderPreparation.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(reader["idotitem"])).FirstOrDefault();

                                    OtItem decomposed = new OtItem();
                                    if (otitem != null)
                                    {
                                        decomposed.IdOT = orderPreparation.IdOT;
                                        decomposed.IdOTItem = Convert.ToInt64(reader["IdOtItem"]);

                                        if (reader["idParent"] != DBNull.Value)
                                        {
                                            decomposed.ParentId = Convert.ToInt32(reader["idParent"]);
                                        }
                                        decomposed.RevisionItem = new RevisionItem();
                                        decomposed.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                        decomposed.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(reader["IdWarehouseproduct"]);



                                        if (reader["IdComponent"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(reader["IdComponent"]);
                                        }
                                        if (decomposed.ParentId == -1)
                                        {
                                            if (reader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = otitem.RevisionItem.Quantity * Convert.ToDecimal(reader["Quantity"]);
                                        }
                                        else
                                        {
                                            decimal qty = otitem.ArticleDecomposedList.First(x => x.RevisionItem.WarehouseProduct.IdComponent == decomposed.ParentId).RevisionItem.Quantity;
                                            if (reader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = qty * Convert.ToDecimal(reader["Quantity"]);
                                        }

                                        if (reader["IdArticle"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                        }

                                        decomposed.RevisionItem.DownloadedQuantity = 0;


                                        otitem.ArticleDecomposedList.Add(decomposed);

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingWorkOrders_V2037() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OrderPreparation orderPreparation = orderPreparations.FirstOrDefault(x => x.IdOT == Convert.ToInt64(reader["IdOT"]));
                                if (orderPreparation != null)
                                {
                                    OtItem otitem = orderPreparation.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(reader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(reader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(reader["idarticle"]) && i.RevisionItem.WarehouseProduct.IdComponent == Convert.ToInt64(reader["idwarehouseproductcomponent"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (reader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(reader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingWorkOrders_V2037() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OrderPreparation orderPreparation = orderPreparations.FirstOrDefault(x => x.IdOT == Convert.ToInt64(reader["IdOT"]));
                                if (orderPreparation != null)
                                {
                                    OtItem otitem = orderPreparation.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(reader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(reader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(reader["idarticle"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (reader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(reader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingWorkOrders_V2037() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }




                    foreach (OrderPreparation itemOP in orderPreparations)
                    {
                        Int64 downloadedQty = 0;
                        decimal Qty = 0;
                        foreach (OtItem itemOtitem in itemOP.OtItems)
                        {
                            if (itemOtitem.ArticleDecomposedList.Count > 0)
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.DownloadedQuantity));
                                Qty = Qty + itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.Quantity);
                                // ot.Status = (Int16)((Math.Abs(ot.DownloadedQuantity) / ot.ActualQuantity) * 100);

                            }
                            else
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.RevisionItem.DownloadedQuantity);
                                Qty = Qty + itemOtitem.RevisionItem.Quantity;
                            }

                        }
                        if (Qty > 0)
                        {
                            itemOP.Progress = (Int16)((Math.Abs(downloadedQty) / Qty) * 100);
                        }
                    }
                }
            }

            orderPreparations = orderPreparations.Where(x => x.Progress < 100).ToList();
            orderPreparations.AddRange(orderPreparations.Where(x => x.Progress == 100 && x.OtDeliveryDateWeek == x.CurrentDateWeek).ToList());
            Log4NetLogger.Logger.Log("Executed GetPendingWorkOrders_V2037().", category: Category.Info, priority: Priority.Low);

            //Get userImage And UserName
            string getLogins = string.Join(",", userShortDetails.Select(i => i.Login).ToList());
            userShortDetails = GetUserShortDetail(getLogins, connectionString);

            foreach (OrderPreparation itemOP in orderPreparations)
            {
                if (itemOP.UserShortDetails != null)
                {
                    foreach (UserShortDetail itemOPUSD in itemOP.UserShortDetails)
                    {
                        if (userShortDetails.Any(usd => usd.Login == itemOPUSD.Login))
                        {
                            UserShortDetail usdItem = userShortDetails.Where(usd => usd.Login == itemOPUSD.Login).FirstOrDefault();
                            itemOPUSD.IdUserGender = usdItem.IdUserGender;
                            itemOPUSD.UserName = usdItem.UserName;
                            itemOPUSD.UserImageInBytes = GetUserProfileImageInBytes(itemOPUSD.Login, userProfileImageFilePath);
                        }
                    }
                }

            }

            return orderPreparations.OrderBy(op => op.OTDeliveryDate).ToList();
        }

        public List<WarehouseInventoryAudit> GetAllWarehouseInventoryAudits(Warehouses warehouse)
        {
            List<WarehouseInventoryAudit> warehouseInventoryAudits = new List<WarehouseInventoryAudit>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(warehouse.Company.ConnectPlantConstr))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetAllWarehouseInventoryAudits", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        WarehouseInventoryAudit warehouseInventoryAudit = new WarehouseInventoryAudit();

                        warehouseInventoryAudit.IdWarehouseInventoryAudit = Convert.ToInt64(reader["IdWarehouseInventoryAudit"]);

                        if (reader["IdWarehouse"] != DBNull.Value)
                            warehouseInventoryAudit.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                        if (reader["Name"] != DBNull.Value)
                            warehouseInventoryAudit.Name = Convert.ToString(reader["Name"]);

                        if (reader["StartDate"] != DBNull.Value)
                            warehouseInventoryAudit.StartDate = Convert.ToDateTime(reader["StartDate"]);

                        if (reader["EndDate"] != DBNull.Value)
                            warehouseInventoryAudit.EndDate = Convert.ToDateTime(reader["EndDate"]);

                        if (reader["IdCreator"] != DBNull.Value)
                            warehouseInventoryAudit.IdCreator = Convert.ToInt32(reader["IdCreator"]);

                        if (reader["CreationDate"] != DBNull.Value)
                            warehouseInventoryAudit.CreationDate = Convert.ToDateTime(reader["CreationDate"]);

                        if (reader["IdModifier"] != DBNull.Value)
                            warehouseInventoryAudit.IdModifier = Convert.ToInt32(reader["IdModifier"]);

                        if (reader["ModificationDate"] != DBNull.Value)
                            warehouseInventoryAudit.ModificationDate = Convert.ToDateTime(reader["ModificationDate"]);

                        if (reader["TotalItems"] != DBNull.Value)
                            warehouseInventoryAudit.TotalItems = Convert.ToInt64(reader["TotalItems"]);

                        if (reader["TotalLocations"] != DBNull.Value)
                            warehouseInventoryAudit.TotalLocations = Convert.ToInt64(reader["TotalLocations"]);

                        if (reader["OKItems"] != DBNull.Value)
                            warehouseInventoryAudit.OKItems = Convert.ToInt64(reader["OKItems"]);

                        if (reader["NOKItems"] != DBNull.Value)
                            warehouseInventoryAudit.NOKItems = Convert.ToInt64(reader["NOKItems"]);

                        if (warehouseInventoryAudit.TotalItems != 0)
                            warehouseInventoryAudit.SuccessRate = Convert.ToByte((((double)warehouseInventoryAudit.OKItems / (double)warehouseInventoryAudit.TotalItems) * 100));

                        if (reader["BalanceAmount"] != DBNull.Value)
                            warehouseInventoryAudit.BalanceAmount = Convert.ToInt64(reader["BalanceAmount"]);

                        warehouseInventoryAudits.Add(warehouseInventoryAudit);
                    }
                }
            }

            return warehouseInventoryAudits;
        }

        public WarehouseInventoryAudit AddWarehouseInventoryAudit(Warehouses warehouse, WarehouseInventoryAudit warehouseInventoryAudit)
        {
            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(warehouse.Company.ConnectPlantConstr))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_InsertWarehouseInventoryAudit", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouseInventoryAudit.IdWarehouse);
                        mySqlCommand.Parameters.AddWithValue("_Name", warehouseInventoryAudit.Name);
                        mySqlCommand.Parameters.AddWithValue("_StartDate", warehouseInventoryAudit.StartDate);
                        mySqlCommand.Parameters.AddWithValue("_EndDate", warehouseInventoryAudit.EndDate);
                        mySqlCommand.Parameters.AddWithValue("_IdCreator", warehouseInventoryAudit.IdCreator);

                        warehouseInventoryAudit.IdWarehouseInventoryAudit = Convert.ToInt64(mySqlCommand.ExecuteScalar());
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error AddWarehouseInventoryAudit(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return warehouseInventoryAudit;
        }

        public bool UpdateWarehouseInventoryAudit(Warehouses warehouse, WarehouseInventoryAudit warehouseInventoryAudit)
        {
            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(warehouse.Company.ConnectPlantConstr))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_UpdateWarehouseInventoryAudit", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdWarehouseInventoryAudit", warehouseInventoryAudit.IdWarehouseInventoryAudit);
                        mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouseInventoryAudit.IdWarehouse);
                        mySqlCommand.Parameters.AddWithValue("_Name", warehouseInventoryAudit.Name);
                        mySqlCommand.Parameters.AddWithValue("_StartDate", warehouseInventoryAudit.StartDate);
                        mySqlCommand.Parameters.AddWithValue("_EndDate", warehouseInventoryAudit.EndDate);
                        mySqlCommand.Parameters.AddWithValue("_IdModifier", warehouseInventoryAudit.IdModifier);

                        warehouseInventoryAudit.IdWarehouseInventoryAudit = Convert.ToInt64(mySqlCommand.ExecuteScalar());
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error AddWarehouseInventoryAudit(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return true;
        }

        public List<WarehouseInventoryAudit> GetOpenWarehouseInventoryAudits(Warehouses warehouse)
        {
            List<WarehouseInventoryAudit> warehouseInventoryAudits = new List<WarehouseInventoryAudit>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(warehouse.Company.ConnectPlantConstr))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetOpenWarehouseInventoryAudits", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        WarehouseInventoryAudit warehouseInventoryAudit = new WarehouseInventoryAudit();

                        warehouseInventoryAudit.IdWarehouseInventoryAudit = Convert.ToInt64(reader["IdWarehouseInventoryAudit"]);

                        if (reader["IdWarehouse"] != DBNull.Value)
                            warehouseInventoryAudit.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                        if (reader["Name"] != DBNull.Value)
                            warehouseInventoryAudit.Name = Convert.ToString(reader["Name"]);

                        if (reader["StartDate"] != DBNull.Value)
                            warehouseInventoryAudit.StartDate = Convert.ToDateTime(reader["StartDate"]);

                        if (reader["EndDate"] != DBNull.Value)
                            warehouseInventoryAudit.EndDate = Convert.ToDateTime(reader["EndDate"]);

                        if (reader["IdCreator"] != DBNull.Value)
                            warehouseInventoryAudit.IdCreator = Convert.ToInt32(reader["IdCreator"]);

                        if (reader["CreationDate"] != DBNull.Value)
                            warehouseInventoryAudit.CreationDate = Convert.ToDateTime(reader["CreationDate"]);

                        if (reader["IdModifier"] != DBNull.Value)
                            warehouseInventoryAudit.IdModifier = Convert.ToInt32(reader["IdModifier"]);

                        if (reader["ModificationDate"] != DBNull.Value)
                            warehouseInventoryAudit.ModificationDate = Convert.ToDateTime(reader["ModificationDate"]);

                        warehouseInventoryAudits.Add(warehouseInventoryAudit);
                    }
                }
            }

            return warehouseInventoryAudits;
        }

        public bool AddUpdateWarehouseInventoryAuditItems(Warehouses warehouse, List<WarehouseInventoryAuditItem> warehouseInventoryAuditItems)
        {
            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(warehouse.Company.ConnectPlantConstr))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("WMS_AddUpdateWarehouseInventoryAuditItem", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        foreach (WarehouseInventoryAuditItem item in warehouseInventoryAuditItems)
                        {
                            mySqlCommand.Parameters.Clear();

                            mySqlCommand.Parameters.AddWithValue("_IdWarehouseInventoryAudit", item.IdWarehouseInventoryAudit);
                            mySqlCommand.Parameters.AddWithValue("_IdWarehouseLocation", item.IdWarehouseLocation);
                            mySqlCommand.Parameters.AddWithValue("_IdArticle", item.IdArticle);
                            mySqlCommand.Parameters.AddWithValue("_IdWarehouseDeliveryNoteItem", item.IdWarehouseDeliveryNoteItem);
                            mySqlCommand.Parameters.AddWithValue("_ExpectedQuantity", item.ExpectedQuantity);
                            mySqlCommand.Parameters.AddWithValue("_CurrentQuantity", item.CurrentQuantity);
                            mySqlCommand.Parameters.AddWithValue("_IsOK", item.IsOK);
                            if (item.IdReason > 0)
                                mySqlCommand.Parameters.AddWithValue("_IdReason", item.IdReason);
                            else
                                mySqlCommand.Parameters.AddWithValue("_IdReason", null);
                            mySqlCommand.Parameters.AddWithValue("_IdReporter", item.IdReporter);
                            mySqlCommand.Parameters.AddWithValue("_IdApprover", item.IdApprover);
                            mySqlCommand.Parameters.AddWithValue("_IdCreator", item.IdCreator);
                            mySqlCommand.Parameters.AddWithValue("_IdModifier", item.IdModifier);

                            mySqlCommand.ExecuteNonQuery();
                        }

                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                    transactionScope.Dispose();
                }
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error AddWarehouseInventoryAuditItem(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);

                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return true;
        }



        public Article GetArticleDetailsByReference_V2038(string reference, string articleVisualAidsPath, Warehouses warehouse, DateTime? fromDate = null, DateTime? toDate = null)
        {
            Article article = new Article();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetArticleDetailsByReference_V2038", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_Reference", reference);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 8000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        try
                        {
                            if (reader["idArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(reader["idArticle"]);

                            if (reader["IdArticleCategory"] != DBNull.Value)
                            {
                                article.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory = new ArticleCategory();
                                article.ArticleCategory.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory.Name = Convert.ToString(reader["categoryName"]);
                                article.ArticleCategory.TaricCode = Convert.ToString(reader["TaricCode"]);
                            }

                            if (reader["ImagePath"] != DBNull.Value)
                            {
                                article.ImagePath = Convert.ToString(reader["ImagePath"]);

                                if (!string.IsNullOrEmpty(article.ImagePath))
                                    article.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, article);
                            }

                            if (reader["Reference"] != DBNull.Value)
                                article.Reference = reader["Reference"].ToString();

                            if (reader["IsOrientativeVisualAid"] != DBNull.Value)
                                article.IsOrientativeVisualAid = Convert.ToByte(reader["IsOrientativeVisualAid"]);

                            if (reader["IsGeneric"] != DBNull.Value)
                                article.IsGeneric = Convert.ToSByte(reader["IsGeneric"]);

                            if (reader["isObsolete"] != DBNull.Value)
                                article.IsObsolete = Convert.ToSByte(reader["isObsolete"]);

                            if (reader["isPublic"] != DBNull.Value)
                                article.IsPublic = Convert.ToSByte(reader["isPublic"]);

                            if (reader["publishOnWeb"] != DBNull.Value)
                                article.PublishOnWeb = Convert.ToSByte(reader["publishOnWeb"]);

                            if (reader["registerSerialNumber"] != DBNull.Value)
                                article.RegisterSerialNumber = Convert.ToByte(reader["registerSerialNumber"]);

                            if (reader["CreatedIn"] != DBNull.Value)
                                article.CreatedIn = Convert.ToDateTime(reader["CreatedIn"]);

                            if (reader["ModifiedIn"] != DBNull.Value)
                                article.ModifiedIn = Convert.ToDateTime(reader["ModifiedIn"]);

                            if (reader["description"] != DBNull.Value)
                                article.Description = Convert.ToString(reader["description"]);

                            if (reader["description_es"] != DBNull.Value)
                                article.Description_es = Convert.ToString(reader["description_es"]);

                            if (reader["description_fr"] != DBNull.Value)
                                article.Description_fr = Convert.ToString(reader["description_fr"]);

                            if (reader["description_pt"] != DBNull.Value)
                                article.Description_pt = Convert.ToString(reader["description_pt"]);

                            if (reader["description_ro"] != DBNull.Value)
                                article.Description_ro = Convert.ToString(reader["description_ro"]);

                            if (reader["description_ru"] != DBNull.Value)
                                article.Description_ru = Convert.ToString(reader["description_ru"]);

                            if (reader["description_zh"] != DBNull.Value)
                                article.Description_zh = Convert.ToString(reader["description_zh"]);

                            if (reader["idReplacementArticle"] != DBNull.Value)
                            {
                                article.IdReplacementArticle = Convert.ToInt32(reader["idReplacementArticle"]);
                                article.ReplacementArticle = Convert.ToString(reader["ReplacementArticle"]);
                            }

                            if (reader["isBatch"] != DBNull.Value)
                                article.IsBatch = Convert.ToByte(reader["isBatch"]);

                            if (reader["taric"] != DBNull.Value)
                                article.Taric = Convert.ToString(reader["taric"]);

                            if (reader["IdArticleType"] != DBNull.Value)
                            {
                                article.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                article.ArticlesType = new ArticleType();
                                article.ArticlesType.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                if (reader["ArticleTypeName"] != DBNull.Value)
                                    article.ArticlesType.Name = Convert.ToString(reader["ArticleTypeName"]);
                            }


                            if (reader["Weight"] != DBNull.Value)
                                article.Weight = Convert.ToDecimal(reader["Weight"]);

                            if (reader["Width"] != DBNull.Value)
                                article.Width = (float)(reader["Width"]);

                            if (reader["Length"] != DBNull.Value)
                                article.Length = (float)(reader["Length"]);

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)(reader["Height"]);


                            if (reader["idCountry"] != DBNull.Value)
                            {
                                article.IdCountry = Convert.ToInt32(reader["idCountry"]);

                                article.Country = new Country();
                                article.Country.IdCountry = Convert.ToByte(reader["idCountry"]);
                                article.Country.Name = Convert.ToString(reader["CountryName"]);
                            }

                            if (reader["articleSleepDate"] != DBNull.Value)
                            {
                                article.ArticleSleepDate = Convert.ToDateTime(reader["articleSleepDate"]);
                                article.ArticleSleepDays = (Int32)(DateTime.Now - article.ArticleSleepDate.Value.Date).TotalDays;
                            }

                            article.MyWarehouse = new MyWarehouse();

                            if (reader["minimumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MinimumStock = Convert.ToInt64(reader["minimumStock"]);
                            }

                            if (reader["stock"] != DBNull.Value)
                            {
                                article.MyWarehouse.CurrentStock = Convert.ToInt64(reader["stock"]);
                            }

                            if (reader["maximumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MaximumStock = Convert.ToInt64(reader["maximumStock"]);
                            }

                            if (reader["idWareHouse"] != DBNull.Value)
                            {
                                article.MyWarehouse.IdWarehouse = Convert.ToInt64(reader["idWareHouse"]);
                            }

                            if (reader["location"] != DBNull.Value)
                            {
                                article.MyWarehouse.Location = Convert.ToString(reader["location"]);
                            }

                            if (reader["MaterialType"] != DBNull.Value)
                                article.MaterialType = Convert.ToInt64(reader["MaterialType"].ToString());
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleDetailsByReference_V2036(). Reference- {0} IdArticle-{1} ErrorMessage- {2}", reference, article.IdArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
                article.LstArticleBySupplier = new List<ArticleBySupplier>();
                article.LstArticleBySupplier = GetArticleSupplierDetailsByIdArticle(connectionString, article.IdArticle);

                article.LstArticleDecomposition = new List<ArticleDecomposition>();
                article.LstArticleDecomposition = GetArticleDeCompostionByIdArticle(connectionString, article.IdArticle);

                article.LstRelatedArticle = new List<RelatedArticle>();
                article.LstRelatedArticle = GetRelatedArticleDetailsByIdArticle(connectionString, article.IdArticle, warehouse.IdWarehouse);

                article.LstArticleDocument = new List<ArticleDocument>();
                article.LstArticleDocument = GetArticleAttachmentByIdArticle(connectionString, article.IdArticle);

                if (article.RegisterSerialNumber == 1)
                {
                    article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                    article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockIncludingSerialNumber(connectionString, article.IdArticle, warehouse.IdWarehouse);
                    // article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle_V2034(connectionString, article.IdArticle, warehouse.IdWarehouse);
                }
                else
                {
                    article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                    article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle_V2034(connectionString, article.IdArticle, warehouse.IdWarehouse);
                }

                article.LstManufacturersByArticles = new List<ManufacturersByArticle>();
                article.LstManufacturersByArticles = GetManufacturers(connectionString, article.IdArticle);

                //if (fromDate != null && toDate != null)
                //{
                article.LstArticlesStock = new List<ArticlesStock>();
                article.LstArticlesStock = GetStockHistoryByIdArticle_V2033(connectionString, article.IdArticle, DateTime.Now, DateTime.Now, warehouse.IdWarehouse);
                // }


                article.LstArticleForecast = new List<ArticleForecast>();
                article.LstArticleForecast = GetArticleForecast_V2037(connectionString, article.IdArticle, warehouse.IdWarehouse);

            }

            return article;
        }

        /// <summary>
        /// [cpatil][02-12-2019][GEOS2-1862]Wrong calculation of the Sleeping days
        /// [cpatil][02-12-2019][GEOS2-1824]Display only articles with warehouse location in Warehouse section
        /// </summary>
        /// <param name="warehouse">Warehouse details</param>
        /// <returns></returns>
        public List<Article> GetWarehouseArticlesStockByWarehouse_V2038(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<Article> articles = new List<Article>();

            using (MySqlConnection connArticle = new MySqlConnection(connectionString))
            {
                connArticle.Open();

                MySqlCommand articlesCommand = new MySqlCommand("WMS_GetWarehouseArticlesStockByWarehouse_V2038", connArticle);
                articlesCommand.CommandType = CommandType.StoredProcedure;
                articlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                articlesCommand.CommandTimeout = 8000;
                using (MySqlDataReader articleReader = articlesCommand.ExecuteReader())
                {
                    if (articleReader.HasRows)
                    {
                        while (articleReader.Read())
                        {
                            try
                            {
                                Article article = new Article();

                                if (articleReader["IdArticle"] != DBNull.Value)
                                    article.IdArticle = Convert.ToInt32(articleReader["IdArticle"]);

                                if (articleReader["Reference"] != DBNull.Value)
                                    article.Reference = Convert.ToString(articleReader["Reference"]);

                                if (articleReader["ArticleImagePath"] != DBNull.Value)
                                    article.ImagePath = Convert.ToString(articleReader["ArticleImagePath"]);

                                if (articleReader["Description"] != DBNull.Value)
                                    article.Description = Convert.ToString(articleReader["Description"]);

                                if (articleReader["Length"] != DBNull.Value)
                                    article.Length = (float)articleReader["Length"];

                                if (articleReader["Width"] != DBNull.Value)
                                    article.Width = (float)articleReader["Width"];

                                if (articleReader["Height"] != DBNull.Value)
                                    article.Height = (float)articleReader["Height"];

                                if (articleReader["Weight"] != DBNull.Value)
                                    article.Weight = Convert.ToDecimal(articleReader["Weight"]);

                                if (articleReader["articleSleepDate"] != DBNull.Value)
                                {
                                    article.ArticleSleepDate = Convert.ToDateTime(articleReader["articleSleepDate"]);
                                    article.ArticleSleepDays = (Int32)(DateTime.Now - article.ArticleSleepDate.Value.Date).TotalDays;
                                }


                                if (articleReader["IdArticleCategory"] != DBNull.Value)
                                {
                                    article.IdArticleCategory = Convert.ToInt32(articleReader["IdArticleCategory"]);

                                    article.ArticleCategory = new ArticleCategory();
                                    article.ArticleCategory.IdArticleCategory = Convert.ToInt32(articleReader["IdArticleCategory"]);
                                    article.ArticleCategory.Name = articleReader["ArticleCategory"].ToString();
                                }

                                article.MyWarehouse = new MyWarehouse();

                                if (articleReader["Location"] != DBNull.Value)
                                    article.MyWarehouse.Location = Convert.ToString(articleReader["Location"]);

                                article.MyWarehouse.IdArticle = article.IdArticle;
                                article.MyWarehouse.CurrentStock = Convert.ToInt64(articleReader["Stock"]);
                                article.MyWarehouse.MinimumStock = Convert.ToInt64(articleReader["MinimumStock"]);
                                article.MyWarehouse.MaximumStock = Convert.ToInt64(articleReader["MaximumStock"]);

                                if (articleReader["IdWarehouse"] != DBNull.Value)
                                {
                                    article.MyWarehouse.IdWarehouse = Convert.ToInt64(articleReader["IdWarehouse"]);
                                    article.MyWarehouse.Warehouse = new Warehouses();
                                    article.MyWarehouse.Warehouse.IdWarehouse = article.MyWarehouse.IdWarehouse;
                                    article.MyWarehouse.Warehouse.Name = Convert.ToString(articleReader["WarehousName"]);
                                    article.MyWarehouse.Warehouse.IdSite = Convert.ToInt64(articleReader["IdSite"]);
                                }

                                articles.Add(article);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetWarehouseArticlesStockByWarehouse_V2038() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return articles;
        }


        public List<OtItem> GetPendingMaterialArticles_V2038(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OtItem> otItems = new List<OtItem>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetPendingMaterialArticles_V2038", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OtItem otItem = new OtItem();
                                if (reader["IdOTItem"] != DBNull.Value)
                                {
                                    otItem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                                    if (reader["IdOT"] != DBNull.Value)
                                        otItem.IdOT = Convert.ToInt64(reader["IdOT"]);

                                    otItem.RevisionItem = new RevisionItem();

                                    if (reader["ActualQty"] != DBNull.Value)
                                        otItem.RevisionItem.Quantity = Convert.ToInt64(reader["ActualQty"]);

                                    if (reader["DownloadedQty"] != DBNull.Value)
                                        otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(reader["DownloadedQty"]);

                                    if (reader["RemainingQty"] != DBNull.Value)
                                        otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(reader["RemainingQty"]);

                                    if (reader["IdArticle"] != DBNull.Value)
                                    {
                                        otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                        otItem.RevisionItem.WarehouseProduct.Article = new Article();
                                        otItem.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                        otItem.RevisionItem.WarehouseProduct.Article.Reference = Convert.ToString(reader["Reference"]);
                                        otItem.RevisionItem.WarehouseProduct.Article.Description = Convert.ToString(reader["Description"]);
                                    }

                                    otItem.Ot = new Ots();
                                    if (reader["MergeCode"] != DBNull.Value)
                                        otItem.Ot.Code = Convert.ToString(reader["MergeCode"]);

                                    if (reader["IdSite"] != DBNull.Value)
                                    {
                                        otItem.Ot.Quotation = new Quotation();

                                        otItem.Ot.Quotation.Site = new Company();
                                        otItem.Ot.Quotation.Site.Name = Convert.ToString(reader["SiteName"]);

                                        otItem.Ot.Quotation.Site.Country = new Country();
                                        otItem.Ot.Quotation.Site.Country.Name = Convert.ToString(reader["Country"]);

                                        otItem.Ot.Quotation.Site.Customer = new Customer();
                                        otItem.Ot.Quotation.Site.Customer.CustomerName = Convert.ToString(reader["CustomerGroup"]);

                                        otItem.Ot.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                    }

                                }

                                otItems.Add(otItem);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialArticles_V2038() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return otItems;
        }

        public List<PlanningSimulator> GetPlanningSimulator_V2038(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<PlanningSimulator> planningSimulatorList = new List<PlanningSimulator>();
            List<Int32> LstIdArticles = new List<Int32>();
            List<CurrentArticleStock> articleStockLst = new List<CurrentArticleStock>();
            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetPlanningSimulator_V2038", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.CommandTimeout = 8000;
                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    // for parent otitems and decomposed articles
                    while (reader.Read())
                    {
                        try
                        {
                            PlanningSimulator planningSimulator = new PlanningSimulator();

                            if (reader["IdArticle"] != DBNull.Value)
                                planningSimulator.IdArticle = Convert.ToInt32(reader["IdArticle"]);


                            if (reader["Reference"] != DBNull.Value)
                                planningSimulator.Reference = Convert.ToString(reader["Reference"]);

                            if (reader["IdOT"] != DBNull.Value)
                                planningSimulator.IdOT = Convert.ToInt64(reader["IdOT"]);

                            if (reader["OTCode"] != DBNull.Value)
                                planningSimulator.OTCode = Convert.ToString(reader["OTCode"]);

                            if (reader["Customer"] != DBNull.Value)
                                planningSimulator.Customer = Convert.ToString(reader["Customer"]);

                            if (reader["OTWeek"] != DBNull.Value)
                                planningSimulator.Week = Convert.ToString(reader["OTWeek"]);

                            if (reader["DeliveryDate"] != DBNull.Value)
                                planningSimulator.OTDeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);

                            if (reader["DownloadedQty"] != DBNull.Value)
                                planningSimulator.DownloadedQty = Convert.ToInt64(reader["DownloadedQty"]);

                            if (reader["ActualQty"] != DBNull.Value)
                                planningSimulator.ActualQty = Convert.ToInt64(reader["ActualQty"]);

                            if (reader["RemainingQty"] != DBNull.Value)
                                planningSimulator.OTRemainingQty = Convert.ToInt64(reader["RemainingQty"]);

                            planningSimulator.IsOut = true;

                            planningSimulatorList.Add(planningSimulator);

                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPlanningSimulator ErrorMessage- ", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                    // for order
                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                PlanningSimulator planningSimulator = new PlanningSimulator();

                                if (reader["IdArticle"] != DBNull.Value)
                                    planningSimulator.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                if (reader["Reference"] != DBNull.Value)
                                    planningSimulator.Reference = Convert.ToString(reader["Reference"]);

                                if (reader["IdWarehousePurchaseOrder"] != DBNull.Value)
                                    planningSimulator.IdWarehousePurchaseOrder = Convert.ToInt64(reader["IdWarehousePurchaseOrder"]);

                                if (reader["POCode"] != DBNull.Value)
                                    planningSimulator.POCode = Convert.ToString(reader["POCode"]);

                                if (reader["Supplier"] != DBNull.Value)
                                    planningSimulator.Supplier = Convert.ToString(reader["Supplier"]);

                                if (reader["POWeek"] != DBNull.Value)
                                    planningSimulator.Week = Convert.ToString(reader["POWeek"]);

                                if (reader["DeliveryDate"] != DBNull.Value)
                                    planningSimulator.PODeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);

                                if (reader["OrderQty"] != DBNull.Value)
                                    planningSimulator.OrderQty = Convert.ToInt64(reader["OrderQty"]);

                                if (reader["ReceivedQuantity"] != DBNull.Value)
                                    planningSimulator.ReceivedQuantity = Convert.ToInt64(reader["ReceivedQuantity"]);

                                if (reader["RemainingQty"] != DBNull.Value)
                                    planningSimulator.PORemainingQty = Convert.ToInt64(reader["RemainingQty"]);


                                planningSimulator.IsOut = false;

                                planningSimulatorList.Add(planningSimulator);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPlanningSimulator ErrorMessage- ", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                    // for articlestock IdWarehouseLocation is not null
                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                if (reader["IdArticle"] != DBNull.Value)
                                {
                                    CurrentArticleStock currentArticleStock = new CurrentArticleStock();

                                    currentArticleStock.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                    currentArticleStock.ArticleStock = Convert.ToInt64(reader["ArticlesStockQty"]);


                                    articleStockLst.Add(currentArticleStock);
                                }

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPlanningSimulator ErrorMessage- ", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    // for articlestock IdWarehouseLocation is null
                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                if (reader["IdArticle"] != DBNull.Value)
                                {
                                    if (articleStockLst.Any(i => i.IdArticle == Convert.ToInt32(reader["IdArticle"])))
                                    {
                                        CurrentArticleStock currentArticleStock = articleStockLst.Where(i => i.IdArticle == Convert.ToInt32(reader["IdArticle"])).FirstOrDefault();
                                        currentArticleStock.ArticleStock = currentArticleStock.ArticleStock + Convert.ToInt64(reader["ArticlesStockQty"]);

                                    }
                                    else
                                    {
                                        CurrentArticleStock currentArticleStock = new CurrentArticleStock();

                                        currentArticleStock.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                        currentArticleStock.ArticleStock = Convert.ToInt64(reader["ArticlesStockQty"]);


                                        articleStockLst.Add(currentArticleStock);
                                    }

                                }

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPlanningSimulator ErrorMessage- ", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                }
            }

            Int64 expectedStock = 0;
            planningSimulatorList = planningSimulatorList.OrderBy(ob => ob.IdArticle).ThenBy(tb => (tb.OTDeliveryDate == null) ? tb.PODeliveryDate : tb.OTDeliveryDate).ThenBy(tb => (tb.PODeliveryDate == null) ? tb.OTDeliveryDate : tb.PODeliveryDate).ToList();
            Int64 rowPointer = 0;
            foreach (PlanningSimulator itemPlanningSimulator in planningSimulatorList)
            {
                rowPointer = rowPointer + 1;
                itemPlanningSimulator.RowPointer = rowPointer;
                if (LstIdArticles.Any(i => i == itemPlanningSimulator.IdArticle))
                {
                    if (itemPlanningSimulator.IsOut)
                    {
                        if (planningSimulatorList.Any(i => i.IdArticle == itemPlanningSimulator.IdArticle && i.RowPointer == itemPlanningSimulator.RowPointer - 1 && i.IsOut == true))
                        {
                            PlanningSimulator planningSimulator = planningSimulatorList.Where(i => i.IdArticle == itemPlanningSimulator.IdArticle && i.RowPointer == itemPlanningSimulator.RowPointer - 1 && i.IsOut == true).FirstOrDefault();
                            planningSimulator.NextOtItemPickingStock = itemPlanningSimulator.OTRemainingQty.Value;
                        }

                        itemPlanningSimulator.CurrentArticleStock = expectedStock;
                        expectedStock = expectedStock - itemPlanningSimulator.OTRemainingQty.Value;
                    }
                    else
                    {
                        itemPlanningSimulator.CurrentArticleStock = expectedStock;
                        expectedStock = expectedStock + itemPlanningSimulator.PORemainingQty.Value;
                    }
                }
                else
                {
                    LstIdArticles.Add(itemPlanningSimulator.IdArticle);
                    if (articleStockLst.Any(i => i.IdArticle == itemPlanningSimulator.IdArticle))
                    {
                        expectedStock = articleStockLst.Where(i => i.IdArticle == itemPlanningSimulator.IdArticle).FirstOrDefault().ArticleStock;
                    }
                    else
                    {
                        expectedStock = 0;
                    }

                    if (itemPlanningSimulator.IsOut)
                    {
                        if (planningSimulatorList.Any(i => i.IdArticle == itemPlanningSimulator.IdArticle && i.RowPointer == itemPlanningSimulator.RowPointer - 1 && i.IsOut == true))
                        {
                            PlanningSimulator planningSimulator = planningSimulatorList.Where(i => i.IdArticle == itemPlanningSimulator.IdArticle && i.RowPointer == itemPlanningSimulator.RowPointer - 1 && i.IsOut == true).FirstOrDefault();
                            planningSimulator.NextOtItemPickingStock = itemPlanningSimulator.OTRemainingQty.Value;
                        }
                        itemPlanningSimulator.CurrentArticleStock = expectedStock;
                        expectedStock = expectedStock - itemPlanningSimulator.OTRemainingQty.Value;
                    }
                    else
                    {
                        itemPlanningSimulator.CurrentArticleStock = expectedStock;
                        expectedStock = expectedStock + itemPlanningSimulator.PORemainingQty.Value;
                    }

                }
                itemPlanningSimulator.ExpectedStock = expectedStock;
            }

            return planningSimulatorList;

        }


        public Ots GetWorkOrderByIdOt_V2038(Int64 idOt, Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            Ots ot = null;

            using (MySqlConnection connOT = new MySqlConnection(connectionString))
            {
                connOT.Open();

                MySqlCommand otCommand = new MySqlCommand("warehouse_GetMaterialOtInformationByIdOt", connOT);
                otCommand.CommandType = CommandType.StoredProcedure;
                otCommand.Parameters.AddWithValue("_IdOt", idOt);
                otCommand.CommandTimeout = 8000;
                using (MySqlDataReader otReader = otCommand.ExecuteReader())
                {
                    if (otReader.Read())
                    {
                        try
                        {
                            ot = new Ots();
                            ot.IdOT = idOt;

                            if (otReader["OtCode"] != DBNull.Value)
                                ot.Code = Convert.ToString(otReader["OtCode"]);

                            ot.NumOT = Convert.ToByte(otReader["NumOT"]);

                            if (otReader["Comments"] != DBNull.Value)
                                ot.Comments = Convert.ToString(otReader["Comments"]);

                            if (otReader["CreatedBy"] != DBNull.Value)
                            {
                                ot.CreatedBy = Convert.ToInt32(otReader["CreatedBy"]);

                                ot.CreatedByPerson = new People();
                                ot.CreatedByPerson.IdPerson = ot.CreatedBy;
                                ot.CreatedByPerson.Name = Convert.ToString(otReader["CreatedByName"]);
                                ot.CreatedByPerson.Surname = Convert.ToString(otReader["CreatedBySurname"]);
                            }

                            ot.ReviewedBy = Convert.ToInt32(otReader["ReviewedBy"]);

                            //CreatedBy
                            if (otReader["CreatedBy"] != DBNull.Value)
                            {
                                ot.CreatedBy = Convert.ToInt32(otReader["CreatedBy"]);

                                ot.CreatedByPerson = new People();
                                ot.CreatedByPerson.IdPerson = ot.CreatedBy;
                                ot.CreatedByPerson.Name = Convert.ToString(otReader["CreatedByName"]);
                                ot.CreatedByPerson.Surname = Convert.ToString(otReader["CreatedBySurname"]);
                            }

                            if (otReader["CreationDate"] != DBNull.Value)
                                ot.CreationDate = Convert.ToDateTime(otReader["CreationDate"]);

                            //ModifiedBy
                            if (otReader["ModifiedBy"] != DBNull.Value)
                            {
                                ot.ModifiedBy = Convert.ToInt32(otReader["ModifiedBy"]);

                                ot.ModifiedByPerson = new People();
                                ot.ModifiedByPerson.IdPerson = ot.ModifiedBy;
                                ot.ModifiedByPerson.Name = Convert.ToString(otReader["ModifiedByName"]);
                                ot.ModifiedByPerson.Surname = Convert.ToString(otReader["ModifiedBySurname"]);
                            }

                            if (otReader["ModifiedIn"] != DBNull.Value)
                                ot.ModifiedIn = Convert.ToDateTime(otReader["ModifiedIn"]);

                            if (otReader["DeliveryDate"] != DBNull.Value)
                                ot.DeliveryDate = Convert.ToDateTime(otReader["DeliveryDate"]);

                            if (otReader["WareHouseLockSession"] != DBNull.Value)
                                ot.WareHouseLockSession = Convert.ToString(otReader["WareHouseLockSession"]);

                            if (otReader["AttachedFiles"] != DBNull.Value)
                                ot.AttachedFiles = Convert.ToString(otReader["AttachedFiles"]);

                            if (otReader["IdShippingAddress"] != DBNull.Value)
                                ot.IdShippingAddress = Convert.ToInt64(otReader["IdShippingAddress"]);

                            ot.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                            ot.Quotation = new Quotation();
                            ot.Quotation.Code = Convert.ToString(otReader["QuotationCode"]);

                            if (otReader["Year"] != DBNull.Value)
                                ot.Quotation.Year = Convert.ToInt32(otReader["Year"]);

                            if (otReader["Description"] != DBNull.Value)
                                ot.Quotation.Description = Convert.ToString(otReader["Description"]);

                            if (otReader["ProjectName"] != DBNull.Value)
                                ot.Quotation.ProjectName = Convert.ToString(otReader["ProjectName"]);


                            if (otReader["ProjectName"] != DBNull.Value)
                                ot.Quotation.ProjectName = Convert.ToString(otReader["ProjectName"]);

                            //Customer
                            if (otReader["IdSite"] != DBNull.Value)
                            {
                                ot.Quotation.Site = new Company();
                                ot.Quotation.Site.IdCompany = Convert.ToInt32(otReader["IdSite"]);
                                ot.Quotation.Site.SiteNameWithoutCountry = Convert.ToString(otReader["SiteName"]);

                                if (otReader["ShortName"] != DBNull.Value && !string.IsNullOrEmpty(Convert.ToString(otReader["ShortName"])))
                                {
                                    ot.Quotation.Site.Name = Convert.ToString(otReader["ShortName"]);
                                }
                                else
                                {
                                    ot.Quotation.Site.Name = Convert.ToString(otReader["Customer"]);
                                }

                                if (otReader["idCountry"] != DBNull.Value)
                                {
                                    ot.Quotation.Site.IdCountry = Convert.ToByte(otReader["idCountry"]);
                                    ot.Quotation.Site.Country = new Country();
                                    ot.Quotation.Site.Country.IdCountry = Convert.ToByte(otReader["idCountry"]);
                                    ot.Quotation.Site.Country.Name = otReader["CountryName"].ToString();
                                    ot.Quotation.Site.Country.Iso = otReader["iso"].ToString();

                                    if (otReader["EuroZone"] != DBNull.Value)
                                    {
                                        ot.Quotation.Site.Country.EuroZone = Convert.ToSByte(otReader["EuroZone"]);
                                    }

                                    if (otReader["IdCountryGroup"] != DBNull.Value)
                                    {
                                        ot.Quotation.Site.CountryGroup = new CountryGroup();
                                        ot.Quotation.Site.CountryGroup.IdCountryGroup = Convert.ToInt64(otReader["IdCountryGroup"]);

                                        if (otReader["CountryGroup"] != DBNull.Value)
                                            ot.Quotation.Site.CountryGroup.Name = Convert.ToString(otReader["CountryGroup"]);

                                        if (otReader["IsFreeTrade"] != DBNull.Value)
                                            ot.Quotation.Site.CountryGroup.IsFreeTrade = Convert.ToByte(otReader["IsFreeTrade"]);
                                    }
                                }

                                ot.Quotation.Site.Customer = new Customer();
                                ot.Quotation.Site.Customer.IdCustomer = Convert.ToInt32(otReader["IdCustomer"]);
                                ot.Quotation.Site.Customer.CustomerName = Convert.ToString(otReader["CustomerName"]);
                            }

                            //Detections Template
                            if (otReader["IdTemplate"] != DBNull.Value)
                            {
                                ot.Quotation.Template = new Template();
                                ot.Quotation.Template.IdTemplate = Convert.ToByte(otReader["IdTemplate"]);
                                ot.Quotation.Template.Name = Convert.ToString(otReader["Template"]);
                                ot.Quotation.Template.Type = Convert.ToInt64(otReader["IdTemplateType"]);
                            }

                            if (otReader["IdOffer"] != DBNull.Value)
                            {
                                ot.Quotation.IdOffer = Convert.ToInt32(otReader["IdOffer"]);

                                ot.Quotation.Offer = new Offer();
                                //ot.Quotation.Offer.Code = Convert.ToString(otReader["OfferCode"]);
                                ot.Quotation.Offer.Description = Convert.ToString(otReader["Description"]);

                                if (otReader["IdCarriageMethod"] != DBNull.Value)
                                {
                                    ot.Quotation.Offer.IdCarriageMethod = Convert.ToByte(otReader["IdCarriageMethod"]);
                                    LookupValue carriage = new LookupValue();
                                    carriage.IdLookupValue = Convert.ToInt32(ot.Quotation.Offer.IdCarriageMethod);
                                    carriage.Value = Convert.ToString(otReader["CarriageValue"]);
                                    carriage.IdImage = Convert.ToInt64(otReader["CarriageImage"]);

                                    ot.Quotation.Offer.CarriageMethod = carriage;
                                }

                                if (otReader["PODate"] != DBNull.Value)
                                    ot.Quotation.Offer.POReceivedInDate = Convert.ToDateTime(otReader["PODate"]);

                                //if (otReader["IdOffer"] != DBNull.Value)
                                //{
                                //    ot.Quotation.Offer.OfferType = new OfferType();
                                //    ot.Quotation.Offer.OfferType.IdOfferType = Convert.ToByte(otReader["IdOfferType"]);
                                //    ot.Quotation.Offer.OfferType.Name = Convert.ToString(otReader["OfferType"]);
                                //}

                                if (otReader["ProducerIdCountryGroup"] != DBNull.Value)
                                {
                                    ot.ProducerIdCountryGroup = Convert.ToInt64(otReader["ProducerIdCountryGroup"]);
                                    ot.CountryGroup = new CountryGroup();
                                    ot.CountryGroup.IdCountryGroup = Convert.ToInt64(otReader["ProducerIdCountryGroup"]);
                                    ot.CountryGroup.Name = Convert.ToString(otReader["ProducerCountryGroup"]);
                                    ot.CountryGroup.HtmlColor = Convert.ToString(otReader["ProducerCountryGroupColor"]);
                                }

                            }
                            ot.OtItems = GetOtItemsByIdOt_V2038(connectionString, idOt, warehouse.IdWarehouse);
                            ot.ArticleStocks = GetStockHistoryByIdOT(connectionString, idOt, warehouse.IdWarehouse);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetWorkOrderByIdOt_V2035(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2} ", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetWorkOrderByIdOt_V2038().", category: Category.Info, priority: Priority.Low);
            return ot;
        }


        public List<OtItem> GetOtItemsByIdOt_V2038(string connectionString, Int64 idOt, Int64 idWarehouse)
        {
            List<OtItem> otItems = new List<OtItem>();

            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetOtItemsByIdOt", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOt", idOt);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                otItemCommand.CommandTimeout = 8000;
                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    int keyId = 0;
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OtItem otItem = new OtItem();

                            otItem.KeyId = keyId;
                            otItem.ParentId = -1;

                            otItem.IdOT = idOt;

                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);
                            otItem.IsBatch = Convert.ToByte(otItemReader["IsBatch"]);

                            if (otItemReader["AttachedFiles"] != DBNull.Value)
                                otItem.AttachedFiles = Convert.ToString(otItemReader["AttachedFiles"]);

                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);
                                otItem.RevisionItem.Quantity = Convert.ToDecimal(otItemReader["Quantity"]);
                                otItem.RevisionItem.UnitPrice = Convert.ToDecimal(otItemReader["UnitPrice"]);

                                if (otItemReader["CustomerCommentOT"] != DBNull.Value)
                                    otItem.RevisionItem.InternalComment = Convert.ToString(otItemReader["CustomerCommentOT"]);

                                if (otItemReader["CustomerCommentRevision"] != DBNull.Value)
                                    otItem.RevisionItem.CustomerComment = Convert.ToString(otItemReader["CustomerCommentRevision"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);

                                if (otItemReader["WpDescription"] != DBNull.Value)
                                    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["ArticleDescription"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["ArticleDescription"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    if (otItemReader["Weight"] != DBNull.Value)
                                        article.Weight = Convert.ToDecimal(otItemReader["Weight"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);

                                    otItem.Status = new ItemOTStatusType();
                                    otItem.Status.IdItemOtStatus = otItem.IdItemOtStatus;
                                    otItem.Status.Name = Convert.ToString(otItemReader["Status"]);
                                }

                                if (otItemReader["AssignedTo"] != DBNull.Value)
                                {
                                    otItem.AssignedTo = Convert.ToInt32(otItemReader["AssignedTo"]);

                                    otItem.AssignedToUser = new People();
                                    otItem.AssignedToUser.Name = Convert.ToString(otItemReader["AssignedName"]);
                                    otItem.AssignedToUser.Surname = Convert.ToString(otItemReader["AssignedSurname"]);
                                }

                                if (otItemReader["DownloadedQty"] != DBNull.Value)
                                    otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otItemReader["DownloadedQty"]);

                                if (otItemReader["RemainingQty"] != DBNull.Value)
                                    otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otItemReader["RemainingQty"]);

                                if ((Int64)otItem.RevisionItem.Quantity > 0)
                                {
                                    //otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;
                                    otItem.RevisionItem.Status = (Int64)((Math.Abs((double)otItem.RevisionItem.DownloadedQuantity) / (double)otItem.RevisionItem.Quantity) * 100);
                                }
                            }



                            List<OtItem> decomposedOtItems = GetArticlesForDecomposition_V2038(connectionString, idOt, idWarehouse, otItem, ref keyId);

                            if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                            {
                                if (otItem.RevisionItem.WarehouseProduct.Article.IdArticleType != 2)
                                {
                                    otItem.RevisionItem.Status = (Int64)((Math.Abs((double)decomposedOtItems.Sum(y => y.RevisionItem.DownloadedQuantity)) / (double)decomposedOtItems.Sum(y => y.RevisionItem.Quantity)) * 100);
                                }
                                otItems.Add(otItem);
                                otItems.AddRange(decomposedOtItems);
                            }
                            else
                            {
                                otItems.Add(otItem);
                            }



                            keyId++;

                            //i = otItem.KeyId + 1;
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetOtItemsByIdOt(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                    if (otItemReader.NextResult())
                    {
                        while (otItemReader.Read())
                        {
                            try
                            {
                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    foreach (var itemotItem in otItems.Where(ot => ot.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(otItemReader["IdArticle"])))
                                    {
                                        if (otItemReader["ArticleStock"] != DBNull.Value)
                                            itemotItem.ArticleStock = Convert.ToInt64(otItemReader["ArticleStock"]);

                                        if (otItemReader["ArticleMinimumStock"] != DBNull.Value)
                                            itemotItem.ArticleMinimumStock = Convert.ToInt64(otItemReader["ArticleMinimumStock"]);
                                    }
                                }

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetOtItemsByIdOt_V2038(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            //Log4NetLogger.Logger.Log("Executed GetOtItemsByIdOt().", category: Category.Info, priority: Priority.Low);
            return otItems;
        }


        public List<OtItem> GetArticlesForDecomposition_V2038(string connectionString, Int64 idOt, Int64 idWarehouse, OtItem parentOtItem, ref int keyId)
        {
            List<OtItem> otItems = new List<OtItem>();

            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("WMS_GetArticlesForDecomposition_V2038", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOTitem", parentOtItem.IdOTItem);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                otItemCommand.CommandTimeout = 8000;

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            keyId++;


                            OtItem otItem = new OtItem();
                            otItem.IdOT = idOt;
                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);

                            if (otItemReader["IdItemOtStatus"] != DBNull.Value)
                                otItem.IdItemOtStatus = Convert.ToByte(otItemReader["IdItemOtStatus"]);


                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);



                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);
                                                          
                                if (otItemReader["IdComponent"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otItemReader["IdComponent"]);
                                }

                              
                                otItem.KeyId = keyId;

                                if (otItemReader["parentArticleType"] != DBNull.Value)
                                {
                                    otItem.ParentArticleType = Convert.ToInt64(otItemReader["parentArticleType"]);
                                }

                                if (otItemReader["idParent"] != DBNull.Value)
                                {
                                    otItem.ParentId = Convert.ToInt32(otItemReader["idParent"]);
                                }

                                if (otItem.ParentId == -1)
                                {
                                    otItem.ParentId = parentOtItem.KeyId;
                                    otItem.RevisionItem.Quantity = parentOtItem.RevisionItem.Quantity * Convert.ToDecimal(otItemReader["Quantity"]);
                                }
                                else
                                {


                                    decimal qty = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).RevisionItem.Quantity;
                                    otItem.RevisionItem.Quantity = qty * Convert.ToDecimal(otItemReader["Quantity"]);
                                    otItem.ParentId = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).KeyId;
                                }



                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["Description"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["Description"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Weight"] != DBNull.Value)
                                        article.Weight = Convert.ToDecimal(otItemReader["Weight"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);

                                }

                                if (parentOtItem.RevisionItem.WarehouseProduct.Article.IdArticleType != 2 && otItem.ParentArticleType!=2)
                                {
                                    int downloaded = GetOtItemDownloadedQuantity(connectionString, otItem.RevisionItem.WarehouseProduct.Article.IdArticle, otItem.IdOTItem, otItem.RevisionItem.WarehouseProduct.IdComponent, idWarehouse);


                                    otItem.RevisionItem.DownloadedQuantity = downloaded;

                                    otItem.RevisionItem.RemainingQuantity = ((Int64)otItem.RevisionItem.Quantity - downloaded);



                                    if ((Int64)otItem.RevisionItem.Quantity > 0)
                                        otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;
                                }
                                else
                                {
                                    otItem.RevisionItem.RemainingQuantity = (Int64)otItem.RevisionItem.Quantity;
                                }
                            }


                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticlesForDecomposition_V2038(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                    if (otItemReader.NextResult())
                    {
                        while (otItemReader.Read())
                        {
                            try
                            {
                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    foreach (var itemotItem in otItems.Where(ot => ot.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(otItemReader["IdArticle"])))
                                    {
                                        if (otItemReader["ArticleStock"] != DBNull.Value)
                                            itemotItem.ArticleStock = Convert.ToInt64(otItemReader["ArticleStock"]);

                                        if (otItemReader["ArticleMinimumStock"] != DBNull.Value)
                                            itemotItem.ArticleMinimumStock = Convert.ToInt64(otItemReader["ArticleMinimumStock"]);
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetArticlesForDecomposition_V2038(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, idWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                }
            }

            return otItems;
        }

        public List<string> GetReadyForShippingOTItems(Warehouses warehouse, string idOts,string emailTemplatePath,string mailServerName,string mailServerPort)
        {
            List<string> logs = new List<string>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OTShippingDetail> otShippingDetails = new List<OTShippingDetail>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("WMS_GetReadyForShippingOTItems", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOts", idOts);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OTShippingDetail otShippingDetail = new OTShippingDetail();

                            if (otItemReader["IdOT"] != DBNull.Value)
                                otShippingDetail.IdOT = Convert.ToInt64(otItemReader["IdOT"]);
                            if (otItemReader["OtCode"] != DBNull.Value)
                                otShippingDetail.OTCode = Convert.ToString(otItemReader["OtCode"]);
                            if (otItemReader["PO"] != DBNull.Value)
                                otShippingDetail.POCode = Convert.ToString(otItemReader["PO"]);
                            if (otItemReader["OfferAssignee"] != DBNull.Value)
                                otShippingDetail.OfferAssigneeName = Convert.ToString(otItemReader["OfferAssignee"]);
                            if (otItemReader["Email"] != DBNull.Value)
                                otShippingDetail.OfferAssigneeEmail = Convert.ToString(otItemReader["Email"]);
                            if (otItemReader["iso"] != DBNull.Value)
                                otShippingDetail.CustomerCountryCode = Convert.ToString(otItemReader["iso"]);
                            if (otItemReader["IdSite"] != DBNull.Value)
                                otShippingDetail.IdSite = Convert.ToInt32(otItemReader["IdSite"]);
                            if (otItemReader["IdDetectionsTemplate"] != DBNull.Value)
                                otShippingDetail.IdTemplate = Convert.ToByte(otItemReader["IdDetectionsTemplate"]);
                            if (otItemReader["ShortName"] != DBNull.Value)
                                otShippingDetail.SiteShortName = Convert.ToString(otItemReader["ShortName"]);
                            if (otItemReader["template"] != DBNull.Value)
                                otShippingDetail.Template = Convert.ToString(otItemReader["template"]);
                            if (otItemReader["EmailTo"] != DBNull.Value)
                                otShippingDetail.EmailTo = Convert.ToString(otItemReader["EmailTo"]);
                            if (otItemReader["EmailCC"] != DBNull.Value)
                                otShippingDetail.EmailCC = Convert.ToString(otItemReader["EmailCC"]);
                            if (otItemReader["currentWeek"] != DBNull.Value)
                                otShippingDetail.CurrentWeek = Convert.ToString(otItemReader["currentWeek"]);

                            otShippingDetail.MailSubject = string.Format("[WMS] Ready for Expedition {0} {1}", otShippingDetail.SiteShortName,otShippingDetail.CurrentWeek);

                            if (File.Exists(string.Format("{0}{1}ReadyForShippingMailFormat_{2}.html", emailTemplatePath,@"\", otShippingDetail.CustomerCountryCode)))
                            {
                                otShippingDetail.HTMLFileName = string.Format("ReadyForShippingMailFormat_{0}.html", otShippingDetail.CustomerCountryCode);
                            }
                            else if (File.Exists(string.Format("{0}{1}ReadyForShippingMailFormat.html", emailTemplatePath, @"\")))
                            {
                                otShippingDetail.HTMLFileName = "ReadyForShippingMailFormat.html";
                            }

                            otShippingDetails.Add(otShippingDetail);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetReadyForShippingOTItems(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                    if (otItemReader.NextResult())
                    {
                        while (otItemReader.Read())
                        {
                            try
                            {
                                if (otItemReader["IdOT"] != DBNull.Value)
                                {
                                    if(otShippingDetails.Any(osd=>osd.IdOT== Convert.ToInt64(otItemReader["IdOT"])))
                                    {
                                        OTShippingDetail otShippingDetail = otShippingDetails.Where(osd => osd.IdOT == Convert.ToInt64(otItemReader["IdOT"])).FirstOrDefault();

                                        if(otShippingDetail.DeliveringItems == null)
                                        {
                                            otShippingDetail.DeliveringItems = new List<OtItemShippingDetail>();
                                        }
                                        
                                        OtItemShippingDetail otItemShippingDetail = new OtItemShippingDetail();
                                      
                                            otItemShippingDetail.POCode = otShippingDetail.POCode ;
                                            otItemShippingDetail.OTCode = otShippingDetail.OTCode;

                                        if (otItemReader["Item"] != DBNull.Value)
                                            otItemShippingDetail.Item = Convert.ToString(otItemReader["Item"]);
                                        if (otItemReader["Reference"] != DBNull.Value)
                                            otItemShippingDetail.Reference = Convert.ToString(otItemReader["Reference"]);
                                        if (otItemReader["Description"] != DBNull.Value)
                                            otItemShippingDetail.Description = Convert.ToString(otItemReader["Description"]);
                                        if (otItemReader["Quantity"] != DBNull.Value)
                                            otItemShippingDetail.Quantity = Convert.ToInt64(otItemReader["Quantity"]);

                                        otShippingDetail.DeliveringItems.Add(otItemShippingDetail);
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetReadyForShippingOTItems(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                    if (otItemReader.NextResult())
                    {
                        while (otItemReader.Read())
                        {
                            try
                            {
                                if (otItemReader["IdOT"] != DBNull.Value)
                                {
                                    if (otShippingDetails.Any(osd => osd.IdOT == Convert.ToInt64(otItemReader["IdOT"])))
                                    {
                                        OTShippingDetail otShippingDetail = otShippingDetails.Where(osd => osd.IdOT == Convert.ToInt64(otItemReader["IdOT"])).FirstOrDefault();

                                        if (otShippingDetail.NotDeliveringItems == null)
                                        {
                                            otShippingDetail.NotDeliveringItems = new List<OtItemShippingDetail>();
                                        }

                                        OtItemShippingDetail otItemShippingDetail = new OtItemShippingDetail();

                                        otItemShippingDetail.POCode = otShippingDetail.POCode;
                                        otItemShippingDetail.OTCode = otShippingDetail.OTCode;
                                       
                                        if (otItemReader["Item"] != DBNull.Value)
                                            otItemShippingDetail.Item = Convert.ToString(otItemReader["Item"]);
                                        if (otItemReader["Reference"] != DBNull.Value)
                                            otItemShippingDetail.Reference = Convert.ToString(otItemReader["Reference"]);
                                        if (otItemReader["Description"] != DBNull.Value)
                                            otItemShippingDetail.Description = Convert.ToString(otItemReader["Description"]);
                                      
                                        if (otItemReader["Quantity"] != DBNull.Value)
                                            otItemShippingDetail.Quantity = Convert.ToInt64(otItemReader["Quantity"]);
                                        if (otItemReader["observations"] != DBNull.Value)
                                            otItemShippingDetail.Observation = Convert.ToString(otItemReader["observations"]);
                                        if (otItemReader["ExpectedSupplierDeliveryDate"] != DBNull.Value)
                                        {
                                            if (Convert.ToString(otItemReader["ExpectedSupplierDeliveryDate"]).ToUpper() != "TBD")
                                            {
                                               
                                                DateTime dtExpectedSupplierDelivery = Convert.ToDateTime(Convert.ToDateTime(otItemReader["ExpectedSupplierDeliveryDate"]).ToString("dd / MM / yyyy"));
                                                otItemShippingDetail.ExpectedSupplierDelivery = dtExpectedSupplierDelivery.ToShortDateString();
                                            }
                                            else
                                            {
                                                otItemShippingDetail.ExpectedSupplierDelivery = Convert.ToString(otItemReader["ExpectedSupplierDeliveryDate"]);
                                            }
                                        }
                                            
                                                                               
                                        otShippingDetail.NotDeliveringItems.Add(otItemShippingDetail);
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetReadyForShippingOTItems(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                }
            }
          
                foreach (var itemotShippingDetail in otShippingDetails.GroupBy(osd=>osd.SiteShortName))
                {

                try
                {
                    if (itemotShippingDetail.Any(io => io.EmailTo != null && io.EmailTo != string.Empty))
                    {
                        if (itemotShippingDetail.Any(iosd => iosd.HTMLFileName != null && iosd.HTMLFileName != string.Empty))
                        {
                            string body = File.ReadAllText(emailTemplatePath + "/" + itemotShippingDetail.Where(iosd => iosd.HTMLFileName != null && iosd.HTMLFileName != string.Empty).Select(iosd => iosd.HTMLFileName.ToString()).FirstOrDefault());


                            StringBuilder strDeliveringItems = new StringBuilder();
                            StringBuilder strNotDeliveringItems = new StringBuilder();
                            StringBuilder strOfferAssignee = new StringBuilder();

                            bool isOfferAssignee = false;
                            bool isDeliveringItems = false;
                            bool isNotDeliveringItems = false;
                            List<string> LstOfferAssignee = new List<string>();
                            foreach (OTShippingDetail itemotShippingDetailchild in itemotShippingDetail.OrderBy(ob => ob.OTCode))
                            {
                                if (!string.IsNullOrEmpty(itemotShippingDetailchild.OfferAssigneeName))
                                {
                                    if (isOfferAssignee == false)
                                    {
                                        isOfferAssignee = true;
                                    }
                                    if (!LstOfferAssignee.Any(loa => loa.ToString() == itemotShippingDetailchild.OfferAssigneeName))
                                    {
                                        LstOfferAssignee.Add(itemotShippingDetailchild.OfferAssigneeName);
                                        if (!string.IsNullOrEmpty(itemotShippingDetailchild.OfferAssigneeEmail))
                                            strOfferAssignee.Append("<p style='font-size: 18px; text-indent: 40px;margin-left:20px;'>" + itemotShippingDetailchild.OfferAssigneeName + " (" + itemotShippingDetailchild.OfferAssigneeEmail + ")</p>");
                                        else
                                            strOfferAssignee.Append("<p style='font-size: 18px; text-indent: 40px;margin-left:20px;'>" + itemotShippingDetailchild.OfferAssigneeName + "</p>");
                                    }
                                }


                                if (itemotShippingDetailchild.DeliveringItems != null && itemotShippingDetailchild.DeliveringItems.Count > 0)
                                {
                                    if (isDeliveringItems == false)
                                    {
                                        isDeliveringItems = true;
                                    }

                                    foreach (OtItemShippingDetail itemDT in itemotShippingDetailchild.DeliveringItems)
                                    {
                                        strDeliveringItems.AppendLine("<tr>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.POCode + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.OTCode + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.Item + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.Reference + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.Description + "</td>");
                                        strDeliveringItems.AppendLine("<td align='right'>" + itemDT.Quantity + "</td>");
                                        strDeliveringItems.AppendLine("</tr>");
                                    }

                                }
                       


                            if (itemotShippingDetailchild.NotDeliveringItems != null && itemotShippingDetailchild.NotDeliveringItems.Count > 0)
                            {
                                if (isNotDeliveringItems == false)
                                {
                                    isNotDeliveringItems = true;
                                }

                                foreach (OtItemShippingDetail itemDT in itemotShippingDetailchild.NotDeliveringItems)
                                {
                                    strNotDeliveringItems.AppendLine("<tr>");
                                    strNotDeliveringItems.AppendLine("<td>" + itemDT.POCode + "</td>");
                                    strNotDeliveringItems.AppendLine("<td>" + itemDT.OTCode + "</td>");
                                    strNotDeliveringItems.AppendLine("<td>" + itemDT.Item + "</td>");
                                    strNotDeliveringItems.AppendLine("<td>" + itemDT.Reference + "</td>");
                                    strNotDeliveringItems.AppendLine("<td>" + itemDT.Description + "</td>");
                                    strNotDeliveringItems.AppendLine("<td align='right'>" + itemDT.Quantity + "</td>");
                                    strNotDeliveringItems.AppendLine("<td>" + itemDT.Observation + "</td>");
                                    strNotDeliveringItems.AppendLine("<td align='right'>" + itemDT.ExpectedSupplierDelivery + "</td>");
                                    strNotDeliveringItems.AppendLine("</tr>");
                                }
                            }
                        }


                        body = body.Replace("[DeliveringItems]", strDeliveringItems.ToString());


                        if (isOfferAssignee == false)
                        {
                            body = body.Replace("[OfferAssignee]", "");
                            body = body.Replace("[IsDisplayOfferAssignee]", "'display: none; overflow: hidden; mso - hide:all; margin: 0; font - size:0; max - height:0; '");
                        }
                        else
                        {
                            body = body.Replace("[OfferAssignee]", strOfferAssignee.ToString());
                            body = body.Replace("[IsDisplayOfferAssignee]", "'font-size: 18px;'");
                        }


                        if (isNotDeliveringItems == false)
                        {
                            body = body.Replace("[NotDeliveringItems]", "");
                            body = body.Replace("[IsDisplaytableStyle]", "'display: none; overflow: hidden; mso - hide:all; margin: 0; font - size:0; max - height:0; '");
                            body = body.Replace("[IsDisplaydivStyle]", "'display: none; overflow: hidden; mso - hide:all; margin: 0; font - size:0; max - height:0; '");
                            body = body.Replace("[IsDisplayborder]", "'0'");
                        }
                        else
                        {
                            body = body.Replace("[NotDeliveringItems]", strNotDeliveringItems.ToString());
                            body = body.Replace("[IsDisplaydivStyle]", "'display: block;'");
                            body = body.Replace("[IsDisplaytableStyle]", "'text-align:center; display: block;'");
                            body = body.Replace("[IsDisplayborder]", "'1'");
                        }


                        List<LinkedResource> ImgResourceList = new List<LinkedResource>();
                        //Emdep_logo
                        Bitmap emdepLogo = new Bitmap(emailTemplatePath + @"\Images\GEOS.png");
                        ImageConverter icEmdepLogo = new ImageConverter();
                        Byte[] emdepLogoBytes = (Byte[])icEmdepLogo.ConvertTo(emdepLogo, typeof(Byte[]));
                        MemoryStream imgEmdepLogo = new MemoryStream(emdepLogoBytes);
                        LinkedResource LREmdepLogo = new LinkedResource(imgEmdepLogo);
                        LREmdepLogo.ContentId = "EmbeddedContent_1";
                        LREmdepLogo.ContentLink = new Uri("cid:" + LREmdepLogo.ContentId);
                        ImgResourceList.Add(LREmdepLogo);

                        if (isDeliveringItems)
                            MailControl.SendHtmlMail(itemotShippingDetail.Select(iosd => iosd.MailSubject.ToString()).FirstOrDefault(), body, itemotShippingDetail.Where(io => io.EmailTo != null && io.EmailTo != string.Empty).Select(iosd => iosd.EmailTo.ToString()).FirstOrDefault(), (!string.IsNullOrEmpty(itemotShippingDetail.Where(io => io.EmailCC != null && io.EmailCC != string.Empty).Select(iosd => iosd.EmailCC.ToString()).FirstOrDefault())) ? Convert.ToString(itemotShippingDetail.Where(io => io.EmailCC != null && io.EmailCC != string.Empty).Select(iosd => iosd.EmailCC.ToString()).FirstOrDefault()).Split(';').ToList<string>() : new List<string>(), "WMS-noreply@emdep.com", mailServerName, mailServerPort, ImgResourceList);
                        else
                            logs.Add(string.Format("Error GetReadyForShippingOTItems(Ot Site-{0}) For site {0} No delivering item exist", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault()));

                    }
                    else
                    {
                        logs.Add(string.Format("Error GetReadyForShippingOTItems(Ot Site-{0}) For site {0} HTMLFileName is not exist", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault()));

                    }
                }
                    else
                    {
                        logs.Add(string.Format("Error GetReadyForShippingOTItems(Ot Site-{0}) For site {0} EmailTo is not added", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault()));
                    }
                }
                catch (Exception ex)
                {
                    logs.Add(string.Format("Error GetReadyForShippingOTItems(Ot Site-{0}), ErrorMessage- {1} ", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), ex.Message));
                }
            }

            return logs;
        }

        public List<Article> GetPendingArticles_V2038(Warehouses warehouse)
        {
            List<Article> articles = new List<Article>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection connArticles = new MySqlConnection(connectionString))
            {
                connArticles.Open();

                MySqlCommand articleCommand = new MySqlCommand("WMS_GetPendingArticles_V2038", connArticles);
                articleCommand.CommandType = CommandType.StoredProcedure;
                articleCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader articleReader = articleCommand.ExecuteReader())
                {
                    while (articleReader.Read())
                    {
                        try
                        {
                            Article article = new Article();

                            if (articleReader["IdArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(articleReader["IdArticle"]);

                            if (articleReader["Reference"] != DBNull.Value)
                                article.Reference = Convert.ToString(articleReader["Reference"]);

                            if (articleReader["Description"] != DBNull.Value)
                                article.Description = Convert.ToString(articleReader["Description"]);

                            WarehousePurchaseOrder warehousePO = new WarehousePurchaseOrder();

                            warehousePO.IdWarehousePurchaseOrder = Convert.ToInt64(articleReader["IdWarehousePurchaseOrder"]);

                            if (articleReader["PurchaseOrderCode"] != DBNull.Value)
                                warehousePO.Code = Convert.ToString(articleReader["PurchaseOrderCode"]);

                            if (articleReader["WO_DeliveryDate"] != DBNull.Value)
                                warehousePO.DeliveryDate = Convert.ToDateTime(articleReader["WO_DeliveryDate"]);

                            if (articleReader["WO_Supplier"] != DBNull.Value)
                            {
                                warehousePO.ArticleSupplier = new ArticleSupplier();
                                warehousePO.ArticleSupplier.Name = Convert.ToString(articleReader["WO_Supplier"]);
                            }

                            if (articleReader["PurchasedQty"] != DBNull.Value)
                            {
                                article.PurchasedQty = Convert.ToInt64(articleReader["PurchasedQty"]);
                            }

                            if (articleReader["DeliveredQty"] != DBNull.Value)
                            {
                                article.DeliveredQty = Convert.ToInt64(articleReader["DeliveredQty"]);
                            }

                            if (articleReader["RemainingQty"] != DBNull.Value)
                                article.Quantity = Convert.ToDouble(articleReader["RemainingQty"]);

                            if (articleReader["IdWarehouse"] != DBNull.Value)
                                warehousePO.IdWarehouse = Convert.ToInt64(articleReader["IdWarehouse"]);

                            article.WarehousePurchaseOrder = warehousePO;

                            articles.Add(article);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPendingArticles_V2038(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetPendingArticles_V2038().", category: Category.Info, priority: Priority.Low);
            return articles;
        }


        public List<Tuple<Int32,string>> GetCustomersWithOneOrderBox(string connectionString)
        {
            List<Tuple<Int32, string>> LstSites = new List<Tuple<Int32, string>>();
           
            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetCustomersWithOneOrderBox", conn);
                command.CommandType = CommandType.StoredProcedure;
              
                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            if (reader["IdSite"] != DBNull.Value)
                                LstSites.Add(Tuple.Create(Convert.ToInt32(reader["IdSite"]), Convert.ToString(reader["SiteName"])));
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetCustomersWithOneOrderBox(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetCustomersWithOneOrderBox().", category: Category.Info, priority: Priority.Low);
            return LstSites;
        }


        public List<Tuple<Int32, string>> GetEMDEPSites(string connectionString)
        {
            List<Tuple<Int32, string>> LstSites = new List<Tuple<Int32, string>>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetEMDEPSites", conn);
                command.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            if (reader["IdSite"] != DBNull.Value)
                                LstSites.Add(Tuple.Create(Convert.ToInt32(reader["IdSite"]), Convert.ToString(reader["SiteName"])));
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetEMDEPSites(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetEMDEPSites().", category: Category.Info, priority: Priority.Low);
            return LstSites;
        }


        /// <summary>
        /// [cpatil][15-01-2020][GEOS2-2020]Display articles in Warehouse section information depending of the type of warehouse
        /// </summary>
        /// <param name="warehouse">Warehouse details</param>
        /// <returns></returns>
        public List<Article> GetWarehouseArticlesStockByWarehouse_V2039(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<Article> articles = new List<Article>();

            using (MySqlConnection connArticle = new MySqlConnection(connectionString))
            {
                connArticle.Open();

                MySqlCommand articlesCommand = new MySqlCommand("WMS_GetWarehouseArticlesStockByWarehouse_V2039", connArticle);
                articlesCommand.CommandType = CommandType.StoredProcedure;
                articlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                articlesCommand.CommandTimeout = 8000;
                using (MySqlDataReader articleReader = articlesCommand.ExecuteReader())
                {
                    if (articleReader.HasRows)
                    {
                        while (articleReader.Read())
                        {
                            try
                            {
                                Article article = new Article();

                                if (articleReader["IdArticle"] != DBNull.Value)
                                    article.IdArticle = Convert.ToInt32(articleReader["IdArticle"]);

                                if (articleReader["Reference"] != DBNull.Value)
                                    article.Reference = Convert.ToString(articleReader["Reference"]);

                                if (articleReader["ArticleImagePath"] != DBNull.Value)
                                    article.ImagePath = Convert.ToString(articleReader["ArticleImagePath"]);

                                if (articleReader["Description"] != DBNull.Value)
                                    article.Description = Convert.ToString(articleReader["Description"]);

                                if (articleReader["Length"] != DBNull.Value)
                                    article.Length = (float)articleReader["Length"];

                                if (articleReader["Width"] != DBNull.Value)
                                    article.Width = (float)articleReader["Width"];

                                if (articleReader["Height"] != DBNull.Value)
                                    article.Height = (float)articleReader["Height"];

                                if (articleReader["Weight"] != DBNull.Value)
                                    article.Weight = Convert.ToDecimal(articleReader["Weight"]);

                                if (articleReader["IsGeneric"] != DBNull.Value)
                                    article.IsGeneric = Convert.ToSByte(articleReader["IsGeneric"]);

                                if (articleReader["IsObsolete"] != DBNull.Value)
                                    article.IsObsolete = Convert.ToSByte(articleReader["IsObsolete"]);

                                if (articleReader["RegisterSerialNumber"] != DBNull.Value)
                                    article.RegisterSerialNumber = Convert.ToByte(articleReader["RegisterSerialNumber"]);

                                if (articleReader["IdArticleType"] != DBNull.Value)
                                {
                                    article.IdArticleType = Convert.ToInt64(articleReader["IdArticleType"]);
                                    article.ArticlesType = new ArticleType();
                                    article.ArticlesType.IdArticleType = Convert.ToInt64(articleReader["IdArticleType"]);
                                    article.ArticlesType.Name= Convert.ToString(articleReader["ArticleTypeName"]);
                                }

                                if (articleReader["MaterialType"] != DBNull.Value)
                                {
                                    article.MaterialType = Convert.ToInt64(articleReader["MaterialType"]);
                                    article.Family = new LookupValue();
                                    article.Family.IdLookupValue = Convert.ToInt32(articleReader["MaterialType"]);
                                    article.Family.Value = Convert.ToString(articleReader["FamilyType"]);
                                }


                                if (articleReader["articleSleepDate"] != DBNull.Value)
                                {
                                    article.ArticleSleepDate = Convert.ToDateTime(articleReader["articleSleepDate"]);
                                    article.ArticleSleepDays = (Int32)(DateTime.Now - article.ArticleSleepDate.Value.Date).TotalDays;
                                }


                                if (articleReader["IdArticleCategory"] != DBNull.Value)
                                {
                                    article.IdArticleCategory = Convert.ToInt32(articleReader["IdArticleCategory"]);

                                    article.ArticleCategory = new ArticleCategory();
                                    article.ArticleCategory.IdArticleCategory = Convert.ToInt32(articleReader["IdArticleCategory"]);
                                    article.ArticleCategory.Name = articleReader["ArticleCategory"].ToString();
                                }

                                article.MyWarehouse = new MyWarehouse();

                                if (articleReader["Location"] != DBNull.Value)
                                    article.MyWarehouse.Location = Convert.ToString(articleReader["Location"]);

                                article.MyWarehouse.IdArticle = article.IdArticle;
                                article.MyWarehouse.CurrentStock = Convert.ToInt64(articleReader["Stock"]);
                                article.MyWarehouse.MinimumStock = Convert.ToInt64(articleReader["MinimumStock"]);
                                article.MyWarehouse.MaximumStock = Convert.ToInt64(articleReader["MaximumStock"]);

                                if (articleReader["IdWarehouse"] != DBNull.Value)
                                {
                                    article.MyWarehouse.IdWarehouse = Convert.ToInt64(articleReader["IdWarehouse"]);
                                    article.MyWarehouse.Warehouse = new Warehouses();
                                    article.MyWarehouse.Warehouse.IdWarehouse = article.MyWarehouse.IdWarehouse;
                                    article.MyWarehouse.Warehouse.Name = Convert.ToString(articleReader["WarehousName"]);
                                    article.MyWarehouse.Warehouse.IdSite = Convert.ToInt64(articleReader["IdSite"]);
                                }

                                articles.Add(article);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetWarehouseArticlesStockByWarehouse_V2039() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            return articles;
        }

        public List<WOItem> GetRevisionItemPackingWorkOrders_V2039(Warehouses warehouse, Int32 idCompany, string articleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<WOItem> unPackedItems = new List<WOItem>();
            Dictionary<Int64, byte[]> articleDetails = new Dictionary<Int64, byte[]>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetRevisionItemPackingWorkOrders_V2039", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.Parameters.AddWithValue("_IdCompany", idCompany);
                command.CommandTimeout = 8000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                WOItem unPackedItem = new WOItem();

                                if (reader["IdOT"] != DBNull.Value)
                                    unPackedItem.IdOT = Convert.ToInt64(reader["IdOT"]);

                                if (reader["IdOffer"] != DBNull.Value)
                                    unPackedItem.IdOffer = Convert.ToInt64(reader["IdOffer"]);

                                if (reader["MergeCode"] != DBNull.Value)
                                {
                                    unPackedItem.WorkOrder = Convert.ToString(reader["MergeCode"]);
                                }

                                if (reader["OtCode"] != DBNull.Value)
                                {
                                    unPackedItem.WorkOrderCode = Convert.ToString(reader["OtCode"]);
                                }

                                if (reader["NumItem"] != DBNull.Value)
                                {
                                    unPackedItem.Item = Convert.ToInt32(reader["NumItem"]);
                                }

                                if (reader["ActualQty"] != DBNull.Value)
                                {
                                    unPackedItem.Qty = Convert.ToInt64(reader["ActualQty"]);
                                    unPackedItem.OriginalQty = unPackedItem.Qty;
                                }


                                if (reader["IdArticle"] != DBNull.Value)
                                {
                                    unPackedItem.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                    if (reader["reference"] != DBNull.Value)
                                        unPackedItem.Reference = Convert.ToString(reader["reference"]);

                                    if (reader["Description"] != DBNull.Value)
                                        unPackedItem.Description = Convert.ToString(reader["Description"]);

                                    if (reader["ArticleWeight"] != DBNull.Value)
                                        unPackedItem.ArticleWeight = Convert.ToDouble(reader["ArticleWeight"]);

                                    if (articleDetails.Any(ad => ad.Key == unPackedItem.IdArticle))
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            unPackedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(unPackedItem.ImagePath))
                                                unPackedItem.ArticleImageInBytes = articleDetails.Where(ad => ad.Key == unPackedItem.IdArticle).Select(ad => ad.Value).FirstOrDefault();
                                        }
                                    }
                                    else
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            unPackedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(unPackedItem.ImagePath))
                                                unPackedItem.ArticleImageInBytes = GetArticleImageInBytes_V2034(articleVisualAidsPath, unPackedItem.ImagePath);

                                            articleDetails.Add(unPackedItem.IdArticle, unPackedItem.ArticleImageInBytes);
                                        }
                                    }
                                }


                                if (reader["PartNumberCode"] != DBNull.Value)
                                    unPackedItem.PartNumberCode = Convert.ToString(reader["PartNumberCode"]);


                                if (reader["idPartNumber"] != DBNull.Value)
                                    unPackedItem.IdPartNumber = Convert.ToInt64(reader["idPartNumber"]);

                                if (reader["IdOTItem"] != DBNull.Value)
                                    unPackedItem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                                unPackedItems.Add(unPackedItem);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetRevisionItemPackingWorkOrders_V2039() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    return unPackedItems;
                }
                
            }
        }

        public List<WOItem> GetPackedItemByIdPackingBox_V2039(Warehouses warehouse, string articleVisualAidsPath, Int64 idPackingBox)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<WOItem> packedItems = new List<WOItem>();
            Dictionary<Int64, byte[]> articleDetails = new Dictionary<Int64, byte[]>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetPackedItemByIdPackingBox_V2039", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.Parameters.AddWithValue("_IdPackingBox", idPackingBox);
                command.CommandTimeout = 8000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                WOItem packedItem = new WOItem();

                                if (reader["IdOT"] != DBNull.Value)
                                    packedItem.IdOT = Convert.ToInt64(reader["IdOT"]);

                                if (reader["IdOffer"] != DBNull.Value)
                                    packedItem.IdOffer = Convert.ToInt64(reader["IdOffer"]);

                                if (reader["MergeCode"] != DBNull.Value)
                                {
                                    packedItem.WorkOrder = Convert.ToString(reader["MergeCode"]);
                                }

                                if (reader["OtCode"] != DBNull.Value)
                                {
                                    packedItem.WorkOrderCode = Convert.ToString(reader["OtCode"]);
                                }

                                if (reader["NumItem"] != DBNull.Value)
                                {
                                    packedItem.Item = Convert.ToInt32(reader["NumItem"]);
                                }

                                if (reader["ActualQty"] != DBNull.Value)
                                {
                                    packedItem.Qty = Convert.ToInt64(reader["ActualQty"]);
                                    packedItem.OriginalQty = packedItem.Qty;
                                }


                                if (reader["IdArticle"] != DBNull.Value)
                                {
                                    packedItem.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                    if (reader["reference"] != DBNull.Value)
                                        packedItem.Reference = Convert.ToString(reader["reference"]);

                                    if (reader["Description"] != DBNull.Value)
                                        packedItem.Description = Convert.ToString(reader["Description"]);

                                    if (reader["ArticleWeight"] != DBNull.Value)
                                        packedItem.ArticleWeight = Convert.ToDouble(reader["ArticleWeight"]);

                                    if (articleDetails.Any(ad => ad.Key == packedItem.IdArticle))
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            packedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(packedItem.ImagePath))
                                                packedItem.ArticleImageInBytes = articleDetails.Where(ad => ad.Key == packedItem.IdArticle).Select(ad => ad.Value).FirstOrDefault();
                                        }
                                    }
                                    else
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            packedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(packedItem.ImagePath))
                                                packedItem.ArticleImageInBytes = GetArticleImageInBytes_V2034(articleVisualAidsPath, packedItem.ImagePath);

                                            articleDetails.Add(packedItem.IdArticle, packedItem.ArticleImageInBytes);
                                        }
                                    }
                                }


                                if (reader["PartNumberCode"] != DBNull.Value)
                                    packedItem.PartNumberCode = Convert.ToString(reader["PartNumberCode"]);


                                if (reader["idPartNumber"] != DBNull.Value)
                                    packedItem.IdPartNumber = Convert.ToInt64(reader["idPartNumber"]);

                                if (reader["IdOTItem"] != DBNull.Value)
                                    packedItem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                                packedItems.Add(packedItem);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPackedItemByIdPackingBox_V2039() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    return packedItems;
                }
            }
        }

        /// <summary>
        /// This method is to get pending articles
        /// [cpatil][10-02-2020]GEOS2-1528 Stock en articulos pendientes
        /// </summary>
        /// <param name="warehouse"></param>
        /// <returns></returns>
        public List<OtItem> GetPendingMaterialArticles_V2040(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OtItem> otItems = new List<OtItem>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetPendingMaterialArticles_V2040", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OtItem otItem = new OtItem();
                                if (reader["IdOTItem"] != DBNull.Value)
                                {
                                    otItem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                                    if (reader["IdOT"] != DBNull.Value)
                                        otItem.IdOT = Convert.ToInt64(reader["IdOT"]);

                                    otItem.RevisionItem = new RevisionItem();

                                    if (reader["ActualQty"] != DBNull.Value)
                                        otItem.RevisionItem.Quantity = Convert.ToInt64(reader["ActualQty"]);

                                    if (reader["DownloadedQty"] != DBNull.Value)
                                        otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(reader["DownloadedQty"]);

                                    if (reader["RemainingQty"] != DBNull.Value)
                                        otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(reader["RemainingQty"]);

                                    if (reader["IdArticle"] != DBNull.Value)
                                    {
                                        otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                        otItem.RevisionItem.WarehouseProduct.Article = new Article();
                                        otItem.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                        otItem.RevisionItem.WarehouseProduct.Article.Reference = Convert.ToString(reader["Reference"]);
                                        otItem.RevisionItem.WarehouseProduct.Article.Description = Convert.ToString(reader["Description"]);
                                        otItem.RevisionItem.WarehouseProduct.Article.MyWarehouse = new MyWarehouse();
                                        if (reader["ArticleCurrenctStock"] != DBNull.Value)
                                            otItem.RevisionItem.WarehouseProduct.Article.MyWarehouse.CurrentStock = Convert.ToInt64(reader["ArticleCurrenctStock"]);
                                        if (reader["ArticleMinimumStock"] != DBNull.Value)
                                            otItem.RevisionItem.WarehouseProduct.Article.MyWarehouse.MinimumStock = Convert.ToInt64(reader["ArticleMinimumStock"]);
                                    }

                                    otItem.Ot = new Ots();
                                    if (reader["MergeCode"] != DBNull.Value)
                                        otItem.Ot.Code = Convert.ToString(reader["MergeCode"]);

                                    if (reader["IdSite"] != DBNull.Value)
                                    {
                                        otItem.Ot.Quotation = new Quotation();

                                        otItem.Ot.Quotation.Site = new Company();
                                        otItem.Ot.Quotation.Site.Name = Convert.ToString(reader["SiteName"]);

                                        otItem.Ot.Quotation.Site.Country = new Country();
                                        otItem.Ot.Quotation.Site.Country.Name = Convert.ToString(reader["Country"]);

                                        otItem.Ot.Quotation.Site.Customer = new Customer();
                                        otItem.Ot.Quotation.Site.Customer.CustomerName = Convert.ToString(reader["CustomerGroup"]);

                                        otItem.Ot.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                    }

                                }

                                otItems.Add(otItem);
                            }
                            catch (Exception ex)
                            {
                                reader.Close();
                                mySqlConnection.Close();
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialArticles_V2040() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                         }
                    }
                }
            }

            return otItems;
        }

        /// <summary>
        /// This method is to get pending articles
        /// [cpatil][27-02-2020]GEOS2-2117 Add OTs not PICKED but expected to be sent in Notifications list
        /// </summary>
        /// <param name="warehouse"></param>
        /// <returns></returns>
        public List<Ots> GetNotPackingButOTDeliveryDateInCurrentWeek(Warehouses warehouse)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<Ots> ots = new List<Ots>();
           
            using (MySqlConnection connOts = new MySqlConnection(connectionString))
            {
                connOts.Open();

                MySqlCommand otsCommand = new MySqlCommand("WMS_GetNotPackingButOTDeliveryDateInCurrentWeek", connOts);
                otsCommand.CommandType = CommandType.StoredProcedure;
                otsCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                otsCommand.CommandTimeout = 6000;

                using (MySqlDataReader otReader = otsCommand.ExecuteReader())
                {
                    if (otReader.HasRows)
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = new Ots();
                             
                                ot.IdOT = Convert.ToInt64(otReader["IdOT"]);

                                if (otReader["MergeCode"] != DBNull.Value)
                                {
                                    ot.MergeCode = Convert.ToString(otReader["MergeCode"]);
                                }

                                if (otReader["DeliveryDate"] != DBNull.Value)
                                {
                                    ot.DeliveryDate = Convert.ToDateTime(otReader["DeliveryDate"]);
                                }

                                ot.Quotation = new Quotation();

                                if (otReader["IdSite"] != DBNull.Value)
                                {
                                    ot.Quotation.IdCustomer = Convert.ToInt32(otReader["IdSite"]);
                                    ot.Quotation.Site = new Company();
                                    ot.Quotation.Site.IdCompany = ot.Quotation.IdCustomer;

                                    if (otReader["ShortName"] != DBNull.Value && !string.IsNullOrEmpty(Convert.ToString(otReader["ShortName"])))
                                    {
                                        ot.Quotation.Site.ShortName = Convert.ToString(otReader["ShortName"]);
                                        ot.Quotation.Site.Name = ot.Quotation.Site.ShortName;
                                    }
                                    else
                                    {
                                        ot.Quotation.Site.ShortName = null;
                                        ot.Quotation.Site.Name = Convert.ToString(otReader["SiteName"]);
                                    }
                                }                           

                                ots.Add(ot);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetNotPackingButOTDeliveryDateInCurrentWeek() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetNotPackingButOTDeliveryDateInCurrentWeek().", category: Category.Info, priority: Priority.Low);
                    return ots;
                }


            }
        }


        public List<Tuple<string, string, string>> GetReadyForShippingOTItems_V2040(Warehouses warehouse, string idOts, string emailTemplatePath, string mailServerName, string mailServerPort)
        {
            List<Tuple<string, string, string>> logs = new List<Tuple<string, string, string>>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OTShippingDetail> otShippingDetails = new List<OTShippingDetail>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("WMS_GetReadyForShippingOTItems_V2040", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOts", idOts);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OTShippingDetail otShippingDetail = new OTShippingDetail();

                            if (otItemReader["IdOT"] != DBNull.Value)
                                otShippingDetail.IdOT = Convert.ToInt64(otItemReader["IdOT"]);
                            if (otItemReader["OtCode"] != DBNull.Value)
                                otShippingDetail.OTCode = Convert.ToString(otItemReader["OtCode"]);
                            if (otItemReader["PO"] != DBNull.Value)
                                otShippingDetail.POCode = Convert.ToString(otItemReader["PO"]);
                            if (otItemReader["OfferAssignee"] != DBNull.Value)
                                otShippingDetail.OfferAssigneeName = Convert.ToString(otItemReader["OfferAssignee"]);
                            if (otItemReader["Email"] != DBNull.Value)
                                otShippingDetail.OfferAssigneeEmail = Convert.ToString(otItemReader["Email"]);
                            if (otItemReader["iso"] != DBNull.Value)
                                otShippingDetail.CustomerCountryCode = Convert.ToString(otItemReader["iso"]);
                            if (otItemReader["IdSite"] != DBNull.Value)
                                otShippingDetail.IdSite = Convert.ToInt32(otItemReader["IdSite"]);
                            if (otItemReader["IdDetectionsTemplate"] != DBNull.Value)
                                otShippingDetail.IdTemplate = Convert.ToByte(otItemReader["IdDetectionsTemplate"]);
                            if (otItemReader["ShortName"] != DBNull.Value)
                                otShippingDetail.SiteShortName = Convert.ToString(otItemReader["ShortName"]);
                            if (otItemReader["template"] != DBNull.Value)
                                otShippingDetail.Template = Convert.ToString(otItemReader["template"]);
                            if (otItemReader["EmailTo"] != DBNull.Value)
                                otShippingDetail.EmailTo = Convert.ToString(otItemReader["EmailTo"]);
                            if (otItemReader["EmailCC"] != DBNull.Value)
                                otShippingDetail.EmailCC = Convert.ToString(otItemReader["EmailCC"]);
                            if (otItemReader["currentWeek"] != DBNull.Value)
                                otShippingDetail.CurrentWeek = Convert.ToString(otItemReader["currentWeek"]);

                            otShippingDetail.MailSubject = string.Format("[WMS] Ready for Expedition {0} {1}", otShippingDetail.SiteShortName, otShippingDetail.CurrentWeek);

                            if (File.Exists(string.Format("{0}{1}ReadyForShippingMailFormat_{2}.html", emailTemplatePath, @"\", otShippingDetail.CustomerCountryCode)))
                            {
                                otShippingDetail.HTMLFileName = string.Format("ReadyForShippingMailFormat_{0}.html", otShippingDetail.CustomerCountryCode);
                            }
                            else if (File.Exists(string.Format("{0}{1}ReadyForShippingMailFormat.html", emailTemplatePath, @"\")))
                            {
                                otShippingDetail.HTMLFileName = "ReadyForShippingMailFormat.html";
                            }

                            otShippingDetails.Add(otShippingDetail);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetReadyForShippingOTItems_V2040(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                    if (otItemReader.NextResult())
                    {
                        while (otItemReader.Read())
                        {
                            try
                            {
                                if (otItemReader["IdOT"] != DBNull.Value)
                                {
                                    if (otShippingDetails.Any(osd => osd.IdOT == Convert.ToInt64(otItemReader["IdOT"])))
                                    {
                                        OTShippingDetail otShippingDetail = otShippingDetails.Where(osd => osd.IdOT == Convert.ToInt64(otItemReader["IdOT"])).FirstOrDefault();

                                        if (otShippingDetail.DeliveringItems == null)
                                        {
                                            otShippingDetail.DeliveringItems = new List<OtItemShippingDetail>();
                                        }

                                        OtItemShippingDetail otItemShippingDetail = new OtItemShippingDetail();

                                        otItemShippingDetail.POCode = otShippingDetail.POCode;
                                        otItemShippingDetail.OTCode = otShippingDetail.OTCode;

                                        if (otItemReader["Item"] != DBNull.Value)
                                            otItemShippingDetail.Item = Convert.ToString(otItemReader["Item"]);
                                        if (otItemReader["Reference"] != DBNull.Value)
                                            otItemShippingDetail.Reference = Convert.ToString(otItemReader["Reference"]);
                                        if (otItemReader["Description"] != DBNull.Value)
                                            otItemShippingDetail.Description = Convert.ToString(otItemReader["Description"]);
                                        if (otItemReader["Quantity"] != DBNull.Value)
                                            otItemShippingDetail.Quantity = Convert.ToInt64(otItemReader["Quantity"]);

                                        otShippingDetail.DeliveringItems.Add(otItemShippingDetail);
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetReadyForShippingOTItems_V2040(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                    if (otItemReader.NextResult())
                    {
                        while (otItemReader.Read())
                        {
                            try
                            {
                                if (otItemReader["IdOT"] != DBNull.Value)
                                {
                                    if (otShippingDetails.Any(osd => osd.IdOT == Convert.ToInt64(otItemReader["IdOT"])))
                                    {
                                        OTShippingDetail otShippingDetail = otShippingDetails.Where(osd => osd.IdOT == Convert.ToInt64(otItemReader["IdOT"])).FirstOrDefault();

                                        if (otShippingDetail.NotDeliveringItems == null)
                                        {
                                            otShippingDetail.NotDeliveringItems = new List<OtItemShippingDetail>();
                                        }

                                        OtItemShippingDetail otItemShippingDetail = new OtItemShippingDetail();

                                        otItemShippingDetail.POCode = otShippingDetail.POCode;
                                        otItemShippingDetail.OTCode = otShippingDetail.OTCode;

                                        if (otItemReader["Item"] != DBNull.Value)
                                            otItemShippingDetail.Item = Convert.ToString(otItemReader["Item"]);
                                        if (otItemReader["Reference"] != DBNull.Value)
                                            otItemShippingDetail.Reference = Convert.ToString(otItemReader["Reference"]);
                                        if (otItemReader["Description"] != DBNull.Value)
                                            otItemShippingDetail.Description = Convert.ToString(otItemReader["Description"]);

                                        if (otItemReader["Quantity"] != DBNull.Value)
                                            otItemShippingDetail.Quantity = Convert.ToInt64(otItemReader["Quantity"]);
                                        if (otItemReader["observations"] != DBNull.Value)
                                            otItemShippingDetail.Observation = Convert.ToString(otItemReader["observations"]);
                                        if (otItemReader["ExpectedSupplierDeliveryDate"] != DBNull.Value)
                                        {
                                            if (Convert.ToString(otItemReader["ExpectedSupplierDeliveryDate"]).ToUpper() != "TBD")
                                            {

                                                DateTime dtExpectedSupplierDelivery = Convert.ToDateTime(Convert.ToDateTime(otItemReader["ExpectedSupplierDeliveryDate"]).ToString("dd / MM / yyyy"));
                                                otItemShippingDetail.ExpectedSupplierDelivery = dtExpectedSupplierDelivery.ToShortDateString();
                                            }
                                            else
                                            {
                                                otItemShippingDetail.ExpectedSupplierDelivery = Convert.ToString(otItemReader["ExpectedSupplierDeliveryDate"]);
                                            }
                                        }


                                        otShippingDetail.NotDeliveringItems.Add(otItemShippingDetail);
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetReadyForShippingOTItems_V2040(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                }
            }

            foreach (var itemotShippingDetail in otShippingDetails.GroupBy(osd => osd.SiteShortName))
            {

                try
                {
                    if (itemotShippingDetail.Any(io => io.EmailTo != null && io.EmailTo != string.Empty))
                    {
                        if (itemotShippingDetail.Any(iosd => iosd.HTMLFileName != null && iosd.HTMLFileName != string.Empty))
                        {
                            string body = File.ReadAllText(emailTemplatePath + "/" + itemotShippingDetail.Where(iosd => iosd.HTMLFileName != null && iosd.HTMLFileName != string.Empty).Select(iosd => iosd.HTMLFileName.ToString()).FirstOrDefault());


                            StringBuilder strDeliveringItems = new StringBuilder();
                            StringBuilder strNotDeliveringItems = new StringBuilder();
                            StringBuilder strOfferAssignee = new StringBuilder();

                            bool isOfferAssignee = false;
                            bool isDeliveringItems = false;
                            bool isNotDeliveringItems = false;
                            List<string> LstOfferAssignee = new List<string>();
                            foreach (OTShippingDetail itemotShippingDetailchild in itemotShippingDetail.OrderBy(ob => ob.OTCode))
                            {
                                if (!string.IsNullOrEmpty(itemotShippingDetailchild.OfferAssigneeName))
                                {
                                    if (isOfferAssignee == false)
                                    {
                                        isOfferAssignee = true;
                                    }
                                    if (!LstOfferAssignee.Any(loa => loa.ToString() == itemotShippingDetailchild.OfferAssigneeName))
                                    {
                                        LstOfferAssignee.Add(itemotShippingDetailchild.OfferAssigneeName);
                                        if (!string.IsNullOrEmpty(itemotShippingDetailchild.OfferAssigneeEmail))
                                            strOfferAssignee.Append("<p style=\"font-size: 18px; text-indent: 10px;\">" + itemotShippingDetailchild.OfferAssigneeName + " (" + itemotShippingDetailchild.OfferAssigneeEmail + ")</p>");
                                        else
                                            strOfferAssignee.Append("<p style=\"font-size: 18px; text-indent: 10px;\">" + itemotShippingDetailchild.OfferAssigneeName + "</p>");
                                    }
                                }


                                if (itemotShippingDetailchild.DeliveringItems != null && itemotShippingDetailchild.DeliveringItems.Count > 0)
                                {
                                    if (isDeliveringItems == false)
                                    {
                                        isDeliveringItems = true;
                                    }
                                    itemotShippingDetailchild.DeliveringItems = GetListSortedByItems(itemotShippingDetailchild.DeliveringItems);
                                    foreach (OtItemShippingDetail itemDT in itemotShippingDetailchild.DeliveringItems)
                                    {
                                        strDeliveringItems.AppendLine("<tr>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.POCode + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.OTCode + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.Item + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.Reference + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.Description + "</td>");
                                        strDeliveringItems.AppendLine("<td align='right'>" + itemDT.Quantity + "</td>");
                                        strDeliveringItems.AppendLine("</tr>");
                                    }
                                }

                                if (itemotShippingDetailchild.NotDeliveringItems != null && itemotShippingDetailchild.NotDeliveringItems.Count > 0)
                                {
                                    if (isNotDeliveringItems == false)
                                    {
                                        isNotDeliveringItems = true;
                                    }
                                    itemotShippingDetailchild.NotDeliveringItems = GetListSortedByItems(itemotShippingDetailchild.NotDeliveringItems);
                                    foreach (OtItemShippingDetail itemDT in itemotShippingDetailchild.NotDeliveringItems)
                                    {
                                        strNotDeliveringItems.AppendLine("<tr>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.POCode + "</td>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.OTCode + "</td>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.Item + "</td>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.Reference + "</td>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.Description + "</td>");
                                        strNotDeliveringItems.AppendLine("<td align='right'>" + itemDT.Quantity + "</td>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.Observation + "</td>");
                                        strNotDeliveringItems.AppendLine("<td align='right'>" + itemDT.ExpectedSupplierDelivery + "</td>");
                                        strNotDeliveringItems.AppendLine("</tr>");
                                    }
                                }
                            }


                            body = body.Replace("[DeliveringItems]", strDeliveringItems.ToString());


                            if (isOfferAssignee == false)
                            {
                                body = body.Replace("[OfferAssignee]", "");
                                body = body.Replace("[IsDisplayOfferAssignee]", "\"display: none; overflow: hidden; mso-hide:all; margin: 0; font-size:0; max-height:0;\"");
                            }
                            else
                            {
                                body = body.Replace("[OfferAssignee]", strOfferAssignee.ToString());
                                body = body.Replace("[IsDisplayOfferAssignee]", "\"font-size: 18px;\"");
                            }

                            if (isNotDeliveringItems == false)
                            {
                                body = body.Replace("[NotDeliveringItems]", "");
                                body = body.Replace("[IsDisplaytableStyle]", "\"display: none; overflow: hidden; mso-hide:all; margin: 0; font-size:0; max-height:0;\"");
                                body = body.Replace("[IsDisplaydivStyle]", "\"display: none; overflow: hidden; mso-hide:all; margin: 0; font-size:0; max-height:0;\"");
                                body = body.Replace("[IsDisplayborder]", "\"0\"");
                            }
                            else
                            {
                                body = body.Replace("[NotDeliveringItems]", strNotDeliveringItems.ToString());
                                body = body.Replace("[IsDisplaydivStyle]", "\"display: block;\"");
                                body = body.Replace("[IsDisplaytableStyle]", "\"text-align:center; display: block;\"");
                                body = body.Replace("[IsDisplayborder]", "\"1\"");
                            }

                            List<LinkedResource> ImgResourceList = new List<LinkedResource>();
                            //Emdep_logo
                            Bitmap emdepLogo = new Bitmap(emailTemplatePath + @"\Images\GEOS.png");
                            ImageConverter icEmdepLogo = new ImageConverter();
                            Byte[] emdepLogoBytes = (Byte[])icEmdepLogo.ConvertTo(emdepLogo, typeof(Byte[]));
                            MemoryStream imgEmdepLogo = new MemoryStream(emdepLogoBytes);
                            LinkedResource LREmdepLogo = new LinkedResource(imgEmdepLogo);
                            LREmdepLogo.ContentId = "EmbeddedContent_1";
                            LREmdepLogo.ContentLink = new Uri("cid:" + LREmdepLogo.ContentId);
                            ImgResourceList.Add(LREmdepLogo);

                            if (isDeliveringItems)
                            {
                                MailControl.SendHtmlMail(itemotShippingDetail.Select(iosd => iosd.MailSubject.ToString()).FirstOrDefault(), body, itemotShippingDetail.Where(io => io.EmailTo != null && io.EmailTo != string.Empty).Select(iosd => iosd.EmailTo.ToString()).FirstOrDefault(), (!string.IsNullOrEmpty(itemotShippingDetail.Where(io => io.EmailCC != null && io.EmailCC != string.Empty).Select(iosd => iosd.EmailCC.ToString()).FirstOrDefault())) ? Convert.ToString(itemotShippingDetail.Where(io => io.EmailCC != null && io.EmailCC != string.Empty).Select(iosd => iosd.EmailCC.ToString()).FirstOrDefault()).Split(';').ToList<string>() : new List<string>(), "WMS-noreply@emdep.com", mailServerName, mailServerPort, ImgResourceList);
                                logs.Add(new Tuple<string, string, string>("EmailSentToPlant", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), string.Format("For site {0} mail send successfully", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault())));
                            }
                            else
                                logs.Add(new Tuple<string, string, string>("NoDeliveredItemsEmailNotSendToPlant", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), string.Format("Error GetReadyForShippingOTItems(Ot Site-{0}) For site {0} No delivering item exist", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault())));

                        }
                        else
                        {
                            logs.Add(new Tuple<string, string, string>("HtmlFileNotExistEmailNotSendToPlant", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), string.Format("Error GetReadyForShippingOTItems(Ot Site-{0}) For site {0} HTMLFileName is not exist", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault())));
                        }
                    }
                    else
                    {
                        logs.Add(new Tuple<string, string, string>("EmailToNotAddedEmailNotSendToPlant", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), string.Format("Error GetReadyForShippingOTItems(Ot Site-{0}) For site {0} EmailTo is not added", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault())));
                    }
                }
                catch (Exception ex)
                {
                    logs.Add(new Tuple<string, string, string>("Exception", null, string.Format("Error GetReadyForShippingOTItems(Ot Site-{0}), ErrorMessage- {1} ", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), ex.Message)));
                }
            }

            return logs;
        }

        private List<OtItemShippingDetail> GetListSortedByItems(List<OtItemShippingDetail> LstOtItemShippingDetail)
        {
            List<OtItemShippingDetail> tempLstOtItemShippingDetail = new List<OtItemShippingDetail>();
            //To check if * without . will come then replace it by.* otherwise exception occur at time of sorting
            foreach (OtItemShippingDetail item in LstOtItemShippingDetail)
            {
                if (!item.Item.Contains('.') && item.Item.Contains('*'))
                    item.Item = item.Item.Replace("*", ".*");
            }
            try
            {
                LstOtItemShippingDetail = LstOtItemShippingDetail.Select(s => new { Str = s, Split = s.Item.Split('.') })
                                          .OrderBy(x => int.Parse(x.Split[0])).ThenBy(x=>int.Parse(x.Split.Count()>1 ? x.Split[1]:"0")).ThenBy(x => int.Parse(x.Split.Count() > 2 ? x.Split[2] : "0")).ThenBy(x => int.Parse(x.Split.Count() > 3 ? x.Split[3] : "0")).ThenBy(x => int.Parse(x.Split.Count() > 4 ? x.Split[4] : "0")).ThenBy(x => int.Parse(x.Split.Count() > 5 ? x.Split[5] : "0")).ThenBy(x => int.Parse(x.Split.Count() > 6 ? x.Split[6] : "0")).ThenBy(x => int.Parse(x.Split.Count() > 7 ? x.Split[7] : "0")).ThenBy(x => int.Parse(x.Split.Count() > 8 ? x.Split[8] : "0")).ThenBy(x => int.Parse(x.Split.Count() > 9 ? x.Split[9] : "0")).ThenBy(x => int.Parse(x.Split.Count() > 10 ? x.Split[10] : "0"))
                                          .Select(x => x.Str)
                                          .ToList();
            }
            catch (Exception ex)
            {
                //Exception occurs bcoz of wrong numItem in warehouseproductcomponent.
                //sorting cannot be do
            }
            return LstOtItemShippingDetail;
        }


        public List<Tuple<string, string, string>> GetReadyForShippingOTItems_V2041(Warehouses warehouse, string idOts, string emailTemplatePath, string mailServerName, string mailServerPort)
        {
            List<Tuple<string, string, string>> logs = new List<Tuple<string, string, string>>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OTShippingDetail> otShippingDetails = new List<OTShippingDetail>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("WMS_GetReadyForShippingOTItems_V2041", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOts", idOts);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
               
                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OTShippingDetail otShippingDetail = new OTShippingDetail();

                            if (otItemReader["IdOT"] != DBNull.Value)
                                otShippingDetail.IdOT = Convert.ToInt64(otItemReader["IdOT"]);
                            if (otItemReader["OtCode"] != DBNull.Value)
                                otShippingDetail.OTCode = Convert.ToString(otItemReader["OtCode"]);
                            if (otItemReader["PO"] != DBNull.Value)
                                otShippingDetail.POCode = Convert.ToString(otItemReader["PO"]);
                            if (otItemReader["OfferAssignee"] != DBNull.Value)
                                otShippingDetail.OfferAssigneeName = Convert.ToString(otItemReader["OfferAssignee"]);
                            if (otItemReader["Email"] != DBNull.Value)
                                otShippingDetail.OfferAssigneeEmail = Convert.ToString(otItemReader["Email"]);
                            if (otItemReader["iso"] != DBNull.Value)
                                otShippingDetail.CustomerCountryCode = Convert.ToString(otItemReader["iso"]);
                            if (otItemReader["IdSite"] != DBNull.Value)
                                otShippingDetail.IdSite = Convert.ToInt32(otItemReader["IdSite"]);
                            if (otItemReader["IdDetectionsTemplate"] != DBNull.Value)
                                otShippingDetail.IdTemplate = Convert.ToByte(otItemReader["IdDetectionsTemplate"]);
                            if (otItemReader["ShortName"] != DBNull.Value)
                                otShippingDetail.SiteShortName = Convert.ToString(otItemReader["ShortName"]);
                            if (otItemReader["template"] != DBNull.Value)
                                otShippingDetail.Template = Convert.ToString(otItemReader["template"]);
                            if (otItemReader["EmailTo"] != DBNull.Value)
                                otShippingDetail.EmailTo = Convert.ToString(otItemReader["EmailTo"]);
                            if (otItemReader["EmailCC"] != DBNull.Value)
                                otShippingDetail.EmailCC = Convert.ToString(otItemReader["EmailCC"]);
                            if (otItemReader["currentWeek"] != DBNull.Value)
                                otShippingDetail.CurrentWeek = Convert.ToString(otItemReader["currentWeek"]);

                            otShippingDetail.MailSubject = string.Format("[WMS] Ready for Expedition {0} {1}", otShippingDetail.SiteShortName, otShippingDetail.CurrentWeek);

                            if (File.Exists(string.Format("{0}{1}ReadyForShippingMailFormat_{2}.html", emailTemplatePath, @"\", otShippingDetail.CustomerCountryCode)))
                            {
                                otShippingDetail.HTMLFileName = string.Format("ReadyForShippingMailFormat_{0}.html", otShippingDetail.CustomerCountryCode);
                            }
                            else if (File.Exists(string.Format("{0}{1}ReadyForShippingMailFormat.html", emailTemplatePath, @"\")))
                            {
                                otShippingDetail.HTMLFileName = "ReadyForShippingMailFormat.html";
                            }

                            otShippingDetails.Add(otShippingDetail);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetReadyForShippingOTItems_V2041(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                    if (otItemReader.NextResult())
                    {
                        while (otItemReader.Read())
                        {
                            try
                            {
                                if (otItemReader["IdOT"] != DBNull.Value)
                                {
                                    if (otShippingDetails.Any(osd => osd.IdOT == Convert.ToInt64(otItemReader["IdOT"])))
                                    {
                                        OTShippingDetail otShippingDetail = otShippingDetails.Where(osd => osd.IdOT == Convert.ToInt64(otItemReader["IdOT"])).FirstOrDefault();

                                        if (otShippingDetail.DeliveringItems == null)
                                        {
                                            otShippingDetail.DeliveringItems = new List<OtItemShippingDetail>();
                                        }

                                        OtItemShippingDetail otItemShippingDetail = new OtItemShippingDetail();

                                        otItemShippingDetail.POCode = otShippingDetail.POCode;
                                        otItemShippingDetail.OTCode = otShippingDetail.OTCode;

                                        if (otItemReader["Item"] != DBNull.Value)
                                            otItemShippingDetail.Item = Convert.ToString(otItemReader["Item"]);
                                        if (otItemReader["Reference"] != DBNull.Value)
                                            otItemShippingDetail.Reference = Convert.ToString(otItemReader["Reference"]);
                                        if (otItemReader["Description"] != DBNull.Value)
                                            otItemShippingDetail.Description = Convert.ToString(otItemReader["Description"]);
                                        if (otItemReader["Quantity"] != DBNull.Value)
                                            otItemShippingDetail.Quantity = Convert.ToInt64(otItemReader["Quantity"]);

                                        otShippingDetail.DeliveringItems.Add(otItemShippingDetail);
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetReadyForShippingOTItems_V2041(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                    if (otItemReader.NextResult())
                    {
                        while (otItemReader.Read())
                        {
                            try
                            {
                                if (otItemReader["IdOT"] != DBNull.Value)
                                {
                                    if (otShippingDetails.Any(osd => osd.IdOT == Convert.ToInt64(otItemReader["IdOT"])))
                                    {
                                        OTShippingDetail otShippingDetail = otShippingDetails.Where(osd => osd.IdOT == Convert.ToInt64(otItemReader["IdOT"])).FirstOrDefault();

                                        if (otShippingDetail.NotDeliveringItems == null)
                                        {
                                            otShippingDetail.NotDeliveringItems = new List<OtItemShippingDetail>();
                                        }

                                        OtItemShippingDetail otItemShippingDetail = new OtItemShippingDetail();

                                        otItemShippingDetail.POCode = otShippingDetail.POCode;
                                        otItemShippingDetail.OTCode = otShippingDetail.OTCode;

                                        if (otItemReader["Item"] != DBNull.Value)
                                            otItemShippingDetail.Item = Convert.ToString(otItemReader["Item"]);
                                        if (otItemReader["Reference"] != DBNull.Value)
                                            otItemShippingDetail.Reference = Convert.ToString(otItemReader["Reference"]);
                                        if (otItemReader["Description"] != DBNull.Value)
                                            otItemShippingDetail.Description = Convert.ToString(otItemReader["Description"]);

                                        if (otItemReader["Quantity"] != DBNull.Value)
                                            otItemShippingDetail.Quantity = Convert.ToInt64(otItemReader["Quantity"]);
                                        if (otItemReader["observations"] != DBNull.Value)
                                            otItemShippingDetail.Observation = Convert.ToString(otItemReader["observations"]);
                                        if (otItemReader["ExpectedSupplierDeliveryDate"] != DBNull.Value)
                                        {
                                            if (Convert.ToString(otItemReader["ExpectedSupplierDeliveryDate"]).ToUpper() != "TBD")
                                            {

                                                DateTime dtExpectedSupplierDelivery = Convert.ToDateTime(Convert.ToDateTime(otItemReader["ExpectedSupplierDeliveryDate"]).ToString("dd / MM / yyyy"));
                                                otItemShippingDetail.ExpectedSupplierDelivery = dtExpectedSupplierDelivery.ToShortDateString();
                                            }
                                            else
                                            {
                                                otItemShippingDetail.ExpectedSupplierDelivery = Convert.ToString(otItemReader["ExpectedSupplierDeliveryDate"]);
                                            }
                                        }


                                        otShippingDetail.NotDeliveringItems.Add(otItemShippingDetail);
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetReadyForShippingOTItems_V2041(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                }
            }

            foreach (var itemotShippingDetail in otShippingDetails.GroupBy(osd => osd.SiteShortName))
            {

                try
                {
                    if (itemotShippingDetail.Any(io => io.EmailTo != null && io.EmailTo != string.Empty))
                    {
                        if (itemotShippingDetail.Any(iosd => iosd.HTMLFileName != null && iosd.HTMLFileName != string.Empty))
                        {
                            string body = File.ReadAllText(emailTemplatePath + "/" + itemotShippingDetail.Where(iosd => iosd.HTMLFileName != null && iosd.HTMLFileName != string.Empty).Select(iosd => iosd.HTMLFileName.ToString()).FirstOrDefault());


                            StringBuilder strDeliveringItems = new StringBuilder();
                            StringBuilder strNotDeliveringItems = new StringBuilder();
                            StringBuilder strOfferAssignee = new StringBuilder();

                            bool isOfferAssignee = false;
                            bool isDeliveringItems = false;
                            bool isNotDeliveringItems = false;
                            List<string> LstOfferAssignee = new List<string>();
                            foreach (OTShippingDetail itemotShippingDetailchild in itemotShippingDetail.OrderBy(ob => ob.OTCode))
                            {
                                if (!string.IsNullOrEmpty(itemotShippingDetailchild.OfferAssigneeName))
                                {
                                    if (isOfferAssignee == false)
                                    {
                                        isOfferAssignee = true;
                                    }
                                    if (!LstOfferAssignee.Any(loa => loa.ToString() == itemotShippingDetailchild.OfferAssigneeName))
                                    {
                                        LstOfferAssignee.Add(itemotShippingDetailchild.OfferAssigneeName);
                                        if (!string.IsNullOrEmpty(itemotShippingDetailchild.OfferAssigneeEmail))
                                            strOfferAssignee.Append("<p style=\"font-size: 18px; text-indent: 10px;\">" + itemotShippingDetailchild.OfferAssigneeName + " (" + itemotShippingDetailchild.OfferAssigneeEmail + ")</p>");
                                        else
                                            strOfferAssignee.Append("<p style=\"font-size: 18px; text-indent: 10px;\">" + itemotShippingDetailchild.OfferAssigneeName + "</p>");
                                    }
                                }


                                if (itemotShippingDetailchild.DeliveringItems != null && itemotShippingDetailchild.DeliveringItems.Count > 0)
                                {
                                    if (isDeliveringItems == false)
                                    {
                                        isDeliveringItems = true;
                                    }
                                    itemotShippingDetailchild.DeliveringItems = GetListSortedByItems(itemotShippingDetailchild.DeliveringItems);
                                    foreach (OtItemShippingDetail itemDT in itemotShippingDetailchild.DeliveringItems)
                                    {
                                        strDeliveringItems.AppendLine("<tr>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.POCode + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.OTCode + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.Item + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.Reference + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.Description + "</td>");
                                        strDeliveringItems.AppendLine("<td align='right'>" + itemDT.Quantity + "</td>");
                                        strDeliveringItems.AppendLine("</tr>");
                                    }
                                }

                                if (itemotShippingDetailchild.NotDeliveringItems != null && itemotShippingDetailchild.NotDeliveringItems.Count > 0)
                                {
                                    if (isNotDeliveringItems == false)
                                    {
                                        isNotDeliveringItems = true;
                                    }
                                    itemotShippingDetailchild.NotDeliveringItems = GetListSortedByItems(itemotShippingDetailchild.NotDeliveringItems);
                                    foreach (OtItemShippingDetail itemDT in itemotShippingDetailchild.NotDeliveringItems)
                                    {
                                        strNotDeliveringItems.AppendLine("<tr>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.POCode + "</td>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.OTCode + "</td>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.Item + "</td>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.Reference + "</td>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.Description + "</td>");
                                        strNotDeliveringItems.AppendLine("<td align='right'>" + itemDT.Quantity + "</td>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.Observation + "</td>");
                                        strNotDeliveringItems.AppendLine("<td align='right'>" + itemDT.ExpectedSupplierDelivery + "</td>");
                                        strNotDeliveringItems.AppendLine("</tr>");
                                    }
                                }
                            }


                            body = body.Replace("[DeliveringItems]", strDeliveringItems.ToString());


                            if (isOfferAssignee == false)
                            {
                                body = body.Replace("[OfferAssignee]", "");
                                body = body.Replace("[IsDisplayOfferAssignee]", "\"display: none; overflow: hidden; mso-hide:all; margin: 0; font-size:0; max-height:0;\"");
                            }
                            else
                            {
                                body = body.Replace("[OfferAssignee]", strOfferAssignee.ToString());
                                body = body.Replace("[IsDisplayOfferAssignee]", "\"font-size: 18px;\"");
                            }

                            if (isNotDeliveringItems == false)
                            {
                                body = body.Replace("[NotDeliveringItems]", "");
                                body = body.Replace("[IsDisplaytableStyle]", "\"display: none; overflow: hidden; mso-hide:all; margin: 0; font-size:0; max-height:0;\"");
                                body = body.Replace("[IsDisplaydivStyle]", "\"display: none; overflow: hidden; mso-hide:all; margin: 0; font-size:0; max-height:0;\"");
                                body = body.Replace("[IsDisplayborder]", "\"0\"");
                            }
                            else
                            {
                                body = body.Replace("[NotDeliveringItems]", strNotDeliveringItems.ToString());
                                body = body.Replace("[IsDisplaydivStyle]", "\"display: block;\"");
                                body = body.Replace("[IsDisplaytableStyle]", "\"text-align:center; display: block;\"");
                                body = body.Replace("[IsDisplayborder]", "\"1\"");
                            }

                            List<LinkedResource> ImgResourceList = new List<LinkedResource>();
                            //Emdep_logo
                            Bitmap emdepLogo = new Bitmap(emailTemplatePath + @"\Images\GEOS.png");
                            ImageConverter icEmdepLogo = new ImageConverter();
                            Byte[] emdepLogoBytes = (Byte[])icEmdepLogo.ConvertTo(emdepLogo, typeof(Byte[]));
                            MemoryStream imgEmdepLogo = new MemoryStream(emdepLogoBytes);
                            LinkedResource LREmdepLogo = new LinkedResource(imgEmdepLogo);
                            LREmdepLogo.ContentId = "EmbeddedContent_1";
                            LREmdepLogo.ContentLink = new Uri("cid:" + LREmdepLogo.ContentId);
                            ImgResourceList.Add(LREmdepLogo);

                            if (isDeliveringItems)
                            {
                                MailControl.SendHtmlMail(itemotShippingDetail.Select(iosd => iosd.MailSubject.ToString()).FirstOrDefault(), body, itemotShippingDetail.Where(io => io.EmailTo != null && io.EmailTo != string.Empty).Select(iosd => iosd.EmailTo.ToString()).FirstOrDefault(), (!string.IsNullOrEmpty(itemotShippingDetail.Where(io => io.EmailCC != null && io.EmailCC != string.Empty).Select(iosd => iosd.EmailCC.ToString()).FirstOrDefault())) ? Convert.ToString(itemotShippingDetail.Where(io => io.EmailCC != null && io.EmailCC != string.Empty).Select(iosd => iosd.EmailCC.ToString()).FirstOrDefault()).Split(';').ToList<string>() : new List<string>(), "WMS-noreply@emdep.com", mailServerName, mailServerPort, ImgResourceList);
                                logs.Add(new Tuple<string, string, string>("EmailSentToPlant", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), string.Format("For site {0} mail send successfully", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault())));
                            }
                            else
                                logs.Add(new Tuple<string, string, string>("NoDeliveredItemsEmailNotSendToPlant", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), string.Format("Error GetReadyForShippingOTItems_V2041(Ot Site-{0}) For site {0} No delivering item exist", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault())));

                        }
                        else
                        {
                            logs.Add(new Tuple<string, string, string>("HtmlFileNotExistEmailNotSendToPlant", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), string.Format("Error GetReadyForShippingOTItems_V2041(Ot Site-{0}) For site {0} HTMLFileName is not exist", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault())));
                        }
                    }
                    else
                    {
                        logs.Add(new Tuple<string, string, string>("EmailToNotAddedEmailNotSendToPlant", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), string.Format("Error GetReadyForShippingOTItems_V2041(Ot Site-{0}) For site {0} EmailTo is not added", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault())));
                    }
                }
                catch (Exception ex)
                {
                    logs.Add(new Tuple<string, string, string>("Exception", null, string.Format("Error GetReadyForShippingOTItems_V2041(Ot Site-{0}), ErrorMessage- {1} ", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), ex.Message)));
                }
            }

            return logs;
        }




        public List<Article> GetAllArticlesWithWarehouseLocations_V2041(Warehouses warehouse)
        {
            string whConnectionString = warehouse.Company.ConnectPlantConstr;
            List<Article> articles = new List<Article>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(whConnectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetAllArticlesWithWarehouseLocations_V2041", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            Article article = new Article();

                            if (reader["IdArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                            if (reader["ImagePath"] != DBNull.Value)
                            {
                                article.ImagePath = Convert.ToString(reader["ImagePath"]);

                            }

                            if (reader["Reference"] != DBNull.Value)
                                article.Reference = Convert.ToString(reader["Reference"]);

                            if (reader["Description"] != DBNull.Value)
                                article.Description = Convert.ToString(reader["Description"]);

                            if (reader["Weight"] != DBNull.Value)
                                article.Weight = Math.Round(Convert.ToDecimal(reader["Weight"]), 3);

                            if (reader["Length"] != DBNull.Value)
                                article.Length = (float)reader["Length"];

                            if (reader["Width"] != DBNull.Value)
                                article.Width = (float)reader["Width"];

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)reader["Height"];


                            if (reader["IdArticleCategory"] != DBNull.Value)
                            {
                                article.IdArticleCategory = Convert.ToInt32(reader["IdArticleCategory"]);

                                article.ArticleCategory = new ArticleCategory();
                                article.ArticleCategory.IdArticleCategory = Convert.ToInt32(reader["IdArticleCategory"]);
                                article.ArticleCategory.Name = Convert.ToString(reader["ArticleCategory"]);
                            }

                            if (reader["IdWarehouseLocation"] != DBNull.Value)
                            {
                                article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                                article.ArticleWarehouseLocation.IdWarehouseLocation = Convert.ToInt32(reader["IdWarehouseLocation"]);

                                if (reader["awlPosition"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.Position = Convert.ToInt64(reader["awlPosition"]);

                                if (reader["MinimumStock"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.MinimumStock = Convert.ToInt64(reader["MinimumStock"]);

                                if (reader["MaximumStock"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.MaximumStock = Convert.ToInt64(reader["MaximumStock"]);

                                article.ArticleWarehouseLocation.WarehouseLocation = new WarehouseLocation();
                                article.ArticleWarehouseLocation.WarehouseLocation.IdWarehouseLocation = article.ArticleWarehouseLocation.IdWarehouseLocation;

                                if (reader["wlPosition"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.Position = Convert.ToInt64(reader["wlPosition"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                                if (reader["Name"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.Name = Convert.ToString(reader["Name"]);

                                if (reader["Parent"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.Parent = Convert.ToInt64(reader["Parent"]);

                                if (reader["FullName"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.FullName = Convert.ToString(reader["FullName"]);

                                if (reader["HtmlColor"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.WarehouseLocation.HtmlColor = Convert.ToString(reader["HtmlColor"]);

                                article.ArticleWarehouseLocation.ArticlesStock = new ArticlesStock();
                                article.ArticleWarehouseLocation.ArticlesStock.IdWarehouseLocation = Convert.ToUInt64(article.ArticleWarehouseLocation.IdWarehouseLocation);

                                if (reader["ArticleStock"] != DBNull.Value)
                                    article.ArticleWarehouseLocation.ArticlesStock.Quantity = Convert.ToInt64(reader["ArticleStock"]);

                                if (!string.IsNullOrEmpty(article.ArticleWarehouseLocation.WarehouseLocation.FullName))
                                {
                                    int i = 0;
                                    foreach (string item in article.ArticleWarehouseLocation.WarehouseLocation.FullName.Split('-').ToArray())
                                    {
                                        if(i==0)
                                        {
                                            article.ArticleWarehouseLocation.WarehouseLocation.LevelFirstName = item;
                                        }
                                        else if (i == 1)
                                        {
                                            article.ArticleWarehouseLocation.WarehouseLocation.LevelSecondName = item;
                                        }
                                        else if (i == 2)
                                        {
                                            article.ArticleWarehouseLocation.WarehouseLocation.LevelThirdName = item;
                                        }
                                        else if (i >2)
                                        {
                                            break;
                                        }
                                        i++;
                                    }
                                }

                                articles.Add(article);
                            }
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetAllArticlesWithWarehouseLocations_V2041(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            return articles;
        }


        public Article GetArticleDetailsByReference_V2041(string reference, string articleVisualAidsPath, Warehouses warehouse, DateTime? fromDate = null, DateTime? toDate = null)
        {
            Article article = new Article();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetArticleDetailsByReference_V2038", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_Reference", reference);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 8000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        try
                        {
                            if (reader["idArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(reader["idArticle"]);

                            if (reader["IdArticleCategory"] != DBNull.Value)
                            {
                                article.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory = new ArticleCategory();
                                article.ArticleCategory.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory.Name = Convert.ToString(reader["categoryName"]);
                                article.ArticleCategory.TaricCode = Convert.ToString(reader["TaricCode"]);
                            }

                            if (reader["ImagePath"] != DBNull.Value)
                            {
                                article.ImagePath = Convert.ToString(reader["ImagePath"]);

                                if (!string.IsNullOrEmpty(article.ImagePath))
                                    article.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, article);
                            }

                            if (reader["Reference"] != DBNull.Value)
                                article.Reference = reader["Reference"].ToString();

                            if (reader["IsOrientativeVisualAid"] != DBNull.Value)
                                article.IsOrientativeVisualAid = Convert.ToByte(reader["IsOrientativeVisualAid"]);

                            if (reader["IsGeneric"] != DBNull.Value)
                                article.IsGeneric = Convert.ToSByte(reader["IsGeneric"]);

                            if (reader["isObsolete"] != DBNull.Value)
                                article.IsObsolete = Convert.ToSByte(reader["isObsolete"]);

                            if (reader["isPublic"] != DBNull.Value)
                                article.IsPublic = Convert.ToSByte(reader["isPublic"]);

                            if (reader["publishOnWeb"] != DBNull.Value)
                                article.PublishOnWeb = Convert.ToSByte(reader["publishOnWeb"]);

                            if (reader["registerSerialNumber"] != DBNull.Value)
                                article.RegisterSerialNumber = Convert.ToByte(reader["registerSerialNumber"]);

                            if (reader["CreatedIn"] != DBNull.Value)
                                article.CreatedIn = Convert.ToDateTime(reader["CreatedIn"]);

                            if (reader["ModifiedIn"] != DBNull.Value)
                                article.ModifiedIn = Convert.ToDateTime(reader["ModifiedIn"]);

                            if (reader["description"] != DBNull.Value)
                                article.Description = Convert.ToString(reader["description"]);

                            if (reader["description_es"] != DBNull.Value)
                                article.Description_es = Convert.ToString(reader["description_es"]);

                            if (reader["description_fr"] != DBNull.Value)
                                article.Description_fr = Convert.ToString(reader["description_fr"]);

                            if (reader["description_pt"] != DBNull.Value)
                                article.Description_pt = Convert.ToString(reader["description_pt"]);

                            if (reader["description_ro"] != DBNull.Value)
                                article.Description_ro = Convert.ToString(reader["description_ro"]);

                            if (reader["description_ru"] != DBNull.Value)
                                article.Description_ru = Convert.ToString(reader["description_ru"]);

                            if (reader["description_zh"] != DBNull.Value)
                                article.Description_zh = Convert.ToString(reader["description_zh"]);

                            if (reader["idReplacementArticle"] != DBNull.Value)
                            {
                                article.IdReplacementArticle = Convert.ToInt32(reader["idReplacementArticle"]);
                                article.ReplacementArticle = Convert.ToString(reader["ReplacementArticle"]);
                            }

                            if (reader["isBatch"] != DBNull.Value)
                                article.IsBatch = Convert.ToByte(reader["isBatch"]);

                            if (reader["taric"] != DBNull.Value)
                                article.Taric = Convert.ToString(reader["taric"]);

                            if (reader["IdArticleType"] != DBNull.Value)
                            {
                                article.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                article.ArticlesType = new ArticleType();
                                article.ArticlesType.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                if (reader["ArticleTypeName"] != DBNull.Value)
                                    article.ArticlesType.Name = Convert.ToString(reader["ArticleTypeName"]);
                            }


                            if (reader["Weight"] != DBNull.Value)
                                article.Weight = Convert.ToDecimal(reader["Weight"]);

                            if (reader["Width"] != DBNull.Value)
                                article.Width = (float)(reader["Width"]);

                            if (reader["Length"] != DBNull.Value)
                                article.Length = (float)(reader["Length"]);

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)(reader["Height"]);


                            if (reader["idCountry"] != DBNull.Value)
                            {
                                article.IdCountry = Convert.ToInt32(reader["idCountry"]);

                                article.Country = new Country();
                                article.Country.IdCountry = Convert.ToByte(reader["idCountry"]);
                                article.Country.Name = Convert.ToString(reader["CountryName"]);
                            }

                            if (reader["articleSleepDate"] != DBNull.Value)
                            {
                                article.ArticleSleepDate = Convert.ToDateTime(reader["articleSleepDate"]);
                                article.ArticleSleepDays = (Int32)(DateTime.Now - article.ArticleSleepDate.Value.Date).TotalDays;
                            }

                            article.MyWarehouse = new MyWarehouse();

                            if (reader["minimumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MinimumStock = Convert.ToInt64(reader["minimumStock"]);
                            }

                            if (reader["stock"] != DBNull.Value)
                            {
                                article.MyWarehouse.CurrentStock = Convert.ToInt64(reader["stock"]);
                            }

                            if (reader["maximumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MaximumStock = Convert.ToInt64(reader["maximumStock"]);
                            }

                            if (reader["idWareHouse"] != DBNull.Value)
                            {
                                article.MyWarehouse.IdWarehouse = Convert.ToInt64(reader["idWareHouse"]);
                            }

                            if (reader["location"] != DBNull.Value)
                            {
                                article.MyWarehouse.Location = Convert.ToString(reader["location"]);
                            }

                            if (reader["MaterialType"] != DBNull.Value)
                                article.MaterialType = Convert.ToInt64(reader["MaterialType"].ToString());
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleDetailsByReference_V2041(). Reference- {0} IdArticle-{1} ErrorMessage- {2}", reference, article.IdArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
                article.LstArticleBySupplier = new List<ArticleBySupplier>();
                article.LstArticleBySupplier = GetArticleSupplierDetailsByIdArticle(connectionString, article.IdArticle);

                article.LstArticleDecomposition = new List<ArticleDecomposition>();
                article.LstArticleDecomposition = GetArticleDeCompostionByIdArticle(connectionString, article.IdArticle);

                article.LstRelatedArticle = new List<RelatedArticle>();
                article.LstRelatedArticle = GetRelatedArticleDetailsByIdArticle(connectionString, article.IdArticle, warehouse.IdWarehouse);

                article.LstArticleDocument = new List<ArticleDocument>();
                article.LstArticleDocument = GetArticleAttachmentByIdArticle(connectionString, article.IdArticle);

                if (article.RegisterSerialNumber == 1)
                {
                    article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                    article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockIncludingSerialNumber(connectionString, article.IdArticle, warehouse.IdWarehouse);
                    // article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle_V2034(connectionString, article.IdArticle, warehouse.IdWarehouse);
                }
                else
                {
                    article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                    article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle_V2034(connectionString, article.IdArticle, warehouse.IdWarehouse);
                }

                article.LstManufacturersByArticles = new List<ManufacturersByArticle>();
                article.LstManufacturersByArticles = GetManufacturers(connectionString, article.IdArticle);

                //if (fromDate != null && toDate != null)
                //{
                article.LstArticlesStock = new List<ArticlesStock>();
                article.LstArticlesStock = GetStockHistoryByIdArticle_V2033(connectionString, article.IdArticle, DateTime.Now, DateTime.Now, warehouse.IdWarehouse);
                // }


                article.LstArticleForecast = new List<ArticleForecast>();
                article.LstArticleForecast = GetArticleForecast_V2037(connectionString, article.IdArticle, warehouse.IdWarehouse);

                article.LstArticleComment = new List<ArticleComment>();
                article.LstArticleComment = GetArticleComments(connectionString, article.IdArticle, warehouse.IdWarehouse);

            }

            return article;
        }


        public List<ArticleComment> GetArticleComments(string connectionString, Int32 idArticle, Int64 idWarehouse)
        {
            List<ArticleComment> articleComments = new List<ArticleComment>();


            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetArticleComments", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdArticle", idArticle);
                command.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                command.CommandTimeout = 8000;
                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            ArticleComment articleComment = new ArticleComment();

                            if (reader["IdArticleComment"] != DBNull.Value)
                                articleComment.IdArticleComment = Convert.ToInt64(reader["IdArticleComment"]);

                            if (reader["IdArticle"] != DBNull.Value)
                                articleComment.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                            if (reader["Comment"] != DBNull.Value)
                                articleComment.Comment = Convert.ToString(reader["Comment"]);
                            if (reader["IdWarehouse"] != DBNull.Value)
                                articleComment.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);
                            if (reader["IdStage"] != DBNull.Value)
                            {
                                articleComment.IdStage = Convert.ToByte(reader["IdStage"]);
                                articleComment.Stage = new Stage();
                                articleComment.Stage.IdStage = Convert.ToByte(reader["IdStage"]);
                                articleComment.Stage.Name = Convert.ToString(reader["Name"]);
                            }
                               
                            if (reader["IdCreator"] != DBNull.Value)
                                articleComment.IdCreator = Convert.ToInt32(reader["IdCreator"]);
                            if (reader["IdModifier"] != DBNull.Value)
                                articleComment.IdModifier = Convert.ToInt32(reader["IdModifier"]);
                            if (reader["ModificationDate"] != DBNull.Value)
                                articleComment.ModificationDate = Convert.ToDateTime(reader["ModificationDate"]);
                            if (reader["CreationDate"] != DBNull.Value)
                                articleComment.CreationDate = Convert.ToDateTime(reader["CreationDate"]);

                            articleComments.Add(articleComment);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleComments(idArticle-{0}). ErrorMessage- {1}", idArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }
         

            return articleComments;
        }


        public bool UpdateArticleDetails_V2041(string mainServerConnectionString, Article article, string articleVisualAidsPath, string connectionString)
        {
            bool isInserted = false;
            if (article.LstArticleWarehouseLocations != null)
            {
                AddArticleWarehouseLocation(mainServerConnectionString, article.LstArticleWarehouseLocations);
                isInserted = true;
            }
            if (article.MyWarehouse != null)
            {
                TransactionScope transactionScope = null;
                try
                {
                    using (transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("mywarehouse_Update", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;
                            mySqlCommand.Parameters.AddWithValue("_IdWarehouse", article.MyWarehouse.IdWarehouse);
                            mySqlCommand.Parameters.AddWithValue("_IdArticle", article.MyWarehouse.IdArticle);
                            mySqlCommand.Parameters.AddWithValue("_MaximumStock", article.MyWarehouse.MaximumStock);
                            mySqlCommand.Parameters.AddWithValue("_MinimumStock", article.MyWarehouse.MinimumStock);

                            mySqlCommand.ExecuteNonQuery();
                            mySqlConnection.Close();


                        }


                        transactionScope.Complete();
                        transactionScope.Dispose();
                    }
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();
                    isInserted = false;
                    throw;
                }
                isInserted = true;
            }
            if (article.IsAddedArticleImage)
            {
                if (article.ImagePath != null)
                {
                    TransactionScope transactionScope = null;
                    try
                    {
                        using (transactionScope = new TransactionScope())
                        {
                            using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                            {
                                mySqlConnection.Open();

                                MySqlCommand mySqlCommand = new MySqlCommand("articles_Update", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;

                                mySqlCommand.Parameters.AddWithValue("_IdArticle", article.IdArticle);
                                mySqlCommand.Parameters.AddWithValue("_ImagePath", @"\" + article.Reference + @"\" + article.Reference + article.ImagePath);
                                mySqlCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                mySqlCommand.Parameters.AddWithValue("_ModifiedBy", article.ModifiedBy);

                                mySqlCommand.ExecuteNonQuery();
                                mySqlConnection.Close();


                            }


                            transactionScope.Complete();
                            transactionScope.Dispose();
                        }
                    }
                    catch (Exception ex)
                    {
                        if (Transaction.Current != null)
                            Transaction.Current.Rollback();

                        if (transactionScope != null)
                            transactionScope.Dispose();
                        isInserted = false;
                        throw;
                    }
                    isInserted = true;
                }
                isInserted = SaveArticleImage(articleVisualAidsPath, article);

            }
            else if (article.IsDeletedArticleImage)
            {
                if (article.ImagePath != null)
                {
                    TransactionScope transactionScope = null;
                    try
                    {
                        using (transactionScope = new TransactionScope())
                        {
                            using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                            {
                                mySqlConnection.Open();

                                MySqlCommand mySqlCommand = new MySqlCommand("articles_Update", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;

                                mySqlCommand.Parameters.AddWithValue("_IdArticle", article.IdArticle);
                                mySqlCommand.Parameters.AddWithValue("_ImagePath", string.Empty);
                                mySqlCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                mySqlCommand.Parameters.AddWithValue("_ModifiedBy", article.ModifiedBy);

                                mySqlCommand.ExecuteNonQuery();
                                mySqlConnection.Close();


                            }


                            transactionScope.Complete();
                            transactionScope.Dispose();
                        }
                    }
                    catch (Exception ex)
                    {
                        if (Transaction.Current != null)
                            Transaction.Current.Rollback();

                        if (transactionScope != null)
                            transactionScope.Dispose();
                        isInserted = false;
                        throw;
                    }
                    isInserted = true;
                }
                isInserted = DeleteArticleImage(articleVisualAidsPath, article);
            }
            if (article.LogEntriesByArticles != null)
            {
                AddLogArticle(mainServerConnectionString, article.LogEntriesByArticles);
                isInserted = true;
            }
            if (article.LstArticleComment != null)
            {
                
                isInserted = AddUpdateDeleteArticleComment(article.LstArticleComment,  mainServerConnectionString);
            }

            return isInserted;
        }


        public bool AddUpdateDeleteArticleComment(List<ArticleComment> articleComments, string mainServerConnectionString)
        {
            bool isactionPerformed = false;
            if (articleComments == null || articleComments.Count == 0)
            {
                isactionPerformed = true;
            }

            if (articleComments != null)
            {
                try
                {
                    foreach (ArticleComment item in articleComments)
                    {
                        if (item.TransactionOperation == ModelBase.TransactionOperations.Add)
                        {
                            using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                            {
                                conn.Open();

                                try
                                {
                                    MySqlCommand conCommand = new MySqlCommand("WMS_InsertArticleComments", conn);
                                    conCommand.CommandType = CommandType.StoredProcedure;
                                    conCommand.Parameters.AddWithValue("_IdWarehouse", item.IdWarehouse);
                                    conCommand.Parameters.AddWithValue("_IdArticle", item.IdArticle);
                                    conCommand.Parameters.AddWithValue("_IdStage", item.IdStage);
                                    conCommand.Parameters.AddWithValue("_Comment", item.Comment);
                                    conCommand.Parameters.AddWithValue("_IdCreator", item.IdCreator);
                                    conCommand.Parameters.AddWithValue("_CreationDate", DateTime.Now);

                                    item.IdArticleComment = Convert.ToInt32(conCommand.ExecuteScalar());

                                    if (item.IdArticleComment > 0)
                                    {
                                        isactionPerformed = true;
                                    }

                                    conn.Close();
                                }
                                catch (Exception ex)
                                {
                                    throw;
                                }

                            }
                        }
                        else if (item.TransactionOperation == ModelBase.TransactionOperations.Update)
                        {
                            using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                            {
                                conn.Open();

                                try
                                {
                                    MySqlCommand conCommand = new MySqlCommand("WMS_UpdateArticleComments", conn);
                                    conCommand.CommandType = CommandType.StoredProcedure;
                                    conCommand.Parameters.AddWithValue("_IdArticleComment", item.IdArticleComment);
                                    conCommand.Parameters.AddWithValue("_IdWarehouse", item.IdWarehouse);
                                    conCommand.Parameters.AddWithValue("_IdArticle", item.IdArticle);
                                    conCommand.Parameters.AddWithValue("_IdStage", item.IdStage);
                                    conCommand.Parameters.AddWithValue("_Comment", item.Comment);
                                    conCommand.Parameters.AddWithValue("_IdModifier", item.IdModifier);
                                    conCommand.Parameters.AddWithValue("_ModificationDate", DateTime.Now);

                                    conCommand.ExecuteNonQuery();

                                    isactionPerformed = true;

                                    conn.Close();
                                }
                                catch (Exception ex)
                                {
                                    throw;
                                }

                            }
                        }
                        else if (item.TransactionOperation == ModelBase.TransactionOperations.Delete)
                        {
                            using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                            {
                                conn.Open();

                                try
                                {
                                    MySqlCommand conCommand = new MySqlCommand("WMS_DeleteArticleComments", conn);
                                    conCommand.CommandType = CommandType.StoredProcedure;
                                    conCommand.Parameters.AddWithValue("_IdArticleComment", item.IdArticleComment);

                                    conCommand.ExecuteNonQuery();

                                    isactionPerformed = true;

                                    conn.Close();
                                }
                                catch (Exception ex)
                                {
                                    throw;
                                }

                            }
                        }
                    }

                }
                catch (Exception ex)
                {
                    throw;
                }
            }
            return isactionPerformed;
        }



        public List<Stage> GetStagesByWarehouseStageIds(string connectionString)
        {
            List<Stage> LstStages = new List<Stage>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetStagesByWarehouseStageIds", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Stage stage = new Stage();
                        try
                        {
                            if (reader["IdStage"] != DBNull.Value)
                            {
                                stage.IdStage = Convert.ToByte(reader["IdStage"]);

                                if (reader["Sequence"] != DBNull.Value)
                                {
                                    stage.Sequence = Convert.ToByte(reader["Sequence"]);
                                }

                                if (reader["Name"] != DBNull.Value)
                                {
                                    stage.Name = Convert.ToString(reader["Name"]);
                                }

                             }

                            LstStages.Add(stage);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetStagesByWarehouseStageIds().  ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                      
                    }

                }
            }
            return LstStages;
        }


        public List<WOItem> GetRevisionItemPackingWorkOrders_V2041(Warehouses warehouse, Int32 idCompany, string articleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<WOItem> unPackedItems = new List<WOItem>();
            Dictionary<Int64, byte[]> articleDetails = new Dictionary<Int64, byte[]>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetRevisionItemPackingWorkOrders_V2041", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.Parameters.AddWithValue("_IdCompany", idCompany);
                command.CommandTimeout = 8000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                WOItem unPackedItem = new WOItem();

                                if (reader["IdOT"] != DBNull.Value)
                                    unPackedItem.IdOT = Convert.ToInt64(reader["IdOT"]);

                                if (reader["IdOffer"] != DBNull.Value)
                                    unPackedItem.IdOffer = Convert.ToInt64(reader["IdOffer"]);

                                if (reader["MergeCode"] != DBNull.Value)
                                {
                                    unPackedItem.WorkOrder = Convert.ToString(reader["MergeCode"]);
                                }

                                if (reader["OtCode"] != DBNull.Value)
                                {
                                    unPackedItem.WorkOrderCode = Convert.ToString(reader["OtCode"]);
                                }

                                if (reader["NumItem"] != DBNull.Value)
                                {
                                    unPackedItem.Item = Convert.ToInt32(reader["NumItem"]);
                                }

                                if (reader["ActualQty"] != DBNull.Value)
                                {
                                    unPackedItem.Qty = Convert.ToInt64(reader["ActualQty"]);
                                    unPackedItem.OriginalQty = unPackedItem.Qty;
                                }


                                if (reader["IdArticle"] != DBNull.Value)
                                {
                                    unPackedItem.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                    if (reader["reference"] != DBNull.Value)
                                        unPackedItem.Reference = Convert.ToString(reader["reference"]);

                                    if (reader["Description"] != DBNull.Value)
                                        unPackedItem.Description = Convert.ToString(reader["Description"]);

                                    if (reader["ArticleWeight"] != DBNull.Value)
                                        unPackedItem.ArticleWeight = Convert.ToDouble(reader["ArticleWeight"]);

                                    if (articleDetails.Any(ad => ad.Key == unPackedItem.IdArticle))
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            unPackedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(unPackedItem.ImagePath))
                                                unPackedItem.ArticleImageInBytes = articleDetails.Where(ad => ad.Key == unPackedItem.IdArticle).Select(ad => ad.Value).FirstOrDefault();
                                        }
                                    }
                                    else
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            unPackedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(unPackedItem.ImagePath))
                                                unPackedItem.ArticleImageInBytes = GetArticleImageInBytes_V2034(articleVisualAidsPath, unPackedItem.ImagePath);

                                            articleDetails.Add(unPackedItem.IdArticle, unPackedItem.ArticleImageInBytes);
                                        }
                                    }


                                    if (reader["ArticleComment"] != DBNull.Value)
                                        unPackedItem.ArticleComment = Convert.ToString(reader["ArticleComment"]);
                                }


                                if (reader["PartNumberCode"] != DBNull.Value)
                                    unPackedItem.PartNumberCode = Convert.ToString(reader["PartNumberCode"]);


                                if (reader["idPartNumber"] != DBNull.Value)
                                    unPackedItem.IdPartNumber = Convert.ToInt64(reader["idPartNumber"]);

                                if (reader["IdOTItem"] != DBNull.Value)
                                    unPackedItem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                                unPackedItems.Add(unPackedItem);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetRevisionItemPackingWorkOrders_V2041() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    return unPackedItems;
                }

            }
        }

        public List<WOItem> GetPackedItemByIdPackingBox_V2041(Warehouses warehouse, string articleVisualAidsPath, Int64 idPackingBox)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<WOItem> packedItems = new List<WOItem>();
            Dictionary<Int64, byte[]> articleDetails = new Dictionary<Int64, byte[]>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetPackedItemByIdPackingBox_V2041", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.Parameters.AddWithValue("_IdPackingBox", idPackingBox);
                command.CommandTimeout = 8000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                WOItem packedItem = new WOItem();

                                if (reader["IdOT"] != DBNull.Value)
                                    packedItem.IdOT = Convert.ToInt64(reader["IdOT"]);

                                if (reader["IdOffer"] != DBNull.Value)
                                    packedItem.IdOffer = Convert.ToInt64(reader["IdOffer"]);

                                if (reader["MergeCode"] != DBNull.Value)
                                {
                                    packedItem.WorkOrder = Convert.ToString(reader["MergeCode"]);
                                }

                                if (reader["OtCode"] != DBNull.Value)
                                {
                                    packedItem.WorkOrderCode = Convert.ToString(reader["OtCode"]);
                                }

                                if (reader["NumItem"] != DBNull.Value)
                                {
                                    packedItem.Item = Convert.ToInt32(reader["NumItem"]);
                                }

                                if (reader["ActualQty"] != DBNull.Value)
                                {
                                    packedItem.Qty = Convert.ToInt64(reader["ActualQty"]);
                                    packedItem.OriginalQty = packedItem.Qty;
                                }


                                if (reader["IdArticle"] != DBNull.Value)
                                {
                                    packedItem.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                    if (reader["reference"] != DBNull.Value)
                                        packedItem.Reference = Convert.ToString(reader["reference"]);

                                    if (reader["Description"] != DBNull.Value)
                                        packedItem.Description = Convert.ToString(reader["Description"]);

                                    if (reader["ArticleWeight"] != DBNull.Value)
                                        packedItem.ArticleWeight = Convert.ToDouble(reader["ArticleWeight"]);

                                    if (articleDetails.Any(ad => ad.Key == packedItem.IdArticle))
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            packedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(packedItem.ImagePath))
                                                packedItem.ArticleImageInBytes = articleDetails.Where(ad => ad.Key == packedItem.IdArticle).Select(ad => ad.Value).FirstOrDefault();
                                        }
                                    }
                                    else
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            packedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(packedItem.ImagePath))
                                                packedItem.ArticleImageInBytes = GetArticleImageInBytes_V2034(articleVisualAidsPath, packedItem.ImagePath);

                                            articleDetails.Add(packedItem.IdArticle, packedItem.ArticleImageInBytes);
                                        }
                                    }
                                    if (reader["ArticleComment"] != DBNull.Value)
                                        packedItem.ArticleComment = Convert.ToString(reader["ArticleComment"]);
                                }


                                if (reader["PartNumberCode"] != DBNull.Value)
                                    packedItem.PartNumberCode = Convert.ToString(reader["PartNumberCode"]);


                                if (reader["idPartNumber"] != DBNull.Value)
                                    packedItem.IdPartNumber = Convert.ToInt64(reader["idPartNumber"]);

                                if (reader["IdOTItem"] != DBNull.Value)
                                    packedItem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                                packedItems.Add(packedItem);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPackedItemByIdPackingBox_V2041() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    return packedItems;
                }
            }
        }

        public List<OtItem> GetRemainingOtItemsByIdOt_V2041(Int64 idOt, Warehouses warehouse, string ArticleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OtItem> otItems = new List<OtItem>();
            List<OtItemSameReference> OtItemSameReferences = new List<OtItemSameReference>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetRemainingOtItemsByIdOt", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOt", idOt);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OtItem otItem = new OtItem();

                            otItem.IdOT = idOt;

                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);



                            otItem.IsBatch = Convert.ToByte(otItemReader["IsBatch"]);

                            if (otItemReader["AttachedFiles"] != DBNull.Value)
                                otItem.AttachedFiles = Convert.ToString(otItemReader["AttachedFiles"]);

                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);
                                otItem.RevisionItem.Quantity = Convert.ToInt64(otItemReader["Quantity"]);
                                otItem.RevisionItem.UnitPrice = Convert.ToDecimal(otItemReader["UnitPrice"]);

                                if (otItemReader["CustomerCommentOT"] != DBNull.Value)
                                    otItem.RevisionItem.InternalComment = Convert.ToString(otItemReader["CustomerCommentOT"]);

                                if (otItemReader["CustomerCommentRevision"] != DBNull.Value)
                                    otItem.RevisionItem.CustomerComment = Convert.ToString(otItemReader["CustomerCommentRevision"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);

                                if (otItemReader["WpDescription"] != DBNull.Value)
                                    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["ArticleDescription"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["ArticleDescription"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    if (otItemReader["UploadedIn"] != DBNull.Value)
                                        article.UploadedIn = Convert.ToDateTime(otItemReader["UploadedIn"]);

                                    if (otItemReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                        article.IdWareHouseDeliveryNoteItem = Convert.ToInt64(otItemReader["IdWareHouseDeliveryNoteItem"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    article.MyWarehouse = new MyWarehouse();

                                    if (otItemReader["MinimumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MinimumStock"]);

                                    if (otItemReader["MaximumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MaximumStock"]);

                                    if (otItemReader["CurrentStock"] != DBNull.Value)
                                        article.MyWarehouse.CurrentStock = Convert.ToInt64(otItemReader["CurrentStock"]);


                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);

                                    otItem.Status = new ItemOTStatusType();
                                    otItem.Status.IdItemOtStatus = otItem.IdItemOtStatus;
                                    otItem.Status.Name = Convert.ToString(otItemReader["Status"]);
                                }

                                if (otItemReader["AssignedTo"] != DBNull.Value)
                                {
                                    otItem.AssignedTo = Convert.ToInt32(otItemReader["AssignedTo"]);

                                    otItem.AssignedToUser = new People();
                                    otItem.AssignedToUser.Name = Convert.ToString(otItemReader["AssignedName"]);
                                    otItem.AssignedToUser.Surname = Convert.ToString(otItemReader["AssignedSurname"]);
                                }

                                if (otItemReader["DownloadedQty"] != DBNull.Value)
                                    otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otItemReader["DownloadedQty"]);

                                if (otItemReader["RemainingQty"] != DBNull.Value)
                                    otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otItemReader["RemainingQty"]);

                                if (otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;


                                List<OtItem> decomposedOtItems = GetArticlesForDecompositionScan_V2041(warehouse, idOt, otItem, ArticleVisualAidsPath, OtItemSameReferences, otItem.RevisionItem.WarehouseProduct.Article.IdArticleType);

                                //if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                //    otItems.AddRange(decomposedOtItems);



                                if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                {
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    otItem.ArticleDecomposedList = decomposedOtItems;
                                }


                                FillPickingMaterial_V2041(otItem, warehouse, ArticleVisualAidsPath, otItems, OtItemSameReferences);
                            }

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRemainingOtItemsByIdOt_V2041(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetRemainingOtItemsByIdOt_V2041().", category: Category.Info, priority: Priority.Low);
            return otItems;
        }


        public void FillPickingMaterial_V2041(OtItem otItem, Warehouses warehouse, string ArticleVisualAidsPath, List<OtItem> otitems, List<OtItemSameReference> otItemSameReferences)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            otItem.PickingMaterialsList = new List<PickingMaterials>();
            List<PickingArticleStockDetail> pickingArticleStockDetails = new List<PickingArticleStockDetail>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetArticlesStockDetailsByIdArticle_V2041", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", otItem.RevisionItem.WarehouseProduct.Article.IdArticle);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                #region
                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {

                    while (articlesReader.Read())
                    {
                        PickingArticleStockDetail pickingArticleStockDetail = new PickingArticleStockDetail();

                        pickingArticleStockDetail.Article = new Article();
                        if (articlesReader["IdArticle"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            pickingArticleStockDetail.Article.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingArticleStockDetail.Article.Description = Convert.ToString(articlesReader["Description"]);

                            if (articlesReader["ImagePath"] != DBNull.Value)
                                pickingArticleStockDetail.Article.ImagePath = Convert.ToString(articlesReader["ImagePath"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingArticleStockDetail.Article.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                            if (articlesReader["ArticleComment"] != DBNull.Value)
                                pickingArticleStockDetail.Article.ArticleComment = Convert.ToString(articlesReader["ArticleComment"]);
                        }

                        if (articlesReader["awlMinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);

                        if (articlesReader["awlMaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);

                        if (articlesReader["ArticleLocationPosition"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationPosition = Convert.ToInt64(articlesReader["ArticleLocationPosition"]);

                        if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                        if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            pickingArticleStockDetail.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                        pickingArticleStockDetail.WarehouseLocation = new WarehouseLocation();
                        if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);


                            pickingArticleStockDetail.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);
                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FullName = Convert.ToString(articlesReader["Fullname"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.HtmlColor = Convert.ToString(articlesReader["HtmlColor"]);

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);
                        }


                        if (articlesReader["UnitPrice"] != DBNull.Value)
                            pickingArticleStockDetail.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                        if (articlesReader["IdCurrency"] != DBNull.Value)
                            pickingArticleStockDetail.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                        if (articlesReader["costprice"] != DBNull.Value)
                            pickingArticleStockDetail.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                        if (articlesReader["MinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                        if (articlesReader["MaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                        pickingArticleStockDetail.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (articlesReader["UploadedIn"] != DBNull.Value)
                            pickingArticleStockDetail.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);

                        if (articlesReader["DeliveryCode"] != DBNull.Value)
                        {

                            pickingArticleStockDetail.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);
                        }


                        if (articlesReader["IdCountryGroup"] != DBNull.Value)
                            pickingArticleStockDetail.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);

                        pickingArticleStockDetails.Add(pickingArticleStockDetail);
                    }
                }
                List<PickingArticleStockDetail> PickingArticleStockDetailSort = new List<PickingArticleStockDetail>();

                foreach (var itemPASD in pickingArticleStockDetails.GroupBy(i => Convert.ToDateTime(i.UploadedIn.Value.ToShortDateString())))
                {
                    foreach (var item in itemPASD.OrderBy(i => i.ArticleLocationPosition).ToList())
                    {
                        PickingArticleStockDetailSort.Add(item);
                    }
                }

                pickingArticleStockDetails = PickingArticleStockDetailSort;

                Int64 remainingQty = otItem.RevisionItem.RemainingQuantity; // download Quantity.
                foreach (PickingArticleStockDetail itemArticleStock in pickingArticleStockDetails)
                {

                    try
                    {

                        if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        {
                            Int64 articleCurrentStockRem = 0;
                            articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                            if (articleCurrentStockRem == 0)
                                continue;
                            else
                                if (remainingQty == 0)
                                return;
                        }
                        else
                        {
                            if (remainingQty == 0)
                                return;
                        }



                        PickingMaterials pickingMaterials = new PickingMaterials();

                        pickingMaterials.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        pickingMaterials.Article = new Article();
                        pickingMaterials.Article.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;
                        pickingMaterials.Article.ArticleComment = itemArticleStock.Article.ArticleComment;
                        pickingMaterials.ArticleComment = itemArticleStock.Article.ArticleComment;
                        pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                        pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        if (itemArticleStock.ArticleLocationMinimumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = itemArticleStock.ArticleLocationMinimumStock.Value;
                        if (itemArticleStock.ArticleLocationMaximumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = itemArticleStock.ArticleLocationMaximumStock.Value;

                        pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.IdOtitem = otItem.IdOTItem;

                        pickingMaterials.IdRevisionItem = otItem.IdRevisionItem;
                        pickingMaterials.RevisionItem = new RevisionItem();
                        pickingMaterials.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.NumItem = otItem.RevisionItem.NumItem;

                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.Quantity = otItem.RevisionItem.Quantity;

                        if (otItem.RevisionItem != null)
                            if (otItem.RevisionItem.WarehouseProduct != null)
                                pickingMaterials.IdWarehouseProductComponent = otItem.RevisionItem.WarehouseProduct.IdComponent;

                        if (!string.IsNullOrEmpty(otItem.RevisionItem.WarehouseProduct.Article.Reference))
                            pickingMaterials.Reference = otItem.RevisionItem.WarehouseProduct.Article.Reference;

                   

                        if (itemArticleStock.ArticleCurrentStock != null)
                            pickingMaterials.ArticleCurrentStock = itemArticleStock.ArticleCurrentStock.Value;

                        if (itemArticleStock.CurrentStock != null)
                            pickingMaterials.CurrentStock = itemArticleStock.CurrentStock.Value;

                        if (itemArticleStock.CostPrice != null)
                            pickingMaterials.CostPrice = itemArticleStock.CostPrice.Value;

                        if (itemArticleStock.UnitPrice != null)
                            pickingMaterials.UnitPrice = itemArticleStock.UnitPrice.Value;


                        pickingMaterials.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        if (pickingMaterials.IdWareHouseDeliveryNoteItem != null)
                        {
                            pickingMaterials.IdWareHouseDeliveryNoteItem = itemArticleStock.IdWareHouseDeliveryNoteItem.Value;


                            pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.Manufacturer = GeManufacturerByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbers(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, itemArticleStock.WarehouseLocation.IdWarehouse));
                        }


                        pickingMaterials.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;


                        pickingMaterials.LocationFullName = itemArticleStock.WarehouseLocation.FullName;


                        pickingMaterials.Description = itemArticleStock.Article.Description;

                    

                        if (!string.IsNullOrEmpty(itemArticleStock.Article.ImagePath))
                        {
                            pickingMaterials.ImagePath = itemArticleStock.Article.ImagePath;
                            Article article = new Article();
                            article.ImagePath = pickingMaterials.ImagePath;
                            pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                        }


                        if (itemArticleStock.MinimumStock != null)
                            pickingMaterials.MinimumStock = itemArticleStock.MinimumStock.Value;

                        if (itemArticleStock.MaximumStock != null)
                            pickingMaterials.MaximumStock = itemArticleStock.MaximumStock.Value;

                        pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (itemArticleStock.UploadedIn != null)
                        {
                            pickingMaterials.UploadedIn = itemArticleStock.UploadedIn;
                            pickingMaterials.WarehouseDeliveryNote.DeliveryDate = itemArticleStock.UploadedIn.Value;
                        }


                        pickingMaterials.WarehouseDeliveryNote.Code = itemArticleStock.WarehouseDeliveryNote.Code;


                        pickingMaterials.IdCurrency = itemArticleStock.IdCurrency;

                        if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        {
                            Int64 articleCurrentStockRem = 0;
                            articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                            if (articleCurrentStockRem > 0)
                            {
                                if (remainingQty > 0 && articleCurrentStockRem > 0)
                                {
                                    if (articleCurrentStockRem > remainingQty)
                                    {
                                        pickingMaterials.DownloadQuantity = remainingQty;
                                        remainingQty = 0;
                                    }
                                    else
                                    {
                                        pickingMaterials.DownloadQuantity = articleCurrentStockRem;
                                        remainingQty = remainingQty - articleCurrentStockRem;
                                    }

                                }
                            }
                            else
                            {
                                if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                                {
                                    if (pickingMaterials.ArticleCurrentStock > remainingQty)
                                    {
                                        pickingMaterials.DownloadQuantity = remainingQty;
                                        remainingQty = 0;
                                    }
                                    else
                                    {
                                        pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                                        remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                                    }

                                }
                            }
                        }
                        else
                        {
                            if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                            {
                                if (pickingMaterials.ArticleCurrentStock > remainingQty)
                                {
                                    pickingMaterials.DownloadQuantity = remainingQty;
                                    remainingQty = 0;
                                }
                                else
                                {
                                    pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                                    remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                                }

                            }
                        }

                        pickingMaterials.WarehouseLocation = new WarehouseLocation();

                        pickingMaterials.WarehouseLocation.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        pickingMaterials.WarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.WarehouseLocation.FullName = itemArticleStock.WarehouseLocation.FullName;

                        pickingMaterials.WarehouseLocation.HtmlColor = itemArticleStock.WarehouseLocation.HtmlColor;

                        pickingMaterials.WarehouseLocation.Latitude = itemArticleStock.WarehouseLocation.Latitude;

                        pickingMaterials.WarehouseLocation.Longitude = itemArticleStock.WarehouseLocation.Longitude;

                        pickingMaterials.WarehouseLocation.Width = itemArticleStock.WarehouseLocation.Width;

                        pickingMaterials.WarehouseLocation.Height = itemArticleStock.WarehouseLocation.Height;

                        pickingMaterials.WarehouseLocation.FileName = itemArticleStock.WarehouseLocation.FileName;

                        pickingMaterials.RegisterSerialNumber = itemArticleStock.Article.RegisterSerialNumber;

                        pickingMaterials.PartNumberCode = GetPartNumberCode(otItem.IdOTItem, connectionString);

                        if (itemArticleStock.IdCountryGroup != null)
                            pickingMaterials.IdCountryGroup = itemArticleStock.IdCountryGroup.Value;

                        //Add in otSameReferenceList
                        OtItemSameReference otItemSameReference = new OtItemSameReference();
                        otItemSameReference.IdArticle = pickingMaterials.IdArticle;
                        otItemSameReference.IdWarehouseDeliveryNoteItem = pickingMaterials.IdWareHouseDeliveryNoteItem;
                        otItemSameReference.ArticleCurrentStock = pickingMaterials.ArticleCurrentStock;
                        otItemSameReference.Qty = pickingMaterials.DownloadQuantity;
                        otItemSameReference.IdWarehouseLocation = pickingMaterials.WarehouseLocation.IdWarehouseLocation;
                        otItemSameReferences.Add(otItemSameReference);

                        otItem.PickingMaterialsList.Add(pickingMaterials);

                        //GetTotalArticleDownloadDetailByOtItem(connectionString, 1800, 35259);

                    }
                    catch (Exception ex)
                    {
                        Log4NetLogger.Logger.Log(string.Format("Error FillPickingMaterial_V2041(IdArticle-{0}, idWarehouse-{1}). ErrorMessage- {2}", otItem.RevisionItem.WarehouseProduct.Article.IdArticle, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                        throw;
                    }
                }
                #endregion

            }

        }

        public List<OtItem> GetArticlesForDecompositionScan_V2041(Warehouses warehouse, Int64 idOt, OtItem parentOtItem, string ArticleVisualAidsPath, List<OtItemSameReference> otItemSameReferences, Int64 idArticleType)
        {
            List<OtItem> otItems = new List<OtItem>();

            string connectionString = warehouse.Company.ConnectPlantConstr;

            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetArticlesForDecomposition", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOTitem", parentOtItem.IdOTItem);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            // keyId++;

                            OtItem otItem = new OtItem();
                            otItem.IdOT = idOt;
                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);

                            if (otItemReader["IdItemOtStatus"] != DBNull.Value)
                                otItem.IdItemOtStatus = Convert.ToByte(otItemReader["IdItemOtStatus"]);


                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);



                                if (otItemReader["IdComponent"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otItemReader["IdComponent"]);
                                }

                                //   otItem.KeyId = keyId;

                                if (otItemReader["idParent"] != DBNull.Value)
                                {
                                    otItem.ParentId = Convert.ToInt32(otItemReader["idParent"]);
                                }

                                if (otItem.ParentId == -1)
                                {
                                    otItem.ParentId = parentOtItem.KeyId;
                                    otItem.RevisionItem.Quantity = parentOtItem.RevisionItem.Quantity * Convert.ToDecimal(otItemReader["Quantity"]);
                                }
                                else
                                {
                                    //OtItem otItem213 = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId);

                                    decimal qty = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).RevisionItem.Quantity;
                                    otItem.RevisionItem.Quantity = qty * Convert.ToDecimal(otItemReader["Quantity"]);
                                    otItem.ParentId = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).KeyId;
                                }

                                //if (otItemReader["WpDescription"] != DBNull.Value)
                                //    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["Description"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["Description"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Weight"] != DBNull.Value)
                                        article.Weight = Convert.ToDecimal(otItemReader["Weight"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);
                                }


                                int downloaded = GetOtItemDownloadedQuantity(connectionString, otItem.RevisionItem.WarehouseProduct.Article.IdArticle, otItem.IdOTItem, otItem.RevisionItem.WarehouseProduct.IdComponent, warehouse.IdWarehouse);


                                otItem.RevisionItem.DownloadedQuantity = downloaded;

                                otItem.RevisionItem.RemainingQuantity = ((Int64)otItem.RevisionItem.Quantity - downloaded);

                                if ((Int64)otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;
                            }
                            otItem.PickingMaterialsList = new List<PickingMaterials>();
                            if (idArticleType != 2)
                                FillPickingMaterial_V2041(otItem, warehouse, ArticleVisualAidsPath, otItems, otItemSameReferences);

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticlesForDecompositionScan_V2041(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }

            return otItems;
        }


        public List<OtItem> GetRemainingOtItemsByIdOtDisbaledFIFO_V2041(Int64 idOt, Warehouses warehouse, string ArticleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OtItem> otItems = new List<OtItem>();
            List<OtItemSameReference> OtItemSameReferences = new List<OtItemSameReference>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetRemainingOtItemsByIdOt", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOt", idOt);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OtItem otItem = new OtItem();

                            otItem.IdOT = idOt;

                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);



                            otItem.IsBatch = Convert.ToByte(otItemReader["IsBatch"]);

                            if (otItemReader["AttachedFiles"] != DBNull.Value)
                                otItem.AttachedFiles = Convert.ToString(otItemReader["AttachedFiles"]);

                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);
                                otItem.RevisionItem.Quantity = Convert.ToInt64(otItemReader["Quantity"]);
                                otItem.RevisionItem.UnitPrice = Convert.ToDecimal(otItemReader["UnitPrice"]);

                                if (otItemReader["CustomerCommentOT"] != DBNull.Value)
                                    otItem.RevisionItem.InternalComment = Convert.ToString(otItemReader["CustomerCommentOT"]);

                                if (otItemReader["CustomerCommentRevision"] != DBNull.Value)
                                    otItem.RevisionItem.CustomerComment = Convert.ToString(otItemReader["CustomerCommentRevision"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);

                                if (otItemReader["WpDescription"] != DBNull.Value)
                                    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["ArticleDescription"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["ArticleDescription"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    if (otItemReader["UploadedIn"] != DBNull.Value)
                                        article.UploadedIn = Convert.ToDateTime(otItemReader["UploadedIn"]);

                                    if (otItemReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                        article.IdWareHouseDeliveryNoteItem = Convert.ToInt64(otItemReader["IdWareHouseDeliveryNoteItem"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    article.MyWarehouse = new MyWarehouse();

                                    if (otItemReader["MinimumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MinimumStock"]);

                                    if (otItemReader["MaximumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MaximumStock"]);

                                    if (otItemReader["CurrentStock"] != DBNull.Value)
                                        article.MyWarehouse.CurrentStock = Convert.ToInt64(otItemReader["CurrentStock"]);


                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);

                                    otItem.Status = new ItemOTStatusType();
                                    otItem.Status.IdItemOtStatus = otItem.IdItemOtStatus;
                                    otItem.Status.Name = Convert.ToString(otItemReader["Status"]);
                                }

                                if (otItemReader["AssignedTo"] != DBNull.Value)
                                {
                                    otItem.AssignedTo = Convert.ToInt32(otItemReader["AssignedTo"]);

                                    otItem.AssignedToUser = new People();
                                    otItem.AssignedToUser.Name = Convert.ToString(otItemReader["AssignedName"]);
                                    otItem.AssignedToUser.Surname = Convert.ToString(otItemReader["AssignedSurname"]);
                                }

                                if (otItemReader["DownloadedQty"] != DBNull.Value)
                                    otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otItemReader["DownloadedQty"]);

                                if (otItemReader["RemainingQty"] != DBNull.Value)
                                    otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otItemReader["RemainingQty"]);

                                if (otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;


                                List<OtItem> decomposedOtItems = GetArticlesForDecompositionScanDisabledFIFO_V2035(idOt, warehouse, otItem, ArticleVisualAidsPath, OtItemSameReferences, otItem.RevisionItem.WarehouseProduct.Article.IdArticleType);

                                //if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                //    otItems.AddRange(decomposedOtItems);



                                if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                {
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    otItem.ArticleDecomposedList = decomposedOtItems;
                                }


                                FillPickingMaterialDisbaledFIFO_V2041(otItem, warehouse, ArticleVisualAidsPath, otItems);
                            }

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRemainingOtItemsByIdOtDisbaledFIFO_V2041(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetRemainingOtItemsByIdOtDisbaledFIFO_V2035).", category: Category.Info, priority: Priority.Low);
            return otItems;
        }


        public void FillPickingMaterialDisbaledFIFO_V2041(OtItem otItem, Warehouses warehouse, string ArticleVisualAidsPath, List<OtItem> otitems)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            otItem.PickingMaterialsList = new List<PickingMaterials>();
            List<PickingArticleStockDetail> pickingArticleStockDetails = new List<PickingArticleStockDetail>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetArticlesStockDetailsByIdArticleDisbaledFIFO_V2041", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", otItem.RevisionItem.WarehouseProduct.Article.IdArticle);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                #region
                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {

                    while (articlesReader.Read())
                    {
                        PickingArticleStockDetail pickingArticleStockDetail = new PickingArticleStockDetail();

                        pickingArticleStockDetail.Article = new Article();
                        if (articlesReader["IdArticle"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            pickingArticleStockDetail.Article.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingArticleStockDetail.Article.Description = Convert.ToString(articlesReader["Description"]);

                            if (articlesReader["ArticleComment"] != DBNull.Value)
                                pickingArticleStockDetail.Article.ArticleComment = Convert.ToString(articlesReader["ArticleComment"]);

                            if (articlesReader["ImagePath"] != DBNull.Value)
                                pickingArticleStockDetail.Article.ImagePath = Convert.ToString(articlesReader["ImagePath"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingArticleStockDetail.Article.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                        }

                        if (articlesReader["awlMinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);

                        if (articlesReader["awlMaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);

                        if (articlesReader["ArticleLocationPosition"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationPosition = Convert.ToInt64(articlesReader["ArticleLocationPosition"]);

                        if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                        if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            pickingArticleStockDetail.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                        pickingArticleStockDetail.WarehouseLocation = new WarehouseLocation();
                        if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);


                            pickingArticleStockDetail.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);
                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FullName = Convert.ToString(articlesReader["Fullname"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.HtmlColor = Convert.ToString(articlesReader["HtmlColor"]);

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);
                        }


                        if (articlesReader["UnitPrice"] != DBNull.Value)
                            pickingArticleStockDetail.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                        if (articlesReader["IdCurrency"] != DBNull.Value)
                            pickingArticleStockDetail.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                        if (articlesReader["costprice"] != DBNull.Value)
                            pickingArticleStockDetail.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                        if (articlesReader["MinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                        if (articlesReader["MaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                        pickingArticleStockDetail.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (articlesReader["UploadedIn"] != DBNull.Value)
                            pickingArticleStockDetail.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);

                        if (articlesReader["DeliveryCode"] != DBNull.Value)
                        {

                            pickingArticleStockDetail.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);
                        }


                        if (articlesReader["IdCountryGroup"] != DBNull.Value)
                            pickingArticleStockDetail.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);

                        pickingArticleStockDetails.Add(pickingArticleStockDetail);
                    }
                }
                List<PickingArticleStockDetail> PickingArticleStockDetailSort = new List<PickingArticleStockDetail>();

                foreach (var itemPASD in pickingArticleStockDetails.GroupBy(i => Convert.ToDateTime(i.UploadedIn.Value.ToShortDateString())))
                {
                    foreach (var item in itemPASD.OrderBy(i => i.ArticleLocationPosition).ToList())
                    {
                        PickingArticleStockDetailSort.Add(item);
                    }
                }

                pickingArticleStockDetails = PickingArticleStockDetailSort;

                // Int64 remainingQty = otItem.RevisionItem.RemainingQuantity; // download Quantity.
                foreach (PickingArticleStockDetail itemArticleStock in pickingArticleStockDetails)
                {

                    try
                    {

                        //if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        //{
                        //    Int64 articleCurrentStockRem = 0;
                        //    articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                        //    if (articleCurrentStockRem == 0)
                        //        continue;
                        //    else
                        //        if (remainingQty == 0)
                        //        return;
                        //}
                        //else
                        //{
                        //    if (remainingQty == 0)
                        //        return;
                        //}



                        PickingMaterials pickingMaterials = new PickingMaterials();

                        pickingMaterials.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        pickingMaterials.Article = new Article();
                        pickingMaterials.Article.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;
                        pickingMaterials.Article.ArticleComment = itemArticleStock.Article.ArticleComment;
                        pickingMaterials.ArticleComment = itemArticleStock.Article.ArticleComment;
                        pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                        pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        if (itemArticleStock.ArticleLocationMinimumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = itemArticleStock.ArticleLocationMinimumStock.Value;
                        if (itemArticleStock.ArticleLocationMaximumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = itemArticleStock.ArticleLocationMaximumStock.Value;

                        pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.IdOtitem = otItem.IdOTItem;

                        pickingMaterials.IdRevisionItem = otItem.IdRevisionItem;
                        pickingMaterials.RevisionItem = new RevisionItem();
                        pickingMaterials.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.NumItem = otItem.RevisionItem.NumItem;

                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.Quantity = otItem.RevisionItem.Quantity;

                        if (otItem.RevisionItem != null)
                            if (otItem.RevisionItem.WarehouseProduct != null)
                                pickingMaterials.IdWarehouseProductComponent = otItem.RevisionItem.WarehouseProduct.IdComponent;

                        if (!string.IsNullOrEmpty(otItem.RevisionItem.WarehouseProduct.Article.Reference))
                            pickingMaterials.Reference = otItem.RevisionItem.WarehouseProduct.Article.Reference;

                        if (itemArticleStock.ArticleCurrentStock != null)
                            pickingMaterials.ArticleCurrentStock = itemArticleStock.ArticleCurrentStock.Value;

                        if (itemArticleStock.CurrentStock != null)
                            pickingMaterials.CurrentStock = itemArticleStock.CurrentStock.Value;

                        if (itemArticleStock.CostPrice != null)
                            pickingMaterials.CostPrice = itemArticleStock.CostPrice.Value;

                        if (itemArticleStock.UnitPrice != null)
                            pickingMaterials.UnitPrice = itemArticleStock.UnitPrice.Value;


                        pickingMaterials.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        if (pickingMaterials.IdWareHouseDeliveryNoteItem != null)
                        {
                            pickingMaterials.IdWareHouseDeliveryNoteItem = itemArticleStock.IdWareHouseDeliveryNoteItem.Value;


                            pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.Manufacturer = GeManufacturerByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbers(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, itemArticleStock.WarehouseLocation.IdWarehouse));
                        }


                        pickingMaterials.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;


                        pickingMaterials.LocationFullName = itemArticleStock.WarehouseLocation.FullName;


                        pickingMaterials.Description = itemArticleStock.Article.Description;

                        if (!string.IsNullOrEmpty(itemArticleStock.Article.ImagePath))
                        {
                            pickingMaterials.ImagePath = itemArticleStock.Article.ImagePath;
                            Article article = new Article();
                            article.ImagePath = pickingMaterials.ImagePath;
                            pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                        }


                        if (itemArticleStock.MinimumStock != null)
                            pickingMaterials.MinimumStock = itemArticleStock.MinimumStock.Value;

                        if (itemArticleStock.MaximumStock != null)
                            pickingMaterials.MaximumStock = itemArticleStock.MaximumStock.Value;

                        pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (itemArticleStock.UploadedIn != null)
                        {
                            pickingMaterials.UploadedIn = itemArticleStock.UploadedIn;
                            pickingMaterials.WarehouseDeliveryNote.DeliveryDate = itemArticleStock.UploadedIn.Value;
                        }


                        pickingMaterials.WarehouseDeliveryNote.Code = itemArticleStock.WarehouseDeliveryNote.Code;


                        pickingMaterials.IdCurrency = itemArticleStock.IdCurrency;

                        pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;

                        //if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        //{
                        //    Int64 articleCurrentStockRem = 0;
                        //    articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                        //    if (articleCurrentStockRem > 0)
                        //    {
                        //        if (remainingQty > 0 && articleCurrentStockRem > 0)
                        //        {
                        //            if (articleCurrentStockRem > remainingQty)
                        //            {
                        //                pickingMaterials.DownloadQuantity = remainingQty;
                        //                remainingQty = 0;
                        //            }
                        //            else
                        //            {
                        //                pickingMaterials.DownloadQuantity = articleCurrentStockRem;
                        //                remainingQty = remainingQty - articleCurrentStockRem;
                        //            }

                        //        }
                        //    }
                        //    else
                        //    {
                        //        if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                        //        {
                        //            if (pickingMaterials.ArticleCurrentStock > remainingQty)
                        //            {
                        //                pickingMaterials.DownloadQuantity = remainingQty;
                        //                remainingQty = 0;
                        //            }
                        //            else
                        //            {
                        //                pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                        //                remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                        //            }

                        //        }
                        //    }
                        //}
                        //else
                        //{
                        //    if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                        //    {
                        //        if (pickingMaterials.ArticleCurrentStock > remainingQty)
                        //        {
                        //            pickingMaterials.DownloadQuantity = remainingQty;
                        //            remainingQty = 0;
                        //        }
                        //        else
                        //        {
                        //            pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                        //            remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                        //        }

                        //    }
                        //}

                        pickingMaterials.WarehouseLocation = new WarehouseLocation();

                        pickingMaterials.WarehouseLocation.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        pickingMaterials.WarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.WarehouseLocation.FullName = itemArticleStock.WarehouseLocation.FullName;

                        pickingMaterials.WarehouseLocation.HtmlColor = itemArticleStock.WarehouseLocation.HtmlColor;

                        pickingMaterials.WarehouseLocation.Latitude = itemArticleStock.WarehouseLocation.Latitude;

                        pickingMaterials.WarehouseLocation.Longitude = itemArticleStock.WarehouseLocation.Longitude;

                        pickingMaterials.WarehouseLocation.Width = itemArticleStock.WarehouseLocation.Width;

                        pickingMaterials.WarehouseLocation.Height = itemArticleStock.WarehouseLocation.Height;

                        pickingMaterials.WarehouseLocation.FileName = itemArticleStock.WarehouseLocation.FileName;

                        pickingMaterials.RegisterSerialNumber = itemArticleStock.Article.RegisterSerialNumber;

                        pickingMaterials.PartNumberCode = GetPartNumberCode(otItem.IdOTItem, connectionString);

                        if (itemArticleStock.IdCountryGroup != null)
                            pickingMaterials.IdCountryGroup = itemArticleStock.IdCountryGroup.Value;

                        ////Add in otSameReferenceList
                        //OtItemSameReference otItemSameReference = new OtItemSameReference();
                        //otItemSameReference.IdArticle = pickingMaterials.IdArticle;
                        //otItemSameReference.IdWarehouseDeliveryNoteItem = pickingMaterials.IdWareHouseDeliveryNoteItem;
                        //otItemSameReference.ArticleCurrentStock = pickingMaterials.ArticleCurrentStock;
                        //otItemSameReference.Qty = pickingMaterials.DownloadQuantity;
                        //otItemSameReference.IdWarehouseLocation = pickingMaterials.WarehouseLocation.IdWarehouseLocation;
                        //otItemSameReferences.Add(otItemSameReference);

                        otItem.PickingMaterialsList.Add(pickingMaterials);

                        //GetTotalArticleDownloadDetailByOtItem(connectionString, 1800, 35259);

                    }
                    catch (Exception ex)
                    {
                        Log4NetLogger.Logger.Log(string.Format("Error FillPickingMaterialDisbaledFIFO_V2041(IdArticle-{0}, idWarehouse-{1}). ErrorMessage- {2}", otItem.RevisionItem.WarehouseProduct.Article.IdArticle, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                        throw;
                    }
                }
                #endregion

            }
        }


        public List<OtItem> GetArticlesForDecompositionScanDisabledFIFO_V2041(Int64 idOt, Warehouses warehouse, OtItem parentOtItem, string ArticleVisualAidsPath, List<OtItemSameReference> otItemSameReferences, Int64 idArticleType)
        {
            List<OtItem> otItems = new List<OtItem>();

            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetArticlesForDecomposition", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOTitem", parentOtItem.IdOTItem);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            // keyId++;

                            OtItem otItem = new OtItem();
                            otItem.IdOT = idOt;
                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);

                            if (otItemReader["IdItemOtStatus"] != DBNull.Value)
                                otItem.IdItemOtStatus = Convert.ToByte(otItemReader["IdItemOtStatus"]);


                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);



                                if (otItemReader["IdComponent"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otItemReader["IdComponent"]);
                                }

                                //   otItem.KeyId = keyId;

                                if (otItemReader["idParent"] != DBNull.Value)
                                {
                                    otItem.ParentId = Convert.ToInt32(otItemReader["idParent"]);
                                }

                                if (otItem.ParentId == -1)
                                {
                                    otItem.ParentId = parentOtItem.KeyId;
                                    otItem.RevisionItem.Quantity = parentOtItem.RevisionItem.Quantity * Convert.ToDecimal(otItemReader["Quantity"]);
                                }
                                else
                                {
                                    //OtItem otItem213 = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId);

                                    decimal qty = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).RevisionItem.Quantity;
                                    otItem.RevisionItem.Quantity = qty * Convert.ToDecimal(otItemReader["Quantity"]);
                                    otItem.ParentId = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).KeyId;
                                }

                                //if (otItemReader["WpDescription"] != DBNull.Value)
                                //    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["Description"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["Description"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Weight"] != DBNull.Value)
                                        article.Weight = Convert.ToDecimal(otItemReader["Weight"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);
                                }


                                int downloaded = GetOtItemDownloadedQuantity(connectionString, otItem.RevisionItem.WarehouseProduct.Article.IdArticle, otItem.IdOTItem, otItem.RevisionItem.WarehouseProduct.IdComponent, warehouse.IdWarehouse);


                                otItem.RevisionItem.DownloadedQuantity = downloaded;

                                otItem.RevisionItem.RemainingQuantity = ((Int64)otItem.RevisionItem.Quantity - downloaded);

                                if ((Int64)otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;
                            }
                            otItem.PickingMaterialsList = new List<PickingMaterials>();
                            if (idArticleType != 2)
                                FillPickingMaterialDisbaledFIFO_V2041(otItem, warehouse, ArticleVisualAidsPath, otItems);

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticlesForDecompositionScanDisabledFIFO_V2041(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }

            return otItems;
        }



        public PendingStorageArticles GetArticleDetailByIdWarehouseDeliveryNoteItem_V2041(Warehouses warehouse, Int64 idWarehouseDeliveryNoteItem, string articleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            PendingStorageArticles pendingStorageArticle = null;

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetArticleDetailByIdWarehouseDeliveryNoteItem_V2041", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouseDeliveryNoteItem", idWarehouseDeliveryNoteItem);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.CommandTimeout = 6000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        if (reader.Read())
                        {
                            try
                            {
                                pendingStorageArticle = new PendingStorageArticles();

                                if (reader["IdArticle"] != DBNull.Value)
                                    pendingStorageArticle.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                if (reader["StockQty"] != DBNull.Value)
                                    pendingStorageArticle.Quantity = Convert.ToInt64(reader["StockQty"]);

                                if (reader["idCurrency"] != DBNull.Value)
                                    pendingStorageArticle.IdCurrency = Convert.ToInt16(reader["idCurrency"]);

                                if (reader["Price"] != DBNull.Value)
                                    pendingStorageArticle.CostPrice = Convert.ToDouble(reader["Price"]);

                                if (reader["UnitPrice"] != DBNull.Value)
                                    pendingStorageArticle.UnitPrice = Convert.ToDouble(reader["UnitPrice"]);

                                if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                    pendingStorageArticle.IdWareHouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);

                                if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                                {
                                    pendingStorageArticle.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                    pendingStorageArticle.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["IdWarehouseDeliveryNote"]);
                                    if (reader["Code"] != DBNull.Value)
                                        pendingStorageArticle.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                    if (reader["DeliveryDate"] != DBNull.Value)
                                        pendingStorageArticle.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                }

                                if (reader["Reference"] != DBNull.Value)
                                    pendingStorageArticle.Reference = Convert.ToString(reader["Reference"]);

                                if (reader["Description"] != DBNull.Value)
                                    pendingStorageArticle.Description = Convert.ToString(reader["Description"]);

                                if (reader["ArticleComment"] != DBNull.Value)
                                    pendingStorageArticle.ArticleComment = Convert.ToString(reader["ArticleComment"]);

                                if (reader["ImagePath"] != DBNull.Value)
                                {
                                    pendingStorageArticle.ImagePath = Convert.ToString(reader["ImagePath"]);
                                    pendingStorageArticle.ArticleImageInBytes = GetArticleImageInBytesByImagePath(articleVisualAidsPath, pendingStorageArticle.ImagePath);
                                }


                                if (reader["IdWarehouseLocation"] != DBNull.Value)
                                    pendingStorageArticle.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    pendingStorageArticle.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);



                                if (reader["WarehouseMinimumStock"] != DBNull.Value)
                                    pendingStorageArticle.MinimumStock = Convert.ToInt64(reader["WarehouseMinimumStock"]);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetArticleDetailByIdWarehouseDeliveryNoteItem_V2041() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetArticleDetailByIdWarehouseDeliveryNoteItem_V2041().", category: Category.Info, priority: Priority.Low);
                    return pendingStorageArticle;
                }


            }
        }

        public double GetWONOfferAmount(Warehouses warehouse, byte idCurrency, DateTime accountingFromYear, DateTime accountingToYear)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            double offerAmount = 0;

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetWONOfferAmount", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idcurrency", idCurrency);
                command.Parameters.AddWithValue("_accountingYearFrom", accountingFromYear);
                command.Parameters.AddWithValue("_accountingYearTo", accountingToYear);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.CommandTimeout = 4000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        if (reader.Read())
                        {
                            try
                            {
                                if (reader["WONOfferAmount"] != DBNull.Value)
                                    offerAmount = Convert.ToDouble(reader["WONOfferAmount"]);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetWONOfferAmount() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetWONOfferAmount().", category: Category.Info, priority: Priority.Low);
                    return offerAmount;
                }


            }
        }


        public double GetArticleStockAmountInWarehouse(Warehouses warehouse, byte idCurrency, DateTime accountingFromYear, DateTime accountingToYear)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            double articleStockAmount = 0;

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetArticleStockAmountInWarehouse", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idcurrency", idCurrency);
                command.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
                command.Parameters.AddWithValue("_accountingToYear", accountingToYear);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.Parameters.AddWithValue("_IdTransitLocation", warehouse.IdTransitLocation);
                command.CommandTimeout = 4000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        if (reader.Read())
                        {
                            try
                            {
                                if (reader["ArticleStockAmount"] != DBNull.Value)
                                    articleStockAmount = Convert.ToDouble(reader["ArticleStockAmount"]);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetArticleStockAmountInWarehouse() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetArticleStockAmountInWarehouse().", category: Category.Info, priority: Priority.Low);
                    return articleStockAmount;
                }


            }
        }



        public double GetAbosleteArticleStockAmountInWarehouse(Warehouses warehouse, byte idCurrency, DateTime accountingFromYear, DateTime accountingToYear)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            double articleStockAmount = 0;

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetAbosleteArticleStockAmountInWarehouse", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idcurrency", idCurrency);
                command.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
                command.Parameters.AddWithValue("_accountingToYear", accountingToYear);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.Parameters.AddWithValue("_IdTransitLocation", warehouse.IdTransitLocation);
                command.CommandTimeout = 4000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        if (reader.Read())
                        {
                            try
                            {
                                if (reader["ArticleStockAmount"] != DBNull.Value)
                                    articleStockAmount = Convert.ToDouble(reader["ArticleStockAmount"]);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetAbosleteArticleStockAmountInWarehouse() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetAbosleteArticleStockAmountInWarehouse().", category: Category.Info, priority: Priority.Low);
                    return articleStockAmount;
                }


            }
        }

        public double GetSleepedArticleStockAmountInWarehouse(Warehouses warehouse, byte idCurrency, DateTime accountingFromYear, DateTime accountingToYear,Int64 aritclesleepDays)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            double articleStockAmount = 0;

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetSleepedArticleStockAmountInWarehouse", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idcurrency", idCurrency);
                command.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
                command.Parameters.AddWithValue("_accountingToYear", accountingToYear);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.Parameters.AddWithValue("_IdTransitLocation", warehouse.IdTransitLocation);
                command.Parameters.AddWithValue("_TotalDays", aritclesleepDays);
                command.CommandTimeout = 4000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        if (reader.Read())
                        {
                            try
                            {
                                if (reader["ArticleStockAmount"] != DBNull.Value)
                                    articleStockAmount = Convert.ToDouble(reader["ArticleStockAmount"]);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetSleepedArticleStockAmountInWarehouse() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetSleepedArticleStockAmountInWarehouse().", category: Category.Info, priority: Priority.Low);
                    return articleStockAmount;
                }


            }
        }


        public List<OfferDetail> GetSalesByMonth(Warehouses warehouse, byte idCurrency, DateTime accountingFromYear, DateTime accountingToYear)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            List<OfferDetail> offers = new List<OfferDetail>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetSalesByMonth", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idcurrency", idCurrency);
                command.Parameters.AddWithValue("_accountingYearFrom", accountingFromYear);
                command.Parameters.AddWithValue("_accountingYearTo", accountingToYear);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                command.CommandTimeout = 4000;

                using (MySqlDataReader offerreader = command.ExecuteReader())
                {
                    if (offerreader.HasRows)
                    {
                        while (offerreader.Read())
                        {
                            try
                            {
                                OfferDetail offer = new OfferDetail();

                                if (offerreader["CurrentMonth"] != DBNull.Value)
                                    offer.CurrentMonth = Convert.ToInt32(offerreader["CurrentMonth"].ToString());
                                if (offerreader["CurrentYear"] != DBNull.Value)
                                    offer.CurrentYear = Convert.ToInt32(offerreader["CurrentYear"].ToString());

                                if (offerreader["TotalOfferAmount"] != DBNull.Value)
                                    offer.Value = Convert.ToDouble(offerreader["TotalOfferAmount"].ToString());

                                if (offerreader["HtmlColor"] != DBNull.Value)
                                {
                                    offer.SaleStatusHTMLColor= Convert.ToString(offerreader["HtmlColor"].ToString());
                                }
                                offer.CurrName = offerreader["OfferCurrency"].ToString();
                                offer.CurrSymbol = offerreader["Symbol"].ToString();


                                offers.Add(offer);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetSalesByMonth() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetSalesByMonth().", category: Category.Info, priority: Priority.Low);
                    return offers;
                }
            }
        }


        public List<WarehouseCustomer> GetSalesByCustomer(Warehouses warehouse, byte idCurrency, DateTime accountingFromYear, DateTime accountingToYear)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            List<WarehouseCustomer> warehouseCustomers = new List<WarehouseCustomer>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetSalesByCustomer", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idcurrency", idCurrency);
                command.Parameters.AddWithValue("_accountingYearFrom", accountingFromYear);
                command.Parameters.AddWithValue("_accountingYearTo", accountingToYear);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                command.CommandTimeout = 4000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                WarehouseCustomer warehouseCustomer = new WarehouseCustomer();

                                if (reader["idSite"] != DBNull.Value)
                                    warehouseCustomer.IdCustomer = Convert.ToInt32(reader["idSite"].ToString());
                                if (reader["Amount"] != DBNull.Value)
                                    warehouseCustomer.Amount = Convert.ToDouble(reader["Amount"].ToString());

                                if (reader["ShortName"] != DBNull.Value)
                                    warehouseCustomer.Alias = Convert.ToString(reader["ShortName"].ToString());

                                if (reader["HtmlColor"] != DBNull.Value)
                                {
                                    warehouseCustomer.SaleStatusHTMLColor = Convert.ToString(reader["HtmlColor"].ToString());
                                }

                                warehouseCustomers.Add(warehouseCustomer);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetSalesByCustomer() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetSalesByCustomer().", category: Category.Info, priority: Priority.Low);
                    return warehouseCustomers;
                }
            }
        }

        public List<WarehouseInventoryWeek> GetInventoryWeek(Warehouses warehouse, byte idCurrency, DateTime accountingFromYear, DateTime accountingToYear)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            List<WarehouseInventoryWeek> warehouseInventoryWeeks = new List<WarehouseInventoryWeek>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetStockAmountByWeekInWarehouse", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idcurrency", idCurrency);
                command.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
                command.Parameters.AddWithValue("_accountingToYear", accountingToYear);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.Parameters.AddWithValue("_IdTransitLocation", warehouse.IdTransitLocation);

                command.CommandTimeout = 4000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                WarehouseInventoryWeek warehouseInventoryWeek = new WarehouseInventoryWeek();

                                if (reader["StockWeek"] != DBNull.Value)
                                    warehouseInventoryWeek.StockWeek = Convert.ToInt64(reader["StockWeek"].ToString());
                                if (reader["ArticleStockAmount"] != DBNull.Value)
                                    warehouseInventoryWeek.Amount = Convert.ToDouble(reader["ArticleStockAmount"].ToString());

                                warehouseInventoryWeeks.Add(warehouseInventoryWeek);

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetInventoryWeek() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetInventoryWeek().", category: Category.Info, priority: Priority.Low);
                    return warehouseInventoryWeeks;
                }
            }
        }

        public List<Tuple<string, string, string>> GetReadyForShippingOTItems_V2042(Warehouses warehouse, string idOts, string emailTemplatePath, string mailServerName, string mailServerPort,string commandTimeout)
        {
            List<Tuple<string, string, string>> logs = new List<Tuple<string, string, string>>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OTShippingDetail> otShippingDetails = new List<OTShippingDetail>();
            DataSet dataSet = new DataSet();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("WMS_GetReadyForShippingOTItems_V2042", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOts", idOts);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                otItemCommand.CommandTimeout = Convert.ToInt32(commandTimeout);
                using (MySqlDataAdapter adap = new MySqlDataAdapter(otItemCommand))
                {
                    adap.Fill(dataSet);
                }
            }
                if(dataSet != null && dataSet.Tables.Count>0)
                {
                    if(dataSet.Tables[0]!=null && dataSet.Tables[0].Rows.Count>0)
                    foreach (DataRow otItemReader in dataSet.Tables[0].Rows)
                    {
                        try
                        {
                            OTShippingDetail otShippingDetail = new OTShippingDetail();

                            if (otItemReader["IdOT"] != DBNull.Value)
                                otShippingDetail.IdOT = Convert.ToInt64(otItemReader["IdOT"]);
                            if (otItemReader["OtCode"] != DBNull.Value)
                                otShippingDetail.OTCode = Convert.ToString(otItemReader["OtCode"]);
                            if (otItemReader["PO"] != DBNull.Value)
                                otShippingDetail.POCode = Convert.ToString(otItemReader["PO"]);
                            if (otItemReader["OfferAssignee"] != DBNull.Value)
                                otShippingDetail.OfferAssigneeName = Convert.ToString(otItemReader["OfferAssignee"]);
                            if (otItemReader["Email"] != DBNull.Value)
                                otShippingDetail.OfferAssigneeEmail = Convert.ToString(otItemReader["Email"]);
                            if (otItemReader["iso"] != DBNull.Value)
                                otShippingDetail.CustomerCountryCode = Convert.ToString(otItemReader["iso"]);
                            if (otItemReader["IdSite"] != DBNull.Value)
                                otShippingDetail.IdSite = Convert.ToInt32(otItemReader["IdSite"]);
                            if (otItemReader["IdDetectionsTemplate"] != DBNull.Value)
                                otShippingDetail.IdTemplate = Convert.ToByte(otItemReader["IdDetectionsTemplate"]);
                            if (otItemReader["ShortName"] != DBNull.Value)
                                otShippingDetail.SiteShortName = Convert.ToString(otItemReader["ShortName"]);
                            if (otItemReader["template"] != DBNull.Value)
                                otShippingDetail.Template = Convert.ToString(otItemReader["template"]);
                            if (otItemReader["EmailTo"] != DBNull.Value)
                                otShippingDetail.EmailTo = Convert.ToString(otItemReader["EmailTo"]);
                            if (otItemReader["EmailCC"] != DBNull.Value)
                                otShippingDetail.EmailCC = Convert.ToString(otItemReader["EmailCC"]);
                            if (otItemReader["currentWeek"] != DBNull.Value)
                                otShippingDetail.CurrentWeek = Convert.ToString(otItemReader["currentWeek"]);

                            otShippingDetail.MailSubject = string.Format("[WMS] Ready for Expedition {0} {1}", otShippingDetail.SiteShortName, otShippingDetail.CurrentWeek);

                            if (File.Exists(string.Format("{0}{1}ReadyForShippingMailFormat_{2}.html", emailTemplatePath, @"\", otShippingDetail.CustomerCountryCode)))
                            {
                                otShippingDetail.HTMLFileName = string.Format("ReadyForShippingMailFormat_{0}.html", otShippingDetail.CustomerCountryCode);
                            }
                            else if (File.Exists(string.Format("{0}{1}ReadyForShippingMailFormat.html", emailTemplatePath, @"\")))
                            {
                                otShippingDetail.HTMLFileName = "ReadyForShippingMailFormat.html";
                            }

                            otShippingDetails.Add(otShippingDetail);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetReadyForShippingOTItems_V2042(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                    if (dataSet.Tables[1] != null && dataSet.Tables[1].Rows.Count > 0)
                    {
                     
                            foreach (DataRow otItemReader in dataSet.Tables[1].Rows)
                            {
                            try
                            {
                                if (otItemReader["IdOT"] != DBNull.Value)
                                {
                                    if (otShippingDetails.Any(osd => osd.IdOT == Convert.ToInt64(otItemReader["IdOT"])))
                                    {
                                        OTShippingDetail otShippingDetail = otShippingDetails.Where(osd => osd.IdOT == Convert.ToInt64(otItemReader["IdOT"])).FirstOrDefault();

                                        if (otShippingDetail.DeliveringItems == null)
                                        {
                                            otShippingDetail.DeliveringItems = new List<OtItemShippingDetail>();
                                        }

                                        OtItemShippingDetail otItemShippingDetail = new OtItemShippingDetail();

                                        otItemShippingDetail.POCode = otShippingDetail.POCode;
                                        otItemShippingDetail.OTCode = otShippingDetail.OTCode;

                                        if (otItemReader["Item"] != DBNull.Value)
                                            otItemShippingDetail.Item = Convert.ToString(otItemReader["Item"]);
                                        if (otItemReader["Reference"] != DBNull.Value)
                                            otItemShippingDetail.Reference = Convert.ToString(otItemReader["Reference"]);
                                        if (otItemReader["Description"] != DBNull.Value)
                                            otItemShippingDetail.Description = Convert.ToString(otItemReader["Description"]);
                                        if (otItemReader["Quantity"] != DBNull.Value)
                                            otItemShippingDetail.Quantity = Convert.ToInt64(otItemReader["Quantity"]);

                                        otShippingDetail.DeliveringItems.Add(otItemShippingDetail);
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetReadyForShippingOTItems_V2042(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                    if (dataSet.Tables[2] != null && dataSet.Tables[2].Rows.Count > 0)
                    {

                        foreach (DataRow otItemReader in dataSet.Tables[2].Rows)
                        {
                            try
                            {
                                if (otItemReader["IdOT"] != DBNull.Value)
                                {
                                    if (otShippingDetails.Any(osd => osd.IdOT == Convert.ToInt64(otItemReader["IdOT"])))
                                    {
                                        OTShippingDetail otShippingDetail = otShippingDetails.Where(osd => osd.IdOT == Convert.ToInt64(otItemReader["IdOT"])).FirstOrDefault();

                                        if (otShippingDetail.NotDeliveringItems == null)
                                        {
                                            otShippingDetail.NotDeliveringItems = new List<OtItemShippingDetail>();
                                        }

                                        OtItemShippingDetail otItemShippingDetail = new OtItemShippingDetail();

                                        otItemShippingDetail.POCode = otShippingDetail.POCode;
                                        otItemShippingDetail.OTCode = otShippingDetail.OTCode;

                                        if (otItemReader["Item"] != DBNull.Value)
                                            otItemShippingDetail.Item = Convert.ToString(otItemReader["Item"]);
                                        if (otItemReader["Reference"] != DBNull.Value)
                                            otItemShippingDetail.Reference = Convert.ToString(otItemReader["Reference"]);
                                        if (otItemReader["Description"] != DBNull.Value)
                                            otItemShippingDetail.Description = Convert.ToString(otItemReader["Description"]);

                                        if (otItemReader["Quantity"] != DBNull.Value)
                                            otItemShippingDetail.Quantity = Convert.ToInt64(otItemReader["Quantity"]);
                                        if (otItemReader["observations"] != DBNull.Value)
                                            otItemShippingDetail.Observation = Convert.ToString(otItemReader["observations"]);
                                        if (otItemReader["ExpectedSupplierDeliveryDate"] != DBNull.Value)
                                        {
                                            if (Convert.ToString(otItemReader["ExpectedSupplierDeliveryDate"]).ToUpper() != "TBD")
                                            {

                                                DateTime dtExpectedSupplierDelivery = Convert.ToDateTime(Convert.ToDateTime(otItemReader["ExpectedSupplierDeliveryDate"]).ToString("dd / MM / yyyy"));
                                                otItemShippingDetail.ExpectedSupplierDelivery = dtExpectedSupplierDelivery.ToShortDateString();
                                            }
                                            else
                                            {
                                                otItemShippingDetail.ExpectedSupplierDelivery = Convert.ToString(otItemReader["ExpectedSupplierDeliveryDate"]);
                                            }
                                        }


                                        otShippingDetail.NotDeliveringItems.Add(otItemShippingDetail);
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetReadyForShippingOTItems_V2042(). ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                }
       

            foreach (var itemotShippingDetail in otShippingDetails.GroupBy(osd => osd.SiteShortName))
            {

                try
                {
                    if (itemotShippingDetail.Any(io => io.EmailTo != null && io.EmailTo != string.Empty))
                    {
                        if (itemotShippingDetail.Any(iosd => iosd.HTMLFileName != null && iosd.HTMLFileName != string.Empty))
                        {
                            string body = File.ReadAllText(emailTemplatePath + "/" + itemotShippingDetail.Where(iosd => iosd.HTMLFileName != null && iosd.HTMLFileName != string.Empty).Select(iosd => iosd.HTMLFileName.ToString()).FirstOrDefault());


                            StringBuilder strDeliveringItems = new StringBuilder();
                            StringBuilder strNotDeliveringItems = new StringBuilder();
                            StringBuilder strOfferAssignee = new StringBuilder();

                            bool isOfferAssignee = false;
                            bool isDeliveringItems = false;
                            bool isNotDeliveringItems = false;
                            List<string> LstOfferAssignee = new List<string>();
                            foreach (OTShippingDetail itemotShippingDetailchild in itemotShippingDetail.OrderBy(ob => ob.OTCode))
                            {
                                if (!string.IsNullOrEmpty(itemotShippingDetailchild.OfferAssigneeName))
                                {
                                    if (isOfferAssignee == false)
                                    {
                                        isOfferAssignee = true;
                                    }
                                    if (!LstOfferAssignee.Any(loa => loa.ToString() == itemotShippingDetailchild.OfferAssigneeName))
                                    {
                                        LstOfferAssignee.Add(itemotShippingDetailchild.OfferAssigneeName);
                                        if (!string.IsNullOrEmpty(itemotShippingDetailchild.OfferAssigneeEmail))
                                            strOfferAssignee.Append("<p style=\"font-size: 18px; text-indent: 10px;\">" + itemotShippingDetailchild.OfferAssigneeName + " (" + itemotShippingDetailchild.OfferAssigneeEmail + ")</p>");
                                        else
                                            strOfferAssignee.Append("<p style=\"font-size: 18px; text-indent: 10px;\">" + itemotShippingDetailchild.OfferAssigneeName + "</p>");
                                    }
                                }


                                if (itemotShippingDetailchild.DeliveringItems != null && itemotShippingDetailchild.DeliveringItems.Count > 0)
                                {
                                    if (isDeliveringItems == false)
                                    {
                                        isDeliveringItems = true;
                                    }
                                    itemotShippingDetailchild.DeliveringItems = GetListSortedByItems(itemotShippingDetailchild.DeliveringItems);
                                    foreach (OtItemShippingDetail itemDT in itemotShippingDetailchild.DeliveringItems)
                                    {
                                        strDeliveringItems.AppendLine("<tr>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.POCode + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.OTCode + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.Item + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.Reference + "</td>");
                                        strDeliveringItems.AppendLine("<td>" + itemDT.Description + "</td>");
                                        strDeliveringItems.AppendLine("<td align='right'>" + itemDT.Quantity + "</td>");
                                        strDeliveringItems.AppendLine("</tr>");
                                    }
                                }

                                if (itemotShippingDetailchild.NotDeliveringItems != null && itemotShippingDetailchild.NotDeliveringItems.Count > 0)
                                {
                                    if (isNotDeliveringItems == false)
                                    {
                                        isNotDeliveringItems = true;
                                    }
                                    itemotShippingDetailchild.NotDeliveringItems = GetListSortedByItems(itemotShippingDetailchild.NotDeliveringItems);
                                    foreach (OtItemShippingDetail itemDT in itemotShippingDetailchild.NotDeliveringItems)
                                    {
                                        strNotDeliveringItems.AppendLine("<tr>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.POCode + "</td>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.OTCode + "</td>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.Item + "</td>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.Reference + "</td>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.Description + "</td>");
                                        strNotDeliveringItems.AppendLine("<td align='right'>" + itemDT.Quantity + "</td>");
                                        strNotDeliveringItems.AppendLine("<td>" + itemDT.Observation + "</td>");
                                        strNotDeliveringItems.AppendLine("<td align='right'>" + itemDT.ExpectedSupplierDelivery + "</td>");
                                        strNotDeliveringItems.AppendLine("</tr>");
                                    }
                                }
                            }


                            body = body.Replace("[DeliveringItems]", strDeliveringItems.ToString());


                            if (isOfferAssignee == false)
                            {
                                body = body.Replace("[OfferAssignee]", "");
                                body = body.Replace("[IsDisplayOfferAssignee]", "\"display: none; overflow: hidden; mso-hide:all; margin: 0; font-size:0; max-height:0;\"");
                            }
                            else
                            {
                                body = body.Replace("[OfferAssignee]", strOfferAssignee.ToString());
                                body = body.Replace("[IsDisplayOfferAssignee]", "\"font-size: 18px;\"");
                            }

                            if (isNotDeliveringItems == false)
                            {
                                body = body.Replace("[NotDeliveringItems]", "");
                                body = body.Replace("[IsDisplaytableStyle]", "\"display: none; overflow: hidden; mso-hide:all; margin: 0; font-size:0; max-height:0;\"");
                                body = body.Replace("[IsDisplaydivStyle]", "\"display: none; overflow: hidden; mso-hide:all; margin: 0; font-size:0; max-height:0;\"");
                                body = body.Replace("[IsDisplayborder]", "\"0\"");
                            }
                            else
                            {
                                body = body.Replace("[NotDeliveringItems]", strNotDeliveringItems.ToString());
                                body = body.Replace("[IsDisplaydivStyle]", "\"display: block;\"");
                                body = body.Replace("[IsDisplaytableStyle]", "\"text-align:center; display: block;\"");
                                body = body.Replace("[IsDisplayborder]", "\"1\"");
                            }

                            List<LinkedResource> ImgResourceList = new List<LinkedResource>();
                            //Emdep_logo
                            Bitmap emdepLogo = new Bitmap(emailTemplatePath + @"\Images\GEOS.png");
                            ImageConverter icEmdepLogo = new ImageConverter();
                            Byte[] emdepLogoBytes = (Byte[])icEmdepLogo.ConvertTo(emdepLogo, typeof(Byte[]));
                            MemoryStream imgEmdepLogo = new MemoryStream(emdepLogoBytes);
                            LinkedResource LREmdepLogo = new LinkedResource(imgEmdepLogo);
                            LREmdepLogo.ContentId = "EmbeddedContent_1";
                            LREmdepLogo.ContentLink = new Uri("cid:" + LREmdepLogo.ContentId);
                            ImgResourceList.Add(LREmdepLogo);

                            if (isDeliveringItems)
                            {
                                MailControl.SendHtmlMail(itemotShippingDetail.Select(iosd => iosd.MailSubject.ToString()).FirstOrDefault(), body, itemotShippingDetail.Where(io => io.EmailTo != null && io.EmailTo != string.Empty).Select(iosd => iosd.EmailTo.ToString()).FirstOrDefault(), (!string.IsNullOrEmpty(itemotShippingDetail.Where(io => io.EmailCC != null && io.EmailCC != string.Empty).Select(iosd => iosd.EmailCC.ToString()).FirstOrDefault())) ? Convert.ToString(itemotShippingDetail.Where(io => io.EmailCC != null && io.EmailCC != string.Empty).Select(iosd => iosd.EmailCC.ToString()).FirstOrDefault()).Split(';').ToList<string>() : new List<string>(), "WMS-noreply@emdep.com", mailServerName, mailServerPort, ImgResourceList);
                                logs.Add(new Tuple<string, string, string>("EmailSentToPlant", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), string.Format("For site {0} mail send successfully", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault())));
                            }
                            else
                                logs.Add(new Tuple<string, string, string>("NoDeliveredItemsEmailNotSendToPlant", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), string.Format("Error GetReadyForShippingOTItems_V2041(Ot Site-{0}) For site {0} No delivering item exist", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault())));

                        }
                        else
                        {
                            logs.Add(new Tuple<string, string, string>("HtmlFileNotExistEmailNotSendToPlant", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), string.Format("Error GetReadyForShippingOTItems_V2041(Ot Site-{0}) For site {0} HTMLFileName is not exist", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault())));
                        }
                    }
                    else
                    {
                        logs.Add(new Tuple<string, string, string>("EmailToNotAddedEmailNotSendToPlant", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), string.Format("Error GetReadyForShippingOTItems_V2041(Ot Site-{0}) For site {0} EmailTo is not added", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault())));
                    }
                }
                catch (Exception ex)
                {
                    logs.Add(new Tuple<string, string, string>("Exception", null, string.Format("Error GetReadyForShippingOTItems_V2042(Ot Site-{0}), ErrorMessage- {1} ", itemotShippingDetail.Select(iosd => iosd.SiteShortName).FirstOrDefault(), ex.Message)));
                }
            }

            return logs;
        }

        public byte[] GetArticleImageInBytes(string ImagePath, string articleVisualAidsPath)
        {
            byte[] bytes = null;
            try
            {
                 if (!string.IsNullOrEmpty(ImagePath))
                    bytes = GetArticleImageInBytesByPath(articleVisualAidsPath, ImagePath);
                  
            }

            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetArticleImageInBytes() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            return bytes;
        }

        public byte[] GetArticleImageInBytesByPath(string ArticleVisualAidsPath, string imagePath)
        {
            if (!Directory.Exists(ArticleVisualAidsPath))
            {
                return null;
            }

            string fileUploadPath = ArticleVisualAidsPath + imagePath;

            if (!File.Exists(fileUploadPath))
            {
                return null;
            }

            if (!string.IsNullOrEmpty(imagePath))
            {

                byte[] bytes = null;

                try
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(fileUploadPath, System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;

                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }

                    return bytes;
                }
              
                catch (Exception ex)
                {
                    Log4NetLogger.Logger.Log(string.Format("Error GetArticleImageInBytesByPath() article ImagePath-{0}. ErrorMessage- {1}", imagePath, ex.Message), category: Category.Exception, priority: Priority.Low);
                    //throw;
                }
            }

            return null;
        }


        public List<OtItem> GetPendingMaterialArticles_V2044(Warehouses warehouse,string countryIconFilePath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OtItem> otItems = new List<OtItem>();
            List<string> countryISOs = new List<string>();
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetPendingMaterialArticles_V2044", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 3000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                OtItem otItem = new OtItem();
                                if (reader["IdOTItem"] != DBNull.Value)
                                {
                                    otItem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                                    if (reader["IdOT"] != DBNull.Value)
                                        otItem.IdOT = Convert.ToInt64(reader["IdOT"]);

                                    otItem.RevisionItem = new RevisionItem();

                                    if (reader["ActualQty"] != DBNull.Value)
                                        otItem.RevisionItem.Quantity = Convert.ToInt64(reader["ActualQty"]);

                                    if (reader["DownloadedQty"] != DBNull.Value)
                                        otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(reader["DownloadedQty"]);

                                    if (reader["RemainingQty"] != DBNull.Value)
                                        otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(reader["RemainingQty"]);

                                    if (reader["IdArticle"] != DBNull.Value)
                                    {
                                        otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                        otItem.RevisionItem.WarehouseProduct.Article = new Article();
                                        otItem.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                                        otItem.RevisionItem.WarehouseProduct.Article.Reference = Convert.ToString(reader["Reference"]);
                                        otItem.RevisionItem.WarehouseProduct.Article.Description = Convert.ToString(reader["Description"]);
                                        otItem.RevisionItem.WarehouseProduct.Article.MyWarehouse = new MyWarehouse();
                                        if (reader["ArticleCurrenctStock"] != DBNull.Value)
                                            otItem.RevisionItem.WarehouseProduct.Article.MyWarehouse.CurrentStock = Convert.ToInt64(reader["ArticleCurrenctStock"]);
                                        if (reader["ArticleMinimumStock"] != DBNull.Value)
                                            otItem.RevisionItem.WarehouseProduct.Article.MyWarehouse.MinimumStock = Convert.ToInt64(reader["ArticleMinimumStock"]);
                                    }

                                    otItem.Ot = new Ots();
                                    if (reader["MergeCode"] != DBNull.Value)
                                        otItem.Ot.Code = Convert.ToString(reader["MergeCode"]);

                                    if (reader["IdSite"] != DBNull.Value)
                                    {
                                        otItem.Ot.Quotation = new Quotation();

                                        otItem.Ot.Quotation.Site = new Company();
                                        otItem.Ot.Quotation.Site.Name = Convert.ToString(reader["SiteName"]);

                                        otItem.Ot.Quotation.Site.Country = new Country();
                                        otItem.Ot.Quotation.Site.Country.Name = Convert.ToString(reader["Country"]);
                                        if (reader["CountryISO"] != DBNull.Value)
                                        {
                                            otItem.Ot.Quotation.Site.Country.Iso = Convert.ToString(reader["CountryISO"]);

                                            if(!countryISOs.Any(co=>co.ToString()== otItem.Ot.Quotation.Site.Country.Iso))
                                            {
                                                countryISOs.Add(otItem.Ot.Quotation.Site.Country.Iso);
                                            }
                                        }

                                        otItem.Ot.Quotation.Site.Customer = new Customer();
                                        otItem.Ot.Quotation.Site.Customer.CustomerName = Convert.ToString(reader["CustomerGroup"]);

                                        otItem.Ot.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                    }

                                }

                                otItems.Add(otItem);
                            }
                            catch (Exception ex)
                            {
                                reader.Close();
                                mySqlConnection.Close();
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialArticles_V2044() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }

            foreach (string item in countryISOs)
            {
                byte[] bytes = null;
                bytes = GetCountryIconFileInBytes(item, countryIconFilePath);
                otItems.Where(oi => oi.Ot.Quotation.Site.Country.Iso == item).ToList().ForEach(oi => oi.Ot.Quotation.Site.Country.CountryIconBytes = bytes);
            }

            return otItems;
        }

        public byte[] GetCountryIconFileInBytes(string countryiso,string filepath)
        {
            byte[] bytes = null;
            try
            {
                string filenamepng = countryiso + ".png";
                string filenamejpg = countryiso + ".jpg";
                string filepathjpg = Path.Combine(filepath, filenamejpg);
                string filepathpng = Path.Combine(filepath, filenamepng);

                if (File.Exists(filepathjpg))
                {

                    using (System.IO.FileStream stream = new System.IO.FileStream(filepathjpg, System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;
                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }
                }
                else if (File.Exists(filepathpng))
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(filepathpng, System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;
                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }
                }
                return bytes;

            }
            catch (FileNotFoundException ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetCountryIconFileInBytes() ISO-{0}. ErrorMessage- {1}", countryiso, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            catch (DirectoryNotFoundException ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetCountryIconFileInBytes() ISO-{0}. ErrorMessage- {1}", countryiso, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
            catch (Exception ex)
            {
                Log4NetLogger.Logger.Log(string.Format("Error GetCountryIconFileInBytes() ISO-{0}. ErrorMessage- {1}", countryiso, ex.Message), category: Category.Exception, priority: Priority.Low);
                throw;
            }
        }

        public Article GetArticleDetailsByReference_V2044(string reference, string articleVisualAidsPath, Warehouses warehouse, string countryIconFilePath,DateTime? fromDate = null, DateTime? toDate = null)
        {
            Article article = new Article();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetArticleDetailsByReference_V2038", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_Reference", reference);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 8000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        try
                        {
                            if (reader["idArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(reader["idArticle"]);

                            if (reader["IdArticleCategory"] != DBNull.Value)
                            {
                                article.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory = new ArticleCategory();
                                article.ArticleCategory.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory.Name = Convert.ToString(reader["categoryName"]);
                                article.ArticleCategory.TaricCode = Convert.ToString(reader["TaricCode"]);
                            }

                            if (reader["ImagePath"] != DBNull.Value)
                            {
                                article.ImagePath = Convert.ToString(reader["ImagePath"]);

                                if (!string.IsNullOrEmpty(article.ImagePath))
                                    article.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, article);
                            }

                            if (reader["Reference"] != DBNull.Value)
                                article.Reference = reader["Reference"].ToString();

                            if (reader["IsOrientativeVisualAid"] != DBNull.Value)
                                article.IsOrientativeVisualAid = Convert.ToByte(reader["IsOrientativeVisualAid"]);

                            if (reader["IsGeneric"] != DBNull.Value)
                                article.IsGeneric = Convert.ToSByte(reader["IsGeneric"]);

                            if (reader["isObsolete"] != DBNull.Value)
                                article.IsObsolete = Convert.ToSByte(reader["isObsolete"]);

                            if (reader["isPublic"] != DBNull.Value)
                                article.IsPublic = Convert.ToSByte(reader["isPublic"]);

                            if (reader["publishOnWeb"] != DBNull.Value)
                                article.PublishOnWeb = Convert.ToSByte(reader["publishOnWeb"]);

                            if (reader["registerSerialNumber"] != DBNull.Value)
                                article.RegisterSerialNumber = Convert.ToByte(reader["registerSerialNumber"]);

                            if (reader["CreatedIn"] != DBNull.Value)
                                article.CreatedIn = Convert.ToDateTime(reader["CreatedIn"]);

                            if (reader["ModifiedIn"] != DBNull.Value)
                                article.ModifiedIn = Convert.ToDateTime(reader["ModifiedIn"]);

                            if (reader["description"] != DBNull.Value)
                                article.Description = Convert.ToString(reader["description"]);

                            if (reader["description_es"] != DBNull.Value)
                                article.Description_es = Convert.ToString(reader["description_es"]);

                            if (reader["description_fr"] != DBNull.Value)
                                article.Description_fr = Convert.ToString(reader["description_fr"]);

                            if (reader["description_pt"] != DBNull.Value)
                                article.Description_pt = Convert.ToString(reader["description_pt"]);

                            if (reader["description_ro"] != DBNull.Value)
                                article.Description_ro = Convert.ToString(reader["description_ro"]);

                            if (reader["description_ru"] != DBNull.Value)
                                article.Description_ru = Convert.ToString(reader["description_ru"]);

                            if (reader["description_zh"] != DBNull.Value)
                                article.Description_zh = Convert.ToString(reader["description_zh"]);

                            if (reader["idReplacementArticle"] != DBNull.Value)
                            {
                                article.IdReplacementArticle = Convert.ToInt32(reader["idReplacementArticle"]);
                                article.ReplacementArticle = Convert.ToString(reader["ReplacementArticle"]);
                            }

                            if (reader["isBatch"] != DBNull.Value)
                                article.IsBatch = Convert.ToByte(reader["isBatch"]);

                            if (reader["taric"] != DBNull.Value)
                                article.Taric = Convert.ToString(reader["taric"]);

                            if (reader["IdArticleType"] != DBNull.Value)
                            {
                                article.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                article.ArticlesType = new ArticleType();
                                article.ArticlesType.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                if (reader["ArticleTypeName"] != DBNull.Value)
                                    article.ArticlesType.Name = Convert.ToString(reader["ArticleTypeName"]);
                            }


                            if (reader["Weight"] != DBNull.Value)
                                article.Weight = Convert.ToDecimal(reader["Weight"]);

                            if (reader["Width"] != DBNull.Value)
                                article.Width = (float)(reader["Width"]);

                            if (reader["Length"] != DBNull.Value)
                                article.Length = (float)(reader["Length"]);

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)(reader["Height"]);


                            if (reader["idCountry"] != DBNull.Value)
                            {
                                article.IdCountry = Convert.ToInt32(reader["idCountry"]);

                                article.Country = new Country();
                                article.Country.IdCountry = Convert.ToByte(reader["idCountry"]);
                                article.Country.Name = Convert.ToString(reader["CountryName"]);


                            }

                            if (reader["articleSleepDate"] != DBNull.Value)
                            {
                                article.ArticleSleepDate = Convert.ToDateTime(reader["articleSleepDate"]);
                                article.ArticleSleepDays = (Int32)(DateTime.Now - article.ArticleSleepDate.Value.Date).TotalDays;
                            }

                            article.MyWarehouse = new MyWarehouse();

                            if (reader["minimumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MinimumStock = Convert.ToInt64(reader["minimumStock"]);
                            }

                            if (reader["stock"] != DBNull.Value)
                            {
                                article.MyWarehouse.CurrentStock = Convert.ToInt64(reader["stock"]);
                            }

                            if (reader["maximumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MaximumStock = Convert.ToInt64(reader["maximumStock"]);
                            }

                            if (reader["idWareHouse"] != DBNull.Value)
                            {
                                article.MyWarehouse.IdWarehouse = Convert.ToInt64(reader["idWareHouse"]);
                            }

                            if (reader["location"] != DBNull.Value)
                            {
                                article.MyWarehouse.Location = Convert.ToString(reader["location"]);
                            }

                            if (reader["MaterialType"] != DBNull.Value)
                                article.MaterialType = Convert.ToInt64(reader["MaterialType"].ToString());
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleDetailsByReference_V2041(). Reference- {0} IdArticle-{1} ErrorMessage- {2}", reference, article.IdArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
                article.LstArticleBySupplier = new List<ArticleBySupplier>();
                article.LstArticleBySupplier = GetArticleSupplierDetailsByIdArticle_V2044(connectionString, article.IdArticle, countryIconFilePath);

                article.LstArticleDecomposition = new List<ArticleDecomposition>();
                article.LstArticleDecomposition = GetArticleDeCompostionByIdArticle(connectionString, article.IdArticle);

                article.LstRelatedArticle = new List<RelatedArticle>();
                article.LstRelatedArticle = GetRelatedArticleDetailsByIdArticle(connectionString, article.IdArticle, warehouse.IdWarehouse);

                article.LstArticleDocument = new List<ArticleDocument>();
                article.LstArticleDocument = GetArticleAttachmentByIdArticle(connectionString, article.IdArticle);

                if (article.RegisterSerialNumber == 1)
                {
                    article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                    article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockIncludingSerialNumber(connectionString, article.IdArticle, warehouse.IdWarehouse);
                    // article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle_V2034(connectionString, article.IdArticle, warehouse.IdWarehouse);
                }
                else
                {
                    article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                    article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle_V2034(connectionString, article.IdArticle, warehouse.IdWarehouse);
                }

                article.LstManufacturersByArticles = new List<ManufacturersByArticle>();
                article.LstManufacturersByArticles = GetManufacturers_V2044(connectionString, article.IdArticle,countryIconFilePath);

                //if (fromDate != null && toDate != null)
                //{
                article.LstArticlesStock = new List<ArticlesStock>();
                article.LstArticlesStock = GetStockHistoryByIdArticle_V2033(connectionString, article.IdArticle, DateTime.Now, DateTime.Now, warehouse.IdWarehouse);
                // }


                article.LstArticleForecast = new List<ArticleForecast>();
                article.LstArticleForecast = GetArticleForecast_V2037(connectionString, article.IdArticle, warehouse.IdWarehouse);

                article.LstArticleComment = new List<ArticleComment>();
                article.LstArticleComment = GetArticleComments(connectionString, article.IdArticle, warehouse.IdWarehouse);

            }

            return article;
        }

        public List<ArticleBySupplier> GetArticleSupplierDetailsByIdArticle_V2044(string connectionString, Int32 idArticle ,string countryIconFilePath)
        {
            List<ArticleBySupplier> articleBySupplierLst = new List<ArticleBySupplier>();
            List<string> countryISOs = new List<string>();
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetArticleSupplierDetailsByIdArticle_V2044", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdArticle", idArticle);


                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ArticleBySupplier articleBySupplier = new ArticleBySupplier();
                        try
                        {
                            if (reader["idarticlesupplier"] != DBNull.Value)
                            {
                                articleBySupplier.IdArticleSupplier = Convert.ToInt64(reader["idarticlesupplier"]);
                                articleBySupplier.ArticleSupplier = new ArticleSupplier();
                                articleBySupplier.ArticleSupplier.IdArticleSupplier = Convert.ToInt64(reader["idarticlesupplier"]);
                            }


                            if (reader["idarticlesupplier"] != DBNull.Value)
                            {
                                articleBySupplier.ArticleSupplier = new ArticleSupplier();
                                articleBySupplier.ArticleSupplier.IdArticleSupplier = Convert.ToInt64(reader["idarticlesupplier"]);
                              
                                if (reader["idarticlesuppliertype"] != DBNull.Value)
                                {
                                    articleBySupplier.ArticleSupplier.IdArticleSupplierType = Convert.ToInt32(reader["idarticlesuppliertype"]);

                                    articleBySupplier.ArticleSupplier.ArticleSupplierType = new ArticleSupplierType();
                                    articleBySupplier.ArticleSupplier.ArticleSupplierType.IdArticleSupplierType = Convert.ToInt32(reader["idarticlesuppliertype"]);
                                    articleBySupplier.ArticleSupplier.ArticleSupplierType.Name = Convert.ToString(reader["ArticleSupplierType"]);
                                    articleBySupplier.ArticleSupplier.ArticleSupplierType.HtmlColor = Convert.ToString(reader["htmlcolor"]);
                                }

                                articleBySupplier.ArticleSupplier.Name = Convert.ToString(reader["name"]);
                              

                                if (reader["idcountry"] != DBNull.Value)
                                {
                                    articleBySupplier.ArticleSupplier.IdCountry = Convert.ToInt64(reader["idcountry"]);
                                    articleBySupplier.ArticleSupplier.Country = new Country();
                                    articleBySupplier.ArticleSupplier.Country.IdCountry = Convert.ToByte(reader["idcountry"]);
                                    articleBySupplier.ArticleSupplier.Country.Name = Convert.ToString(reader["CountryName"]);
                                    if (reader["CountryISO"] != DBNull.Value)
                                    {
                                        articleBySupplier.ArticleSupplier.Country.Iso = Convert.ToString(reader["CountryISO"]);

                                        if (!countryISOs.Any(co => co.ToString() == articleBySupplier.ArticleSupplier.Country.Iso))
                                        {
                                            countryISOs.Add(articleBySupplier.ArticleSupplier.Country.Iso);
                                        }
                                    }

                                }

                               


                            }

                             articleBySupplier.Reference = Convert.ToString(reader["reference"]);
                            articleBySupplier.Description = Convert.ToString(reader["description"]);

                            if (reader["isthefavorite"] != DBNull.Value)
                            {
                                articleBySupplier.IsTheFavorite = Convert.ToByte(reader["isthefavorite"]);
                            }

                            if (reader["PurchaseQty"] != DBNull.Value)
                            {
                                articleBySupplier.PurchaseQty = Convert.ToInt64(reader["PurchaseQty"]);
                            }





                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleSupplierDetailsByIdArticle_V2044(). IdArticle- {0} Idarticlesupplier-{1}  ErrorMessage- {2}", idArticle, articleBySupplier.IdArticleSupplier, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                        articleBySupplierLst.Add(articleBySupplier);
                    }

                }
            }

            foreach (string item in countryISOs)
            {
                byte[] bytes = null;
                bytes = GetCountryIconFileInBytes(item, countryIconFilePath);
                articleBySupplierLst.Where(asl => asl.ArticleSupplier.Country.Iso == item).ToList().ForEach(asl => asl.ArticleSupplier.Country.CountryIconBytes = bytes);
            }

            return articleBySupplierLst;
        }


        public List<ManufacturersByArticle> GetManufacturers_V2044(string connectionString, Int32 idArticle,string countryIconFilePath)
        {
            List<ManufacturersByArticle> manufacturersByArticles = new List<ManufacturersByArticle>();
            List<string> countryISOs = new List<string>();

            using (MySqlConnection connWarehousePurchaseOrderItem = new MySqlConnection(connectionString))
            {
                connWarehousePurchaseOrderItem.Open();

                MySqlCommand dNItemsCommand = new MySqlCommand("WMS_GetManufacturers_V2044", connWarehousePurchaseOrderItem);
                dNItemsCommand.CommandType = CommandType.StoredProcedure;
                dNItemsCommand.Parameters.AddWithValue("_IdArticle", idArticle);

                using (MySqlDataReader dNReader = dNItemsCommand.ExecuteReader())
                {
                    while (dNReader.Read())
                    {
                        try
                        {
                            ManufacturersByArticle manufacturersByArticle = new ManufacturersByArticle();

                            manufacturersByArticle.IdArticle = idArticle;

                            if (dNReader["IdManufacturerByArticle"] != DBNull.Value)
                                manufacturersByArticle.IdManufacturerByArticle = Convert.ToInt64(dNReader["IdManufacturerByArticle"]);

                            if (dNReader["IdManufacturer"] != DBNull.Value)
                            {
                                manufacturersByArticle.IdManufacturer = Convert.ToInt64(dNReader["IdManufacturer"]);
                                manufacturersByArticle.Manufacturer = new Manufacturer();
                                manufacturersByArticle.Manufacturer.IdManufacturer = manufacturersByArticle.IdManufacturer;
                                manufacturersByArticle.Manufacturer.Name = Convert.ToString(dNReader["Manufacturer"]);
                            }

                            if (dNReader["IdCountry"] != DBNull.Value)
                            {
                                manufacturersByArticle.IdCountry = Convert.ToInt64(dNReader["IdCountry"]);

                                manufacturersByArticle.Country = new Country();
                                manufacturersByArticle.Country.IdCountry = Convert.ToByte(manufacturersByArticle.IdCountry);
                                manufacturersByArticle.Country.Name = Convert.ToString(dNReader["Country"]);
                                if (dNReader["CountryISO"] != DBNull.Value)
                                {
                                    manufacturersByArticle.Country.Iso = Convert.ToString(dNReader["CountryISO"]);

                                    if (!countryISOs.Any(co => co.ToString() == manufacturersByArticle.Country.Iso))
                                    {
                                        countryISOs.Add(manufacturersByArticle.Country.Iso);
                                    }
                                }

                            }

                            manufacturersByArticles.Add(manufacturersByArticle);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetManufacturers_V2044(idArticle-{0}). ErrorMessage- {1}", idArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            foreach (string item in countryISOs)
            {
                byte[] bytes = null;
                bytes = GetCountryIconFileInBytes(item, countryIconFilePath);
                manufacturersByArticles.Where(ma => ma.Country.Iso == item).ToList().ForEach(ma => ma.Country.CountryIconBytes = bytes);
            }

            return manufacturersByArticles;
        }

        public List<Ots> GetPendingMaterialWorkOrdersByWarehouse_V2044(Warehouses warehouse,string countryIconFilePath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<Ots> ots = new List<Ots>();
            List<string> countryISOs = new List<string>();
            using (MySqlConnection connOts = new MySqlConnection(connectionString))
            {
                connOts.Open();

                MySqlCommand otsCommand = new MySqlCommand("WMS_GetPendingMaterialWorkOrdersByWarehouse_V2044", connOts);
                otsCommand.CommandType = CommandType.StoredProcedure;
                otsCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                otsCommand.CommandTimeout = 8000;

                using (MySqlDataReader otReader = otsCommand.ExecuteReader())
                {
                    if (otReader.HasRows)
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = new Ots();
                                ot.IdOT = Convert.ToInt64(otReader["IdOT"]);
                                ot.NumOT = Convert.ToByte(otReader["NumOT"]);

                                if (otReader["OtCode"] != DBNull.Value)
                                {
                                    ot.Code = Convert.ToString(otReader["OtCode"]);
                                    ot.MergeCode = Convert.ToString(otReader["MergeCode"]);
                                }

                                if (otReader["DeliveryDate"] != DBNull.Value)
                                {
                                    ot.DeliveryDate = Convert.ToDateTime(otReader["DeliveryDate"]);
                                    ot.Delay = (int)(ot.DeliveryDate.Value.Date - DateTime.Now.Date).TotalDays;
                                }

                                ot.Quotation = new Quotation();

                                if (otReader["IdQuotation"] != DBNull.Value)
                                {
                                    ot.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                                    ot.Quotation.IdQuotation = Convert.ToInt64(otReader["IdQuotation"]);
                                    ot.Quotation.Code = Convert.ToString(otReader["QuotationCode"]);
                                }

                                if (otReader["IdTemplate"] != DBNull.Value)
                                {
                                    ot.Quotation.IdDetectionsTemplate = Convert.ToByte(otReader["IdTemplate"]);

                                    ot.Quotation.Template = new Template();
                                    ot.Quotation.Template.IdTemplate = ot.Quotation.IdDetectionsTemplate;
                                    ot.Quotation.Template.Name = Convert.ToString(otReader["Template"]);
                                    ot.Quotation.Template.IdTemplate = Convert.ToByte(otReader["TemplateType"]);
                                }

                                if (otReader["IdOffer"] != DBNull.Value)
                                {
                                    ot.Quotation.IdOffer = Convert.ToInt64(otReader["IdOffer"]);
                                    ot.Quotation.Offer = new Offer();
                                    ot.Quotation.Offer.IdOffer = ot.Quotation.IdOffer;

                                    if (otReader["IsCritical"] != DBNull.Value)
                                        ot.Quotation.Offer.IsCritical = Convert.ToByte(otReader["IsCritical"]);

                                    if (otReader["IdStatus"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdStatus = Convert.ToInt64(otReader["IdStatus"]);
                                        ot.Quotation.Offer.GeosStatus = new GeosStatus();
                                        ot.Quotation.Offer.GeosStatus.IdOfferStatusType = Convert.ToInt64(otReader["IdStatus"]);
                                        ot.Quotation.Offer.GeosStatus.Name = Convert.ToString(otReader["OfferStatus"]);
                                        ot.Quotation.Offer.GeosStatus.HtmlColor = Convert.ToString(otReader["OfferStatusHtmlColor"]);

                                        if (otReader["IdSalesStatusType"] != DBNull.Value)
                                        {
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType = new SalesStatusType();
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.IdSalesStatusType = Convert.ToInt64(otReader["IdSalesStatusType"]);
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.Name = Convert.ToString(otReader["SalesStatusType"]);
                                            ot.Quotation.Offer.GeosStatus.SalesStatusType.HtmlColor = Convert.ToString(otReader["SalesStatusHtmlColor"]);
                                            if (otReader["SalesStatusIdImage"] != DBNull.Value)
                                                ot.Quotation.Offer.GeosStatus.SalesStatusType.IdImage = Convert.ToInt64(otReader["SalesStatusIdImage"]);
                                        }
                                    }

                                    ot.Quotation.Offer.Code = Convert.ToString(otReader["OfferCode"]);
                                    ot.Quotation.Offer.Description = Convert.ToString(otReader["Description"]);


                                    if (otReader["IdOfferType"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdOfferType = Convert.ToByte(otReader["IdOfferType"]);

                                        ot.Quotation.Offer.OfferType = new OfferType();
                                        ot.Quotation.Offer.OfferType.IdOfferType = Convert.ToByte(ot.Quotation.Offer.IdOfferType);
                                        ot.Quotation.Offer.OfferType.Name = Convert.ToString(otReader["OfferType"]);

                                        //ot.MergeCode = ot.Quotation.Code + " " + ot.Quotation.Offer.OfferType.Name + " " + ot.NumOT;
                                    }

                                    if (otReader["IdCarriageMethod"] != DBNull.Value)
                                    {
                                        ot.Quotation.Offer.IdCarriageMethod = Convert.ToByte(otReader["IdCarriageMethod"]);
                                        ot.Quotation.Offer.CarriageMethod = new LookupValue();
                                        ot.Quotation.Offer.CarriageMethod.IdLookupValue = Convert.ToByte(ot.Quotation.Offer.IdCarriageMethod);
                                        ot.Quotation.Offer.CarriageMethod.Value = Convert.ToString(otReader["CarriageMethod"]);

                                        if (otReader["CarriageImage"] != DBNull.Value)
                                            ot.Quotation.Offer.CarriageMethod.IdImage = Convert.ToInt64(otReader["CarriageImage"]);
                                    }
                                }

                                if (otReader["IdWarehouse"] != DBNull.Value)
                                {
                                    ot.Quotation.IdWarehouse = Convert.ToInt64(otReader["IdWarehouse"]);
                                }

                                if (otReader["IdSite"] != DBNull.Value)
                                {
                                    ot.Quotation.IdCustomer = Convert.ToInt32(otReader["IdSite"]);
                                    ot.Quotation.Site = new Company();
                                    ot.Quotation.Site.IdCompany = ot.Quotation.IdCustomer;
                                    ot.Quotation.Site.SiteNameWithoutCountry = Convert.ToString(otReader["SiteName"]);

                                    if (otReader["ShortName"] != DBNull.Value && !string.IsNullOrEmpty(Convert.ToString(otReader["ShortName"])))
                                    {
                                        ot.Quotation.Site.ShortName = Convert.ToString(otReader["ShortName"]);
                                        ot.Quotation.Site.Name = ot.Quotation.Site.ShortName;
                                    }
                                    else
                                    {
                                        ot.Quotation.Site.ShortName = null;
                                        ot.Quotation.Site.Name = Convert.ToString(otReader["SiteName"]);
                                    }

                                    ot.Quotation.Site.Customer = new Customer();
                                    ot.Quotation.Site.Customer.IdCustomer = Convert.ToInt32(otReader["IdCustomer"]);
                                    ot.Quotation.Site.Customer.CustomerName = Convert.ToString(otReader["CustomerName"]);

                                    if (otReader["IdCountry"] != DBNull.Value)
                                    {
                                        ot.Quotation.Site.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country = new Country();
                                        ot.Quotation.Site.Country.IdCountry = Convert.ToByte(otReader["IdCountry"]);
                                        ot.Quotation.Site.Country.Name = Convert.ToString(otReader["CountryName"]);
                                        if (otReader["CountryISO"] != DBNull.Value)
                                        {
                                            ot.Quotation.Site.Country.Iso = Convert.ToString(otReader["CountryISO"]);

                                            if (!countryISOs.Any(co => co.ToString() == ot.Quotation.Site.Country.Iso))
                                            {
                                                countryISOs.Add(ot.Quotation.Site.Country.Iso);
                                            }
                                        }

                                    }
                                }

                                if (otReader["ActualQty"] != DBNull.Value)
                                    ot.ActualQuantity = Convert.ToInt64(otReader["ActualQty"]);

                                if (otReader["DownloadedQty"] != DBNull.Value)
                                    ot.DownloadedQuantity = Convert.ToInt64(otReader["DownloadedQty"]);

                                if (otReader["PODate"] != DBNull.Value)
                                    ot.PoDate = Convert.ToDateTime(otReader["PODate"]);

                                if (otReader["ProducerCountryGroupName"] != DBNull.Value)
                                {
                                    ot.CountryGroup = new CountryGroup();
                                    ot.CountryGroup.Name = otReader["ProducerCountryGroupName"].ToString();
                                    if (otReader["ProducerCountryGroupHTMLColor"] != DBNull.Value)
                                        ot.CountryGroup.HtmlColor = otReader["ProducerCountryGroupHTMLColor"].ToString();
                                }



                                ot.RemainingQuantity = ot.ActualQuantity + ot.DownloadedQuantity;
                                if (ot.ActualQuantity > 0)
                                {
                                    ot.Status = (Int16)((Math.Abs(ot.DownloadedQuantity) / ot.ActualQuantity) * 100);
                                }
                                ot.OtItems = new List<OtItem>();
                                ots.Add(ot);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2044() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otItem = new OtItem();
                                    if (otReader["IdOT"] != DBNull.Value)
                                        otItem.IdOT = Convert.ToInt64(otReader["IdOT"]);
                                    if (otReader["IdOtItem"] != DBNull.Value)
                                        otItem.IdOTItem = Convert.ToInt64(otReader["IdOtItem"]);
                                    if (otReader["IdRevisionItem"] != DBNull.Value)
                                    {
                                        otItem.IdRevisionItem = Convert.ToInt64(otReader["IdRevisionItem"]);
                                        otItem.RevisionItem = new RevisionItem();
                                        otItem.RevisionItem.IdRevisionItem = Convert.ToInt64(otReader["IdRevisionItem"]);
                                        otItem.RevisionItem.Quantity = Convert.ToDecimal(otReader["Quantity"]);
                                        if (otReader["DownloadedQty"] != DBNull.Value)
                                            otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otReader["DownloadedQty"]);

                                        if (otReader["RemainingQty"] != DBNull.Value)
                                            otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otReader["RemainingQty"]);


                                        if (otReader["IdArticle"] != DBNull.Value)
                                        {
                                            otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();

                                            otItem.RevisionItem.WarehouseProduct.Article = new Article();
                                            otItem.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(otReader["IdArticle"]);
                                            if (otReader["IdArticleType"] != DBNull.Value)
                                            {
                                                otItem.RevisionItem.WarehouseProduct.Article.IdArticleType = Convert.ToInt64(otReader["IdArticleType"]);
                                            }
                                            if (otReader["ArticleCurrentStock"] != DBNull.Value)
                                                otItem.RevisionItem.WarehouseProduct.Article.ArticleCurrentStock = Convert.ToInt64(otReader["ArticleCurrentStock"]);

                                            if (otReader["ArticleWarehouseLocationIdArticle"] != DBNull.Value)
                                            {
                                                otItem.RevisionItem.WarehouseProduct.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                                                otItem.RevisionItem.WarehouseProduct.Article.ArticleWarehouseLocation.IdArticle = Convert.ToInt32(otReader["ArticleWarehouseLocationIdArticle"]);

                                            }
                                        }
                                    }
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    ot.OtItems.Add(otItem);
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2044() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }


                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(otReader["idotitem"])).FirstOrDefault();

                                    OtItem decomposed = new OtItem();
                                    if (otitem != null)
                                    {
                                        decomposed.IdOT = ot.IdOT;
                                        decomposed.IdOTItem = Convert.ToInt64(otReader["IdOtItem"]);

                                        if (otReader["idParent"] != DBNull.Value)
                                        {
                                            decomposed.ParentId = Convert.ToInt32(otReader["idParent"]);
                                        }
                                        decomposed.RevisionItem = new RevisionItem();
                                        decomposed.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                        decomposed.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otReader["IdWarehouseproduct"]);



                                        if (otReader["IdComponent"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otReader["IdComponent"]);
                                        }

                                        if (otReader["ParentIdArticleType"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.ParentIdArticleType = Convert.ToInt64(otReader["ParentIdArticleType"]);
                                        }

                                        if (decomposed.ParentId == -1)
                                        {
                                            if (otReader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = otitem.RevisionItem.Quantity * Convert.ToDecimal(otReader["Quantity"]);
                                        }
                                        else
                                        {
                                            decimal qty = otitem.ArticleDecomposedList.First(x => x.RevisionItem.WarehouseProduct.IdComponent == decomposed.ParentId).RevisionItem.Quantity;
                                            if (otReader["Quantity"] != DBNull.Value)
                                                decomposed.RevisionItem.Quantity = qty * Convert.ToDecimal(otReader["Quantity"]);
                                        }

                                        if (otReader["IdArticle"] != DBNull.Value)
                                        {
                                            decomposed.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otReader["IdArticle"]);
                                            decomposed.RevisionItem.WarehouseProduct.Article = new Article();
                                            decomposed.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(otReader["IdArticle"]);
                                            if (otReader["IdArticleType"] != DBNull.Value)
                                                decomposed.RevisionItem.WarehouseProduct.Article.IdArticleType = Convert.ToInt64(otReader["IdArticleType"]);
                                            if (otReader["ArticleWarehouseLocationIdArticle"] != DBNull.Value)
                                            {
                                                decomposed.RevisionItem.WarehouseProduct.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                                                decomposed.RevisionItem.WarehouseProduct.Article.ArticleWarehouseLocation.IdArticle = Convert.ToInt32(otReader["ArticleWarehouseLocationIdArticle"]);
                                            }
                                            if (otReader["ArticleCurrentStock"] != DBNull.Value)
                                                decomposed.RevisionItem.WarehouseProduct.Article.ArticleCurrentStock = Convert.ToInt64(otReader["ArticleCurrentStock"]);
                                        }

                                        // int downloaded = GetOtItemDownloadedQuantity(connectionString, decomposed.RevisionItem.WarehouseProduct.IdArticle, decomposed.IdOTItem, decomposed.RevisionItem.WarehouseProduct.IdComponent, Convert.ToInt64(warehouseIds));


                                        decomposed.RevisionItem.DownloadedQuantity = 0;

                                        //  decomposed.RevisionItem.RemainingQuantity = ((Int64)decomposed.RevisionItem.Quantity - downloaded);




                                        otitem.ArticleDecomposedList.Add(decomposed);

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2044() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                        // ots = ots.Where(x => x.RemainingQuantity > 0).ToList();
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(otReader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(otReader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(otReader["idarticle"]) && i.RevisionItem.WarehouseProduct.IdComponent == Convert.ToInt64(otReader["idwarehouseproductcomponent"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (otReader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(otReader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2044() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (otReader.NextResult())
                    {
                        while (otReader.Read())
                        {
                            try
                            {
                                Ots ot = ots.FirstOrDefault(x => x.IdOT == Convert.ToInt64(otReader["IdOT"]));
                                if (ot != null)
                                {
                                    OtItem otitem = ot.OtItems.Where(x => x.IdOTItem == Convert.ToInt64(otReader["idotitem"])).FirstOrDefault();

                                    if (otitem != null)
                                    {

                                        if (otitem.ArticleDecomposedList.Count > 0)
                                        {
                                            OtItem otitemad = otitem.ArticleDecomposedList.Where(i => i.IdOTItem == Convert.ToInt64(otReader["idotitem"]) && i.RevisionItem.WarehouseProduct.IdArticle == Convert.ToInt64(otReader["idarticle"])).FirstOrDefault();
                                            if (otitemad != null)
                                            {
                                                if (otReader["downloadedQty"] != DBNull.Value)
                                                    otitemad.RevisionItem.DownloadedQuantity = otitemad.RevisionItem.DownloadedQuantity + Convert.ToInt64(otReader["downloadedQty"]);
                                            }
                                        }

                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPendingMaterialWorkOrdersByWarehouse_V2044() 2. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }




                    foreach (Ots itemOT in ots)
                    {

                        Int64 downloadedQty = 0;
                        decimal Qty = 0;
                        foreach (OtItem itemOtitem in itemOT.OtItems)
                        {
                            if (itemOtitem.RevisionItem.WarehouseProduct.Article.IdArticleType == 4)
                            {
                                foreach (OtItem itemArticleDecomposed in itemOtitem.ArticleDecomposedList)
                                {

                                    if (itemArticleDecomposed.RevisionItem.WarehouseProduct.ParentIdArticleType != 2)
                                    {
                                        if (itemArticleDecomposed.RevisionItem.WarehouseProduct.Article.IdArticleType != 4)
                                        {
                                            if (itemArticleDecomposed.RevisionItem.WarehouseProduct.Article.ArticleWarehouseLocation != null)
                                            {
                                                itemOT.OtItemCount = itemOT.OtItemCount + 1;
                                                if (itemArticleDecomposed.RevisionItem.WarehouseProduct.Article.ArticleCurrentStock == 0)
                                                {
                                                    itemOT.OutOfStockItemCount = itemOT.OutOfStockItemCount + 1;
                                                }
                                            }

                                        }
                                    }
                                }
                            }
                            else
                            {
                                if (itemOtitem.RevisionItem.WarehouseProduct.Article.ArticleWarehouseLocation != null)
                                {
                                    itemOT.OtItemCount = itemOT.OtItemCount + 1;
                                    if (itemOtitem.RevisionItem.WarehouseProduct.Article.ArticleCurrentStock == 0)
                                    {
                                        itemOT.OutOfStockItemCount = itemOT.OutOfStockItemCount + 1;
                                    }
                                }

                            }

                            if (itemOtitem.ArticleDecomposedList.Count > 0)
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.DownloadedQuantity));
                                Qty = Qty + itemOtitem.ArticleDecomposedList.Sum(x => x.RevisionItem.Quantity);
                                // ot.Status = (Int16)((Math.Abs(ot.DownloadedQuantity) / ot.ActualQuantity) * 100);

                            }
                            else
                            {
                                downloadedQty = downloadedQty + Math.Abs(itemOtitem.RevisionItem.DownloadedQuantity);
                                Qty = Qty + itemOtitem.RevisionItem.Quantity;
                            }

                        }
                        if (Qty > 0)
                        {
                            itemOT.Status = (Int16)((Math.Abs(downloadedQty) / Qty) * 100);
                        }
                    }
                }
            }

            ots = ots.Where(x => x.Status < 100).ToList();

            foreach (string item in countryISOs)
            {
                byte[] bytes = null;
                bytes = GetCountryIconFileInBytes(item, countryIconFilePath);
                ots.Where(ot => ot.Quotation.Site.Country.Iso == item).ToList().ForEach(ot => ot.Quotation.Site.Country.CountryIconBytes = bytes);
            }
            Log4NetLogger.Logger.Log("Executed GetPendingMaterialWorkOrdersByWarehouse_V2044().", category: Category.Info, priority: Priority.Low);
            return ots;
        }

        public List<WarehousePurchaseOrder> GetPurchaseOrdersPendingReceptionByWarehouse_V2044(Warehouses warehouse,string countryIconFilePath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<WarehousePurchaseOrder> warehousePurchaseOrders = new List<WarehousePurchaseOrder>();
            List<string> countryISOs = new List<string>();
            using (MySqlConnection connPurchaseOrders = new MySqlConnection(connectionString))
            {
                connPurchaseOrders.Open();

                MySqlCommand poCommand = new MySqlCommand("WMS_GetPurchaseOrdersPendingReceptionByWarehouse_V2044", connPurchaseOrders);
                poCommand.CommandType = CommandType.StoredProcedure;
                poCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader poReader = poCommand.ExecuteReader())
                {
                    double totalQuantity = 0;
                    double receivedQuantity = 0;

                    while (poReader.Read())
                    {
                        try
                        {
                            totalQuantity = 0;
                            receivedQuantity = 0;

                            WarehousePurchaseOrder warehousePurchaseOrder = new WarehousePurchaseOrder();

                            warehousePurchaseOrder.IdWarehousePurchaseOrder = Convert.ToInt64(poReader["idWarehousepurchaseorder"]);

                            if (poReader["Code"] != DBNull.Value)
                                warehousePurchaseOrder.Code = Convert.ToString(poReader["Code"]);

                            if (poReader["IdArticleSupplier"] != DBNull.Value)
                            {
                                ArticleSupplier articleSupplier = new ArticleSupplier();

                                articleSupplier.IdArticleSupplier = Convert.ToInt64(poReader["IdArticleSupplier"]);

                                if (poReader["Supplier"] != DBNull.Value)
                                    articleSupplier.Name = Convert.ToString(poReader["Supplier"]);

                                if (poReader["IdCountry"] != DBNull.Value)
                                {
                                    articleSupplier.IdCountry = Convert.ToInt64(poReader["IdCountry"]);

                                    articleSupplier.Country = new Country();
                                    articleSupplier.Country.IdCountry = Convert.ToByte(poReader["IdCountry"]);
                                    articleSupplier.Country.Name = Convert.ToString(poReader["CountryName"]);
                                    if (poReader["CountryISO"] != DBNull.Value)
                                    {
                                        articleSupplier.Country.Iso = Convert.ToString(poReader["CountryISO"]);

                                        if (!countryISOs.Any(co => co.ToString() == articleSupplier.Country.Iso))
                                        {
                                            countryISOs.Add(articleSupplier.Country.Iso);
                                        }
                                    }

                                }

                                warehousePurchaseOrder.ArticleSupplier = articleSupplier;
                            }

                            if (poReader["DeliveryDate"] != DBNull.Value && Convert.ToDateTime(poReader["deliveryDate"]) != DateTime.MinValue)
                            {
                                warehousePurchaseOrder.DeliveryDate = Convert.ToDateTime(poReader["deliveryDate"]);
                                warehousePurchaseOrder.Delay = (int)(warehousePurchaseOrder.DeliveryDate.Value.Date - DateTime.Now.Date).TotalDays;
                            }

                            if (poReader["AttachedPO"] != DBNull.Value)
                                warehousePurchaseOrder.AttachedPO = Convert.ToByte(poReader["AttachedPO"]);

                            if (poReader["Deliveries"] != DBNull.Value)
                            {
                                warehousePurchaseOrder.Deliveries = Convert.ToInt32(poReader["Deliveries"]);

                                if (warehousePurchaseOrder.Deliveries > 0)
                                {
                                    warehousePurchaseOrder.IsPartialPending = true;
                                }
                            }

                            if (poReader["LatestDeliveryDate"] != DBNull.Value)
                                warehousePurchaseOrder.LatestDeliveryDate = Convert.ToDateTime(poReader["LatestDeliveryDate"]);

                            if (poReader["IdWarehouse"] != DBNull.Value)
                                warehousePurchaseOrder.IdWarehouse = Convert.ToInt64(poReader["IdWarehouse"]);

                            if (poReader["OrderQty"] != DBNull.Value)
                                totalQuantity = Convert.ToDouble(poReader["OrderQty"]);

                            if (poReader["ReceivedQuantity"] != DBNull.Value)
                                receivedQuantity = Convert.ToDouble(poReader["ReceivedQuantity"]);

                            if (totalQuantity > 0)
                                warehousePurchaseOrder.Status = (Int16)((receivedQuantity / totalQuantity) * 100);

                            warehousePurchaseOrders.Add(warehousePurchaseOrder);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetPurchaseOrdersPendingReception_V2044(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            foreach (string item in countryISOs)
            {
                byte[] bytes = null;
                bytes = GetCountryIconFileInBytes(item, countryIconFilePath);
                warehousePurchaseOrders.Where(wp => wp.ArticleSupplier.Country.Iso == item).ToList().ForEach(wp => wp.ArticleSupplier.Country.CountryIconBytes = bytes);
            }

            Log4NetLogger.Logger.Log("Executed GetPurchaseOrdersPendingReception_V2044().", category: Category.Info, priority: Priority.Low);
            return warehousePurchaseOrders;
        }

        public List<WMSOrder> GetOrders(Warehouses warehouse, DateTime accountingYearFrom,DateTime accountingYearTo, string countryIconFilePath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<WMSOrder> WMSOrders = new List<WMSOrder>();
            List<string> countryISOs = new List<string>();
            using (MySqlConnection connPurchaseOrders = new MySqlConnection(connectionString))
            {
                connPurchaseOrders.Open();

                MySqlCommand poCommand = new MySqlCommand("WMS_GetOrders", connPurchaseOrders);
                poCommand.CommandType = CommandType.StoredProcedure;
                poCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                poCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                poCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);

                using (MySqlDataReader poReader = poCommand.ExecuteReader())
                {
                    while (poReader.Read())
                    {
                        try
                        {

                            WMSOrder wmsOrder = new WMSOrder();

                            if (poReader["IdOffer"] != DBNull.Value)
                                wmsOrder.IdOffer = Convert.ToInt64(poReader["IdOffer"]);

                            if (poReader["OfferCode"] != DBNull.Value)
                                wmsOrder.OfferCode = Convert.ToString(poReader["OfferCode"]);

                            if (poReader["Description"] != DBNull.Value)
                                wmsOrder.OfferDescription = Convert.ToString(poReader["Description"]);

                            if (poReader["CarriageMethod"] != DBNull.Value)
                                wmsOrder.CarriageMethod = Convert.ToString(poReader["CarriageMethod"]);

                            if (poReader["CustomerName"] != DBNull.Value)
                                wmsOrder.Group = Convert.ToString(poReader["CustomerName"]);

                            if (poReader["SiteName"] != DBNull.Value)
                                wmsOrder.Plant = Convert.ToString(poReader["SiteName"]);

                            if (poReader["IsCritical"] != DBNull.Value)
                                wmsOrder.IsCritical = Convert.ToByte(poReader["IsCritical"]);


                            if (poReader["IdCountry"] != DBNull.Value)
                            {
                                wmsOrder.IdCountry = Convert.ToByte(poReader["IdCountry"]);
                                wmsOrder.Country = new Country();
                                wmsOrder.Country.IdCountry = Convert.ToByte(poReader["IdCountry"]);
                                wmsOrder.Country.Name = Convert.ToString(poReader["CountryName"]);
                                if (poReader["CountryISO"] != DBNull.Value)
                                {
                                    wmsOrder.Country.Iso = Convert.ToString(poReader["CountryISO"]);

                                    if (!countryISOs.Any(co => co.ToString() == wmsOrder.Country.Iso))
                                    {
                                        countryISOs.Add(wmsOrder.Country.Iso);
                                    }
                                }

                            }

                            if (poReader["IsCritical"] != DBNull.Value)
                                wmsOrder.IsCritical = Convert.ToByte(poReader["IsCritical"]);

                            if (poReader["POCode"] != DBNull.Value)
                                wmsOrder.POCode = Convert.ToString(poReader["POCode"]);

                            if (poReader["OfferAssigned"] != DBNull.Value)
                                wmsOrder.OfferAssignedTo = Convert.ToString(poReader["OfferAssigned"]);

                            if (poReader["NoOfItems"] != DBNull.Value)
                                wmsOrder.NoOfItems = Convert.ToInt64(poReader["NoOfItems"]);

                            if (poReader["OfferStatus"] != DBNull.Value)
                                wmsOrder.OfferStatus = Convert.ToString(poReader["OfferStatus"]);

                            if (poReader["OfferStatusColor"] != DBNull.Value)
                                wmsOrder.OfferStatusColor = Convert.ToString(poReader["OfferStatusColor"]);

                            if (poReader["IdOfferType"] != DBNull.Value)
                            {
                                wmsOrder.IdOfferType = Convert.ToByte(poReader["IdOfferType"]);
                                wmsOrder.OfferTypeName = Convert.ToString(poReader["OfferType"]);
                            }

                            if (poReader["PoReceptionDate"] != DBNull.Value)
                            {
                                wmsOrder.PODate = Convert.ToDateTime(poReader["PoReceptionDate"]);
                              
                            }

                            WMSOrders.Add(wmsOrder);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetOrders(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                    if (poReader.NextResult())
                    {
                        while (poReader.Read())
                        {
                            try
                            {
                                if (WMSOrders.Any(wo => wo.IdOffer == Convert.ToInt64(poReader["IdOffer"])))
                                {

                                    WMSOrder wmsOrder = WMSOrders.Where(wo => wo.IdOffer == Convert.ToInt64(poReader["IdOffer"])).FirstOrDefault();


                                    if (poReader["FirstShipmentDate"] != DBNull.Value)
                                        wmsOrder.FirstShipmentDate = Convert.ToDateTime(poReader["FirstShipmentDate"]);

                                    if (poReader["DaysElapsedFirstShipment"] != DBNull.Value)
                                        wmsOrder.DaysElaspedFirstShipment = Convert.ToInt64(poReader["DaysElapsedFirstShipment"]);

                                  
                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetOrders(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    if (poReader.NextResult())
                    {
                        while (poReader.Read())
                        {
                            try
                            {
                                if (WMSOrders.Any(wo => wo.IdOffer == Convert.ToInt64(poReader["IdOffer"])))
                                {

                                    WMSOrder wmsOrder = WMSOrders.Where(wo => wo.IdOffer == Convert.ToInt64(poReader["IdOffer"])).FirstOrDefault();

                                    if (poReader["LastShipmentDate"] != DBNull.Value)
                                        wmsOrder.LastShipmentDate = Convert.ToDateTime(poReader["LastShipmentDate"]);

                                    if (poReader["DaysElapsedLastShipment"] != DBNull.Value)
                                        wmsOrder.DaysElaspedLastShipment = Convert.ToInt64(poReader["DaysElapsedLastShipment"]);

                                }
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetOrders(). ErrorMessage-" + ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }
                }
            }
            foreach (string item in countryISOs)
            {
                byte[] bytes = null;
                bytes = GetCountryIconFileInBytes(item, countryIconFilePath);
                WMSOrders.Where(o => o.Country.Iso == item).ToList().ForEach(ot => ot.Country.CountryIconBytes = bytes);
            }

            Log4NetLogger.Logger.Log("Executed GetOrders().", category: Category.Info, priority: Priority.Low);
            return WMSOrders;
        }


          public Article GetArticleDetailsByReference_V2051(string reference, string articleVisualAidsPath, Warehouses warehouse, string countryIconFilePath,DateTime? fromDate = null, DateTime? toDate = null)
        {
            Article article = new Article();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetArticleDetailsByReference_V2038", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_Reference", reference);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.CommandTimeout = 8000;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        try
                        {
                            if (reader["idArticle"] != DBNull.Value)
                                article.IdArticle = Convert.ToInt32(reader["idArticle"]);

                            if (reader["IdArticleCategory"] != DBNull.Value)
                            {
                                article.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory = new ArticleCategory();
                                article.ArticleCategory.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);
                                article.ArticleCategory.Name = Convert.ToString(reader["categoryName"]);
                                article.ArticleCategory.TaricCode = Convert.ToString(reader["TaricCode"]);
                            }

                            if (reader["ImagePath"] != DBNull.Value)
                            {
                                article.ImagePath = Convert.ToString(reader["ImagePath"]);

                                if (!string.IsNullOrEmpty(article.ImagePath))
                                    article.ArticleImageInBytes = GetArticleImageInBytes(articleVisualAidsPath, article);
                            }

                            if (reader["Reference"] != DBNull.Value)
                                article.Reference = reader["Reference"].ToString();

                            if (reader["IsOrientativeVisualAid"] != DBNull.Value)
                                article.IsOrientativeVisualAid = Convert.ToByte(reader["IsOrientativeVisualAid"]);

                            if (reader["IsGeneric"] != DBNull.Value)
                                article.IsGeneric = Convert.ToSByte(reader["IsGeneric"]);

                            if (reader["isObsolete"] != DBNull.Value)
                                article.IsObsolete = Convert.ToSByte(reader["isObsolete"]);

                            if (reader["isPublic"] != DBNull.Value)
                                article.IsPublic = Convert.ToSByte(reader["isPublic"]);

                            if (reader["publishOnWeb"] != DBNull.Value)
                                article.PublishOnWeb = Convert.ToSByte(reader["publishOnWeb"]);

                            if (reader["registerSerialNumber"] != DBNull.Value)
                                article.RegisterSerialNumber = Convert.ToByte(reader["registerSerialNumber"]);

                            if (reader["CreatedIn"] != DBNull.Value)
                                article.CreatedIn = Convert.ToDateTime(reader["CreatedIn"]);

                            if (reader["ModifiedIn"] != DBNull.Value)
                                article.ModifiedIn = Convert.ToDateTime(reader["ModifiedIn"]);

                            if (reader["description"] != DBNull.Value)
                                article.Description = Convert.ToString(reader["description"]);

                            if (reader["description_es"] != DBNull.Value)
                                article.Description_es = Convert.ToString(reader["description_es"]);

                            if (reader["description_fr"] != DBNull.Value)
                                article.Description_fr = Convert.ToString(reader["description_fr"]);

                            if (reader["description_pt"] != DBNull.Value)
                                article.Description_pt = Convert.ToString(reader["description_pt"]);

                            if (reader["description_ro"] != DBNull.Value)
                                article.Description_ro = Convert.ToString(reader["description_ro"]);

                            if (reader["description_ru"] != DBNull.Value)
                                article.Description_ru = Convert.ToString(reader["description_ru"]);

                            if (reader["description_zh"] != DBNull.Value)
                                article.Description_zh = Convert.ToString(reader["description_zh"]);

                            if (reader["idReplacementArticle"] != DBNull.Value)
                            {
                                article.IdReplacementArticle = Convert.ToInt32(reader["idReplacementArticle"]);
                                article.ReplacementArticle = Convert.ToString(reader["ReplacementArticle"]);
                            }

                            if (reader["isBatch"] != DBNull.Value)
                                article.IsBatch = Convert.ToByte(reader["isBatch"]);

                            if (reader["taric"] != DBNull.Value)
                                article.Taric = Convert.ToString(reader["taric"]);

                            if (reader["IdArticleType"] != DBNull.Value)
                            {
                                article.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                article.ArticlesType = new ArticleType();
                                article.ArticlesType.IdArticleType = Convert.ToInt64(reader["IdArticleType"]);

                                if (reader["ArticleTypeName"] != DBNull.Value)
                                    article.ArticlesType.Name = Convert.ToString(reader["ArticleTypeName"]);
                            }


                            if (reader["Weight"] != DBNull.Value)
                                article.Weight = Convert.ToDecimal(reader["Weight"]);

                            if (reader["Width"] != DBNull.Value)
                                article.Width = (float)(reader["Width"]);

                            if (reader["Length"] != DBNull.Value)
                                article.Length = (float)(reader["Length"]);

                            if (reader["Height"] != DBNull.Value)
                                article.Height = (float)(reader["Height"]);


                            if (reader["idCountry"] != DBNull.Value)
                            {
                                article.IdCountry = Convert.ToInt32(reader["idCountry"]);

                                article.Country = new Country();
                                article.Country.IdCountry = Convert.ToByte(reader["idCountry"]);
                                article.Country.Name = Convert.ToString(reader["CountryName"]);


                            }

                            if (reader["articleSleepDate"] != DBNull.Value)
                            {
                                article.ArticleSleepDate = Convert.ToDateTime(reader["articleSleepDate"]);
                                article.ArticleSleepDays = (Int32)(DateTime.Now - article.ArticleSleepDate.Value.Date).TotalDays;
                            }

                            article.MyWarehouse = new MyWarehouse();

                            if (reader["minimumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MinimumStock = Convert.ToInt64(reader["minimumStock"]);
                            }

                            if (reader["stock"] != DBNull.Value)
                            {
                                article.MyWarehouse.CurrentStock = Convert.ToInt64(reader["stock"]);
                            }

                            if (reader["maximumStock"] != DBNull.Value)
                            {
                                article.MyWarehouse.MaximumStock = Convert.ToInt64(reader["maximumStock"]);
                            }

                            if (reader["idWareHouse"] != DBNull.Value)
                            {
                                article.MyWarehouse.IdWarehouse = Convert.ToInt64(reader["idWareHouse"]);
                            }

                            if (reader["location"] != DBNull.Value)
                            {
                                article.MyWarehouse.Location = Convert.ToString(reader["location"]);
                            }

                            if (reader["MaterialType"] != DBNull.Value)
                                article.MaterialType = Convert.ToInt64(reader["MaterialType"].ToString());
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleDetailsByReference_V2041(). Reference- {0} IdArticle-{1} ErrorMessage- {2}", reference, article.IdArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
                article.LstArticleBySupplier = new List<ArticleBySupplier>();
                article.LstArticleBySupplier = GetArticleSupplierDetailsByIdArticle_V2044(connectionString, article.IdArticle, countryIconFilePath);

                article.LstArticleDecomposition = new List<ArticleDecomposition>();
                article.LstArticleDecomposition = GetArticleDeCompostionByIdArticle(connectionString, article.IdArticle);

                article.LstRelatedArticle = new List<RelatedArticle>();
                article.LstRelatedArticle = GetRelatedArticleDetailsByIdArticle(connectionString, article.IdArticle, warehouse.IdWarehouse);

                article.LstArticleDocument = new List<ArticleDocument>();
                article.LstArticleDocument = GetArticleAttachmentByIdArticle(connectionString, article.IdArticle);

                if (article.RegisterSerialNumber == 1)
                {
                    article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                    article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockIncludingSerialNumber(connectionString, article.IdArticle, warehouse.IdWarehouse);
                    // article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle_V2034(connectionString, article.IdArticle, warehouse.IdWarehouse);
                }
                else
                {
                    article.LstArticleWarehouseLocations = new List<ArticleWarehouseLocations>();
                    article.LstArticleWarehouseLocations = GetArticleWarehouseLocationStockByIdArticle_V2034(connectionString, article.IdArticle, warehouse.IdWarehouse);
                }

                article.LstManufacturersByArticles = new List<ManufacturersByArticle>();
                article.LstManufacturersByArticles = GetManufacturers_V2044(connectionString, article.IdArticle,countryIconFilePath);

                //if (fromDate != null && toDate != null)
                //{
                article.LstArticlesStock = new List<ArticlesStock>();
                article.LstArticlesStock = GetStockHistoryByIdArticle_V2033(connectionString, article.IdArticle, DateTime.Now, DateTime.Now, warehouse.IdWarehouse);
                // }


                article.LstArticleForecast = new List<ArticleForecast>();
                article.LstArticleForecast = GetArticleForecast_V2037(connectionString, article.IdArticle, warehouse.IdWarehouse);

                article.LstArticleComment = new List<ArticleComment>();
                article.LstArticleComment = GetArticleComments_V2051(connectionString, article.IdArticle, warehouse.IdWarehouse);

            }

            return article;
        }

        public bool UpdateArticleDetails_V2051(string mainServerConnectionString, Article article, string articleVisualAidsPath, string connectionString)
        {
            bool isInserted = false;
            if (article.LstArticleWarehouseLocations != null)
            {
                AddArticleWarehouseLocation(mainServerConnectionString, article.LstArticleWarehouseLocations);
                isInserted = true;
            }
            if (article.MyWarehouse != null)
            {
                TransactionScope transactionScope = null;
                try
                {
                    using (transactionScope = new TransactionScope())
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand mySqlCommand = new MySqlCommand("mywarehouse_Update", mySqlConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;
                            mySqlCommand.Parameters.AddWithValue("_IdWarehouse", article.MyWarehouse.IdWarehouse);
                            mySqlCommand.Parameters.AddWithValue("_IdArticle", article.MyWarehouse.IdArticle);
                            mySqlCommand.Parameters.AddWithValue("_MaximumStock", article.MyWarehouse.MaximumStock);
                            mySqlCommand.Parameters.AddWithValue("_MinimumStock", article.MyWarehouse.MinimumStock);

                            mySqlCommand.ExecuteNonQuery();
                            mySqlConnection.Close();


                        }


                        transactionScope.Complete();
                        transactionScope.Dispose();
                    }
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();
                    isInserted = false;
                    throw;
                }
                isInserted = true;
            }
            if (article.IsAddedArticleImage)
            {
                if (article.ImagePath != null)
                {
                    TransactionScope transactionScope = null;
                    try
                    {
                        using (transactionScope = new TransactionScope())
                        {
                            using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                            {
                                mySqlConnection.Open();

                                MySqlCommand mySqlCommand = new MySqlCommand("articles_Update", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;

                                mySqlCommand.Parameters.AddWithValue("_IdArticle", article.IdArticle);
                                mySqlCommand.Parameters.AddWithValue("_ImagePath", @"\" + article.Reference + @"\" + article.Reference + article.ImagePath);
                                mySqlCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                mySqlCommand.Parameters.AddWithValue("_ModifiedBy", article.ModifiedBy);

                                mySqlCommand.ExecuteNonQuery();
                                mySqlConnection.Close();


                            }


                            transactionScope.Complete();
                            transactionScope.Dispose();
                        }
                    }
                    catch (Exception ex)
                    {
                        if (Transaction.Current != null)
                            Transaction.Current.Rollback();

                        if (transactionScope != null)
                            transactionScope.Dispose();
                        isInserted = false;
                        throw;
                    }
                    isInserted = true;
                }
                isInserted = SaveArticleImage(articleVisualAidsPath, article);

            }
            else if (article.IsDeletedArticleImage)
            {
                if (article.ImagePath != null)
                {
                    TransactionScope transactionScope = null;
                    try
                    {
                        using (transactionScope = new TransactionScope())
                        {
                            using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                            {
                                mySqlConnection.Open();

                                MySqlCommand mySqlCommand = new MySqlCommand("articles_Update", mySqlConnection);
                                mySqlCommand.CommandType = CommandType.StoredProcedure;

                                mySqlCommand.Parameters.AddWithValue("_IdArticle", article.IdArticle);
                                mySqlCommand.Parameters.AddWithValue("_ImagePath", string.Empty);
                                mySqlCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                mySqlCommand.Parameters.AddWithValue("_ModifiedBy", article.ModifiedBy);

                                mySqlCommand.ExecuteNonQuery();
                                mySqlConnection.Close();


                            }


                            transactionScope.Complete();
                            transactionScope.Dispose();
                        }
                    }
                    catch (Exception ex)
                    {
                        if (Transaction.Current != null)
                            Transaction.Current.Rollback();

                        if (transactionScope != null)
                            transactionScope.Dispose();
                        isInserted = false;
                        throw;
                    }
                    isInserted = true;
                }
                isInserted = DeleteArticleImage(articleVisualAidsPath, article);
            }
            if (article.LogEntriesByArticles != null)
            {
                AddLogArticle(mainServerConnectionString, article.LogEntriesByArticles);
                isInserted = true;
            }
            if (article.LstArticleComment != null)
            {

                isInserted = AddUpdateDeleteArticleComment_V2051(article.LstArticleComment, mainServerConnectionString);
            }

            return isInserted;
        }

        public bool AddUpdateDeleteArticleComment_V2051(List<ArticleComment> articleComments, string mainServerConnectionString)
        {
            bool isactionPerformed = false;
            if (articleComments == null || articleComments.Count == 0)
            {
                isactionPerformed = true;
            }

            if (articleComments != null)
            {
                try
                {
                    foreach (ArticleComment item in articleComments)
                    {
                        if (item.TransactionOperation == ModelBase.TransactionOperations.Add)
                        {
                            using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                            {
                                conn.Open();

                                try
                                {
                                    MySqlCommand conCommand = new MySqlCommand("WMS_InsertArticleComments_V2051", conn);
                                    conCommand.CommandType = CommandType.StoredProcedure;
                                    conCommand.Parameters.AddWithValue("_IdWarehouse", item.IdWarehouse);
                                    conCommand.Parameters.AddWithValue("_IdArticle", item.IdArticle);
                                    conCommand.Parameters.AddWithValue("_IdStage", item.IdStage);
                                    conCommand.Parameters.AddWithValue("_Comment", item.Comment);
                                    conCommand.Parameters.AddWithValue("_IdCreator", item.IdCreator);
                                    conCommand.Parameters.AddWithValue("_CreationDate", DateTime.Now);
                                    conCommand.Parameters.AddWithValue("_DateOfExpiry", item.DateOfExpiry);

                                    item.IdArticleComment = Convert.ToInt32(conCommand.ExecuteScalar());

                                    if (item.IdArticleComment > 0)
                                    {
                                        isactionPerformed = true;
                                    }

                                    conn.Close();
                                }
                                catch (Exception ex)
                                {
                                    throw;
                                }

                            }
                        }
                        else if (item.TransactionOperation == ModelBase.TransactionOperations.Update)
                        {
                            using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                            {
                                conn.Open();

                                try
                                {
                                    MySqlCommand conCommand = new MySqlCommand("WMS_UpdateArticleComments_V2051", conn);
                                    conCommand.CommandType = CommandType.StoredProcedure;
                                    conCommand.Parameters.AddWithValue("_IdArticleComment", item.IdArticleComment);
                                    conCommand.Parameters.AddWithValue("_IdWarehouse", item.IdWarehouse);
                                    conCommand.Parameters.AddWithValue("_IdArticle", item.IdArticle);
                                    conCommand.Parameters.AddWithValue("_IdStage", item.IdStage);
                                    conCommand.Parameters.AddWithValue("_Comment", item.Comment);
                                    conCommand.Parameters.AddWithValue("_IdModifier", item.IdModifier);
                                    conCommand.Parameters.AddWithValue("_ModificationDate", DateTime.Now);
                                    conCommand.Parameters.AddWithValue("_DateOfExpiry", item.DateOfExpiry);

                                    conCommand.ExecuteNonQuery();

                                    isactionPerformed = true;

                                    conn.Close();
                                }
                                catch (Exception ex)
                                {
                                    throw;
                                }

                            }
                        }
                        else if (item.TransactionOperation == ModelBase.TransactionOperations.Delete)
                        {
                            using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                            {
                                conn.Open();

                                try
                                {
                                    MySqlCommand conCommand = new MySqlCommand("WMS_DeleteArticleComments", conn);
                                    conCommand.CommandType = CommandType.StoredProcedure;
                                    conCommand.Parameters.AddWithValue("_IdArticleComment", item.IdArticleComment);

                                    conCommand.ExecuteNonQuery();

                                    isactionPerformed = true;

                                    conn.Close();
                                }
                                catch (Exception ex)
                                {
                                    throw;
                                }

                            }
                        }
                    }

                }
                catch (Exception ex)
                {
                    throw;
                }
            }
            return isactionPerformed;
        }

        public List<ArticleComment> GetArticleComments_V2051(string connectionString, Int32 idArticle, Int64 idWarehouse)
        {
            List<ArticleComment> articleComments = new List<ArticleComment>();


            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetArticleComments_V2051", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdArticle", idArticle);
                command.Parameters.AddWithValue("_IdWarehouse", idWarehouse);
                command.CommandTimeout = 8000;
                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            ArticleComment articleComment = new ArticleComment();

                            if (reader["IdArticleComment"] != DBNull.Value)
                                articleComment.IdArticleComment = Convert.ToInt64(reader["IdArticleComment"]);

                            if (reader["IdArticle"] != DBNull.Value)
                                articleComment.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                            if (reader["Comment"] != DBNull.Value)
                                articleComment.Comment = Convert.ToString(reader["Comment"]);
                            if (reader["IdWarehouse"] != DBNull.Value)
                                articleComment.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);
                            if (reader["IdStage"] != DBNull.Value)
                            {
                                articleComment.IdStage = Convert.ToByte(reader["IdStage"]);
                                articleComment.Stage = new Stage();
                                articleComment.Stage.IdStage = Convert.ToByte(reader["IdStage"]);
                                articleComment.Stage.Name = Convert.ToString(reader["Name"]);
                            }

                            if (reader["IdCreator"] != DBNull.Value)
                                articleComment.IdCreator = Convert.ToInt32(reader["IdCreator"]);
                            if (reader["IdModifier"] != DBNull.Value)
                                articleComment.IdModifier = Convert.ToInt32(reader["IdModifier"]);
                            if (reader["ModificationDate"] != DBNull.Value)
                                articleComment.ModificationDate = Convert.ToDateTime(reader["ModificationDate"]);
                            if (reader["CreationDate"] != DBNull.Value)
                                articleComment.CreationDate = Convert.ToDateTime(reader["CreationDate"]);
                            if (reader["DateOfExpiry"] != DBNull.Value)
                                articleComment.DateOfExpiry = Convert.ToDateTime(reader["DateOfExpiry"]);

                            articleComments.Add(articleComment);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticleComments_V2051(idArticle-{0}). ErrorMessage- {1}", idArticle, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }


            return articleComments;
        }

        public List<InventoryMaterial> GetInternalUsePickArticleByIdWarehouseLocation(Warehouses warehouse, Int64 idWarehouseLocation, string articleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<InventoryMaterial> inventoryMaterials = new List<InventoryMaterial>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetInternalUsePickArticleByIdWarehouseLocation", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouseLocation", idWarehouseLocation);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.CommandTimeout = 6000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                InventoryMaterial inventoryMaterial = new InventoryMaterial();
                                if (reader["IdArticle"] != DBNull.Value)
                                    inventoryMaterial.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                if (reader["AvailableQty"] != DBNull.Value)
                                    inventoryMaterial.AvailableQty = Convert.ToInt64(reader["AvailableQty"]);

                                if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                    inventoryMaterial.IdWareHouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);

                                if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                                {
                                    inventoryMaterial.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                    inventoryMaterial.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["IdWarehouseDeliveryNote"]);
                                    if (reader["Code"] != DBNull.Value)
                                        inventoryMaterial.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                    if (reader["DeliveryDate"] != DBNull.Value)
                                        inventoryMaterial.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                }

                                if (reader["Reference"] != DBNull.Value)
                                    inventoryMaterial.Reference = Convert.ToString(reader["Reference"]);

                                if (reader["Description"] != DBNull.Value)
                                    inventoryMaterial.Description = Convert.ToString(reader["Description"]);

                                if (reader["ImagePath"] != DBNull.Value)
                                {
                                    inventoryMaterial.ImagePath = Convert.ToString(reader["ImagePath"]);
                                    inventoryMaterial.ArticleImageInBytes = GetArticleImageInBytesByImagePath(articleVisualAidsPath, inventoryMaterial.ImagePath);
                                }

                                if (reader["IdWarehouseLocation"] != DBNull.Value)
                                    inventoryMaterial.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    inventoryMaterial.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                                if (reader["ArticleWarehouseMinStock"] != DBNull.Value)
                                    inventoryMaterial.AwlMinimumStock = Convert.ToInt64(reader["ArticleWarehouseMinStock"]);

                                if (reader["WarehouseMinimumStock"] != DBNull.Value)
                                    inventoryMaterial.MinimumStock = Convert.ToInt64(reader["WarehouseMinimumStock"]);

                                if (reader["Price"] != DBNull.Value)
                                    inventoryMaterial.CostPrice = Convert.ToDouble(reader["Price"]);

                                if (reader["UnitPrice"] != DBNull.Value)
                                    inventoryMaterial.UnitPrice = Convert.ToDouble(reader["UnitPrice"]);

                                if (reader["IdOtItem"] != DBNull.Value)
                                    inventoryMaterial.IdOtitem = Convert.ToInt64(reader["IdOtItem"]);

                                if (reader["idCurrency"] != DBNull.Value)
                                    inventoryMaterial.IdCurrency = Convert.ToInt16(reader["idCurrency"]);

                                if (reader["idWarehouseProductComponent"] != DBNull.Value)
                                    inventoryMaterial.IdWarehouseProductComponent = Convert.ToInt64(reader["idWarehouseProductComponent"]);

                                inventoryMaterials.Add(inventoryMaterial);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetInternalUsePickArticleByIdWarehouseLocation() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    Log4NetLogger.Logger.Log("Executed GetInternalUsePickArticleByIdWarehouseLocation().", category: Category.Info, priority: Priority.Low);
                    return inventoryMaterials;
                }
            }
        }

        public List<InventoryMaterial> GetInternalUseRefundArticleByIdWarehouseLocation(Warehouses warehouse, Int64 idWarehouseLocation, string articleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<InventoryMaterial> inventoryMaterials = new List<InventoryMaterial>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetInternalUseRefundArticleByIdWarehouseLocation", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouseLocation", idWarehouseLocation);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.CommandTimeout = 6000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                InventoryMaterial inventoryMaterial = new InventoryMaterial();
                                if (reader["IdArticle"] != DBNull.Value)
                                    inventoryMaterial.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                if (reader["AvailableQty"] != DBNull.Value)
                                    inventoryMaterial.AvailableQty = Convert.ToInt64(reader["AvailableQty"]);

                                if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                    inventoryMaterial.IdWareHouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);

                                if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                                {
                                    inventoryMaterial.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                    inventoryMaterial.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["IdWarehouseDeliveryNote"]);
                                    if (reader["Code"] != DBNull.Value)
                                        inventoryMaterial.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                    if (reader["DeliveryDate"] != DBNull.Value)
                                        inventoryMaterial.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                }

                                if (reader["Reference"] != DBNull.Value)
                                    inventoryMaterial.Reference = Convert.ToString(reader["Reference"]);

                                if (reader["Description"] != DBNull.Value)
                                    inventoryMaterial.Description = Convert.ToString(reader["Description"]);

                                if (reader["ImagePath"] != DBNull.Value)
                                {
                                    inventoryMaterial.ImagePath = Convert.ToString(reader["ImagePath"]);
                                    inventoryMaterial.ArticleImageInBytes = GetArticleImageInBytesByImagePath(articleVisualAidsPath, inventoryMaterial.ImagePath);
                                }

                                if (reader["IdWarehouseLocation"] != DBNull.Value)
                                    inventoryMaterial.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    inventoryMaterial.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);

                                if (reader["ArticleWarehouseMinStock"] != DBNull.Value)
                                    inventoryMaterial.AwlMinimumStock = Convert.ToInt64(reader["ArticleWarehouseMinStock"]);

                                if (reader["WarehouseMinimumStock"] != DBNull.Value)
                                    inventoryMaterial.MinimumStock = Convert.ToInt64(reader["WarehouseMinimumStock"]);

                                if (reader["Price"] != DBNull.Value)
                                    inventoryMaterial.CostPrice = Convert.ToDouble(reader["Price"]);

                                if (reader["UnitPrice"] != DBNull.Value)
                                    inventoryMaterial.UnitPrice = Convert.ToDouble(reader["UnitPrice"]);

                                if (reader["IdOtItem"] != DBNull.Value)
                                    inventoryMaterial.IdOtitem = Convert.ToInt64(reader["IdOtItem"]);

                                if (reader["idCurrency"] != DBNull.Value)
                                    inventoryMaterial.IdCurrency = Convert.ToInt16(reader["idCurrency"]);

                                if (reader["idWarehouseProductComponent"] != DBNull.Value)
                                    inventoryMaterial.IdWarehouseProductComponent = Convert.ToInt64(reader["idWarehouseProductComponent"]);

                                inventoryMaterials.Add(inventoryMaterial);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetInventoryArticleByIdWarehouseLocation() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    Log4NetLogger.Logger.Log("Executed GetInventoryArticleByIdWarehouseLocation().", category: Category.Info, priority: Priority.Low);
                    return inventoryMaterials;
                }
            }
        }

        public List<OtItem> GetRemainingOtItemsByIdOt_V2051(Int64 idOt, Warehouses warehouse, string ArticleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OtItem> otItems = new List<OtItem>();
            List<OtItemSameReference> OtItemSameReferences = new List<OtItemSameReference>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetRemainingOtItemsByIdOt", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOt", idOt);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OtItem otItem = new OtItem();

                            otItem.IdOT = idOt;

                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);



                            otItem.IsBatch = Convert.ToByte(otItemReader["IsBatch"]);

                            if (otItemReader["AttachedFiles"] != DBNull.Value)
                                otItem.AttachedFiles = Convert.ToString(otItemReader["AttachedFiles"]);

                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);
                                otItem.RevisionItem.Quantity = Convert.ToInt64(otItemReader["Quantity"]);
                                otItem.RevisionItem.UnitPrice = Convert.ToDecimal(otItemReader["UnitPrice"]);

                                if (otItemReader["CustomerCommentOT"] != DBNull.Value)
                                    otItem.RevisionItem.InternalComment = Convert.ToString(otItemReader["CustomerCommentOT"]);

                                if (otItemReader["CustomerCommentRevision"] != DBNull.Value)
                                    otItem.RevisionItem.CustomerComment = Convert.ToString(otItemReader["CustomerCommentRevision"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);

                                if (otItemReader["WpDescription"] != DBNull.Value)
                                    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["ArticleDescription"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["ArticleDescription"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    if (otItemReader["UploadedIn"] != DBNull.Value)
                                        article.UploadedIn = Convert.ToDateTime(otItemReader["UploadedIn"]);

                                    if (otItemReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                        article.IdWareHouseDeliveryNoteItem = Convert.ToInt64(otItemReader["IdWareHouseDeliveryNoteItem"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    article.MyWarehouse = new MyWarehouse();

                                    if (otItemReader["MinimumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MinimumStock"]);

                                    if (otItemReader["MaximumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MaximumStock"]);

                                    if (otItemReader["CurrentStock"] != DBNull.Value)
                                        article.MyWarehouse.CurrentStock = Convert.ToInt64(otItemReader["CurrentStock"]);


                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);

                                    otItem.Status = new ItemOTStatusType();
                                    otItem.Status.IdItemOtStatus = otItem.IdItemOtStatus;
                                    otItem.Status.Name = Convert.ToString(otItemReader["Status"]);
                                }

                                if (otItemReader["AssignedTo"] != DBNull.Value)
                                {
                                    otItem.AssignedTo = Convert.ToInt32(otItemReader["AssignedTo"]);

                                    otItem.AssignedToUser = new People();
                                    otItem.AssignedToUser.Name = Convert.ToString(otItemReader["AssignedName"]);
                                    otItem.AssignedToUser.Surname = Convert.ToString(otItemReader["AssignedSurname"]);
                                }

                                if (otItemReader["DownloadedQty"] != DBNull.Value)
                                    otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otItemReader["DownloadedQty"]);

                                if (otItemReader["RemainingQty"] != DBNull.Value)
                                    otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otItemReader["RemainingQty"]);

                                if (otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;


                                List<OtItem> decomposedOtItems = GetArticlesForDecompositionScan_V2051(warehouse, idOt, otItem, ArticleVisualAidsPath, OtItemSameReferences, otItem.RevisionItem.WarehouseProduct.Article.IdArticleType);

                                //if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                //    otItems.AddRange(decomposedOtItems);



                                if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                {
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    otItem.ArticleDecomposedList = decomposedOtItems;
                                }


                                FillPickingMaterial_V2051(otItem, warehouse, ArticleVisualAidsPath, otItems, OtItemSameReferences);
                            }

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRemainingOtItemsByIdOt_V2051(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetRemainingOtItemsByIdOt_V2051().", category: Category.Info, priority: Priority.Low);
            return otItems;
        }

        public List<OtItem> GetArticlesForDecompositionScan_V2051(Warehouses warehouse, Int64 idOt, OtItem parentOtItem, string ArticleVisualAidsPath, List<OtItemSameReference> otItemSameReferences, Int64 idArticleType)
        {
            List<OtItem> otItems = new List<OtItem>();

            string connectionString = warehouse.Company.ConnectPlantConstr;

            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetArticlesForDecomposition", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOTitem", parentOtItem.IdOTItem);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            // keyId++;

                            OtItem otItem = new OtItem();
                            otItem.IdOT = idOt;
                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);

                            if (otItemReader["IdItemOtStatus"] != DBNull.Value)
                                otItem.IdItemOtStatus = Convert.ToByte(otItemReader["IdItemOtStatus"]);


                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);



                                if (otItemReader["IdComponent"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otItemReader["IdComponent"]);
                                }

                                //   otItem.KeyId = keyId;

                                if (otItemReader["idParent"] != DBNull.Value)
                                {
                                    otItem.ParentId = Convert.ToInt32(otItemReader["idParent"]);
                                }

                                if (otItem.ParentId == -1)
                                {
                                    otItem.ParentId = parentOtItem.KeyId;
                                    otItem.RevisionItem.Quantity = parentOtItem.RevisionItem.Quantity * Convert.ToDecimal(otItemReader["Quantity"]);
                                }
                                else
                                {
                                    //OtItem otItem213 = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId);

                                    decimal qty = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).RevisionItem.Quantity;
                                    otItem.RevisionItem.Quantity = qty * Convert.ToDecimal(otItemReader["Quantity"]);
                                    otItem.ParentId = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).KeyId;
                                }

                                //if (otItemReader["WpDescription"] != DBNull.Value)
                                //    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["Description"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["Description"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Weight"] != DBNull.Value)
                                        article.Weight = Convert.ToDecimal(otItemReader["Weight"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);
                                }


                                int downloaded = GetOtItemDownloadedQuantity(connectionString, otItem.RevisionItem.WarehouseProduct.Article.IdArticle, otItem.IdOTItem, otItem.RevisionItem.WarehouseProduct.IdComponent, warehouse.IdWarehouse);


                                otItem.RevisionItem.DownloadedQuantity = downloaded;

                                otItem.RevisionItem.RemainingQuantity = ((Int64)otItem.RevisionItem.Quantity - downloaded);

                                if ((Int64)otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;
                            }
                            otItem.PickingMaterialsList = new List<PickingMaterials>();
                            if (idArticleType != 2)
                                FillPickingMaterial_V2051(otItem, warehouse, ArticleVisualAidsPath, otItems, otItemSameReferences);

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticlesForDecompositionScan_V2051(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }

            return otItems;
        }

        public void FillPickingMaterial_V2051(OtItem otItem, Warehouses warehouse, string ArticleVisualAidsPath, List<OtItem> otitems, List<OtItemSameReference> otItemSameReferences)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            otItem.PickingMaterialsList = new List<PickingMaterials>();
            List<PickingArticleStockDetail> pickingArticleStockDetails = new List<PickingArticleStockDetail>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetArticlesStockDetailsByIdArticle_V2051", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", otItem.RevisionItem.WarehouseProduct.Article.IdArticle);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                #region
                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {

                    while (articlesReader.Read())
                    {
                        PickingArticleStockDetail pickingArticleStockDetail = new PickingArticleStockDetail();

                        pickingArticleStockDetail.Article = new Article();
                        if (articlesReader["IdArticle"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            pickingArticleStockDetail.Article.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingArticleStockDetail.Article.Description = Convert.ToString(articlesReader["Description"]);

                            if (articlesReader["ImagePath"] != DBNull.Value)
                                pickingArticleStockDetail.Article.ImagePath = Convert.ToString(articlesReader["ImagePath"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingArticleStockDetail.Article.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                            if (articlesReader["ArticleComment"] != DBNull.Value)
                                pickingArticleStockDetail.Article.ArticleComment = Convert.ToString(articlesReader["ArticleComment"]);

                            if (articlesReader["ArticleCommentDateOfExpiry"] != DBNull.Value)
                                pickingArticleStockDetail.Article.ArticleCommentDateOfExpiry = Convert.ToDateTime(articlesReader["ArticleCommentDateOfExpiry"]);
                        }

                        if (articlesReader["awlMinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);

                        if (articlesReader["awlMaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);

                        if (articlesReader["ArticleLocationPosition"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationPosition = Convert.ToInt64(articlesReader["ArticleLocationPosition"]);

                        if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                        if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            pickingArticleStockDetail.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                        pickingArticleStockDetail.WarehouseLocation = new WarehouseLocation();
                        if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);


                            pickingArticleStockDetail.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);
                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FullName = Convert.ToString(articlesReader["Fullname"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.HtmlColor = Convert.ToString(articlesReader["HtmlColor"]);

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);
                        }


                        if (articlesReader["UnitPrice"] != DBNull.Value)
                            pickingArticleStockDetail.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                        if (articlesReader["IdCurrency"] != DBNull.Value)
                            pickingArticleStockDetail.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                        if (articlesReader["costprice"] != DBNull.Value)
                            pickingArticleStockDetail.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                        if (articlesReader["MinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                        if (articlesReader["MaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                        pickingArticleStockDetail.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (articlesReader["UploadedIn"] != DBNull.Value)
                            pickingArticleStockDetail.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);

                        if (articlesReader["DeliveryCode"] != DBNull.Value)
                        {

                            pickingArticleStockDetail.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);
                        }


                        if (articlesReader["IdCountryGroup"] != DBNull.Value)
                            pickingArticleStockDetail.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);

                        pickingArticleStockDetails.Add(pickingArticleStockDetail);
                    }
                }
                List<PickingArticleStockDetail> PickingArticleStockDetailSort = new List<PickingArticleStockDetail>();

                foreach (var itemPASD in pickingArticleStockDetails.GroupBy(i => Convert.ToDateTime(i.UploadedIn.Value.ToShortDateString())))
                {
                    foreach (var item in itemPASD.OrderBy(i => i.ArticleLocationPosition).ToList())
                    {
                        PickingArticleStockDetailSort.Add(item);
                    }
                }

                pickingArticleStockDetails = PickingArticleStockDetailSort;

                Int64 remainingQty = otItem.RevisionItem.RemainingQuantity; // download Quantity.
                foreach (PickingArticleStockDetail itemArticleStock in pickingArticleStockDetails)
                {

                    try
                    {

                        if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        {
                            Int64 articleCurrentStockRem = 0;
                            articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                            if (articleCurrentStockRem == 0)
                                continue;
                            else
                                if (remainingQty == 0)
                                return;
                        }
                        else
                        {
                            if (remainingQty == 0)
                                return;
                        }



                        PickingMaterials pickingMaterials = new PickingMaterials();

                        pickingMaterials.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        pickingMaterials.Article = new Article();
                        pickingMaterials.Article.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;
                        pickingMaterials.Article.ArticleComment = itemArticleStock.Article.ArticleComment;
                        pickingMaterials.Article.ArticleCommentDateOfExpiry = itemArticleStock.Article.ArticleCommentDateOfExpiry;
                        pickingMaterials.ArticleComment = itemArticleStock.Article.ArticleComment;
                        pickingMaterials.ArticleCommentDateOfExpiry = itemArticleStock.Article.ArticleCommentDateOfExpiry;
                        if(pickingMaterials.Article.ArticleCommentDateOfExpiry!=null)
                        {
                            if (pickingMaterials.Article.ArticleCommentDateOfExpiry.Value.Date < DateTime.Now.Date)
                            {
                                pickingMaterials.Article.ArticleComment = null;
                                pickingMaterials.ArticleComment = null;
                            }
                        }
                        pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                        pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        if (itemArticleStock.ArticleLocationMinimumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = itemArticleStock.ArticleLocationMinimumStock.Value;
                        if (itemArticleStock.ArticleLocationMaximumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = itemArticleStock.ArticleLocationMaximumStock.Value;

                        pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.IdOtitem = otItem.IdOTItem;

                        pickingMaterials.IdRevisionItem = otItem.IdRevisionItem;
                        pickingMaterials.RevisionItem = new RevisionItem();
                        pickingMaterials.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.NumItem = otItem.RevisionItem.NumItem;

                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.Quantity = otItem.RevisionItem.Quantity;

                        if (otItem.RevisionItem != null)
                            if (otItem.RevisionItem.WarehouseProduct != null)
                                pickingMaterials.IdWarehouseProductComponent = otItem.RevisionItem.WarehouseProduct.IdComponent;

                        if (!string.IsNullOrEmpty(otItem.RevisionItem.WarehouseProduct.Article.Reference))
                            pickingMaterials.Reference = otItem.RevisionItem.WarehouseProduct.Article.Reference;



                        if (itemArticleStock.ArticleCurrentStock != null)
                            pickingMaterials.ArticleCurrentStock = itemArticleStock.ArticleCurrentStock.Value;

                        if (itemArticleStock.CurrentStock != null)
                            pickingMaterials.CurrentStock = itemArticleStock.CurrentStock.Value;

                        if (itemArticleStock.CostPrice != null)
                            pickingMaterials.CostPrice = itemArticleStock.CostPrice.Value;

                        if (itemArticleStock.UnitPrice != null)
                            pickingMaterials.UnitPrice = itemArticleStock.UnitPrice.Value;


                        pickingMaterials.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        if (pickingMaterials.IdWareHouseDeliveryNoteItem != null)
                        {
                            pickingMaterials.IdWareHouseDeliveryNoteItem = itemArticleStock.IdWareHouseDeliveryNoteItem.Value;


                            pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.Manufacturer = GeManufacturerByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbers(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, itemArticleStock.WarehouseLocation.IdWarehouse));
                        }


                        pickingMaterials.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;


                        pickingMaterials.LocationFullName = itemArticleStock.WarehouseLocation.FullName;


                        pickingMaterials.Description = itemArticleStock.Article.Description;



                        if (!string.IsNullOrEmpty(itemArticleStock.Article.ImagePath))
                        {
                            pickingMaterials.ImagePath = itemArticleStock.Article.ImagePath;
                            Article article = new Article();
                            article.ImagePath = pickingMaterials.ImagePath;
                            pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                        }


                        if (itemArticleStock.MinimumStock != null)
                            pickingMaterials.MinimumStock = itemArticleStock.MinimumStock.Value;

                        if (itemArticleStock.MaximumStock != null)
                            pickingMaterials.MaximumStock = itemArticleStock.MaximumStock.Value;

                        pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (itemArticleStock.UploadedIn != null)
                        {
                            pickingMaterials.UploadedIn = itemArticleStock.UploadedIn;
                            pickingMaterials.WarehouseDeliveryNote.DeliveryDate = itemArticleStock.UploadedIn.Value;
                        }


                        pickingMaterials.WarehouseDeliveryNote.Code = itemArticleStock.WarehouseDeliveryNote.Code;


                        pickingMaterials.IdCurrency = itemArticleStock.IdCurrency;

                        if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        {
                            Int64 articleCurrentStockRem = 0;
                            articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                            if (articleCurrentStockRem > 0)
                            {
                                if (remainingQty > 0 && articleCurrentStockRem > 0)
                                {
                                    if (articleCurrentStockRem > remainingQty)
                                    {
                                        pickingMaterials.DownloadQuantity = remainingQty;
                                        remainingQty = 0;
                                    }
                                    else
                                    {
                                        pickingMaterials.DownloadQuantity = articleCurrentStockRem;
                                        remainingQty = remainingQty - articleCurrentStockRem;
                                    }

                                }
                            }
                            else
                            {
                                if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                                {
                                    if (pickingMaterials.ArticleCurrentStock > remainingQty)
                                    {
                                        pickingMaterials.DownloadQuantity = remainingQty;
                                        remainingQty = 0;
                                    }
                                    else
                                    {
                                        pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                                        remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                                    }

                                }
                            }
                        }
                        else
                        {
                            if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                            {
                                if (pickingMaterials.ArticleCurrentStock > remainingQty)
                                {
                                    pickingMaterials.DownloadQuantity = remainingQty;
                                    remainingQty = 0;
                                }
                                else
                                {
                                    pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                                    remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                                }

                            }
                        }

                        pickingMaterials.WarehouseLocation = new WarehouseLocation();

                        pickingMaterials.WarehouseLocation.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        pickingMaterials.WarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.WarehouseLocation.FullName = itemArticleStock.WarehouseLocation.FullName;

                        pickingMaterials.WarehouseLocation.HtmlColor = itemArticleStock.WarehouseLocation.HtmlColor;

                        pickingMaterials.WarehouseLocation.Latitude = itemArticleStock.WarehouseLocation.Latitude;

                        pickingMaterials.WarehouseLocation.Longitude = itemArticleStock.WarehouseLocation.Longitude;

                        pickingMaterials.WarehouseLocation.Width = itemArticleStock.WarehouseLocation.Width;

                        pickingMaterials.WarehouseLocation.Height = itemArticleStock.WarehouseLocation.Height;

                        pickingMaterials.WarehouseLocation.FileName = itemArticleStock.WarehouseLocation.FileName;

                        pickingMaterials.RegisterSerialNumber = itemArticleStock.Article.RegisterSerialNumber;

                        pickingMaterials.PartNumberCode = GetPartNumberCode(otItem.IdOTItem, connectionString);

                        if (itemArticleStock.IdCountryGroup != null)
                            pickingMaterials.IdCountryGroup = itemArticleStock.IdCountryGroup.Value;

                        //Add in otSameReferenceList
                        OtItemSameReference otItemSameReference = new OtItemSameReference();
                        otItemSameReference.IdArticle = pickingMaterials.IdArticle;
                        otItemSameReference.IdWarehouseDeliveryNoteItem = pickingMaterials.IdWareHouseDeliveryNoteItem;
                        otItemSameReference.ArticleCurrentStock = pickingMaterials.ArticleCurrentStock;
                        otItemSameReference.Qty = pickingMaterials.DownloadQuantity;
                        otItemSameReference.IdWarehouseLocation = pickingMaterials.WarehouseLocation.IdWarehouseLocation;
                        otItemSameReferences.Add(otItemSameReference);

                        otItem.PickingMaterialsList.Add(pickingMaterials);

                        //GetTotalArticleDownloadDetailByOtItem(connectionString, 1800, 35259);

                    }
                    catch (Exception ex)
                    {
                        Log4NetLogger.Logger.Log(string.Format("Error FillPickingMaterial_V2051(IdArticle-{0}, idWarehouse-{1}). ErrorMessage- {2}", otItem.RevisionItem.WarehouseProduct.Article.IdArticle, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                        throw;
                    }
                }
                #endregion

            }

        }

        public List<OtItem> GetRemainingOtItemsByIdOtDisbaledFIFO_V2051(Int64 idOt, Warehouses warehouse, string ArticleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<OtItem> otItems = new List<OtItem>();
            List<OtItemSameReference> OtItemSameReferences = new List<OtItemSameReference>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetRemainingOtItemsByIdOt", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOt", idOt);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            OtItem otItem = new OtItem();

                            otItem.IdOT = idOt;

                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);



                            otItem.IsBatch = Convert.ToByte(otItemReader["IsBatch"]);

                            if (otItemReader["AttachedFiles"] != DBNull.Value)
                                otItem.AttachedFiles = Convert.ToString(otItemReader["AttachedFiles"]);

                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);
                                otItem.RevisionItem.Quantity = Convert.ToInt64(otItemReader["Quantity"]);
                                otItem.RevisionItem.UnitPrice = Convert.ToDecimal(otItemReader["UnitPrice"]);

                                if (otItemReader["CustomerCommentOT"] != DBNull.Value)
                                    otItem.RevisionItem.InternalComment = Convert.ToString(otItemReader["CustomerCommentOT"]);

                                if (otItemReader["CustomerCommentRevision"] != DBNull.Value)
                                    otItem.RevisionItem.CustomerComment = Convert.ToString(otItemReader["CustomerCommentRevision"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);

                                if (otItemReader["WpDescription"] != DBNull.Value)
                                    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["ArticleDescription"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["ArticleDescription"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    if (otItemReader["UploadedIn"] != DBNull.Value)
                                        article.UploadedIn = Convert.ToDateTime(otItemReader["UploadedIn"]);

                                    if (otItemReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                        article.IdWareHouseDeliveryNoteItem = Convert.ToInt64(otItemReader["IdWareHouseDeliveryNoteItem"]);

                                    if (otItemReader["IdArticleType"] != DBNull.Value)
                                        article.IdArticleType = Convert.ToInt64(otItemReader["IdArticleType"]);

                                    article.MyWarehouse = new MyWarehouse();

                                    if (otItemReader["MinimumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MinimumStock"]);

                                    if (otItemReader["MaximumStock"] != DBNull.Value)
                                        article.MyWarehouse.MinimumStock = Convert.ToInt64(otItemReader["MaximumStock"]);

                                    if (otItemReader["CurrentStock"] != DBNull.Value)
                                        article.MyWarehouse.CurrentStock = Convert.ToInt64(otItemReader["CurrentStock"]);


                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);

                                    otItem.Status = new ItemOTStatusType();
                                    otItem.Status.IdItemOtStatus = otItem.IdItemOtStatus;
                                    otItem.Status.Name = Convert.ToString(otItemReader["Status"]);
                                }

                                if (otItemReader["AssignedTo"] != DBNull.Value)
                                {
                                    otItem.AssignedTo = Convert.ToInt32(otItemReader["AssignedTo"]);

                                    otItem.AssignedToUser = new People();
                                    otItem.AssignedToUser.Name = Convert.ToString(otItemReader["AssignedName"]);
                                    otItem.AssignedToUser.Surname = Convert.ToString(otItemReader["AssignedSurname"]);
                                }

                                if (otItemReader["DownloadedQty"] != DBNull.Value)
                                    otItem.RevisionItem.DownloadedQuantity = Convert.ToInt64(otItemReader["DownloadedQty"]);

                                if (otItemReader["RemainingQty"] != DBNull.Value)
                                    otItem.RevisionItem.RemainingQuantity = Convert.ToInt64(otItemReader["RemainingQty"]);

                                if (otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;


                                List<OtItem> decomposedOtItems = GetArticlesForDecompositionScanDisabledFIFO_V2051(idOt, warehouse, otItem, ArticleVisualAidsPath, OtItemSameReferences, otItem.RevisionItem.WarehouseProduct.Article.IdArticleType);

                                //if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                //    otItems.AddRange(decomposedOtItems);



                                if (decomposedOtItems != null && decomposedOtItems.Count > 0)
                                {
                                    otItem.ArticleDecomposedList = new List<OtItem>();
                                    otItem.ArticleDecomposedList = decomposedOtItems;
                                }


                                FillPickingMaterialDisbaledFIFO_V2051(otItem, warehouse, ArticleVisualAidsPath, otItems);
                            }

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetRemainingOtItemsByIdOtDisbaledFIFO_V2051(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }
            }

            Log4NetLogger.Logger.Log("Executed GetRemainingOtItemsByIdOtDisbaledFIFO_V2051).", category: Category.Info, priority: Priority.Low);
            return otItems;
        }


        public List<OtItem> GetArticlesForDecompositionScanDisabledFIFO_V2051(Int64 idOt, Warehouses warehouse, OtItem parentOtItem, string ArticleVisualAidsPath, List<OtItemSameReference> otItemSameReferences, Int64 idArticleType)
        {
            List<OtItem> otItems = new List<OtItem>();

            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand otItemCommand = new MySqlCommand("warehouse_GetArticlesForDecomposition", connOtItem);
                otItemCommand.CommandType = CommandType.StoredProcedure;
                otItemCommand.Parameters.AddWithValue("_IdOTitem", parentOtItem.IdOTItem);
                otItemCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                using (MySqlDataReader otItemReader = otItemCommand.ExecuteReader())
                {
                    while (otItemReader.Read())
                    {
                        try
                        {
                            // keyId++;

                            OtItem otItem = new OtItem();
                            otItem.IdOT = idOt;
                            otItem.IdOTItem = Convert.ToInt64(otItemReader["IdOtItem"]);

                            if (otItemReader["IdItemOtStatus"] != DBNull.Value)
                                otItem.IdItemOtStatus = Convert.ToByte(otItemReader["IdItemOtStatus"]);


                            otItem.Rework = Convert.ToByte(otItemReader["Rework"]);

                            if (otItemReader["IdRevisionItem"] != DBNull.Value)
                            {
                                otItem.IdRevisionItem = Convert.ToInt64(otItemReader["IdRevisionItem"]);

                                otItem.RevisionItem = new RevisionItem();
                                otItem.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                                otItem.RevisionItem.NumItem = Convert.ToString(otItemReader["NumItem"]);

                                otItem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                                otItem.RevisionItem.WarehouseProduct.IdWarehouseProduct = Convert.ToInt64(otItemReader["IdWarehouseproduct"]);



                                if (otItemReader["IdComponent"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdComponent = Convert.ToInt64(otItemReader["IdComponent"]);
                                }

                                //   otItem.KeyId = keyId;

                                if (otItemReader["idParent"] != DBNull.Value)
                                {
                                    otItem.ParentId = Convert.ToInt32(otItemReader["idParent"]);
                                }

                                if (otItem.ParentId == -1)
                                {
                                    otItem.ParentId = parentOtItem.KeyId;
                                    otItem.RevisionItem.Quantity = parentOtItem.RevisionItem.Quantity * Convert.ToDecimal(otItemReader["Quantity"]);
                                }
                                else
                                {
                                    //OtItem otItem213 = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId);

                                    decimal qty = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).RevisionItem.Quantity;
                                    otItem.RevisionItem.Quantity = qty * Convert.ToDecimal(otItemReader["Quantity"]);
                                    otItem.ParentId = otItems.First(x => x.RevisionItem.WarehouseProduct.IdComponent == otItem.ParentId).KeyId;
                                }

                                //if (otItemReader["WpDescription"] != DBNull.Value)
                                //    otItem.RevisionItem.WarehouseProduct.Description = Convert.ToString(otItemReader["WpDescription"]);

                                if (otItemReader["IdArticle"] != DBNull.Value)
                                {
                                    otItem.RevisionItem.WarehouseProduct.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);

                                    Article article = new Article();
                                    article.IdArticle = Convert.ToInt32(otItemReader["IdArticle"]);
                                    article.IsGeneric = Convert.ToSByte(otItemReader["IsGeneric"]);
                                    article.Reference = Convert.ToString(otItemReader["Reference"]);
                                    article.IsObsolete = Convert.ToSByte(otItemReader["IsObsolete"]);

                                    if (otItemReader["Description"] != DBNull.Value)
                                        article.Description = Convert.ToString(otItemReader["Description"]);

                                    if (otItemReader["Description_es"] != DBNull.Value)
                                        article.Description_es = Convert.ToString(otItemReader["Description_es"]);

                                    if (otItemReader["Description_fr"] != DBNull.Value)
                                        article.Description_fr = Convert.ToString(otItemReader["Description_fr"]);

                                    article.ImagePath = Convert.ToString(otItemReader["ImagePath"]);
                                    article.RegisterSerialNumber = Convert.ToByte(otItemReader["RegisterSerialNumber"]);

                                    if (otItemReader["Weight"] != DBNull.Value)
                                        article.Weight = Convert.ToDecimal(otItemReader["Weight"]);

                                    if (otItemReader["Location"] != DBNull.Value)
                                        article.Location = Convert.ToString(otItemReader["Location"]);

                                    otItem.RevisionItem.WarehouseProduct.Article = article;
                                }

                                if (otItemReader["Iditemotstatus"] != DBNull.Value)
                                {
                                    otItem.IdItemOtStatus = Convert.ToByte(otItemReader["Iditemotstatus"]);
                                }


                                int downloaded = GetOtItemDownloadedQuantity(connectionString, otItem.RevisionItem.WarehouseProduct.Article.IdArticle, otItem.IdOTItem, otItem.RevisionItem.WarehouseProduct.IdComponent, warehouse.IdWarehouse);


                                otItem.RevisionItem.DownloadedQuantity = downloaded;

                                otItem.RevisionItem.RemainingQuantity = ((Int64)otItem.RevisionItem.Quantity - downloaded);

                                if ((Int64)otItem.RevisionItem.Quantity > 0)
                                    otItem.RevisionItem.Status = (Math.Abs(otItem.RevisionItem.DownloadedQuantity) / (Int64)otItem.RevisionItem.Quantity) * 100;
                            }
                            otItem.PickingMaterialsList = new List<PickingMaterials>();
                            if (idArticleType != 2)
                                FillPickingMaterialDisbaledFIFO_V2051(otItem, warehouse, ArticleVisualAidsPath, otItems);

                            otItems.Add(otItem);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetArticlesForDecompositionScanDisabledFIFO_V2051(idOt-{0}, idWarehouse-{1}). ErrorMessage- {2}", idOt, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }

                }
            }

            return otItems;
        }


        public void FillPickingMaterialDisbaledFIFO_V2051(OtItem otItem, Warehouses warehouse, string ArticleVisualAidsPath, List<OtItem> otitems)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            otItem.PickingMaterialsList = new List<PickingMaterials>();
            List<PickingArticleStockDetail> pickingArticleStockDetails = new List<PickingArticleStockDetail>();
            using (MySqlConnection connOtItem = new MySqlConnection(connectionString))
            {
                connOtItem.Open();

                MySqlCommand ArticlesCommand = new MySqlCommand("WMS_GetArticlesStockDetailsByIdArticleDisbaledFIFO_V2051", connOtItem);
                ArticlesCommand.CommandType = CommandType.StoredProcedure;
                ArticlesCommand.Parameters.AddWithValue("_IdArticle", otItem.RevisionItem.WarehouseProduct.Article.IdArticle);
                ArticlesCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);

                #region
                using (MySqlDataReader articlesReader = ArticlesCommand.ExecuteReader())
                {

                    while (articlesReader.Read())
                    {
                        PickingArticleStockDetail pickingArticleStockDetail = new PickingArticleStockDetail();

                        pickingArticleStockDetail.Article = new Article();
                        if (articlesReader["IdArticle"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            pickingArticleStockDetail.Article.IdArticle = Convert.ToInt32(articlesReader["IdArticle"]);

                            if (articlesReader["Description"] != DBNull.Value)
                                pickingArticleStockDetail.Article.Description = Convert.ToString(articlesReader["Description"]);

                            if (articlesReader["ArticleComment"] != DBNull.Value)
                                pickingArticleStockDetail.Article.ArticleComment = Convert.ToString(articlesReader["ArticleComment"]);

                            if (articlesReader["ArticleCommentDateOfExpiry"] != DBNull.Value)
                                pickingArticleStockDetail.Article.ArticleCommentDateOfExpiry = Convert.ToDateTime(articlesReader["ArticleCommentDateOfExpiry"]);

                            if (articlesReader["ImagePath"] != DBNull.Value)
                                pickingArticleStockDetail.Article.ImagePath = Convert.ToString(articlesReader["ImagePath"]);

                            if (articlesReader["RegisterSerialNumber"] != DBNull.Value)
                                pickingArticleStockDetail.Article.RegisterSerialNumber = Convert.ToByte(articlesReader["RegisterSerialNumber"]);

                        }

                        if (articlesReader["awlMinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMinimumStock = Convert.ToInt64(articlesReader["awlMinimumStock"]);

                        if (articlesReader["awlMaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationMaximumStock = Convert.ToInt64(articlesReader["awlMaximumStock"]);

                        if (articlesReader["ArticleLocationPosition"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleLocationPosition = Convert.ToInt64(articlesReader["ArticleLocationPosition"]);

                        if (articlesReader["ArticleCurrentStock"] != DBNull.Value)
                            pickingArticleStockDetail.ArticleCurrentStock = Convert.ToInt64(articlesReader["ArticleCurrentStock"]);

                        if (articlesReader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            pickingArticleStockDetail.IdWareHouseDeliveryNoteItem = Convert.ToInt64(articlesReader["IdWareHouseDeliveryNoteItem"]);

                        pickingArticleStockDetail.WarehouseLocation = new WarehouseLocation();
                        if (articlesReader["IdWarehouseLocation"] != DBNull.Value)
                        {
                            pickingArticleStockDetail.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);


                            pickingArticleStockDetail.WarehouseLocation.IdWarehouseLocation = Convert.ToInt64(articlesReader["IdWarehouseLocation"]);
                            if (articlesReader["Fullname"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FullName = Convert.ToString(articlesReader["Fullname"]);

                            if (articlesReader["IdWarehouse"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.IdWarehouse = Convert.ToInt64(articlesReader["IdWarehouse"]);

                            if (articlesReader["HtmlColor"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.HtmlColor = Convert.ToString(articlesReader["HtmlColor"]);

                            if (articlesReader["Latitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Latitude = Convert.ToDouble(articlesReader["Latitude"]);

                            if (articlesReader["Longitude"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Longitude = Convert.ToDouble(articlesReader["Longitude"]);

                            if (articlesReader["Width"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Width = Convert.ToDouble(articlesReader["Width"]);

                            if (articlesReader["Height"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.Height = Convert.ToDouble(articlesReader["Height"]);

                            if (articlesReader["FileName"] != DBNull.Value)
                                pickingArticleStockDetail.WarehouseLocation.FileName = Convert.ToString(articlesReader["FileName"]);
                        }


                        if (articlesReader["UnitPrice"] != DBNull.Value)
                            pickingArticleStockDetail.UnitPrice = Convert.ToDouble(articlesReader["UnitPrice"]);

                        if (articlesReader["IdCurrency"] != DBNull.Value)
                            pickingArticleStockDetail.IdCurrency = Convert.ToInt16(articlesReader["IdCurrency"]);

                        if (articlesReader["costprice"] != DBNull.Value)
                            pickingArticleStockDetail.CostPrice = Convert.ToDouble(articlesReader["costprice"]);

                        if (articlesReader["MinimumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MinimumStock = Convert.ToInt64(articlesReader["MinimumStock"].ToString());

                        if (articlesReader["MaximumStock"] != DBNull.Value)
                            pickingArticleStockDetail.MaximumStock = Convert.ToInt64(articlesReader["MaximumStock"].ToString());

                        pickingArticleStockDetail.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (articlesReader["UploadedIn"] != DBNull.Value)
                            pickingArticleStockDetail.UploadedIn = Convert.ToDateTime(articlesReader["UploadedIn"]);

                        if (articlesReader["DeliveryCode"] != DBNull.Value)
                        {

                            pickingArticleStockDetail.WarehouseDeliveryNote.Code = Convert.ToString(articlesReader["DeliveryCode"]);
                        }


                        if (articlesReader["IdCountryGroup"] != DBNull.Value)
                            pickingArticleStockDetail.IdCountryGroup = Convert.ToInt64(articlesReader["IdCountryGroup"]);

                        pickingArticleStockDetails.Add(pickingArticleStockDetail);
                    }
                }
                List<PickingArticleStockDetail> PickingArticleStockDetailSort = new List<PickingArticleStockDetail>();

                foreach (var itemPASD in pickingArticleStockDetails.GroupBy(i => Convert.ToDateTime(i.UploadedIn.Value.ToShortDateString())))
                {
                    foreach (var item in itemPASD.OrderBy(i => i.ArticleLocationPosition).ToList())
                    {
                        PickingArticleStockDetailSort.Add(item);
                    }
                }

                pickingArticleStockDetails = PickingArticleStockDetailSort;

                // Int64 remainingQty = otItem.RevisionItem.RemainingQuantity; // download Quantity.
                foreach (PickingArticleStockDetail itemArticleStock in pickingArticleStockDetails)
                {

                    try
                    {

                        //if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        //{
                        //    Int64 articleCurrentStockRem = 0;
                        //    articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                        //    if (articleCurrentStockRem == 0)
                        //        continue;
                        //    else
                        //        if (remainingQty == 0)
                        //        return;
                        //}
                        //else
                        //{
                        //    if (remainingQty == 0)
                        //        return;
                        //}



                        PickingMaterials pickingMaterials = new PickingMaterials();

                        pickingMaterials.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        pickingMaterials.Article = new Article();
                        pickingMaterials.Article.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;
                        pickingMaterials.Article.ArticleComment = itemArticleStock.Article.ArticleComment;
                        pickingMaterials.Article.ArticleCommentDateOfExpiry = itemArticleStock.Article.ArticleCommentDateOfExpiry;
                        pickingMaterials.ArticleComment = itemArticleStock.Article.ArticleComment;
                        pickingMaterials.ArticleCommentDateOfExpiry = itemArticleStock.Article.ArticleCommentDateOfExpiry;
                        if (pickingMaterials.Article.ArticleCommentDateOfExpiry != null)
                        {
                            if (pickingMaterials.Article.ArticleCommentDateOfExpiry.Value.Date < DateTime.Now.Date)
                            {
                                pickingMaterials.Article.ArticleComment = null;
                                pickingMaterials.ArticleComment = null;
                            }
                               
                        }
                        pickingMaterials.Article.ArticleWarehouseLocation = new ArticleWarehouseLocations();
                        pickingMaterials.Article.ArticleWarehouseLocation.IdArticle = otItem.RevisionItem.WarehouseProduct.Article.IdArticle;

                        if (itemArticleStock.ArticleLocationMinimumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MinimumStock = itemArticleStock.ArticleLocationMinimumStock.Value;
                        if (itemArticleStock.ArticleLocationMaximumStock != null)
                            pickingMaterials.Article.ArticleWarehouseLocation.MaximumStock = itemArticleStock.ArticleLocationMaximumStock.Value;

                        pickingMaterials.Article.ArticleWarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.IdOtitem = otItem.IdOTItem;

                        pickingMaterials.IdRevisionItem = otItem.IdRevisionItem;
                        pickingMaterials.RevisionItem = new RevisionItem();
                        pickingMaterials.RevisionItem.IdRevisionItem = otItem.IdRevisionItem;
                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.NumItem = otItem.RevisionItem.NumItem;

                        if (otItem.RevisionItem != null)
                            pickingMaterials.RevisionItem.Quantity = otItem.RevisionItem.Quantity;

                        if (otItem.RevisionItem != null)
                            if (otItem.RevisionItem.WarehouseProduct != null)
                                pickingMaterials.IdWarehouseProductComponent = otItem.RevisionItem.WarehouseProduct.IdComponent;

                        if (!string.IsNullOrEmpty(otItem.RevisionItem.WarehouseProduct.Article.Reference))
                            pickingMaterials.Reference = otItem.RevisionItem.WarehouseProduct.Article.Reference;

                        if (itemArticleStock.ArticleCurrentStock != null)
                            pickingMaterials.ArticleCurrentStock = itemArticleStock.ArticleCurrentStock.Value;

                        if (itemArticleStock.CurrentStock != null)
                            pickingMaterials.CurrentStock = itemArticleStock.CurrentStock.Value;

                        if (itemArticleStock.CostPrice != null)
                            pickingMaterials.CostPrice = itemArticleStock.CostPrice.Value;

                        if (itemArticleStock.UnitPrice != null)
                            pickingMaterials.UnitPrice = itemArticleStock.UnitPrice.Value;


                        pickingMaterials.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        if (pickingMaterials.IdWareHouseDeliveryNoteItem != null)
                        {
                            pickingMaterials.IdWareHouseDeliveryNoteItem = itemArticleStock.IdWareHouseDeliveryNoteItem.Value;


                            pickingMaterials.MadeIn = GetMadeInByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.Manufacturer = GeManufacturerByIdWareHouseDeliveryNoteItem(pickingMaterials.IdWareHouseDeliveryNoteItem, connectionString);
                            pickingMaterials.SerialNumbers = new List<SerialNumber>(GetSerialNumbers(connectionString, pickingMaterials.IdWareHouseDeliveryNoteItem, itemArticleStock.WarehouseLocation.IdWarehouse));
                        }


                        pickingMaterials.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;


                        pickingMaterials.LocationFullName = itemArticleStock.WarehouseLocation.FullName;


                        pickingMaterials.Description = itemArticleStock.Article.Description;

                        if (!string.IsNullOrEmpty(itemArticleStock.Article.ImagePath))
                        {
                            pickingMaterials.ImagePath = itemArticleStock.Article.ImagePath;
                            Article article = new Article();
                            article.ImagePath = pickingMaterials.ImagePath;
                            pickingMaterials.ArticleImageInBytes = GetArticleImageInBytes(ArticleVisualAidsPath, article);
                        }


                        if (itemArticleStock.MinimumStock != null)
                            pickingMaterials.MinimumStock = itemArticleStock.MinimumStock.Value;

                        if (itemArticleStock.MaximumStock != null)
                            pickingMaterials.MaximumStock = itemArticleStock.MaximumStock.Value;

                        pickingMaterials.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                        if (itemArticleStock.UploadedIn != null)
                        {
                            pickingMaterials.UploadedIn = itemArticleStock.UploadedIn;
                            pickingMaterials.WarehouseDeliveryNote.DeliveryDate = itemArticleStock.UploadedIn.Value;
                        }


                        pickingMaterials.WarehouseDeliveryNote.Code = itemArticleStock.WarehouseDeliveryNote.Code;


                        pickingMaterials.IdCurrency = itemArticleStock.IdCurrency;

                        pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;

                        //if (otItemSameReferences.Any(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation))
                        //{
                        //    Int64 articleCurrentStockRem = 0;
                        //    articleCurrentStockRem = (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).FirstOrDefault().ArticleCurrentStock) - (otItemSameReferences.Where(oisr => oisr.IdArticle == otItem.RevisionItem.WarehouseProduct.Article.IdArticle && oisr.IdWarehouseDeliveryNoteItem == itemArticleStock.IdWareHouseDeliveryNoteItem && oisr.IdWarehouseLocation == itemArticleStock.IdWarehouseLocation).Sum(i => i.Qty));
                        //    if (articleCurrentStockRem > 0)
                        //    {
                        //        if (remainingQty > 0 && articleCurrentStockRem > 0)
                        //        {
                        //            if (articleCurrentStockRem > remainingQty)
                        //            {
                        //                pickingMaterials.DownloadQuantity = remainingQty;
                        //                remainingQty = 0;
                        //            }
                        //            else
                        //            {
                        //                pickingMaterials.DownloadQuantity = articleCurrentStockRem;
                        //                remainingQty = remainingQty - articleCurrentStockRem;
                        //            }

                        //        }
                        //    }
                        //    else
                        //    {
                        //        if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                        //        {
                        //            if (pickingMaterials.ArticleCurrentStock > remainingQty)
                        //            {
                        //                pickingMaterials.DownloadQuantity = remainingQty;
                        //                remainingQty = 0;
                        //            }
                        //            else
                        //            {
                        //                pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                        //                remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                        //            }

                        //        }
                        //    }
                        //}
                        //else
                        //{
                        //    if (remainingQty > 0 && pickingMaterials.ArticleCurrentStock > 0)
                        //    {
                        //        if (pickingMaterials.ArticleCurrentStock > remainingQty)
                        //        {
                        //            pickingMaterials.DownloadQuantity = remainingQty;
                        //            remainingQty = 0;
                        //        }
                        //        else
                        //        {
                        //            pickingMaterials.DownloadQuantity = pickingMaterials.ArticleCurrentStock;
                        //            remainingQty = remainingQty - pickingMaterials.ArticleCurrentStock;
                        //        }

                        //    }
                        //}

                        pickingMaterials.WarehouseLocation = new WarehouseLocation();

                        pickingMaterials.WarehouseLocation.IdWarehouse = itemArticleStock.WarehouseLocation.IdWarehouse;

                        pickingMaterials.WarehouseLocation.IdWarehouseLocation = itemArticleStock.WarehouseLocation.IdWarehouseLocation;

                        pickingMaterials.WarehouseLocation.FullName = itemArticleStock.WarehouseLocation.FullName;

                        pickingMaterials.WarehouseLocation.HtmlColor = itemArticleStock.WarehouseLocation.HtmlColor;

                        pickingMaterials.WarehouseLocation.Latitude = itemArticleStock.WarehouseLocation.Latitude;

                        pickingMaterials.WarehouseLocation.Longitude = itemArticleStock.WarehouseLocation.Longitude;

                        pickingMaterials.WarehouseLocation.Width = itemArticleStock.WarehouseLocation.Width;

                        pickingMaterials.WarehouseLocation.Height = itemArticleStock.WarehouseLocation.Height;

                        pickingMaterials.WarehouseLocation.FileName = itemArticleStock.WarehouseLocation.FileName;

                        pickingMaterials.RegisterSerialNumber = itemArticleStock.Article.RegisterSerialNumber;

                        pickingMaterials.PartNumberCode = GetPartNumberCode(otItem.IdOTItem, connectionString);

                        if (itemArticleStock.IdCountryGroup != null)
                            pickingMaterials.IdCountryGroup = itemArticleStock.IdCountryGroup.Value;

                        ////Add in otSameReferenceList
                        //OtItemSameReference otItemSameReference = new OtItemSameReference();
                        //otItemSameReference.IdArticle = pickingMaterials.IdArticle;
                        //otItemSameReference.IdWarehouseDeliveryNoteItem = pickingMaterials.IdWareHouseDeliveryNoteItem;
                        //otItemSameReference.ArticleCurrentStock = pickingMaterials.ArticleCurrentStock;
                        //otItemSameReference.Qty = pickingMaterials.DownloadQuantity;
                        //otItemSameReference.IdWarehouseLocation = pickingMaterials.WarehouseLocation.IdWarehouseLocation;
                        //otItemSameReferences.Add(otItemSameReference);

                        otItem.PickingMaterialsList.Add(pickingMaterials);

                        //GetTotalArticleDownloadDetailByOtItem(connectionString, 1800, 35259);

                    }
                    catch (Exception ex)
                    {
                        Log4NetLogger.Logger.Log(string.Format("Error FillPickingMaterialDisbaledFIFO_V2051(IdArticle-{0}, idWarehouse-{1}). ErrorMessage- {2}", otItem.RevisionItem.WarehouseProduct.Article.IdArticle, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                        throw;
                    }
                }
                #endregion

            }
        }


        public PendingStorageArticles GetArticleDetailByIdWarehouseDeliveryNoteItem_V2051(Warehouses warehouse, Int64 idWarehouseDeliveryNoteItem, string articleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;

            PendingStorageArticles pendingStorageArticle = null;

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetArticleDetailByIdWarehouseDeliveryNoteItem_V2051", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouseDeliveryNoteItem", idWarehouseDeliveryNoteItem);
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.CommandTimeout = 6000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        if (reader.Read())
                        {
                            try
                            {
                                pendingStorageArticle = new PendingStorageArticles();

                                if (reader["IdArticle"] != DBNull.Value)
                                    pendingStorageArticle.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                if (reader["StockQty"] != DBNull.Value)
                                    pendingStorageArticle.Quantity = Convert.ToInt64(reader["StockQty"]);

                                if (reader["idCurrency"] != DBNull.Value)
                                    pendingStorageArticle.IdCurrency = Convert.ToInt16(reader["idCurrency"]);

                                if (reader["Price"] != DBNull.Value)
                                    pendingStorageArticle.CostPrice = Convert.ToDouble(reader["Price"]);

                                if (reader["UnitPrice"] != DBNull.Value)
                                    pendingStorageArticle.UnitPrice = Convert.ToDouble(reader["UnitPrice"]);

                                if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                                    pendingStorageArticle.IdWareHouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);

                                if (reader["idWarehouseDeliveryNote"] != DBNull.Value)
                                {
                                    pendingStorageArticle.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                    pendingStorageArticle.WarehouseDeliveryNote.IdWarehouseDeliveryNote = Convert.ToInt64(reader["IdWarehouseDeliveryNote"]);
                                    if (reader["Code"] != DBNull.Value)
                                        pendingStorageArticle.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                    if (reader["DeliveryDate"] != DBNull.Value)
                                        pendingStorageArticle.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);
                                }

                                if (reader["Reference"] != DBNull.Value)
                                    pendingStorageArticle.Reference = Convert.ToString(reader["Reference"]);

                                if (reader["Description"] != DBNull.Value)
                                    pendingStorageArticle.Description = Convert.ToString(reader["Description"]);

                                if (reader["ArticleComment"] != DBNull.Value)
                                    pendingStorageArticle.ArticleComment = Convert.ToString(reader["ArticleComment"]);


                                if (reader["ArticleCommentDateOfExpiry"] != DBNull.Value)
                                    pendingStorageArticle.ArticleCommentDateOfExpiry = Convert.ToDateTime(reader["ArticleCommentDateOfExpiry"]);

                                if (reader["ImagePath"] != DBNull.Value)
                                {
                                    pendingStorageArticle.ImagePath = Convert.ToString(reader["ImagePath"]);
                                    pendingStorageArticle.ArticleImageInBytes = GetArticleImageInBytesByImagePath(articleVisualAidsPath, pendingStorageArticle.ImagePath);
                                }


                                if (reader["IdWarehouseLocation"] != DBNull.Value)
                                    pendingStorageArticle.IdWarehouseLocation = Convert.ToInt64(reader["IdWarehouseLocation"]);

                                if (reader["IdWarehouse"] != DBNull.Value)
                                    pendingStorageArticle.IdWarehouse = Convert.ToInt64(reader["IdWarehouse"]);



                                if (reader["WarehouseMinimumStock"] != DBNull.Value)
                                    pendingStorageArticle.MinimumStock = Convert.ToInt64(reader["WarehouseMinimumStock"]);
                                if(pendingStorageArticle.ArticleCommentDateOfExpiry!=null)
                                if(pendingStorageArticle.ArticleCommentDateOfExpiry.Value.Date<DateTime.Now.Date)
                                {
                                    pendingStorageArticle.ArticleComment = null;
                                }

                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetArticleDetailByIdWarehouseDeliveryNoteItem_V2051() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }


                    Log4NetLogger.Logger.Log("Executed GetArticleDetailByIdWarehouseDeliveryNoteItem_V2051().", category: Category.Info, priority: Priority.Low);
                    return pendingStorageArticle;
                }


            }
        }


        public List<WOItem> GetPackedItemByIdPackingBox_V2051(Warehouses warehouse, string articleVisualAidsPath, Int64 idPackingBox)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<WOItem> packedItems = new List<WOItem>();
            Dictionary<Int64, byte[]> articleDetails = new Dictionary<Int64, byte[]>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetPackedItemByIdPackingBox_V2051", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.Parameters.AddWithValue("_IdPackingBox", idPackingBox);
                command.CommandTimeout = 8000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                WOItem packedItem = new WOItem();

                                if (reader["IdOT"] != DBNull.Value)
                                    packedItem.IdOT = Convert.ToInt64(reader["IdOT"]);

                                if (reader["IdOffer"] != DBNull.Value)
                                    packedItem.IdOffer = Convert.ToInt64(reader["IdOffer"]);

                                if (reader["MergeCode"] != DBNull.Value)
                                {
                                    packedItem.WorkOrder = Convert.ToString(reader["MergeCode"]);
                                }

                                if (reader["OtCode"] != DBNull.Value)
                                {
                                    packedItem.WorkOrderCode = Convert.ToString(reader["OtCode"]);
                                }

                                if (reader["NumItem"] != DBNull.Value)
                                {
                                    packedItem.Item = Convert.ToInt32(reader["NumItem"]);
                                }

                                if (reader["ActualQty"] != DBNull.Value)
                                {
                                    packedItem.Qty = Convert.ToInt64(reader["ActualQty"]);
                                    packedItem.OriginalQty = packedItem.Qty;
                                }


                                if (reader["IdArticle"] != DBNull.Value)
                                {
                                    packedItem.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                    if (reader["reference"] != DBNull.Value)
                                        packedItem.Reference = Convert.ToString(reader["reference"]);

                                    if (reader["Description"] != DBNull.Value)
                                        packedItem.Description = Convert.ToString(reader["Description"]);

                                    if (reader["ArticleWeight"] != DBNull.Value)
                                        packedItem.ArticleWeight = Convert.ToDouble(reader["ArticleWeight"]);

                                    if (articleDetails.Any(ad => ad.Key == packedItem.IdArticle))
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            packedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(packedItem.ImagePath))
                                                packedItem.ArticleImageInBytes = articleDetails.Where(ad => ad.Key == packedItem.IdArticle).Select(ad => ad.Value).FirstOrDefault();
                                        }
                                    }
                                    else
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            packedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(packedItem.ImagePath))
                                                packedItem.ArticleImageInBytes = GetArticleImageInBytes_V2034(articleVisualAidsPath, packedItem.ImagePath);

                                            articleDetails.Add(packedItem.IdArticle, packedItem.ArticleImageInBytes);
                                        }
                                    }
                                    if (reader["ArticleComment"] != DBNull.Value)
                                        packedItem.ArticleComment = Convert.ToString(reader["ArticleComment"]);


                                    if (reader["ArticleCommentDateOfExpiry"] != DBNull.Value)
                                        packedItem.ArticleCommentDateOfExpiry = Convert.ToDateTime(reader["ArticleCommentDateOfExpiry"]);

                                }


                                if (reader["PartNumberCode"] != DBNull.Value)
                                    packedItem.PartNumberCode = Convert.ToString(reader["PartNumberCode"]);


                                if (reader["idPartNumber"] != DBNull.Value)
                                    packedItem.IdPartNumber = Convert.ToInt64(reader["idPartNumber"]);

                                if (reader["IdOTItem"] != DBNull.Value)
                                    packedItem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                                     if (packedItem.ArticleCommentDateOfExpiry != null)
                                    if (packedItem.ArticleCommentDateOfExpiry.Value.Date < DateTime.Now.Date)
                                    {
                                        packedItem.ArticleComment = null;
                                    }

                                packedItems.Add(packedItem);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetPackedItemByIdPackingBox_V2051() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    return packedItems;
                }
            }
        }


        public List<WOItem> GetRevisionItemPackingWorkOrders_V2051(Warehouses warehouse, Int32 idCompany, string articleVisualAidsPath)
        {
            string connectionString = warehouse.Company.ConnectPlantConstr;
            List<WOItem> unPackedItems = new List<WOItem>();
            Dictionary<Int64, byte[]> articleDetails = new Dictionary<Int64, byte[]>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();

                MySqlCommand command = new MySqlCommand("WMS_GetRevisionItemPackingWorkOrders_V2051", conn);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                command.Parameters.AddWithValue("_IdCompany", idCompany);
                command.CommandTimeout = 8000;

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                WOItem unPackedItem = new WOItem();

                                if (reader["IdOT"] != DBNull.Value)
                                    unPackedItem.IdOT = Convert.ToInt64(reader["IdOT"]);

                                if (reader["IdOffer"] != DBNull.Value)
                                    unPackedItem.IdOffer = Convert.ToInt64(reader["IdOffer"]);

                                if (reader["MergeCode"] != DBNull.Value)
                                {
                                    unPackedItem.WorkOrder = Convert.ToString(reader["MergeCode"]);
                                }

                                if (reader["OtCode"] != DBNull.Value)
                                {
                                    unPackedItem.WorkOrderCode = Convert.ToString(reader["OtCode"]);
                                }

                                if (reader["NumItem"] != DBNull.Value)
                                {
                                    unPackedItem.Item = Convert.ToInt32(reader["NumItem"]);
                                }

                                if (reader["ActualQty"] != DBNull.Value)
                                {
                                    unPackedItem.Qty = Convert.ToInt64(reader["ActualQty"]);
                                    unPackedItem.OriginalQty = unPackedItem.Qty;
                                }


                                if (reader["IdArticle"] != DBNull.Value)
                                {
                                    unPackedItem.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                                    if (reader["reference"] != DBNull.Value)
                                        unPackedItem.Reference = Convert.ToString(reader["reference"]);

                                    if (reader["Description"] != DBNull.Value)
                                        unPackedItem.Description = Convert.ToString(reader["Description"]);

                                    if (reader["ArticleWeight"] != DBNull.Value)
                                        unPackedItem.ArticleWeight = Convert.ToDouble(reader["ArticleWeight"]);

                                    if (articleDetails.Any(ad => ad.Key == unPackedItem.IdArticle))
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            unPackedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(unPackedItem.ImagePath))
                                                unPackedItem.ArticleImageInBytes = articleDetails.Where(ad => ad.Key == unPackedItem.IdArticle).Select(ad => ad.Value).FirstOrDefault();
                                        }
                                    }
                                    else
                                    {
                                        if (reader["ImagePath"] != DBNull.Value)
                                        {
                                            unPackedItem.ImagePath = Convert.ToString(reader["ImagePath"]);

                                            if (!string.IsNullOrEmpty(unPackedItem.ImagePath))
                                                unPackedItem.ArticleImageInBytes = GetArticleImageInBytes_V2034(articleVisualAidsPath, unPackedItem.ImagePath);

                                            articleDetails.Add(unPackedItem.IdArticle, unPackedItem.ArticleImageInBytes);
                                        }
                                    }


                                    if (reader["ArticleComment"] != DBNull.Value)
                                        unPackedItem.ArticleComment = Convert.ToString(reader["ArticleComment"]);


                                    if (reader["ArticleCommentDateOfExpiry"] != DBNull.Value)
                                        unPackedItem.ArticleCommentDateOfExpiry = Convert.ToDateTime(reader["ArticleCommentDateOfExpiry"]);
                                }


                                if (reader["PartNumberCode"] != DBNull.Value)
                                    unPackedItem.PartNumberCode = Convert.ToString(reader["PartNumberCode"]);


                                if (reader["idPartNumber"] != DBNull.Value)
                                    unPackedItem.IdPartNumber = Convert.ToInt64(reader["idPartNumber"]);

                                if (reader["IdOTItem"] != DBNull.Value)
                                    unPackedItem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                                if (unPackedItem.ArticleCommentDateOfExpiry != null)
                                    if (unPackedItem.ArticleCommentDateOfExpiry.Value.Date < DateTime.Now.Date)
                                    {
                                        unPackedItem.ArticleComment = null;
                                    }
                                unPackedItems.Add(unPackedItem);
                            }
                            catch (Exception ex)
                            {
                                Log4NetLogger.Logger.Log(string.Format("Error GetRevisionItemPackingWorkOrders_V2051() 1. ErrorMessage- {0}", ex.Message), category: Category.Exception, priority: Priority.Low);
                                throw;
                            }
                        }
                    }

                    return unPackedItems;
                }

            }
        }

        public List<ArticlesStock> GetWarehouseDeliveryNoteCode_V2060(Int64 idOTItem, Warehouses warehouse, Int64? idWarehouseProductComponent)
        {
            List<ArticlesStock> articleStockLst = new List<ArticlesStock>();
            string connectionString = warehouse.Company.ConnectPlantConstr;
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("WMS_GetWarehouseDeliveryNoteCode_V2060", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdOTItem", idOTItem);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouse", warehouse.IdWarehouse);
                mySqlCommand.Parameters.AddWithValue("_IdWarehouseProductComponent", idWarehouseProductComponent);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        try
                        {
                            ArticlesStock articlesStock = new ArticlesStock();

                            if (reader["IdOtItem"] != DBNull.Value)
                                articlesStock.IdOtItem = Convert.ToUInt64(reader["IdOtItem"]);

                            if (reader["IdArticle"] != DBNull.Value)
                                articlesStock.IdArticle = Convert.ToUInt32(reader["IdArticle"]);

                           

                            if (reader["IdWareHouseDeliveryNoteItem"] != DBNull.Value)
                            {
                                articlesStock.IdWarehouseDeliveryNoteItem = Convert.ToUInt64(reader["IdWareHouseDeliveryNoteItem"]);
                                articlesStock.WarehouseDeliveryNoteItem = new WarehouseDeliveryNoteItem();
                                articlesStock.WarehouseDeliveryNoteItem.IdWarehouseDeliveryNoteItem = Convert.ToInt64(reader["IdWareHouseDeliveryNoteItem"]);
                                articlesStock.WarehouseDeliveryNoteItem.WarehouseDeliveryNote = new WarehouseDeliveryNote();
                                articlesStock.WarehouseDeliveryNoteItem.WarehouseDeliveryNote.Code = Convert.ToString(reader["Code"]);
                                articlesStock.WarehouseDeliveryNoteItem.WarehouseDeliveryNote.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"]);

                                articlesStock.WarehouseDeliveryNoteItem.Producer = new ManufacturersByArticle();
                                if (reader["IdManufacturer"] != DBNull.Value)
                                {

                                    articlesStock.WarehouseDeliveryNoteItem.Producer.IdManufacturer = Convert.ToInt64(reader["IdManufacturer"]);
                                    articlesStock.WarehouseDeliveryNoteItem.Producer.Manufacturer = new Manufacturer();
                                    articlesStock.WarehouseDeliveryNoteItem.Producer.Manufacturer.IdManufacturer = Convert.ToInt64(reader["IdManufacturer"]);
                                    articlesStock.WarehouseDeliveryNoteItem.Producer.Manufacturer.Name = reader["ManufacturerName"].ToString();
                                }
                                if (reader["IdCountry"] != DBNull.Value)
                                {
                                    articlesStock.WarehouseDeliveryNoteItem.Producer.IdCountry = Convert.ToInt64(reader["IdCountry"]);
                                    articlesStock.WarehouseDeliveryNoteItem.Producer.Country = new Country();
                                    articlesStock.WarehouseDeliveryNoteItem.Producer.Country.IdCountry = Convert.ToByte(reader["IdCountry"]);
                                    articlesStock.WarehouseDeliveryNoteItem.Producer.Country.Name = Convert.ToString(reader["CountryName"]);
                                }



                            }

                            if (reader["qty"] != DBNull.Value)
                            {
                                articlesStock.Quantity = Convert.ToInt64(reader["qty"]);
                            }

                            if (reader["idWarehouseProductComponent"] != DBNull.Value)
                                articlesStock.IdWarehouseProductComponent = Convert.ToUInt64(reader["idWarehouseProductComponent"]);

                            if (reader["IdRevisionItem"] != DBNull.Value)
                            {
                                articlesStock.RevisionItem = new RevisionItem();
                                articlesStock.RevisionItem.IdRevisionItem = Convert.ToInt64(reader["IdRevisionItem"]);
                                if (reader["IdProduct"] != DBNull.Value)
                                {
                                    articlesStock.RevisionItem.IdProduct = Convert.ToInt64(reader["IdProduct"]);
                                    articlesStock.SerialNumbers = GetSerialNumbersForRefund(connectionString, Convert.ToInt64(articlesStock.IdWarehouseDeliveryNoteItem), warehouse.IdWarehouse, articlesStock.RevisionItem.IdProduct);
                                }

                            }


                            articleStockLst.Add(articlesStock);
                        }
                        catch (Exception ex)
                        {
                            Log4NetLogger.Logger.Log(string.Format("Error GetWarehouseDeliveryNoteCode_V2060(). IdOtItem- {0} _IdWarehouse-{1} ErrorMessage- {2}", idOTItem, warehouse.IdWarehouse, ex.Message), category: Category.Exception, priority: Priority.Low);
                            throw;
                        }
                    }
                }

            }

            return articleStockLst;
        }


    }
}
