using Emdep.Geos.Data.Common;
using Emdep.Geos.Data.Common.Epc;
using Emdep.Geos.Data.Common.OptimizedClass;
using Emdep.Geos.Data.DataAccess;
using System;
using System.Collections.Generic;
using System.Linq;
using MySql.Data.MySqlClient;
using System.Data;
using System.Text;
using System.Data.SqlClient;
using System.IO;
using System.Text.RegularExpressions;
using System.IO.Compression;
using System.Transactions;
using System.Net;
using System.Net.Http;
using System.Net.Http.Headers;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using Emdep.Geos.Data.Common.File;

namespace Emdep.Geos.Data.BusinessLogic
{
    public class CrmManager
    {
        /// <summary>
        /// This method is to get list of company
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>List of all company</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          companies = mgr.GetCompanies(connectionString);//SP:-sites_GetSites
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<Company> GetCompanies(string connectionstring)
        {
            IList<Company> companies = new List<Company>();

            using (MySqlConnection consite = new MySqlConnection(connectionstring))
            {
                consite.Open();
                MySqlCommand consitecommand = new MySqlCommand("sites_GetSites", consite);
                consitecommand.CommandType = CommandType.StoredProcedure;
                using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                {
                    while (sitereader.Read())
                    {
                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(sitereader["IdCompany"].ToString());
                        company.Name = sitereader["Name"].ToString();
                        companies.Add(company);
                    }
                }
            }

            return companies;
        }


        /// <summary>
        /// This method is to get emdep sites all companies
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>List of company</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          companies = mgr.GetEmdepSitesCompanies(connectionString);
        ///          //QUERY:-"select si.IdSite,si.Name,si.ShortName,emsi.IP,emsi.DatabaseIP,co.idCountry,co.name from sites si inner join emdepsites emsi on si.IdSite = emsi.idSite inner join countries co on co.idCountry = si.IdCountry order by co.name, si.ShortName;" 
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<Company> GetEmdepSitesCompanies(string connectionstring)
        {
            IList<Company> companies = new List<Company>();

            using (MySqlConnection consite = new MySqlConnection(connectionstring))
            {
                consite.Open();
                MySqlCommand consitecommand = new MySqlCommand("emdepsites_GetEmdepSitesCompanies", consite);
                consitecommand.CommandType = CommandType.StoredProcedure;
                using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                {
                    while (sitereader.Read())
                    {
                        string connstr = "Data Source = " + sitereader["DatabaseIP"].ToString() + "; Database = geos; User ID = GeosUsr; Password = GEOS;Convert Zero Datetime=True";
                        if (companies.Any(co => co.ConnectPlantConstr == connstr))
                        {

                        }

                        else
                        {
                            Company company = new Company();

                            company.IdCompany = Convert.ToInt32(sitereader["IdSite"].ToString());
                            company.Name = sitereader["Name"].ToString();
                            company.ShortName = sitereader["ShortName"].ToString();
                            company.Alias = sitereader["ShortName"].ToString();
                            company.ConnectPlantId = sitereader["IdSite"].ToString();
                            company.ConnectPlantConstr = connstr;
                            company.Country = new Country();
                            company.Country.IdCountry = Convert.ToByte(sitereader["idCountry"].ToString());
                            company.Country.Name = sitereader["name"].ToString();
                            companies.Add(company);
                        }
                    }
                }
            }
            return companies;
        }

        /// <summary>
        /// This method is to get list of people details
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idSite">Get idsite</param>
        /// <returns>List of people</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          peoples = mgr.GetSiteContacts(connectionString,idSite);
        ///          //QUERY:-"select * from people where IdSite=" + idSite + "" 
        ///     }
        /// }
        /// </code>
        /// </example>
        public List<People> GetSiteContacts(string connectionstring, Int64 idSite)
        {
            List<People> peoples = new List<People>();

            using (MySqlConnection consite = new MySqlConnection(connectionstring))
            {
                consite.Open();
                //string query = "select * from people where IdSite=" + idSite + " and IsStillActive=1;";
                MySqlCommand consitecommand = new MySqlCommand("people_GetSiteContacts", consite);
                consitecommand.CommandType = CommandType.StoredProcedure;
                consitecommand.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                {
                    while (sitereader.Read())
                    {
                        People people = new People();
                        people.IdPerson = Convert.ToInt32(sitereader["IdPerson"].ToString());
                        people.Name = sitereader["Name"].ToString();
                        people.Surname = sitereader["Surname"].ToString();
                        people.IdPersonType = Convert.ToByte(sitereader["IdPersonType"].ToString());
                        people.Email = sitereader["Email"].ToString();
                        people.IdSite = Convert.ToInt32(sitereader["IdSite"].ToString());
                        people.IsStillActive = Convert.ToByte(sitereader["IsStillActive"].ToString());
                        people.Phone = sitereader["Phone"].ToString();
                        people.Observations = sitereader["Observations"].ToString();
                        if (sitereader["CreatedIn"] != DBNull.Value)
                            people.CreatedIn = Convert.ToDateTime(sitereader["CreatedIn"].ToString());
                        if (sitereader["DisabledIn"] != DBNull.Value)
                            people.DisabledIn = Convert.ToDateTime(sitereader["DisabledIn"].ToString());
                        if (sitereader["IdPersonGender"] != DBNull.Value)
                            people.IdPersonGender = Convert.ToByte(sitereader["IdPersonGender"].ToString());
                        if (sitereader["IdCompanyDepartment"] != DBNull.Value)
                        {
                            people.IdCompanyDepartment = Convert.ToInt32(sitereader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment = new LookupValue();
                            people.CompanyDepartment.IdLookupValue = Convert.ToInt32(sitereader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment.Value = sitereader["Value"].ToString();
                            if (sitereader["IdImage"] != DBNull.Value)
                                people.CompanyDepartment.IdImage = Convert.ToInt64(sitereader["IdImage"].ToString());
                            //if (sitereader["InUse"] != DBNull.Value)
                            //    people.CompanyDepartment.InUse = Convert.ToBoolean(sitereader["InUse"].ToString());

                        }
                        people.JobTitle = sitereader["JobTitle"].ToString();
                        people.ImageText = sitereader["Image"].ToString();

                        peoples.Add(people);
                    }
                }
            }
            return peoples;
        }

        /// <summary>
        /// This method is to get list of currency
        /// </summary>
        /// <returns>List of currency</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          currencies = mgr.GetCurrencies();//SP:-currency_GetAllCurrency (using EF CrmContext)
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<Currency> GetCurrencies()
        {

            IList<Currency> currencies = null;

            using (var context = new CrmContext())
            {
                currencies = context.Currencies.SqlQuery("currency_GetAllCurrency").ToList();
            }


            return currencies;
        }

        /// <summary>
        /// This method is to get sales status type
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>List of sales status type</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          salesStatusTypes = mgr.GetAllSalesStatusType(connectionString);
        ///          //SP:-salesstatustype_GetAllSalesStatusType 
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<SalesStatusType> GetAllSalesStatusType(string connectionstring)
        {
            IList<SalesStatusType> salesStatusTypes = new List<SalesStatusType>();

            using (MySqlConnection con = new MySqlConnection(connectionstring))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("salesstatustype_GetAllSalesStatusType", con);
                concommand.CommandType = CommandType.StoredProcedure;
                using (MySqlDataReader offerreader = concommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        SalesStatusType salesStatusType = new SalesStatusType();
                        salesStatusType.IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString());
                        salesStatusType.Name = offerreader["SalesStatusType"].ToString();
                        salesStatusType.IdImage = Convert.ToInt64(offerreader["IdImage"].ToString());
                        salesStatusType.HtmlColor = offerreader["HtmlColor"].ToString();
                        salesStatusType.GeosStatus = new GeosStatus() { IdOfferStatusType = Convert.ToInt64(offerreader["IdOfferStatusType"].ToString()), Name = offerreader["OfferStatusType"].ToString(), Position = Convert.ToInt64(offerreader["OfferStatusPosition"].ToString()), HtmlColor = offerreader["OfferStatusHtmlColor"].ToString() };
                        salesStatusTypes.Add(salesStatusType);
                    }
                }
            }

            return salesStatusTypes;
        }

        /// <summary>
        /// This method is to get template by id offer option
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idOfferOption">Get offer option id</param>
        /// <returns>List of templates</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          templates = mgr.GetTemplatesByIdOfferOption(connectionString,idOfferOption);
        ///          //SP:-templatesbyofferoption_GetTemplatesByOfferOption 
        ///     }
        /// }
        /// </code>
        /// </example>
        public List<Template> GetTemplatesByIdOfferOption(string connectionstring, Int64 idOfferOption)
        {

            List<Template> templates = new List<Template>();

            using (MySqlConnection con = new MySqlConnection(connectionstring))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("templatesbyofferoption_GetTemplatesByOfferOption", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdOfferOption", idOfferOption);
                using (MySqlDataReader offerreader = concommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Template template = new Template();
                        template.Suffix = offerreader["Suffix"].ToString();
                        template.Name = offerreader["Name"].ToString();
                        template.IdTemplate = Convert.ToByte(offerreader["IdTemplate"].ToString());
                        template.Type = Convert.ToByte(offerreader["Type"].ToString());

                        templates.Add(template);
                    }
                }
            }

            return templates;
        }

        /// <summary>
        /// This method is to get list of offer types
        /// </summary>
        /// <returns>List of offer types</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offerTypes = mgr.GetOfferType();
        ///          //SP:-offertypes_GetAllOffertypes  (Using EF - CrmContext)
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<OfferType> GetOfferType()
        {
            IList<OfferType> offerTypes = null;

            using (var context = new CrmContext())
            {
                offerTypes = context.OfferTypes.SqlQuery("offertypes_GetAllOffertypes").ToList();
            }

            return offerTypes;
        }

        /// <summary>
        /// This method is to get templates by selected options by offer
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="optionsByOffers">Get options by offers</param>
        /// <returns>List of bytes</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          idAllTemplates = mgr.GetTemplatesBySelectedOptionsByOffer(connectionstring,optionsByOffers);
        ///          //Called Methods:-GetTemplatesByIdOfferOption(connectionstring, itemOptionsByOffer.IdOption)
        ///                            GetDefaultArticleByIdOfferOption(itemOptionsByOffer.IdOption, connectionstring)
        ///     }
        /// }
        /// </code>
        /// </example>
        private List<byte> GetTemplatesBySelectedOptionsByOffer(string connectionstring, List<OptionsByOffer> optionsByOffers)
        {
            List<byte> idAllTemplates = new List<byte>();
            foreach (OptionsByOffer itemOptionsByOffer in optionsByOffers)
            {
                List<byte> idTemplates = new List<byte>();
                idTemplates = GetTemplatesByIdOfferOption(connectionstring, itemOptionsByOffer.IdOption).ToList().Select(temp => temp.IdTemplate).ToList();
                byte? idDefaultTemplate = null;
                idDefaultTemplate = GetDefaultArticleByIdOfferOption(itemOptionsByOffer.IdOption, connectionstring).IdTemplate;
                if (idDefaultTemplate != null)
                    idTemplates.Add(idDefaultTemplate.Value);
                foreach (byte item in idTemplates)
                {
                    if (!idAllTemplates.Contains(item))
                        idAllTemplates.Add(item);
                }

            }

            return idAllTemplates.Distinct().ToList();
        }



        /// <summary>
        /// This method is to add quotation related to offer
        /// </summary>
        /// <param name="offer">Get offer details to add quotation</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           mgr.AddQuotations(offer,connectionstring);
        ///          //Methods:-GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
        ///                     GetDefaultArticleByIdOfferOption(optionsByOffer.IdOption, connectionstring);
        ///          //SP:-optionsbyoffer_Insert,quotations_Insert
        ///          //QUERY:-"select * from revisions where IdQuotation=" + idQuotation + "";
        ///          //QUERY:- "INSERT INTO revisions (idquotation ,numrevision, madeBy, reviewedBy, creationDate, comments, sentTo, closed, discount, expiryDate, idcurrency, ModifiedBy, ModifiedIn)" +
        ///          //"VALUES (" + idQuotation + " ," + r.NumRevision + ", " + r.CreatedBy + ", " + r.ReviewedBy + ", '" + r.CreatedIn.ToString("yyyy/MM/dd HH:mm:ss") + "', '" + r.Comments + "', '" + string.Empty + "', '" + r.ApprovedIn.ToString("yyyy/MM/dd HH:mm:ss") + "', 0, '" + r.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss") + "', " + offer.IdCurrency + "," + offer.CreatedBy + ", '" + DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss") + "');";
        ///     }
        /// }
        /// </code>
        /// </example>
        public void AddQuotations(Offer offer, string connectionstring, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {
            try
            {
                foreach (OptionsByOffer optionsByOffer in offer.OptionsByOffers)
                {
                    List<Template> selectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                    Template selectedOptiontemplate = GetDefaultArticleByIdOfferOption(optionsByOffer.IdOption, connectionstring);
                    if (selectedOptiontemplate != null)
                        selectedOptionTemplates.Add(selectedOptiontemplate);

                    using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                    {
                        conquotation.Open();

                        using (MySqlTransaction trans = conquotation.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand conquotationcommand = new MySqlCommand("optionsbyoffer_Insert", conquotation);
                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                conquotationcommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                conquotationcommand.Parameters.AddWithValue("_Quantity", optionsByOffer.Quantity);
                                conquotationcommand.Transaction = trans;
                                conquotationcommand.ExecuteNonQuery();

                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }

                    foreach (Template quotation in selectedOptionTemplates)
                    {
                        Int64 idQuotation = 0;
                        Quotation tempquotation = new Quotation();
                        tempquotation.Offer = new Offer();
                        tempquotation.Offer.IdOffer = offer.IdOffer;
                        tempquotation.Year = DateTime.Now.Year;
                        tempquotation.Number = offer.Number;
                        tempquotation.Code = offer.Code + quotation.Suffix;
                        tempquotation.CreatedIn = DateTime.Now;
                        tempquotation.Template = new Template();
                        tempquotation.Template = quotation;

                        if (quotation.IdTemplate != 0)
                        {
                            string quotationCode = offer.Code + quotation.Suffix;
                            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                            {
                                conquotation.Open();
                                using (MySqlTransaction trans = conquotation.BeginTransaction())
                                {
                                    try
                                    {
                                        MySqlCommand conquotationcommand = new MySqlCommand("quotations_Insert", conquotation);
                                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                                        conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                        conquotationcommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                        conquotationcommand.Parameters.AddWithValue("_Description", offer.Description);
                                        conquotationcommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                        conquotationcommand.Parameters.AddWithValue("_Number", offer.Number);
                                        conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                        conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                        conquotationcommand.Parameters.AddWithValue("_QuotQuantity", 0);
                                        conquotationcommand.Transaction = trans;
                                        idQuotation = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                                        if (idQuotation > 0)
                                        {
                                            bool isinsert = false;
                                            MySqlCommand conoffercommand = new MySqlCommand("revisions_GetrevisionsByIdQuotation", conquotation);
                                            conoffercommand.CommandType = CommandType.StoredProcedure;
                                            conoffercommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                            using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                                            {
                                                if (!offerreader.Read())
                                                {
                                                    isinsert = true;
                                                }
                                            }

                                            if (isinsert)
                                            {
                                                Revision r = new Revision();
                                                r.NumRevision = 0;
                                                //[001]
                                                if (offer.CreatedBy != null && offer.CreatedBy == 164)
                                                {
                                                    r.CreatedBy = 164;
                                                    r.ReviewedBy = 164;
                                                }
                                                else
                                                {
                                                    r.CreatedBy = offer.CreatedBy;
                                                    r.ReviewedBy = offer.CreatedBy;
                                                }
                                                r.CreatedIn = DateTime.Now;
                                                r.NumRevision = 0;
                                                r.Discount = 0;
                                                r.ExpireDate = DateTime.Now.AddDays(14);
                                                r.Comments = offer.Contact + "\r\n" + offer.Description;
                                                //r.Quotation = quotation;
                                                if (quotation.IdTemplate == 15 || quotation.IdTemplate == 16 || quotation.IdTemplate == 18)
                                                    r.ApprovedIn = DateTime.Now;
                                                else
                                                    r.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");

                                                conquotationcommand = new MySqlCommand("revisions_Insert", conquotation);
                                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                                                conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r.ReviewedBy);
                                                conquotationcommand.Parameters.AddWithValue("_NumRevision", r.NumRevision);
                                                conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.CreatedBy);
                                                conquotationcommand.Parameters.AddWithValue("_MadeBy", r.CreatedBy);
                                                conquotationcommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                                conquotationcommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                                conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                                                conquotationcommand.Parameters.AddWithValue("_CreationDate", r.CreatedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_Comments", r.Comments);
                                                conquotationcommand.Parameters.AddWithValue("_Closed", r.ApprovedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Transaction = trans;
                                                r.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                tempquotation.Revisions = new List<Revision>();
                                                tempquotation.Revisions.Add(r);

                                            }
                                        }

                                        trans.Commit();
                                    }
                                    catch (Exception ex)
                                    {
                                        trans.Rollback();
                                        throw;
                                    }
                                }
                            }
                        }

                        tempquotation.IdQuotation = idQuotation;
                        ///////////////////////////////////////////////////////
                        if (offer.IdOfferType != 10 && quotation.IdTemplate == 15)
                        {
                            List<OtItem> items = new List<OtItem>();

                            List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                            items.AddRange(temp);

                            if (items.Count != 0)
                                CreateQuotationWithItems(tempquotation, offer, items, connectionstring);
                        }
                        else if (offer.IdOfferType != 10 && quotation.IdTemplate == 23)
                        {
                            List<OtItem> items = new List<OtItem>();

                            List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                            items.AddRange(temp);
                            if (items.Count != 0)
                                CreateQuotationWithItems(tempquotation, offer, items, connectionstring);

                            //link EPC for eng analysis. 
                            if (!ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                InsertEngAnalysisInDotProject(dotProjectConnectionString, connectionstring, mailServer, workbenchConnectionString, offer, tempquotation);
                            else
                                UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, tempquotation, workbenchConnectionString, mailServer);

                            if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.IsCompleted &&
                                tempquotation != null && tempquotation.Ots != null && tempquotation.Ots.Count > 0
                                && tempquotation.Ots[0].Items != null && tempquotation.Ots[0].Items.Count > 0)
                            {
                                ApplicationManager app = new ApplicationManager();

                                //This property is for AssignedEngAnalysis from dotproject.
                                People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);
                                app.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.CreatedByUser, assignedEngAnalysisPerson, tempquotation.Ots[0].DeliveryDate);

                                LogEntryByOffer log = new LogEntryByOffer();
                                log.IdUser = offer.CreatedBy;
                                log.DateTime = DateTime.Now;
                                log.Comments = "The analysis of engineering department has been completed.";
                                log.IdLogEntryType = 2;
                                offer.LogEntryByOffers.Add(log);
                            }

                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }
        }

        #region Eng analysis rddotproject

        private bool ExistProjectInDotProject(string dotProjectConnectionString, string code)
        {
            bool isExist = false;

            using (MySqlConnection dotProjectConnection = new MySqlConnection(dotProjectConnectionString))
            {
                dotProjectConnection.Open();

                MySqlCommand myCommand = new MySqlCommand("epc_GetProjectExist", dotProjectConnection);
                myCommand.CommandType = CommandType.StoredProcedure;
                myCommand.Parameters.AddWithValue("_CODE", code.Trim());

                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        isExist = true;
                    }
                }

                dotProjectConnection.Close();
            }

            return isExist;


            //bool exist = false;

            //string query = " select * from projects where project_ot=?CODE;";

            //MySqlConnection myConnection;
            //myConnection = new MySqlConnection(dotProjectConnectionString);
            //myConnection.Open();

            //MySqlCommand myCommand = new MySqlCommand(query, myConnection);
            //myCommand.Parameters.Add("?CODE", code);
            //MySqlDataReader reader = myCommand.ExecuteReader();

            //if (reader.Read())
            //    exist = true;

            //reader.Close();
            //myCommand.Dispose();
            //myConnection.Close();

            //return exist;
        }

        public void UpdateProjectStatusInDotProject(string dotProjectConnectionString, Offer o, int status)
        {
            using (MySqlConnection connRddotTask = new MySqlConnection(dotProjectConnectionString))
            {
                connRddotTask.Open();

                MySqlCommand myCommand = new MySqlCommand("epc_UpdateProjectStatus", connRddotTask);
                myCommand.CommandType = CommandType.StoredProcedure;
                myCommand.Parameters.AddWithValue("_ProjectOt", o.Code);
                myCommand.Parameters.AddWithValue("_Status", status);
                myCommand.ExecuteNonQuery();

                connRddotTask.Close();
            }

            LogEntryByOffer log = new LogEntryByOffer();
            log.IdUser = o.ModifiedBy;
            log.DateTime = DateTime.Now;
            log.Comments = "The project status of dotproject has changed to: {0}"; // "The status of the project of dotproject has changed to: {0}";
            log.IdLogEntryType = 2; // new LogOfferType(2, "Status Changes");

            if (status == 7)
                log.Comments = String.Format(log.Comments, "Ruled Out");
            else if (status == 8)
                log.Comments = String.Format(log.Comments, "Offered");
            //else if (status == 9)
            //    log.Comments = String.Format(log.Comments, "GEOS Request");
            else if (status == 12)
                log.Comments = String.Format(log.Comments, "New PO");

            o.LogEntryByOffers.Add(log);

            //MySqlConnection MyConnection = new MySqlConnection(dotProjectConnectionString);
            //MyConnection.Open();
            //MySqlCommand MyCommand = MyConnection.CreateCommand();
            //MySqlTransaction MyTransaction = MyConnection.BeginTransaction();

            //MyCommand.Connection = MyConnection;
            //MyCommand.Transaction = MyTransaction;

            //MyCommand.CommandText = @"UPDATE projects SET project_status=?STATUS  where project_ot= ?OT";
            //MyCommand.Parameters.AddWithValue("?STATUS", status.ToString());
            //MyCommand.Parameters.AddWithValue("?OT", o.Code);

            //MyCommand.ExecuteNonQuery();
            //MyTransaction.Commit();
            //MyConnection.Close();

            //[001]
            //LogOffer log = new LogOffer();
            //log.User = GOM_v3.Properties.Settings.Default.LOGGED_USER;
            //log.Date = DateTime.Now;
            //log.Comment = "The project status of dotproject has changed to: {0}"; // "The status of the project of dotproject has changed to: {0}";
            //log.Type = new LogOfferType(2, "Status Changes");

            //if (status == 7)
            //    log.Comment = String.Format(log.Comment, "Ruled Out");
            //else if (status == 8)
            //    log.Comment = String.Format(log.Comment, "Offered");
            //else if (status == 12)
            //    log.Comment = String.Format(log.Comment, "New PO");

            //o.Logs.Add(log);
        }

        private void InsertEngAnalysisInDotProject(string dotProjectConnectionString, string connectionString, MailServer mailServer, string workbenchConnectionString, Offer offer, Quotation quotation)
        {
            int idproject;
            int idtaskManagement;
            int idtaskAnalysis;
            TransactionScope transactionScope = null;

            try
            {
                string projectName = GetNextProjectNameFromDotProject(dotProjectConnectionString);
                EmdepSite site = GetEmdepSiteById(Convert.ToInt32(offer.Site.ConnectPlantId), connectionString);

                using (transactionScope = new TransactionScope(TransactionScopeOption.Required, new TransactionOptions() { IsolationLevel = System.Transactions.IsolationLevel.RepeatableRead }))
                {
                    UpdateNextProjectNumberOfDotproject(dotProjectConnectionString);

                    using (MySqlConnection connRddotProject = new MySqlConnection(dotProjectConnectionString))
                    {
                        connRddotProject.Open();

                        MySqlCommand MyCommand = new MySqlCommand("epc_InsertIntoProjects", connRddotProject);
                        MyCommand.CommandType = CommandType.StoredProcedure;

                        //MyCommand.CommandText = @"INSERT INTO projects (project_Internal_name, project_company, project_company_internal, project_department, 
                        //                                project_name, project_ot, project_short_name, project_owner, project_url, project_start_date, project_status, 
                        //                                project_color_identifier, project_description, project_creator,project_departments, project_category, 
                        //                                project_type, project_priority, project_plant, project_origin, project_requester, project_end_date) values(?PROJECTINTERNALNAME, ?PROJECTCOMPANY, 
                        //                                ?PROJECTCOMPANYINTERNAL, ?PROJECTDEPARTMENT, ?PROJECTNAME, ?PROJECTOT, ?PROJECTSHORTNAME, ?PROJECTOWNER, ?PROJECTURL, 
                        //                                ?PROJECTSTARTDATE, ?PROJECTSTATUS, ?PROJECTCOLORIDENTIFIER, ?PROJECTDESCRIPTION, ?PROJECTCREATOR, ?PROJECTDEPARTMENTS,
                        //                                ?PROJECTCATEGORY, ?PROJECTTYPE, ?PROJECTPRIORITY, ?PROJECTPLANT, ?PROJECTORIGIN, ?PROJECT_REQUESTER, ?PROJECTENDDATE)";

                        MyCommand.Parameters.AddWithValue("_projectInternalName", projectName);
                        MyCommand.Parameters.AddWithValue("_projectCompany", 260);
                        MyCommand.Parameters.AddWithValue("_projectCompanyInternal", 0);
                        MyCommand.Parameters.AddWithValue("_projectDepartment", 0);
                        MyCommand.Parameters.AddWithValue("_projectName", offer.Description);
                        MyCommand.Parameters.AddWithValue("_projectOt", offer.Code);

                        if (!string.IsNullOrEmpty(offer.Description))
                        {
                            if (offer.Description.Length >= 10)
                                MyCommand.Parameters.AddWithValue("_projectShortname", offer.Description.Substring(0, 10));
                            else
                                MyCommand.Parameters.AddWithValue("_projectShortname", offer.Description);
                        }
                        else
                        {
                            MyCommand.Parameters.AddWithValue("_projectShortname", string.Empty);
                        }

                        MyCommand.Parameters.AddWithValue("_projectOwner", 3);
                        MyCommand.Parameters.AddWithValue("_projectUrl", @"file://serveres03/rddotproject$/" + DateTime.Now.Year + @"/" + projectName);
                        MyCommand.Parameters.AddWithValue("_projectStartdate", DateTime.Now);
                        MyCommand.Parameters.AddWithValue("_projectStatus", 9);
                        MyCommand.Parameters.AddWithValue("_projectColorIdentifier", "FF000");
                        MyCommand.Parameters.AddWithValue("_projectDescription", offer.Description);

                        if (offer.CreatedBy > 0)
                            MyCommand.Parameters.AddWithValue("_projectCreator", offer.CreatedBy);          // GOM_v3.Properties.Settings.Default.LOGGED_USER.Id.ToString());
                        else
                            MyCommand.Parameters.AddWithValue("_projectCreator", offer.ModifiedBy);

                        MyCommand.Parameters.AddWithValue("_projectDepartments", string.Empty);

                        //If it is automation we keep it in dotproject as TAU (13)
                        if (offer.IdBusinessUnit == (uint)3)
                            MyCommand.Parameters.AddWithValue("?_projectCategory", 13);
                        else
                            MyCommand.Parameters.AddWithValue("_projectCategory", 1);

                        MyCommand.Parameters.AddWithValue("_projectType", 0);
                        MyCommand.Parameters.AddWithValue("_projectPriority", -1);
                        MyCommand.Parameters.AddWithValue("_projectPlant", offer.IdCustomer);                               //   o.Customer.Id.ToString());
                        MyCommand.Parameters.AddWithValue("_projectOrigin", Convert.ToInt32(offer.Site.ConnectPlantId));    // GOM_v3.Properties.Settings.Default.SITE.ToString());

                        if (offer.CreatedBy > 0)
                            MyCommand.Parameters.AddWithValue("_projectRequester", offer.CreatedBy);                            // GOM_v3.Properties.Settings.Default.LOGGED_USER.Id.ToString());
                        else
                            MyCommand.Parameters.AddWithValue("_projectRequester", offer.ModifiedBy);

                        MyCommand.Parameters.AddWithValue("_projectEnddate", null);

                        idproject = Convert.ToInt32(MyCommand.ExecuteScalar());
                        connRddotProject.Close();
                    }

                    //Task - 00. Management
                    using (MySqlConnection connRddotTask = new MySqlConnection(dotProjectConnectionString))
                    {
                        connRddotTask.Open();

                        MySqlCommand MyCommand = new MySqlCommand("epc_InsertIntoTasks", connRddotTask);
                        MyCommand.CommandType = CommandType.StoredProcedure;

                        //MyCommand.CommandText = @"INSERT INTO tasks (task_name,task_project,task_owner,task_start_date,task_description,task_creator, task_end_date, task_duration, task_type)
                        //                VALUES (?TASKNAME,?TASKPROJECT,?TASKOWNER,?TASKSTARTDATE,?TASKDESCRIPTION, ?TASKCREATOR, ?ENDDATE, ?TASKDURATION, ?TASKTYPE)";

                        MyCommand.Parameters.AddWithValue("_taskName", "00. Management");
                        MyCommand.Parameters.AddWithValue("_taskProject", idproject);
                        MyCommand.Parameters.AddWithValue("_taskOwner", 3);
                        MyCommand.Parameters.AddWithValue("_taskStartdate", DateTime.Now);
                        MyCommand.Parameters.AddWithValue("_taskDescription", "Management");

                        if (offer.CreatedBy > 0)
                            MyCommand.Parameters.AddWithValue("_taskCreator", offer.CreatedBy);         // GOM_v3.Properties.Settings.Default.LOGGED_USER.Id.ToString());
                        else
                            MyCommand.Parameters.AddWithValue("_taskCreator", offer.ModifiedBy);

                        MyCommand.Parameters.AddWithValue("_taskDuration", 1);
                        MyCommand.Parameters.AddWithValue("_taskType", 7);

                        if (quotation.Ots[0].DeliveryDate.Value != null)
                            MyCommand.Parameters.AddWithValue("_taskEnddate", quotation.Ots[0].DeliveryDate.Value.ToString("yyyy-MM-dd 00:00:00"));
                        else
                            MyCommand.Parameters.AddWithValue("_taskEnddate", null);

                        idtaskManagement = Convert.ToInt32(MyCommand.ExecuteScalar());
                        connRddotTask.Close();
                    }

                    //Task - 01.Analysis
                    using (MySqlConnection connRddotTask = new MySqlConnection(dotProjectConnectionString))
                    {
                        connRddotTask.Open();

                        MySqlCommand MyCommand = new MySqlCommand("epc_InsertIntoTasks", connRddotTask);
                        MyCommand.CommandType = CommandType.StoredProcedure;

                        //MyCommand.CommandText = @"INSERT INTO tasks (task_name,task_project,task_owner,task_start_date,task_description,task_creator, task_end_date, task_duration, task_type)
                        //                VALUES (?TASKNAME,?TASKPROJECT,?TASKOWNER,?TASKSTARTDATE,?TASKDESCRIPTION, ?TASKCREATOR, ?ENDDATE, ?TASKDURATION, ?TASKTYPE)";

                        MyCommand.Parameters.AddWithValue("_taskName", "01. Analysis");
                        MyCommand.Parameters.AddWithValue("_taskProject", idproject);
                        MyCommand.Parameters.AddWithValue("_taskOwner", 3);
                        MyCommand.Parameters.AddWithValue("_taskStartdate", DateTime.Now);
                        MyCommand.Parameters.AddWithValue("_taskDescription", "Analysis for the offer");

                        if (offer.CreatedBy > 0)
                            MyCommand.Parameters.AddWithValue("_taskCreator", offer.CreatedBy);         // GOM_v3.Properties.Settings.Default.LOGGED_USER.Id.ToString());
                        else
                            MyCommand.Parameters.AddWithValue("_taskCreator", offer.ModifiedBy);

                        MyCommand.Parameters.AddWithValue("_taskDuration", 1);
                        MyCommand.Parameters.AddWithValue("_taskEnddate", null);
                        MyCommand.Parameters.AddWithValue("_taskType", 5);

                        idtaskAnalysis = Convert.ToInt32(MyCommand.ExecuteScalar());
                        connRddotTask.Close();
                    }

                    //Insert custom field values.
                    using (MySqlConnection connRddotCustomField = new MySqlConnection(dotProjectConnectionString))
                    {
                        connRddotCustomField.Open();

                        MySqlCommand MyCommand = new MySqlCommand("epc_InsertIntoCustomFieldsValues", connRddotCustomField);
                        MyCommand.CommandType = CommandType.StoredProcedure;

                        //GOM_v3.Properties.Settings.Default.SITE);

                        //MyCommand.CommandText = @"INSERT INTO custom_fields_values (value_id, value_module, value_object_id,value_field_id,value_charvalue, value_intvalue)
                        //                VALUES ((SELECT id + 1 FROM custom_fields_values_id c),?MODULE, ?ID, ?FIELD_ID, ?CHARVALUE, ?INTVALUE)";

                        MyCommand.Parameters.AddWithValue("_Module", string.Empty);
                        MyCommand.Parameters.AddWithValue("_Id", idproject);
                        MyCommand.Parameters.AddWithValue("_FieldId", 8);
                        MyCommand.Parameters.AddWithValue("_CharValue", "file://" + site.FileServerIP + "/WorkingOrders$/" + offer.Year.ToString() + "/" + offer.Code);
                        MyCommand.Parameters.AddWithValue("_Intvalue", "0");

                        MyCommand.ExecuteNonQuery();

                        connRddotCustomField.Close();

                        //MyCommand.CommandText = @"UPDATE rddotproject.custom_fields_values_id set id=id+1;";
                        //MyCommand.ExecuteNonQuery();
                    }

                    //tasks
                    UpdateTaskParentInDotProject(dotProjectConnectionString, idtaskManagement);
                    UpdateTaskParentInDotProject(dotProjectConnectionString, idtaskAnalysis);

                    transactionScope.Complete();
                }

                // GOM_v3.Properties.Settings.Default.Email_New_Project_DotProject;
                ApplicationManager applicationManager = new ApplicationManager();
                GeosAppSetting geosAppSetting = GetGeosAppSettings(1, workbenchConnectionString);

                applicationManager.SendNewRddotProjectMail(mailServer, geosAppSetting.DefaultValue, projectName, offer, quotation.Ots[0].DeliveryDate.Value.ToString("yyyy-MM-dd"));

                //Email to people.
                //string subject = string.Format("[GEOS notification] New Project {0}", offer.Code);
                //string description = string.Format(@"{0} from Commercial department has created the following project: 
                //                    - Description: {1} 
                //                    - Working Order: {2} 
                //                    - Internal ID: {3}
                //                    - Customer: {4} 
                //                    - Delivery date: {5}", "skhade", offer.Description, offer.Code, projectName, offer.Customer.FullName, quotation.Ots[0].DeliveryDate.Value.ToString("yyyy-MM-dd"));

                /////GOM_v3.Properties.Settings.Default.LOGGED_USER.FullName replaced with skhade
                //string to = ""; // GOM_v3.Properties.Settings.Default.Email_New_Project_DotProject;
                //cm.SendMail(to, GOM_v3.Properties.Settings.Default.LOGGED_USER, string.Empty, subject, description, GOM_v3.Properties.Settings.Default.EMAIL_SERVER);
                //Ho desactivem perqu els comercials no han de tenir perms a R&D
                //CreateFoldersForDotproject(projectName, q);
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();

                throw;
            }
        }

        private string GetNextProjectNameFromDotProject(string dotProjectConnectionString)
        {
            string code = "0000";

            using (MySqlConnection dotProjectConnection = new MySqlConnection(dotProjectConnectionString))
            {
                dotProjectConnection.Open();

                MySqlCommand myCommand = new MySqlCommand("epc_GetNextProjectNameFromConfig", dotProjectConnection);
                myCommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    if (reader.Read())
                        code = Convert.ToString(reader["config_value"]);
                }

                dotProjectConnection.Close();
            }

            code = DateTime.Now.Year + "-PR" + Convert.ToInt32(code.Substring(code.Length - 4));

            return code;



            //string query = @"SELECT config_value FROM config  where config_id=117;";

            //MySqlConnection myConnection = new MySqlConnection(dotProjectConnectionString);
            //myConnection.Open();

            //MySqlCommand myCommand = new MySqlCommand(query, myConnection);
            //MySqlDataReader reader = myCommand.ExecuteReader();

            //if (reader.Read())
            //    code = Convert.ToString(reader["config_value"]);

            //reader.Close();
            //myCommand.Dispose();
            //myConnection.Close();

            //code = DateTime.Now.Year + "-PR" + Convert.ToInt32(code.Substring(code.Length - 4));

            //return code;
        }

        public void UpdateNextProjectNumberOfDotproject(string dotProjectConnectionString)
        {
            using (MySqlConnection connRddotTask = new MySqlConnection(dotProjectConnectionString))
            {
                connRddotTask.Open();
                MySqlCommand MyCommand = new MySqlCommand("epc_UpdateConfig", connRddotTask);
                MyCommand.CommandType = CommandType.StoredProcedure;
                MyCommand.ExecuteNonQuery();
                connRddotTask.Close();
            }

            //MySqlConnection MyConnection = new MySqlConnection(dotProjectConnectionString);
            //MyConnection.Open();
            //MySqlCommand MyCommand = MyConnection.CreateCommand();
            //MySqlTransaction MyTransaction = MyConnection.BeginTransaction();

            //MyCommand.Connection = MyConnection;
            //MyCommand.Transaction = MyTransaction;

            //MyCommand.CommandText = @"UPDATE rddotproject.config set config_value=config_value+1 where config_id=117;";

            //MyCommand.ExecuteNonQuery();
            //MyTransaction.Commit();
            //MyConnection.Close();
        }

        private void UpdateTaskParentInDotProject(string dotProjectConnectionString, int idParent)
        {
            using (MySqlConnection connRddotTask = new MySqlConnection(dotProjectConnectionString))
            {
                connRddotTask.Open();

                MySqlCommand MyCommand = new MySqlCommand("epc_UpdateTasks", connRddotTask);
                MyCommand.CommandType = CommandType.StoredProcedure;
                MyCommand.Parameters.AddWithValue("_TaskId", idParent.ToString());
                MyCommand.ExecuteNonQuery();

                connRddotTask.Close();
            }

            //MySqlConnection MyConnection = new MySqlConnection(dotProjectConnectionString);
            //MyConnection.Open();
            //MySqlCommand MyCommand = MyConnection.CreateCommand();
            //MySqlTransaction MyTransaction = MyConnection.BeginTransaction();

            //MyCommand.Connection = MyConnection;
            //MyCommand.Transaction = MyTransaction;

            //MyCommand.CommandText = @"UPDATE tasks SET TASK_PARENT=?ID where task_id=?ID";
            //MyCommand.Parameters.AddWithValue("?ID", idParent.ToString());

            //MyCommand.ExecuteNonQuery();
            //MyTransaction.Commit();
            //MyConnection.Close();
        }

        private void UpdateEngAnalysisStatus(string dotProjectConnectionString, Offer offer)
        {
            //If the offer contains an engineering analysis
            //and its status is canceled at dotproject passed to Ruled Out (7)
            //if your status is "Only Quoted" goes to Offered (8)
            //If your status is not "Only quoted" or "Canceled" it passes to GeosRequest (9)
            //OfferContainsOfferOption(offer, 25)

            if (offer.OptionsByOffers != null && offer.OptionsByOffers.Exists(x => x.IdOption == 25))
            {
                if (offer.GeosStatus.IdOfferStatusType == 4 && ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                {
                    UpdateProjectStatusInDotProject(dotProjectConnectionString, offer, 7);
                }
                else if (offer.GeosStatus.IdOfferStatusType == 1 && ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                {
                    UpdateProjectStatusInDotProject(dotProjectConnectionString, offer, 8);
                }
                //else if (offer.GeosStatus.IdOfferStatusType != 1 && offer.GeosStatus.IdOfferStatusType != 4 && ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                //    UpdateProjectStatusInDotProject(dotProjectConnectionString, offer, 9);
            }
        }

        public void UpdateEndDateEngAnalysis(string dotProjectConString, string connectionString, Offer offer, Quotation quotation, string workbenchConnectionString, MailServer mailServer)
        {
            string project_ot = offer.Code;
            DateTime task_end_date = quotation.Ots[0].DeliveryDate.Value;

            if (quotation.Ots[0].PrevDeliveryDate == null)
                quotation.Ots[0].PrevDeliveryDate = quotation.Ots[0].DeliveryDate.Value;

            DateTime oldEndDate = quotation.Ots[0].PrevDeliveryDate.Value;

            string description = string.Format("{0} from Commercial department has changed the project delivery date (project {1}). The date has been changed from {2} to {3}", offer.ModifiedByUser.FullName, project_ot, oldEndDate.ToString("yyyy-MM-dd"), task_end_date.ToString("yyyy-MM-dd"));

            bool isProjectInWaitingForQuote = IsProjectInWaitingForQuote(project_ot, connectionString);

            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {
                    if (isProjectInWaitingForQuote)
                    {
                        using (MySqlConnection mySqlConnection = new MySqlConnection(dotProjectConString))
                        {
                            mySqlConnection.Open();

                            MySqlCommand myCommand = new MySqlCommand("epc_UpdateTaskEndDate", mySqlConnection);
                            myCommand.CommandType = CommandType.StoredProcedure;
                            myCommand.Parameters.AddWithValue("_ProjectOt", project_ot);
                            myCommand.Parameters.AddWithValue("_EndDate", task_end_date.ToString("yyyy-MM-dd 00:00:00"));

                            //MyCommand.CommandText = @"UPDATE tasks SET task_end_date=?ENDDATE where task_project=(SELECT project_id from projects where project_ot= ?OT)";

                            myCommand.ExecuteNonQuery();
                            mySqlConnection.Close();
                        }
                    }

                    UpdateEndDateProject(project_ot, task_end_date, dotProjectConString);

                    User systemUser = new User();
                    systemUser.IdUser = 55;
                    int comment_type = 10;
                    InsertProjectComment(project_ot, dotProjectConString, systemUser, description, comment_type);

                    transactionScope.Complete();
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            //SendMail(to, loggedUser, cc, subject, description, smtp);

            // GOM_v3.Properties.Settings.Default.Email_New_Project_DotProject;
            ApplicationManager applicationManager = new ApplicationManager();
            GeosAppSetting geosAppSetting = GetGeosAppSettings(1, workbenchConnectionString);


            if (oldEndDate.ToString("yyyy-MM-dd") != task_end_date.ToString("yyyy-MM-dd"))
                applicationManager.SendUpdateRddotProjectMail(mailServer, geosAppSetting.DefaultValue, offer, oldEndDate.ToString("yyyy-MM-dd"), task_end_date.ToString("yyyy-MM-dd"));

            //(MailServer mailServer, string sendTo, Offer offer, string projectName, string prevDeliveryDate, string deliveryDate)
        }

        private bool IsProjectInWaitingForQuote(string projectCode, string connectionString)
        {
            bool exist = false;

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand myCommand = new MySqlCommand("offers_IsProjectInWaitingForQuote", mySqlConnection);
                myCommand.CommandType = CommandType.StoredProcedure;
                myCommand.Parameters.AddWithValue("_Code", projectCode);

                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    if (reader.Read())
                        exist = true;
                }

                mySqlConnection.Close();
            }

            return exist;

            //bool exist = false;
            //string query = "select * from offers where idstatus=2 and code = ?CODE;";
            //MySqlConnection myConnection;
            //myConnection = new MySqlConnection(connectionString);
            //myConnection.Open();
            //MySqlCommand myCommand = new MySqlCommand(query, myConnection);
            //myCommand.Parameters.AddWithValue("?CODE", projectCode);
            //MySqlDataReader reader = myCommand.ExecuteReader();
            //if (reader.Read())
            //    exist = true;
            //reader.Close();
            //myCommand.Dispose();
            //myConnection.Close();
            //return exist;
        }

        private void UpdateEndDateProject(string project_ot, DateTime task_end_date, string dotProjectConnectionString)
        {
            using (MySqlConnection mySqlConnection = new MySqlConnection(dotProjectConnectionString))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("epc_UpdateProjectEndDate", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;

                //mySqlCommand.CommandText = @"UPDATE projects SET project_end_date=?ENDDATE where project_ot= ?OT";

                mySqlCommand.Parameters.AddWithValue("_ProjectOt", project_ot);
                mySqlCommand.Parameters.AddWithValue("_EndDate", task_end_date.ToString("yyyy-MM-dd 00:00:00"));

                mySqlCommand.ExecuteNonQuery();
                mySqlConnection.Close();
            }


            //mySqlConnection.Open();

            //MySqlCommand myCommand = new MySqlCommand("epc_UpdateTaskEndDate", mySqlConnection);
            //myCommand.CommandType = CommandType.StoredProcedure;
            //myCommand.Parameters.AddWithValue("_ProjectOt", project_ot);
            //myCommand.Parameters.AddWithValue("_EndDate", task_end_date.ToString("yyyy-MM-dd 00:00:00"));

            ////MyCommand.CommandText = @"UPDATE tasks SET task_end_date=?ENDDATE where task_project=(SELECT project_id from projects where project_ot= ?OT)";

            //myCommand.ExecuteNonQuery();
            //mySqlConnection.Close();
        }

        public void InsertProjectComment(string project_ot, string dotProjectConnectionString, User usr, string description, int comment_type)
        {
            uint idProject = GetIdProject(project_ot, dotProjectConnectionString);

            if (idProject != 0)
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(dotProjectConnectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand mySqlCommand = new MySqlCommand("epc_InsertProjectComment", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;

                    //MyCommand.CommandText = @"INSERT INTO project_comments (project_comment_type_id, project_id, project_comment_date, project_comment_text, user_id)
                    //                                VALUES(?project_comment_type_id, ?project_id, ?project_comment_date, ?project_comment_text, ?user_id)";

                    mySqlCommand.Parameters.AddWithValue("_ProjectCommentTypeId", comment_type);
                    mySqlCommand.Parameters.AddWithValue("_ProjectId", idProject);
                    mySqlCommand.Parameters.AddWithValue("_ProjectCommentDate", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                    mySqlCommand.Parameters.AddWithValue("_ProjectCommentText", description);
                    mySqlCommand.Parameters.AddWithValue("_UserId", usr.IdUser);

                    mySqlCommand.ExecuteNonQuery();
                    mySqlConnection.Close();
                }
            }
        }

        private uint GetIdProject(string project_ot, string connectionString)
        {
            uint id = 0;
            //string query = "SELECT project_id from rddotproject.projects where project_ot= ?CODE";

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand myCommand = new MySqlCommand("epc_GetProjectIdByProjectOt", mySqlConnection);
                myCommand.CommandType = CommandType.StoredProcedure;
                myCommand.Parameters.AddWithValue("_CODE", project_ot);

                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    if (reader.Read())
                        id = Convert.ToUInt32(reader["project_id"]);
                }

                mySqlConnection.Close();
            }

            return id;
        }

        /// <summary>
        /// This method is to Get Geos AppSettings by IdAppSetting
        /// </summary>
        /// <param name="IdAppSetting">Get id site</param>
        /// <param name="connectionString">Get connection string</param>
        /// <returns>Geos AppSettings</returns>

        public GeosAppSetting GetGeosAppSettings(Int16 IdAppSetting, string connectionString)
        {
            GeosAppSetting geosAppSetting = new GeosAppSetting();

            using (MySqlConnection MyConnection = new MySqlConnection(connectionString))
            {
                MyConnection.Open();
                MySqlCommand myCommand = new MySqlCommand("geosappsettings_GetGeosAppSettings", MyConnection);
                myCommand.CommandType = CommandType.StoredProcedure;
                myCommand.Parameters.AddWithValue("_IdAppSetting", IdAppSetting);

                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        geosAppSetting.IdAppSetting = IdAppSetting;
                        geosAppSetting.DefaultValue = reader["DefaultValue"].ToString();
                        geosAppSetting.AppSettingName = reader["AppSettingName"].ToString();
                    }

                    reader.Close();
                }

                myCommand.Dispose();
                MyConnection.Close();
            }

            return geosAppSetting;
        }

        #endregion

        public List<OtItem> GetDefaultArticlesByOfferOptionAndTemplate(Int64 idOfferOption, byte idTemplate, string connectionstring)
        {
            List<OtItem> items = new List<OtItem>();

            using (MySqlConnection contemplate = new MySqlConnection(connectionstring))
            {
                contemplate.Open();

                //string templatequery = "SELECT * FROM templates WHERE IdTemplate = 18;";
                MySqlCommand contemplatecommand = new MySqlCommand("GetDefaultArticlesByOfferOptionAndTemplate", contemplate);
                contemplatecommand.CommandType = CommandType.StoredProcedure;
                contemplatecommand.Parameters.AddWithValue("_IdOfferOption", idOfferOption);
                contemplatecommand.Parameters.AddWithValue("_IdTemplate", idTemplate);
                using (MySqlDataReader reader = contemplatecommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        OtItem oi = new OtItem();
                        oi.RevisionItem = new RevisionItem();
                        oi.RevisionItem.WarehouseProduct = new WarehouseProduct();
                        oi.RevisionItem.WarehouseProduct.Article = new Article();
                        oi.Status = new ItemOTStatusType();

                        oi.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(reader["idArticle"]);
                        oi.RevisionItem.WarehouseProduct.Article.Quantity = Convert.ToDouble(reader["quantity"]);
                        oi.RevisionItem.WarehouseProduct.Article.Description = reader["description"].ToString();
                        oi.RevisionItem.WarehouseProduct.Article.Description_es = reader["description_es"].ToString();
                        oi.RevisionItem.WarehouseProduct.Article.Description_fr = reader["description_Fr"].ToString();
                        oi.Status.IdItemOtStatus = Convert.ToUInt16(reader["idDefaultItemOtStatus"]);
                        items.Add(oi);
                    }
                }
            }

            return items;
        }


        private void CreateQuotationWithItems(Quotation q, Offer of, List<OtItem> items, string connectionString)
        {
            MySqlConnection conrevision;
            conrevision = new MySqlConnection(connectionString);

            conrevision.Open();
            MySqlCommand conquotationcommand = conrevision.CreateCommand();
            MySqlTransaction MyTransaction = conrevision.BeginTransaction();

            conquotationcommand.Connection = conrevision;
            conquotationcommand.Transaction = MyTransaction;

            try
            {

                Revision r = q.Revisions[0];
                r.Items = new Dictionary<string, RevisionItem>();

                //insertem la revisi 1
                Revision r1 = new Revision();
                r1.Quotation = q;
                r1.NumRevision = 1;
                r1.CreatedIn = r.CreatedIn;
                r1.CreatedBy = r.CreatedBy;
                r1.ReviewedBy = r.ReviewedBy;
                r1.CreatedIn = r.CreatedIn;
                r1.ExpireDate = r.ExpireDate;
                r1.Comments = r.Comments;
                r1.Items = new Dictionary<string, RevisionItem>();
                r1.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");


                conquotationcommand = new MySqlCommand("revisions_Insert", conrevision);
                conquotationcommand.CommandType = CommandType.StoredProcedure;
                conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r1.ReviewedBy);
                conquotationcommand.Parameters.AddWithValue("_NumRevision", r1.NumRevision);
                conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                conquotationcommand.Parameters.AddWithValue("_ModifiedBy", r1.CreatedBy);
                conquotationcommand.Parameters.AddWithValue("_MadeBy", r1.CreatedBy);
                conquotationcommand.Parameters.AddWithValue("_IdQuotation", r1.Quotation.IdQuotation);
                conquotationcommand.Parameters.AddWithValue("_IdCurrency", of.IdCurrency);
                conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r1.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                conquotationcommand.Parameters.AddWithValue("_CreationDate", r1.CreatedIn);
                conquotationcommand.Parameters.AddWithValue("_Comments", r1.Comments);
                conquotationcommand.Parameters.AddWithValue("_Closed", r1.ApprovedIn);

                r1.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                int i = 1;
                foreach (OtItem oi in items)
                {
                    bool insert = true;
                    //si la oferta es una IC o una CO
                    if (of.Code.StartsWith("C") || (of.Code.StartsWith("IC")))
                    {
                        //si l'article es el 9warranty i la cotitzaci es la de technical assistance l'afegirem
                        if ((oi.RevisionItem.WarehouseProduct.Article.IdArticle != 10590) && (q.Template.IdTemplate == 15))
                            insert = false;

                    }
                    else
                    {
                        //si l'article es el 9warranty i la cotitzaci es la de technical assistance no l'afegirem
                        if ((oi.RevisionItem.WarehouseProduct.Article.IdArticle == 10590) && (q.Template.IdTemplate == 15))
                            insert = false;
                    }

                    if (insert)
                    {
                        string description = "";

                        description = oi.RevisionItem.WarehouseProduct.Article.Description;
                        WarehouseProduct ap = new WarehouseProduct();
                        ap.Article = oi.RevisionItem.WarehouseProduct.Article;
                        ap.Description = description;
                        ap.Parent = 0;
                        conquotationcommand = new MySqlCommand("products_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdProductType", 2);

                        ap.IdWarehouseProduct = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                        conquotationcommand = new MySqlCommand("warehouseproduct_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdWarehouseProduct", ap.IdWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_IdArticle", ap.Article.IdArticle);
                        conquotationcommand.Parameters.AddWithValue("_Description", ap.Description);
                        conquotationcommand.Parameters.AddWithValue("_Parent", ap.Parent);

                        conquotationcommand.ExecuteNonQuery();

                        RevisionItem ri = new RevisionItem();
                        ri.WarehouseProduct = ap;
                        ri.Revision = r;
                        ri.NumItem = i.ToString();
                        ri.Quantity = Convert.ToInt64(oi.RevisionItem.WarehouseProduct.Article.Quantity);
                        ri.UnitPrice = 0;
                        ri.CustomerComment = "";

                        conquotationcommand = new MySqlCommand("revisionitems_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdRevision", ri.Revision.Id);
                        conquotationcommand.Parameters.AddWithValue("_NumItem", ri.NumItem);
                        conquotationcommand.Parameters.AddWithValue("_IdProduct", ri.WarehouseProduct.IdWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_Quantity", ri.Quantity);
                        conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri.UnitPrice);
                        conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                        conquotationcommand.Parameters.AddWithValue("_Validated", false);
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri.CustomerComment);
                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri.Revision.CreatedBy);
                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri.Revision.CreatedBy);

                        ri.IdRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                        RevisionItem ri1 = new RevisionItem();
                        ri1.WarehouseProduct = ap;
                        ri1.Revision = r1;
                        ri1.CreatedBy = r1.CreatedBy;
                        ri1.ModifiedBy = r1.CreatedBy;
                        ri1.NumItem = i.ToString();
                        ri1.Quantity = Convert.ToUInt32(oi.RevisionItem.WarehouseProduct.Article.Quantity);
                        ri1.UnitPrice = 0;
                        ri1.CustomerComment = "";

                        conquotationcommand = new MySqlCommand("revisionitems_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdRevision", ri1.Revision.Id);
                        conquotationcommand.Parameters.AddWithValue("_NumItem", ri1.NumItem);
                        conquotationcommand.Parameters.AddWithValue("_IdProduct", ri1.WarehouseProduct.IdWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_Quantity", ri1.Quantity);
                        conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri1.UnitPrice);
                        conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                        conquotationcommand.Parameters.AddWithValue("_Validated", false);
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri1.CustomerComment);
                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri1.Revision.CreatedBy);
                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri1.Revision.CreatedBy);

                        ri1.IdRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                        r.Items.Add(ri.NumItem, ri);
                        r1.Items.Add(ri1.NumItem, ri1);

                        i++;
                    }
                }

                q.Revisions.Add(r1);

                //insertem la ot
                Ots o = new Ots();
                o.NumOT = 1;
                o.CreationDate = r.CreatedIn;
                o.DeliveryDate = r.CreatedIn.AddDays(15);
                o.CreatedBy = r.CreatedBy;
                o.ReviewedBy = r.CreatedBy;
                o.Code = GetOTCode(Convert.ToInt32(of.Site.ConnectPlantId), q, connectionString);
                o.Year = Convert.ToInt32(q.Year);
                o.Number = Convert.ToInt32(q.Number);
                o.Quotation = q;
                o.Items = new Dictionary<string, OtItem>();

                if (o.IdShippingAddress != 0)
                    o.IdShippingAddress = o.IdShippingAddress;
                else if (of.IdShippingAddress != 0)
                    o.IdShippingAddress = of.IdShippingAddress.Value;
                else
                    o.IdShippingAddress = null;

                //si els tems estan enviats tanquem la OT
                if (items[0].IdItemOtStatus == 10)
                    o.IsClosed = 1;
                else
                    o.IsClosed = 0;

                conquotationcommand = new MySqlCommand("ots_Insert", conrevision);
                conquotationcommand.CommandType = CommandType.StoredProcedure;
                conquotationcommand.Parameters.AddWithValue("_NumOT", o.NumOT);
                conquotationcommand.Parameters.AddWithValue("_CreationDate", o.CreationDate);

                if (of.EngineeringAnalysis != null)
                {
                    conquotationcommand.Parameters.AddWithValue("_DeliveryDate", of.EngineeringAnalysis.DueDate);
                }
                else
                {
                    conquotationcommand.Parameters.AddWithValue("_DeliveryDate", o.DeliveryDate);
                }

                conquotationcommand.Parameters.AddWithValue("_IdSite", of.Site.ConnectPlantId);
                conquotationcommand.Parameters.AddWithValue("_CreatedBy", o.CreatedBy);
                conquotationcommand.Parameters.AddWithValue("_ReviewedBy", o.ReviewedBy);
                conquotationcommand.Parameters.AddWithValue("_Code", o.Code);
                conquotationcommand.Parameters.AddWithValue("_Year", o.Year);
                conquotationcommand.Parameters.AddWithValue("_Number", o.Number);
                conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                conquotationcommand.Parameters.AddWithValue("_ModifiedBy", o.CreatedBy);
                conquotationcommand.Parameters.AddWithValue("_IdAddress", o.IdShippingAddress);
                conquotationcommand.Parameters.AddWithValue("_IsClosed", o.IsClosed);
                conquotationcommand.Parameters.AddWithValue("_IdQuotation", o.Quotation.IdQuotation);

                o.IdOT = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                MyTransaction.Commit();
                conrevision.Close();

                TransactionScope transactionScope = null;

                using (transactionScope = new TransactionScope())
                {
                    try
                    {
                        foreach (KeyValuePair<string, RevisionItem> ri in o.Quotation.Revisions[1].Items)
                        {
                            byte idItemOtStatus = 1;
                            foreach (OtItem it in items)
                            {
                                if (it.RevisionItem.WarehouseProduct.Article.IdArticle == ri.Value.WarehouseProduct.Article.IdArticle)
                                {
                                    idItemOtStatus = Convert.ToByte(it.Status.IdItemOtStatus);
                                    break;
                                }
                            }

                            OtItem oi = InsertItemInOt(of, ri.Value, idItemOtStatus, o, q, connectionString);
                            o.Items.Add(oi.RevisionItem.NumItem, oi);
                            InsertPartNumber(of, oi, connectionString);
                        }

                        transactionScope.Complete();
                    }
                    catch (Exception ex)
                    {
                        if (Transaction.Current != null)
                            Transaction.Current.Rollback();

                        if (transactionScope != null)
                            transactionScope.Dispose();

                        throw;
                    }
                }

                q.Ots = new List<Ots>();
                q.Ots.Add(o);
            }
            catch (Exception ex)
            {
                conrevision.Close();
            }
        }

        private OtItem InsertItemInOt(Offer of, RevisionItem ri, byte idStatus, Ots o, Quotation q, string connectionString)
        {
            OtItem oi = new OtItem();
            oi.Ot = o;
            oi.Quotation = q;
            oi.RevisionItem = ri;
            oi.Status = new ItemOTStatusType();
            oi.Status.IdItemOtStatus = idStatus;

            if (of.EngineeringAnalysis != null)
            {
                oi.CustomerComment = of.EngineeringAnalysis.Comments;

                //[CRM-M040-02] (#49016) Validate Eng. Analysis
                if (of.EngineeringAnalysis.IsCompleted)
                {
                    oi.Status.IdItemOtStatus = 10;
                }
            }
            else
            {
                oi.CustomerComment = "";
            }

            using (MySqlConnection conrevision = new MySqlConnection(connectionString))
            {
                conrevision.Open();

                try
                {
                    MySqlCommand conquotationcommand = new MySqlCommand("otitems_Insert", conrevision);
                    conquotationcommand.CommandType = CommandType.StoredProcedure;
                    conquotationcommand.Parameters.AddWithValue("_IdOT", oi.Ot.IdOT);
                    conquotationcommand.Parameters.AddWithValue("_IdRevisionItem", oi.RevisionItem.IdRevisionItem);
                    conquotationcommand.Parameters.AddWithValue("_IdItemOTStatus", oi.Status.IdItemOtStatus);
                    conquotationcommand.Parameters.AddWithValue("_CustomerComment", oi.CustomerComment);
                    conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                    conquotationcommand.Parameters.AddWithValue("_CreatedBy", oi.RevisionItem.CreatedBy);
                    conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                    conquotationcommand.Parameters.AddWithValue("_ModifiedBy", oi.RevisionItem.CreatedBy);

                    oi.IdOTItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                    conrevision.Close();
                }
                catch (Exception ex)
                {
                    throw;
                }

            }
            return oi;
        }


        private OtItem InsertItemInOt_V2041(Offer of, RevisionItem ri, byte idStatus, Ots o, Quotation q, string connectionString)
        {
            OtItem oi = new OtItem();
            oi.Ot = o;
            oi.Quotation = q;
            oi.RevisionItem = ri;
            oi.Status = new ItemOTStatusType();
            oi.Status.IdItemOtStatus = idStatus;

            if (of.EngineeringAnalysis != null)
            {
                oi.CustomerComment = of.EngineeringAnalysis.Comments;

                //[CRM-M040-02] (#49016) Validate Eng. Analysis
                if (of.EngineeringAnalysis.IsCompleted)
                {
                    oi.Status.IdItemOtStatus = 10;
                }
            }
            else
            {
                oi.CustomerComment = "";
            }

            using (MySqlConnection conrevision = new MySqlConnection(connectionString))
            {
                conrevision.Open();

                try
                {
                    MySqlCommand conquotationcommand = new MySqlCommand("CRM_otitemsInsert_V2041", conrevision);
                    conquotationcommand.CommandType = CommandType.StoredProcedure;
                    conquotationcommand.Parameters.AddWithValue("_IdOT", oi.Ot.IdOT);
                    conquotationcommand.Parameters.AddWithValue("_IdRevisionItem", oi.RevisionItem.IdRevisionItem);
                    conquotationcommand.Parameters.AddWithValue("_IdItemOTStatus", oi.Status.IdItemOtStatus);
                    conquotationcommand.Parameters.AddWithValue("_CustomerComment", oi.CustomerComment);
                    conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                    conquotationcommand.Parameters.AddWithValue("_CreatedBy", oi.RevisionItem.CreatedBy);
                    conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                    conquotationcommand.Parameters.AddWithValue("_ModifiedBy", oi.RevisionItem.CreatedBy);

                    oi.IdOTItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                    conrevision.Close();
                }
                catch (Exception ex)
                {
                    throw;
                }

            }
            return oi;
        }

        private void InsertPartNumber(Offer offer, OtItem oi, string connectionString)
        {
            string barCode = GetBarCode(oi.Quotation.Code);

            for (int i = 1; i <= oi.RevisionItem.Quantity; i++)
            {
                string code = barCode + Convert.ToUInt32(oi.RevisionItem.NumItem).ToString("000") + i.ToString("000");
                uint idPartNumber = 0;

                using (MySqlConnection conrevision = new MySqlConnection(connectionString))
                {
                    conrevision.Open();

                    try
                    {
                        MySqlCommand conquotationcommand = new MySqlCommand("PartNumbers_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_CODE", code);
                        conquotationcommand.Parameters.AddWithValue("_OTITEM", oi.IdOTItem);
                        conquotationcommand.Parameters.AddWithValue("_IdPartNumberType", null);
                        conquotationcommand.Parameters.AddWithValue("_IdPackingBox", null);
                        conquotationcommand.Parameters.AddWithValue("_ID", null);

                        idPartNumber = Convert.ToUInt32(conquotationcommand.ExecuteScalar());
                    }
                    catch (Exception ex)
                    {
                        throw;
                    }
                }

                //busquem les etapes de l'article  i per cada etapa creem un tracking
                List<int> stages = new List<int>();

                using (MySqlConnection conrevision = new MySqlConnection(connectionString))
                {
                    conrevision.Open();

                    try
                    {
                        MySqlCommand conStagesArticlecommand = new MySqlCommand("Get_StagesByArticle", conrevision);
                        conStagesArticlecommand.CommandType = CommandType.StoredProcedure;
                        conStagesArticlecommand.Parameters.AddWithValue("_IdArticle", oi.RevisionItem.WarehouseProduct.Article.IdArticle);
                        conStagesArticlecommand.Parameters.AddWithValue("_IdSite", Convert.ToInt32(offer.Site.ConnectPlantId));
                        conStagesArticlecommand.Parameters.AddWithValue("_IdStage", null);
                        conStagesArticlecommand.Parameters.AddWithValue("_Sequence", null);

                        using (MySqlDataReader reader = conStagesArticlecommand.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                stages.Add(Convert.ToInt32(reader["idStage"]));
                            }
                        }

                        conrevision.Close();
                    }
                    catch (Exception ex)
                    {
                        throw;
                    }
                }

                //si l'etapa es COMERCIAL (1) la creem en l'usuari que hi ha logat, sin en l'usuari system
                //i sense endDate. l'startDate es modificar quan l'article arribi a cada etapa
                foreach (int stg in stages)
                {
                    using (MySqlConnection conrevision = new MySqlConnection(connectionString))
                    {
                        conrevision.Open();

                        try
                        {
                            MySqlCommand conPNTcommand = new MySqlCommand("PartNumbersTracking_Insert", conrevision);
                            conPNTcommand.CommandType = CommandType.StoredProcedure;
                            conPNTcommand.Parameters.AddWithValue("_IdPartNumber", idPartNumber);
                            conPNTcommand.Parameters.AddWithValue("_IdStage", stg);
                            conPNTcommand.Parameters.AddWithValue("_StartDate", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            conPNTcommand.Parameters.AddWithValue("_CurrentTime", Convert.ToInt32(0));
                            conPNTcommand.Parameters.AddWithValue("_Rework", false);

                            //Unused
                            conPNTcommand.Parameters.AddWithValue("_IdCause", null);
                            conPNTcommand.Parameters.AddWithValue("_Remarks", null);

                            if (stg == 1)
                            {
                                conPNTcommand.Parameters.AddWithValue("_EndDate", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                conPNTcommand.Parameters.AddWithValue("_IdOperator", oi.RevisionItem.CreatedBy);
                                conPNTcommand.Parameters.AddWithValue("_Paused", false);
                            }
                            else if (stg == 23 && offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.IsCompleted)
                            {
                                conPNTcommand.Parameters.AddWithValue("_EndDate", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                conPNTcommand.Parameters.AddWithValue("_IdOperator", oi.RevisionItem.CreatedBy);
                                conPNTcommand.Parameters.AddWithValue("_Paused", false);
                            }
                            else
                            {
                                conPNTcommand.Parameters.AddWithValue("_EndDate", null);
                                conPNTcommand.Parameters.AddWithValue("_IdOperator", null);
                                conPNTcommand.Parameters.AddWithValue("_Paused", true);
                            }

                            conPNTcommand.ExecuteNonQuery();
                            conrevision.Close();
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }
                    }
                }
            }
        }


        //Modified the function to GET the barcode with the suffix and 4 or 5 digits depending
        //if the number of the quotation is new (5 digits) or old (4 digits)
        public string GetBarCode(string quotationCode)
        {
            string barCode = String.Empty;

            switch (quotationCode.Substring(0, 1))
            {
                case "C":
                    if (quotationCode.Length == 7)
                    {
                        //Ejemplo: C10001A
                        barCode = quotationCode.Substring(0, quotationCode.Length - 1);
                    }
                    if (quotationCode.Length == 8)
                    {
                        //Ejemplo:  C100001A
                        barCode = quotationCode.Substring(0);
                    }
                    else if (quotationCode.Length == 9)
                    {
                        //Ejemplo: C10MA001A
                        barCode = quotationCode.Substring(0, 3) + quotationCode.Substring(5, 3);
                    }
                    else if (quotationCode.Length == 10)
                    {
                        //Ejemplo:  C10MA0001A
                        barCode = quotationCode.Substring(0, 3) + quotationCode.Substring(5);
                    }
                    break;
                case "T":
                    if (quotationCode.Length == 7 || quotationCode.Length == 8)
                    {
                        //Ejemplo: T10-045, T10-045A
                        if (char.IsDigit(Convert.ToChar(quotationCode.Remove(0, quotationCode.Length - 1))))
                            barCode = quotationCode.Substring(0, 3) + quotationCode.Substring(4);
                        else
                            barCode = quotationCode.Substring(0, 3) + quotationCode.Substring(4, 4).PadLeft(5, '0');
                    }
                    else if (quotationCode.Length == 9 || quotationCode.Length == 10)
                    {
                        //Ejemplo: T10MA-045, T10MA-045A
                        if (char.IsDigit(Convert.ToChar(quotationCode.Remove(0, quotationCode.Length - 1))))
                            barCode = quotationCode.Substring(0, 3) + quotationCode.Substring(6);
                        else
                            barCode = quotationCode.Substring(0, 3) + quotationCode.Substring(6, 4).PadLeft(5, '0');
                    }
                    break;
                case "I":
                    {
                        if (quotationCode.Substring(1, 1) == "C")
                        {
                            if (quotationCode.Length == 8)
                            {
                                //Ejemplo: IC10001A
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 4).PadLeft(5, '0');
                            }
                            if (quotationCode.Length == 9)
                            {
                                //Ejemplo:  IC100001A
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 5);
                            }
                            else if (quotationCode.Length == 10)
                            {
                                //Ejemplo: IC10MA001A
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 4).PadLeft(5, '0');
                            }
                            else if (quotationCode.Length == 11)
                            {
                                //Ejemplo:  IC10MA0001A
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 5);
                            }
                            break;
                        }
                        else if (quotationCode.Substring(1, 1) == "E")
                        {
                            if (quotationCode.Length == 8)
                            {
                                //Ejemplo: IC10001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 4).PadLeft(5, '0');
                            }
                            if (quotationCode.Length == 9)
                            {
                                //Ejemplo:  IC100001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 5);
                            }
                            else if (quotationCode.Length == 10)
                            {
                                //Ejemplo: IC10MA001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 4).PadLeft(5, '0');
                            }
                            else if (quotationCode.Length == 11)
                            {
                                //Ejemplo:  IC10MA0001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 5);
                            }
                            break;
                        }
                        else if (quotationCode.Substring(1, 1) == "T")
                        {
                            if (quotationCode.Length == 8)
                            {
                                //Ejemplo: IC10001A
                                barCode = "H" + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 4).PadLeft(5, '0');
                            }
                            if (quotationCode.Length == 9)
                            {
                                //Ejemplo:  IC100001A
                                barCode = "H" + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 5);
                            }
                            else if (quotationCode.Length == 10)
                            {
                                //Ejemplo: IC10MA001A
                                barCode = "H" + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 4).PadLeft(5, '0');
                            }
                            else if (quotationCode.Length == 11)
                            {
                                //Ejemplo:  IC10MA0001A
                                barCode = "H" + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 5);
                            }
                            break;
                        }
                        else if (quotationCode.Substring(1, 1) == "S")
                        {
                            if (quotationCode.Length == 8)
                            {
                                //Ejemplo: IC10001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 4).PadLeft(5, '0');
                            }
                            if (quotationCode.Length == 9)
                            {
                                //Ejemplo:  IC100001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 5);
                            }
                            else if (quotationCode.Length == 10)
                            {
                                //Ejemplo: IC10MA001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 4).PadLeft(5, '0');
                            }
                            else if (quotationCode.Length == 11)
                            {
                                //Ejemplo:  IC10MA0001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 5);
                            }
                            break;
                        }
                        else if (quotationCode.Substring(1, 1) == "W")
                        {
                            if (quotationCode.Length == 8)
                            {
                                //Ejemplo: IC10001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 4).PadLeft(5, '0');
                            }
                            if (quotationCode.Length == 9)
                            {
                                //Ejemplo:  IC100001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 5);
                            }
                            else if (quotationCode.Length == 10)
                            {
                                //Ejemplo: IC10MA001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 4).PadLeft(5, '0');
                            }
                            else if (quotationCode.Length == 11)
                            {
                                //Ejemplo:  IC10MA0001A
                                barCode = quotationCode.Substring(1, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 5);
                            }
                            break;
                        }
                        break;
                    }

                case "R":
                    {

                        if (quotationCode.Length == 8 || quotationCode.Length == 9)
                        {
                            //Ejemplo: RD10044, RD10044A
                            if (char.IsDigit(Convert.ToChar(quotationCode.Remove(0, quotationCode.Length - 1))))
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 5);
                            else
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(4, 4).PadLeft(5, '0');
                        }
                        else if (quotationCode.Length == 10 || quotationCode.Length == 11)
                        {
                            //Ejemplo: RD10MA044, RD10MA044A
                            if (char.IsDigit(Convert.ToChar(quotationCode.Remove(0, quotationCode.Length - 1))))
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6);
                            else
                                barCode = quotationCode.Substring(0, 1) + quotationCode.Substring(2, 2) + quotationCode.Substring(6, 4).PadLeft(5, '0');
                        }

                        break;
                    }

                default:
                    //Si el codi te 5 digits posarem el sufixe, sin no
                    string[] splittedCode = quotationCode.Split('-');
                    //No renombrarem els nmeros d'items si el codi de la cotitzaci es major de 5 digits (4 del nmero mes 1 del sufix)
                    if (splittedCode.Length > 1 && splittedCode[1].Length > 5)
                        barCode = quotationCode.Substring(2, 2) + quotationCode.Substring(quotationCode.IndexOf('-') + 1);
                    else
                        barCode = quotationCode.Substring(2, 2) + quotationCode.Substring(quotationCode.IndexOf('-') + 1, 4);
                    break;
            }

            return barCode;
        }

        private string GetPlantCodeByIdSite(Int32 idSite, string connectionString)
        {
            string plantCode = string.Empty;


            using (MySqlConnection conrevision = new MySqlConnection(connectionString))
            {
                conrevision.Open();
                try
                {

                    MySqlCommand conquotationcommand = new MySqlCommand("emdepsites_GetEmdepSitesByIdSite", conrevision);
                    conquotationcommand.CommandType = CommandType.StoredProcedure;
                    conquotationcommand.Parameters.AddWithValue("_IdSite", idSite);
                    using (MySqlDataReader sitereader = conquotationcommand.ExecuteReader())
                    {
                        if (sitereader.Read())
                        {
                            plantCode = sitereader["Code"].ToString();
                        }
                    }



                }
                catch (Exception ex)
                {

                    throw;
                }
            }

            return plantCode;
        }

        private bool IsSupply(string code)
        {
            Regex exp = new Regex(@"^\d{4}-\d{4}$|^\d{4}-\d{4}[A-z]$|^\d{4}[A-z]{2}-\d{4}$|^\d{4}[A-z]{2}-\d{4}[A-z]$|^\d{4}-\d{5}$|^\d{4}-\d{5}[A-z]$|^\d{4}[A-z]{2}-\d{5}$|^\d{4}[A-z]{2}-\d{5}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }
        private bool IsComplaint(string code)
        {
            Regex exp = new Regex(@"^C\d{5}$|^C\d{5}[A-z]$|^C\d{2}[A-z]{2}\d{3}$|^C\d{2}[A-z]{2}\d{3}[A-z]$|^C\d{6}[A-z]$|^C\d{2}[A-z]{2}\d{4}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }
        private bool IsInternalOrder(string code)
        {
            Regex exp = new Regex(@"^IC\d{5}$|^IC\d{5}[A-z]$|^IC\d{2}[A-z]{2}\d{3}$|^IC\d{2}[A-z]{2}\d{3}[A-z]$|^IC\d{2}[A-z]{2}\d{4}[A-z]$|^IC\d{6}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }
        private bool IsTechnicianMaterials(string code)
        {
            Regex exp = new Regex(@"^T\d{2}-d{3}$|^T\d{2}-d{3}[A-z]$|^T\d{2}[A-z]{2}-\d{3}$|^T\d{2}[A-z]{2}-\d{3}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }

        private bool IsInternalEmdep(string code)
        {
            Regex exp = new Regex(@"^IE\d{5}$|^IE\d{5}[A-z]$|^IE\d{2}[A-z]{2}\d{3}$|^IE\d{2}[A-z]{2}\d{3}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }

        private bool IsITO(string code)
        {
            Regex exp = new Regex(@"^IT\d{5}$|^IT\d{5}[A-z]$|^IT\d{2}[A-z]{2}\d{3}$|^IT\d{2}[A-z]{2}\d{3}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }

        private bool IsIS(string code)
        {
            Regex exp = new Regex(@"^IS\d{5}$|^IS\d{5}[A-z]$|^IS\d{2}[A-z]{2}\d{3}$|^IS\d{2}[A-z]{2}\d{3}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }

        private bool IsEngenieeringDepartment(string code)
        {
            Regex exp = new Regex(@"^RD\d{5}$|^RD\d{5}[A-z]$|^RD\d{2}[A-z]{2}\d{3}$|^RD\d{2}[A-z]{2}\d{3}[A-z]$");
            if (exp.IsMatch(code))
                return true;
            else
                return false;
        }

        public string GetOTCode(Int32 IdPlant, Quotation q, string connectionString)
        {
            string OTCode = q.Code;
            string plantCode = GetPlantCodeByIdSite(IdPlant, connectionString);

            if (IsSupply(OTCode))
            {
                OTCode = q.Code.Substring(0, 4);
                OTCode += plantCode + "-" + q.Code.Substring(q.Code.IndexOf("-") + 1);
            }
            else if (IsComplaint(OTCode))
            {
                OTCode = q.Code.Substring(0, 3);
                if (Char.IsDigit(Convert.ToChar(q.Code.Substring(q.Code.Length - 1))))
                    OTCode += plantCode + q.Code.Substring(q.Code.Length - 3);
                else if (q.Code.Length == 8 || q.Code.Length == 10)
                    OTCode += plantCode + q.Code.Substring(q.Code.Length - 5);
                else
                    OTCode += plantCode + q.Code.Substring(q.Code.Length - 4);
            }
            else if ((IsInternalOrder(OTCode)) || (IsInternalEmdep(OTCode)) || (IsEngenieeringDepartment(OTCode)) || IsITO(OTCode) || IsIS(OTCode))
            {
                OTCode = q.Code.Substring(0, 4);
                if (Char.IsDigit(Convert.ToChar(q.Code.Substring(q.Code.Length - 1))))
                    OTCode += plantCode + q.Code.Substring(q.Code.Length - 3);
                else if (q.Code.Length == 9 || q.Code.Length == 11)
                    OTCode += plantCode + q.Code.Substring(q.Code.Length - 5);
                else
                    OTCode += plantCode + q.Code.Substring(q.Code.Length - 4);
            }
            else if (IsTechnicianMaterials(OTCode))
            {
                OTCode = q.Code.Substring(0, 3);
                OTCode += plantCode + q.Code.Substring(q.Code.IndexOf("-") + 1);
            }

            return OTCode;
        }

        /// <summary>
        /// This method is to add log entry by offer
        /// </summary>
        /// <param name="offer">Get added offer details</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="offerPlantConnectstr">Get offer plant connectionstring</param>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           mgr.AddLogEntryByOffer(offer,connectionstring,offerPlantConnectstr);
        ///          //SP:- logEntryByOffer_Insert
        ///          //QUERY:-"update logentriesbyoffer set comments='" + logEntryByOffer.Comments + "', dateTime='" + DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss") + "'  where idLogEntry=" + logEntryByOffer.IdLogEntry + ";";
        ///          //QUERY:- "delete from logentriesbyoffer where idLogEntry=" + logEntryByOffer.IdLogEntry + ";";
        ///        
        ///     }
        /// }
        /// </code>
        /// </example>
        public void AddLogEntryByOffer(Offer offer, string connectionstring, string offerPlantConnectstr)
        {
            try
            {
                if (offerPlantConnectstr == null)
                    offerPlantConnectstr = connectionstring;

                if (offer.LogEntryByOffers != null)
                {
                    foreach (LogEntryByOffer logEntryByOffer in offer.LogEntryByOffers)
                    {
                        if (logEntryByOffer.IsUpdate)
                        {
                            if (logEntryByOffer.IdLogEntry > 0)
                            {
                                using (MySqlConnection conlogEntryByOffer = new MySqlConnection(offerPlantConnectstr))
                                {
                                    conlogEntryByOffer.Open();
                                    using (MySqlTransaction trans = conlogEntryByOffer.BeginTransaction())
                                    {
                                        try
                                        {
                                            //string query = "update logentriesbyoffer set comments='" + logEntryByOffer.Comments + "', dateTime='" + DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss") + "'  where idLogEntry=" + logEntryByOffer.IdLogEntry + ";";
                                            MySqlCommand conlogEntryByOffercommand = new MySqlCommand("logEntryByOffer_Update", conlogEntryByOffer);
                                            conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                                            conlogEntryByOffercommand.Parameters.AddWithValue("_IdLogEntry", logEntryByOffer.IdLogEntry);
                                            conlogEntryByOffercommand.Parameters.AddWithValue("_Comment", logEntryByOffer.Comments);
                                            conlogEntryByOffercommand.Parameters.AddWithValue("_logDatetime", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                            conlogEntryByOffercommand.Parameters.AddWithValue("_IsRtfText", logEntryByOffer.IsRtfText);
                                            conlogEntryByOffercommand.Transaction = trans;
                                            conlogEntryByOffercommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }
                            }
                        }

                        else if (logEntryByOffer.IsDeleted)
                        {
                            if (logEntryByOffer.IdLogEntry > 0)
                            {
                                using (MySqlConnection conlogEntryByOffer = new MySqlConnection(offerPlantConnectstr))
                                {
                                    conlogEntryByOffer.Open();
                                    using (MySqlTransaction trans = conlogEntryByOffer.BeginTransaction())
                                    {
                                        try
                                        {
                                            // string query = "delete from logentriesbyoffer where idLogEntry=" + logEntryByOffer.IdLogEntry + ";";
                                            MySqlCommand conlogEntryByOffercommand = new MySqlCommand("logEntryByOffer_Delete", conlogEntryByOffer);
                                            conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                                            conlogEntryByOffercommand.Parameters.AddWithValue("_IdLogEntry", logEntryByOffer.IdLogEntry);
                                            conlogEntryByOffercommand.Transaction = trans;
                                            conlogEntryByOffercommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            using (MySqlConnection conlogEntryByOffer = new MySqlConnection(offerPlantConnectstr))
                            {
                                conlogEntryByOffer.Open();
                                using (MySqlTransaction trans = conlogEntryByOffer.BeginTransaction())
                                {
                                    try
                                    {
                                        MySqlCommand conlogEntryByOffercommand = new MySqlCommand("logEntryByOffer_Insert", conlogEntryByOffer);
                                        conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_IdUser", logEntryByOffer.IdUser);
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_Comments", logEntryByOffer.Comments);
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_IdLogEntryType", logEntryByOffer.IdLogEntryType);
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_IsRtfText", logEntryByOffer.IsRtfText);
                                        conlogEntryByOffercommand.Transaction = trans;
                                        conlogEntryByOffercommand.ExecuteNonQuery();
                                        trans.Commit();
                                    }
                                    catch (Exception ex)
                                    {
                                        trans.Rollback();
                                        throw;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;

            }
        }

        /// <summary>
        /// This method is to add log entry by site
        /// </summary>
        /// <param name="site">Site details</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           mgr.AddLogEntryBySite(site,connectionstring);
        ///          //SP:- logEntryBySite_Insert
        ///          //QUERY:-"update log_entries_by_site set comments='" + logEntryBySite.Comments + "', dateTime='" + DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss") + "'  where IdLogEntriesBySite=" + logEntryBySite.IdLogEntryBySite + ";";
        ///          //QUERY:- "delete from log_entries_by_site where IdLogEntriesBySite=" + logEntryBySite.IdLogEntryBySite + ";";
        ///        
        ///     }
        /// }
        /// </code>
        /// </example>
        public void AddLogEntryBySite(Company site, string connectionstring)
        {
            try
            {
                if (site.LogEntryBySites != null)
                {
                    foreach (LogEntryBySite logEntryBySite in site.LogEntryBySites)
                    {
                        if (logEntryBySite.IsUpdate)
                        {
                            if (logEntryBySite.IdLogEntryBySite > 0)
                            {
                                using (MySqlConnection conlogEntryBySite = new MySqlConnection(connectionstring))
                                {
                                    conlogEntryBySite.Open();

                                    //using (MySqlTransaction trans = conlogEntryBySite.BeginTransaction())
                                    //{
                                    //    try
                                    //    {
                                    //string query = "update log_entries_by_site set comments='" + logEntryBySite.Comments + "', dateTime='" + DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss") + "'  where IdLogEntriesBySite=" + logEntryBySite.IdLogEntryBySite + ";";

                                    MySqlCommand conlogEntryBySitecommand = new MySqlCommand("logEntriesBySite_Update", conlogEntryBySite);
                                    conlogEntryBySitecommand.CommandType = CommandType.StoredProcedure;

                                    conlogEntryBySitecommand.Parameters.AddWithValue("_IdLogEntriesBySite", logEntryBySite.IdLogEntryBySite);
                                    conlogEntryBySitecommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                                    conlogEntryBySitecommand.Parameters.AddWithValue("_Comments", logEntryBySite.Comments);
                                    //conlogEntryBySitecommand.Transaction = trans;
                                    conlogEntryBySitecommand.ExecuteNonQuery();
                                    conlogEntryBySite.Close();

                                    //trans.Commit();
                                    //    }
                                    //    catch (Exception ex)
                                    //    {
                                    //        trans.Rollback();
                                    //        throw;
                                    //    }
                                    //}
                                }
                            }
                        }

                        else if (logEntryBySite.IsDeleted)
                        {
                            if (logEntryBySite.IdLogEntryBySite > 0)
                            {
                                using (MySqlConnection conlogEntryBySite = new MySqlConnection(connectionstring))
                                {
                                    conlogEntryBySite.Open();

                                    //using (MySqlTransaction trans = conlogEntryBySite.BeginTransaction())
                                    //{
                                    //    try
                                    //    {
                                    //string query = "delete from log_entries_by_site where IdLogEntriesBySite=" + logEntryBySite.IdLogEntryBySite + ";";

                                    MySqlCommand conlogEntryBySitecommand = new MySqlCommand("logEntriesBySite_Delete", conlogEntryBySite);
                                    conlogEntryBySitecommand.CommandType = CommandType.StoredProcedure;

                                    conlogEntryBySitecommand.Parameters.AddWithValue("_IdLogEntriesBySite", logEntryBySite.IdLogEntryBySite);
                                    //conlogEntryBySitecommand.Transaction = trans;
                                    conlogEntryBySitecommand.ExecuteNonQuery();
                                    conlogEntryBySite.Close();

                                    //    trans.Commit();
                                    //}
                                    //catch (Exception ex)
                                    //{
                                    //    trans.Rollback();
                                    //    throw;
                                    //}
                                    //}

                                }
                            }
                        }
                        else
                        {
                            using (MySqlConnection conlogEntryBySite = new MySqlConnection(connectionstring))
                            {
                                conlogEntryBySite.Open();

                                //using (MySqlTransaction trans = conlogEntryBySite.BeginTransaction())
                                //{
                                //    try
                                //    {

                                MySqlCommand conlogEntryBySitecommand = new MySqlCommand("logEntryBySite_Insert", conlogEntryBySite);
                                conlogEntryBySitecommand.CommandType = CommandType.StoredProcedure;
                                conlogEntryBySitecommand.Parameters.AddWithValue("_IdSite", site.IdCompany);
                                conlogEntryBySitecommand.Parameters.AddWithValue("_IdUser", logEntryBySite.IdUser);
                                conlogEntryBySitecommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                                conlogEntryBySitecommand.Parameters.AddWithValue("_Comments", logEntryBySite.Comments);

                                //conlogEntryBySitecommand.Parameters.AddWithValue("_IdLogEntryType", logEntryBySite.IdLogEntryType);
                                //conlogEntryBySitecommand.Transaction = trans;

                                conlogEntryBySitecommand.ExecuteNonQuery();
                                conlogEntryBySite.Close();

                                //trans.Commit();
                                //    }
                                //    catch (Exception ex)
                                //    {
                                //        trans.Rollback();
                                //        throw;
                                //    }
                                //}
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }
        }

        /// <summary>
        /// This method is to add site by business product
        /// </summary>
        /// <param name="site">Get site details</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           mgr.AddSiteByBusinessProduct(site,connectionstring);
        ///          //QUERY:-"insert into sites_by_businessproduct( IdSite, IdBusinessProduct) values(" + site.IdCompany + "," + sitesByBusinessProduct.IdBusinessProduct + ")";
        ///          //QUERY:- "delete from sites_by_businessproduct where IdSite=" + site.IdCompany + " and IdBusinessProduct=" + sitesByBusinessProduct.IdBusinessProduct + ";";
        ///        
        ///     }
        /// }
        /// </code>
        /// </example>
        public void AddSiteByBusinessProduct(Company site, string connectionstring)
        {
            try
            {
                if (site.BusinessProductList != null)
                {
                    foreach (SitesByBusinessProduct sitesByBusinessProduct in site.BusinessProductList)
                    {
                        if (sitesByBusinessProduct.IsAdded)
                        {
                            if (site.IdCompany > 0 && sitesByBusinessProduct.IdBusinessProduct > 0)
                            {
                                using (MySqlConnection consitesByBusinessProduct = new MySqlConnection(connectionstring))
                                {
                                    consitesByBusinessProduct.Open();
                                    //using (MySqlTransaction trans = consitesByBusinessProduct.BeginTransaction())
                                    //{
                                    //    try
                                    //    {
                                    //string query = "insert into sites_by_businessproduct( IdSite, IdBusinessProduct) values(" + site.IdCompany + "," + sitesByBusinessProduct.IdBusinessProduct + ")";

                                    MySqlCommand consitesByBusinessProductcommand = new MySqlCommand("sitesByBusinessproduct_Insert", consitesByBusinessProduct);
                                    consitesByBusinessProductcommand.CommandType = CommandType.StoredProcedure;
                                    consitesByBusinessProductcommand.Parameters.AddWithValue("_IdSite", site.IdCompany);
                                    consitesByBusinessProductcommand.Parameters.AddWithValue("_IdBusinessProduct", sitesByBusinessProduct.IdBusinessProduct);
                                    //consitesByBusinessProductcommand.Transaction = trans;
                                    consitesByBusinessProductcommand.ExecuteNonQuery();
                                    consitesByBusinessProduct.Close();

                                    //    trans.Commit();
                                    //}
                                    //catch (Exception ex)
                                    //{
                                    //    trans.Rollback();
                                    //    throw;
                                    //}
                                    //}
                                }
                            }
                        }
                        else if (sitesByBusinessProduct.IsDeleted)
                        {
                            if (site.IdCompany > 0 && sitesByBusinessProduct.IdBusinessProduct > 0)
                            {
                                using (MySqlConnection conlogEntryBySite = new MySqlConnection(connectionstring))
                                {
                                    conlogEntryBySite.Open();
                                    //using (MySqlTransaction trans = conlogEntryBySite.BeginTransaction())
                                    //{
                                    //    try
                                    //    {
                                    string query = "delete from sites_by_businessproduct where IdSite=" + site.IdCompany + " and IdBusinessProduct=" + sitesByBusinessProduct.IdBusinessProduct + ";";
                                    MySqlCommand conlogEntryBySitecommand = new MySqlCommand(query, conlogEntryBySite);
                                    //conlogEntryBySitecommand.Transaction = trans;
                                    conlogEntryBySitecommand.ExecuteNonQuery();
                                    conlogEntryBySite.Close();
                                    //        trans.Commit();
                                    //    }
                                    //    catch (Exception ex)
                                    //    {
                                    //        trans.Rollback();
                                    //        throw;
                                    //    }
                                    //}
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }
        }

        /// <summary>
        /// This method is to add log entry by offer
        /// </summary>
        /// <param name="logEntryByOffer">Get log entry by offer details</param>
        /// <param name="connectionString">Get connection string</param>
        /// <param name="offerPlantConnectstr">Get offer plant connection string</param>
        /// <returns>Is inserted or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           bool isInserted = mgr.AddLogEntryByOffer(logEntryByOffer,connectionstring,offerPlantConnectstr);
        ///          //SP:-logEntryByOffer_Insert
        ///     }
        /// }
        /// </code>
        /// </example>
        public bool AddLogEntryByOffer(LogEntryByOffer logEntryByOffer, string connectionString, string offerPlantConnectstr)
        {
            bool isInserted = false;
            try
            {
                if (offerPlantConnectstr == null)
                    offerPlantConnectstr = connectionString;
                using (MySqlConnection conlogEntryByOffer = new MySqlConnection(offerPlantConnectstr))
                {
                    conlogEntryByOffer.Open();
                    using (MySqlTransaction trans = conlogEntryByOffer.BeginTransaction())
                    {
                        try
                        {
                            MySqlCommand conlogEntryByOffercommand = new MySqlCommand("logEntryByOffer_Insert", conlogEntryByOffer);
                            conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                            conlogEntryByOffercommand.Parameters.AddWithValue("_IdOffer", logEntryByOffer.IdOffer);
                            conlogEntryByOffercommand.Parameters.AddWithValue("_IdUser", logEntryByOffer.IdUser);
                            conlogEntryByOffercommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                            conlogEntryByOffercommand.Parameters.AddWithValue("_Comments", logEntryByOffer.Comments);
                            conlogEntryByOffercommand.Parameters.AddWithValue("_IdLogEntryType", logEntryByOffer.IdLogEntryType);
                            conlogEntryByOffercommand.Parameters.AddWithValue("_IsRtfText", logEntryByOffer.IsRtfText);

                            conlogEntryByOffercommand.Transaction = trans;
                            conlogEntryByOffercommand.ExecuteNonQuery();
                            isInserted = true;
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;

            }
            return isInserted;
        }

        /// <summary>
        /// This method is to add log entry by site
        /// </summary>
        /// <param name="logEntryBySite">Get logEntryBySite details</param>
        /// <param name="connectionString">Get connection string</param>
        /// <returns>Is inserted or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           bool isInserted = mgr.AddLogEntryBySite(logEntryBySite,connectionstring);
        ///          //SP:-logEntryBySite_Insert
        ///     }
        /// }
        /// </code>
        /// </example>
        public bool AddLogEntryBySite(LogEntryBySite logEntryBySite, string connectionString)
        {
            bool isInserted = false;
            try
            {

                using (MySqlConnection conlogEntryBySite = new MySqlConnection(connectionString))
                {
                    conlogEntryBySite.Open();
                    using (MySqlTransaction trans = conlogEntryBySite.BeginTransaction())
                    {
                        try
                        {
                            MySqlCommand conlogEntryBySitecommand = new MySqlCommand("logEntryBySite_Insert", conlogEntryBySite);
                            conlogEntryBySitecommand.CommandType = CommandType.StoredProcedure;
                            conlogEntryBySitecommand.Parameters.AddWithValue("_IdSite", logEntryBySite.IdSite);
                            conlogEntryBySitecommand.Parameters.AddWithValue("_IdUser", logEntryBySite.IdUser);
                            conlogEntryBySitecommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                            conlogEntryBySitecommand.Parameters.AddWithValue("_Comments", logEntryBySite.Comments);
                            //conlogEntryBySitecommand.Parameters.AddWithValue("_IdLogEntryType", logEntryBySite.IdLogEntryType);
                            conlogEntryBySitecommand.Transaction = trans;
                            conlogEntryBySitecommand.ExecuteNonQuery();
                            isInserted = true;
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;

            }
            return isInserted;
        }

        /// <summary>
        /// This method is to add offer contact
        /// </summary>
        /// <param name="offerContacts">Get offer contact details</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idOffer">Get offer id</param>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          mgr.AddOfferContact(offerContacts,connectionstring,idOffer);
        ///          //SP:-offercontact_Insert
        ///     }
        /// }
        /// </code>
        /// </example>
        public void AddOfferContact(List<OfferContact> offerContacts, string connectionstring, Int64 idOffer)
        {

            try
            {
                if (offerContacts != null)
                {
                    foreach (OfferContact offerContact in offerContacts)
                    {
                        if (offerContact.IsDeleted == true)
                        {
                            bool isdelete = IsDeletedOfferContact(offerContact, connectionstring);
                        }
                        else
                        {
                            using (MySqlConnection conlogEntryByOffer = new MySqlConnection(connectionstring))
                            {
                                conlogEntryByOffer.Open();
                                using (MySqlTransaction trans = conlogEntryByOffer.BeginTransaction())
                                {
                                    try
                                    {
                                        MySqlCommand conlogEntryByOffercommand = new MySqlCommand("offercontact_Insert", conlogEntryByOffer);
                                        conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_IdOffer", idOffer);
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_IdContact", offerContact.IdContact);
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_IsPrimaryOfferContact", offerContact.IsPrimaryOfferContact);
                                        conlogEntryByOffercommand.Transaction = trans;
                                        int idOfferContact = Convert.ToInt32(conlogEntryByOffercommand.ExecuteScalar());
                                        trans.Commit();
                                    }
                                    catch (Exception ex)
                                    {
                                        trans.Rollback();
                                        throw;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }

        }

        /// <summary>
        /// This method is to deleted offer contact
        /// </summary>
        /// <param name="offerContact">Get offer contact details</param>
        /// <param name="connectionstring">Get connecting string</param>
        /// <returns>Is deleted or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          bool isDeleted = mgr.IsDeletedOfferContact(offerContacts,connectionstring);
        ///          //QUERY:-" delete from offer_contacts where IdOffer=" + offerContact.IdOffer + " and IdContact=" + offerContact.IdContact + ";";
        ///     }
        /// }
        /// </code>
        /// </example>
        private bool IsDeletedOfferContact(OfferContact offerContact, string connectionstring)
        {
            bool isDeleted = false;

            try
            {
                using (MySqlConnection conlogEntryByOffer = new MySqlConnection(connectionstring))
                {
                    conlogEntryByOffer.Open();
                    using (MySqlTransaction trans = conlogEntryByOffer.BeginTransaction())
                    {
                        try
                        {
                            // string query = " delete from offer_contacts where IdOffer=" + offerContact.IdOffer + " and IdContact=" + offerContact.IdContact + ";";
                            MySqlCommand conlogEntryByOffercommand = new MySqlCommand("offercontacts_Delete", conlogEntryByOffer);
                            conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                            conlogEntryByOffercommand.Parameters.AddWithValue("_IdOffer", offerContact.IdOffer);
                            conlogEntryByOffercommand.Parameters.AddWithValue("_IdContact", offerContact.IdContact);
                            conlogEntryByOffercommand.Transaction = trans;
                            conlogEntryByOffercommand.ExecuteNonQuery();
                            isDeleted = true;
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                throw;

            }
            return isDeleted;
        }

        /// <summary>
        /// This method is to set primary offer contact
        /// </summary>
        /// <param name="offerContact">Get offer conatct details</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>Is set primary or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          bool isSetPrimary = mgr.IsSetPrimaryOfferContact(offerContacts,connectionstring);
        ///          //QUERY:-" update offer_contacts set IsPrimaryOfferContact = " + offerContact.IsPrimaryOfferContact + " where IdOffer=" + offerContact.IdOffer + " and IdContact=" + offerContact.IdContact + ";";
        ///     }
        /// }
        /// </code>
        /// </example>
        public bool IsSetPrimaryOfferContact(OfferContact offerContact, string connectionstring)
        {
            bool isSetPrimary = false;
            try
            {

                using (MySqlConnection conlogEntryByOffer = new MySqlConnection(offerContact.Site.ConnectPlantConstr))
                {
                    conlogEntryByOffer.Open();
                    using (MySqlTransaction trans = conlogEntryByOffer.BeginTransaction())
                    {
                        try
                        {
                            // string query = " update offer_contacts set IsPrimaryOfferContact = " + offerContact.IsPrimaryOfferContact + " where IdOffer=" + offerContact.IdOffer + " and IdContact=" + offerContact.IdContact + ";";
                            MySqlCommand conlogEntryByOffercommand = new MySqlCommand("offercontacts_SetIsPrimaryOfferContact", conlogEntryByOffer);
                            conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                            conlogEntryByOffercommand.Parameters.AddWithValue("_IdOffer", offerContact.IdOffer);
                            conlogEntryByOffercommand.Parameters.AddWithValue("_IdContact", offerContact.IdContact);
                            conlogEntryByOffercommand.Parameters.AddWithValue("_IsPrimaryOfferContact", offerContact.IsPrimaryOfferContact);
                            conlogEntryByOffercommand.Transaction = trans;
                            conlogEntryByOffercommand.ExecuteNonQuery();
                            isSetPrimary = true;
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                throw;

            }
            return isSetPrimary;
        }

        public CarProject AddCarProject(CarProject carProject, string mainconnectionstring)
        {
            // CarProject addCarProject = new CarProject();
            try
            {
                using (MySqlConnection conoffer = new MySqlConnection(mainconnectionstring))
                {
                    conoffer.Open();
                    //string query = "select * from car_projects where name = '" + carProject.Name.Trim() + "';";
                    MySqlCommand conoffercommand = new MySqlCommand("carprojects_GetCarProjectsExist", conoffer);

                    conoffercommand.CommandType = CommandType.StoredProcedure;
                    conoffercommand.Parameters.AddWithValue("_Name", carProject.Name.Trim());

                    using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                    {
                        if (offerreader.Read())
                        {
                            carProject.IdCarProject = -1;
                        }
                        else
                        {
                            using (MySqlConnection concompany = new MySqlConnection(mainconnectionstring))
                            {
                                concompany.Open();
                                using (MySqlTransaction trans = concompany.BeginTransaction())
                                {
                                    try
                                    {
                                        MySqlCommand concompanycommand = new MySqlCommand("carprojects_Insert", concompany);
                                        concompanycommand.CommandType = CommandType.StoredProcedure;

                                        concompanycommand.Parameters.AddWithValue("_Name", carProject.Name.Trim());
                                        concompanycommand.Parameters.AddWithValue("_IdCarOem", carProject.IdCarOem);
                                        concompanycommand.Parameters.AddWithValue("_CreationDate", DateTime.Now);
                                        carProject.IdCarProject = Convert.ToInt32(concompanycommand.ExecuteScalar());

                                        trans.Commit();
                                    }
                                    catch (Exception ex)
                                    {
                                        trans.Rollback();
                                        throw;
                                    }
                                }

                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {

                throw;
            }
            return carProject;
        }

        public CarProject AddCarProjectWithCreatedBy(CarProject carProject, string mainconnectionstring)
        {
            // CarProject addCarProject = new CarProject();
            try
            {
                using (MySqlConnection conoffer = new MySqlConnection(mainconnectionstring))
                {
                    conoffer.Open();
                    // string query = "select * from car_projects where name = '" + carProject.Name.Trim() + "';";
                    MySqlCommand conoffercommand = new MySqlCommand("carprojects_GetCarProjectsExist", conoffer);
                    conoffercommand.CommandType = CommandType.StoredProcedure;
                    conoffercommand.Parameters.AddWithValue("_Name", carProject.Name.Trim());

                    using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                    {
                        if (offerreader.Read())
                        {
                            carProject.IdCarProject = -1;
                        }
                        else
                        {
                            using (MySqlConnection concompany = new MySqlConnection(mainconnectionstring))
                            {
                                concompany.Open();
                                using (MySqlTransaction trans = concompany.BeginTransaction())
                                {
                                    try
                                    {
                                        MySqlCommand concompanycommand = new MySqlCommand("carprojects_InsertWithCreatedBy", concompany);
                                        concompanycommand.CommandType = CommandType.StoredProcedure;

                                        concompanycommand.Parameters.AddWithValue("_Name", carProject.Name.Trim());
                                        concompanycommand.Parameters.AddWithValue("_IdCarOem", carProject.IdCarOem);
                                        concompanycommand.Parameters.AddWithValue("_CreationDate", DateTime.Now);
                                        concompanycommand.Parameters.AddWithValue("_CreatedBy", carProject.CreatedBy);
                                        carProject.IdCarProject = Convert.ToInt32(concompanycommand.ExecuteScalar());

                                        trans.Commit();
                                    }
                                    catch (Exception ex)
                                    {
                                        trans.Rollback();
                                        throw;
                                    }
                                }

                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {

                throw;
            }
            return carProject;
        }

        public bool IsExistCarProject(string connectionString, string Name)
        {
            bool isExist = false;

            using (MySqlConnection myConnection = new MySqlConnection(connectionString))
            {
                myConnection.Open();
                //MySqlCommand myCommand = new MySqlCommand("select * from car_projects where name='" + Name.Trim() + "';", myConnection);

                MySqlCommand myCommand = new MySqlCommand("carprojects_GetCarProjectsExist", myConnection);
                myCommand.CommandType = CommandType.StoredProcedure;
                myCommand.Parameters.AddWithValue("_Name", Name.Trim());


                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        isExist = true;
                    }
                }

            }
            return isExist;
        }


        public List<CarProject> GetCarProject(Int32 idCustomer, string connectionstring)
        {
            List<CarProject> carProjects = new List<CarProject>();
            try
            {
                using (MySqlConnection consite = new MySqlConnection(connectionstring))
                {
                    consite.Open();
                    //string query = "select cp.IdCarProject,cp.Name As ProjectName,cp.IdCarOem ,co.Name As CarOEM,cp.CreationDate from car_projects cp inner join caroems co on co.IdCarOEM = cp.IdCarOem order by CreationDate desc";
                    MySqlCommand consitecommand = new MySqlCommand("carProjects_GetAllCarProjects", consite);
                    consitecommand.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                    {
                        while (sitereader.Read())
                        {
                            CarProject carProject = new CarProject();
                            carProject.IdCarProject = Convert.ToInt64(sitereader["IdCarProject"].ToString());
                            carProject.Name = sitereader["ProjectName"].ToString();
                            carProject.IdCarOem = Convert.ToInt32(sitereader["IdCarOem"].ToString());
                            //carProject.IdCustomer = Convert.ToInt32(sitereader["IdCustomer"].ToString());
                            carProject.CreationDate = Convert.ToDateTime(sitereader["CreationDate"].ToString());
                            carProject.CarOEM = new CarOEM();
                            carProject.CarOEM.IdCarOEM = Convert.ToInt32(sitereader["IdCarOem"].ToString());
                            carProject.CarOEM.Name = sitereader["CarOEM"].ToString();
                            carProjects.Add(carProject);
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                throw;
            }
            return carProjects;
        }

        public List<LookupValue> GetBusinessUnitStatusWise(byte idCurrency, Int32 idUser, Int64 accountingYear, Int32 idPermission, Company company)
        {
            List<LookupValue> lookupValues = new List<LookupValue>();
            try
            {
                using (MySqlConnection consite = new MySqlConnection(company.ConnectPlantConstr))
                {
                    consite.Open();
                    MySqlCommand consitecommand = new MySqlCommand("offers_GetBusinessUnitStatusWise", consite);
                    consitecommand.CommandType = CommandType.StoredProcedure;
                    consitecommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                    consitecommand.Parameters.AddWithValue("_idUser", idUser);
                    consitecommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                    consitecommand.Parameters.AddWithValue("_idPermission", idPermission);
                    using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                    {
                        while (sitereader.Read())
                        {
                            if (sitereader["IdBusinessUnit"] != DBNull.Value)
                            {
                                if (lookupValues.Any(lv => lv.IdLookupValue == Convert.ToInt32(sitereader["IdBusinessUnit"].ToString())))
                                {
                                    LookupValue lookupValue = lookupValues.Where(lv => lv.IdLookupValue == Convert.ToInt32(sitereader["IdBusinessUnit"].ToString())).FirstOrDefault();
                                    SalesStatusType salesStatusType = new SalesStatusType();
                                    if (sitereader["IdSalesStatusType"] != DBNull.Value)
                                        salesStatusType.IdSalesStatusType = Convert.ToInt64(sitereader["IdSalesStatusType"].ToString());
                                    if (sitereader["Status"] != DBNull.Value)
                                        salesStatusType.Name = sitereader["Status"].ToString();
                                    if (sitereader["Amount"] != DBNull.Value)
                                        salesStatusType.TotalAmount = Convert.ToDouble(sitereader["Amount"].ToString());
                                    if (sitereader["IdCurrency"] != DBNull.Value)
                                    {
                                        salesStatusType.Currency = new Currency();
                                        salesStatusType.Currency.IdCurrency = Convert.ToByte(sitereader["IdCurrency"].ToString());
                                        salesStatusType.Currency.Name = sitereader["Currency"].ToString();
                                    }
                                    lookupValue.SalesStatusTypes.Add(salesStatusType);
                                }
                                else
                                {
                                    LookupValue lookupValue = new LookupValue();
                                    lookupValue.IdLookupValue = Convert.ToInt32(sitereader["IdBusinessUnit"].ToString());
                                    lookupValue.Value = sitereader["BusinessUnit"].ToString();
                                    lookupValue.SalesStatusTypes = new List<SalesStatusType>();
                                    SalesStatusType salesStatusType = new SalesStatusType();
                                    if (sitereader["IdSalesStatusType"] != DBNull.Value)
                                        salesStatusType.IdSalesStatusType = Convert.ToInt64(sitereader["IdSalesStatusType"].ToString());
                                    if (sitereader["Status"] != DBNull.Value)
                                        salesStatusType.Name = sitereader["Status"].ToString();
                                    if (sitereader["Amount"] != DBNull.Value)
                                        salesStatusType.TotalAmount = Convert.ToDouble(sitereader["Amount"].ToString());
                                    if (sitereader["IdCurrency"] != DBNull.Value)
                                    {
                                        salesStatusType.Currency = new Currency();
                                        salesStatusType.Currency.IdCurrency = Convert.ToByte(sitereader["IdCurrency"].ToString());
                                        salesStatusType.Currency.Name = sitereader["Currency"].ToString();
                                    }
                                    lookupValue.SalesStatusTypes.Add(salesStatusType);
                                    lookupValues.Add(lookupValue);
                                }
                            }
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                throw;
            }
            return lookupValues;
        }



        public List<LookupValue> GetBusinessUnitStatusWise(byte idCurrency, Int32 idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Int32 idPermission, Company company)
        {
            List<LookupValue> lookupValues = new List<LookupValue>();
            try
            {
                using (MySqlConnection consite = new MySqlConnection(company.ConnectPlantConstr))
                {
                    consite.Open();
                    MySqlCommand consitecommand = new MySqlCommand("offers_GetBusinessUnitStatusWiseDateWise", consite);
                    consitecommand.CommandType = CommandType.StoredProcedure;
                    consitecommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                    consitecommand.Parameters.AddWithValue("_idUser", idUser);
                    consitecommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                    consitecommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                    consitecommand.Parameters.AddWithValue("_idPermission", idPermission);
                    consitecommand.Parameters.AddWithValue("_idCurrentUser", idUser);

                    using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                    {
                        while (sitereader.Read())
                        {
                            if (sitereader["IdBusinessUnit"] != DBNull.Value)
                            {
                                if (lookupValues.Any(lv => lv.IdLookupValue == Convert.ToInt32(sitereader["IdBusinessUnit"].ToString())))
                                {
                                    LookupValue lookupValue = lookupValues.Where(lv => lv.IdLookupValue == Convert.ToInt32(sitereader["IdBusinessUnit"].ToString())).FirstOrDefault();
                                    SalesStatusType salesStatusType = new SalesStatusType();
                                    if (sitereader["IdSalesStatusType"] != DBNull.Value)
                                        salesStatusType.IdSalesStatusType = Convert.ToInt64(sitereader["IdSalesStatusType"].ToString());
                                    if (sitereader["Status"] != DBNull.Value)
                                        salesStatusType.Name = sitereader["Status"].ToString();
                                    if (sitereader["Amount"] != DBNull.Value)
                                        salesStatusType.TotalAmount = Convert.ToDouble(sitereader["Amount"].ToString());
                                    if (sitereader["IdCurrency"] != DBNull.Value)
                                    {
                                        salesStatusType.Currency = new Currency();
                                        salesStatusType.Currency.IdCurrency = Convert.ToByte(sitereader["IdCurrency"].ToString());
                                        salesStatusType.Currency.Name = sitereader["Currency"].ToString();
                                    }
                                    lookupValue.SalesStatusTypes.Add(salesStatusType);
                                }
                                else
                                {
                                    LookupValue lookupValue = new LookupValue();
                                    lookupValue.IdLookupValue = Convert.ToInt32(sitereader["IdBusinessUnit"].ToString());
                                    lookupValue.Value = sitereader["BusinessUnit"].ToString();
                                    lookupValue.SalesStatusTypes = new List<SalesStatusType>();
                                    SalesStatusType salesStatusType = new SalesStatusType();
                                    if (sitereader["IdSalesStatusType"] != DBNull.Value)
                                        salesStatusType.IdSalesStatusType = Convert.ToInt64(sitereader["IdSalesStatusType"].ToString());
                                    if (sitereader["Status"] != DBNull.Value)
                                        salesStatusType.Name = sitereader["Status"].ToString();
                                    if (sitereader["Amount"] != DBNull.Value)
                                        salesStatusType.TotalAmount = Convert.ToDouble(sitereader["Amount"].ToString());
                                    if (sitereader["IdCurrency"] != DBNull.Value)
                                    {
                                        salesStatusType.Currency = new Currency();
                                        salesStatusType.Currency.IdCurrency = Convert.ToByte(sitereader["IdCurrency"].ToString());
                                        salesStatusType.Currency.Name = sitereader["Currency"].ToString();
                                    }
                                    lookupValue.SalesStatusTypes.Add(salesStatusType);
                                    lookupValues.Add(lookupValue);
                                }
                            }
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                throw;
            }
            return lookupValues;
        }

        public List<LookupValue> GetPlantQuotaAmountBUWise(string assignedPlant, byte idCurrency, Int64 accountingYear, string connectionString)
        {
            List<LookupValue> lookupValues = new List<LookupValue>();
            try
            {
                using (MySqlConnection consite = new MySqlConnection(connectionString))
                {
                    consite.Open();
                    MySqlCommand consitecommand = new MySqlCommand("PlantBusinessUnitSalesQuota_GetPlantQuotaAmountBUWise", consite);
                    consitecommand.CommandType = CommandType.StoredProcedure;
                    consitecommand.Parameters.AddWithValue("_assignedPlant", assignedPlant);
                    consitecommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                    consitecommand.Parameters.AddWithValue("_accountingYear", accountingYear);

                    using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                    {
                        while (sitereader.Read())
                        {
                            if (sitereader["IdBusinessUnit"] != DBNull.Value)
                            {
                                LookupValue lookupValue = new LookupValue();
                                if (sitereader["IdBusinessUnit"] != DBNull.Value)
                                    lookupValue.IdLookupValue = Convert.ToInt32(sitereader["IdBusinessUnit"].ToString());
                                if (sitereader["Value"] != DBNull.Value)
                                    lookupValue.Value = sitereader["Value"].ToString();
                                if (sitereader["SalesQuotaAmount"] != DBNull.Value)
                                    lookupValue.SalesQuotaAmount = Convert.ToDouble(sitereader["SalesQuotaAmount"].ToString());
                                if (sitereader["IdSalesQuotaCurrency"] != DBNull.Value)
                                    lookupValue.IdSalesQuotaCurrency = Convert.ToByte(sitereader["IdSalesQuotaCurrency"].ToString());
                                lookupValues.Add(lookupValue);
                            }
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                throw;
            }
            return lookupValues;
        }


        public List<LookupValue> GetPlantQuotaAmountBUWise(string assignedPlant, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, string connectionString)
        {
            List<LookupValue> lookupValues = new List<LookupValue>();
            try
            {
                using (MySqlConnection consite = new MySqlConnection(connectionString))
                {
                    consite.Open();
                    MySqlCommand consitecommand = new MySqlCommand("PlantBusinessUnitSalesQuota_GetPlantQuotaAmountBUWiseDatewise", consite);
                    consitecommand.CommandType = CommandType.StoredProcedure;
                    consitecommand.Parameters.AddWithValue("_assignedPlant", assignedPlant);
                    consitecommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                    consitecommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                    consitecommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                    using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                    {
                        while (sitereader.Read())
                        {
                            if (sitereader["IdBusinessUnit"] != DBNull.Value)
                            {
                                LookupValue lookupValue = new LookupValue();
                                if (sitereader["IdBusinessUnit"] != DBNull.Value)
                                    lookupValue.IdLookupValue = Convert.ToInt32(sitereader["IdBusinessUnit"].ToString());
                                if (sitereader["Value"] != DBNull.Value)
                                    lookupValue.Value = sitereader["Value"].ToString();
                                if (sitereader["SalesQuotaAmount"] != DBNull.Value)
                                    lookupValue.SalesQuotaAmount = Convert.ToDouble(sitereader["SalesQuotaAmount"].ToString());
                                if (sitereader["IdSalesQuotaCurrency"] != DBNull.Value)
                                    lookupValue.IdSalesQuotaCurrency = Convert.ToByte(sitereader["IdSalesQuotaCurrency"].ToString());
                                lookupValues.Add(lookupValue);
                            }
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                throw;
            }
            return lookupValues;
        }

        /// <summary>
        /// This method is to add company details
        /// </summary>
        /// <param name="company">Get company details to add</param>
        /// <param name="mainServerConnectionString">Get main server connecting string</param>
        /// <param name="crmconnectionstring">Get local crm connecting string</param>
        /// <returns>Added company details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string mainconnectionString = ConfigurationManager.ConnectionStrings["MainServerContext"].ConnectionString;
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          Company company = mgr.AddCompany(company,mainconnectionstring,crmconnectionstring);
        ///          //QUERY:-"select * from sites where name='" + sitename + "' and IdCustomer=" + company.IdCustomer + " ;";
        ///          //SP:-sites_Insert
        ///          //Method:-AddSiteByBusinessProduct(company, mainconnectionstring);
        ///                    AddLogEntryBySite(company, crmconnectionstring);
        ///     }
        /// }
        /// </code>
        /// </example>
        public Company AddCompany(Company company, string mainServerConnectionString, string crmConnectionString, Company emdepSite = null)
        {
            //Int32 companyId = 0;
            bool IsAccountExists = false;

            string sitename = company.Name + " (" + company.Country.Name + ")";
            sitename = sitename.ToString().Replace("'", "\"");

            using (TransactionScope transactionScope = new System.Transactions.TransactionScope())
            {
                try
                {
                    using (MySqlConnection connExistSite = new MySqlConnection(mainServerConnectionString))
                    {
                        connExistSite.Open();

                        MySqlCommand conoffercommand = new MySqlCommand("sites_GetSiteNameCustomerIdExist", connExistSite);
                        conoffercommand.CommandType = CommandType.StoredProcedure;
                        conoffercommand.Parameters.AddWithValue("_SiteName", sitename);
                        conoffercommand.Parameters.AddWithValue("_IdCustomer", company.IdCustomer);

                        using (MySqlDataReader siteReader = conoffercommand.ExecuteReader())
                        {
                            if (siteReader.Read())
                            {
                                company.IdCompany = -1;
                                IsAccountExists = true;
                            }
                        }

                        connExistSite.Close();
                    }

                    if (!IsAccountExists)
                    {
                        using (MySqlConnection connCompany = new MySqlConnection(mainServerConnectionString))
                        {
                            connCompany.Open();

                            //MySqlCommand concompanycommand = new MySqlCommand("sites_Insert", connCompany);

                            using (MySqlCommand concompanycommand = new MySqlCommand("sites_Insert", connCompany))
                            {
                                concompanycommand.CommandType = CommandType.StoredProcedure;
                                concompanycommand.Parameters.AddWithValue("_IdCustomer", company.IdCustomer);
                                concompanycommand.Parameters.AddWithValue("_Name", company.Name);
                                concompanycommand.Parameters.AddWithValue("_IdCountry", company.IdCountry);
                                concompanycommand.Parameters.AddWithValue("_Address", company.Address);
                                concompanycommand.Parameters.AddWithValue("_Telephone", company.Telephone);
                                concompanycommand.Parameters.AddWithValue("_Email", company.Email);
                                concompanycommand.Parameters.AddWithValue("_Region", company.Region);
                                concompanycommand.Parameters.AddWithValue("_Fax", company.Fax);
                                concompanycommand.Parameters.AddWithValue("_IdBusinessCenter", company.IdBusinessCenter);
                                concompanycommand.Parameters.AddWithValue("_IdBusinessField", company.IdBusinessField);
                                concompanycommand.Parameters.AddWithValue("_Size", company.Size);
                                concompanycommand.Parameters.AddWithValue("_CuttingMachines", company.CuttingMachines);
                                concompanycommand.Parameters.AddWithValue("_NumberOfEmployees", company.NumberOfEmployees);
                                concompanycommand.Parameters.AddWithValue("_Line", company.Line);
                                concompanycommand.Parameters.AddWithValue("_Website", company.Website);
                                concompanycommand.Parameters.AddWithValue("_City", company.City);
                                concompanycommand.Parameters.AddWithValue("_PostCode", company.ZipCode);
                                concompanycommand.Parameters.AddWithValue("_CreatedBy", company.CreatedBy);
                                concompanycommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                concompanycommand.Parameters.AddWithValue("_IdBusinessType", company.IdBusinessType);
                                concompanycommand.Parameters.AddWithValue("_Latitude", company.Latitude);
                                concompanycommand.Parameters.AddWithValue("_Longitude", company.Longitude);
                                concompanycommand.Parameters.AddWithValue("_ShortName", company.ShortName);
                                concompanycommand.Parameters.AddWithValue("_IdSalesResponsible", company.IdSalesResponsible);
                                concompanycommand.Parameters.AddWithValue("_IdSalesResponsibleAssemblyBU", company.IdSalesResponsibleAssemblyBU);

                                company.IdCompany = Convert.ToInt32(concompanycommand.ExecuteScalar());
                            }

                            //[CRM-M024-15] Add default emdep plant when creating a new account.
                            if (emdepSite != null)
                            {
                                using (MySqlCommand concompanycommand = new MySqlCommand("sites_CustomerSitesByEmdepSiteInsert", connCompany))
                                {
                                    concompanycommand.CommandType = CommandType.StoredProcedure;
                                    concompanycommand.Parameters.AddWithValue("_IdCustomerSite", company.IdCompany);
                                    concompanycommand.Parameters.AddWithValue("_IdEmdepSite", emdepSite.IdCompany);
                                    concompanycommand.Parameters.AddWithValue("_AccountingCode", null);
                                    concompanycommand.ExecuteNonQuery();
                                }
                            }

                            connCompany.Close();
                        }

                        if (company.IdCompany > 0)
                        {
                            AddSiteByBusinessProduct(company, mainServerConnectionString);
                            AddLogEntryBySite(company, mainServerConnectionString);
                        }

                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            //try
            //{
            //using (MySqlConnection conoffer = new MySqlConnection(mainconnectionstring))
            //{
            //    conoffer.Open();

            //    MySqlCommand conoffercommand = new MySqlCommand("sites_GetSiteNameCustomerIdExist", conoffer);
            //    conoffercommand.CommandType = CommandType.StoredProcedure;
            //    conoffercommand.Parameters.AddWithValue("_SiteName", sitename);
            //    conoffercommand.Parameters.AddWithValue("_IdCustomer", company.IdCustomer);

            //    using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
            //    {
            //        if (offerreader.Read())
            //        {
            //            company.IdCompany = -1;
            //        }
            //        else
            //        {
            //            using (MySqlConnection concompany = new MySqlConnection(mainconnectionstring))
            //            {
            //                concompany.Open();
            //                using (MySqlTransaction trans = concompany.BeginTransaction())
            //                {
            //                    try
            //                    {
            //                        MySqlCommand concompanycommand = new MySqlCommand("sites_Insert", concompany);
            //                        concompanycommand.CommandType = CommandType.StoredProcedure;
            //                        concompanycommand.Parameters.AddWithValue("_IdCustomer", company.IdCustomer);
            //                        concompanycommand.Parameters.AddWithValue("_Name", company.Name);
            //                        concompanycommand.Parameters.AddWithValue("_IdCountry", company.IdCountry);
            //                        concompanycommand.Parameters.AddWithValue("_Address", company.Address);
            //                        concompanycommand.Parameters.AddWithValue("_Telephone", company.Telephone);
            //                        concompanycommand.Parameters.AddWithValue("_Email", company.Email);
            //                        concompanycommand.Parameters.AddWithValue("_Region", company.Region);
            //                        concompanycommand.Parameters.AddWithValue("_Fax", company.Fax);
            //                        concompanycommand.Parameters.AddWithValue("_IdBusinessCenter", company.IdBusinessCenter);
            //                        concompanycommand.Parameters.AddWithValue("_IdBusinessField", company.IdBusinessField);
            //                        concompanycommand.Parameters.AddWithValue("_Size", company.Size);
            //                        concompanycommand.Parameters.AddWithValue("_CuttingMachines", company.CuttingMachines);
            //                        concompanycommand.Parameters.AddWithValue("_NumberOfEmployees", company.NumberOfEmployees);
            //                        concompanycommand.Parameters.AddWithValue("_Line", company.Line);
            //                        concompanycommand.Parameters.AddWithValue("_Website", company.Website);
            //                        concompanycommand.Parameters.AddWithValue("_City", company.City);
            //                        concompanycommand.Parameters.AddWithValue("_PostCode", company.ZipCode);
            //                        concompanycommand.Parameters.AddWithValue("_CreatedBy", company.CreatedBy);
            //                        concompanycommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
            //                        //concompanycommand.Parameters.AddWithValue("_IdBusinessProduct", company.IdBusinessProduct);
            //                        concompanycommand.Parameters.AddWithValue("_IdBusinessType", company.IdBusinessType);
            //                        concompanycommand.Parameters.AddWithValue("_Latitude", company.Latitude);
            //                        concompanycommand.Parameters.AddWithValue("_Longitude", company.Longitude);
            //                        concompanycommand.Parameters.AddWithValue("_ShortName", company.ShortName);
            //                        concompanycommand.Parameters.AddWithValue("_IdSalesResponsible", company.IdSalesResponsible);
            //                        concompanycommand.Parameters.AddWithValue("_IdSalesResponsibleAssemblyBU", company.IdSalesResponsibleAssemblyBU);
            //                        concompanycommand.Transaction = trans;
            //                        companyId = Convert.ToInt32(concompanycommand.ExecuteScalar());
            //                        company.IdCompany = companyId;
            //                        trans.Commit();
            //                    }
            //                    catch (Exception ex)
            //                    {
            //                        trans.Rollback();
            //                        throw;
            //                    }
            //                }

            //            }
            //        }
            //    }

            //    if (company.IdCompany > 0)
            //    {
            //        AddSiteByBusinessProduct(company, mainconnectionstring);
            //        AddLogEntryBySite(company, crmconnectionstring);
            //    }
            //}

            //}
            //catch (Exception ex)
            //{
            //    throw;
            //}

            return company;
        }

        /// <summary>
        /// This method is to update company details
        /// </summary>
        /// <param name="company">Get company details to update</param>
        /// <param name="mainServerConnectionString">Get main server connection string</param>
        /// <param name="crmconnectionstring">Get local crm connection string</param>
        /// <returns>Company details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string mainconnectionString = ConfigurationManager.ConnectionStrings["MainServerContext"].ConnectionString;
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          Company company = mgr.updateCompany(company,mainconnectionstring,crmconnectionstring);
        ///          //SP:-sites_Update
        ///          //Method:-AddSiteByBusinessProduct(company, mainconnectionstring);
        ///                    AddLogEntryBySite(company, crmconnectionstring);
        ///     }
        /// }
        /// </code>
        /// </example>
        private Company updateCompany(Company company, string mainServerConnectionString, string crmConnectionString)
        {
            company.IsUpdate = false;

            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection concompany = new MySqlConnection(mainServerConnectionString))
                    {
                        concompany.Open();

                        MySqlCommand concompanycommand = new MySqlCommand("sites_Update", concompany);
                        concompanycommand.CommandType = CommandType.StoredProcedure;
                        concompanycommand.Parameters.AddWithValue("_IdSite", company.IdCompany);
                        concompanycommand.Parameters.AddWithValue("_IdCustomer", company.IdCustomer);
                        concompanycommand.Parameters.AddWithValue("_Name", company.Name);
                        concompanycommand.Parameters.AddWithValue("_IdCountry", company.IdCountry);
                        concompanycommand.Parameters.AddWithValue("_Address", company.Address);
                        concompanycommand.Parameters.AddWithValue("_Telephone", company.Telephone);
                        concompanycommand.Parameters.AddWithValue("_Email", company.Email);
                        concompanycommand.Parameters.AddWithValue("_Region", company.Region);
                        concompanycommand.Parameters.AddWithValue("_Fax", company.Fax);
                        concompanycommand.Parameters.AddWithValue("_IdBusinessCenter", company.IdBusinessCenter);
                        concompanycommand.Parameters.AddWithValue("_IdBusinessField", company.IdBusinessField);
                        concompanycommand.Parameters.AddWithValue("_Size", company.Size);
                        concompanycommand.Parameters.AddWithValue("_CuttingMachines", company.CuttingMachines);
                        concompanycommand.Parameters.AddWithValue("_NumberOfEmployee", company.NumberOfEmployees);
                        concompanycommand.Parameters.AddWithValue("_Line", company.Line);
                        concompanycommand.Parameters.AddWithValue("_Website", company.Website);
                        concompanycommand.Parameters.AddWithValue("_City", company.City);
                        concompanycommand.Parameters.AddWithValue("_PostCode", company.ZipCode);
                        concompanycommand.Parameters.AddWithValue("_ModifiedBy", company.ModifiedBy);
                        concompanycommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        concompanycommand.Parameters.AddWithValue("_IdBusinessType", company.IdBusinessType);
                        concompanycommand.Parameters.AddWithValue("_Latitude", company.Latitude);
                        concompanycommand.Parameters.AddWithValue("_Longitude", company.Longitude);
                        concompanycommand.Parameters.AddWithValue("_ShortName", company.ShortName);
                        concompanycommand.Parameters.AddWithValue("_IdSalesResponsible", company.IdSalesResponsible);
                        concompanycommand.Parameters.AddWithValue("_IdSalesResponsibleAssemblyBU", company.IdSalesResponsibleAssemblyBU);

                        concompanycommand.ExecuteNonQuery();
                        company.IsUpdate = true;
                    }

                    if (company.IsUpdate)
                    {
                        AddSiteByBusinessProduct(company, mainServerConnectionString);
                        AddLogEntryBySite(company, mainServerConnectionString);
                    }

                    transactionScope.Complete();
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return company;


            //company.IsUpdate = false;
            //try
            //{
            //    using (MySqlConnection concompany = new MySqlConnection(mainconnectionstring))
            //    {
            //        concompany.Open();
            //        using (MySqlTransaction trans = concompany.BeginTransaction())
            //        {
            //            try
            //            {
            //                MySqlCommand concompanycommand = new MySqlCommand("sites_Update", concompany);
            //                concompanycommand.CommandType = CommandType.StoredProcedure;
            //                concompanycommand.Parameters.AddWithValue("_IdSite", company.IdCompany);
            //                concompanycommand.Parameters.AddWithValue("_IdCustomer", company.IdCustomer);
            //                concompanycommand.Parameters.AddWithValue("_Name", company.Name);
            //                concompanycommand.Parameters.AddWithValue("_IdCountry", company.IdCountry);
            //                concompanycommand.Parameters.AddWithValue("_Address", company.Address);
            //                concompanycommand.Parameters.AddWithValue("_Telephone", company.Telephone);
            //                concompanycommand.Parameters.AddWithValue("_Email", company.Email);
            //                concompanycommand.Parameters.AddWithValue("_Region", company.Region);
            //                concompanycommand.Parameters.AddWithValue("_Fax", company.Fax);
            //                concompanycommand.Parameters.AddWithValue("_IdBusinessCenter", company.IdBusinessCenter);
            //                concompanycommand.Parameters.AddWithValue("_IdBusinessField", company.IdBusinessField);
            //                concompanycommand.Parameters.AddWithValue("_Size", company.Size);
            //                concompanycommand.Parameters.AddWithValue("_CuttingMachines", company.CuttingMachines);
            //                concompanycommand.Parameters.AddWithValue("_NumberOfEmployee", company.NumberOfEmployees);
            //                concompanycommand.Parameters.AddWithValue("_Line", company.Line);
            //                concompanycommand.Parameters.AddWithValue("_Website", company.Website);
            //                concompanycommand.Parameters.AddWithValue("_City", company.City);
            //                concompanycommand.Parameters.AddWithValue("_PostCode", company.ZipCode);
            //                concompanycommand.Parameters.AddWithValue("_ModifiedBy", company.ModifiedBy);
            //                concompanycommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
            //                // concompanycommand.Parameters.AddWithValue("_IdBusinessProduct", company.IdBusinessProduct);
            //                concompanycommand.Parameters.AddWithValue("_IdBusinessType", company.IdBusinessType);
            //                concompanycommand.Parameters.AddWithValue("_Latitude", company.Latitude);
            //                concompanycommand.Parameters.AddWithValue("_Longitude", company.Longitude);
            //                concompanycommand.Parameters.AddWithValue("_ShortName", company.ShortName);
            //                concompanycommand.Parameters.AddWithValue("_IdSalesResponsible", company.IdSalesResponsible);
            //                concompanycommand.Parameters.AddWithValue("_IdSalesResponsibleAssemblyBU", company.IdSalesResponsibleAssemblyBU);
            //                concompanycommand.Transaction = trans;
            //                concompanycommand.ExecuteNonQuery();
            //                company.IsUpdate = true;
            //                trans.Commit();
            //            }
            //            catch (Exception ex)
            //            {
            //                trans.Rollback();
            //                throw;
            //            }
            //        }
            //    }
            //    if (company.IsUpdate)
            //    {
            //        AddSiteByBusinessProduct(company, mainconnectionstring);
            //        AddLogEntryBySite(company, crmconnectionstring);
            //    }
            //}
            //catch (Exception ex)
            //{
            //    throw;
            //}
            //return company;
        }

        /// <summary>
        /// This method is to update company details
        /// </summary>
        /// <param name="company">Get company details</param>
        /// <param name="mainconnectionstring">Get main server connection string</param>
        /// <param name="crmconnectionstring">Get local crm connection string</param>
        /// <returns>updated company details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string mainconnectionString = ConfigurationManager.ConnectionStrings["MainServerContext"].ConnectionString;
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          Company company = mgr.UpdateCompany(company,mainconnectionstring,crmconnectionstring);
        ///          //SP:-sites_Update
        ///          //QUERY:- "select IdSite,Name,IdCustomer,IdCountry from sites where IdSite=" + company.IdCompany + ";";
        ///                    "select * from sites where name='" + sitename + "' and IdCustomer=" + company.IdCustomer + " ;";
        ///          //Method:- updateCompany(company, mainconnectionstring, crmconnectionstring);
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public Company UpdateCompany(Company company, string mainconnectionstring, string crmconnectionstring)
        {
            Company addedcompany = new Company();
            company.IsUpdate = false;
            company.IsExist = false;
            try
            {
                using (MySqlConnection conoffer = new MySqlConnection(mainconnectionstring))
                {
                    conoffer.Open();
                    //string query = "select IdSite,Name,IdCustomer,IdCountry from sites where IdSite=" + company.IdCompany + ";";
                    MySqlCommand conoffercommand = new MySqlCommand("sites_GetSitesById", conoffer);
                    conoffercommand.CommandType = CommandType.StoredProcedure;
                    conoffercommand.Parameters.AddWithValue("_IdSite", company.IdCompany);

                    using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                    {
                        if (offerreader.Read())
                        {
                            addedcompany.IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString());
                            addedcompany.IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString());
                            addedcompany.IdCountry = Convert.ToByte(offerreader["IdCountry"].ToString());
                            addedcompany.Name = offerreader["Name"].ToString();
                        }
                    }
                }
                string sitename = company.Name.Trim() + " (" + company.Country.Name + ")";
                sitename = sitename.ToString().Replace("'", "\"");
                if (addedcompany.Name.ToUpper() == sitename.ToUpper())
                {
                    if (addedcompany.IdCustomer == company.IdCustomer)
                    {
                        company = updateCompany(company, mainconnectionstring, crmconnectionstring);
                    }
                    else
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(mainconnectionstring))
                        {
                            conoffer.Open();
                            //string query = "select * from sites where name='" + sitename + "' and IdCustomer=" + company.IdCustomer + " ;";
                            //MySqlCommand conoffercommand = new MySqlCommand(query, conoffer);
                            //conoffercommand.Connection = conoffer;
                            MySqlCommand conoffercommand = new MySqlCommand("sites_GetSiteNameCustomerIdExist", conoffer);
                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_SiteName", sitename);
                            conoffercommand.Parameters.AddWithValue("_IdCustomer", company.IdCustomer);
                            using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                            {
                                if (offerreader.Read())
                                {
                                    company.IsExist = true;

                                }
                                else
                                {
                                    company = updateCompany(company, mainconnectionstring, crmconnectionstring);
                                }
                            }
                        }
                    }
                }
                else
                {
                    using (MySqlConnection conoffer = new MySqlConnection(mainconnectionstring))
                    {
                        conoffer.Open();
                        MySqlCommand conoffercommand = new MySqlCommand("sites_GetSiteNameCustomerIdExist", conoffer);
                        conoffercommand.CommandType = CommandType.StoredProcedure;
                        conoffercommand.Parameters.AddWithValue("_SiteName", sitename);
                        conoffercommand.Parameters.AddWithValue("_IdCustomer", company.IdCustomer);

                        using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                        {
                            if (offerreader.Read())
                            {
                                company.IsExist = true;

                            }
                            else
                            {
                                company = updateCompany(company, mainconnectionstring, crmconnectionstring);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;

            }
            return company;
        }

        /// <summary>
        /// This method is to get code for site
        /// </summary>
        /// <param name="idCustomer">Get id customer</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>Get code for site</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          string code = mgr.GetCodeForSite(idCustomer,connectionstring);
        ///          //QUERY:- "select code from emdepsites where idsite=" + idCustomer + ";";
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        private string GetCodeForSite(Int32 idCustomer, string connectionstring)
        {
            string code = "";
            using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
            {
                conoffer.Open();
                // string query = "select code from emdepsites where idsite=" + idCustomer + ";";
                MySqlCommand conoffercommand = new MySqlCommand("emdepsites_GetCodeByIdSite", conoffer);
                conoffercommand.CommandType = CommandType.StoredProcedure;
                conoffercommand.Parameters.AddWithValue("_IdSite", idCustomer);

                using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                {
                    if (offerreader.Read())
                        code = offerreader["code"].ToString();
                    else
                        code = string.Empty;
                }
            }
            return code;
        }

        /// <summary>
        /// This method is to get next number of supplies from GCM
        /// </summary>
        /// <param name="idOfferType">Get type</param>
        /// <param name="sqlconnectionstring">Get connection string</param>
        /// <returns>Get next number of supplies from GCM</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///           string offerCodeConnectionString = ConfigurationManager.ConnectionStrings["OfferCodeContext"].ConnectionString;
        ///          Int64 nextNumber = mgr.GetNextNumberOfSuppliesFromGCM(idOfferType,sqlconnectionstring);
        ///            if (idOfferType == 1)
        ///              query = "select coalesce(MAX(number+1),1)as nextNumber from supplies where year= " + DateTime.Now.Year + " ;";
        ///            else if (idOfferType == 2)
        ///              query = "select coalesce(MAX(number+1),1)as nextNumber from icos where year= " + DateTime.Now.Year + " ;";
        ///             else if (idOfferType == 3)
        ///              query = "select coalesce(MAX(number+1),1)as nextNumber from complaints where year= " + DateTime.Now.Year + " ;";
        ///             else if (idOfferType == 4)
        ///              query = "select coalesce(MAX(number+1),1)as nextNumber from technicians_materials where year= " + DateTime.Now.Year + " ;";
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public Int64 GetNextNumberOfSuppliesFromGCM(byte? idOfferType, string sqlconnectionstring, string mainServerConnectionString = null, bool UseSQLCounter = true)
        {
            Int64 nextNumber = 0;

            if (idOfferType == 1 && !UseSQLCounter)  // 1-OT - Get Number from mysql Geos counters.
            {
                nextNumber = GetNextNumberOfOfferFromCounters(idOfferType, null, null, 0, mainServerConnectionString);
            }
            else
            {
                SqlDataAdapter daGCM;
                DataTable dtGCM;
                string query = "";
                using (SqlConnection conoffer = new SqlConnection(sqlconnectionstring))
                {
                    conoffer.Open();

                    if (idOfferType == 1)
                        query = "select coalesce(MAX(number+1),1)as nextNumber from supplies where year= " + DateTime.Now.Year + " ;";
                    else if (idOfferType == 2)
                        query = "select coalesce(MAX(number+1),1)as nextNumber from icos where year= " + DateTime.Now.Year + " ;";
                    else if (idOfferType == 3)
                        query = "select coalesce(MAX(number+1),1)as nextNumber from complaints where year= " + DateTime.Now.Year + " ;";
                    else if (idOfferType == 4)
                        query = "select coalesce(MAX(number+1),1)as nextNumber from technicians_materials where year= " + DateTime.Now.Year + " ;";

                    daGCM = new SqlDataAdapter(query, sqlconnectionstring);
                    dtGCM = new DataTable();
                    daGCM.Fill(dtGCM);

                    DataRow drGCM;

                    if (dtGCM.Rows.Count > 0)
                    {
                        drGCM = dtGCM.Rows[0];
                        nextNumber = Convert.ToInt32(drGCM["nextNumber"].ToString());
                    }
                }
            }

            return nextNumber;
        }

        /// <summary>
        /// This method is to get next number of offer from counters
        /// </summary>
        /// <param name="idOfferType">Get id offer type</param>
        /// <param name="connectionstring">Get Connection string</param>
        /// <param name="connectPlantstr">Get plant connection string</param>
        /// <param name="idUser">Get id user</param>
        /// <param name="mainserverConnectionString">Get main server connection string</param>
        /// <returns>Get next number of offer from counters</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          string mainserverconnectionString = ConfigurationManager.ConnectionStrings["MainServerContext"].ConnectionString;
        ///          Int64 nextNumber = mgr.GetNextNumberOfOfferFromCounters(idOfferType,connectionstring,connectPlantstr,idUser,mainserverConnectionString);
        ///          //QUERY:- "select NextNumber from counters where idOfferType=" + idOfferType + " and year =" + DateTime.Now.Year + ";";
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public Int64 GetNextNumberOfOfferFromCounters(byte? idOfferType, string connectionstring, string connectPlantstr, Int32 idUser, string mainserverConnectionString)
        {
            Int64 nextNumber = 1;

            using (MySqlConnection conoffer = new MySqlConnection(mainserverConnectionString))
            {
                conoffer.Open();
                string query = "select NextNumber from counters where idOfferType=" + idOfferType + " and year =" + DateTime.Now.Year + ";";

                MySqlCommand myCommand = new MySqlCommand(query, conoffer);
                myCommand.CommandType = CommandType.Text;
                using (MySqlDataReader offerreader = myCommand.ExecuteReader())
                {
                    if (offerreader.Read())
                        nextNumber = Convert.ToInt32(offerreader["NextNumber"].ToString());
                }
            }

            return nextNumber;
        }


        /// <summary>
        /// This method is to make offer code
        /// </summary>
        /// <param name="offer">Get offer details</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="offerCodeConnectionString">Get offer code connection string</param>
        /// <param name="connectPlantstr">Get plant connection string</param>
        /// <param name="idUser">Get id user</param>
        /// <param name="mainserverConnectionString">Get main server connection string</param>
        /// <returns>Get offer code</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          string offerCodeConnectionString = ConfigurationManager.ConnectionStrings["OfferCodeContext"].ConnectionString;
        ///          string mainserverconnectionString = ConfigurationManager.ConnectionStrings["MainServerContext"].ConnectionString;
        ///          string code = mgr.MakeOfferCode(offer,connectionstring,offerCodeConnectionString,connectPlantstr,idUser,mainserverConnectionString);
        ///          if (offer.IdOfferType == 1)
        ///           code = DateTime.Now.Year.ToString() + GetCodeForSite(offer.IdCustomer, connectionstring) + "-" + GetNextNumberOfSuppliesFromGCM(offer.IdOfferType, offerCodeConnectionString).ToString().PadLeft(5, '0');
        ///          else if (offer.IdOfferType == 10)
        ///             code = "OP" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(offer.IdCustomer, connectionstring) + GetNextNumberOfOfferFromCounters(offer.IdOfferType, connectionstring, connectPlantstr, idUser, mainserverConnectionString).ToString().PadLeft(3, '0');
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public string MakeOfferCode(Offer offer, string connectionstring, string offerCodeConnectionString, string connectPlantstr, Int32 idUser, string mainserverConnectionString)
        {
            string code = "";

            if (offer.IdOfferType == 1)
                code = DateTime.Now.Year.ToString() + GetCodeForSite(offer.IdCustomer, connectionstring) + "-" + GetNextNumberOfSuppliesFromGCM(offer.IdOfferType, offerCodeConnectionString).ToString().PadLeft(5, '0');
            else if (offer.IdOfferType == 2)
                code = "IC" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(offer.IdCustomer, connectionstring) + offer.Number.ToString().PadLeft(4, '0');
            else if (offer.IdOfferType == 3)
                code = "C" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(offer.IdCustomer, connectionstring) + offer.Number.ToString().PadLeft(4, '0');
            else if (offer.IdOfferType == 4)
                code = "T" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(offer.IdCustomer, connectionstring) + "-" + offer.Number.ToString().PadLeft(3, '0');
            else if (offer.IdOfferType == 5)
                code = "IE" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(offer.IdCustomer, connectionstring) + offer.Number.ToString().PadLeft(3, '0');
            else if (offer.IdOfferType == 6)
                code = "RD" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(offer.IdCustomer, connectionstring) + offer.Number.ToString().PadLeft(3, '0');
            else if (offer.IdOfferType == 7)
                code = "IT" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(offer.IdCustomer, connectionstring) + offer.Number.ToString().PadLeft(3, '0');
            else if (offer.IdOfferType == 8)
                code = "IS" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(offer.IdCustomer, connectionstring) + GetNextNumberOfOfferFromCounters(offer.IdOfferType, connectionstring, connectPlantstr, idUser, mainserverConnectionString).ToString().PadLeft(3, '0');
            else if (offer.IdOfferType == 9)
                code = "IW" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(offer.IdCustomer, connectionstring) + GetNextNumberOfOfferFromCounters(offer.IdOfferType, connectionstring, connectPlantstr, idUser, mainserverConnectionString).ToString().PadLeft(3, '0');
            else if (offer.IdOfferType == 10)
                code = "OP" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(offer.IdCustomer, connectionstring) + GetNextNumberOfOfferFromCounters(offer.IdOfferType, connectionstring, connectPlantstr, idUser, mainserverConnectionString).ToString().PadLeft(3, '0');
            else
                code = "";

            return code;
        }

        /// <summary>
        /// This method is to make offfercode
        /// </summary>
        /// <param name="idOfferType">Get offertype id</param>
        /// <param name="idCustomer">Get customer id</param>
        /// <param name="connectionstring">Get conncetionstring</param>
        /// <param name="offerCodeConnectionString">Get offer code Connection string</param>
        /// <returns>Offer Code</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          string offerCodeConnectionString = ConfigurationManager.ConnectionStrings["OfferCodeContext"].ConnectionString;
        ///          string mainserverconnectionString = ConfigurationManager.ConnectionStrings["MainServerContext"].ConnectionString;
        ///          string code = mgr.MakeOfferCode(offer,connectionstring,offerCodeConnectionString,connectPlantstr,idUser,mainserverConnectionString);
        ///          if (offer.IdOfferType == 1)
        ///           code = DateTime.Now.Year.ToString() + GetCodeForSite(idCustomer, connectionstring) + "-" + GetNextNumberOfSuppliesFromGCM(offer.IdOfferType, offerCodeConnectionString).ToString().PadLeft(5, '0');
        ///          else if (offer.IdOfferType == 10)
        ///             code = "OP" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(IdCustomer, connectionstring) + GetNextNumberOfOfferFromCounters(offer.IdOfferType, connectionstring, connectPlantstr, idUser, mainserverConnectionString).ToString().PadLeft(3, '0');
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public string MakeOfferCode(byte? idOfferType, Int32 idCustomer, string connectionstring, string offerCodeConnectionString, string connectPlantstr, Int32 idUser, string mainserverConnectionString, bool UseSQLCounter = true)
        {
            string code = "";

            if (idOfferType == 1)
            {
                if (!UseSQLCounter)
                    code = DateTime.Now.Year.ToString() + GetCodeForSite(idCustomer, connectionstring) + "-" + GetNextNumberOfOfferFromCounters(idOfferType, connectionstring, connectPlantstr, idUser, mainserverConnectionString).ToString().PadLeft(5, '0');
                else
                    code = DateTime.Now.Year.ToString() + GetCodeForSite(idCustomer, connectionstring) + "-" + GetNextNumberOfSuppliesFromGCM(idOfferType, offerCodeConnectionString).ToString().PadLeft(5, '0');
            }
            else if (idOfferType == 2)
                code = "IC" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfSuppliesFromGCM(idOfferType, offerCodeConnectionString).ToString().PadLeft(4, '0');
            else if (idOfferType == 3)
                code = "C" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfSuppliesFromGCM(idOfferType, offerCodeConnectionString).ToString().PadLeft(4, '0');
            else if (idOfferType == 4)
                code = "T" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + "-" + GetNextNumberOfSuppliesFromGCM(idOfferType, offerCodeConnectionString).ToString().PadLeft(3, '0');
            else if (idOfferType == 5)
                code = "IE" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfOfferFromCounters(idOfferType, connectionstring, connectPlantstr, idUser, mainserverConnectionString).ToString().PadLeft(3, '0');
            else if (idOfferType == 6)
                code = "RD" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfOfferFromCounters(idOfferType, connectionstring, connectPlantstr, idUser, mainserverConnectionString).ToString().PadLeft(3, '0');
            else if (idOfferType == 7)
                code = "IT" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfOfferFromCounters(idOfferType, connectionstring, connectPlantstr, idUser, mainserverConnectionString).ToString().PadLeft(3, '0');
            else if (idOfferType == 8)
                code = "IS" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfOfferFromCounters(idOfferType, connectionstring, connectPlantstr, idUser, mainserverConnectionString).ToString().PadLeft(3, '0');
            else if (idOfferType == 9)
                code = "IW" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfOfferFromCounters(idOfferType, connectionstring, connectPlantstr, idUser, mainserverConnectionString).ToString().PadLeft(3, '0');
            else if (idOfferType == 10)
                code = "OP" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfOfferFromCounters(idOfferType, connectionstring, connectPlantstr, idUser, mainserverConnectionString).ToString().PadLeft(5, '0');
            else
                code = "";

            return code;
        }

        /// <summary>
        /// This method is to insert offer to GCM
        /// </summary>
        /// <param name="offer">Get offer details</param>
        /// <param name="offerCodeConnectionString">Get connectionstring</param>
        /// <param name="idSite">Get site id</param>
        /// <returns>inserted or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///        
        ///          string offerCodeConnectionString = ConfigurationManager.ConnectionStrings["OfferCodeContext"].ConnectionString;
        ///          string code = mgr.InsertOfferToGCM(offer,offerCodeConnectionString,idSite);
        ///          if (offer.Code.StartsWith("C"))
        ///             return InsertCOToGCM(offer, offerCodeConnectionString, idSite);
        ///          else if (offer.Code.StartsWith("IC"))
        ///             return InsertICOToGCM(offer, offerCodeConnectionString, idSite);
        ///          else if (offer.Code.StartsWith("T"))
        ///            return InsertTechniciansMaterialToGCM(offer, offerCodeConnectionString, idSite);
        ///          else
        ///             return InsertSuppliesToGCM(offer, offerCodeConnectionString, idSite);
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        private bool InsertOfferToGCM(Offer offer, string offerCodeConnectionString, Int64 idSite)
        {
            if (offer.Code.StartsWith("C"))
                return InsertCOToGCM(offer, offerCodeConnectionString, idSite);
            else if (offer.Code.StartsWith("IC"))
                return InsertICOToGCM(offer, offerCodeConnectionString, idSite);
            else if (offer.Code.StartsWith("T"))
                return InsertTechniciansMaterialToGCM(offer, offerCodeConnectionString, idSite);
            else
                return InsertSuppliesToGCM(offer, offerCodeConnectionString, idSite);
        }

        /// <summary>
        /// This method is to insert offer number in supplies
        /// </summary>
        /// <param name="offer">Get offer details</param>
        /// <param name="connectionstring">Get connectionstring</param>
        /// <param name="idSite">Get site id</param>
        /// <returns>Inserted or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///        
        ///          string offerCodeConnectionString = ConfigurationManager.ConnectionStrings["OfferCodeContext"].ConnectionString;
        ///          string code = mgr.InsertSuppliesToGCM(offer,offerCodeConnectionString,idSite);
        ///          QUERY :- "select * from supplies where year= " + DateTime.Now.Year + " and number =" + offer.Number + " ;";
        ///          QUERY :- "INSERT INTO supplies (year, number, date, customer, description, comercial, status, price, comments, cancelled, emdep, codestring, cancelable, cancellation_reason, missingCustomerSamples, rfq, currency, islocked, projectName, sentIn, probabilityOfSuccess, answerEstimatedDate, quantity, type) " +
        ///                   " VALUES(@YEAR,@NUMBER, @DATE,@CUSTOMER,@DESCRIPTION,@COMERCIAL, @STATUS,@PRICE, @COMMENTS,@CANCELLED, @EMDEP,@CODESTRING, @CANCELABLE,@CANCELATION_REASON, @MISSINGCUSTOMERSAMPLES, @RFQ, @CURRENCY, @ISLOCKED,@PROJECTNAME, @SENTIN, @PROBABILITYOFSUCCESS, @ANSWERESTIMATEDDATE,@QUANTITY, @TYPE);";
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        private bool InsertSuppliesToGCM(Offer offer, string connectionstring, Int64 idSite)
        {
            bool insert = true;
            SqlDataAdapter daGCM;
            DataTable dtGCM;

            using (SqlConnection conoffer = new SqlConnection(connectionstring))
            {
                conoffer.Open();
                string query = "select * from supplies where year= " + DateTime.Now.Year + " and number =" + offer.Number + " ;";

                daGCM = new SqlDataAdapter(query, conoffer);
                dtGCM = new DataTable();
                daGCM.Fill(dtGCM);

                if (dtGCM.Rows.Count > 0)
                    insert = false;

            }

            if (insert)
            {
                try
                {
                    using (SqlConnection conoffer = new SqlConnection(connectionstring))
                    {
                        conoffer.Open();
                        using (SqlTransaction trans = conoffer.BeginTransaction())
                        {
                            try
                            {
                                SqlCommand MyCommand = conoffer.CreateCommand();
                                MyCommand.Connection = conoffer;
                                MyCommand.CommandText = "INSERT INTO supplies (year, number, date, customer, description, comercial, status, price, comments, cancelled, emdep, codestring, cancelable, cancellation_reason, missingCustomerSamples, rfq, currency, islocked, projectName, sentIn, probabilityOfSuccess, answerEstimatedDate, quantity, type) " +
                                                          " VALUES(@YEAR,@NUMBER, @DATE,@CUSTOMER,@DESCRIPTION,@COMERCIAL, @STATUS,@PRICE, @COMMENTS,@CANCELLED, @EMDEP,@CODESTRING, @CANCELABLE,@CANCELATION_REASON, @MISSINGCUSTOMERSAMPLES, @RFQ, @CURRENCY, @ISLOCKED,@PROJECTNAME, @SENTIN, @PROBABILITYOFSUCCESS, @ANSWERESTIMATEDDATE,@QUANTITY, @TYPE);";

                                MyCommand.Parameters.AddWithValue("@YEAR", DateTime.Now.Year);
                                MyCommand.Parameters.AddWithValue("@NUMBER", offer.Number);
                                MyCommand.Parameters.AddWithValue("@DATE", DateTime.Now);
                                MyCommand.Parameters.AddWithValue("@CUSTOMER", Convert.ToInt32(offer.IdCustomer));
                                MyCommand.Parameters.AddWithValue("@DESCRIPTION", offer.Description);
                                MyCommand.Parameters.AddWithValue("@COMERCIAL", 4);
                                MyCommand.Parameters.AddWithValue("@STATUS", GetGCMStatus(offer));
                                MyCommand.Parameters.AddWithValue("@PRICE", offer.Value);
                                MyCommand.Parameters.AddWithValue("@COMMENTS", offer.Comments);
                                MyCommand.Parameters.AddWithValue("@CANCELLED", false);
                                MyCommand.Parameters.AddWithValue("@EMDEP", GetEmdepNumber(idSite));
                                MyCommand.Parameters.AddWithValue("@CODESTRING", offer.Code);
                                MyCommand.Parameters.AddWithValue("@CANCELABLE", false);
                                MyCommand.Parameters.AddWithValue("@CANCELATION_REASON", DBNull.Value);
                                MyCommand.Parameters.AddWithValue("@MISSINGCUSTOMERSAMPLES", false);
                                MyCommand.Parameters.AddWithValue("@RFQ", offer.Rfq);
                                MyCommand.Parameters.AddWithValue("@CURRENCY", offer.Currency.Name);
                                MyCommand.Parameters.AddWithValue("@ISLOCKED", false);
                                MyCommand.Parameters.AddWithValue("@PROJECTNAME", "");
                                if (offer.SendIn != null && offer.SendIn != DateTime.MinValue)
                                    MyCommand.Parameters.AddWithValue("@SENTIN", offer.SendIn);
                                else
                                    MyCommand.Parameters.AddWithValue("@SENTIN", Convert.ToDateTime(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")));
                                MyCommand.Parameters.AddWithValue("@PROBABILITYOFSUCCESS", offer.ProbabilityOfSuccess);
                                MyCommand.Parameters.AddWithValue("@ANSWERESTIMATEDDATE", DBNull.Value);
                                MyCommand.Parameters.AddWithValue("@QUANTITY", DBNull.Value);
                                MyCommand.Parameters.AddWithValue("@TYPE", DBNull.Value);
                                MyCommand.Transaction = trans;
                                MyCommand.ExecuteNonQuery();
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }

                    }
                }
                catch (Exception ex)
                {
                    throw;

                }
            }

            return insert;
        }

        /// <summary>
        /// This method is to insert offer number in  Complaints
        /// </summary>
        /// <param name="offer">Get offer details</param>
        /// <param name="connectionstring">Get connectionstring</param>
        /// <param name="idSite">Get site id</param>
        /// <returns>inserted or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///        
        ///          string offerCodeConnectionString = ConfigurationManager.ConnectionStrings["OfferCodeContext"].ConnectionString;
        ///          string code = mgr.InsertCOToGCM(offer,offerCodeConnectionString,idSite);
        ///          QUERY :- "select * from complaints where year= " + DateTime.Now.Year + " and number =" + offer.Number + " ;";
        ///          QUERY :- "INSERT INTO complaints (year, number, codestring, mp, customer, ot_related, date, description, involve_ot, outgoing_date, comercial, status, comments, emdep, mpdate, newCP) " +
        ///                   " VALUES(" + DateTime.Now.Year + ", " + offer.Number + ", '" + offer.Code + "',1, " + Convert.ToInt32(offer.IdCustomer) + ",' ', '" + DateTime.Now.ToString("yyyy - MM - dd HH: mm:ss") + "', '" + offer.Description + "',1, '" + offer.DeliveryDate.Value.ToString("yyyy - MM - dd HH: mm:ss") + "',4, " + GetGCMStatus(offer) + ", '" + offer.Comments + "', " + GetEmdepNumber(idSite) + ", '" + Convert.ToDateTime("1900-01-01 00:00:00").ToString("yyyy-MM-dd HH:mm:ss") + "', 0);";
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        private bool InsertCOToGCM(Offer offer, string connectionstring, Int64 idSite)
        {
            bool insert = true;
            SqlDataAdapter daGCM;
            DataTable dtGCM;

            using (SqlConnection MyConn = new SqlConnection(connectionstring))
            {
                MyConn.Open();
                string query = "select * from complaints where year= " + DateTime.Now.Year + " and number =" + offer.Number + " ;";

                daGCM = new SqlDataAdapter(query, MyConn);
                dtGCM = new DataTable();
                daGCM.Fill(dtGCM);

                if (dtGCM.Rows.Count > 0)
                    insert = false;

            }

            if (insert)
            {
                using (SqlConnection MyConn = new SqlConnection(connectionstring))
                {
                    MyConn.Open();
                    using (SqlTransaction trans = MyConn.BeginTransaction())
                    {
                        try
                        {
                            string sqlQuery = "INSERT INTO complaints (year, number, codestring, mp, customer, ot_related, date, description, involve_ot, outgoing_date, comercial, status, comments, emdep, mpdate, newCP) " +
                                                    " VALUES(" + DateTime.Now.Year + ", " + offer.Number + ", '" + offer.Code + "',1, " + Convert.ToInt32(offer.IdCustomer) + ",' ', '" + DateTime.Now.ToString("yyyy - MM - dd HH: mm:ss") + "', '" + offer.Description + "',1, '" + offer.DeliveryDate.Value.ToString("yyyy - MM - dd HH: mm:ss") + "',4, " + GetGCMStatus(offer) + ", '" + offer.Comments + "', " + GetEmdepNumber(idSite) + ", '" + Convert.ToDateTime("1900-01-01 00:00:00").ToString("yyyy-MM-dd HH:mm:ss") + "', 0);";

                            SqlCommand MyCommand = new SqlCommand(sqlQuery, MyConn, trans);
                            MyCommand.ExecuteNonQuery();
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }

                }
            }

            return insert;
        }

        /// <summary>
        /// This method is to insert offer number in technicians_materials 
        /// </summary>
        /// <param name="offer">Get offer details</param>
        /// <param name="connectionstring">Get connection ctring</param>
        /// <param name="idSite">Get site id</param>
        /// <returns>inserted or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///        
        ///          string offerCodeConnectionString = ConfigurationManager.ConnectionStrings["OfferCodeContext"].ConnectionString;
        ///          bool insert = mgr.InsertTechniciansMaterialToGCM(offer,offerCodeConnectionString,idSite);
        ///          QUERY :- "select * from technicians_materials where year= " + DateTime.Now.Year + " and number =" + offer.Number + " ;";
        ///          QUERY :- "INSERT INTO technicians_materials (year, number, codestring, mp, technician, date, description, outgoing_date, status, comments, emdep,mpdate) " +
        ///                   " VALUES(" + DateTime.Now.Year + ", " + offer.Number + ", '" + offer.Code + "',1,1, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "', '" + offer.Description + "','" + offer.DeliveryDate.Value.ToString("yyyy-MM-dd HH:mm:ss") + "', " + GetGCMStatus(offer) + ", '" + offer.Comments + "', " + GetEmdepNumber(idSite) + ",'" + Convert.ToDateTime("1900-01-01 00:00:00").ToString("yyyy-MM-dd HH:mm:ss") + "');";
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        private bool InsertTechniciansMaterialToGCM(Offer offer, string connectionstring, Int64 idSite)
        {
            bool insert = true;
            SqlDataAdapter daGCM;
            DataTable dtGCM;

            using (SqlConnection MyConn = new SqlConnection(connectionstring))
            {
                MyConn.Open();
                string query = "select * from technicians_materials where year= " + DateTime.Now.Year + " and number =" + offer.Number + " ;";

                daGCM = new SqlDataAdapter(query, MyConn);
                dtGCM = new DataTable();
                daGCM.Fill(dtGCM);

                if (dtGCM.Rows.Count > 0)
                    insert = false;

            }

            if (insert)
            {
                using (SqlConnection MyConn = new SqlConnection(connectionstring))
                {
                    MyConn.Open();
                    using (SqlTransaction trans = MyConn.BeginTransaction())
                    {
                        try
                        {
                            string sqlQuery = "INSERT INTO technicians_materials (year, number, codestring, mp, technician, date, description, outgoing_date, status, comments, emdep,mpdate) " +
                                                 " VALUES(" + DateTime.Now.Year + ", " + offer.Number + ", '" + offer.Code + "',1,1, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "', '" + offer.Description + "','" + offer.DeliveryDate.Value.ToString("yyyy-MM-dd HH:mm:ss") + "', " + GetGCMStatus(offer) + ", '" + offer.Comments + "', " + GetEmdepNumber(idSite) + ",'" + Convert.ToDateTime("1900-01-01 00:00:00").ToString("yyyy-MM-dd HH:mm:ss") + "');";
                            SqlCommand MyCommand = new SqlCommand(sqlQuery, MyConn, trans);
                            MyCommand.ExecuteNonQuery();
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
            }

            return insert;
        }

        /// <summary>
        /// This method is to insert offer number in ICOS 
        /// </summary>
        /// <param name="offer">Get offer details</param>
        /// <param name="connectionstring">Get connectionstring</param>
        /// <param name="idSite">Get site id</param>
        /// <returns>inserted or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///        
        ///          string offerCodeConnectionString = ConfigurationManager.ConnectionStrings["OfferCodeContext"].ConnectionString;
        ///          bool insert = mgr.InsertICOToGCM(offer,offerCodeConnectionString,idSite);
        ///          QUERY :- "select * from ICOS where year= " + DateTime.Now.Year + " and number =" + offer.Number + " ;";
        ///          QUERY :- "INSERT INTO ICOS (year, number, codestring, mp, customer, date, description, comercial, delivery_date, status, comments, emdep, mpdate) " +
        ///                   " VALUES(" + DateTime.Now.Year + ", " + offer.Number + ",'" + offer.Code + "', 1, " + Convert.ToInt32(offer.IdCustomer) + ", '" + DateTime.Now.ToString("yyyy - MM - dd HH: mm:ss") + "', '" + offer.Description + "',4, '" + offer.DeliveryDate.Value.ToString("yyyy - MM - dd HH: mm:ss") + "'," + GetGCMStatus(offer) + ",'" + offer.Comments + "', " + GetEmdepNumber(idSite) + ",'" + Convert.ToDateTime("1900-01-01 00:00:00").ToString("yyyy - MM - dd HH: mm:ss") + "');";
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        private bool InsertICOToGCM(Offer offer, string connectionstring, Int64 idSite)
        {
            bool insert = true;
            SqlDataAdapter daGCM;
            DataTable dtGCM;

            using (SqlConnection MyConn = new SqlConnection(connectionstring))
            {
                MyConn.Open();
                string query = "select * from ICOS where year= " + DateTime.Now.Year + " and number =" + offer.Number + " ;";

                daGCM = new SqlDataAdapter(query, MyConn);
                dtGCM = new DataTable();
                daGCM.Fill(dtGCM);

                if (dtGCM.Rows.Count > 0)
                    insert = false;

            }

            if (insert)
            {
                using (SqlConnection MyConn = new SqlConnection(connectionstring))
                {
                    MyConn.Open();
                    using (SqlTransaction trans = MyConn.BeginTransaction())
                    {
                        try
                        {

                            string sqlQuery = "INSERT INTO ICOS (year, number, codestring, mp, customer, date, description, comercial, delivery_date, status, comments, emdep, mpdate) " +
                                                " VALUES(" + DateTime.Now.Year + ", " + offer.Number + ",'" + offer.Code + "', 1, " + Convert.ToInt32(offer.IdCustomer) + ", '" + DateTime.Now.ToString("yyyy - MM - dd HH: mm:ss") + "', '" + offer.Description + "',4, '" + offer.DeliveryDate.Value.ToString("yyyy - MM - dd HH: mm:ss") + "'," + GetGCMStatus(offer) + ",'" + offer.Comments + "', " + GetEmdepNumber(idSite) + ",'" + Convert.ToDateTime("1900-01-01 00:00:00").ToString("yyyy - MM - dd HH: mm:ss") + "');";

                            SqlCommand MyCommand = new SqlCommand(sqlQuery, MyConn, trans);

                            int i = MyCommand.ExecuteNonQuery();
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
            }

            return insert;
        }

        /// <summary>
        /// This method is to get emdep number
        /// </summary>
        /// <param name="idSite">Get site id</param>
        /// <returns>Emdep Number</returns>
        public int GetEmdepNumber(Int64 idSite)
        {
            int enumeratedMeaning = 6;
            switch (idSite)
            {
                case 20:
                    enumeratedMeaning = 2;
                    break;
                case 199:
                    enumeratedMeaning = 7;
                    break;
                case 55:
                    enumeratedMeaning = 4;
                    break;
                case 23:
                    enumeratedMeaning = 1;
                    break;
                case 57:
                    enumeratedMeaning = 3;
                    break;
                case 370:
                    enumeratedMeaning = 8;
                    break;
                case 18:
                    enumeratedMeaning = 6;
                    break;
                case 58:
                    enumeratedMeaning = 5;
                    break;
            }
            return enumeratedMeaning;
        }

        /// <summary>
        /// This method is to get GCM status
        /// </summary>
        /// <param name="offer">Get offer details</param>
        /// <returns>GCM status</returns>
        public int GetGCMStatus(Offer offer)
        {
            int gcmStatus = 1;

            switch (offer.IdOfferType)
            {
                case 1: //supply
                    switch (offer.IdStatus)
                    {
                        case 1://ONLY QUOTED
                            gcmStatus = 3;
                            break;
                        case 2: //WAITING FOR QUOTE
                            gcmStatus = 46;
                            break;
                        case 3: //ACCEPTED 
                            gcmStatus = 1;
                            break;
                        case 4://CANCELLED
                            gcmStatus = 2;
                            break;
                        default: //guions
                            gcmStatus = 37;
                            break;
                    }
                    break;
                case 2: //ICO
                    switch (offer.IdStatus)
                    {
                        case 3://ACCEPTED
                            gcmStatus = 20;
                            break;
                        case 9: //COMPLETELY DELIVERED
                            gcmStatus = 21;
                            break;
                        case 5: //IN PRODUCTION 
                            gcmStatus = 23;
                            break;
                        case 8://PARTIALLY DELIVERED
                            gcmStatus = 23;
                            break;
                        case 11://WAITING FOR INVOICE
                            gcmStatus = 24;
                            break;
                        case 10://WAITING FOR SAMPLES
                            gcmStatus = 55;
                            break;
                        case 4://CANCELLED
                            gcmStatus = 78;
                            break;
                        default: //guions
                            gcmStatus = 19;
                            break;
                    }
                    break;
                case 3: //CO
                    switch (offer.IdStatus)
                    {
                        case 3://ACCEPTED
                            gcmStatus = 26;
                            break;
                        case 9: //COMPLETELY DELIVERED
                            gcmStatus = 27;
                            break;
                        case 5: //IN PRODUCTION 
                            gcmStatus = 28;
                            break;
                        case 8://PARTIALLY DELIVERED
                            gcmStatus = 29;
                            break;
                        case 11://WAITING FOR INVOICE
                            gcmStatus = 30;
                            break;
                        case 10://WAITING FOR SAMPLES
                            gcmStatus = 56;
                            break;
                        case 4://CANCELLED
                            gcmStatus = 73;
                            break;
                        default: //guions
                            gcmStatus = 25;
                            break;
                    }
                    break;
                case 4: //TECHNICIANS
                    switch (offer.IdStatus)
                    {
                        case 3://ACCEPTED
                            gcmStatus = 32;
                            break;
                        case 9: //COMPLETELY DELIVERED
                            gcmStatus = 33;
                            break;
                        case 5: //IN PRODUCTION 
                            gcmStatus = 34;
                            break;
                        case 8://PARTIALLY DELIVERED
                            gcmStatus = 35;
                            break;
                        case 11://WAITING FOR INVOICE
                            gcmStatus = 36;
                            break;
                        case 10://WAITING FOR SAMPLES
                            gcmStatus = 57;
                            break;
                        case 4://CANCELLED
                            gcmStatus = 79;
                            break;
                        default: //guions
                            gcmStatus = 31;
                            break;
                    }
                    break;

            }

            return gcmStatus;
        }

        /// <summary>
        /// This method is to update next offer number to counter
        /// </summary>
        /// <param name="idOfferType">Get offer type id</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///        
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          bool insert = mgr.UpdateNextOfferNumberToCounters(offer,connectionstring);
        ///          QUERY :- @"SELECT * FROM counters WHERE idOfferType=" + idOfferType + ";";
        ///          QUERY :-  @"INSERT INTO counters (idOfferType, Year, NextNumber) values (" + idOfferType + ", " + DateTime.Now.Year + ", 2);";
        ///          QUERY :-  @"UPDATE counters SET NextNumber=(NextNumber+1) where idOfferType=" + idOfferType + ";";
        ///          QUERY :-  @"UPDATE counters SET NextNumber=2, Year =" + DateTime.Now.Year + " WHERE idOfferType=" + idOfferType + ";";
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public void UpdateNextOfferNumberToCounters(byte? idOfferType, string connectionstring)
        {
            bool exist = false;
            bool sameYear = false;
            using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
            {
                conoffer.Open();

                MySqlCommand MyCommand = conoffer.CreateCommand();

                MyCommand.Connection = conoffer;

                MyCommand.CommandText = @"SELECT * FROM counters WHERE idOfferType=" + idOfferType + ";";

                using (MySqlDataReader offerreader = MyCommand.ExecuteReader())
                {
                    if (offerreader.Read())
                    {
                        exist = true;
                        if (Convert.ToInt32(offerreader["year"]) == DateTime.Now.Year)
                            sameYear = true;
                    }
                }

            }
            //Si no existeix el nmero o es un nou any li posarem el nmero 2 ja que el 1 l'acabem de fer servir
            //i el nmero de la base de dades sempre es el prxim

            if (!exist)
            {
                using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                {
                    conoffer.Open();
                    using (MySqlTransaction trans = conoffer.BeginTransaction())
                    {
                        try
                        {
                            MySqlCommand MyCommand = conoffer.CreateCommand();

                            MyCommand.Connection = conoffer;
                            MyCommand.CommandText = @"INSERT INTO counters (idOfferType, Year, NextNumber) values (" + idOfferType + ", " + DateTime.Now.Year + ", 2);";
                            MyCommand.Transaction = trans;
                            MyCommand.ExecuteNonQuery();
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
            }
            else
            {
                if (sameYear)
                {

                    using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                    {
                        conoffer.Open();
                        using (MySqlTransaction trans = conoffer.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand MyCommand = conoffer.CreateCommand();
                                MyCommand.Connection = conoffer;
                                MyCommand.CommandText = @"UPDATE counters SET NextNumber=(NextNumber+1) where idOfferType=" + idOfferType + ";";
                                MyCommand.Transaction = trans;
                                MyCommand.ExecuteNonQuery();
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }
                }
                else
                {
                    using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                    {
                        conoffer.Open();
                        using (MySqlTransaction trans = conoffer.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand MyCommand = conoffer.CreateCommand();

                                MyCommand.Connection = conoffer;
                                MyCommand.CommandText = @"UPDATE counters SET NextNumber=2, Year =" + DateTime.Now.Year + " WHERE idOfferType=" + idOfferType + ";";
                                MyCommand.Transaction = trans;
                                MyCommand.ExecuteNonQuery();
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }


                }
            }

        }



        /// <summary>
        /// This method is to add offer
        /// </summary>
        /// <param name="offer">Get offer details</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="offerCodeConnectionString">Get offer code connection string</param>
        /// <param name="idSite">Get site id</param>
        /// <param name="commericalPath">Get commerical path</param>
        /// <param name="workingOrdersPath">Get working order path</param>
        /// <param name="mainserverConnectionString">Get main server connection string</param>
        /// <returns>Get added offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string offerCodeConnectionString = ConfigurationManager.ConnectionStrings["OfferCodeContext"].ConnectionString;
        ///          string mainServerConnectionString = ConfigurationManager.ConnectionStrings["MainServerContext"].ConnectionString;
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          Offer offer = mgr.AddOffer(offer, connectionString, offerCodeConnectionString, idSite, Properties.Settings.Default.CommericalPath, Properties.Settings.Default.WorkingOrdersPath,mainServerConnectionString);
        ///          Method :-  if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
        ///                      offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
        ///                     else
        ///                      UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
        ///          SP :- offers_Insert
        ///          Methods :-   AddQuotations(offer, offer.Site.ConnectPlantConstr);
        ///                       AddLogEntryByOffer(offer, offer.Site.ConnectPlantConstr, null);
        ///                       AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public Offer AddOffer(Offer offer, string connectionString, string offerCodeConnectionString, Int32 idSite, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {
            Int64 offerId = 0;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
            {
                if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                    UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                else
                    offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
            }
            else
                UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);

            if (offerInsertedInGCM)
            {
                using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                {
                    conoffer.Open();
                    using (MySqlTransaction trans = conoffer.BeginTransaction())
                    {
                        try
                        {
                            // SP:- offers_Insert this sp is used till Sprint58
                            // MySqlCommand conoffercommand = new MySqlCommand("offers_Insert", conoffer);

                            // To Add RFQ changed SP:-offers_Insert_Sprint59 in Sprint59
                            MySqlCommand conoffercommand = new MySqlCommand("offers_Insert_Sprint59", conoffer);

                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                            conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                            conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                            conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                            conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                            conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                            conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                            conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                            conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                            conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                            conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                            conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                            conoffercommand.Parameters.AddWithValue("_CreatedBy", offer.CreatedBy);
                            conoffercommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                            conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                            conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                            conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                            conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                            conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                            conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                            conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                            conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                            conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                            conoffercommand.Transaction = trans;
                            offerId = Convert.ToInt64(conoffercommand.ExecuteScalar());
                            offer.IdOffer = offerId;
                            offer.Year = DateTime.Now.Year;

                            UpdateEngAnalysisStatus(dotProjectConnectionString, offer);

                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }

                    }
                }
            }
            if (offerInsertedInGCM && offer.IdOffer > 0)
            {
                AddQuotations(offer, offer.Site.ConnectPlantConstr, dotProjectConnectionString, mailServer, workbenchConnectionString);
                AddLogEntryByOffer(offer, offer.Site.ConnectPlantConstr, null);
                AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);

            }
            return offer;
        }


        /// <summary>
        /// This method is to get site deatils by site id
        /// </summary>
        /// <param name="IdSite">Get id site</param>
        /// <param name="connectionString">Get connection string</param>
        /// <returns>company details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          Company s = mgr.GetSiteByIdSite(Int32 IdSite, string connectionString);
        ///          QUERY :- "SELECT s.name as siteName, s.idsite, s.idcustomer, s.LanguageForDocumentation, c.name as cusName, co.idcountry, co.idzone " +
        ///                   " FROM sites s " +
        ///                   " INNER JOIN customers c on c.idcustomer=s.idcustomer " +
        ///                   " inner join countries co on co.idcountry=s.idcountry" +
        ///                   " WHERE IdSite = ?IdSite;";
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        private Company GetSiteByIdSite(Int32 IdSite, string connectionString)
        {
            Company s = new Company();

            MySqlConnection MyConnection = new MySqlConnection(connectionString);
            MyConnection.Open();

            //string query = "SELECT s.name as siteName, s.idsite, s.idcustomer, s.LanguageForDocumentation, c.name as cusName, co.idcountry, co.idzone " +
            //               " FROM sites s " +
            //               " INNER JOIN customers c on c.idcustomer=s.idcustomer " +
            //               " inner join countries co on co.idcountry=s.idcountry" +
            //               " WHERE IdSite = ?IdSite;";

            MySqlCommand myCommand = new MySqlCommand("sites_GetSiteDetailsById", MyConnection);
            myCommand.CommandType = CommandType.StoredProcedure;
            myCommand.Parameters.AddWithValue("_IdSite", IdSite);
            MySqlDataReader reader = myCommand.ExecuteReader();

            if (reader.Read())
            {
                s.Name = reader["siteName"].ToString();
                s.IdCompany = Convert.ToInt32(reader["IdSite"]);
                s.LanguageForDocumentation = reader["LanguageForDocumentation"].ToString();
                s.Customer = new Customer();
                s.Customer.IdCustomer = Convert.ToInt32(reader["idcustomer"]);
                s.Customer.CustomerName = reader["cusName"].ToString();
                s.Country = new Country();
                s.Country.IdCountry = Convert.ToByte(reader["idcountry"]);
                s.Country.Zone = new Zone();
                s.Country.Zone.IdZone = Convert.ToInt32(reader["idzone"]);
            }
            else
            {
                s.IdCompany = 0;
            }
            reader.Close();
            myCommand.Dispose();
            MyConnection.Close();

            return s;
        }

        /// <summary>
        /// This method is to get emdep site deatils by site id
        /// </summary>
        /// <param name="idSite">Get site id</param>
        /// <param name="connectionString">Get connection string</param>
        /// <returns>Emdep site details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          EmdepSite s = mgr.GetEmdepSiteById(Int32 IdSite, string connectionString);
        ///          QUERY :- @"SELECT em.IP,
        ///                     em.idSite,
        ///                     em.FileServerIP,
        ///                     em.DatabaseIP,
        ///                     si.ShortName
        ///                      FROM emdepsites em INNER JOIN sites si ON em.idSite = si.IdSite
        ///                      WHERE em.idsite = ? IDSITE";
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public EmdepSite GetEmdepSiteById(Int32 idSite, string connectionString)
        {

            //string query = @"SELECT em.IP,
            //                 em.idSite,
            //                 em.FileServerIP,
            //                 em.DatabaseIP,
            //                 si.ShortName
            //                 FROM emdepsites em INNER JOIN sites si ON em.idSite = si.IdSite
            //                 WHERE em.idsite = ?IDSITE";

            EmdepSite site = new EmdepSite();

            MySqlConnection myConnection;
            myConnection = new MySqlConnection(connectionString);
            myConnection.Open();

            MySqlCommand myCommand = new MySqlCommand("emdepsites_GetemdepsitesDetailsById", myConnection);
            myCommand.CommandType = CommandType.StoredProcedure;
            myCommand.Parameters.Add("_IdSite", idSite);
            MySqlDataReader reader = myCommand.ExecuteReader();

            if (reader.Read())
            {
                site.IP = reader["IP"].ToString();
                site.IdSite = Convert.ToUInt32(reader["idSite"]);
                site.FileServerIP = Convert.ToString(reader["FileServerIP"]);
                site.DatabaseIP = Convert.ToString(reader["DatabaseIP"]);
                site.ShortName = reader["ShortName"].ToString();
            }

            reader.Close();
            myCommand.Dispose();
            myConnection.Close();

            return site;
        }
        public bool ExistsDirectory(string path)
        {
            return Directory.Exists(path);

        }
        public void CreateDirectory(string path)
        {

            Directory.CreateDirectory(path);


        }
        /// <summary>
        /// This method is to create folder of offer
        /// </summary>
        /// <param name="offer">Get offer details</param>
        /// <param name="connectionString">Get connection string</param>
        /// <param name="offerSiteId">Get offer site id</param>
        /// <param name="commericalPath">Get commerical path where to create offer folder</param>
        /// <param name="workingOrdersPath">Get work order path to create working order folder</param>
        /// <returns>Is created or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          bool isCreated = mgr.CreateFolderOffer(Offer offer, string connectionString, string offerSiteId, string commericalPath, string workingOrdersPath);
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public bool CreateFolderOffer(Offer offer, string connectionString, string offerSiteId, string commericalPath, string workingOrdersPath, string workbenchConnectionString, bool? isNewFolderForOffer = null)
        {
            string basepath = "";
            string path = string.Empty;
            string year = string.Empty;

            if (offer.Year > 0)
            {
                year = Convert.ToString(offer.Year);
            }
            else
            {
                year = DateTime.Now.Year.ToString();
            }

            try
            {
                // EmdepSite site = GetEmdepSiteById(Convert.ToInt32(offerSiteId), connectionString);

                if (offer.IdOfferType == 1)
                {
                    basepath = commericalPath;

                    if (!ExistsDirectory(basepath + " " + year))
                    {
                        string newOffersPath = basepath + " " + year;
                        CreateDirectory(newOffersPath);
                    }

                    basepath = basepath + " " + year;


                    if (!ExistsDirectory(System.IO.Path.Combine(basepath, offer.Site.FullName)))
                    {
                        string newCustomerPath = System.IO.Path.Combine(basepath, offer.Site.FullName);
                        CreateDirectory(newCustomerPath);
                    }
                    basepath = System.IO.Path.Combine(basepath, offer.Site.FullName);


                    if (!ExistsDirectory(System.IO.Path.Combine(basepath, offer.Code)))
                    {
                        string newOfferPath = System.IO.Path.Combine(basepath, offer.Code);
                        CreateDirectory(newOfferPath);
                    }
                    basepath = basepath + "\\" + offer.Code;

                    if (isNewFolderForOffer.HasValue && isNewFolderForOffer.Value)
                    {
                        GeosAppSetting geosAppSetting = GetGeosAppSettings(6, workbenchConnectionString);

                        if (geosAppSetting != null && !string.IsNullOrEmpty(geosAppSetting.DefaultValue))
                        {
                            List<string> folders_offers = geosAppSetting.DefaultValue.Split(';').ToList();

                            foreach (string folder in folders_offers)
                            {
                                string docPath = System.IO.Path.Combine(basepath, folder.Trim());

                                if (!ExistsDirectory(docPath))
                                {
                                    CreateDirectory(docPath);
                                }
                            }
                        }
                    }
                    else
                    {
                        if (!ExistsDirectory(System.IO.Path.Combine(basepath, "DOC_TECNICA")))
                        {
                            string docPath = System.IO.Path.Combine(basepath, "DOC_TECNICA");
                            CreateDirectory(docPath);
                        }

                        if (!ExistsDirectory(System.IO.Path.Combine(basepath, "OFERTAS")))
                        {
                            string offerPath = System.IO.Path.Combine(basepath, "OFERTAS");
                            CreateDirectory(offerPath);
                        }

                        if (!ExistsDirectory(System.IO.Path.Combine(basepath, "OT")))
                        {
                            string otPath = System.IO.Path.Combine(basepath, "OT");
                            CreateDirectory(otPath);
                        }

                        if (!ExistsDirectory(System.IO.Path.Combine(basepath, "PLANOS")))
                        {
                            string drawingsPath = System.IO.Path.Combine(basepath, "PLANOS");
                            CreateDirectory(drawingsPath);
                        }

                        if (!ExistsDirectory(System.IO.Path.Combine(basepath, "TRACKINGS")))
                        {
                            string trackPath = System.IO.Path.Combine(basepath, "TRACKINGS");
                            CreateDirectory(trackPath);
                        }

                        if (!ExistsDirectory(System.IO.Path.Combine(basepath, "SHIPMENTS")))
                        {
                            string trackPath = System.IO.Path.Combine(basepath, "SHIPMENTS");
                            CreateDirectory(trackPath);
                        }

                        if (!ExistsDirectory(System.IO.Path.Combine(basepath, "PO")))
                        {
                            string trackPath = System.IO.Path.Combine(basepath, "PO");
                            CreateDirectory(trackPath);
                        }
                    }
                }

                basepath = System.IO.Path.Combine(workingOrdersPath, year);

                if (!ExistsDirectory(basepath))
                {
                    CreateDirectory(basepath);
                }

                basepath = System.IO.Path.Combine(basepath, offer.Code);
                if (!ExistsDirectory(basepath))
                {
                    CreateDirectory(basepath);
                }


                {
                    path = System.IO.Path.Combine(basepath, "01 Project Specifications");
                    if (!ExistsDirectory(path))
                    {
                        CreateDirectory(path);
                    }

                    path = System.IO.Path.Combine(basepath, "02 Engineering Analysis");
                    if (!ExistsDirectory(path))
                    {
                        CreateDirectory(path);
                    }

                    path = System.IO.Path.Combine(basepath, "03 Production Documentation");
                    if (!ExistsDirectory(path))
                    {
                        CreateDirectory(path);
                    }
                    path = System.IO.Path.Combine(basepath, "04 Drawings");
                    if (!ExistsDirectory(path))
                    {
                        CreateDirectory(path);
                    }
                    path = System.IO.Path.Combine(basepath, "05 Backup");
                    if (!ExistsDirectory(path))
                    {
                        CreateDirectory(path);
                    }
                    path = System.IO.Path.Combine(basepath, "06 Pictures");
                    if (!ExistsDirectory(path))
                    {
                        CreateDirectory(path);
                    }
                    path = System.IO.Path.Combine(basepath, "07 QA Documents");
                    if (!ExistsDirectory(path))
                    {
                        CreateDirectory(path);
                    }
                    path = System.IO.Path.Combine(basepath, "08 Official Documentation");
                    if (!ExistsDirectory(path))
                    {
                        CreateDirectory(path);
                    }
                }

                // Engineering Analysis
                //string engAnalysisPath = System.IO.Path.Combine(workingOrdersPath);
                CopyAttachmentFolderFiles(offer, offerSiteId, workingOrdersPath);

                return true;
            }
            catch (Exception ex)
            {

                throw;
            }
        }

        private bool CopyAttachmentFolderFiles(Offer offer, string offerSiteId, string workingOrdersPath)
        {
            string[] files = null;

            if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.Attachments != null && offer.EngineeringAnalysis.Attachments.Count > 0)
            {
                if (!string.IsNullOrEmpty(offer.EngineeringAnalysis.GUIDString))
                {
                    string zipPath = workingOrdersPath + @"\_tmp\" + offer.EngineeringAnalysis.GUIDString + ".Zip";
                    string extractedPath = workingOrdersPath + @"\_tmp\" + offer.EngineeringAnalysis.GUIDString;

                    //Extract zip to local temp folder.
                    if (File.Exists(zipPath))
                    {
                        ZipFile.ExtractToDirectory(zipPath, extractedPath);

                        //Delete Zip Folder
                        File.Delete(zipPath);

                        //Get all files in Extract folder in _tmp
                        files = Directory.GetFiles(extractedPath);

                        foreach (Attachment attachment in offer.EngineeringAnalysis.Attachments)
                        {
                            if (attachment.IsDeleted && File.Exists(attachment.FilePath))
                            {
                                File.Delete(attachment.FilePath);
                            }
                            else
                            {
                                foreach (string file in files)
                                {
                                    if (Path.GetFileName(file) == attachment.OriginalFileName)
                                    {
                                        StringBuilder destpath = new StringBuilder();
                                        destpath.Append(workingOrdersPath);
                                        destpath.Append(@"\");
                                        destpath.Append(offer.Year);
                                        destpath.Append(@"\");
                                        destpath.Append(offer.Code);
                                        destpath.Append(@"\01 Project Specifications\");

                                        try
                                        {
                                            System.IO.File.Copy(file, destpath + Path.GetFileName(file), true);
                                            File.Delete(file);
                                        }
                                        catch (Exception ex)
                                        {
                                        }
                                    }
                                }
                            }
                        }

                        if (ExistsDirectory(extractedPath))
                        {
                            Directory.Delete(extractedPath, true);
                        }
                    }
                }
                else
                {
                    foreach (Attachment attachment in offer.EngineeringAnalysis.Attachments)
                    {
                        if (attachment.IsDeleted && File.Exists(attachment.FilePath))
                        {
                            File.Delete(attachment.FilePath);
                        }
                    }
                }
            }

            return true;
        }


        /// <summary>
        /// This method is to check exist PO relation or not
        /// </summary>
        /// <param name="customerPurchaseOrder">Get customerPurchaseOrder details</param>
        /// <param name="idOffer">Get offer id</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>Exist PO relation or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          bool exist = mgr.ExistPORelation(CustomerPurchaseOrder customerPurchaseOrder, Int64 idOffer, string connectionstring);
        ///          //QUERY:-"SELECT * from customerpurchaseordersbyoffer where idcustomerpurchaseorder=" + customerPurchaseOrder.IdCustomerPurchaseOrders + " and idOffer=" + idOffer + ";";
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        private bool ExistPORelation(CustomerPurchaseOrder customerPurchaseOrder, Int64 idOffer, string connectionstring)
        {
            bool exist = false;

            using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
            {
                conoffer.Open();
                string query = "SELECT * from customerpurchaseordersbyoffer where idcustomerpurchaseorder=" + customerPurchaseOrder.IdCustomerPurchaseOrders + " and idOffer=" + idOffer + ";";
                MySqlCommand myCommand = new MySqlCommand(query, conoffer);

                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    if (reader.Read())
                        exist = true;
                }
            }
            return exist;
        }

        /// <summary>
        /// This method is to update customer purchase order
        /// </summary>
        /// <param name="customerPurchaseOrder">Get customer purchase order details</param>
        /// <param name="offer">Get offer details</param>
        /// <param name="ConnectionString">Get connection string</param>
        /// <param name="idSite">Get site id</param>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           mgr.UpdateCustomerPurchaseOrder(CustomerPurchaseOrder customerPurchaseOrder, Offer offer, string ConnectionString, Int32 idSite);
        ///          //QUERY:-"SELECT * from customerpurchaseordersbyoffer where idcustomerpurchaseorder=" + customerPurchaseOrder.IdCustomerPurchaseOrders + " and idOffer=" + idOffer + ";";
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public void UpdateCustomerPurchaseOrder(CustomerPurchaseOrder customerPurchaseOrder, Offer offer, string ConnectionString, Int32 idSite)
        {
            using (MySqlConnection conoffer = new MySqlConnection(ConnectionString))
            {

                Int64? idShippingAddress;
                Int32? idCustomer;
                conoffer.Open();
                using (MySqlTransaction trans = conoffer.BeginTransaction())
                {
                    try
                    {
                        if (!(customerPurchaseOrder.ShippingAddress.IdShippingAddress != 0))
                            idShippingAddress = customerPurchaseOrder.ShippingAddress.IdShippingAddress;
                        else
                            idShippingAddress = null;
                        if (customerPurchaseOrder.Company.IdCompany != 0)
                            idCustomer = customerPurchaseOrder.Company.IdCompany;
                        else
                            idCustomer = null;

                        string sqlQuery = "UPDATE customerPurchaseOrders SET Code='" + customerPurchaseOrder.Code + "', ReceivedIn='" + customerPurchaseOrder.ReceivedIn.ToString("yyyy-MM-dd HH:mm:ss") + "', ReceivedBy='" + customerPurchaseOrder.ReceivedBy + "', " +
                                            " value=" + customerPurchaseOrder.Value + ", idCurrency=" + customerPurchaseOrder.Currency.IdCurrency + ", ModifiedBy=" + customerPurchaseOrder.ModifiedBy.IdUser + ", ModifiedIn='" + customerPurchaseOrder.ModifiedIn.ToString("yyyy-MM-dd HH:mm:ss") + "', isGoAhead=" + customerPurchaseOrder.IsGoAhead + ", idSite=" + idCustomer + ", idshippingAddress=" + idShippingAddress + ", isPartial=" + customerPurchaseOrder.IsPartial + " " +
                                            " WHERE idcustomerpurchaseorders=" + customerPurchaseOrder.IdCustomerPurchaseOrders + ";";

                        MySqlCommand conoffercommand = new MySqlCommand(sqlQuery, conoffer);
                        conoffercommand.Transaction = trans;
                        conoffercommand.ExecuteNonQuery();
                        trans.Commit();
                    }
                    catch (Exception ex)
                    {
                        trans.Rollback();
                        throw;
                    }
                }
            }

        }

        /// <summary>
        /// This method is to get all log entries by id offer
        /// </summary>
        /// <param name="idOffer">Get offer id</param>
        /// <param name="connectionString">Get connection string</param>
        /// <returns>List of log entry by offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           logEntries = mgr.GetAllLogEntriesByIdOffer(Int64 idOffer, string connectionString);
        ///          //SP:-logentry_GetAllLogEntriesByIdOffer
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public List<LogEntryByOffer> GetAllLogEntriesByIdOffer(Int64 idOffer, string connectionString)
        {
            List<LogEntryByOffer> logEntries = new List<LogEntryByOffer>();
            //using (var workbenchcontext = new WorkbenchContext())
            //{
            using (MySqlConnection conoffer = new MySqlConnection(connectionString))
            {
                conoffer.Open();

                MySqlCommand conoffercommand = new MySqlCommand("logentry_GetAllLogEntriesByIdOffer", conoffer);
                conoffercommand.CommandType = CommandType.StoredProcedure;
                conoffercommand.Parameters.AddWithValue("_idOffer", idOffer);
                using (MySqlDataReader reader = conoffercommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        LogEntryByOffer logEntryByOffer = new LogEntryByOffer();
                        logEntryByOffer.IdLogEntry = Convert.ToInt64(reader["idLogEntry"].ToString());
                        logEntryByOffer.IdLogEntryType = Convert.ToByte(reader["idLogEntryType"].ToString());
                        logEntryByOffer.IdOffer = Convert.ToInt64(reader["idOffer"].ToString());
                        logEntryByOffer.IdUser = Convert.ToInt32(reader["idUser"].ToString());
                        logEntryByOffer.People = new People { IdPerson = Convert.ToInt32(reader["idUser"].ToString()), Name = reader["Name"].ToString(), Surname = reader["Surname"].ToString() };
                        logEntryByOffer.DateTime = Convert.ToDateTime(reader["dateTime"].ToString());
                        logEntryByOffer.Comments = reader["comments"].ToString();
                        logEntryByOffer.IsDeleted = false;
                        logEntries.Add(logEntryByOffer);
                    }
                }
                //}
            }
            return logEntries;
        }

        /// <summary>
        /// This method is to get all log entries by site id
        /// </summary>
        /// <param name="idSite">Get site id</param>
        /// <param name="connectionString">Get connection string</param>
        /// <returns>List of LogEntryBySite</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           logEntries = mgr.GetAllLogEntriesByIdSite(Int64 idOffer, string connectionString);
        ///          //SP:-logentry_GetAllLogEntriesByIdSite
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public List<LogEntryBySite> GetAllLogEntriesByIdSite(Int64 idSite, string connectionString)
        {
            List<LogEntryBySite> logEntries = new List<LogEntryBySite>();
            //using (var workbenchcontext = new WorkbenchContext())
            //{
            using (MySqlConnection conoffer = new MySqlConnection(connectionString))
            {
                conoffer.Open();

                MySqlCommand conoffercommand = new MySqlCommand("logentry_GetAllLogEntriesByIdSite", conoffer);
                conoffercommand.CommandType = CommandType.StoredProcedure;
                conoffercommand.Parameters.AddWithValue("_idSite", idSite);
                using (MySqlDataReader reader = conoffercommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        LogEntryBySite logEntryBySite = new LogEntryBySite();
                        logEntryBySite.IdLogEntryBySite = Convert.ToInt64(reader["IdLogEntriesBySite"].ToString());
                        // logEntryBySite.IdLogEntryType = Convert.ToByte(reader["idLogEntryType"].ToString());
                        logEntryBySite.IdSite = Convert.ToInt64(reader["IdSite"].ToString());
                        logEntryBySite.IdUser = Convert.ToInt32(reader["IdUser"].ToString());
                        logEntryBySite.People = new People { IdPerson = Convert.ToInt32(reader["IdUser"].ToString()), Name = reader["Name"].ToString(), Surname = reader["Surname"].ToString() };
                        logEntryBySite.DateTime = Convert.ToDateTime(reader["DateTime"].ToString());
                        logEntryBySite.Comments = reader["comments"].ToString();
                        logEntryBySite.IsDeleted = false;
                        logEntries.Add(logEntryBySite);
                    }
                }
                //}
            }
            return logEntries;
        }

        /// <summary>
        /// This method is to get all comments by id offer
        /// </summary>
        /// <param name="idOffer">Get offer id</param>
        /// <param name="connectionString">Get connection string</param>
        /// <returns>list of log entry by offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           logEntries = mgr.GetAllCommentsByIdOffer(Int64 idOffer, string connectionString);
        ///          //SP:-logentry_GetAllCommentsByIdOffer
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public List<LogEntryByOffer> GetAllCommentsByIdOffer(Int64 idOffer, string connectionString)
        {
            List<LogEntryByOffer> logEntries = new List<LogEntryByOffer>();
            //using (var workbenchcontext = new WorkbenchContext())
            //{
            using (MySqlConnection conoffer = new MySqlConnection(connectionString))
            {
                conoffer.Open();

                MySqlCommand conoffercommand = new MySqlCommand("logentry_GetAllCommentsByIdOffer", conoffer);
                conoffercommand.CommandType = CommandType.StoredProcedure;
                conoffercommand.Parameters.AddWithValue("_idOffer", idOffer);

                using (MySqlDataReader reader = conoffercommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        LogEntryByOffer logEntryByOffer = new LogEntryByOffer();
                        logEntryByOffer.IdLogEntry = Convert.ToInt64(reader["idLogEntry"].ToString());
                        logEntryByOffer.IdLogEntryType = Convert.ToByte(reader["idLogEntryType"].ToString());
                        logEntryByOffer.IdOffer = Convert.ToInt64(reader["idOffer"].ToString());
                        logEntryByOffer.IdUser = Convert.ToInt32(reader["idUser"].ToString());
                        logEntryByOffer.IsRtfText = Convert.ToBoolean(reader["IsRtfText"].ToString());

                        logEntryByOffer.People = new People();
                        logEntryByOffer.People.IdPerson = Convert.ToInt32(reader["idUser"].ToString());
                        logEntryByOffer.People.Name = reader["Name"].ToString();
                        logEntryByOffer.People.Surname = reader["Surname"].ToString();
                        logEntryByOffer.People.Login = reader["Login"].ToString();

                        if (reader["IdPersonGender"] != DBNull.Value)
                        {
                            logEntryByOffer.People.IdPersonGender = Convert.ToByte(reader["IdPersonGender"].ToString());
                        }

                        logEntryByOffer.DateTime = Convert.ToDateTime(reader["dateTime"].ToString());
                        logEntryByOffer.Comments = reader["comments"].ToString();
                        logEntries.Add(logEntryByOffer);
                    }
                }
                return logEntries;
            }
            //}
        }

        /// <summary>
        /// This method is to add customer purchase order relation
        /// </summary>
        /// <param name="customerPurchaseOrder">Get customer purchase order details</param>
        /// <param name="offer">Get offer details</param>
        /// <param name="ConnectionString">Get connection string</param>
        /// <param name="idSite">Get site id</param>
        /// <param name="dotProjectConnectionString">Get dot project connection string</param>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           mgr.InsertCustomerPurchaseOrderRelation(CustomerPurchaseOrder customerPurchaseOrder, Offer offer, string ConnectionString, Int32 idSite);
        ///          //QUERY:-"INSERT INTO customerpurchaseordersbyoffer (idOffer, idCustomerPurchaseOrder, emailSent, Comments) " +
        ///                    " VALUES(" + offer.IdOffer + ", " + customerPurchaseOrder.IdCustomerPurchaseOrders + ", " + customerPurchaseOrder.EmailSent + ", '" + customerPurchaseOrder.Comments + "');";
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        private void InsertCustomerPurchaseOrderRelation(CustomerPurchaseOrder customerPurchaseOrder, Offer offer, string ConnectionString, Int32 idSite)
        {
            //SendNewPOMail(o,idSite, ConnectionString, dotProjectConnectionString);

            MySqlConnection MyConnection;
            using (MyConnection = new MySqlConnection(ConnectionString))
            {
                MyConnection.Open();
                using (MySqlTransaction trans = MyConnection.BeginTransaction())
                {
                    try
                    {
                        string sqlQuery = "INSERT INTO customerpurchaseordersbyoffer (idOffer, idCustomerPurchaseOrder, emailSent, Comments) " +
                                        " VALUES(" + offer.IdOffer + ", " + customerPurchaseOrder.IdCustomerPurchaseOrders + ", " + customerPurchaseOrder.EmailSent + ", '" + customerPurchaseOrder.Comments + "');";
                        MySqlCommand conoffercommand = new MySqlCommand(sqlQuery, MyConnection);
                        conoffercommand.Transaction = trans;
                        conoffercommand.ExecuteNonQuery();
                        trans.Commit();
                    }
                    catch (Exception ex)
                    {
                        trans.Rollback();
                        throw;
                    }
                }
            }
            customerPurchaseOrder.OperationDB = OperationDb.Nothing;

        }

        /// <summary>
        /// This method is to check is the first PO or not
        /// </summary>
        /// <param name="offer">Get offer details</param>
        /// <param name="idSite">Get site id</param>
        /// <param name="ConnectionString">Get connection string</param>
        /// <returns>Is the first PO or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          bool first =  IsTheFirstPO(Offer offer, Int32 idSite, string ConnectionString);
        ///          //QUERY:-" select * from customerpurchaseordersbyoffer where idoffer=" + offer.IdOffer + ";";
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        private bool IsTheFirstPO(Offer offer, Int32 idSite, string ConnectionString)
        {
            bool first = true;
            Int64 idsite = idSite;

            using (MySqlConnection myConnection = new MySqlConnection(ConnectionString))
            {
                myConnection.Open();
                string query = " select * from customerpurchaseordersbyoffer where idoffer=" + offer.IdOffer + ";";
                MySqlCommand myCommand = new MySqlCommand(query, myConnection);

                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    if (reader.Read())
                        first = false;
                }
            }

            return first;
        }

        /// <summary>
        /// This method is to udate quotation details
        /// </summary>
        /// <param name="offer">Get offer details</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///         UpdateQuotation(Offer offer, string connectionstring);
        ///         //Method:- GetOfferQuotationByIdOffer(offer.IdOffer, connectionstring);
        ///                    GetTemplatesBySelectedOptionsByOffer(connectionstring, offer.OptionsByOffers.Where(op => op.IsSelected == true).ToList());
        ///                    GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
        ///                    GetDefaultArticleByIdOfferOption(optionsByOffer.IdOption, connectionstring);
        ///          //SP:- quotations_Insert
        ///          //QUERY:- "select * from quotations where Code = '" + quotationCode + "';";
        ///                    "update quotations set IdOffer=" + offer.IdOffer + " where IdDetectionsTemplate = " + quotation.IdTemplate + " AND Code = '" + quotationCode + "';";
        ///                    "select * from revisions where IdQuotation=" + idQuotation + "";
        ///                    "INSERT INTO revisions (idquotation ,numrevision, madeBy, reviewedBy, creationDate, comments, sentTo, closed, discount, expiryDate, idcurrency, ModifiedBy, ModifiedIn)" +
        ///                    "VALUES (" + idQuotation + " ," + r.NumRevision + ", " + r.CreatedBy + ", " + r.ReviewedBy + ", '" + r.CreatedIn.ToString("yyyy/MM/dd HH:mm:ss") + "', '" + r.Comments + "', '" + string.Empty + "', '" + r.ApprovedIn.ToString("yyyy/MM/dd HH:mm:ss") + "', 0, '" + r.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss") + "', " + offer.IdCurrency + "," + offer.ModifiedBy + ", '" + DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss") + "');";
        ///                    "DELETE FROM optionsbyoffer WHERE IdOffer = " + offer.IdOffer + " AND IdOption = " + optionsByOffer.IdOption + ";";
        ///                    "update quotations set IdOffer=null where IdDetectionsTemplate = " + quotation.IdTemplate + " AND IdOffer = " + offer.IdOffer + ";";
        ///     }
        /// }
        /// </code>
        /// </example>
        private void UpdateQuotation(Offer offer, string connectionstring, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {
            List<Quotation> quotationByIdOffer = GetOfferQuotationByIdOffer(offer.IdOffer, connectionstring).ToList();
            List<byte> quotIdDetectionsTemplates = quotationByIdOffer.Select(fg => fg.IdDetectionsTemplate).ToList();

            //List<byte> quotIdDetectionsTemplates = GetOfferQuotationByIdOffer(offer.IdOffer, connectionstring).ToList().Select(fg => fg.IdDetectionsTemplate).ToList();

            List<byte> selectedOptionByOfferTemplates = GetTemplatesBySelectedOptionsByOffer(connectionstring, offer.OptionsByOffers.Where(op => op.IsSelected == true).ToList());


            foreach (OptionsByOffer optionsByOffer in offer.OptionsByOffers)
            {
                if (optionsByOffer.IsSelected == true && optionsByOffer.Quantity > 0)
                {
                    List<Template> selectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                    Template selectedOptiontemplate = GetDefaultArticleByIdOfferOption(optionsByOffer.IdOption, connectionstring);
                    if (selectedOptiontemplate != null)
                        selectedOptionTemplates.Add(selectedOptiontemplate);

                    using (MySqlConnection conoption = new MySqlConnection(connectionstring))
                    {
                        conoption.Open();
                        using (MySqlTransaction trans = conoption.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand conoptioncommand = new MySqlCommand("optionsbyoffer_Update", conoption);
                                conoptioncommand.CommandType = CommandType.StoredProcedure;
                                conoptioncommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                conoptioncommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                conoptioncommand.Parameters.AddWithValue("_Quantity", optionsByOffer.Quantity);
                                conoptioncommand.Transaction = trans;
                                conoptioncommand.ExecuteNonQuery();
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }


                    foreach (Template quotation in selectedOptionTemplates)
                    {
                        if (!quotIdDetectionsTemplates.Contains(quotation.IdTemplate))
                        {
                            bool isUpdate = false;
                            string quotationCode = offer.Code + quotation.Suffix;
                            Int64 idQuotation = 0;

                            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                            {
                                conquotation.Open();
                                MySqlCommand conquotationcommand = new MySqlCommand("quotations_GetquotationsByCode", conquotation);
                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                using (MySqlDataReader reader = conquotationcommand.ExecuteReader())
                                {
                                    if (reader.Read())
                                    {
                                        isUpdate = true;

                                        if (reader["IdQuotation"] != DBNull.Value)
                                        {
                                            idQuotation = Convert.ToInt64(reader["IdQuotation"]);
                                        }
                                    }
                                }
                            }

                            if (isUpdate)
                            {
                                using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                {
                                    conquotation.Open();
                                    using (MySqlTransaction trans = conquotation.BeginTransaction())
                                    {
                                        try
                                        {
                                            // string sqlQuery = "update quotations set IdOffer=" + offer.IdOffer + " where IdDetectionsTemplate = " + quotation.IdTemplate + " AND Code = '" + quotationCode + "';";
                                            MySqlCommand conquotationcommand = new MySqlCommand("quotations_UpdateByCode", conquotation);
                                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                                            conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                            conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                            conquotationcommand.Transaction = trans;
                                            conquotationcommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }

                                //Engineering analysis update code. Comment and date when added from unlinked to linked.
                                if (optionsByOffer.IdOption == 25)
                                {
                                    Quotation quot = new Quotation();
                                    quot.IdQuotation = idQuotation;

                                    if (quot != null)
                                    {
                                        Ots ot = GetOTByQuotationId(quot, connectionstring);
                                        List<OtItem> otitems = null;

                                        if (ot != null)
                                        {
                                            otitems = GetOtItemsByIdOT(ot, connectionstring);

                                            using (var transactionScope = new TransactionScope())
                                            {
                                                try
                                                {
                                                    UpdateOTByIdOT(offer, quot, ot, connectionstring);

                                                    foreach (var otItem in otitems)
                                                    {
                                                        UpdateOTitemByIdOtItem(offer, otItem, connectionstring);

                                                        //Get part number tracking and add update tracking
                                                        PartNumbersTracking partNumbersTracking = GetPartNumbersTrackingByIdOtItem(otItem, 23, connectionstring);

                                                        if (partNumbersTracking != null)
                                                        {
                                                            if (otItem.Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                                            {
                                                                partNumbersTracking.IdOperator = offer.ModifiedBy;
                                                                partNumbersTracking.EndDate = DateTime.Now;
                                                                partNumbersTracking.Paused = false;
                                                            }
                                                            else if (otItem.Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                            {
                                                                partNumbersTracking.IdOperator = null;
                                                                partNumbersTracking.EndDate = null;
                                                                partNumbersTracking.Paused = true;


                                                            }

                                                            UpdatePartNumbersTrackingByIdPartNumbersTracking(offer, partNumbersTracking, connectionstring);
                                                        }


                                                    }
                                                    transactionScope.Complete();
                                                }
                                                catch (Exception ex)
                                                {
                                                    if (Transaction.Current != null)
                                                        Transaction.Current.Rollback();

                                                    if (transactionScope != null)
                                                        transactionScope.Dispose();

                                                    throw;
                                                }
                                            }

                                            quot.Ots = new List<Ots>();
                                            quot.Ots.Add(ot);
                                            UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, quot, workbenchConnectionString, mailServer);

                                            if (otitems != null && otitems.Count > 0)
                                            {
                                                ApplicationManager applicationManager = new ApplicationManager();

                                                //This property is for AssignedEngAnalysis from dotproject.
                                                People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);

                                                // Send email when eng analysis is validated by 
                                                if (otitems[0].Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                                {
                                                    if (offer.EngineeringAnalysis != null)
                                                        applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                                    else
                                                        applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, ot.DeliveryDate);

                                                    LogEntryByOffer log = new LogEntryByOffer();
                                                    log.IdUser = offer.ModifiedBy;
                                                    log.DateTime = DateTime.Now;
                                                    log.Comments = "The analysis of engineering department has been completed.";
                                                    log.IdLogEntryType = 2;
                                                    offer.LogEntryByOffers.Add(log);
                                                }
                                                else if (otitems[0].Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                {
                                                    if (offer.EngineeringAnalysis != null)
                                                        applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                                    else
                                                        applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, ot.DeliveryDate);

                                                    LogEntryByOffer log = new LogEntryByOffer();
                                                    log.IdUser = offer.ModifiedBy;
                                                    log.DateTime = DateTime.Now;
                                                    log.Comments = "The analysis of engineering department has been re-opened.";
                                                    log.IdLogEntryType = 2;
                                                    offer.LogEntryByOffers.Add(log);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            else
                            {
                                //Int64 idQuotation = 0;
                                Quotation tempquotation = new Quotation();
                                tempquotation.Offer = new Offer();
                                tempquotation.Offer.IdOffer = offer.IdOffer;
                                tempquotation.Year = DateTime.Now.Year;
                                tempquotation.Number = offer.Number;
                                tempquotation.Code = offer.Code + quotation.Suffix;
                                tempquotation.CreatedIn = DateTime.Now;
                                tempquotation.Template = new Template();
                                tempquotation.Template = quotation;
                                if (quotation.IdTemplate != 0)
                                {
                                    // string quotationCode = offer.Code + quotation.Suffix;
                                    using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                    {
                                        conquotation.Open();
                                        using (MySqlTransaction trans = conquotation.BeginTransaction())
                                        {
                                            try
                                            {
                                                MySqlCommand conquotationcommand = new MySqlCommand("quotations_Insert", conquotation);
                                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                                conquotationcommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                                conquotationcommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                                conquotationcommand.Parameters.AddWithValue("_Number", offer.Number);
                                                conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                                conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                                conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                                conquotationcommand.Parameters.AddWithValue("_QuotQuantity", 0);
                                                conquotationcommand.Parameters.AddWithValue("_Description", offer.Description);
                                                conquotationcommand.Transaction = trans;
                                                idQuotation = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                if (idQuotation > 0)
                                                {
                                                    bool isinsert = false;
                                                    MySqlCommand conoffercommand = new MySqlCommand("revisions_GetrevisionsByIdQuotation", conquotation);
                                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                                    conoffercommand.Parameters.AddWithValue("_IdQuotation", idQuotation);

                                                    using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                                                    {
                                                        if (!offerreader.Read())
                                                        {
                                                            isinsert = true;
                                                        }
                                                    }

                                                    if (isinsert)
                                                    {
                                                        Revision r = new Revision();
                                                        r.NumRevision = 0;
                                                        //[001]
                                                        if (offer.ModifiedBy != null && offer.ModifiedBy == 164)
                                                        {
                                                            r.CreatedBy = 164;
                                                            r.ReviewedBy = 164;
                                                        }
                                                        else
                                                        {
                                                            r.CreatedBy = offer.ModifiedBy;
                                                            r.ReviewedBy = offer.ModifiedBy;
                                                        }
                                                        r.CreatedIn = DateTime.Now;
                                                        r.NumRevision = 0;
                                                        r.Discount = 0;
                                                        r.ExpireDate = DateTime.Now.AddDays(14);
                                                        r.Comments = offer.Contact + "\r\n" + offer.Description;
                                                        //r.Quotation = quotation;
                                                        if (quotation.IdTemplate == 15 || quotation.IdTemplate == 16 || quotation.IdTemplate == 18)
                                                            r.ApprovedIn = DateTime.Now;
                                                        else
                                                            r.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");

                                                        conquotationcommand = new MySqlCommand("revisions_Insert", conquotation);
                                                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                        conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                                                        conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r.ReviewedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_NumRevision", r.NumRevision);
                                                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_MadeBy", r.CreatedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                                        conquotationcommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                                        conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                                                        conquotationcommand.Parameters.AddWithValue("_CreationDate", r.CreatedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_Comments", r.Comments);
                                                        conquotationcommand.Parameters.AddWithValue("_Closed", r.ApprovedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Transaction = trans;
                                                        r.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                        tempquotation.Revisions = new List<Revision>();
                                                        tempquotation.Revisions.Add(r);
                                                    }
                                                }
                                                trans.Commit();
                                            }
                                            catch (Exception ex)
                                            {
                                                trans.Rollback();
                                                throw;
                                            }
                                        }
                                    }

                                    tempquotation.IdQuotation = idQuotation;

                                    ///////////////////////////////////////////////////////

                                    if (offer.IdOfferType != 10 && quotation.IdTemplate == 15) // || quotation.IdTemplate == 23))
                                    {
                                        List<OtItem> items = new List<OtItem>();

                                        List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                                        items.AddRange(temp);
                                        if (items.Count != 0)
                                            CreateQuotationWithItems(tempquotation, offer, items, connectionstring);
                                    }
                                    else if (offer.IdOfferType != 10 && quotation.IdTemplate == 23)
                                    {
                                        List<OtItem> items = new List<OtItem>();

                                        List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                                        items.AddRange(temp);
                                        if (items.Count != 0)
                                            CreateQuotationWithItems(tempquotation, offer, items, connectionstring);

                                        //link EPC for eng analysis. 
                                        if (!ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                            InsertEngAnalysisInDotProject(dotProjectConnectionString, connectionstring, mailServer, workbenchConnectionString, offer, tempquotation);
                                        else
                                            UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, tempquotation, workbenchConnectionString, mailServer);
                                        //GOM_v3.Properties.Settings.Default.Email_Delivery_Date_Changed

                                    }
                                }
                            }
                        }
                        else
                        {
                            //Update Quotation Codes when offer type is changed.
                            string quotationCode = offer.Code + quotation.Suffix;

                            Quotation quotationByOffer = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == quotation.IdTemplate);

                            if (quotation != null)
                                UpdateQuotationCodeIfTypeChanged(offer, quotationByOffer, quotation, connectionstring);

                            if (optionsByOffer.IdOption == 25) //Engineering analysis update code.
                            {
                                Quotation quot = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == 23);

                                if (quot != null)
                                {
                                    Ots ot = GetOTByQuotationId(quot, connectionstring);
                                    List<OtItem> otitems = null;

                                    if (ot != null)
                                    {
                                        otitems = GetOtItemsByIdOT(ot, connectionstring);

                                        using (var transactionScope = new TransactionScope())
                                        {
                                            try
                                            {
                                                UpdateOTByIdOT(offer, quot, ot, connectionstring);

                                                foreach (var otItem in otitems)
                                                {
                                                    UpdateOTitemByIdOtItem(offer, otItem, connectionstring);

                                                    //Get part number tracking and add update tracking
                                                    PartNumbersTracking partNumbersTracking = GetPartNumbersTrackingByIdOtItem(otItem, 23, connectionstring);

                                                    if (partNumbersTracking != null)
                                                    {
                                                        if (otItem.Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                                        {
                                                            partNumbersTracking.IdOperator = offer.ModifiedBy;
                                                            partNumbersTracking.EndDate = DateTime.Now;
                                                            partNumbersTracking.Paused = false;
                                                        }
                                                        else if (otItem.Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                        {
                                                            partNumbersTracking.IdOperator = null;
                                                            partNumbersTracking.EndDate = null;
                                                            partNumbersTracking.Paused = true;
                                                        }

                                                        UpdatePartNumbersTrackingByIdPartNumbersTracking(offer, partNumbersTracking, connectionstring);
                                                    }
                                                }

                                                transactionScope.Complete();
                                            }
                                            catch (Exception ex)
                                            {
                                                if (Transaction.Current != null)
                                                    Transaction.Current.Rollback();

                                                if (transactionScope != null)
                                                    transactionScope.Dispose();

                                                throw;
                                            }
                                        }
                                    }

                                    quot.Ots = new List<Ots>();
                                    quot.Ots.Add(ot);
                                    if (ot != null)
                                        UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, quotationByOffer, workbenchConnectionString, mailServer);

                                    if (otitems != null && otitems.Count > 0)
                                    {
                                        ApplicationManager applicationManager = new ApplicationManager();

                                        //This property is for AssignedEngAnalysis from dotproject.
                                        People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);

                                        // Send email when eng analysis is validated by 
                                        if (otitems[0].Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                        {
                                            if (offer.EngineeringAnalysis != null)
                                            {
                                                applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                            }
                                            else
                                            {
                                                applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, ot.DeliveryDate);
                                            }

                                            LogEntryByOffer log = new LogEntryByOffer();
                                            log.IdUser = offer.ModifiedBy;
                                            log.DateTime = DateTime.Now;
                                            log.Comments = "The analysis of engineering department has been completed.";
                                            log.IdLogEntryType = 2;
                                            offer.LogEntryByOffers.Add(log);
                                        }
                                        else if (otitems[0].Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                        {
                                            if (offer.EngineeringAnalysis != null)
                                            {
                                                applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                            }
                                            else
                                            {
                                                applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, ot.DeliveryDate);
                                            }

                                            LogEntryByOffer log = new LogEntryByOffer();
                                            log.IdUser = offer.ModifiedBy;
                                            log.DateTime = DateTime.Now;
                                            log.Comments = "The analysis of engineering department has been re-opened.";
                                            log.IdLogEntryType = 2;
                                            offer.LogEntryByOffers.Add(log);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                else
                {
                    if (optionsByOffer.IsSelected == false && optionsByOffer.Quantity == 0)
                    {
                        using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                        {
                            conquotation.Open();
                            using (MySqlTransaction trans = conquotation.BeginTransaction())
                            {
                                try
                                {
                                    //string sqlQuery = "DELETE FROM optionsbyoffer WHERE IdOffer = " + offer.IdOffer + " AND IdOption = " + optionsByOffer.IdOption + ";";
                                    MySqlCommand conquotationcommand = new MySqlCommand("optionsbyoffer_Delete", conquotation);
                                    conquotationcommand.CommandType = CommandType.StoredProcedure;
                                    conquotationcommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                    conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conquotationcommand.Transaction = trans;
                                    conquotationcommand.ExecuteNonQuery();

                                    if (optionsByOffer.IdOption == 25 && ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                        UpdateProjectStatusInDotProject(dotProjectConnectionString, offer, 7);

                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }

                        List<Template> unselectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                        Template unselectedOptionTemplate = GetDefaultArticleByIdOfferOption(optionsByOffer.IdOption, connectionstring);

                        if (unselectedOptionTemplate != null)
                            unselectedOptionTemplates.Add(unselectedOptionTemplate);

                        foreach (Template quotation in unselectedOptionTemplates)
                        {
                            if (!selectedOptionByOfferTemplates.Contains(quotation.IdTemplate))
                            {
                                using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                {
                                    conquotation.Open();
                                    using (MySqlTransaction trans = conquotation.BeginTransaction())
                                    {
                                        try
                                        {
                                            //string sqlQuery = "update quotations set IdOffer=null where IdDetectionsTemplate = " + quotation.IdTemplate + " AND IdOffer = " + offer.IdOffer + ";";
                                            MySqlCommand conquotationcommand = new MySqlCommand("quotations_UpdateByIdOfferANDTemplate", conquotation);
                                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                                            conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                            conquotationcommand.Transaction = trans;
                                            conquotationcommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }
                            }
                        }
                    }

                }
            }
        }

        /// <summary>
        /// [CRM-M025-01] Add an option to create Eng Analysis.
        /// Get OTs related to quotation.
        /// </summary>
        /// <param name="quotation">The quotation.</param>
        /// <param name="connectionstring">The Offer connection string.</param>
        /// <returns></returns>
        private Ots GetOTByQuotationId(Quotation quotation, string connectionstring)
        {
            Ots ot = null;

            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
            {
                conquotation.Open();
                MySqlCommand conquotationcommand = new MySqlCommand("ots_GetOTsByQuotationId", conquotation);
                conquotationcommand.CommandType = CommandType.StoredProcedure;
                conquotationcommand.Parameters.AddWithValue("_IdQuotation", quotation.IdQuotation);

                using (MySqlDataReader reader = conquotationcommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ot = new Ots();

                        ot.IdOT = Convert.ToInt64(reader["IdOT"].ToString());

                        if (reader["NumOT"] != DBNull.Value)
                            ot.NumOT = Convert.ToByte(reader["NumOT"].ToString());

                        if (reader["Comments"] != DBNull.Value)
                            ot.Comments = Convert.ToString(reader["Comments"]);

                        if (reader["Observations"] != DBNull.Value)
                            ot.Observations = Convert.ToString(reader["Observations"]);

                        if (reader["CreatedBy"] != DBNull.Value)
                            ot.CreatedBy = Convert.ToInt32(reader["CreatedBy"]);

                        if (reader["ReviewedBy"] != DBNull.Value)
                            ot.ReviewedBy = Convert.ToInt32(reader["ReviewedBy"]);

                        if (reader["CreationDate"] != DBNull.Value)
                            ot.CreationDate = Convert.ToDateTime(reader["CreationDate"].ToString());

                        if (reader["DeliveryDate"] != DBNull.Value)
                            ot.DeliveryDate = Convert.ToDateTime(reader["DeliveryDate"].ToString());

                        if (reader["DeliveryDate"] != DBNull.Value)
                            ot.PrevDeliveryDate = Convert.ToDateTime(reader["DeliveryDate"].ToString());

                        if (reader["IdSite"] != DBNull.Value)
                            ot.IdSite = Convert.ToInt32(reader["IdSite"]);

                        if (reader["AttachedFiles"] != DBNull.Value)
                            ot.AttachedFiles = Convert.ToString(reader["AttachedFiles"]);

                        if (reader["Code"] != DBNull.Value)
                            ot.Code = Convert.ToString(reader["Code"]);

                        if (reader["Year"] != DBNull.Value)
                            ot.Year = Convert.ToInt32(reader["Year"]);

                        if (reader["Number"] != DBNull.Value)
                            ot.Number = Convert.ToInt32(reader["Number"]);
                    }
                }
            }

            return ot;
        }


        /// <summary>
        /// [CRM-M025-01] Add an option to create Eng Analysis.
        /// To Get ot items by idot.
        /// </summary>
        /// <param name="ot">The OT</param>
        /// <param name="connectionstring">The connection string of offer.</param>
        /// <returns>The List of OtItems.</returns>
        private List<OtItem> GetOtItemsByIdOT(Ots ot, string connectionstring)
        {
            List<OtItem> otitems = new List<OtItem>();

            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
            {
                conquotation.Open();
                MySqlCommand conquotationcommand = new MySqlCommand("ots_GetOtItemsByIdOT", conquotation);
                conquotationcommand.CommandType = CommandType.StoredProcedure;
                conquotationcommand.Parameters.AddWithValue("_IdOT", ot.IdOT);

                using (MySqlDataReader reader = conquotationcommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        OtItem otitem = new OtItem();

                        otitem.IdOT = ot.IdOT;

                        if (reader["IsBatch"] != DBNull.Value)
                            otitem.IsBatch = Convert.ToByte(reader["IsBatch"].ToString());

                        if (reader["NumItem"] != DBNull.Value)
                        {
                            otitem.RevisionItem = new RevisionItem();
                            otitem.RevisionItem.NumItem = Convert.ToString(reader["NumItem"]);
                        }

                        if (reader["IdOTItem"] != DBNull.Value)
                            otitem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                        if (reader["IdItemOtStatus"] != DBNull.Value)
                        {
                            otitem.Status = new ItemOTStatusType();
                            otitem.Status.IdItemOtStatus = Convert.ToInt32(reader["IdItemOtStatus"]);
                            otitem.Status.Name = Convert.ToString(reader["Status"]);
                        }

                        if (reader["Rework"] != DBNull.Value)
                            otitem.Rework = Convert.ToByte(reader["Rework"]);

                        if (reader["CustomerComment"] != DBNull.Value)
                            otitem.CustomerComment = Convert.ToString(reader["CustomerComment"]);

                        if (reader["AttachedFiles"] != DBNull.Value)
                            otitem.AttachedFiles = Convert.ToString(reader["AttachedFiles"]);

                        if (reader["AssignedTo"] != DBNull.Value)
                        {
                            otitem.AssignedTo = Convert.ToInt32(reader["AssignedTo"]);
                            otitem.AssignedToUser = new People();
                            otitem.AssignedToUser.IdPerson = Convert.ToInt32(reader["AssignedTo"]);
                            otitem.AssignedToUser.Name = Convert.ToString(reader["Name"]);
                            otitem.AssignedToUser.Surname = Convert.ToString(reader["Surname"]);
                            otitem.AssignedToUser.Email = Convert.ToString(reader["Email"]);
                        }

                        otitems.Add(otitem);
                    }
                }
            }

            return otitems;
        }

        private PartNumbersTracking GetPartNumbersTrackingByIdOtItem(OtItem otItem, byte idStage, string connectionString)
        {
            PartNumbersTracking partNumbersTracking = null;

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("ots_GetPartNumbersTrackingByIdOTItem", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdOTItem", otItem.IdOTItem);
                mySqlCommand.Parameters.AddWithValue("_IdStage", idStage);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        partNumbersTracking = new PartNumbersTracking();

                        if (reader["IdPartNumberTracking"] != DBNull.Value)
                            partNumbersTracking.IdPartNumberTracking = Convert.ToInt64(reader["IdPartNumberTracking"]);

                        if (reader["IdPartNumber"] != DBNull.Value)
                            partNumbersTracking.IdPartNumber = Convert.ToInt64(reader["IdPartNumber"]);

                        if (reader["IdStage"] != DBNull.Value)
                            partNumbersTracking.IdStage = Convert.ToByte(reader["IdStage"]);

                        if (reader["StartDate"] != DBNull.Value)
                            partNumbersTracking.StartDate = Convert.ToDateTime(reader["StartDate"]);

                        if (reader["EndDate"] != DBNull.Value)
                            partNumbersTracking.EndDate = Convert.ToDateTime(reader["EndDate"]);

                        if (reader["IdOperator"] != DBNull.Value)
                            partNumbersTracking.IdOperator = Convert.ToInt32(reader["IdOperator"]);

                        if (reader["CurrentTime"] != DBNull.Value)
                            partNumbersTracking.CurrentTime = Convert.ToInt64(reader["CurrentTime"]);

                        if (reader["Rework"] != DBNull.Value)
                            partNumbersTracking.Rework = Convert.ToBoolean(reader["Rework"]);

                        if (reader["IdCause"] != DBNull.Value)
                            partNumbersTracking.IdCause = Convert.ToInt32(reader["IdCause"]);

                        if (reader["Paused"] != DBNull.Value)
                            partNumbersTracking.Paused = Convert.ToBoolean(reader["Paused"]);

                        if (reader["Remarks"] != DBNull.Value)
                            partNumbersTracking.Remarks = Convert.ToString(reader["Remarks"]);
                    }
                }
            }

            return partNumbersTracking;
        }

        /// <summary>
        /// [CRM-M025-01] Add an option to create Eng Analysis.
        /// This method is used to update delivery date of OT. (used TransactionScope for this).
        /// </summary>
        /// <param name="of">The Offer</param>
        /// <param name="quotation">The Quotation</param>
        /// <param name="ot">The Ot</param>
        /// <param name="connectionstring">The Connection string of offer plant</param>
        private void UpdateOTByIdOT(Offer of, Quotation quotation, Ots ot, string connectionstring)
        {
            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
            {
                conquotation.Open();

                try
                {
                    MySqlCommand conquotationcommand = new MySqlCommand("ots_Update", conquotation);
                    conquotationcommand.CommandType = CommandType.StoredProcedure;

                    conquotationcommand.Parameters.AddWithValue("_NumOT", ot.NumOT);
                    conquotationcommand.Parameters.AddWithValue("_CreationDate", ot.CreationDate);

                    if (of.EngineeringAnalysis != null)
                    {
                        ot.DeliveryDate = of.EngineeringAnalysis.DueDate;
                        conquotationcommand.Parameters.AddWithValue("_DeliveryDate", of.EngineeringAnalysis.DueDate);
                    }
                    else
                    {
                        conquotationcommand.Parameters.AddWithValue("_DeliveryDate", ot.DeliveryDate);
                    }

                    conquotationcommand.Parameters.AddWithValue("_IdSite", of.Site.ConnectPlantId);
                    conquotationcommand.Parameters.AddWithValue("_CreatedBy", ot.CreatedBy);
                    conquotationcommand.Parameters.AddWithValue("_ReviewedBy", ot.ReviewedBy);
                    conquotationcommand.Parameters.AddWithValue("_Code", ot.Code);
                    conquotationcommand.Parameters.AddWithValue("_Year", ot.Year);
                    conquotationcommand.Parameters.AddWithValue("_Number", ot.Number);
                    conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                    conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ot.CreatedBy);
                    conquotationcommand.Parameters.AddWithValue("_IdAddress", null);
                    conquotationcommand.Parameters.AddWithValue("_IsClosed", ot.IsClosed);
                    conquotationcommand.Parameters.AddWithValue("_IdQuotation", quotation.IdQuotation);

                    conquotationcommand.ExecuteNonQuery();

                    conquotation.Close();
                }
                catch (Exception ex)
                {
                    conquotation.Close();
                    throw;
                }
            }
        }

        /// <summary>
        /// [CRM-M025-01] Add an option to create Eng Analysis.
        /// This code is to update Internal comment in Otitem status.
        /// </summary>
        /// <param name="of">The Offer</param>
        /// <param name="otItem">The Ot item.</param>
        /// <param name="connectionstring">The Connection string of offer plant</param>
        private void UpdateOTitemByIdOtItem(Offer of, OtItem otItem, string connectionstring)
        {
            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
            {
                conquotation.Open();

                try
                {
                    MySqlCommand conquotationcommand = new MySqlCommand("otitems_Update", conquotation);
                    conquotationcommand.CommandType = CommandType.StoredProcedure;

                    conquotationcommand.Parameters.AddWithValue("_IdOTItem", otItem.IdOTItem);

                    if (of.EngineeringAnalysis != null)
                    {
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", of.EngineeringAnalysis.Comments);

                        //[CRM-M040-02] If eng analysis is completed then update otitem status to shipped.
                        if (of.EngineeringAnalysis.IsCompleted)
                        {
                            conquotationcommand.Parameters.AddWithValue("_IdItemOtStatus", 10);
                        }
                        else
                        {
                            conquotationcommand.Parameters.AddWithValue("_IdItemOtStatus", 1);
                        }
                    }
                    else
                    {
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", "");
                    }

                    conquotationcommand.ExecuteNonQuery();
                    conquotation.Close();
                }
                catch (Exception ex)
                {
                    conquotation.Close();
                    throw;
                }
            }
        }

        private void UpdateOTitemByIdOtItem_V2041(Offer of, OtItem otItem, string connectionstring)
        {
            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
            {
                conquotation.Open();

                try
                {
                    MySqlCommand conquotationcommand = new MySqlCommand("otitems_Update", conquotation);
                    conquotationcommand.CommandType = CommandType.StoredProcedure;

                    conquotationcommand.Parameters.AddWithValue("_IdOTItem", otItem.IdOTItem);

                    if (of.EngineeringAnalysis != null)
                    {
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", of.EngineeringAnalysis.Comments);

                        //[CRM-M040-02] If eng analysis is completed then update otitem status to shipped.
                        if (of.EngineeringAnalysis.IsCompleted)
                        {
                            if (otItem.RevisionItem.Quantity > 0)
                            {
                                conquotationcommand.Parameters.AddWithValue("_IdItemOtStatus", 10);
                            }

                            else
                            {
                                conquotationcommand.Parameters.AddWithValue("_IdItemOtStatus", 15);

                            }

                        }
                        else
                        {
                            if (otItem.RevisionItem.Quantity > 0)
                            {
                                conquotationcommand.Parameters.AddWithValue("_IdItemOtStatus", 1);

                            }

                            else
                            {
                                conquotationcommand.Parameters.AddWithValue("_IdItemOtStatus", 15);

                            }

                        }
                    }
                    else
                    {
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", "");
                    }

                    conquotationcommand.ExecuteNonQuery();
                    conquotation.Close();
                }
                catch (Exception ex)
                {
                    conquotation.Close();
                    throw;
                }
            }
        }
        private void UpdateOTitemByIdOtItem_V2042(Offer of, OtItem otItem, string connectionstring)
        {
            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
            {
                conquotation.Open();

                try
                {
                    MySqlCommand conquotationcommand = new MySqlCommand("otitems_Update", conquotation);
                    conquotationcommand.CommandType = CommandType.StoredProcedure;

                    conquotationcommand.Parameters.AddWithValue("_IdOTItem", otItem.IdOTItem);

                    if (of.EngineeringAnalysis != null)
                    {
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", of.EngineeringAnalysis.Comments);

                        //[CRM-M040-02] If eng analysis is completed then update otitem status to shipped.
                        if (of.EngineeringAnalysis.IsCompleted)
                        {
                            if (otItem.RevisionItem.Quantity > 0)
                            {
                                conquotationcommand.Parameters.AddWithValue("_IdItemOtStatus", 10);
                            }

                            else
                            {
                                conquotationcommand.Parameters.AddWithValue("_IdItemOtStatus", 15);

                            }

                        }
                        else
                        {
                            if (otItem.RevisionItem.Quantity > 0)
                            {
                                if(otItem.Status.IdItemOtStatus==15)
                                    conquotationcommand.Parameters.AddWithValue("_IdItemOtStatus", 1);
                                else
                                    conquotationcommand.Parameters.AddWithValue("_IdItemOtStatus", otItem.Status.IdItemOtStatus);
                            }

                            else
                            {
                                conquotationcommand.Parameters.AddWithValue("_IdItemOtStatus", 15);

                            }

                        }
                    }
                    else
                    {
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", "");
                    }

                    conquotationcommand.ExecuteNonQuery();
                    conquotation.Close();
                }
                catch (Exception ex)
                {
                    conquotation.Close();
                    throw;
                }
            }
        }
        private void UpdatePartNumbersTrackingByIdPartNumbersTracking(Offer of, PartNumbersTracking partNumbersTracking, string connectionstring)
        {
            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
            {
                conquotation.Open();

                try
                {
                    MySqlCommand mySqlCommand = new MySqlCommand("PartNumbersTracking_Update", conquotation);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;

                    mySqlCommand.Parameters.AddWithValue("_IdPartNumberTracking", partNumbersTracking.IdPartNumberTracking);
                    mySqlCommand.Parameters.AddWithValue("_IdPartNumber", partNumbersTracking.IdPartNumber);
                    mySqlCommand.Parameters.AddWithValue("_IdStage", partNumbersTracking.IdStage);
                    mySqlCommand.Parameters.AddWithValue("_StartDate", partNumbersTracking.StartDate);
                    mySqlCommand.Parameters.AddWithValue("_EndDate", partNumbersTracking.EndDate);
                    mySqlCommand.Parameters.AddWithValue("_IdOperator", partNumbersTracking.IdOperator);
                    mySqlCommand.Parameters.AddWithValue("_CurrentTime", partNumbersTracking.CurrentTime);
                    mySqlCommand.Parameters.AddWithValue("_Rework", partNumbersTracking.Rework);
                    mySqlCommand.Parameters.AddWithValue("_IdCause", partNumbersTracking.IdCause);
                    mySqlCommand.Parameters.AddWithValue("_Paused", partNumbersTracking.Paused);
                    mySqlCommand.Parameters.AddWithValue("_Remarks", partNumbersTracking.Remarks);

                    mySqlCommand.ExecuteNonQuery();
                    conquotation.Close();
                }
                catch (Exception ex)
                {
                    conquotation.Close();
                    throw;
                }
            }
        }


        /// <summary>
        /// [CRM-M023-21] Quotation Code is not renamed when offer code is changed.
        /// </summary>
        private void UpdateQuotationCodeIfTypeChanged(Offer offer, Quotation quotationByIdOffer, Template template, string connectionString)
        {
            //bool offerInsertedInGCM = true;

            //if (offer.IsUpdateLeadToOT)
            //{
            //    if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
            //        offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
            //    else
            //        UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
            //}

            using (MySqlConnection connQuotation = new MySqlConnection(connectionString))
            {
                string quotationCode = offer.Code + template.Suffix;
                connQuotation.Open();
                using (MySqlTransaction trans = connQuotation.BeginTransaction())
                {
                    try
                    {
                        MySqlCommand quotationCommand = new MySqlCommand("quotations_UpdateQuotationCode", connQuotation);
                        quotationCommand.CommandType = CommandType.StoredProcedure;

                        quotationCommand.Parameters.AddWithValue("_IdQuotation", quotationByIdOffer.IdQuotation);
                        quotationCommand.Parameters.AddWithValue("_Year", offer.Year);
                        quotationCommand.Parameters.AddWithValue("_Number", offer.Number);
                        quotationCommand.Parameters.AddWithValue("_Code", quotationCode);
                        quotationCommand.Parameters.AddWithValue("_IdDetectionsTemplate", template.IdTemplate);
                        quotationCommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                        quotationCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        quotationCommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);

                        quotationCommand.Transaction = trans;
                        quotationCommand.ExecuteNonQuery();
                        trans.Commit();
                    }
                    catch (Exception ex)
                    {
                        trans.Rollback();
                        throw;
                    }
                }
            }
        }

        /// <summary>
        /// This method is to get current plant id 
        /// </summary>
        /// <param name="idUser">Get user id</param>
        /// <param name="connectionString">Get connection string</param>
        /// <returns>Company details of current plant id </returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          Company company= mgr.GetCurrentPlantId(Int32 idUser, string connectionString)
        ///          //Method:-GetCurrentSiteId(idUser, connectionString);
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public Company GetCurrentPlantId(Int32 idUser, string connectionString)
        {
            Company site = GetCurrentSiteId(idUser, connectionString);

            return site;
        }

        public bool UpdateOfferForParticularColumn(Offer offer, string connectionstring, string offerCodeConnectionString, Int32 idSite, Int32 idUser, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {
            bool isupdated = false;
            bool isupdatedLeadToOT = true;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            try
            {
                if (offer.IsUpdateLeadToOT)
                {
                    if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
                    {
                        if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                            UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                        else
                            offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
                    }
                    else
                        UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                }

                if (offerInsertedInGCM)
                {
                    MySqlDataAdapter daGCM;
                    DataTable dtGCM;

                    using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                    {
                        conoffer.Open();
                        string query = "select IdOffer from offers where Code= '" + offer.Code + "' and IdOffer =" + offer.IdOffer + " ;";

                        daGCM = new MySqlDataAdapter(query, conoffer);

                        dtGCM = new DataTable();
                        daGCM.Fill(dtGCM);

                        if (dtGCM.Rows.Count > 0)
                            isupdatedLeadToOT = false;

                    }

                    if (offer.IsUpdateLeadToOT)
                    {

                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_LeadOTUpdateParticularColumn", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    //conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                    conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    //conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    //conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    //conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                    else
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_UpdateParticularColumn", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    //conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    //conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    //conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    //conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    //conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);

                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                }

                if (isupdated)
                {
                    UpdateQuotation(offer, offer.Site.ConnectPlantConstr, dotProjectConnectionString, mailServer, workbenchConnectionString);

                    //LostReasonsByOffer lostReasonsByOffer = UpdateLostReasonsByOffer(offer.LostReasonsByOffer, offer.Site.ConnectPlantConstr);
                    AddLogEntryByOffer(offer, connectionstring, offer.Site.ConnectPlantConstr);
                    //AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);
                }

            }
            catch (Exception ex)
            {
                throw;
                //isupdated = false;
            }

            return isupdated;
        }





        /// <summary>
        /// This method is to update offer details
        /// </summary>
        /// <param name="offer">Get offer details to update</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="offerCodeConnectionString">Get offer code connection string</param>
        /// <param name="idSite">Get site id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="commericalPath">Get commerical path</param>
        /// <param name="workingOrdersPath">Get working order path</param>
        /// <param name="mainserverConnectionString">Get main server connection string</param>
        /// <returns>is updated or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string offerCodeConnectionString = ConfigurationManager.ConnectionStrings["OfferCodeContext"].ConnectionString;
        ///           string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           string mainServerConnectionString = ConfigurationManager.ConnectionStrings["MainServerContext"].ConnectionString;
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          bool isupdated= mgr.UpdateOffer(Offer offer, string connectionstring, string offerCodeConnectionString, Int32 idSite, Int32 idUser, string commericalPath, string workingOrdersPath, string mainserverConnectionString);
        ///          //Method :- offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
        ///                      UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
        ///                      UpdateQuotation(offer, offer.Site.ConnectPlantConstr);
        ///                      LostReasonsByOffer lostReasonsByOffer = UpdateLostReasonsByOffer(offer.LostReasonsByOffer, offer.Site.ConnectPlantConstr);
        ///                      AddLogEntryByOffer(offer, connectionstring, offer.Site.ConnectPlantConstr);
        ///                      AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);
        ///           //Query :- "select IdOffer from offers where Code= '" + offer.Code + "' and IdOffer =" + offer.IdOffer + " ;";
        ///           //SP :- offers_LeadOTUpdate ,offers_Update         
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public bool UpdateOffer(Offer offer, string connectionstring, string offerCodeConnectionString, Int32 idSite, Int32 idUser, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {
            bool isupdated = false;
            bool isupdatedLeadToOT = true;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            try
            {
                if (offer.IsUpdateLeadToOT)
                {
                    if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
                    {
                        if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                            UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                        else
                            offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
                    }
                    else
                        UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                }

                if (offerInsertedInGCM)
                {
                    MySqlDataAdapter daGCM;
                    DataTable dtGCM;

                    using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                    {
                        conoffer.Open();
                        string query = "select IdOffer from offers where Code= '" + offer.Code + "' and IdOffer =" + offer.IdOffer + " ;";

                        daGCM = new MySqlDataAdapter(query, conoffer);
                        dtGCM = new DataTable();
                        daGCM.Fill(dtGCM);

                        if (dtGCM.Rows.Count > 0)
                            isupdatedLeadToOT = false;
                    }
                    Int64? nullProductCategory = null;
                    if (offer.IdProductCategory > 0)
                    {
                        nullProductCategory = offer.IdProductCategory;
                    }
                    if (offer.IsUpdateLeadToOT)
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_LeadOTUpdate", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                    conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    trans.Commit();

                                    offer.Year = DateTime.Now.Year;
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                    else
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_Update", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                }

                if (isupdated)
                {
                    UpdateEngAnalysisStatus(dotProjectConnectionString, offer);

                    UpdateQuotation(offer, offer.Site.ConnectPlantConstr, dotProjectConnectionString, mailServer, workbenchConnectionString);

                    LostReasonsByOffer lostReasonsByOffer = UpdateLostReasonsByOffer(offer.LostReasonsByOffer, offer.Site.ConnectPlantConstr);
                    AddLogEntryByOffer(offer, connectionstring, offer.Site.ConnectPlantConstr);
                    AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);

                    if (offer.NewlyLinkedActivities != null && offer.NewlyLinkedActivities.Count > 0)
                    {
                        using (var transactionScope = new TransactionScope())
                        {
                            try
                            {
                                AddLinkExistingActivityToOffer(mainserverConnectionString, offer.NewlyLinkedActivities, offer.Site, offer.IdOffer);
                                transactionScope.Complete();
                            }
                            catch (Exception ex)
                            {
                                if (Transaction.Current != null)
                                    Transaction.Current.Rollback();

                                if (transactionScope != null)
                                    transactionScope.Dispose();

                                throw;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
                //isupdated = false;
            }

            return isupdated;
        }

        /// <summary>
        /// This method is to get offer quotation by id offer
        /// </summary>
        /// <param name="idOffer">Get offer id</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>List of Quotation</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          quotations = mgr.GetOfferQuotationByIdOffer(Int64 idOffer, string connectionstring)
        ///          //SP:-quotations_GetQuotationsByofferId
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        private List<Quotation> GetOfferQuotationByIdOffer(Int64 idOffer, string connectionstring)
        {
            List<Quotation> quotations = new List<Quotation>();
            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
            {
                conquotation.Open();
                MySqlCommand conquotationcommand = new MySqlCommand("quotations_GetQuotationsByofferId", conquotation);
                conquotationcommand.CommandType = CommandType.StoredProcedure;
                conquotationcommand.Parameters.AddWithValue("_offerId", idOffer);
                using (MySqlDataReader quotationreader = conquotationcommand.ExecuteReader())
                {
                    while (quotationreader.Read())
                    {
                        Quotation quotation = new Quotation();
                        quotation.IdOffer = Convert.ToInt64(quotationreader["IdOffer"].ToString());
                        quotation.IdQuotation = Convert.ToInt64(quotationreader["IdQuotation"].ToString());
                        if (quotationreader["QuotQuantity"] != DBNull.Value)
                            quotation.QuotQuantity = Convert.ToInt64(quotationreader["QuotQuantity"].ToString());
                        quotation.IdDetectionsTemplate = Convert.ToByte(quotationreader["IdDetectionsTemplate"].ToString());
                        quotation.Template = new Template { IdTemplate = Convert.ToByte(quotationreader["IdTemplate"].ToString()), Name = quotationreader["Name"].ToString(), Suffix = quotationreader["Suffix"].ToString() };
                        quotations.Add(quotation);
                    }
                }
            }
            return quotations;
        }

        /// <summary>
        /// This method is to get default article by id offer option
        /// </summary>
        /// <param name="idOfferOption">Get offer option id</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>Template details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          Template template = mgr.GetDefaultArticleByIdOfferOption(Int64 idOfferOption, string connectionstring);
        ///          //QUERY:-"SELECT * FROM defaultarticlesbyofferoption WHERE idOfferOption = " + idOfferOption + " AND idTemplate = 18;";
        ///                   "SELECT * FROM templates WHERE IdTemplate = 18;";
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        private Template GetDefaultArticleByIdOfferOption(Int64 idOfferOption, string connectionstring)
        {
            Template template = new Template();
            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
            {
                conquotation.Open();

                // string query = "SELECT * FROM defaultarticlesbyofferoption WHERE idOfferOption = " + idOfferOption + " AND idTemplate = 18;";
                MySqlCommand conoffercommand = new MySqlCommand("GetdefaultarticlesbyofferoptionByIdidOfferOption", conquotation);
                conoffercommand.CommandType = CommandType.StoredProcedure;
                conoffercommand.Parameters.AddWithValue("_IdOfferOption", idOfferOption);
                using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                {
                    if (offerreader.Read())
                    {
                        using (MySqlConnection contemplate = new MySqlConnection(connectionstring))
                        {
                            contemplate.Open();

                            //string templatequery = "SELECT * FROM templates WHERE IdTemplate = 18;";
                            MySqlCommand contemplatecommand = new MySqlCommand("templates_GetTemplateByIdTemplate", contemplate);
                            contemplatecommand.CommandType = CommandType.StoredProcedure;
                            contemplatecommand.Parameters.AddWithValue("_IdTemplate", 18);

                            using (MySqlDataReader templatereader = contemplatecommand.ExecuteReader())
                            {
                                if (templatereader.Read())
                                {
                                    template.Suffix = templatereader["Suffix"].ToString();
                                    template.Name = templatereader["Name"].ToString();
                                    template.IdTemplate = Convert.ToByte(templatereader["IdTemplate"].ToString());
                                    template.Type = Convert.ToByte(templatereader["Type"].ToString());
                                }
                            }
                        }
                    }
                }
            }
            return template;
        }

        /// <summary>
        /// This method is to update offer status
        /// </summary>
        /// <param name="idOffer">Get offer id</param>
        /// <param name="idStatus">Get status id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="statusDate">Get status date</param>
        /// <param name="idSalesStatusType">Get sales status type id</param>
        /// <param name="isCodeUpdate">Get is code update or not</param>
        /// <param name="lostReasonsByOffer">Get lost reason by offer</param>
        /// <param name="connectionString ">Get connection string, </param>
        /// <param name="connectPlantconstr ">Get pant connection string</param>
        /// <param name="mainserverConnectionString">Get main server connection string</param>
        /// <param name="offer">Get offer details</param>
        /// <param name="offerCodeConnectionString">Get offer code connection string</param>
        /// <param name="idSite">Get site id</param>
        /// <returns>updated or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///           string connectionString = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           string offerCodeConnectionString = ConfigurationManager.ConnectionStrings["OfferCodeContext"].ConnectionString;
        ///           string mainserverConnectionString = ConfigurationManager.ConnectionStrings["MainServerContext"].ConnectionString;
        ///            bool isUpdated = mgr.UpdateOfferStatus(Int64 idOffer, Int64 idStatus, Int32 idUser, DateTime statusDate, Int64 idSalesStatusType, bool isCodeUpdate, LostReasonsByOffer lostReasonsByOffer, string connectionString, string connectPlantconstr, string mainserverConnectionString, Offer offer = null, string offerCodeConnectionString = null, Int32 idSite = 0);
        ///           //Method:-offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
        ///                    UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
        ///                      UpdateLostReasonsByOffer(lostReasonsByOffer, connectPlantconstr);
        ///         //SP :- offers_UpdateOfferStatus,
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public bool UpdateOfferStatus(Int64 idOffer, Int64 idStatus, Int32 idUser, DateTime statusDate, Int64 idSalesStatusType, bool isCodeUpdate, LostReasonsByOffer lostReasonsByOffer, string connectionString, string connectPlantconstr, string mainserverConnectionString, Offer offer = null, string offerCodeConnectionString = null, Int32 idSite = 0, bool UseSQLCounter = true)
        {
            bool isUpdated = false;
            bool offerInsertedInGCM = true;
            try
            {

                if (isCodeUpdate)
                {
                    if (offer != null || idSite != 0 || offerCodeConnectionString != null)
                    {
                        if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
                        {
                            if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                                UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                            else
                                offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
                        }
                        else
                            UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                    }
                }
                if (isCodeUpdate)
                {
                    using (MySqlConnection myConnection = new MySqlConnection(connectPlantconstr))
                    {
                        myConnection.Open();
                        using (MySqlTransaction trans = myConnection.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand concommand = new MySqlCommand("offers_UpdateOfferStatus", myConnection);
                                concommand.CommandType = CommandType.StoredProcedure;
                                concommand.Parameters.AddWithValue("_IdOffer", idOffer);
                                concommand.Parameters.AddWithValue("_Code", offer.Code);
                                concommand.Parameters.AddWithValue("_Number", offer.Number);
                                concommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                                concommand.Parameters.AddWithValue("_IsCodeUpdate", "True");
                                concommand.Parameters.AddWithValue("_IdStatus", idStatus);
                                concommand.Parameters.AddWithValue("_IdSalesStatusType", idSalesStatusType);
                                concommand.Parameters.AddWithValue("_StatusDate", statusDate);
                                concommand.Parameters.AddWithValue("_ModifiedBy", idUser);
                                concommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                concommand.Transaction = trans;
                                concommand.ExecuteNonQuery();
                                isUpdated = true;
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }
                    if (lostReasonsByOffer != null)
                    {
                        UpdateLostReasonsByOffer(lostReasonsByOffer, connectPlantconstr);
                    }
                }
                else
                {
                    using (MySqlConnection myConnection = new MySqlConnection(connectPlantconstr))
                    {
                        myConnection.Open();
                        using (MySqlTransaction trans = myConnection.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand concommand = new MySqlCommand("offers_UpdateOfferStatus", myConnection);
                                concommand.CommandType = CommandType.StoredProcedure;
                                concommand.Parameters.AddWithValue("_IdOffer", idOffer);
                                concommand.Parameters.AddWithValue("_Code", "");
                                concommand.Parameters.AddWithValue("_Number", 0);
                                concommand.Parameters.AddWithValue("_IdOfferType", 0);
                                concommand.Parameters.AddWithValue("_IsCodeUpdate", "False");
                                concommand.Parameters.AddWithValue("_IdStatus", idStatus);
                                concommand.Parameters.AddWithValue("_IdSalesStatusType", idSalesStatusType);
                                concommand.Parameters.AddWithValue("_StatusDate", statusDate);
                                concommand.Parameters.AddWithValue("_ModifiedBy", idUser);
                                concommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                concommand.Transaction = trans;
                                concommand.ExecuteNonQuery();

                                isUpdated = true;
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }
                    if (lostReasonsByOffer != null)
                    {
                        UpdateLostReasonsByOffer(lostReasonsByOffer, connectPlantconstr);
                    }
                }
                if (isUpdated)
                {

                    AddLogEntryByOffer(offer, connectionString, connectPlantconstr);

                }

            }
            catch (Exception ex)
            {
                throw;
            }

            return isUpdated;
        }

        /// <summary>
        /// This method is to update sales target by site
        /// </summary>
        /// <param name="connectionString">Get connection string</param>
        /// <param name="salesTargetBySite">Get sale target by site details to update</param>
        /// <returns>Is updated or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          bool isUpdated = mgr.UpdateSalesTargetBySite(SalesTargetBySite salesTargetBySite, string connectionString)
        ///          //SP :- salestargetbysite_Update
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public bool UpdateSalesTargetBySite(SalesTargetBySite salesTargetBySite, string connectionString)
        {
            bool isUpdated = false;
            try
            {
                using (MySqlConnection myConnection = new MySqlConnection(connectionString))
                {
                    myConnection.Open();
                    using (MySqlTransaction trans = myConnection.BeginTransaction())
                    {
                        try
                        {
                            MySqlCommand concommand = new MySqlCommand("salestargetbysite_Update", myConnection);
                            concommand.CommandType = CommandType.StoredProcedure;
                            concommand.Parameters.AddWithValue("_IdSite", salesTargetBySite.IdSite);
                            concommand.Parameters.AddWithValue("_Year", salesTargetBySite.Year);
                            concommand.Parameters.AddWithValue("_TargetAmount", salesTargetBySite.TargetAmount);
                            concommand.Parameters.AddWithValue("_IdCurrency", salesTargetBySite.IdCurrency);
                            concommand.Transaction = trans;
                            concommand.ExecuteNonQuery();

                            isUpdated = true;
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }

            return isUpdated;
        }

        public bool UpdatePlantBusinessUnitSalesQuota(PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota, string connectionString)
        {
            bool isUpdated = false;
            try
            {
                foreach (LookupValue itemplantBusinessUnitSalesQuota in plantBusinessUnitSalesQuota.LookupValue)
                {
                    using (MySqlConnection myConnection = new MySqlConnection(connectionString))
                    {
                        myConnection.Open();
                        using (MySqlTransaction trans = myConnection.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand concommand = new MySqlCommand("plantBusinessUnitSalesQuota_Update", myConnection);
                                concommand.CommandType = CommandType.StoredProcedure;
                                concommand.Parameters.AddWithValue("_IdPlant", plantBusinessUnitSalesQuota.IdPlant);
                                concommand.Parameters.AddWithValue("_IdBusinessUnit", itemplantBusinessUnitSalesQuota.IdLookupValue);
                                concommand.Parameters.AddWithValue("_SalesQuotaAmount", itemplantBusinessUnitSalesQuota.SalesQuotaAmount);
                                concommand.Parameters.AddWithValue("_IdSalesQuotaCurrency", itemplantBusinessUnitSalesQuota.IdSalesQuotaCurrency);
                                concommand.Transaction = trans;
                                concommand.ExecuteNonQuery();

                                isUpdated = true;
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                throw;
            }

            return isUpdated;
        }

        public bool UpdatePlantBusinessUnitSalesQuotaWithYear(PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota, string connectionString)
        {
            bool isUpdated = false;
            try
            {
                foreach (LookupValue itemplantBusinessUnitSalesQuota in plantBusinessUnitSalesQuota.LookupValue)
                {
                    using (MySqlConnection myConnection = new MySqlConnection(connectionString))
                    {
                        myConnection.Open();
                        using (MySqlTransaction trans = myConnection.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand concommand = new MySqlCommand("plantBusinessUnitSalesQuota_UpdateWithYear", myConnection);
                                concommand.CommandType = CommandType.StoredProcedure;
                                concommand.Parameters.AddWithValue("_IdPlant", plantBusinessUnitSalesQuota.IdPlant);
                                concommand.Parameters.AddWithValue("_IdBusinessUnit", itemplantBusinessUnitSalesQuota.IdLookupValue);
                                concommand.Parameters.AddWithValue("_AccountingYear", plantBusinessUnitSalesQuota.Year);
                                concommand.Parameters.AddWithValue("_SalesQuotaAmount", itemplantBusinessUnitSalesQuota.SalesQuotaAmount);
                                concommand.Parameters.AddWithValue("_IdSalesQuotaCurrency", itemplantBusinessUnitSalesQuota.IdSalesQuotaCurrency);
                                concommand.Transaction = trans;
                                concommand.ExecuteNonQuery();

                                isUpdated = true;
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                throw;
            }

            return isUpdated;
        }

        /// <summary>
        /// This method is to update lost reasons by offer
        /// </summary>
        /// <param name="lostReasonsByOffer">Get lost reason details by offer</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>Lost reasons by offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          LostReasonsByOffer lostReasonsByOffer = mgr.UpdateLostReasonsByOffer(LostReasonsByOffer lostReasonsByOffer, string connectionstring);
        ///          //QUERY :- "select * from lostreasonsbyoffer where idoffer=" + lostReasonsByOffer.IdOffer + ";"
        ///          //SP :- lostReasonsByOffer_Update,lostReasonsByOffer_Insert
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        private LostReasonsByOffer UpdateLostReasonsByOffer(LostReasonsByOffer lostReasonsByOffer, string connectionstring)
        {
            try
            {
                if (lostReasonsByOffer != null)
                {
                    LostReasonsByOffer lostReason = null;
                    using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
                    {
                        conlostReasonsByOffer.Open();
                        MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("lostreasonsbyoffer_GetLostReasonsByIdOffer", conlostReasonsByOffer);
                        conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                        conlostReasonsByOffercommand.Parameters.AddWithValue("_IdOffer", lostReasonsByOffer.IdOffer);
                        using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                        {
                            if (lostReasonsByOfferreader.Read())
                            {
                                lostReason = new LostReasonsByOffer();
                                lostReason.IdOffer = Convert.ToInt64(lostReasonsByOfferreader["Idoffer"].ToString());
                                lostReason.IdLostReasonList = lostReasonsByOfferreader["IdLostReasonList"].ToString();
                                if (lostReasonsByOfferreader["IdCompetitor"] != DBNull.Value)
                                    lostReason.IdCompetitor = Convert.ToInt64(lostReasonsByOfferreader["IdCompetitor"].ToString());
                                lostReason.Comments = lostReasonsByOfferreader["Comments"].ToString();
                            }
                        }
                    }

                    if (lostReason != null)
                    {
                        using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
                        {
                            conlostReasonsByOffer.Open();
                            using (MySqlTransaction trans = conlostReasonsByOffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("lostReasonsByOffer_Update", conlostReasonsByOffer);
                                    conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                                    conlostReasonsByOffercommand.Parameters.AddWithValue("_IdOffer", lostReasonsByOffer.IdOffer);
                                    conlostReasonsByOffercommand.Parameters.AddWithValue("_IdLostReasonList", lostReasonsByOffer.IdLostReasonList);
                                    conlostReasonsByOffercommand.Parameters.AddWithValue("_IdCompetitor", lostReasonsByOffer.IdCompetitor);
                                    conlostReasonsByOffercommand.Parameters.AddWithValue("_Comments", lostReasonsByOffer.Comments);
                                    conlostReasonsByOffercommand.Transaction = trans;
                                    conlostReasonsByOffercommand.ExecuteNonQuery();
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                    else
                    {
                        using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
                        {
                            conlostReasonsByOffer.Open();
                            using (MySqlTransaction trans = conlostReasonsByOffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("lostReasonsByOffer_Insert", conlostReasonsByOffer);
                                    conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                                    conlostReasonsByOffercommand.Parameters.AddWithValue("_IdOffer", lostReasonsByOffer.IdOffer);
                                    conlostReasonsByOffercommand.Parameters.AddWithValue("_IdLostReasonList", lostReasonsByOffer.IdLostReasonList);
                                    conlostReasonsByOffercommand.Parameters.AddWithValue("_IdCompetitor", lostReasonsByOffer.IdCompetitor);
                                    conlostReasonsByOffercommand.Parameters.AddWithValue("_Comments", lostReasonsByOffer.Comments);
                                    conlostReasonsByOffercommand.Transaction = trans;
                                    conlostReasonsByOffercommand.ExecuteNonQuery();
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                }
            }

            catch (Exception ex)
            {
                throw;
            }
            return lostReasonsByOffer;
        }

        /// <summary>
        /// This method is to get top offers
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="offerLimit">Get offer limit</param>
        /// <param name="accountingYear">Get accountingYear</param>
        /// <param name="companyDetails">Get company details</param>
        /// <param name="idUserPermission">Get user permission</param>
        /// <returns>List of top offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           offers = mgr.GetTopOffers(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int32 offerLimit, Int64 accountingYear, Company companyDetails, Int32 idUserPermission);
        ///          //SP :- offers_GetTopOffers
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<Offer> GetTopOffers(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int32 offerLimit, Int64 accountingYear, Company companyDetails, Int32 idUserPermission)
        {
            IList<Offer> offers = new List<Offer>();
            int rowCount = 0;

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetTopOffers", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_offerLimit", offerLimit);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        rowCount = rowCount + 1;
                        Offer offer = new Offer();
                        offer.IdOffer = Convert.ToInt64(offerreader["idOffer"].ToString());
                        offer.Code = offerreader["Code"].ToString();
                        offer.Description = offerreader["OfferTitle"].ToString();
                        offer.Site = new Company { Name = offerreader["CustomerName"].ToString(), Country = new Country { Name = offerreader["Country"].ToString() } };
                        offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;
                        offer.Site.Customers = new List<Customer> { new Customer { CustomerName = offerreader["CustomerGroup"].ToString() } };
                        offer.Value = Convert.ToDouble(offerreader["OfferAmount"].ToString());
                        offer.Currency = new Currency { Name = offerreader["OfferCurrency"].ToString(), Symbol = offerreader["Symbol"].ToString() };
                        offer.NumberOfOffers = rowCount;
                        if (offerreader["ExpectedPoReceptionDate"] != DBNull.Value)
                            offer.OfferExpectedDate = Convert.ToDateTime(offerreader["ExpectedPoReceptionDate"].ToString());

                        offers.Add(offer);
                        if (offers.Count() == offerLimit)
                            break;
                    }
                }
            }
            //}

            return offers;
        }

        /// <summary>
        /// This method is to get top offers 
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="offerLimit">Get offer limit</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="companyDetails">Get company details</param>
        /// <returns>List of top offer details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           offers = mgr.GetSelectedUsersTopOffers(string connectionstring, byte idCurrency, Int32 offerLimit, Int64 accountingYear, string idUser, Company companyDetails);
        ///          //SP :- offers_GetSelectedUsersTopOffers
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<Offer> GetSelectedUsersTopOffers(string connectionstring, byte idCurrency, Int32 offerLimit, Int64 accountingYear, string idUser, Company companyDetails)
        {
            IList<Offer> offers = new List<Offer>();
            int rowCount = 0;

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUsersTopOffers", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_offerLimit", offerLimit);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {

                    while (offerreader.Read())
                    {
                        rowCount = rowCount + 1;
                        Offer offer = new Offer();
                        offer.IdOffer = Convert.ToInt64(offerreader["idOffer"].ToString());
                        offer.Code = offerreader["Code"].ToString();
                        offer.Description = offerreader["OfferTitle"].ToString();
                        offer.Site = new Company { Name = offerreader["CustomerName"].ToString(), Country = new Country { Name = offerreader["Country"].ToString() } };
                        offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;
                        offer.Site.Customers = new List<Customer> { new Customer { CustomerName = offerreader["CustomerGroup"].ToString() } };
                        offer.Value = Convert.ToDouble(offerreader["OfferAmount"].ToString());
                        offer.Currency = new Currency { Name = offerreader["OfferCurrency"].ToString(), Symbol = offerreader["Symbol"].ToString() };
                        offer.NumberOfOffers = rowCount;
                        if (offerreader["ExpectedPoReceptionDate"] != DBNull.Value)
                            offer.OfferExpectedDate = Convert.ToDateTime(offerreader["ExpectedPoReceptionDate"].ToString());

                        offers.Add(offer);
                        if (offers.Count() == offerLimit)
                            break;
                    }
                }
            }


            return offers;
        }

        /// <summary>
        /// This method is to get list of offer
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="companyDetails">Get company details</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           offers = mgr.GetSalesStatus(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission);
        ///          //SP :- offers_GetSalesStatus
        ///          //Method :- GetSalesStatusTargetDashboard(companyDetails.ConnectPlantConstr, idCurrency, idUser, idZone, accountingYear, idUserPermission);
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<Offer> GetSalesStatus(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission)
        {
            IList<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSalesStatus", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {

                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdStatus = Convert.ToInt64(offerreader["OfferStatusId"].ToString());
                        offer.Site = new Company();
                        //offer.Site.ConnectPlantConstr = dictconnectstr.Value;
                        offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;
                        offer.GeosStatus = new GeosStatus { Name = offerreader["OfferStatusName"].ToString(), SalesStatusType = new SalesStatusType { Name = offerreader["Status"].ToString(), IdImage = Convert.ToInt64(offerreader["StatusIdImage"].ToString()) } };
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        if (offerreader["TotalOfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["TotalOfferAmount"].ToString());
                        offer.Currency = new Currency { Name = offerreader["OfferCurrency"].ToString(), Symbol = offerreader["Symbol"].ToString() };
                        offer.Status = offerreader["Status"].ToString();

                        offers.Add(offer);
                    }
                }
            }

            IList<SalesTargetBySite> salesTargetBySites = GetSalesStatusTargetDashboard(companyDetails.ConnectPlantConstr, idCurrency, idUser, idZone, accountingYear, idUserPermission);
            Offer offertarget = new Offer();
            offertarget.Site = new Company();

            offertarget.Site.ConnectPlantId = companyDetails.ConnectPlantId;
            offertarget.GeosStatus = new GeosStatus { SalesStatusType = new SalesStatusType { Name = "TARGET", IdImage = 0 } };
            offertarget.Status = "TARGET";
            offertarget.Value = Convert.ToDouble(salesTargetBySites[0].TargetAmount);
            offertarget.Currency = new Currency { Name = salesTargetBySites[0].CurrencyConversion.CurrencyFrom.Name, Symbol = salesTargetBySites[0].CurrencyConversion.CurrencyFrom.Symbol };
            offers.Add(offertarget);

            return offers;
        }



        /// <summary>
        /// This method is to get list of offer
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYearFrom">Get accounting year From</param>
        /// <param name="accountingYearTo">Get accounting year To</param>
        /// <param name="companyDetails">Get company details</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///           offers = mgr.GetSalesStatus(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission);
        ///          //SP :- offers_GetSalesStatus
        ///          //Method :- GetSalesStatusTargetDashboard(companyDetails.ConnectPlantConstr, idCurrency, idUser, idZone, accountingYear, idUserPermission);
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<Offer> GetSalesStatus(byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, Int32 idUserPermission)
        {
            IList<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSalesStatusDateWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {

                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdStatus = Convert.ToInt64(offerreader["OfferStatusId"].ToString());
                        offer.Site = new Company();
                        //offer.Site.ConnectPlantConstr = dictconnectstr.Value;
                        offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;
                        offer.GeosStatus = new GeosStatus { Name = offerreader["OfferStatusName"].ToString(), SalesStatusType = new SalesStatusType { Name = offerreader["Status"].ToString(), IdImage = Convert.ToInt64(offerreader["StatusIdImage"].ToString()) } };
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        if (offerreader["TotalOfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["TotalOfferAmount"].ToString());
                        offer.Currency = new Currency { Name = offerreader["OfferCurrency"].ToString(), Symbol = offerreader["Symbol"].ToString() };
                        offer.Status = offerreader["Status"].ToString();
                        offers.Add(offer);
                    }
                }
            }

            IList<SalesTargetBySite> salesTargetBySites = GetSalesStatusTargetDashboard(companyDetails.ConnectPlantConstr, idCurrency, idUser, idZone, accountingYearFrom, accountingYearTo, idUserPermission);
            Offer offertarget = new Offer();
            offertarget.Site = new Company();

            offertarget.Site.ConnectPlantId = companyDetails.ConnectPlantId;
            offertarget.GeosStatus = new GeosStatus { SalesStatusType = new SalesStatusType { Name = "TARGET", IdImage = 0 } };
            offertarget.Status = "TARGET";
            offertarget.Value = Convert.ToDouble(salesTargetBySites[0].TargetAmount);
            offertarget.Currency = new Currency { Name = salesTargetBySites[0].CurrencyConversion.CurrencyFrom.Name, Symbol = salesTargetBySites[0].CurrencyConversion.CurrencyFrom.Symbol };
            offers.Add(offertarget);

            return offers;
        }

        /// <summary>
        /// This method is to get list of offer status details
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get all user ids separeted by , having active user rights to view this users offers</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="companydetails">Get company details</param>
        /// <returns>List of offer status details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          offers = mgr.GetSelectedUserSalesStatus(byte idCurrency, string idUser, Int64 accountingYear, Company companydetails);
        ///          //SP :- offers_GetSelectedUsersSalesStatus
        ///          //Method :- GetSelectedUsersSalesStatusTargetDashboard(companydetails.ConnectPlantConstr, idCurrency, idUser, accountingYear);
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<Offer> GetSelectedUserSalesStatus(byte idCurrency, string idUser, Int64 accountingYear, Company companydetails, Int32 idCurrentUser = 0)
        {
            IList<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companydetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUsersSalesStatus", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdStatus = Convert.ToInt64(offerreader["OfferStatusId"].ToString());
                        offer.Site = new Company();
                        //offer.Site.ConnectPlantConstr = dictconnectstr.Value;
                        offer.Site.ConnectPlantId = companydetails.ConnectPlantId;
                        offer.GeosStatus = new GeosStatus { Name = offerreader["OfferStatusName"].ToString(), SalesStatusType = new SalesStatusType { Name = offerreader["Status"].ToString(), IdImage = Convert.ToInt64(offerreader["StatusIdImage"].ToString()) } };
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        if (offerreader["TotalOfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["TotalOfferAmount"].ToString());
                        offer.Currency = new Currency { Name = offerreader["OfferCurrency"].ToString(), Symbol = offerreader["Symbol"].ToString() };
                        offer.Status = offerreader["Status"].ToString();

                        offers.Add(offer);
                    }
                }
            }
            IList<SalesTargetBySite> salesTargetBySites = GetSelectedUsersSalesStatusTargetDashboard(companydetails.ConnectPlantConstr, idCurrency, idUser, accountingYear);
            Offer offertarget = new Offer();
            offertarget.Site = new Company();
            offertarget.Site.ConnectPlantId = companydetails.ConnectPlantId;
            offertarget.GeosStatus = new GeosStatus { SalesStatusType = new SalesStatusType { Name = "TARGET", IdImage = 0 } };
            offertarget.Status = "TARGET";
            offertarget.Value = Convert.ToDouble(salesTargetBySites[0].TargetAmount);
            offertarget.Currency = new Currency { Name = salesTargetBySites[0].CurrencyConversion.CurrencyFrom.Name, Symbol = salesTargetBySites[0].CurrencyConversion.CurrencyFrom.Symbol };
            offers.Add(offertarget);

            return offers;
        }



        /// <summary>
        /// This method is to get list of offer status details
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get all user ids separeted by , having active user rights to view this users offers</param>
        /// <param name="accountingYearFrom">Get accounting year From</param>
        /// <param name="accountingYearTo">Get accounting year To</param>
        /// <param name="companydetails">Get company details</param>
        /// <returns>List of offer status details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          offers = mgr.GetSelectedUserSalesStatus(byte idCurrency, string idUser, Int64 accountingYear, Company companydetails);
        ///          //SP :- offers_GetSelectedUsersSalesStatus
        ///          //Method :- GetSelectedUsersSalesStatusTargetDashboard(companydetails.ConnectPlantConstr, idCurrency, idUser, accountingYear);
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<Offer> GetSelectedUserSalesStatus(byte idCurrency, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company companydetails, Int32 idCurrentUser = 0)
        {
            IList<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companydetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSalesStatusDateWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 21);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdStatus = Convert.ToInt64(offerreader["OfferStatusId"].ToString());
                        offer.Site = new Company();

                        offer.Site.ConnectPlantId = companydetails.ConnectPlantId;
                        offer.GeosStatus = new GeosStatus { Name = offerreader["OfferStatusName"].ToString(), SalesStatusType = new SalesStatusType { Name = offerreader["Status"].ToString(), IdImage = Convert.ToInt64(offerreader["StatusIdImage"].ToString()) } };
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        if (offerreader["TotalOfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["TotalOfferAmount"].ToString());
                        offer.Currency = new Currency { Name = offerreader["OfferCurrency"].ToString(), Symbol = offerreader["Symbol"].ToString() };
                        offer.Status = offerreader["Status"].ToString();

                        offers.Add(offer);
                    }
                }
            }
            IList<SalesTargetBySite> salesTargetBySites = GetSelectedUsersSalesStatusTargetDashboard(companydetails.ConnectPlantConstr, idCurrency, idUser, accountingYearFrom, accountingYearTo);
            Offer offertarget = new Offer();
            offertarget.Site = new Company();
            offertarget.Site.ConnectPlantId = companydetails.ConnectPlantId;
            offertarget.GeosStatus = new GeosStatus { SalesStatusType = new SalesStatusType { Name = "TARGET", IdImage = 0 } };
            offertarget.Status = "TARGET";
            offertarget.Value = Convert.ToDouble(salesTargetBySites[0].TargetAmount);
            offertarget.Currency = new Currency { Name = salesTargetBySites[0].CurrencyConversion.CurrencyFrom.Name, Symbol = salesTargetBySites[0].CurrencyConversion.CurrencyFrom.Symbol };
            offers.Add(offertarget);

            return offers;
        }







        /// <summary>
        /// This method is to get list of templates
        /// </summary>
        /// <returns>List of templates</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          templates = mgr.GetTemplates();
        ///          //SP :- templates_GetTemplates (using EF CrmContext)
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<Template> GetTemplates()
        {
            IList<Template> templates = null;
            using (var crmContext = new CrmContext())
            {
                templates = crmContext.Templates.SqlQuery("templates_GetTemplates").ToList();
            }
            return templates;
        }

        /// <summary>
        /// [WAREHOUSE-M027-02] Add Pending Work Orders Section
        /// </summary>
        /// <param name="connectionString">The local plant connection string.</param>
        /// <param name="idTemplateType">The Id Template type.</param>
        /// <returns>The list of templates</returns>
        public List<Template> GetTemplatesByIdTemplateType(string connectionString, Int64 idTemplateType)
        {
            List<Template> templates = new List<Template>();

            using (MySqlConnection connTemplates = new MySqlConnection(connectionString))
            {
                connTemplates.Open();

                MySqlCommand templatesCommand = new MySqlCommand("templates_GetTemplatesByIdTemplateType", connTemplates);
                templatesCommand.CommandType = CommandType.StoredProcedure;
                templatesCommand.Parameters.AddWithValue("_IdTemplateType", idTemplateType);

                using (MySqlDataReader poReader = templatesCommand.ExecuteReader())
                {
                    while (poReader.Read())
                    {
                        try
                        {
                            Template template = new Template();

                            template.IdTemplate = Convert.ToByte(poReader["IdTemplate"]);
                            template.Name = Convert.ToString(poReader["Name"]);
                            template.Name_es = Convert.ToString(poReader["Name_es"]);
                            template.Name_fr = Convert.ToString(poReader["Name_fr"]);

                            if (poReader["Suffix"] != DBNull.Value)
                                template.Suffix = Convert.ToString(poReader["Suffix"]);

                            template.Type = Convert.ToInt64(poReader["Type"]);
                            template.Name_ro = Convert.ToString(poReader["Name_ro"]);
                            template.Name_zh = Convert.ToString(poReader["Name_zh"]);
                            template.Name_pt = Convert.ToString(poReader["Name_pt"]);
                            template.Name_ru = Convert.ToString(poReader["Name_ru"]);

                            if (poReader["HtmlColor"] != DBNull.Value)
                                template.HtmlColor = Convert.ToString(poReader["HtmlColor"]);

                            templates.Add(template);
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }
                    }
                }
            }

            return templates;
        }

        public Double GetOfferMaxValue(string connectionstring)
        {
            Double max_value = 0;
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("select * from offer_max_value;", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.Text;
                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    if (lostReasonsByOfferreader.Read())
                    {
                        max_value = Convert.ToDouble(lostReasonsByOfferreader["Max_Value"].ToString());
                    }
                }
            }
            return max_value;
        }

        public List<PlantBusinessUnitSalesQuota> GetPlantBusinessUnitSalesQuotaByUser(string connectionstring, Int32 idUser)
        {
            List<PlantBusinessUnitSalesQuota> plantBusinessUnitSalesQuotas = new List<PlantBusinessUnitSalesQuota>();
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("PlantBusinessUnitSalesQuota_GetPlantBusinessUnitSalesQuotaByUser", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idUser", idUser);
                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    while (lostReasonsByOfferreader.Read())
                    {
                        if (plantBusinessUnitSalesQuotas.Any(pb => pb.ShortName == lostReasonsByOfferreader["ShortName"].ToString()))
                        {
                            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();
                            plantBusinessUnitSalesQuota = plantBusinessUnitSalesQuotas.Where(pb => pb.ShortName == lostReasonsByOfferreader["ShortName"].ToString()).FirstOrDefault();
                            if (lostReasonsByOfferreader["IdPlant"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(lostReasonsByOfferreader["IdPlant"].ToString());
                            if (lostReasonsByOfferreader["IdBusinessUnit"] != DBNull.Value)
                            {
                                plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                LookupValue lv = new LookupValue();
                                lv.IdLookupValue = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                lv.Value = lostReasonsByOfferreader["Value"].ToString();
                                if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                    lv.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                                if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                    lv.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue.Add(lv);
                            }
                            if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                            if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                            plantBusinessUnitSalesQuota.ShortName = lostReasonsByOfferreader["ShortName"].ToString();

                        }
                        else
                        {
                            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();
                            plantBusinessUnitSalesQuota.ShortName = lostReasonsByOfferreader["ShortName"].ToString();
                            if (lostReasonsByOfferreader["IdPlant"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(lostReasonsByOfferreader["IdPlant"].ToString());
                            if (lostReasonsByOfferreader["IdBusinessUnit"] != DBNull.Value)
                            {
                                plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue = new List<LookupValue>();
                                LookupValue lv = new LookupValue();
                                lv.IdLookupValue = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                lv.Value = lostReasonsByOfferreader["Value"].ToString();
                                if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                    lv.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                                if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                    lv.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue.Add(lv);
                            }
                            if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                            if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());

                            plantBusinessUnitSalesQuotas.Add(plantBusinessUnitSalesQuota);
                        }
                    }
                }
            }
            return plantBusinessUnitSalesQuotas;
        }

        //public List<PlantBusinessUnitSalesQuota> GetPlantBUSalesQuotaWithYearByUser(string connectionstring, Int32 idUser,byte idCurrency,Int32 accountingYear)
        //{
        //    List<PlantBusinessUnitSalesQuota> plantBusinessUnitSalesQuotas = new List<PlantBusinessUnitSalesQuota>();
        //    using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
        //    {
        //        conlostReasonsByOffer.Open();
        //        MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("GetPlantBUSalesQuotaWithYearByUser", conlostReasonsByOffer);
        //        conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
        //        conlostReasonsByOffercommand.Parameters.AddWithValue("_idUser", idUser);
        //        conlostReasonsByOffercommand.Parameters.AddWithValue("_idCurrency", idCurrency);
        //        conlostReasonsByOffercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
        //        using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
        //        {
        //            while (lostReasonsByOfferreader.Read())
        //            {
        //                if (plantBusinessUnitSalesQuotas.Any(pb => pb.ShortName == lostReasonsByOfferreader["ShortName"].ToString()))
        //                {
        //                    PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();
        //                    plantBusinessUnitSalesQuota = plantBusinessUnitSalesQuotas.Where(pb => pb.ShortName == lostReasonsByOfferreader["ShortName"].ToString()).FirstOrDefault();
        //                    if (lostReasonsByOfferreader["IdPlant"] != DBNull.Value)
        //                        plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(lostReasonsByOfferreader["IdPlant"].ToString());
        //                    if (lostReasonsByOfferreader["IdBusinessUnit"] != DBNull.Value)
        //                    {
        //                        plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
        //                        LookupValue lv = new LookupValue();
        //                        lv.IdLookupValue = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
        //                        lv.Value = lostReasonsByOfferreader["Value"].ToString();
        //                        if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
        //                            lv.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
        //                        if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
        //                            lv.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
        //                        plantBusinessUnitSalesQuota.LookupValue.Add(lv);
        //                    }
        //                    if (lostReasonsByOfferreader["Year"] != DBNull.Value)
        //                        plantBusinessUnitSalesQuota.Year = Convert.ToInt32(lostReasonsByOfferreader["Year"].ToString());
        //                    if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
        //                        plantBusinessUnitSalesQuota.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
        //                    if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
        //                        plantBusinessUnitSalesQuota.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
        //                    plantBusinessUnitSalesQuota.ShortName = lostReasonsByOfferreader["ShortName"].ToString();

        //                }
        //                else
        //                {
        //                    PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();
        //                    plantBusinessUnitSalesQuota.ShortName = lostReasonsByOfferreader["ShortName"].ToString();
        //                    if (lostReasonsByOfferreader["IdPlant"] != DBNull.Value)
        //                        plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(lostReasonsByOfferreader["IdPlant"].ToString());
        //                    if (lostReasonsByOfferreader["IdBusinessUnit"] != DBNull.Value)
        //                    {
        //                        plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
        //                        plantBusinessUnitSalesQuota.LookupValue = new List<LookupValue>();
        //                        LookupValue lv = new LookupValue();
        //                        lv.IdLookupValue = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
        //                        lv.Value = lostReasonsByOfferreader["Value"].ToString();
        //                        if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
        //                            lv.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
        //                        if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
        //                            lv.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
        //                        plantBusinessUnitSalesQuota.LookupValue.Add(lv);
        //                    }
        //                    if (lostReasonsByOfferreader["Year"] != DBNull.Value)
        //                        plantBusinessUnitSalesQuota.Year = Convert.ToInt32(lostReasonsByOfferreader["Year"].ToString());
        //                    if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
        //                        plantBusinessUnitSalesQuota.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
        //                    if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
        //                        plantBusinessUnitSalesQuota.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());

        //                    plantBusinessUnitSalesQuotas.Add(plantBusinessUnitSalesQuota);
        //                }
        //            }
        //        }
        //    }
        //    return plantBusinessUnitSalesQuotas;
        //}

        public List<PlantBusinessUnitSalesQuota> GetPlantBusinessUnitSalesQuotaBySelectedUsers(string connectionstring, string idUser)
        {
            List<PlantBusinessUnitSalesQuota> plantBusinessUnitSalesQuotas = new List<PlantBusinessUnitSalesQuota>();
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("PlantBusinessUnitSalesQuota_GetPlantSalesQuotaBySelectedUser", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idUser", idUser);
                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    while (lostReasonsByOfferreader.Read())
                    {
                        if (plantBusinessUnitSalesQuotas.Any(pb => pb.ShortName == lostReasonsByOfferreader["ShortName"].ToString()))
                        {
                            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();
                            plantBusinessUnitSalesQuota = plantBusinessUnitSalesQuotas.Where(pb => pb.ShortName == lostReasonsByOfferreader["ShortName"].ToString()).FirstOrDefault();
                            if (lostReasonsByOfferreader["IdPlant"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(lostReasonsByOfferreader["IdPlant"].ToString());
                            if (lostReasonsByOfferreader["IdBusinessUnit"] != DBNull.Value)
                            {
                                plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                LookupValue lv = new LookupValue();
                                lv.IdLookupValue = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                lv.Value = lostReasonsByOfferreader["Value"].ToString();
                                if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                    lv.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                                if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                    lv.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue.Add(lv);
                            }
                            if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                            if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                            plantBusinessUnitSalesQuota.ShortName = lostReasonsByOfferreader["ShortName"].ToString();

                        }
                        else
                        {
                            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();
                            plantBusinessUnitSalesQuota.ShortName = lostReasonsByOfferreader["ShortName"].ToString();
                            if (lostReasonsByOfferreader["IdPlant"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(lostReasonsByOfferreader["IdPlant"].ToString());
                            if (lostReasonsByOfferreader["IdBusinessUnit"] != DBNull.Value)
                            {
                                plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue = new List<LookupValue>();
                                LookupValue lv = new LookupValue();
                                lv.IdLookupValue = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                lv.Value = lostReasonsByOfferreader["Value"].ToString();
                                if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                    lv.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                                if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                    lv.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue.Add(lv);
                            }
                            if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                            if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());

                            plantBusinessUnitSalesQuotas.Add(plantBusinessUnitSalesQuota);
                        }
                    }
                }
            }
            return plantBusinessUnitSalesQuotas;
        }


        public List<PlantBusinessUnitSalesQuota> GetPlantSalesQuotaWithYearByIdUser(string connectionstring, Int32 idUser, byte idCurrency, Int32 accountingYear)
        {
            List<PlantBusinessUnitSalesQuota> plantBusinessUnitSalesQuotas = new List<PlantBusinessUnitSalesQuota>();
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("GetPlantSalesQuotaWithYearByIdUser", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idUser", idUser);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idCurrency", idCurrency);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    while (lostReasonsByOfferreader.Read())
                    {
                        if (plantBusinessUnitSalesQuotas.Any(pb => pb.ShortName == lostReasonsByOfferreader["ShortName"].ToString()))
                        {
                            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();
                            plantBusinessUnitSalesQuota = plantBusinessUnitSalesQuotas.Where(pb => pb.ShortName == lostReasonsByOfferreader["ShortName"].ToString()).FirstOrDefault();
                            if (lostReasonsByOfferreader["IdPlant"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(lostReasonsByOfferreader["IdPlant"].ToString());
                            if (lostReasonsByOfferreader["IdBusinessUnit"] != DBNull.Value)
                            {
                                plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                LookupValue lv = new LookupValue();
                                lv.IdLookupValue = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                lv.Value = lostReasonsByOfferreader["Value"].ToString();
                                if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                    lv.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                                if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                    lv.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue.Add(lv);
                            }
                            if (lostReasonsByOfferreader["Year"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.Year = Convert.ToInt32(lostReasonsByOfferreader["Year"].ToString());
                            if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                            if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                            plantBusinessUnitSalesQuota.ShortName = lostReasonsByOfferreader["ShortName"].ToString();

                        }
                        else
                        {
                            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();
                            plantBusinessUnitSalesQuota.ShortName = lostReasonsByOfferreader["ShortName"].ToString();
                            if (lostReasonsByOfferreader["IdPlant"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(lostReasonsByOfferreader["IdPlant"].ToString());
                            if (lostReasonsByOfferreader["IdBusinessUnit"] != DBNull.Value)
                            {
                                plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue = new List<LookupValue>();
                                LookupValue lv = new LookupValue();
                                lv.IdLookupValue = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                lv.Value = lostReasonsByOfferreader["Value"].ToString();
                                if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                    lv.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                                if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                    lv.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue.Add(lv);
                            }
                            if (lostReasonsByOfferreader["Year"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.Year = Convert.ToInt32(lostReasonsByOfferreader["Year"].ToString());
                            if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                            if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());

                            plantBusinessUnitSalesQuotas.Add(plantBusinessUnitSalesQuota);
                        }
                    }
                }
            }
            return plantBusinessUnitSalesQuotas;
        }

        public PlantBusinessUnitSalesQuota GetTotalPlantQuotaSelectedUserWise(string connectionstring, string assignedPlant, byte idCurrency)
        {
            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuotas = new PlantBusinessUnitSalesQuota();
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("PlantBusinessUnitSalesQuota_GetSalesQuotaAmountByPlant", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_assignedPlant", assignedPlant);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    if (lostReasonsByOfferreader.Read())
                    {
                        if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                            plantBusinessUnitSalesQuotas.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                        if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                            plantBusinessUnitSalesQuotas.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                    }
                }
            }
            return plantBusinessUnitSalesQuotas;
        }

        public SalesUser GetTotalSalesQuotaBySelectedUserId(string connectionstring, string userIds, byte idCurrency)
        {
            SalesUser salesUser = new SalesUser();
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("PlantBusinessUnitSalesQuota_GetSalesQuotaAmountByUserId", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_userId", userIds);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    if (lostReasonsByOfferreader.Read())
                    {
                        if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                            salesUser.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                        if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                            salesUser.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                    }
                }
            }
            return salesUser;
        }


        public PlantBusinessUnitSalesQuota GetTotalPlantQuotaSelectedPlantWiseAndYear(string connectionstring, string assignedPlant, byte idCurrency, Int32 accountingYear, Int32 idCurrentUser = 0)
        {
            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuotas = new PlantBusinessUnitSalesQuota();
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("PlantBusinessUnitSalesQuota_GetSalesQuotaAmountByPlantAndYear", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_assignedPlant", assignedPlant);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    if (lostReasonsByOfferreader.Read())
                    {
                        if (lostReasonsByOfferreader["Year"] != DBNull.Value)
                            plantBusinessUnitSalesQuotas.Year = Convert.ToInt32(lostReasonsByOfferreader["Year"].ToString());
                        if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                            plantBusinessUnitSalesQuotas.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                        if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                            plantBusinessUnitSalesQuotas.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                    }
                }
            }

            return plantBusinessUnitSalesQuotas;
        }

        public PlantBusinessUnitSalesQuota GetTotalPlantQuotaSelectedPlantWiseAndYear(string connectionstring, string assignedPlant, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, Int32 idCurrentUser = 0)
        {
            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuotas = new PlantBusinessUnitSalesQuota();
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("PlantBUSalesQuota_GetSalesQuotaAmountByPlantAndYearDateWise", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_assignedPlant", assignedPlant);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    if (lostReasonsByOfferreader.Read())
                    {
                        if (lostReasonsByOfferreader["Year"] != DBNull.Value)
                            plantBusinessUnitSalesQuotas.Year = Convert.ToInt32(lostReasonsByOfferreader["Year"].ToString());
                        if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                            plantBusinessUnitSalesQuotas.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                        if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                            plantBusinessUnitSalesQuotas.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                    }
                }
            }

            return plantBusinessUnitSalesQuotas;
        }
        public SalesUserQuota GetTotalSalesQuotaBySelectedUserIdAndYear(string connectionstring, string userIds, byte idCurrency, Int32 accountingYear)
        {
            SalesUserQuota salesUser = new SalesUserQuota();
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("SalesUserQuotas_GetSalesQuotaAmountByUserIdAndYear", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_userId", userIds);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_accountingYear", accountingYear);

                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    if (lostReasonsByOfferreader.Read())
                    {
                        if (lostReasonsByOfferreader["Year"] != DBNull.Value)
                            salesUser.Year = Convert.ToInt32(lostReasonsByOfferreader["Year"].ToString());

                        if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                            salesUser.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());

                        if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                            salesUser.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                    }
                }
            }

            return salesUser;
        }
        public SalesUserQuota GetTotalSalesQuotaBySelectedUserIdAndYear(string connectionstring, string userIds, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo)
        {
            SalesUserQuota salesUser = new SalesUserQuota();
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("SalesUserQuotas_GetSalesQuotaAmountByUserIdAndYearDateWise", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_userId", userIds);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    if (lostReasonsByOfferreader.Read())
                    {

                        if (lostReasonsByOfferreader["Year"] != DBNull.Value)
                            salesUser.Year = Convert.ToInt32(lostReasonsByOfferreader["Year"].ToString());

                        if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                            salesUser.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());

                        if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                            salesUser.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                    }
                }
            }

            return salesUser;
        }

        /// <summary>
        /// This method is to get sales staus by week
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          offers = mgr.GetSalesStatusByWeek(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Int32 idUserPermission);
        ///          //SP :- offers_GetSalesStatusByWeek
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public List<Offer> GetSalesStatusByWeek(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Int32 idUserPermission)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionstring))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSalesStatusByWeek", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {

                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdStatus = Convert.ToInt64(offerreader["OfferStatusId"].ToString());
                        offer.CurrentWeek = Convert.ToInt32(offerreader["CurrentWeek"].ToString());
                        offer.GeosStatus = new GeosStatus { Name = offerreader["OfferStatusName"].ToString() };
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        if (offerreader["TotalOfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["TotalOfferAmount"].ToString());
                        offer.Currency = new Currency { Name = offerreader["OfferCurrency"].ToString(), Symbol = offerreader["Symbol"].ToString() };
                        offer.Status = offerreader["Status"].ToString();

                        offers.Add(offer);
                    }
                }
            }
            return offers;
        }

        /// <summary>
        /// This method is to get offer contacts details
        /// </summary>
        /// <param name="idOffer">Get offer id</param>
        /// <param name="connectionstring">Get offer connection string</param>
        /// <param name="offerPlantConnectStr">Get offer plant connection string</param>
        /// <returns>List of offer contacts</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          offerContacts = mgr.GetOfferContact(Int64 idOffer, string connectionstring, string offerPlantConnectStr);
        ///          //SP :- offercontacts_GetOfferContacts
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public List<OfferContact> GetOfferContact(Int64 idOffer, string connectionstring, string offerPlantConnectStr)
        {
            if (offerPlantConnectStr == null)
                offerPlantConnectStr = connectionstring;
            List<OfferContact> offerContacts = new List<OfferContact>();
            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(offerPlantConnectStr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offercontacts_GetOfferContacts", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_IdOffer", idOffer);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        OfferContact offerContact = new OfferContact();
                        offerContact.IdOfferContact = Convert.ToInt64(offerreader["IdOfferContact"].ToString());
                        offerContact.IdContact = Convert.ToInt32(offerreader["IdContact"].ToString());
                        offerContact.IdOffer = Convert.ToInt64(offerreader["IdOffer"].ToString());
                        if (offerreader["IsPrimaryOfferContact"] != DBNull.Value)
                            offerContact.IsPrimaryOfferContact = Convert.ToByte(offerreader["IsPrimaryOfferContact"].ToString());
                        offerContact.People = new People { IdPerson = Convert.ToInt32(offerreader["IdContact"].ToString()), Name = offerreader["Name"].ToString(), Surname = offerreader["Surname"].ToString(), Email = offerreader["Email"].ToString(), Phone = offerreader["Phone"].ToString(), Observations = offerreader["Observations"].ToString() };
                        if (offerreader["IdPersonGender"] != DBNull.Value)
                            offerContact.People.IdPersonGender = Convert.ToByte(offerreader["IdPersonGender"].ToString());

                        if (offerreader["IdCompanyDepartment"] != DBNull.Value)
                        {
                            offerContact.People.IdCompanyDepartment = Convert.ToInt32(offerreader["IdCompanyDepartment"].ToString());
                            offerContact.People.CompanyDepartment = new LookupValue();
                            offerContact.People.CompanyDepartment.IdLookupValue = Convert.ToInt32(offerreader["IdCompanyDepartment"].ToString());
                            offerContact.People.CompanyDepartment.Value = offerreader["Value"].ToString();
                            if (offerreader["IdImage"] != DBNull.Value)
                                offerContact.People.CompanyDepartment.IdImage = Convert.ToInt64(offerreader["IdImage"].ToString());
                            //if (peopleContactreader["InUse"] != DBNull.Value)
                            //    people.CompanyDepartment.InUse = Convert.ToBoolean(peopleContactreader["InUse"].ToString());
                        }
                        offerContact.People.JobTitle = offerreader["JobTitle"].ToString();
                        offerContact.People.ImageText = offerreader["Image"].ToString();

                        offerContacts.Add(offerContact);
                    }
                }
            }
            return offerContacts;
        }

        /// <summary>
        /// This method is to get sales status by month
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="companyDetails">Get company details</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offers = mgr.GetSalesStatusByMonth(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission);
        ///          //SP :- offers_GetSalesStatusByMonth
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public List<Offer> GetSalesStatusByMonth(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSalesStatusByMonth", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdStatus = Convert.ToInt64(offerreader["OfferStatusId"].ToString());
                        offer.CurrentMonth = Convert.ToInt32(offerreader["CurrentMonth"].ToString());
                        offer.GeosStatus = new GeosStatus { Name = offerreader["OfferStatusName"].ToString() };
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());

                        if (offerreader["TotalOfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["TotalOfferAmount"].ToString());

                        offer.Currency = new Currency { Name = offerreader["OfferCurrency"].ToString(), Symbol = offerreader["Symbol"].ToString() };
                        offer.Site = new Company();
                        offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;
                        //offer.Site.ConnectPlantConstr = dictconnectstr.Value;
                        offer.Status = offerreader["Status"].ToString();

                        offers.Add(offer);
                    }
                }
            }
            // }
            return offers;
        }






        /// <summary>
        /// This method is to get sales status by month
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYearFrom">Get accounting year From</param>
        /// <param name="accountingYearTo">Get accounting year To</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offers = mgr.GetSalesStatusByMonth(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission);
        ///          //SP :- offers_GetSalesStatusByMonth
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public List<Offer> GetSalesStatusByMonth(byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, Int32 idUserPermission)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();

                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSalesStatusByMonthDateWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdStatus = Convert.ToInt64(offerreader["OfferStatusId"].ToString());
                        offer.CurrentMonth = Convert.ToInt32(offerreader["CurrentMonth"].ToString());
                        offer.CurrentYear = Convert.ToInt32(offerreader["CurrentYear"].ToString());
                        offer.GeosStatus = new GeosStatus { Name = offerreader["OfferStatusName"].ToString() };
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());

                        if (offerreader["TotalOfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["TotalOfferAmount"].ToString());

                        offer.Currency = new Currency { Name = offerreader["OfferCurrency"].ToString(), Symbol = offerreader["Symbol"].ToString() };
                        offer.Site = new Company();
                        offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;
                        //offer.Site.ConnectPlantConstr = dictconnectstr.Value;
                        offer.Status = offerreader["Status"].ToString();

                        offers.Add(offer);
                    }
                }
            }
            // }
            return offers;
        }






        /// <summary>
        /// This method is to get list of offer status details by month
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get all user ids separeted by , having active user rights to view this users offers</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="companydetails">Get company details</param>
        /// <returns>List of offer status details by month</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offers = mgr.GetSelectedUsersSalesStatusByMonth(byte idCurrency, string idUser, Int64 accountingYear, Company companydetails);
        ///          //SP :- offers_GetSelectedUserSalesStatusByMonth
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public List<Offer> GetSelectedUsersSalesStatusByMonth(byte idCurrency, string idUser, Int64 accountingYear, Company companydetails, Int32 idCurrentUser = 0)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companydetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUserSalesStatusByMonth", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {

                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdStatus = Convert.ToInt64(offerreader["OfferStatusId"].ToString());
                        offer.CurrentMonth = Convert.ToInt32(offerreader["CurrentMonth"].ToString());

                        offer.GeosStatus = new GeosStatus { Name = offerreader["OfferStatusName"].ToString() };
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        if (offerreader["TotalOfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["TotalOfferAmount"].ToString());
                        offer.Currency = new Currency { Name = offerreader["OfferCurrency"].ToString(), Symbol = offerreader["Symbol"].ToString() };
                        offer.Site = new Company();
                        offer.Site.ConnectPlantId = companydetails.ConnectPlantId;
                        //offer.Site.ConnectPlantConstr = dictconnectstr.Value;
                        offer.Status = offerreader["Status"].ToString();

                        offers.Add(offer);
                    }
                }
            }

            return offers;
        }

        /// <summary>
        /// This method is to get list of offer status details by month
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get all user ids separeted by , having active user rights to view this users offers</param>
        /// <param name="accountingYearFrom">Get accounting year From</param>
        /// <param name="accountingYearTo">Get accounting year To</param>
        /// <param name="companydetails">Get company details</param>
        /// <returns>List of offer status details by month</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offers = mgr.GetSelectedUsersSalesStatusByMonth(byte idCurrency, string idUser, Int64 accountingYear, Company companydetails);
        ///          //SP :- offers_GetSelectedUserSalesStatusByMonth
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public List<Offer> GetSelectedUsersSalesStatusByMonth(byte idCurrency, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company companydetails, Int32 idCurrentUser = 0)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companydetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUserSalesStatusByMonthDateWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {

                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdStatus = Convert.ToInt64(offerreader["OfferStatusId"].ToString());
                        offer.CurrentMonth = Convert.ToInt32(offerreader["CurrentMonth"].ToString());
                        offer.CurrentYear = Convert.ToInt32(offerreader["CurrentYear"].ToString());
                        offer.GeosStatus = new GeosStatus { Name = offerreader["OfferStatusName"].ToString() };
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        if (offerreader["TotalOfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["TotalOfferAmount"].ToString());
                        offer.Currency = new Currency { Name = offerreader["OfferCurrency"].ToString(), Symbol = offerreader["Symbol"].ToString() };
                        offer.Site = new Company();
                        offer.Site.ConnectPlantId = companydetails.ConnectPlantId;
                        //offer.Site.ConnectPlantConstr = dictconnectstr.Value;
                        offer.Status = offerreader["Status"].ToString();

                        offers.Add(offer);
                    }
                }
            }

            return offers;
        }



        /// <summary>
        /// This method is to get list of sales target by site
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYear">Get accountingYear</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of sales target by site</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          salesTargetBySites = mgr.GetSalesStatusTargetDashboard(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Int32 idUserPermission);
        ///          //SP :- salestargetbysite_GetSalesStatusTarget
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<SalesTargetBySite> GetSalesStatusTargetDashboard(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Int32 idUserPermission)
        {
            IList<SalesTargetBySite> salesTargetBySites = new List<SalesTargetBySite>();

            using (MySqlConnection consalesTargetBySites = new MySqlConnection(connectionstring))
            {
                consalesTargetBySites.Open();
                MySqlCommand consalesTargetBySitescommand = new MySqlCommand("salestargetbysite_GetSalesStatusTarget", consalesTargetBySites);
                consalesTargetBySitescommand.CommandType = CommandType.StoredProcedure;
                consalesTargetBySitescommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                consalesTargetBySitescommand.Parameters.AddWithValue("_idUser", idUser);
                consalesTargetBySitescommand.Parameters.AddWithValue("_idZone", idZone);
                consalesTargetBySitescommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                consalesTargetBySitescommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader salesTargetBySitesreader = consalesTargetBySitescommand.ExecuteReader())
                {
                    while (salesTargetBySitesreader.Read())
                    {
                        SalesTargetBySite salesTargetBySite = new SalesTargetBySite();
                        if (salesTargetBySitesreader["SalesTarget"] != DBNull.Value)
                            salesTargetBySite.TargetAmount = Convert.ToDecimal(salesTargetBySitesreader["SalesTarget"].ToString());
                        salesTargetBySite.CurrencyConversion = new CurrencyConversion { CurrencyFrom = new Currency { Name = salesTargetBySitesreader["Name"].ToString(), Symbol = salesTargetBySitesreader["Symbol"].ToString() } };
                        salesTargetBySites.Add(salesTargetBySite);
                    }
                }
            }

            return salesTargetBySites;
        }



        /// <summary>
        /// This method is to get list of sales target by site
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYearFrom">Get accounting year From</param>
        /// <param name="accountingYearTo">Get accounting year To</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of sales target by site</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          salesTargetBySites = mgr.GetSalesStatusTargetDashboard(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Int32 idUserPermission);
        ///          //SP :- salestargetbysite_GetSalesStatusTarget
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<SalesTargetBySite> GetSalesStatusTargetDashboard(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Int32 idUserPermission)
        {
            IList<SalesTargetBySite> salesTargetBySites = new List<SalesTargetBySite>();

            using (MySqlConnection consalesTargetBySites = new MySqlConnection(connectionstring))
            {
                consalesTargetBySites.Open();
                MySqlCommand consalesTargetBySitescommand = new MySqlCommand("salestargetbysite_GetSalesStatusTargetDateWise", consalesTargetBySites);
                consalesTargetBySitescommand.CommandType = CommandType.StoredProcedure;
                consalesTargetBySitescommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                consalesTargetBySitescommand.Parameters.AddWithValue("_idUser", idUser);
                consalesTargetBySitescommand.Parameters.AddWithValue("_idZone", idZone);
                consalesTargetBySitescommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                consalesTargetBySitescommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                consalesTargetBySitescommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader salesTargetBySitesreader = consalesTargetBySitescommand.ExecuteReader())
                {
                    while (salesTargetBySitesreader.Read())
                    {
                        SalesTargetBySite salesTargetBySite = new SalesTargetBySite();
                        if (salesTargetBySitesreader["SalesTarget"] != DBNull.Value)
                            salesTargetBySite.TargetAmount = Convert.ToDecimal(salesTargetBySitesreader["SalesTarget"].ToString());
                        salesTargetBySite.CurrencyConversion = new CurrencyConversion { CurrencyFrom = new Currency { Name = salesTargetBySitesreader["Name"].ToString(), Symbol = salesTargetBySitesreader["Symbol"].ToString() } };
                        salesTargetBySites.Add(salesTargetBySite);
                    }
                }
            }

            return salesTargetBySites;
        }

        /// <summary>
        /// This method is to get list of sales target by site
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get idcurrency</param>
        /// <param name="idUser">Get id user</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <returns>List of sales target by site</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          salesTargetBySites = mgr.GetSelectedUsersSalesStatusTargetDashboard(string connectionstring, byte idCurrency, string idUser, Int64 accountingYear);
        ///          //SP :- salestargetbysite_GetSelectedUsersSalesStatusTarget
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<SalesTargetBySite> GetSelectedUsersSalesStatusTargetDashboard(string connectionstring, byte idCurrency, string idUser, Int64 accountingYear)
        {
            IList<SalesTargetBySite> salesTargetBySites = new List<SalesTargetBySite>();

            using (MySqlConnection consalesTargetBySites = new MySqlConnection(connectionstring))
            {
                consalesTargetBySites.Open();
                MySqlCommand consalesTargetBySitescommand = new MySqlCommand("salestargetbysite_GetSelectedUsersSalesStatusTarget", consalesTargetBySites);
                consalesTargetBySitescommand.CommandType = CommandType.StoredProcedure;
                consalesTargetBySitescommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                consalesTargetBySitescommand.Parameters.AddWithValue("_idUser", idUser);
                consalesTargetBySitescommand.Parameters.AddWithValue("_accountingYear", accountingYear);

                using (MySqlDataReader salesTargetBySitesreader = consalesTargetBySitescommand.ExecuteReader())
                {
                    while (salesTargetBySitesreader.Read())
                    {
                        SalesTargetBySite salesTargetBySite = new SalesTargetBySite();
                        if (salesTargetBySitesreader["SalesTarget"] != DBNull.Value)
                            salesTargetBySite.TargetAmount = Convert.ToDecimal(salesTargetBySitesreader["SalesTarget"].ToString());
                        salesTargetBySite.CurrencyConversion = new CurrencyConversion { CurrencyFrom = new Currency { Name = salesTargetBySitesreader["Name"].ToString(), Symbol = salesTargetBySitesreader["Symbol"].ToString() } };
                        salesTargetBySites.Add(salesTargetBySite);
                    }
                }
            }

            return salesTargetBySites;
        }




        /// <summary>
        /// This method is to get list of sales target by site
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get idcurrency</param>
        /// <param name="idUser">Get id user</param>
        /// <param name="accountingYearFrom">Get accounting year From</param>
        /// <param name="accountingYearTo">Get accounting year To</param>
        /// <returns>List of sales target by site</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          salesTargetBySites = mgr.GetSelectedUsersSalesStatusTargetDashboard(string connectionstring, byte idCurrency, string idUser, Int64 accountingYear);
        ///          //SP :- salestargetbysite_GetSelectedUsersSalesStatusTarget
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<SalesTargetBySite> GetSelectedUsersSalesStatusTargetDashboard(string connectionstring, byte idCurrency, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo)
        {
            IList<SalesTargetBySite> salesTargetBySites = new List<SalesTargetBySite>();

            using (MySqlConnection consalesTargetBySites = new MySqlConnection(connectionstring))
            {
                consalesTargetBySites.Open();
                MySqlCommand consalesTargetBySitescommand = new MySqlCommand("salestargetbysite_GetSelectedUsersSalesStatusTargetDateWise", consalesTargetBySites);
                consalesTargetBySitescommand.CommandType = CommandType.StoredProcedure;
                consalesTargetBySitescommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                consalesTargetBySitescommand.Parameters.AddWithValue("_idUser", idUser);
                consalesTargetBySitescommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                consalesTargetBySitescommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                using (MySqlDataReader salesTargetBySitesreader = consalesTargetBySitescommand.ExecuteReader())
                {
                    while (salesTargetBySitesreader.Read())
                    {
                        SalesTargetBySite salesTargetBySite = new SalesTargetBySite();
                        if (salesTargetBySitesreader["SalesTarget"] != DBNull.Value)
                            salesTargetBySite.TargetAmount = Convert.ToDecimal(salesTargetBySitesreader["SalesTarget"].ToString());
                        salesTargetBySite.CurrencyConversion = new CurrencyConversion { CurrencyFrom = new Currency { Name = salesTargetBySitesreader["Name"].ToString(), Symbol = salesTargetBySitesreader["Symbol"].ToString() } };
                        salesTargetBySites.Add(salesTargetBySite);
                    }
                }
            }

            return salesTargetBySites;
        }

        /// <summary>
        /// This method is to get list of currency conversion
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>List of currency conversion</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          currencyConversions = mgr.GetCurrencyConversions(string connectionstring, byte idCurrency, string idUser, Int64 accountingYear);
        ///          //SP :- currencyconversions_GetCurrencyConversions
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<CurrencyConversion> GetCurrencyConversions(string connectionstring)
        {
            IList<CurrencyConversion> currencyConversions = new List<CurrencyConversion>();

            using (MySqlConnection conCurrencyConversion = new MySqlConnection(connectionstring))
            {
                conCurrencyConversion.Open();
                MySqlCommand conCurrencyConversioncommand = new MySqlCommand("currencyconversions_GetCurrencyConversions", conCurrencyConversion);
                conCurrencyConversioncommand.CommandType = CommandType.StoredProcedure;
                using (MySqlDataReader CurrencyConversionreader = conCurrencyConversioncommand.ExecuteReader())
                {
                    while (CurrencyConversionreader.Read())
                    {
                        CurrencyConversion currencyConversion = new CurrencyConversion();
                        currencyConversion.Idcurrencyfrom = Convert.ToByte(CurrencyConversionreader["idcurrencyfrom"].ToString());
                        currencyConversion.Idcurrencyto = Convert.ToByte(CurrencyConversionreader["idcurrencyto"].ToString());
                        currencyConversion.CurrencyFrom = new Currency { Name = CurrencyConversionreader["CurrencyFrom"].ToString() };
                        currencyConversion.CurrencyTo = new Currency { Name = CurrencyConversionreader["CurrencyTo"].ToString() };
                        currencyConversion.ExchangeRate = float.Parse(CurrencyConversionreader["ExchangeRate"].ToString());
                        currencyConversion.LastUpdate = Convert.ToDateTime(CurrencyConversionreader["ModificationDate"].ToString());
                        currencyConversions.Add(currencyConversion);
                    }
                }
            }

            return currencyConversions;
        }

        public IList<Currency> GetCurrencyByExchangeRate(string connectionstring)
        {
            IList<Currency> currencies = new List<Currency>();

            using (MySqlConnection conCurrencyConversion = new MySqlConnection(connectionstring))
            {
                conCurrencyConversion.Open();
                MySqlCommand conCurrencyConversioncommand = new MySqlCommand(" SELECT cur.IdCurrency,cur.Name,cur.Symbol,cur.Description, cur.CodeN, cc.idcurrencyconversion, cc.idcurrencyfrom, cc.idcurrencyto,cc.exchangerate, cc.lastupdate FROM currency cur INNER JOIN currencyconversions cc ON cur.IdCurrency = cc.idcurrencyfrom AND cc.idcurrencyTo = 1 ORDER BY cur.IdCurrency; ", conCurrencyConversion);
                conCurrencyConversioncommand.CommandType = CommandType.Text;
                using (MySqlDataReader CurrencyConversionreader = conCurrencyConversioncommand.ExecuteReader())
                {
                    while (CurrencyConversionreader.Read())
                    {
                        Currency currency = new Currency();
                        currency.CodeN = Convert.ToInt64(CurrencyConversionreader["CodeN"].ToString());
                        currency.Description = CurrencyConversionreader["Description"].ToString();
                        currency.Symbol = CurrencyConversionreader["Symbol"].ToString();
                        currency.Name = CurrencyConversionreader["Name"].ToString();
                        currency.IdCurrency = Convert.ToByte(CurrencyConversionreader["IdCurrency"].ToString());
                        currency.CurrencyConversions = new List<CurrencyConversion>();
                        CurrencyConversion currencyConversion = new CurrencyConversion();
                        currencyConversion.Idcurrencyconversion = Convert.ToInt64(CurrencyConversionreader["idcurrencyconversion"].ToString());
                        currencyConversion.Idcurrencyfrom = Convert.ToByte(CurrencyConversionreader["idcurrencyfrom"].ToString());
                        currencyConversion.Idcurrencyto = Convert.ToByte(CurrencyConversionreader["idcurrencyto"].ToString());
                        currencyConversion.ExchangeRate = float.Parse(CurrencyConversionreader["exchangerate"].ToString());
                        currencyConversion.LastUpdate = Convert.ToDateTime(CurrencyConversionreader["lastupdate"].ToString());
                        currency.CurrencyConversions.Add(currencyConversion);
                        currencies.Add(currency);
                    }
                }
            }

            return currencies;
        }

        /// <summary>
        /// This method is to get people contacts
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <returns>List of people</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          peopleContacts = mgr.GetPeopleContacts(string connectionstring, Int32 idUser, Int32 idZone, Int32 idUserPermission);
        ///          //SP :- people_GetPeopleContacts
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<People> GetPeopleContacts(string connectionstring, Int32 idUser, Int32 idZone, Int32 idUserPermission)
        {
            IList<People> peopleContacts = new List<People>();

            using (MySqlConnection conpeopleContact = new MySqlConnection(connectionstring))
            {
                conpeopleContact.Open();
                MySqlCommand peopleContactcommand = new MySqlCommand("people_GetPeopleContacts", conpeopleContact);
                peopleContactcommand.CommandType = CommandType.StoredProcedure;
                peopleContactcommand.Parameters.AddWithValue("_idUser", idUser);
                peopleContactcommand.Parameters.AddWithValue("_idZone", idZone);
                peopleContactcommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader peopleContactreader = peopleContactcommand.ExecuteReader())
                {
                    while (peopleContactreader.Read())
                    {
                        People people = new People();
                        people.IdPerson = Convert.ToInt32(peopleContactreader["IdContact"].ToString());
                        people.Name = peopleContactreader["FirstName"].ToString();
                        people.Surname = peopleContactreader["LastName"].ToString();
                        people.Email = peopleContactreader["ContactEmail"].ToString();
                        people.Phone = peopleContactreader["ContactPhone"].ToString();
                        people.PeopleType = new PeopleType { Name = peopleContactreader["Department"].ToString() };
                        peopleContacts.Add(people);
                    }
                }
            }

            return peopleContacts;
        }

        /// <summary>
        /// This method is to get list of people
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idSite">Get id site</param>
        /// <returns>List of people</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          peopleContacts = mgr.GetContactsOfSiteByOfferId(string connectionstring, Int32 idSite);
        ///          //SP :- people_GetContactsOfSiteByOfferId
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<People> GetContactsOfSiteByOfferId(string connectionstring, Int32 idSite)
        {
            IList<People> peopleContacts = new List<People>();

            using (MySqlConnection conpeopleContact = new MySqlConnection(connectionstring))
            {
                conpeopleContact.Open();
                MySqlCommand peopleContactcommand = new MySqlCommand("people_GetContactsOfSiteByOfferId", conpeopleContact);
                peopleContactcommand.CommandType = CommandType.StoredProcedure;
                peopleContactcommand.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader peopleContactreader = peopleContactcommand.ExecuteReader())
                {
                    while (peopleContactreader.Read())
                    {
                        People people = new People();
                        people.IdPerson = Convert.ToInt32(peopleContactreader["IdPerson"].ToString());
                        people.Name = peopleContactreader["Name"].ToString();
                        people.Surname = peopleContactreader["Surname"].ToString();
                        people.Email = peopleContactreader["Email"].ToString();
                        people.IsStillActive = Convert.ToByte(peopleContactreader["IsStillActive"].ToString());

                        if (peopleContactreader["IdSite"] != DBNull.Value)
                            people.IdSite = Convert.ToInt32(peopleContactreader["IdSite"].ToString());
                        people.Observations = peopleContactreader["Observations"].ToString();
                        if (peopleContactreader["CreatedIn"] != DBNull.Value)
                            people.CreatedIn = Convert.ToDateTime(peopleContactreader["CreatedIn"].ToString());
                        if (peopleContactreader["DisabledIn"] != DBNull.Value)
                            people.DisabledIn = Convert.ToDateTime(peopleContactreader["DisabledIn"].ToString());
                        if (peopleContactreader["IdPersonGender"] != DBNull.Value)
                            people.IdPersonGender = Convert.ToByte(peopleContactreader["IdPersonGender"].ToString());
                        people.Phone = peopleContactreader["Phone"].ToString();
                        people.PeopleType = new PeopleType { IdPersonType = Convert.ToByte(peopleContactreader["IdPersonType"].ToString()), Name = peopleContactreader["Department"].ToString() };
                        if (peopleContactreader["IdCompanyDepartment"] != DBNull.Value)
                        {
                            people.IdCompanyDepartment = Convert.ToInt32(peopleContactreader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment = new LookupValue();
                            people.CompanyDepartment.IdLookupValue = Convert.ToInt32(peopleContactreader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment.Value = peopleContactreader["Value"].ToString();
                            if (peopleContactreader["IdImage"] != DBNull.Value)
                                people.CompanyDepartment.IdImage = Convert.ToInt64(peopleContactreader["IdImage"].ToString());
                            //if (peopleContactreader["InUse"] != DBNull.Value)
                            //    people.CompanyDepartment.InUse = Convert.ToBoolean(peopleContactreader["InUse"].ToString());
                        }
                        people.JobTitle = peopleContactreader["JobTitle"].ToString();
                        people.ImageText = peopleContactreader["Image"].ToString();

                        peopleContacts.Add(people);
                    }
                }
            }

            return peopleContacts;
        }

        /// <summary>
        /// This method is to get site info
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of companies</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          Companies = mgr.GetSiteInfo(string connectionstring, Int32 idUser, Int32 idZone, Int32 idUserPermission);
        ///          //SP :- sites_GetSiteInfo
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<Company> GetSiteInfo(string connectionstring, Int32 idUser, Int32 idZone, Int32 idUserPermission)
        {
            IList<Company> Companies = new List<Company>();

            using (MySqlConnection conSiteInfo = new MySqlConnection(connectionstring))
            {
                conSiteInfo.Open();
                MySqlCommand SiteInfocommand = new MySqlCommand("sites_GetSiteInfo", conSiteInfo);
                SiteInfocommand.CommandType = CommandType.StoredProcedure;
                SiteInfocommand.Parameters.AddWithValue("_idUser", idUser);
                SiteInfocommand.Parameters.AddWithValue("_idZone", idZone);
                SiteInfocommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader SiteInforeader = SiteInfocommand.ExecuteReader())
                {

                    while (SiteInforeader.Read())
                    {
                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(SiteInforeader["IdSite"].ToString());
                        company.Customers = new List<Customer> { new Customer { CustomerName = SiteInforeader["CustomerGroup"].ToString() } };
                        company.Name = SiteInforeader["CustomerName"].ToString();
                        company.RegisteredName = SiteInforeader["CustomerOfficialName"].ToString();
                        company.CIF = SiteInforeader["CustomerVatNumber"].ToString();
                        company.Country = new Country { Name = SiteInforeader["CustomerCountry"].ToString() };
                        company.Address = SiteInforeader["CustomerAddress"].ToString();
                        company.City = SiteInforeader["CustomerCity"].ToString();
                        company.PostCode = SiteInforeader["CustomerCityZipCode"].ToString();
                        company.Region = SiteInforeader["CustomerRegion"].ToString();
                        company.LocationLatitude = SiteInforeader["LocationLatitude"].ToString();
                        company.LocationLongitude = SiteInforeader["LocationLongitude"].ToString();
                        company.Telephone = SiteInforeader["CustomerPhone"].ToString();
                        company.Fax = SiteInforeader["CustomerFax"].ToString();
                        company.Website = SiteInforeader["CustomerWebsite"].ToString();
                        company.People = new People { Name = SiteInforeader["SalesOwnerFirstName"].ToString(), Surname = SiteInforeader["SalesOwnerLastName"].ToString(), AnnualSalesTargetAmount = SiteInforeader["AnnualSalesTargetAmount"].ToString(), CustomerBusiness = SiteInforeader["CustomerBusiness"].ToString(), AnnualSalesTargetCurrency = SiteInforeader["AnnualSalesTargetCurrency"].ToString(), CustomerSizeInSquareMeters = Convert.ToInt64(SiteInforeader["CustomerSizeInSquareMeters"].ToString()), CustomerNumberOfEmployees = Convert.ToInt64(SiteInforeader["CustomerNumberOfEmployees"].ToString()) };
                        Companies.Add(company);
                    }
                }
            }

            return Companies;
        }

        /// <summary>
        /// This method is to get lookup values
        /// </summary>
        /// <param name="key">Get key</param>
        /// <returns>List of Lookup values</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          list = mgr.GetLookupValues(key); // using EF WorkbenchContext
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<LookupValue> GetLookupValues(byte key)
        {
            IList<LookupValue> list = null;

            using (var context = new WorkbenchContext())
            {
                list = (from records in context.LookupValues where records.IdLookupKey == key select records).OrderBy(y => y.Position).ToList();
            }

            return list;
        }

        /// <summary>
        /// This method is to get all sites details
        /// </summary>
        /// <param name="idUser">Get id user</param>
        /// <param name="connectionString">Get connection string</param>
        /// <returns>Get Dictionary&ltstring, string&gt;</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          Dictionary&lt;string, string&gt; connectionstrings = GetAllSitesDetails(Int32 idUser, string connectionString); 
        ///           SP:-  emdepsites_GetAllPlantsDetails
        ///     }
        /// }
        /// </code>
        /// </example>
        public Dictionary<string, string> GetAllSitesDetails(Int32 idUser, string connectionString)
        {
            Dictionary<string, string> connectionstrings = new Dictionary<string, string>();
            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand command = new MySqlCommand("emdepsites_GetAllPlantsDetails", con);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idUser", idUser);
                List<string> strDatabaseIP = new List<string>();
                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {

                        string connstr = "Data Source = " + reader["DatabaseIP"].ToString() + "; Database = geos; User ID = GeosUsr; Password = GEOS;Convert Zero Datetime=True";
                        if (connectionstrings.Count == 0)
                        {
                            strDatabaseIP.Add(reader["DatabaseIP"].ToString());
                            connectionstrings.Add(reader["idSite"].ToString(), connstr);
                        }
                        if (strDatabaseIP.Exists(cs => cs.ToString() == reader["DatabaseIP"].ToString()))
                        {

                        }
                        else
                        {
                            strDatabaseIP.Add(reader["DatabaseIP"].ToString());
                            connectionstrings.Add(reader["idSite"].ToString(), connstr);
                        }

                    }

                }
            }
            return connectionstrings;
        }

        /// <summary>
        /// This method is to get list of company
        /// </summary>
        /// <param name="idUser">Get iduser</param>
        /// <param name="connectionString">Get connection string</param>
        /// <returns>List of company</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///         connectionstrings = mgr.GetAllCompaniesDetails(Int32 idUser, string connectionString);
        ///           SP:-  emdepsites_GetAllPlantsDetails
        ///     }
        /// }
        /// </code>
        /// </example>
        public List<Company> GetAllCompaniesDetails(Int32 idUser, string connectionString)
        {
            List<Company> connectionstrings = new List<Company>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand command = new MySqlCommand("emdepsites_GetAllPlantsDetails", con);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idUser", idUser);
                List<string> strDatabaseIP = new List<string>();

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Company company = new Company();
                        string connstr = "Data Source = " + reader["DatabaseIP"].ToString() + "; Database = geos; User ID = GeosUsr; Password = GEOS;Convert Zero Datetime=True";
                        if (connectionstrings.Count == 0)
                        {
                            strDatabaseIP.Add(reader["DatabaseIP"].ToString());
                            company.IdCompany = Convert.ToInt32(reader["idSite"].ToString());
                            company.Alias = reader["ShortName"].ToString();
                            company.ShortName = reader["ShortName"].ToString();
                            company.Name = reader["Name"].ToString();
                            company.ConnectPlantId = reader["idSite"].ToString();
                            company.ConnectPlantConstr = connstr;
                            company.Country = new Country();
                            company.Country.IdCountry = Convert.ToByte(reader["idCountry"].ToString());
                            company.Country.Name = reader["name"].ToString();
                            connectionstrings.Add(company);
                        }

                        if (strDatabaseIP.Exists(cs => cs.ToString() == reader["DatabaseIP"].ToString()))
                        {
                        }
                        else
                        {
                            strDatabaseIP.Add(reader["DatabaseIP"].ToString());
                            company.IdCompany = Convert.ToInt32(reader["idSite"].ToString());
                            company.Alias = reader["ShortName"].ToString();
                            company.ShortName = reader["ShortName"].ToString();
                            company.Name = reader["Name"].ToString();
                            company.Country = new Country();
                            company.Country.IdCountry = Convert.ToByte(reader["idCountry"].ToString());
                            company.Country.Name = reader["name"].ToString();
                            company.ConnectPlantId = reader["idSite"].ToString();
                            company.ConnectPlantConstr = connstr;
                            connectionstrings.Add(company);
                        }

                    }

                }
            }

            return connectionstrings;
        }

        /// <summary>
        /// This method is to get all sites details by id
        /// </summary>
        /// <param name="idUser">Get id user</param>
        /// <param name="idSite">Get id site</param>
        /// <param name="connectionString">Get connection string</param>
        /// <returns>Get dictionary</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          connectionstrings = mgr.GetAllSitesDetailsById(Int32 idUser, Int32 idSite, string connectionString);
        ///           SP :-  emdepsites_GetAllPlantsDetailsById
        ///     }
        /// }
        /// </code>
        /// </example>
        private Dictionary<string, string> GetAllSitesDetailsById(Int32 idUser, Int32 idSite, string connectionString)
        {
            Dictionary<string, string> connectionstrings = new Dictionary<string, string>();
            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand command = new MySqlCommand("emdepsites_GetAllPlantsDetailsById", con);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idUser", idUser);
                command.Parameters.AddWithValue("_idSite", idSite);
                List<string> strDatabaseIP = new List<string>();
                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        string connstr = "Data Source = " + reader["DatabaseIP"].ToString() + "; Database = geos; User ID = GeosUsr; Password = GEOS;Convert Zero Datetime=True";
                        strDatabaseIP.Add(reader["DatabaseIP"].ToString());
                        connectionstrings.Add(reader["idSite"].ToString(), connstr);
                    }
                }
            }
            return connectionstrings;
        }


        /// <summary>
        /// This method is to get current site id
        /// </summary>
        /// <param name="idUser">Get id user</param>
        /// <param name="connectionString">Get connection string</param>
        /// <returns>Company details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          site = mgr.GetCurrentSiteId(Int32 idUser,connectionString);
        ///          SP :-  emdepsites_GetAllPlantsDetails
        ///     }
        /// }
        /// </code>
        /// </example>
        private Company GetCurrentSiteId(Int32 idUser, string connectionString)
        {
            Company site = new Company();
            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand command = new MySqlCommand("emdepsites_GetAllPlantsDetails", con);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idUser", idUser);

                List<string> strDatabaseIP = new List<string>();
                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        string connstr = "Data Source = " + reader["DatabaseIP"].ToString() + "; Database = geos; User ID = GeosUsr; Password = GEOS;Convert Zero Datetime=True";
                        string[] getconnstr = connstr.Split(';');
                        string[] currentconnstr = connectionString.Split(';');
                        string[] getconnstrip = getconnstr[0].Split('=');
                        string[] currentconnstrip = currentconnstr[0].Split('=');
                        if (getconnstrip[1].Trim() == currentconnstrip[1].Trim())
                        {
                            site.ConnectPlantId = reader["idSite"].ToString();
                            site.ConnectPlantConstr = connectionString;
                            break;
                        }
                    }
                }
            }
            return site;
        }

        public DataSet GetOffersWithoutPurchaseOrderReturnListDatatable1(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company compdetails, Int32 idUserPermission)
        {
            DataSet offerOptions = new DataSet("offerOptions");

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOffersWithoutPurchaseOrder", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
                //DataSet ds = new DataSet();
                da.Fill(offerOptions);
            }
            //using (MySqlConnection conoptionsbyoffer = new MySqlConnection(companydetails.ConnectPlantConstr))
            //{
            //    conoptionsbyoffer.Open();
            //    MySqlCommand conoptionsbyoffercommand = new MySqlCommand("optionsbyoffer_GetAllOptionsByOfferId", conoptionsbyoffer);
            //    conoptionsbyoffercommand.CommandType = CommandType.StoredProcedure;
            //    conoptionsbyoffercommand.Parameters.AddWithValue("_idUser", idUser);
            //    conoptionsbyoffercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
            //    conoptionsbyoffercommand.Parameters.AddWithValue("_idZone", idZone);
            //    conoptionsbyoffercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
            //    conoptionsbyoffercommand.Parameters.AddWithValue("_connectPlantId", companydetails.ConnectPlantId);

            //    using (MySqlDataAdapter returnVal = new MySqlDataAdapter(conoptionsbyoffercommand))
            //    {
            //        returnVal.Fill(offerOptions, "OptionsByOffers");
            //        //OptionsByOffers.Columns.Add("ConnectPlant");
            //        //OptionsByOffers.Columns["ConnectPlant"].Expression = companydetails.ConnectPlantId;
            //        //OptionsByOffers.RemotingFormat = SerializationFormat.Xml;
            //        //OptionsByOffers.AcceptChanges();
            //        //conoptionsbyoffer.Close();
            //    }
            //}
            //offerOptions.Tables.Add(offers);
            //offerOptions.Tables.Add(OptionsByOffers);
            //XmlDocument xmlDoc = new XmlDocument();
            //string offerOptionsxml = offerOptions.GetXml();
            //xmlDoc.LoadXml(offerOptionsxml);
            //offerOptions.RemotingFormat = SerializationFormat.Xml;
            offerOptions.AcceptChanges();
            // string json = JsonConvert.SerializeObject(offerOptions, Newtonsoft.Json.Formatting.Indented);
            return offerOptions;
        }

        /// <summary>
        /// This method is to get offer details
        /// </summary>
        /// <param name="idCurrency">Get idcurrency</param>
        /// <param name="idUser">Get iduser</param>
        /// <param name="idZone">Get idzone</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="compdetails">Get company details</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>Get offer details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          offersOptionsList = = GetOffersWithoutPurchaseOrderReturnListDatatable(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company compdetails, Int32 idUserPermission);
        ///          SP :-  offers_GetOffersWithoutPurchaseOrder
        ///     }
        /// }
        /// </code>
        /// </example>
        public OffersOptionsList GetOffersWithoutPurchaseOrderReturnListDatatable(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company compdetails, Int32 idUserPermission)
        {
            OffersOptionsList offersOptionsList = new OffersOptionsList();
            offersOptionsList.Offers = new List<Offer>();
            offersOptionsList.OptionsByOffers = new List<OptionsByOffer>();
            //DataSet ds = new DataSet();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOffersWithoutPurchaseOrder", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idEmdepSite", compdetails.ConnectPlantId);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
                //DataSet ds = new DataSet();
                //da.Fill(ds);

                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            Offer offer = new Offer();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());
                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }
                            offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());
                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };
                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());
                            }
                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());
                            }
                            offer.Site.ConnectPlantId = compdetails.ConnectPlantId;

                            offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };
                            offer.Site.Country = new Country { Name = itemRow["CustomerCountry"].ToString(), Zone = new Zone { Name = itemRow["CustomerZone"].ToString() } };
                            offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(itemRow["OfferStatusid"].ToString()), Name = itemRow["OfferStatus"].ToString(), HtmlColor = itemRow["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["SalesStatusType"].ToString(), HtmlColor = itemRow["SalesStatusTypeColor"].ToString() } };
                            offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            offer.Currency = new Currency { IdCurrency = Convert.ToByte(itemRow["IdCurrency"].ToString()), Name = itemRow["OfferCurrency"].ToString() };
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                                offer.DeliveryDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString());
                            else
                                offer.DeliveryDate = null;

                            if (itemRow["Rfq"] != DBNull.Value)
                                offer.Rfq = itemRow["Rfq"].ToString();

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RFQReception = Convert.ToDateTime(itemRow["RFQReception"].ToString());
                            else
                                offer.RFQReception = null;

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.SendIn = Convert.ToDateTime(itemRow["SendIn"].ToString());
                            else
                                offer.SendIn = null;

                            if (itemRow["IdSource"] != DBNull.Value)
                            {
                                offer.IdSource = Convert.ToByte(itemRow["IdSource"].ToString());
                                offer.Source = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdSource"].ToString()), Value = itemRow["Source"].ToString() };
                            }

                            if (itemRow["IdBusinessUnit"] != DBNull.Value)
                            {
                                offer.IdBusinessUnit = Convert.ToByte(itemRow["IdBusinessUnit"].ToString());
                                offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdBusinessUnit"].ToString()), Value = itemRow["BusinessUnit"].ToString() };
                            }

                            if (itemRow["IdProject"] != DBNull.Value)
                            {
                                offer.IdProject = Convert.ToInt32(itemRow["IdProject"].ToString());
                                offer.Projects = new List<Project>();
                                Project project = new Project();
                                project.IdProject = Convert.ToInt32(itemRow["IdProject"].ToString());
                                project.ProjectCode = itemRow["Code"].ToString();
                                project.ProjectName = itemRow["Title"].ToString();
                                offer.Projects.Add(project);
                            }

                            if (itemRow["IdCarProject"] != DBNull.Value)
                            {
                                offer.IdCarProject = Convert.ToInt64(itemRow["IdCarProject"].ToString());
                                offer.CarProject = new CarProject();

                                offer.CarProject.IdCarProject = Convert.ToInt32(itemRow["IdCarProject"].ToString());
                                offer.CarProject.Name = itemRow["CarProjectName"].ToString();
                            }

                            if (itemRow["IdCarOEM"] != DBNull.Value)
                            {
                                offer.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM = new CarOEM();
                                offer.CarOEM.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM.Name = itemRow["CarOEM"].ToString();
                            }

                            if (offer.GeosStatus != null && offer.GeosStatus.IdOfferStatusType == 1)
                            {
                                ////If some comment or some activity exists then Last activity date= latest comment or activity date
                                ///// To get last activity date = latest comment date.
                                //List<LogEntryByOffer> ListLogComments = GetAllCommentsByIdOffer(offer.IdOffer, compdetails.ConnectPlantConstr).ToList();
                                //if (ListLogComments.Count > 0)
                                //{
                                //    int result = Nullable.Compare<DateTime>(ListLogComments[0].DateTime, offer.LastActivityDate);

                                //    if (result > 0)
                                //        offer.LastActivityDate = ListLogComments[0].DateTime;
                                //}

                                ///// To get Last activity date= latest activity creation date.
                                //List<Activity> activities = GetActivitiesByIdOffer(offer.IdOffer, Convert.ToInt32(compdetails.ConnectPlantId), compdetails.ConnectPlantConstr).OrderByDescending(x => x.CreatedIn).ToList();
                                //if (activities.Count > 0)
                                //{
                                //    var activityDate = activities.Max(x => x.CreatedIn);
                                //    int result = Nullable.Compare<DateTime>(activityDate, offer.LastActivityDate);

                                //    if (result > 0)
                                //        offer.LastActivityDate = activityDate;
                                //}

                                ////If no comments and no linked activities then Last_activity_date= quote sent date
                                //if (ListLogComments.Count == 0 && activities.Count == 0)
                                //{
                                //    offer.LastActivityDate = offer.SendIn;
                                //}

                                if (itemRow["CommentLastUpdate"] != DBNull.Value)
                                {
                                    offer.LastActivityDate = Convert.ToDateTime(itemRow["CommentLastUpdate"]);
                                }

                                if (itemRow["ActivityLastUpdate"] != DBNull.Value)
                                {
                                    if (offer.LastActivityDate == null)
                                    {
                                        offer.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"]);
                                    }
                                    else
                                    {
                                        int result = Nullable.Compare<DateTime>(Convert.ToDateTime(itemRow["ActivityLastUpdate"]), offer.LastActivityDate);
                                        if (result > 0)
                                            offer.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"]);
                                    }
                                }

                                if (offer.LastActivityDate == null)
                                {
                                    offer.LastActivityDate = offer.SendIn;
                                }
                            }

                            offer.OptionsByOffers = new List<OptionsByOffer>();
                            offersOptionsList.Offers.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            OptionsByOffer optionsbyoffer = new OptionsByOffer();
                            optionsbyoffer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsbyoffer.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsbyoffer.IdOfferPlant = Convert.ToInt32(compdetails.ConnectPlantId);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsbyoffer.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsbyoffer.Quantity > 0)
                                    optionsbyoffer.IsSelected = true;
                                else
                                    optionsbyoffer.IsSelected = false;
                            }
                            else
                            {
                                optionsbyoffer.IsSelected = false;
                            }
                            optionsbyoffer.OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(itemRow["IdOption"].ToString()), Name = itemRow["offeroption"].ToString(), OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(itemRow["IdOfferOptionType"].ToString()), Name = itemRow["offeroptiontype"].ToString() } };

                            offersOptionsList.OptionsByOffers.Add(optionsbyoffer);
                        }
                    }
                }
            }

            return offersOptionsList;
        }



        /// <summary>
        /// This method is to get offer details
        /// </summary>
        /// <param name="idCurrency">Get idcurrency</param>
        /// <param name="idUser">Get iduser</param>
        /// <param name="idZone">Get idzone</param>
        /// <param name="AccountingYearFrom">Get accounting year From</param>
        /// <param name="AccountingYearTo">Get accounting year To</param>
        /// <param name="compdetails">Get company details</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>Get offer details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          offersOptionsList = = GetOffersWithoutPurchaseOrderReturnListDatatable(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company compdetails, Int32 idUserPermission);
        ///          SP :-  offers_GetOffersWithoutPurchaseOrder
        ///     }
        /// }
        /// </code>
        /// </example>
        public OffersOptionsList GetOffersWithoutPurchaseOrderReturnListDatatable(byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Company compdetails, Int32 idUserPermission)
        {
            OffersOptionsList offersOptionsList = new OffersOptionsList();
            offersOptionsList.Offers = new List<Offer>();
            offersOptionsList.OptionsByOffers = new List<OptionsByOffer>();
            offersOptionsList.LostReasonsByOffers = new List<LostReasonsByOffer>();
            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOffersWithoutPurchaseOrderDateWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idEmdepSite", compdetails.ConnectPlantId);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);


                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            Offer offer = new Offer();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());
                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }
                            offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());
                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };
                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());
                            }
                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());
                            }
                            offer.Site.ConnectPlantId = compdetails.ConnectPlantId;

                            offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };
                            offer.Site.Country = new Country { Name = itemRow["CustomerCountry"].ToString(), Zone = new Zone { Name = itemRow["CustomerZone"].ToString() } };
                            offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(itemRow["OfferStatusid"].ToString()), Name = itemRow["OfferStatus"].ToString(), HtmlColor = itemRow["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["SalesStatusType"].ToString(), HtmlColor = itemRow["SalesStatusTypeColor"].ToString() } };
                            offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            offer.Currency = new Currency { IdCurrency = Convert.ToByte(itemRow["IdCurrency"].ToString()), Name = itemRow["OfferCurrency"].ToString() };
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                                offer.DeliveryDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString());
                            else
                                offer.DeliveryDate = null;

                            if (itemRow["Rfq"] != DBNull.Value)
                                offer.Rfq = itemRow["Rfq"].ToString();

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RFQReception = Convert.ToDateTime(itemRow["RFQReception"].ToString());
                            else
                                offer.RFQReception = null;

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.SendIn = Convert.ToDateTime(itemRow["SendIn"].ToString());
                            else
                                offer.SendIn = null;

                            if (itemRow["IdSource"] != DBNull.Value)
                            {
                                offer.IdSource = Convert.ToByte(itemRow["IdSource"].ToString());
                                offer.Source = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdSource"].ToString()), Value = itemRow["Source"].ToString() };
                            }

                            if (itemRow["IdBusinessUnit"] != DBNull.Value)
                            {
                                offer.IdBusinessUnit = Convert.ToByte(itemRow["IdBusinessUnit"].ToString());
                                offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdBusinessUnit"].ToString()), Value = itemRow["BusinessUnit"].ToString() };
                            }

                            if (itemRow["IdProject"] != DBNull.Value)
                            {
                                offer.IdProject = Convert.ToInt32(itemRow["IdProject"].ToString());
                                offer.Projects = new List<Project>();
                                Project project = new Project();
                                project.IdProject = Convert.ToInt32(itemRow["IdProject"].ToString());
                                project.ProjectCode = itemRow["Code"].ToString();
                                project.ProjectName = itemRow["Title"].ToString();
                                offer.Projects.Add(project);
                            }

                            if (itemRow["IdCarProject"] != DBNull.Value)
                            {
                                offer.IdCarProject = Convert.ToInt64(itemRow["IdCarProject"].ToString());
                                offer.CarProject = new CarProject();

                                offer.CarProject.IdCarProject = Convert.ToInt32(itemRow["IdCarProject"].ToString());
                                offer.CarProject.Name = itemRow["CarProjectName"].ToString();
                            }

                            if (itemRow["IdCarOEM"] != DBNull.Value)
                            {
                                offer.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM = new CarOEM();
                                offer.CarOEM.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM.Name = itemRow["CarOEM"].ToString();
                            }

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                offer.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory = new ProductCategory();
                                offer.ProductCategory.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory.Name = itemRow["ProductSubCategory"].ToString();

                                if (itemRow["IdCategory"] != DBNull.Value)
                                {
                                    offer.ProductCategory.IdParent = Convert.ToInt64(itemRow["IdCategory"].ToString());
                                    offer.ProductCategory.Category = new ProductCategory();
                                    offer.ProductCategory.Category.IdProductCategory = Convert.ToInt64(itemRow["IdCategory"].ToString());
                                    offer.ProductCategory.Category.Name = itemRow["Category"].ToString();
                                }
                            }

                            if (offer.GeosStatus != null && offer.GeosStatus.IdOfferStatusType == 1)
                            {
                                if (itemRow["CommentLastUpdate"] != DBNull.Value)
                                {
                                    offer.LastActivityDate = Convert.ToDateTime(itemRow["CommentLastUpdate"]);
                                }

                                if (itemRow["ActivityLastUpdate"] != DBNull.Value)
                                {
                                    if (offer.LastActivityDate == null)
                                    {
                                        offer.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"]);
                                    }
                                    else
                                    {
                                        int result = Nullable.Compare<DateTime>(Convert.ToDateTime(itemRow["ActivityLastUpdate"]), offer.LastActivityDate);
                                        if (result > 0)
                                            offer.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"]);
                                    }
                                }

                                if (offer.LastActivityDate == null)
                                {
                                    offer.LastActivityDate = offer.SendIn;
                                }
                            }

                            offer.OptionsByOffers = new List<OptionsByOffer>();
                            offer.LostReasonsByOffers = new List<LostReasonsByOffer>();
                            offersOptionsList.Offers.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            OptionsByOffer optionsbyoffer = new OptionsByOffer();
                            optionsbyoffer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsbyoffer.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsbyoffer.IdOfferPlant = Convert.ToInt32(compdetails.ConnectPlantId);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsbyoffer.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsbyoffer.Quantity > 0)
                                    optionsbyoffer.IsSelected = true;
                                else
                                    optionsbyoffer.IsSelected = false;
                            }
                            else
                            {
                                optionsbyoffer.IsSelected = false;
                            }
                            optionsbyoffer.OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(itemRow["IdOption"].ToString()), Name = itemRow["offeroption"].ToString(), OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(itemRow["IdOfferOptionType"].ToString()), Name = itemRow["offeroptiontype"].ToString() } };

                            offersOptionsList.OptionsByOffers.Add(optionsbyoffer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            LostReasonsByOffer lostReasonsByOffer = new LostReasonsByOffer();
                            if (itemRow["IdOffer"] != DBNull.Value)
                                lostReasonsByOffer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            lostReasonsByOffer.Comments = itemRow["Comments"].ToString();
                            lostReasonsByOffer.Competitor = new Competitor();
                            lostReasonsByOffer.Competitor.Name = itemRow["Name"].ToString();
                            lostReasonsByOffer.OfferLostReason = new OfferLostReason();
                            lostReasonsByOffer.OfferLostReason.Name = itemRow["Reason"].ToString();
                            lostReasonsByOffer.IdOfferPlant = Convert.ToInt32(compdetails.ConnectPlantId);

                            offersOptionsList.LostReasonsByOffers.Add(lostReasonsByOffer);
                        }
                    }


                }
            }

            return offersOptionsList;
        }






        /// <summary>
        /// This method is to get list of company
        /// </summary>
        /// <param name="connectionString">Get connection string</param>
        /// <param name="accountingFromYear">Get accounting from year</param>
        /// <param name="accountingToYear">Get accounting to year</param>
        /// <returns>List of company</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          companies = = mgr.GetSalesTargetByPlantQuotas(string connectionString, Int64 accountingFromYear, Int64 accountingToYear);
        ///          QUERY :-  "SELECT emsi.IdSite,st.Year,st.IdCurrency,st.TargetAmount,si.ShortName FROM emdepsites emsi LEFT JOIN salestargetbysite st ON st.IdSite = emsi.idSite AND (st.Year BETWEEN " + accountingFromYear + " AND " + accountingToYear + ") INNER JOIN sites si ON si.IdSite = emsi.IdSite;"
        ///     }
        /// }
        /// </code>
        /// </example>
        public List<Company> GetSalesTargetByPlantQuotas(string connectionString, Int64 accountingFromYear, Int64 accountingToYear)
        {
            List<Company> companies = new List<Company>();
            DataTable dt = new DataTable();
            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("salestargetbysite_GetSalesTargetByPlantQuotas", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingToYear", accountingToYear);
                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
                //DataSet ds = new DataSet();
                da.Fill(dt);
                foreach (DataRow item in dt.Rows)
                {
                    if (companies.Any(co => co.IdCompany == Convert.ToInt32(item["IdSite"].ToString())))
                    {
                        Company company = companies.Where(co => co.IdCompany == Convert.ToInt32(item["IdSite"].ToString())).FirstOrDefault();
                        if (item["Year"] != DBNull.Value && item["TargetAmount"] != DBNull.Value)
                        {
                            company.SalesTargetBySite = new SalesTargetBySite();
                            company.SalesTargetBySite.IdSite = Convert.ToInt32(item["IdSite"].ToString());
                            company.SalesTargetBySite.Year = Convert.ToInt32(item["Year"].ToString());
                            company.SalesTargetBySite.IdCurrency = Convert.ToByte(item["IdCurrency"].ToString());
                            company.SalesTargetBySite.TargetAmount = Convert.ToDecimal(item["TargetAmount"].ToString());
                            company.SalesTargetBySiteLst.Add(company.SalesTargetBySite);
                        }
                    }
                    else
                    {
                        Company company = new Company();
                        company.ShortName = item["ShortName"].ToString();
                        company.IdCompany = Convert.ToInt32(item["IdSite"].ToString());
                        company.SalesTargetBySiteLst = new List<SalesTargetBySite>();
                        if (item["Year"] != DBNull.Value && item["TargetAmount"] != DBNull.Value)
                        {
                            company.SalesTargetBySite = new SalesTargetBySite();
                            company.SalesTargetBySite.IdSite = Convert.ToInt32(item["IdSite"].ToString());
                            company.SalesTargetBySite.Year = Convert.ToInt32(item["Year"].ToString());
                            company.SalesTargetBySite.IdCurrency = Convert.ToByte(item["IdCurrency"].ToString());
                            company.SalesTargetBySite.TargetAmount = Convert.ToDecimal(item["TargetAmount"].ToString());
                            company.SalesTargetBySiteLst.Add(company.SalesTargetBySite);
                        }
                        companies.Add(company);

                    }

                }
            }
            return companies;
        }


        /// <summary>
        /// This method is to get Offer details
        /// </summary>
        /// <param name="idCurrency">Get idCurrency</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="compdetails">Get company details</param>
        /// <returns>offer details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          OffersOptionsList = = mgr.GetSelectedUsersOffersWithoutPurchaseOrderReturnListDatatable(byte idCurrency, string idUser, Int64 accountingYear, Company compdetails);
        ///          SP :-  offers_GetSelectedUsersOffersWithoutPurchaseOrder
        ///     }
        /// }
        /// </code>
        /// </example>
        public OffersOptionsList GetSelectedUsersOffersWithoutPurchaseOrderReturnListDatatable(byte idCurrency, string idUser, Int64 accountingYear, Company compdetails, Int32 idCurrentUser = 0)
        {
            OffersOptionsList OffersOptionsList = new OffersOptionsList();
            OffersOptionsList.Offers = new List<Offer>();
            OffersOptionsList.OptionsByOffers = new List<OptionsByOffer>();
            //DataSet ds = new DataSet();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUsersOffersWithoutPurchaseOrder", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idEmdepSite", compdetails.ConnectPlantId);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
                //DataSet ds = new DataSet();
                //da.Fill(ds);

                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            Offer offer = new Offer();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());
                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());
                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());
                            }

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());
                            }

                            offer.Site.ConnectPlantId = compdetails.ConnectPlantId;

                            offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };

                            offer.Site.Country = new Country { Name = itemRow["CustomerCountry"].ToString(), Zone = new Zone { Name = itemRow["CustomerZone"].ToString() } };

                            offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(itemRow["OfferStatusid"].ToString()), Name = itemRow["OfferStatus"].ToString(), HtmlColor = itemRow["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["SalesStatusType"].ToString(), HtmlColor = itemRow["SalesStatusTypeColor"].ToString() } };

                            offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            offer.Currency = new Currency { IdCurrency = Convert.ToByte(itemRow["IdCurrency"].ToString()), Name = itemRow["OfferCurrency"].ToString() };

                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                                offer.DeliveryDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString());
                            else
                                offer.DeliveryDate = null;

                            if (itemRow["Rfq"] != DBNull.Value)
                                offer.Rfq = itemRow["Rfq"].ToString();

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RFQReception = Convert.ToDateTime(itemRow["RFQReception"].ToString());
                            else
                                offer.RFQReception = null;

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.SendIn = Convert.ToDateTime(itemRow["SendIn"].ToString());
                            else
                                offer.SendIn = null;

                            if (itemRow["IdSource"] != DBNull.Value)
                            {
                                offer.IdSource = Convert.ToByte(itemRow["IdSource"].ToString());
                                offer.Source = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdSource"].ToString()), Value = itemRow["Source"].ToString() };
                            }

                            if (itemRow["IdBusinessUnit"] != DBNull.Value)
                            {
                                offer.IdBusinessUnit = Convert.ToByte(itemRow["IdBusinessUnit"].ToString());
                                offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdBusinessUnit"].ToString()), Value = itemRow["BusinessUnit"].ToString() };
                            }

                            if (itemRow["IdProject"] != DBNull.Value)
                            {
                                offer.IdProject = Convert.ToInt32(itemRow["IdProject"].ToString());
                                offer.Projects = new List<Project>();
                                Project project = new Project();
                                project.IdProject = Convert.ToInt32(itemRow["IdProject"].ToString());
                                project.ProjectCode = itemRow["Code"].ToString();
                                project.ProjectName = itemRow["Title"].ToString();
                                offer.Projects.Add(project);
                            }

                            if (itemRow["IdCarProject"] != DBNull.Value)
                            {
                                offer.IdCarProject = Convert.ToInt64(itemRow["IdCarProject"].ToString());
                                offer.CarProject = new CarProject();

                                offer.CarProject.IdCarProject = Convert.ToInt32(itemRow["IdCarProject"].ToString());
                                offer.CarProject.Name = itemRow["CarProjectName"].ToString();

                            }

                            if (itemRow["IdCarOEM"] != DBNull.Value)
                            {
                                offer.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM = new CarOEM();
                                offer.CarOEM.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM.Name = itemRow["CarOEM"].ToString();
                            }

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                offer.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory = new ProductCategory();
                                offer.ProductCategory.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory.Name = itemRow["ProductSubCategory"].ToString();

                                if (itemRow["IdCategory"] != DBNull.Value)
                                {
                                    offer.ProductCategory.IdParent = Convert.ToInt64(itemRow["IdCategory"].ToString());
                                    offer.ProductCategory.Category = new ProductCategory();
                                    offer.ProductCategory.Category.IdProductCategory = Convert.ToInt64(itemRow["IdCategory"].ToString());
                                    offer.ProductCategory.Category.Name = itemRow["Category"].ToString();
                                }
                            }

                            if (offer.GeosStatus != null && offer.GeosStatus.IdOfferStatusType == 1)
                            {
                                ////If some comment or some activity exists then Last activity date= latest comment or activity date
                                ///// To get last activity date = latest comment date.
                                //List<LogEntryByOffer> ListLogComments = GetAllCommentsByIdOffer(offer.IdOffer, compdetails.ConnectPlantConstr).ToList();
                                //if (ListLogComments.Count > 0)
                                //{
                                //    int result = Nullable.Compare<DateTime>(ListLogComments[0].DateTime, offer.LastActivityDate);

                                //    if (result > 0)
                                //        offer.LastActivityDate = ListLogComments[0].DateTime;
                                //}

                                ///// To get Last activity date= latest activity creation date.
                                //List<Activity> activities = GetActivitiesByIdOffer(offer.IdOffer, Convert.ToInt32(compdetails.ConnectPlantId), compdetails.ConnectPlantConstr).OrderByDescending(x => x.CreatedIn).ToList();
                                //if (activities.Count > 0)
                                //{
                                //    var activityDate = activities.Max(x => x.CreatedIn);
                                //    int result = Nullable.Compare<DateTime>(activityDate, offer.LastActivityDate);

                                //    if (result > 0)
                                //        offer.LastActivityDate = activityDate;
                                //}

                                ////If no comments and no linked activities then Last_activity_date= quote sent date
                                //if (ListLogComments.Count == 0 && activities.Count == 0)
                                //{
                                //    offer.LastActivityDate = offer.SendIn;
                                //}

                                if (itemRow["CommentLastUpdate"] != DBNull.Value)
                                {
                                    offer.LastActivityDate = Convert.ToDateTime(itemRow["CommentLastUpdate"]);
                                }

                                if (itemRow["ActivityLastUpdate"] != DBNull.Value)
                                {
                                    if (offer.LastActivityDate == null)
                                    {
                                        offer.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"]);
                                    }
                                    else
                                    {
                                        int result = Nullable.Compare<DateTime>(Convert.ToDateTime(itemRow["ActivityLastUpdate"]), offer.LastActivityDate);
                                        if (result > 0)
                                            offer.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"]);
                                    }
                                }

                                if (offer.LastActivityDate == null)
                                {
                                    offer.LastActivityDate = offer.SendIn;
                                }
                            }

                            offer.OptionsByOffers = new List<OptionsByOffer>();

                            OffersOptionsList.Offers.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            OptionsByOffer optionsbyoffer = new OptionsByOffer();
                            optionsbyoffer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsbyoffer.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsbyoffer.IdOfferPlant = Convert.ToInt32(compdetails.ConnectPlantId);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsbyoffer.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsbyoffer.Quantity > 0)
                                    optionsbyoffer.IsSelected = true;
                                else
                                    optionsbyoffer.IsSelected = false;
                            }
                            else
                            {
                                optionsbyoffer.IsSelected = false;
                            }
                            optionsbyoffer.OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(itemRow["IdOption"].ToString()), Name = itemRow["offeroption"].ToString(), OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(itemRow["IdOfferOptionType"].ToString()), Name = itemRow["offeroptiontype"].ToString() } };

                            OffersOptionsList.OptionsByOffers.Add(optionsbyoffer);
                        }
                    }
                }
            }
            return OffersOptionsList;
        }



        /// <summary>
        /// This method is to get Offer details
        /// </summary>
        /// <param name="idCurrency">Get idCurrency</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="AccountingYearFrom">Get accounting year From</param>
        /// <param name="AccountingYearTo">Get accounting year To</param>
        /// <param name="compdetails">Get company details</param>
        /// <returns>offer details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          OffersOptionsList = = mgr.GetSelectedUsersOffersWithoutPurchaseOrderReturnListDatatable(byte idCurrency, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company compdetails);
        ///          SP :-  offers_GetSelectedUsersOffersWithoutPurchaseOrder
        ///     }
        /// }
        /// </code>
        /// </example>
        public OffersOptionsList GetSelectedUsersOffersWithoutPurchaseOrderReturnListDatatable(byte idCurrency, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company compdetails, Int32 idCurrentUser = 0)
        {
            OffersOptionsList OffersOptionsList = new OffersOptionsList();
            OffersOptionsList.Offers = new List<Offer>();
            OffersOptionsList.OptionsByOffers = new List<OptionsByOffer>();
            OffersOptionsList.LostReasonsByOffers = new List<LostReasonsByOffer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUsersOffersWithoutPurchaseOrderDateWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idEmdepSite", compdetails.ConnectPlantId);


                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
                //DataSet ds = new DataSet();
                //da.Fill(ds);

                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            Offer offer = new Offer();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());
                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());
                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());
                            }

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());
                            }

                            offer.Site.ConnectPlantId = compdetails.ConnectPlantId;

                            offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };

                            offer.Site.Country = new Country { Name = itemRow["CustomerCountry"].ToString(), Zone = new Zone { Name = itemRow["CustomerZone"].ToString() } };

                            offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(itemRow["OfferStatusid"].ToString()), Name = itemRow["OfferStatus"].ToString(), HtmlColor = itemRow["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["SalesStatusType"].ToString(), HtmlColor = itemRow["SalesStatusTypeColor"].ToString() } };

                            offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            offer.Currency = new Currency { IdCurrency = Convert.ToByte(itemRow["IdCurrency"].ToString()), Name = itemRow["OfferCurrency"].ToString() };

                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                                offer.DeliveryDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString());
                            else
                                offer.DeliveryDate = null;

                            if (itemRow["Rfq"] != DBNull.Value)
                                offer.Rfq = itemRow["Rfq"].ToString();

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RFQReception = Convert.ToDateTime(itemRow["RFQReception"].ToString());
                            else
                                offer.RFQReception = null;

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.SendIn = Convert.ToDateTime(itemRow["SendIn"].ToString());
                            else
                                offer.SendIn = null;

                            if (itemRow["IdSource"] != DBNull.Value)
                            {
                                offer.IdSource = Convert.ToByte(itemRow["IdSource"].ToString());
                                offer.Source = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdSource"].ToString()), Value = itemRow["Source"].ToString() };
                            }

                            if (itemRow["IdBusinessUnit"] != DBNull.Value)
                            {
                                offer.IdBusinessUnit = Convert.ToByte(itemRow["IdBusinessUnit"].ToString());
                                offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdBusinessUnit"].ToString()), Value = itemRow["BusinessUnit"].ToString() };
                            }

                            if (itemRow["IdProject"] != DBNull.Value)
                            {
                                offer.IdProject = Convert.ToInt32(itemRow["IdProject"].ToString());
                                offer.Projects = new List<Project>();
                                Project project = new Project();
                                project.IdProject = Convert.ToInt32(itemRow["IdProject"].ToString());
                                project.ProjectCode = itemRow["Code"].ToString();
                                project.ProjectName = itemRow["Title"].ToString();
                                offer.Projects.Add(project);
                            }

                            if (itemRow["IdCarProject"] != DBNull.Value)
                            {
                                offer.IdCarProject = Convert.ToInt64(itemRow["IdCarProject"].ToString());
                                offer.CarProject = new CarProject();

                                offer.CarProject.IdCarProject = Convert.ToInt32(itemRow["IdCarProject"].ToString());
                                offer.CarProject.Name = itemRow["CarProjectName"].ToString();

                            }

                            if (itemRow["IdCarOEM"] != DBNull.Value)
                            {
                                offer.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM = new CarOEM();
                                offer.CarOEM.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM.Name = itemRow["CarOEM"].ToString();
                            }

                            if (offer.GeosStatus != null && offer.GeosStatus.IdOfferStatusType == 1)
                            {

                                if (itemRow["CommentLastUpdate"] != DBNull.Value)
                                {
                                    offer.LastActivityDate = Convert.ToDateTime(itemRow["CommentLastUpdate"]);
                                }

                                if (itemRow["ActivityLastUpdate"] != DBNull.Value)
                                {
                                    if (offer.LastActivityDate == null)
                                    {
                                        offer.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"]);
                                    }
                                    else
                                    {
                                        int result = Nullable.Compare<DateTime>(Convert.ToDateTime(itemRow["ActivityLastUpdate"]), offer.LastActivityDate);
                                        if (result > 0)
                                            offer.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"]);
                                    }
                                }

                                if (offer.LastActivityDate == null)
                                {
                                    offer.LastActivityDate = offer.SendIn;
                                }
                            }

                            offer.OptionsByOffers = new List<OptionsByOffer>();
                            offer.LostReasonsByOffers = new List<LostReasonsByOffer>();
                            OffersOptionsList.Offers.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            OptionsByOffer optionsbyoffer = new OptionsByOffer();
                            optionsbyoffer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsbyoffer.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsbyoffer.IdOfferPlant = Convert.ToInt32(compdetails.ConnectPlantId);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsbyoffer.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsbyoffer.Quantity > 0)
                                    optionsbyoffer.IsSelected = true;
                                else
                                    optionsbyoffer.IsSelected = false;
                            }
                            else
                            {
                                optionsbyoffer.IsSelected = false;
                            }
                            optionsbyoffer.OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(itemRow["IdOption"].ToString()), Name = itemRow["offeroption"].ToString(), OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(itemRow["IdOfferOptionType"].ToString()), Name = itemRow["offeroptiontype"].ToString() } };

                            OffersOptionsList.OptionsByOffers.Add(optionsbyoffer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            LostReasonsByOffer lostReasonsByOffer = new LostReasonsByOffer();
                            if (itemRow["IdOffer"] != DBNull.Value)
                                lostReasonsByOffer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            lostReasonsByOffer.IdOfferPlant = Convert.ToInt32(compdetails.ConnectPlantId);
                            lostReasonsByOffer.Comments = itemRow["Comments"].ToString();
                            lostReasonsByOffer.Competitor = new Competitor();
                            lostReasonsByOffer.Competitor.Name = itemRow["Name"].ToString();
                            lostReasonsByOffer.OfferLostReason = new OfferLostReason();
                            lostReasonsByOffer.OfferLostReason.Name = itemRow["Reason"].ToString();


                            OffersOptionsList.LostReasonsByOffers.Add(lostReasonsByOffer);
                        }
                    }
                }
            }
            return OffersOptionsList;
        }




        /// <summary>
        /// This method is to get list of offer
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="companyDetails">Get company details </param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of offers</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offers = mgr.GetOffersPipeline(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission);
        ///          SP :-  offers_GetSelectedUsersOffersWithoutPurchaseOrder
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<Offer> GetOffersPipeline(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission)
        {
            IList<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOfferPipeline", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);


                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());
                        if (offerreader["IdSalesOwner"] != DBNull.Value)
                        {
                            offer.IdSalesOwner = Convert.ToInt32(offerreader["IdSalesOwner"].ToString());

                        }
                        offer.IdOfferType = Convert.ToByte(offerreader["IdOfferType"].ToString());
                        offer.Code = offerreader["OfferCode"].ToString();
                        offer.Description = offerreader["OfferTitle"].ToString();
                        offer.Site = new Company { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["SiteName"].ToString() };
                        if (offerreader["IdSalesResponsible"] != DBNull.Value)
                        {
                            offer.Site.IdSalesResponsible = Convert.ToInt32(offerreader["IdSalesResponsible"].ToString());
                        }
                        if (offerreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                        {
                            offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(offerreader["IdSalesResponsibleAssemblyBU"].ToString());
                        }
                        offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;
                        //offer.Site.ConnectPlantConstr = dictconnectstr.Value;
                        offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } };
                        offer.Site.Country = new Country { Name = offerreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offerreader["CustomerZone"].ToString() } };
                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["OfferStatusid"].ToString()), Name = offerreader["OfferStatus"].ToString(), HtmlColor = offerreader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["SalesStatusType"].ToString(), HtmlColor = offerreader["SalesStatusTypeColor"].ToString() } };
                        offer.Value = Convert.ToDouble(offerreader["OfferAmount"].ToString());
                        offer.Currency = new Currency { IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString()), Name = offerreader["OfferCurrency"].ToString() };
                        if (offerreader["OfferConfidentialLevel"] != DBNull.Value)
                            offer.ProbabilityOfSuccess = Convert.ToSByte(offerreader["OfferConfidentialLevel"].ToString());
                        if (offerreader["RFQReception"] != DBNull.Value)
                            offer.RFQReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        if (offerreader["sendIn"] != DBNull.Value)
                            offer.SendIn = Convert.ToDateTime(offerreader["sendIn"].ToString());
                        if (offerreader["OfferExpectedPODate"] != DBNull.Value)
                            offer.DeliveryDate = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());

                        offers.Add(offer);
                    }
                }
            }

            return offers;
        }


        /// <summary>
        /// This method is to get list of offer
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYearFrom">Get accounting year From</param>
        /// <param name="accountingYearTo">Get accounting year To</param>
        /// <param name="companyDetails">Get company details </param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of offers</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offers = mgr.GetOffersPipeline(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission);
        ///          SP :-  offers_GetSelectedUsersOffersWithoutPurchaseOrder
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<Offer> GetOffersPipeline(byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, Int32 idUserPermission)
        {
            IList<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOfferPipelineDatewise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);


                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());
                        if (offerreader["IdSalesOwner"] != DBNull.Value)
                        {
                            offer.IdSalesOwner = Convert.ToInt32(offerreader["IdSalesOwner"].ToString());

                        }
                        if (offerreader["IdOfferType"] != DBNull.Value)
                            offer.IdOfferType = Convert.ToByte(offerreader["IdOfferType"].ToString());

                        offer.Code = offerreader["OfferCode"].ToString();
                        offer.Description = offerreader["OfferTitle"].ToString();
                        offer.Site = new Company { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["SiteName"].ToString() };
                        if (offerreader["IdSalesResponsible"] != DBNull.Value)
                        {
                            offer.Site.IdSalesResponsible = Convert.ToInt32(offerreader["IdSalesResponsible"].ToString());
                        }
                        if (offerreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                        {
                            offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(offerreader["IdSalesResponsibleAssemblyBU"].ToString());
                        }
                        offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;
                        //offer.Site.ConnectPlantConstr = dictconnectstr.Value;

                        if (offerreader["IdCustomer"] != DBNull.Value)
                            offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } };

                        offer.Site.Country = new Country { Name = offerreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offerreader["CustomerZone"].ToString() } };
                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["OfferStatusid"].ToString()), Name = offerreader["OfferStatus"].ToString(), HtmlColor = offerreader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["SalesStatusType"].ToString(), HtmlColor = offerreader["SalesStatusTypeColor"].ToString() } };

                        if (offerreader["OfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["OfferAmount"].ToString());

                        offer.Currency = new Currency { IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString()), Name = offerreader["OfferCurrency"].ToString() };
                        if (offerreader["OfferConfidentialLevel"] != DBNull.Value)
                            offer.ProbabilityOfSuccess = Convert.ToSByte(offerreader["OfferConfidentialLevel"].ToString());
                        if (offerreader["RFQReception"] != DBNull.Value)
                            offer.RFQReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        if (offerreader["sendIn"] != DBNull.Value)
                            offer.SendIn = Convert.ToDateTime(offerreader["sendIn"].ToString());
                        if (offerreader["OfferExpectedPODate"] != DBNull.Value)
                            offer.DeliveryDate = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());

                        offers.Add(offer);
                    }
                }
            }

            return offers;
        }

        /// <summary>
        /// This method is to get list of offers 
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="companyDetails">Get company details</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of offers</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offers = mgr.GetOffersPipelineLogEntryWise(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission);
        ///          SP :-  offers_GetOfferPipelineLogEntryWise
        ///     }
        /// }
        /// </code>
        /// </example>
        public IList<Offer> GetOffersPipelineLogEntryWise(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission)
        {
            IList<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOfferPipelineLogEntryWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                //MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
                //DataTable dt = new DataTable();
                //da.Fill(dt);

                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    //foreach (DataRow itemRow in dt.Rows)
                    if (itemRow.HasRows)
                        while (itemRow.Read())
                        {
                            try
                            {
                                Offer offer = new Offer();
                                offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                                offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(itemRow["OfferStatusid"].ToString()), Name = itemRow["OfferStatus"].ToString(), HtmlColor = itemRow["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["SalesStatusType"].ToString(), HtmlColor = itemRow["SalesStatusTypeColor"].ToString() } };
                                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                                offer.LogEntryByOffers = new List<LogEntryByOffer>();
                                LogEntryByOffer logEntryByOffer = new LogEntryByOffer();
                                logEntryByOffer.IdLogEntry = Convert.ToInt64(itemRow["idLogEntry"].ToString());
                                logEntryByOffer.Comments = itemRow["comments"].ToString();
                                offer.LogEntryByOffers.Add(logEntryByOffer);
                                offers.Add(offer);
                            }
                            catch (Exception ex)
                            {
                            }
                        }
                }

            }

            return offers;
        }


        /// <summary>
        /// This method is to get list of offers
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="companydetails">Get company details</param>
        /// <returns>List of offers</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offers = mgr.GetSelectedOffersPipeline(byte idCurrency, string idUser, Int64 accountingYear, Company companydetails);
        ///          SP :-  offers_GetSelectedUserOfferPipeline
        ///     }
        /// }
        /// </code>
        /// </example> 
        public IList<Offer> GetSelectedOffersPipeline(byte idCurrency, string idUser, Int64 accountingYear, Company companydetails, Int32 idCurrentUser = 0)
        {
            IList<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companydetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUserOfferPipeline", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();

                        offer.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());
                        if (offerreader["IdSalesOwner"] != DBNull.Value)
                        {
                            offer.IdSalesOwner = Convert.ToInt32(offerreader["IdSalesOwner"].ToString());

                        }
                        offer.IdOfferType = Convert.ToByte(offerreader["IdOfferType"].ToString());
                        offer.Code = offerreader["OfferCode"].ToString();
                        offer.Description = offerreader["OfferTitle"].ToString();

                        offer.Site = new Company { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["SiteName"].ToString() };
                        if (offerreader["IdSalesResponsible"] != DBNull.Value)
                        {
                            offer.Site.IdSalesResponsible = Convert.ToInt32(offerreader["IdSalesResponsible"].ToString());
                        }
                        if (offerreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                        {
                            offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(offerreader["IdSalesResponsibleAssemblyBU"].ToString());
                        }
                        offer.Site.ConnectPlantId = companydetails.ConnectPlantId;
                        offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } };
                        offer.Site.Country = new Country { Name = offerreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offerreader["CustomerZone"].ToString() } };
                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["OfferStatusid"].ToString()), Name = offerreader["OfferStatus"].ToString(), HtmlColor = offerreader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["SalesStatusType"].ToString(), HtmlColor = offerreader["SalesStatusTypeColor"].ToString() } };
                        offer.Value = Convert.ToDouble(offerreader["OfferAmount"].ToString());

                        offer.Currency = new Currency { IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString()), Name = offerreader["OfferCurrency"].ToString() };
                        if (offerreader["OfferConfidentialLevel"] != DBNull.Value)
                            offer.ProbabilityOfSuccess = Convert.ToSByte(offerreader["OfferConfidentialLevel"].ToString());

                        if (offerreader["OfferExpectedPODate"] != DBNull.Value)
                            offer.DeliveryDate = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());

                        if (offerreader["RFQReception"] != DBNull.Value)
                            offer.RFQReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        if (offerreader["sendIn"] != DBNull.Value)
                            offer.SendIn = Convert.ToDateTime(offerreader["sendIn"].ToString());
                        offers.Add(offer);
                    }
                }
            }

            return offers;
        }


        /// <summary>
        /// This method is to get list of offers
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="accountingYearFrom">Get accounting year From</param>
        /// <param name="accountingYearTo">Get accounting year To</param>
        /// <param name="companydetails">Get company details</param>
        /// <returns>List of offers</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offers = mgr.GetSelectedOffersPipeline(byte idCurrency, string idUser, Int64 accountingYear, Company companydetails);
        ///          SP :-  offers_GetSelectedUserOfferPipeline
        ///     }
        /// }
        /// </code>
        /// </example> 
        public IList<Offer> GetSelectedOffersPipeline(byte idCurrency, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company companydetails, Int32 idCurrentUser = 0)
        {
            IList<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companydetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOfferPipelineDatewise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 21);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();

                        offer.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());
                        if (offerreader["IdSalesOwner"] != DBNull.Value)
                        {
                            offer.IdSalesOwner = Convert.ToInt32(offerreader["IdSalesOwner"].ToString());

                        }
                        if (offerreader["IdOfferType"] != DBNull.Value)
                            offer.IdOfferType = Convert.ToByte(offerreader["IdOfferType"].ToString());
                        offer.Code = offerreader["OfferCode"].ToString();
                        offer.Description = offerreader["OfferTitle"].ToString();

                        offer.Site = new Company { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["SiteName"].ToString() };
                        if (offerreader["IdSalesResponsible"] != DBNull.Value)
                        {
                            offer.Site.IdSalesResponsible = Convert.ToInt32(offerreader["IdSalesResponsible"].ToString());
                        }
                        if (offerreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                        {
                            offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(offerreader["IdSalesResponsibleAssemblyBU"].ToString());
                        }
                        offer.Site.ConnectPlantId = companydetails.ConnectPlantId;

                        if (offerreader["IdCustomer"] != DBNull.Value)
                            offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } };
                        offer.Site.Country = new Country { Name = offerreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offerreader["CustomerZone"].ToString() } };
                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["OfferStatusid"].ToString()), Name = offerreader["OfferStatus"].ToString(), HtmlColor = offerreader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["SalesStatusType"].ToString(), HtmlColor = offerreader["SalesStatusTypeColor"].ToString() } };

                        if (offerreader["OfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["OfferAmount"].ToString());

                        offer.Currency = new Currency { IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString()), Name = offerreader["OfferCurrency"].ToString() };
                        if (offerreader["OfferConfidentialLevel"] != DBNull.Value)
                            offer.ProbabilityOfSuccess = Convert.ToSByte(offerreader["OfferConfidentialLevel"].ToString());

                        if (offerreader["OfferExpectedPODate"] != DBNull.Value)
                            offer.DeliveryDate = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());

                        if (offerreader["RFQReception"] != DBNull.Value)
                            offer.RFQReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        if (offerreader["sendIn"] != DBNull.Value)
                            offer.SendIn = Convert.ToDateTime(offerreader["sendIn"].ToString());
                        offers.Add(offer);
                    }
                }
            }

            return offers;
        }

        /// <summary>
        /// This method is to get list of offers
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="companydetails">Get company details</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offers = mgr.GetSelectedOffersPipelineLogentryWise(byte idCurrency, string idUser, Int64 accountingYear, Company companydetails);
        ///          SP :-  offers_GetSelectedUserOfferPipelineLogEntryWise
        ///     }
        /// }
        /// </code>
        /// </example> 
        public IList<Offer> GetSelectedOffersPipelineLogentryWise(byte idCurrency, string idUser, Int64 accountingYear, Company companydetails, Int32 idCurrentUser = 0)
        {
            IList<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companydetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUserOfferPipelineLogEntryWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                //MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
                //DataTable dt = new DataTable();
                //da.Fill(dt);

                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    //foreach (DataRow itemRow in dt.Rows)
                    if (itemRow.HasRows)
                        while (itemRow.Read())
                        {
                            Offer offer = new Offer();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                            offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(itemRow["OfferStatusid"].ToString()), Name = itemRow["OfferStatus"].ToString(), HtmlColor = itemRow["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["SalesStatusType"].ToString(), HtmlColor = itemRow["SalesStatusTypeColor"].ToString() } };
                            offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            offer.LogEntryByOffers = new List<LogEntryByOffer>();
                            LogEntryByOffer logEntryByOffer = new LogEntryByOffer();
                            logEntryByOffer.IdLogEntry = Convert.ToInt64(itemRow["idLogEntry"].ToString());
                            logEntryByOffer.Comments = itemRow["comments"].ToString();
                            offer.LogEntryByOffers.Add(logEntryByOffer);
                            offers.Add(offer);

                        }
                }
            }

            return offers;
        }

        public List<CarProject> GetTopCarProjectOffers(byte idCurrency, string idUser, Int64 accountingYear, Int32 projectLimit, Int32 idUserPermission, Company companydetails, Int32 idCurrentUser = 0)
        {
            List<CarProject> carProjects = new List<CarProject>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companydetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetTopProjects", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_projectLimit", projectLimit);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                //MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
                //DataTable dt = new DataTable();
                //da.Fill(dt);

                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            CarProject carProject = new CarProject();
                            carProject.IdCarProject = Convert.ToInt64(itemRow["IdCarProject"].ToString());
                            carProject.Name = itemRow["Name"].ToString();

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                carProject.ProjectOfferAmount = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            carProject.Offers = new List<Offer>();

                            using (MySqlConnection conoffer = new MySqlConnection(companydetails.ConnectPlantConstr))
                            {
                                conoffer.Open();
                                MySqlCommand conoffercommand = new MySqlCommand("offers_GetAllOffersByIdCarProject", conoffer);
                                conoffercommand.CommandType = CommandType.StoredProcedure;
                                conoffercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                                conoffercommand.Parameters.AddWithValue("_idUser", idUser);
                                conoffercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                                conoffercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                                conoffercommand.Parameters.AddWithValue("_idCarProject", carProject.IdCarProject);
                                conoffercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                                //MySqlDataAdapter daoffer = new MySqlDataAdapter(conoffercommand);
                                //DataTable dtoffer = new DataTable();
                                //daoffer.Fill(dtoffer);

                                using (MySqlDataReader itemofferRow = conoffercommand.ExecuteReader())
                                {
                                    if (itemofferRow.HasRows)
                                    {
                                        while (itemofferRow.Read())
                                        {

                                            Offer offer = new Offer();
                                            offer.IdOffer = Convert.ToInt64(itemofferRow["idOffer"].ToString());
                                            offer.Code = itemofferRow["Code"].ToString();
                                            offer.Description = itemofferRow["OfferTitle"].ToString();
                                            offer.Site = new Company { Name = itemofferRow["CustomerName"].ToString(), Country = new Country { Name = itemofferRow["Country"].ToString() } };
                                            offer.Site.ConnectPlantId = companydetails.ConnectPlantId;
                                            if (itemofferRow["IdCustomer"] != DBNull.Value)
                                                offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemofferRow["IdCustomer"].ToString()), CustomerName = itemofferRow["CustomerGroup"].ToString() } };
                                            offer.Value = Convert.ToDouble(itemofferRow["OfferAmount"].ToString());
                                            offer.Currency = new Currency { Name = itemofferRow["OfferCurrency"].ToString(), Symbol = itemofferRow["Symbol"].ToString() };
                                            if (itemofferRow["IdCarProject"] != DBNull.Value)
                                                offer.IdCarProject = Convert.ToInt64(itemofferRow["IdCarProject"].ToString());
                                            if (itemofferRow["ExpectedPoReceptionDate"] != DBNull.Value)
                                                offer.OfferExpectedDate = Convert.ToDateTime(itemofferRow["ExpectedPoReceptionDate"].ToString());
                                            if (itemofferRow["IdCarOEM"] != DBNull.Value)
                                            {
                                                offer.IdCarOEM = Convert.ToInt32(itemofferRow["IdCarOEM"].ToString());
                                                offer.CarOEM = new CarOEM();
                                                offer.CarOEM.IdCarOEM = Convert.ToInt32(itemofferRow["IdCarOEM"].ToString());
                                                offer.CarOEM.Name = itemofferRow["CarOEM"].ToString();
                                            }
                                            carProject.Offers.Add(offer);
                                        }
                                    }
                                }
                            }

                            carProjects.Add(carProject);
                        }
                    }
                }
            }

            return carProjects;
        }




        public List<CarProject> GetTopCarProjectOffers(byte idCurrency, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Int32 projectLimit, Int32 idUserPermission, Company companydetails, Int32 idCurrentUser = 0)
        {
            List<CarProject> carProjects = new List<CarProject>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companydetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetTopProjectsDatewise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_projectLimit", projectLimit);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                //MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
                //DataTable dt = new DataTable();
                //da.Fill(dt);

                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            CarProject carProject = new CarProject();
                            carProject.IdCarProject = Convert.ToInt64(itemRow["IdCarProject"].ToString());
                            carProject.Name = itemRow["Name"].ToString();

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                carProject.ProjectOfferAmount = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            carProject.Offers = new List<Offer>();

                            using (MySqlConnection conoffer = new MySqlConnection(companydetails.ConnectPlantConstr))
                            {
                                conoffer.Open();
                                MySqlCommand conoffercommand = new MySqlCommand("offers_GetAllOffersByIdCarProjectDateWise", conoffer);
                                conoffercommand.CommandType = CommandType.StoredProcedure;
                                conoffercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                                conoffercommand.Parameters.AddWithValue("_idUser", idUser);
                                conoffercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                                conoffercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                                conoffercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                                conoffercommand.Parameters.AddWithValue("_idCarProject", carProject.IdCarProject);
                                conoffercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                                //MySqlDataAdapter daoffer = new MySqlDataAdapter(conoffercommand);
                                //DataTable dtoffer = new DataTable();
                                //daoffer.Fill(dtoffer);

                                using (MySqlDataReader itemofferRow = conoffercommand.ExecuteReader())
                                {
                                    if (itemofferRow.HasRows)
                                    {
                                        while (itemofferRow.Read())
                                        {

                                            Offer offer = new Offer();
                                            offer.IdOffer = Convert.ToInt64(itemofferRow["idOffer"].ToString());
                                            offer.Code = itemofferRow["Code"].ToString();
                                            offer.Description = itemofferRow["OfferTitle"].ToString();
                                            offer.Site = new Company { Name = itemofferRow["CustomerName"].ToString(), Country = new Country { Name = itemofferRow["Country"].ToString() } };
                                            offer.Site.ConnectPlantId = companydetails.ConnectPlantId;
                                            if (itemofferRow["IdCustomer"] != DBNull.Value)
                                                offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemofferRow["IdCustomer"].ToString()), CustomerName = itemofferRow["CustomerGroup"].ToString() } };
                                            offer.Value = Convert.ToDouble(itemofferRow["OfferAmount"].ToString());
                                            offer.Currency = new Currency { Name = itemofferRow["OfferCurrency"].ToString(), Symbol = itemofferRow["Symbol"].ToString() };
                                            if (itemofferRow["IdCarProject"] != DBNull.Value)
                                                offer.IdCarProject = Convert.ToInt64(itemofferRow["IdCarProject"].ToString());
                                            if (itemofferRow["ExpectedPoReceptionDate"] != DBNull.Value)
                                                offer.OfferExpectedDate = Convert.ToDateTime(itemofferRow["ExpectedPoReceptionDate"].ToString());
                                            if (itemofferRow["IdCarOEM"] != DBNull.Value)
                                            {
                                                offer.IdCarOEM = Convert.ToInt32(itemofferRow["IdCarOEM"].ToString());
                                                offer.CarOEM = new CarOEM();
                                                offer.CarOEM.IdCarOEM = Convert.ToInt32(itemofferRow["IdCarOEM"].ToString());
                                                offer.CarOEM.Name = itemofferRow["CarOEM"].ToString();
                                            }
                                            carProject.Offers.Add(offer);
                                        }
                                    }
                                }
                            }

                            carProjects.Add(carProject);
                        }
                    }
                }
            }

            return carProjects;
        }

        //public List<CarProject> GetTopCarProjectOffers(byte idCurrency, string idUser, Int64 accountingYear, Int32 projectLimit, Int32 idUserPermission, Company companydetails, Int32 idCurrentUser = 0)
        //{
        //    List<CarProject> carProjects = new List<CarProject>();

        //    using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companydetails.ConnectPlantConstr))
        //    {
        //        conofferwithoutpurchaseorder.Open();
        //        MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetTopProjects", conofferwithoutpurchaseorder);
        //        conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
        //        conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
        //        conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
        //        conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
        //        conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_projectLimit", projectLimit);
        //        conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
        //        conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
        //        MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
        //        DataTable dt = new DataTable();
        //        da.Fill(dt);
        //        foreach (DataRow itemRow in dt.Rows)
        //        {
        //            CarProject carProject = new CarProject();
        //            carProject.IdCarProject = Convert.ToInt64(itemRow["IdCarProject"].ToString());
        //            carProject.Name = itemRow["Name"].ToString();
        //            if (itemRow["OfferAmount"] != DBNull.Value)
        //                carProject.ProjectOfferAmount = Convert.ToDouble(itemRow["OfferAmount"].ToString());
        //            carProject.Offers = new List<Offer>();
        //            using (MySqlConnection conoffer = new MySqlConnection(companydetails.ConnectPlantConstr))
        //            {
        //                conoffer.Open();
        //                MySqlCommand conoffercommand = new MySqlCommand("offers_GetAllOffersByIdCarProject", conoffer);
        //                conoffercommand.CommandType = CommandType.StoredProcedure;
        //                conoffercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
        //                conoffercommand.Parameters.AddWithValue("_idUser", idUser);
        //                conoffercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
        //                conoffercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
        //                conoffercommand.Parameters.AddWithValue("_idCarProject", carProject.IdCarProject);
        //                conoffercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
        //                MySqlDataAdapter daoffer = new MySqlDataAdapter(conoffercommand);
        //                DataTable dtoffer = new DataTable();
        //                daoffer.Fill(dtoffer);
        //                foreach (DataRow itemofferRow in dtoffer.Rows)
        //                {
        //                    Offer offer = new Offer();
        //                    offer.IdOffer = Convert.ToInt64(itemofferRow["idOffer"].ToString());
        //                    offer.Code = itemofferRow["Code"].ToString();
        //                    offer.Description = itemofferRow["OfferTitle"].ToString();
        //                    offer.Site = new Company { Name = itemofferRow["CustomerName"].ToString(), Country = new Country { Name = itemofferRow["Country"].ToString() } };
        //                    offer.Site.ConnectPlantId = companydetails.ConnectPlantId;
        //                    if (itemofferRow["IdCustomer"] != DBNull.Value)
        //                        offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemofferRow["IdCustomer"].ToString()), CustomerName = itemofferRow["CustomerGroup"].ToString() } };
        //                    offer.Value = Convert.ToDouble(itemofferRow["OfferAmount"].ToString());
        //                    offer.Currency = new Currency { Name = itemofferRow["OfferCurrency"].ToString(), Symbol = itemofferRow["Symbol"].ToString() };
        //                    if (itemofferRow["IdCarProject"] != DBNull.Value)
        //                        offer.IdCarProject = Convert.ToInt64(itemofferRow["IdCarProject"].ToString());
        //                    if (itemofferRow["ExpectedPoReceptionDate"] != DBNull.Value)
        //                        offer.OfferExpectedDate = Convert.ToDateTime(itemofferRow["ExpectedPoReceptionDate"].ToString());
        //                    if (itemofferRow["IdCarOEM"] != DBNull.Value)
        //                    {
        //                        offer.IdCarOEM = Convert.ToInt32(itemofferRow["IdCarOEM"].ToString());
        //                        offer.CarOEM = new CarOEM();
        //                        offer.CarOEM.IdCarOEM = Convert.ToInt32(itemofferRow["IdCarOEM"].ToString());
        //                        offer.CarOEM.Name = itemofferRow["CarOEM"].ToString();
        //                    }
        //                    carProject.Offers.Add(offer);
        //                }
        //            }
        //            carProjects.Add(carProject);
        //        }
        //    }
        //    return carProjects;
        //}

        public bool AddSaleUser(SalesUser salesUser, string connectionstring)
        {
            bool isAddedSalesUsers = false;
            int isadded = 0;
            using (MySqlConnection concompany = new MySqlConnection(connectionstring))
            {
                concompany.Open();
                using (MySqlTransaction trans = concompany.BeginTransaction())
                {
                    try
                    {
                        MySqlCommand concompanycommand = new MySqlCommand("salesusers_Insert", concompany);
                        concompanycommand.CommandType = CommandType.StoredProcedure;
                        concompanycommand.Parameters.AddWithValue("_IdSalesUser", salesUser.IdSalesUser);
                        concompanycommand.Parameters.AddWithValue("_IdSalesTeam", salesUser.IdSalesTeam);
                        concompanycommand.Parameters.AddWithValue("_IdSalesPlant", salesUser.IdSalesPlant);
                        concompanycommand.Parameters.AddWithValue("_SalesQuotaAmount", salesUser.SalesQuotaAmount);
                        concompanycommand.Parameters.AddWithValue("_IdSalesQuotaCurrency", salesUser.IdSalesQuotaCurrency);
                        concompanycommand.Transaction = trans;
                        isadded = Convert.ToInt32(concompanycommand.ExecuteScalar());
                        if (isadded == 1)
                            isAddedSalesUsers = true;
                        else
                            isAddedSalesUsers = false;
                        trans.Commit();
                    }
                    catch (Exception ex)
                    {
                        trans.Rollback();
                        throw;
                    }
                }
                return isAddedSalesUsers;
            }
        }



        public List<SalesUser> GetAllSalesUserPeopleDetails(byte idCurrency, string connectionString, Int32 accountingYear)
        {
            List<SalesUser> salesUsers = new List<SalesUser>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("salesusers_GetAllSalesUserPeopleDetails", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
                DataTable dt = new DataTable();
                da.Fill(dt);
                foreach (DataRow itemRow in dt.Rows)
                {
                    SalesUser salesUser = new SalesUser();
                    salesUser.IdSalesTeam = Convert.ToInt32(itemRow["IdSalesTeam"].ToString());
                    salesUser.IdSalesUser = Convert.ToInt32(itemRow["IdSalesUser"].ToString());
                    if (itemRow["IdSalesQuotaCurrency"] != DBNull.Value)
                        salesUser.IdSalesQuotaCurrency = Convert.ToByte(itemRow["IdSalesQuotaCurrency"].ToString());
                    if (itemRow["SalesQuotaAmount"] != DBNull.Value)
                        salesUser.SalesQuotaAmount = Convert.ToDouble(itemRow["SalesQuotaAmount"].ToString());
                    salesUser.LookupValue = new LookupValue();
                    salesUser.LookupValue.IdLookupValue = Convert.ToInt32(itemRow["IdSalesTeam"].ToString());
                    salesUser.LookupValue.Value = itemRow["TeamUser"].ToString();
                    if (itemRow["IdPerson"] != DBNull.Value)
                    {
                        salesUser.People = new People();
                        salesUser.People.IdPerson = Convert.ToInt32(itemRow["IdPerson"].ToString());
                        salesUser.People.Name = itemRow["Name"].ToString();
                        salesUser.People.Surname = itemRow["Surname"].ToString();
                        salesUser.People.Email = itemRow["Email"].ToString();
                        salesUser.People.Phone = itemRow["Phone"].ToString();
                        if (itemRow["IdPersonGender"] != DBNull.Value)
                        {
                            salesUser.People.IdPersonGender = Convert.ToByte(itemRow["IdPersonGender"].ToString());
                            if (salesUser.People.IdPersonGender == 1)
                                salesUser.People.UserGender = "Female";
                            else if (salesUser.People.IdPersonGender == 2)
                                salesUser.People.UserGender = "Male";
                        }
                        salesUser.People.Company = new Company();
                        salesUser.People.Company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                        salesUser.People.Company.Name = itemRow["Plant"].ToString();
                        salesUser.People.Company.Country = new Country();
                        salesUser.People.Company.Country.IdCountry = Convert.ToByte(itemRow["IdCountry"].ToString());
                        salesUser.People.Company.Country.Name = itemRow["Country"].ToString();
                        salesUser.People.Company.Country.Zone = new Zone();
                        salesUser.People.Company.Country.Zone.IdZone = Convert.ToInt32(itemRow["IdZone"].ToString());
                        salesUser.People.Company.Country.Zone.Name = itemRow["Region"].ToString();
                    }
                    salesUsers.Add(salesUser);
                }
            }
            return salesUsers;
        }


        /// <summary>
        /// This method is to get list of offer model appointment
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="compdetails">Get company details</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of offer model appointment</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          modelAppointments = mgr.GetOffersModelAppointment(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company compdetails, Int32 idUserPermission);
        ///          SP :-  offers_GetOffersDailyEvents,offers_GetOrders
        ///     }
        /// }
        /// </code>
        /// </example> 
        public List<ModelAppointment> GetOffersModelAppointment(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company compdetails, Int32 idUserPermission)
        {
            List<ModelAppointment> modelAppointments = new List<ModelAppointment>();
            ModelAppointment modelAppointment = null;

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOffersDailyEvents", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        modelAppointment = new ModelAppointment();
                        modelAppointment.StartTime = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());
                        modelAppointment.EndTime = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());
                        modelAppointment.IsOfferDonePO = false;
                        modelAppointment.Label = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString());
                        modelAppointment.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["OfferStatusid"].ToString()), Name = offerreader["OfferStatus"].ToString(), HtmlColor = offerreader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["SalesStatusType"].ToString(), HtmlColor = offerreader["SalesStatusTypeColor"].ToString() } };
                        modelAppointment.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());
                        modelAppointment.Subject = offerreader["OfferTitle"].ToString();
                        modelAppointment.Description = offerreader["OfferTitle"].ToString();
                        modelAppointment.ConnectPlantId = compdetails.ConnectPlantId;
                        if (offerreader["OfferExpectedPODate"] != DBNull.Value)
                            modelAppointment.OfferExpectedDate = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());
                        if (offerreader["RFQReception"] != DBNull.Value)
                            modelAppointment.RfqReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        if (offerreader["SendIn"] != DBNull.Value)
                            modelAppointment.SendIn = Convert.ToDateTime(offerreader["SendIn"].ToString());

                        modelAppointments.Add(modelAppointment);
                    }
                }
            }

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOrders", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        if (modelAppointments.Any(mapp => mapp.IdOffer != Convert.ToInt64(offerreader["idoffer"].ToString())))
                        {
                            modelAppointment = new ModelAppointment();
                            modelAppointment.StartTime = Convert.ToDateTime(offerreader["PoReceptionDate"].ToString());
                            modelAppointment.EndTime = Convert.ToDateTime(offerreader["PoReceptionDate"].ToString());
                            modelAppointment.IsOfferDonePO = true;
                            modelAppointment.Label = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString());
                            modelAppointment.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["IdStatus"].ToString()), Name = offerreader["OfferStatus"].ToString(), HtmlColor = offerreader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["Status"].ToString(), HtmlColor = offerreader["SalesStatusTypeColor"].ToString() } };
                            modelAppointment.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());
                            modelAppointment.Subject = offerreader["OfferTitle"].ToString();
                            modelAppointment.Description = offerreader["OfferTitle"].ToString();
                            modelAppointment.ConnectPlantId = compdetails.ConnectPlantId;
                            if (offerreader["IsGoAhead"] != DBNull.Value)
                                modelAppointment.IsGoAhead = Convert.ToByte(offerreader["IsGoAhead"].ToString());
                            if (offerreader["PoReceptionDate"] != DBNull.Value)
                                modelAppointment.PoReceivedInDate = Convert.ToDateTime(offerreader["PoReceptionDate"].ToString());
                            if (offerreader["DeliveryDate"] != DBNull.Value)
                                modelAppointment.OtsDeliveryDate = Convert.ToDateTime(offerreader["DeliveryDate"].ToString());

                            modelAppointments.Add(modelAppointment);
                        }
                    }

                }
            }
            return modelAppointments;
        }




        /// <summary>
        /// This method is to get list of offer model appointment
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYearFrom">Get accounting year From</param>
        /// <param name="accountingYearTo">Get accounting year To</param>
        /// <param name="compdetails">Get company details</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of offer model appointment</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          modelAppointments = mgr.GetOffersModelAppointment(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company compdetails, Int32 idUserPermission);
        ///          SP :-  offers_GetOffersDailyEvents,offers_GetOrders
        ///     }
        /// }
        /// </code>
        /// </example> 
        public List<ModelAppointment> GetOffersModelAppointment(byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Company compdetails, Int32 idUserPermission)
        {
            List<ModelAppointment> modelAppointments = new List<ModelAppointment>();
            ModelAppointment modelAppointment = null;

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOffersDailyEventsDatewise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        modelAppointment = new ModelAppointment();
                        modelAppointment.StartTime = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());
                        modelAppointment.EndTime = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());
                        modelAppointment.IsOfferDonePO = false;
                        modelAppointment.Label = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString());
                        modelAppointment.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["OfferStatusid"].ToString()), Name = offerreader["OfferStatus"].ToString(), HtmlColor = offerreader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["SalesStatusType"].ToString(), HtmlColor = offerreader["SalesStatusTypeColor"].ToString() } };
                        modelAppointment.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());
                        modelAppointment.Subject = offerreader["OfferTitle"].ToString();
                        modelAppointment.Description = offerreader["OfferTitle"].ToString();
                        modelAppointment.ConnectPlantId = compdetails.ConnectPlantId;
                        if (offerreader["OfferExpectedPODate"] != DBNull.Value)
                            modelAppointment.OfferExpectedDate = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());
                        if (offerreader["RFQReception"] != DBNull.Value)
                            modelAppointment.RfqReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        if (offerreader["SendIn"] != DBNull.Value)
                            modelAppointment.SendIn = Convert.ToDateTime(offerreader["SendIn"].ToString());

                        modelAppointments.Add(modelAppointment);
                    }
                }
            }

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOrdersDateWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        if (modelAppointments.Any(mapp => mapp.IdOffer != Convert.ToInt64(offerreader["idoffer"].ToString())))
                        {
                            modelAppointment = new ModelAppointment();
                            modelAppointment.StartTime = Convert.ToDateTime(offerreader["PoReceptionDate"].ToString());
                            modelAppointment.EndTime = Convert.ToDateTime(offerreader["PoReceptionDate"].ToString());
                            modelAppointment.IsOfferDonePO = true;
                            modelAppointment.Label = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString());
                            modelAppointment.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["IdStatus"].ToString()), Name = offerreader["OfferStatus"].ToString(), HtmlColor = offerreader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["Status"].ToString(), HtmlColor = offerreader["SalesStatusTypeColor"].ToString() } };
                            modelAppointment.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());
                            modelAppointment.Subject = offerreader["OfferTitle"].ToString();
                            modelAppointment.Description = offerreader["OfferTitle"].ToString();
                            modelAppointment.ConnectPlantId = compdetails.ConnectPlantId;
                            if (offerreader["IsGoAhead"] != DBNull.Value)
                                modelAppointment.IsGoAhead = Convert.ToByte(offerreader["IsGoAhead"].ToString());
                            if (offerreader["PoReceptionDate"] != DBNull.Value)
                                modelAppointment.PoReceivedInDate = Convert.ToDateTime(offerreader["PoReceptionDate"].ToString());
                            if (offerreader["DeliveryDate"] != DBNull.Value)
                                modelAppointment.OtsDeliveryDate = Convert.ToDateTime(offerreader["DeliveryDate"].ToString());

                            modelAppointments.Add(modelAppointment);
                        }
                    }

                }
            }
            return modelAppointments;
        }



        /// <summary>
        /// This method is to get list of model appointment
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="compdetails">Get company details</param>
        /// <returns>List of model appointment</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          modelAppointments = mgr.GetSelectedUsersOffersModelAppointment(byte idCurrency, string idUser, Int64 accountingYear, Company compdetails);
        ///          SP :-  offers_GetSelectedUserOffersDailyEvents,offers_GetSelectedUsersOrders
        ///     }
        /// }
        /// </code>
        /// </example> 
        public List<ModelAppointment> GetSelectedUsersOffersModelAppointment(byte idCurrency, string idUser, Int64 accountingYear, Company compdetails, Int32 idCurrentUser = 0)
        {
            List<ModelAppointment> modelAppointments = new List<ModelAppointment>();
            ModelAppointment modelAppointment = null;

            //Dictionary<string, string> dictconnectstrings = new Dictionary<string, string>();
            //dictconnectstrings = GetAllSitesDetailsById(idUser, offerplantId, connectionstring);

            //foreach (var dictconnectstr in dictconnectstrings)
            //{

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUserOffersDailyEvents", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        modelAppointment = new ModelAppointment();
                        modelAppointment.StartTime = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());
                        modelAppointment.EndTime = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());
                        modelAppointment.IsOfferDonePO = false;
                        modelAppointment.Label = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString());
                        modelAppointment.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["OfferStatusid"].ToString()), Name = offerreader["OfferStatus"].ToString(), HtmlColor = offerreader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["SalesStatusType"].ToString(), HtmlColor = offerreader["SalesStatusTypeColor"].ToString() } };
                        modelAppointment.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());
                        modelAppointment.Subject = offerreader["OfferTitle"].ToString();
                        modelAppointment.Description = offerreader["OfferTitle"].ToString();
                        modelAppointment.ConnectPlantId = compdetails.ConnectPlantId;
                        if (offerreader["OfferExpectedPODate"] != DBNull.Value)
                            modelAppointment.OfferExpectedDate = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());
                        if (offerreader["RFQReception"] != DBNull.Value)
                            modelAppointment.RfqReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        if (offerreader["SendIn"] != DBNull.Value)
                            modelAppointment.SendIn = Convert.ToDateTime(offerreader["SendIn"].ToString());
                        modelAppointments.Add(modelAppointment);
                    }
                }
            }

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUsersOrders", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        if (modelAppointments.Any(mapp => mapp.IdOffer != Convert.ToInt64(offerreader["idoffer"].ToString())))
                        {
                            modelAppointment = new ModelAppointment();
                            modelAppointment.StartTime = Convert.ToDateTime(offerreader["PoReceptionDate"].ToString());
                            modelAppointment.EndTime = Convert.ToDateTime(offerreader["PoReceptionDate"].ToString());
                            modelAppointment.IsOfferDonePO = true;
                            modelAppointment.Label = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString());
                            modelAppointment.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["IdStatus"].ToString()), Name = offerreader["OfferStatus"].ToString(), HtmlColor = offerreader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["Status"].ToString(), HtmlColor = offerreader["SalesStatusTypeColor"].ToString() } };
                            modelAppointment.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());
                            modelAppointment.Subject = offerreader["OfferTitle"].ToString();
                            modelAppointment.Description = offerreader["OfferTitle"].ToString();
                            modelAppointment.ConnectPlantId = compdetails.ConnectPlantId;
                            if (offerreader["IsGoAhead"] != DBNull.Value)
                                modelAppointment.IsGoAhead = Convert.ToByte(offerreader["IsGoAhead"].ToString());
                            if (offerreader["PoReceptionDate"] != DBNull.Value)
                                modelAppointment.PoReceivedInDate = Convert.ToDateTime(offerreader["PoReceptionDate"].ToString());
                            if (offerreader["DeliveryDate"] != DBNull.Value)
                                modelAppointment.OtsDeliveryDate = Convert.ToDateTime(offerreader["DeliveryDate"].ToString());
                            modelAppointments.Add(modelAppointment);
                        }
                    }
                    //}
                }
            }

            return modelAppointments;
        }



        /// <summary>
        /// This method is to get list of model appointment
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="accountingYearFrom">Get accounting year From</param>
        /// <param name="accountingYearTo">Get accounting year To</param>
        /// <param name="compdetails">Get company details</param>
        /// <returns>List of model appointment</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          modelAppointments = mgr.GetSelectedUsersOffersModelAppointment(byte idCurrency, string idUser, Int64 accountingYear, Company compdetails);
        ///          SP :-  offers_GetSelectedUserOffersDailyEvents,offers_GetSelectedUsersOrders
        ///     }
        /// }
        /// </code>
        /// </example> 
        public List<ModelAppointment> GetSelectedUsersOffersModelAppointment(byte idCurrency, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company compdetails, Int32 idCurrentUser = 0)
        {
            List<ModelAppointment> modelAppointments = new List<ModelAppointment>();
            ModelAppointment modelAppointment = null;
            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUserOffersDailyEventsDateWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);

                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        modelAppointment = new ModelAppointment();
                        modelAppointment.StartTime = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());
                        modelAppointment.EndTime = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());
                        modelAppointment.IsOfferDonePO = false;
                        modelAppointment.Label = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString());
                        modelAppointment.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["OfferStatusid"].ToString()), Name = offerreader["OfferStatus"].ToString(), HtmlColor = offerreader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["SalesStatusType"].ToString(), HtmlColor = offerreader["SalesStatusTypeColor"].ToString() } };
                        modelAppointment.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());
                        modelAppointment.Subject = offerreader["OfferTitle"].ToString();
                        modelAppointment.Description = offerreader["OfferTitle"].ToString();
                        modelAppointment.ConnectPlantId = compdetails.ConnectPlantId;
                        if (offerreader["OfferExpectedPODate"] != DBNull.Value)
                            modelAppointment.OfferExpectedDate = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());
                        if (offerreader["RFQReception"] != DBNull.Value)
                            modelAppointment.RfqReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        if (offerreader["SendIn"] != DBNull.Value)
                            modelAppointment.SendIn = Convert.ToDateTime(offerreader["SendIn"].ToString());
                        modelAppointments.Add(modelAppointment);
                    }
                }
            }

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUsersOrdersDateWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        if (modelAppointments.Any(mapp => mapp.IdOffer != Convert.ToInt64(offerreader["idoffer"].ToString())))
                        {
                            modelAppointment = new ModelAppointment();
                            modelAppointment.StartTime = Convert.ToDateTime(offerreader["PoReceptionDate"].ToString());
                            modelAppointment.EndTime = Convert.ToDateTime(offerreader["PoReceptionDate"].ToString());
                            modelAppointment.IsOfferDonePO = true;
                            modelAppointment.Label = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString());
                            modelAppointment.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["IdStatus"].ToString()), Name = offerreader["OfferStatus"].ToString(), HtmlColor = offerreader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["Status"].ToString(), HtmlColor = offerreader["SalesStatusTypeColor"].ToString() } };
                            modelAppointment.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());
                            modelAppointment.Subject = offerreader["OfferTitle"].ToString();
                            modelAppointment.Description = offerreader["OfferTitle"].ToString();
                            modelAppointment.ConnectPlantId = compdetails.ConnectPlantId;
                            if (offerreader["IsGoAhead"] != DBNull.Value)
                                modelAppointment.IsGoAhead = Convert.ToByte(offerreader["IsGoAhead"].ToString());
                            if (offerreader["PoReceptionDate"] != DBNull.Value)
                                modelAppointment.PoReceivedInDate = Convert.ToDateTime(offerreader["PoReceptionDate"].ToString());
                            if (offerreader["DeliveryDate"] != DBNull.Value)
                                modelAppointment.OtsDeliveryDate = Convert.ToDateTime(offerreader["DeliveryDate"].ToString());
                            modelAppointments.Add(modelAppointment);
                        }
                    }
                    //}
                }
            }

            return modelAppointments;
        }




        /// <summary>
        /// This method is to get list of offer
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="companyDetails">Get company details</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offers = mgr.GetOfferLeadSourceCompanyWise(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission);
        ///          SP :-  offers_GetLeadSource
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<Offer> GetOfferLeadSourceCompanyWise(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetLeadSource", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        offer.IdSource = Convert.ToByte(offerreader["IdSource"].ToString());
                        offer.Source = new LookupValue { IdLookupValue = Convert.ToByte(offerreader["IdSource"].ToString()), Value = offerreader["Source"].ToString() };
                        offer.Site = new Company();
                        offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;
                        //offer.Site.ConnectPlantConstr = dictconnectstr.Value;
                        offers.Add(offer);
                    }
                }
            }

            return offers;
        }

        public List<Offer> GetOfferLeadSourceCompanyWise(byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, Int32 idUserPermission)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetLeadSourceDatewise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        offer.IdSource = Convert.ToByte(offerreader["IdSource"].ToString());
                        offer.Source = new LookupValue { IdLookupValue = Convert.ToByte(offerreader["IdSource"].ToString()), Value = offerreader["Source"].ToString() };
                        offer.Site = new Company();
                        offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;
                        //offer.Site.ConnectPlantConstr = dictconnectstr.Value;
                        offers.Add(offer);
                    }
                }
            }

            return offers;
        }

        /// <summary>
        /// This method is to get list of offer
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="companyDetails">Get company details</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offers = mgr.GetSelectedUsersOfferLeadSourceCompanyWise(byte idCurrency, string idUser, Int64 accountingYear, Company companyDetails);
        ///          SP :-  offers_GetSelectedUsersLeadSource
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<Offer> GetSelectedUsersOfferLeadSourceCompanyWise(byte idCurrency, string idUser, Int64 accountingYear, Company companyDetails, Int32 idCurrentUser = 0)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUsersLeadSource", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        offer.IdSource = Convert.ToByte(offerreader["IdSource"].ToString());
                        offer.Source = new LookupValue { IdLookupValue = Convert.ToByte(offerreader["IdSource"].ToString()), Value = offerreader["Source"].ToString() };
                        offer.Site = new Company();
                        offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;
                        //offer.Site.ConnectPlantConstr = dictconnectstr.Value;
                        offers.Add(offer);
                    }
                }
            }

            return offers;
        }

        public List<Offer> GetSelectedUsersOfferLeadSourceCompanyWise(byte idCurrency, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, Int32 idCurrentUser = 0)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetLeadSourceDatewise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 21);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        offer.IdSource = Convert.ToByte(offerreader["IdSource"].ToString());
                        offer.Source = new LookupValue { IdLookupValue = Convert.ToByte(offerreader["IdSource"].ToString()), Value = offerreader["Source"].ToString() };
                        offer.Site = new Company();
                        offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;
                        //offer.Site.ConnectPlantConstr = dictconnectstr.Value;
                        offers.Add(offer);
                    }
                }
            }

            return offers;
        }

        /// <summary>
        /// This method is to update list of currency conversion
        /// </summary>
        /// <param name="currencyConversions">Get list of currency conversion to update</param>
        /// <returns>Is updated or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          bool isUpdated = mgr.UpdateCurrencyConversion(List<CurrencyConversion> currencyConversions);
        ///          SP :-  currencyconversions_UpdateCurrencyConversions
        ///     }
        /// }
        /// </code>
        /// </example>  
        public bool UpdateCurrencyConversion(List<CurrencyConversion> currencyConversions)
        {
            bool isUpdated = false;
            try
            {
                using (var db = new CrmContext())
                {

                    currencyConversions = currencyConversions.Select(cc => { cc.Idcurrencyfrom = (from records in db.Currencies where records.Name == cc.CurrencyFrom.Name select records.IdCurrency).SingleOrDefault(); cc.Idcurrencyto = (from records in db.Currencies where records.Name == cc.CurrencyTo.Name select records.IdCurrency).SingleOrDefault(); return cc; }).ToList();

                    foreach (CurrencyConversion currencyConversion in currencyConversions)
                    {

                        var idcurrencyTo = new MySqlParameter("@_idcurrencyTo", currencyConversion.Idcurrencyto);
                        var idcurrencyFrom = new MySqlParameter("@_idcurrencyFrom", currencyConversion.Idcurrencyfrom);
                        var exchangeRate = new MySqlParameter("@_exchangeRate", currencyConversion.ExchangeRate);
                        var lastupdate = new MySqlParameter("@_lastupdate", DateTime.Now);

                        db.Database.ExecuteSqlCommand("currencyconversions_UpdateCurrencyConversions(@_idcurrencyTo,@_idcurrencyFrom,@_exchangeRate,@_lastupdate)", idcurrencyTo, idcurrencyFrom, exchangeRate, lastupdate);

                        isUpdated = true;
                    }
                }
            }
            catch (Exception ex)
            {

                isUpdated = false;
            }
            return isUpdated;
        }

        /// <summary>
        /// This method is to get offer lost reason
        /// </summary>
        /// <returns>List of offer lost reason</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offerLostReason = mgr.GetOfferLostReason(); // (using EF CrmContext)
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<OfferLostReason> GetOfferLostReason()
        {
            List<OfferLostReason> offerLostReason = null;
            try
            {
                using (var db = new CrmContext())
                {

                    offerLostReason = (from records in db.OfferLostReasons select records).ToList();
                }
            }
            catch (Exception ex)
            {

            }
            return offerLostReason;
        }

        /// <summary>
        /// This method is to get offer deatils related to offer id
        /// </summary>
        /// <param name="idOffer">Get offer id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="company">Get company details</param>
        /// <returns>Get offer details related to offer id</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offer = mgr.GetOfferDetailsById(Int64 idOffer, Int32 idUser, byte idCurrency, Int64 accountingYear, Company company);
        ///          SP :-  offers_GetOfferDetailsById,optionsbyoffer_GetOptionsByOfferId
        ///          Query :- "select ost.IdOfferStatusTracking,ost.IdOffer,ost.IdOfferStatusType,ost.StartDate,ost.EndDate,st.IdSalesStatusType,st.Name from offer_status_tracking ost inner join offerstatustypes ofst on ost.IdOfferStatusType = ofst.IdOfferStatusType inner join sales_status_types st on st.IdSalesStatusType = ofst.IdSalesStatusType  where IdOffer = " + idOffer + ""
        ///     }
        /// }
        /// </code>
        /// </example>  
        public Offer GetOfferDetailsById(Int64 idOffer, Int32 idUser, byte idCurrency, Int64 accountingYear, Company company, string workingOrdersPath)
        {
            Offer offer = new Offer();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(company.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOfferDetailsById", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_offerId", idOffer);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (offerreader.Read())
                    {
                        offer.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());
                        if (offerreader["IdSalesOwner"] != DBNull.Value)
                        {
                            offer.IdSalesOwner = Convert.ToInt32(offerreader["IdSalesOwner"].ToString());
                            offer.SalesOwner = new People { IdPerson = Convert.ToInt32(offerreader["IdSalesOwner"].ToString()), Name = offerreader["OfferSalesOwnerName"].ToString(), Surname = offerreader["OfferSalesOwnerSurName"].ToString() };
                        }

                        offer.IdOfferType = Convert.ToByte(offerreader["idOfferType"].ToString());
                        offer.Code = offerreader["OfferCode"].ToString();
                        offer.Number = Convert.ToInt64(offerreader["number"].ToString());
                        offer.Year = Convert.ToInt64(offerreader["OfferYear"].ToString());
                        offer.IdCustomer = Convert.ToInt32(offerreader["IdSite"].ToString());
                        offer.IdStatus = Convert.ToByte(offerreader["IdStatus"].ToString());

                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToByte(offerreader["IdStatus"].ToString()), Name = offerreader["OfferStatus"].ToString() };

                        if (offerreader["IdSalesStatusType"] != DBNull.Value)
                        {
                            offer.GeosStatus.IdSalesStatusType = Convert.ToByte(offerreader["IdSalesStatusType"].ToString());

                            offer.GeosStatus.SalesStatusType = new SalesStatusType();
                            offer.GeosStatus.SalesStatusType.IdSalesStatusType = Convert.ToByte(offerreader["IdSalesStatusType"].ToString());
                            offer.GeosStatus.SalesStatusType.Name = offerreader["SalesStatus"].ToString();
                        }

                        offer.IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString());
                        offer.ModifiedBy = Convert.ToInt32(offerreader["ModifiedBy"].ToString());
                        if (offerreader["IdBusinessUnit"] != DBNull.Value)
                            offer.IdBusinessUnit = Convert.ToByte(offerreader["IdBusinessUnit"].ToString());
                        if (offerreader["IdSource"] != DBNull.Value)
                            offer.IdSource = Convert.ToByte(offerreader["IdSource"].ToString());
                        offer.Description = offerreader["OfferTitle"].ToString();
                        offer.Site = new Company() { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["SiteName"].ToString(), Country = new Country { Name = offerreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offerreader["CustomerZone"].ToString() } } };
                        offer.Site.ConnectPlantId = company.ConnectPlantId;
                        offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } };

                        offer.Value = Convert.ToDouble(offerreader["OfferAmount"].ToString());
                        if (offerreader["IdProject"] != DBNull.Value)
                            offer.IdProject = Convert.ToInt32(offerreader["IdProject"].ToString());
                        if (offerreader["IdCarProject"] != DBNull.Value)
                            offer.IdCarProject = Convert.ToInt32(offerreader["IdCarProject"].ToString());
                        if (offerreader["OfferConfidentialLevel"] != DBNull.Value)
                            offer.ProbabilityOfSuccess = Convert.ToSByte(offerreader["OfferConfidentialLevel"].ToString());
                        if (offerreader["OfferExpectedDate"] != DBNull.Value)
                            offer.OfferExpectedDate = Convert.ToDateTime(offerreader["OfferExpectedDate"].ToString());
                        else
                            offer.OfferExpectedDate = null;
                        if (offerreader["RFQReception"] != DBNull.Value)
                            offer.RFQReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        else
                            offer.RFQReception = null;
                        if (offerreader["sendIn"] != DBNull.Value)
                            offer.SendIn = Convert.ToDateTime(offerreader["sendIn"].ToString());
                        else
                            offer.SendIn = null;
                        if (offerreader["DeliveryDate"] != DBNull.Value)
                            offer.DeliveryDate = Convert.ToDateTime(offerreader["DeliveryDate"].ToString());
                        else
                            offer.DeliveryDate = null;
                        if (offerreader["otsDeliveryDate"] != DBNull.Value)
                            offer.OTSDeliveryDate = Convert.ToDateTime(offerreader["otsDeliveryDate"].ToString());
                        else
                            offer.OTSDeliveryDate = null;
                        if (offerreader["POReceivedInDate"] != DBNull.Value)
                            offer.POReceivedInDate = Convert.ToDateTime(offerreader["POReceivedInDate"].ToString());
                        else
                            offer.POReceivedInDate = null;
                        offer.Rfq = offerreader["Rfq"].ToString();
                        offer.Comments = offerreader["Comments"].ToString();
                        offer.Currency = new Currency { IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString()), Name = offerreader["CurrencyName"].ToString() };
                        if (offerreader["ModifiedIn"].ToString() == "01/01/1000 0:00:00")
                        {
                            offer.ModifiedIn = null;
                        }
                        else
                        {
                            offer.ModifiedIn = Convert.ToDateTime(offerreader["ModifiedIn"].ToString());
                        }
                        if (offerreader["CreatedIn"] != DBNull.Value)
                            offer.CreatedIn = Convert.ToDateTime(offerreader["CreatedIn"].ToString());
                        if (offerreader["IdCarOEM"] != DBNull.Value)
                            offer.IdCarOEM = Convert.ToInt32(offerreader["IdCarOEM"].ToString());

                        offer.OptionsByOffers = new List<OptionsByOffer>();
                        using (MySqlConnection conoptionsbyoffer = new MySqlConnection(company.ConnectPlantConstr))
                        {
                            conoptionsbyoffer.Open();
                            MySqlCommand conoptionsbyoffercommand = new MySqlCommand("optionsbyoffer_GetOptionsByOfferId", conoptionsbyoffer);
                            conoptionsbyoffercommand.CommandType = CommandType.StoredProcedure;
                            conoptionsbyoffercommand.Parameters.AddWithValue("_offerId", offer.IdOffer);
                            using (MySqlDataReader optionsbyofferreader = conoptionsbyoffercommand.ExecuteReader())
                            {
                                while (optionsbyofferreader.Read())
                                {

                                    OptionsByOffer optionsbyoffer = new OptionsByOffer();
                                    optionsbyoffer.IdOffer = Convert.ToInt64(optionsbyofferreader["IdOffer"].ToString());
                                    optionsbyoffer.IdOption = Convert.ToInt64(optionsbyofferreader["IdOption"].ToString());
                                    if (optionsbyofferreader["Quantity"] != DBNull.Value)
                                    {
                                        optionsbyoffer.Quantity = Convert.ToInt32(optionsbyofferreader["Quantity"].ToString());
                                        if (optionsbyoffer.Quantity > 0)
                                            optionsbyoffer.IsSelected = true;
                                        else
                                            optionsbyoffer.IsSelected = false;
                                    }
                                    else
                                    {
                                        optionsbyoffer.IsSelected = false;
                                    }
                                    optionsbyoffer.OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(optionsbyofferreader["IdOption"].ToString()), Name = optionsbyofferreader["offeroption"].ToString(), OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(optionsbyofferreader["IdOfferOptionType"].ToString()), Name = optionsbyofferreader["offeroptiontype"].ToString() } };

                                    if (offer.OptionsByOffers.Any(obo => obo.IdOffer == optionsbyoffer.IdOffer && obo.IdOption == optionsbyoffer.IdOption))
                                    {

                                    }
                                    else
                                    {
                                        offer.OptionsByOffers.Add(optionsbyoffer);
                                    }
                                }
                            }


                            if (offer.OptionsByOffers.Any(x => x.IdOption == 25))
                            {


                                List<Quotation> quotationByIdOffer = GetOfferQuotationByIdOffer(offer.IdOffer, company.ConnectPlantConstr).ToList();

                                Quotation quot = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == 23);

                                if (quot != null)
                                {
                                    EngineeringAnalysis engineeringAnalysis = new EngineeringAnalysis();
                                    Ots ot = GetOTByQuotationId(quot, company.ConnectPlantConstr);

                                    if (ot != null)
                                    {
                                        engineeringAnalysis.DueDate = ot.DeliveryDate.Value;

                                        List<OtItem> otitems = GetOtItemsByIdOT(ot, company.ConnectPlantConstr);
                                        if (otitems.Count > 0)
                                        {
                                            engineeringAnalysis.Comments = otitems[0].CustomerComment;
                                        }
                                    }

                                    engineeringAnalysis.Attachments = new List<Attachment>();

                                    string path = workingOrdersPath + @"\" + offer.Year + @"\" + offer.Code + @"\01 Project Specifications\";
                                    if (Directory.Exists(path))
                                    {
                                        string[] files = Directory.GetFiles(path);

                                        foreach (string file in files)
                                        {
                                            Attachment attachment = new Attachment();
                                            attachment.OriginalFileName = Path.GetFileName(file);
                                            attachment.FilePath = Path.GetFullPath(file);
                                            engineeringAnalysis.Attachments.Add(attachment);
                                        }
                                    }

                                    offer.EngineeringAnalysis = engineeringAnalysis;
                                }
                            }
                        }

                        offer.OfferStatusTracking = new List<OfferStatusTracking>();
                        using (MySqlConnection conofferstatus = new MySqlConnection(company.ConnectPlantConstr))
                        {
                            conofferstatus.Open();
                            MySqlCommand conofferstatuscommand = new MySqlCommand("offerstatustracking_GetOfferStatusTrackingByIdOffer", conofferstatus);
                            conofferstatuscommand.CommandType = CommandType.StoredProcedure;
                            conofferstatuscommand.Parameters.AddWithValue("_idOffer", offer.IdOffer);
                            using (MySqlDataReader offerstatusreader = conofferstatuscommand.ExecuteReader())
                            {
                                while (offerstatusreader.Read())
                                {
                                    if (offer.OfferStatusTracking.Any(ofs => ofs.SalesStatusType.IdSalesStatusType == Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString())))
                                    {
                                        OfferStatusTracking offerStatusTrackingtemp = offer.OfferStatusTracking.Where(ofs => ofs.SalesStatusType.IdSalesStatusType == Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString())).FirstOrDefault();
                                        offerStatusTrackingtemp.IdOfferStatusTracking = Convert.ToInt64(offerstatusreader["IdOfferStatusTracking"].ToString());
                                        offerStatusTrackingtemp.IdOffer = Convert.ToInt64(offerstatusreader["IdOffer"].ToString());
                                        offerStatusTrackingtemp.IdOfferStatusType = Convert.ToInt64(offerstatusreader["IdOfferStatusType"].ToString());
                                        offerStatusTrackingtemp.SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString()), Name = offerstatusreader["Name"].ToString(), HtmlColor = offerstatusreader["HtmlColor"].ToString() };
                                        offerStatusTrackingtemp.StartDate = Convert.ToDateTime(offerstatusreader["StartDate"].ToString());

                                        if (offerstatusreader["EndDate"] != DBNull.Value)
                                        {
                                            offerStatusTrackingtemp.EndDate = offerstatusreader["EndDate"].ToString();
                                        }
                                        else
                                        {
                                            offerStatusTrackingtemp.EndDate = DateTime.Now.ToString();
                                        }

                                        try
                                        {
                                            offerStatusTrackingtemp.NoOfDays = offerStatusTrackingtemp.NoOfDays + (Convert.ToDateTime(Convert.ToDateTime(offerStatusTrackingtemp.EndDate).ToString("yyyy-MM-dd")) - Convert.ToDateTime(offerStatusTrackingtemp.StartDate.ToString("yyyy-MM-dd"))).TotalDays;
                                        }
                                        catch (Exception ex)
                                        {

                                        }
                                    }
                                    else
                                    {
                                        OfferStatusTracking offerStatusTracking = new OfferStatusTracking();
                                        offerStatusTracking.IdOfferStatusTracking = Convert.ToInt64(offerstatusreader["IdOfferStatusTracking"].ToString());
                                        offerStatusTracking.IdOffer = Convert.ToInt64(offerstatusreader["IdOffer"].ToString());
                                        offerStatusTracking.IdOfferStatusType = Convert.ToInt64(offerstatusreader["IdOfferStatusType"].ToString());
                                        offerStatusTracking.SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString()), Name = offerstatusreader["Name"].ToString(), HtmlColor = offerstatusreader["HtmlColor"].ToString() };
                                        offerStatusTracking.StartDate = Convert.ToDateTime(offerstatusreader["StartDate"].ToString());

                                        if (offerstatusreader["EndDate"] != DBNull.Value)
                                        {
                                            offerStatusTracking.EndDate = offerstatusreader["EndDate"].ToString();
                                        }
                                        else
                                        {
                                            offerStatusTracking.EndDate = DateTime.Now.ToString();
                                        }

                                        try
                                        {
                                            offerStatusTracking.NoOfDays = (Convert.ToDateTime(Convert.ToDateTime(offerStatusTracking.EndDate).ToString("yyyy-MM-dd")) - Convert.ToDateTime(offerStatusTracking.StartDate.ToString("yyyy-MM-dd"))).TotalDays;
                                        }
                                        catch (Exception ex)
                                        {

                                        }

                                        offer.OfferStatusTracking.Add(offerStatusTracking);
                                    }
                                }
                            }
                        }
                    }
                }
            }


            return offer;
        }


        /// <summary>
        /// This method is to get offer deatils related to offer id
        /// </summary>
        /// <param name="idOffer">Get offer id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="company">Get company details</param>
        /// <returns>Get offer details related to offer id</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offer = mgr.GetOfferDetailsById(Int64 idOffer, Int32 idUser, byte idCurrency, Int64 accountingYear, Company company);
        ///          SP :-  offers_GetOfferDetailsById,optionsbyoffer_GetOptionsByOfferId
        ///          Query :- "select ost.IdOfferStatusTracking,ost.IdOffer,ost.IdOfferStatusType,ost.StartDate,ost.EndDate,st.IdSalesStatusType,st.Name from offer_status_tracking ost inner join offerstatustypes ofst on ost.IdOfferStatusType = ofst.IdOfferStatusType inner join sales_status_types st on st.IdSalesStatusType = ofst.IdSalesStatusType  where IdOffer = " + idOffer + ""
        ///     }
        /// }
        /// </code>
        /// </example>  
        public Offer GetOfferDetailsById(Int64 idOffer, Int32 idUser, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, Company company, string workingOrdersPath)
        {
            Offer offer = new Offer();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(company.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOfferDetailsByIdDateWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_offerId", idOffer);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (offerreader.Read())
                    {
                        offer.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());

                        if (offerreader["IdSalesOwner"] != DBNull.Value)
                        {
                            offer.IdSalesOwner = Convert.ToInt32(offerreader["IdSalesOwner"].ToString());
                            offer.SalesOwner = new People { IdPerson = Convert.ToInt32(offerreader["IdSalesOwner"].ToString()), Name = offerreader["OfferSalesOwnerName"].ToString(), Surname = offerreader["OfferSalesOwnerSurName"].ToString(), Email = Convert.ToString(offerreader["OfferSalesOwnerEmail"]) };
                        }

                        offer.IdOfferType = Convert.ToByte(offerreader["idOfferType"].ToString());
                        offer.Code = offerreader["OfferCode"].ToString();
                        offer.Number = Convert.ToInt64(offerreader["number"].ToString());
                        offer.Year = Convert.ToInt64(offerreader["OfferYear"].ToString());
                        offer.IdCustomer = Convert.ToInt32(offerreader["IdSite"].ToString());
                        offer.IdStatus = Convert.ToByte(offerreader["IdStatus"].ToString());

                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToByte(offerreader["IdStatus"].ToString()), Name = offerreader["OfferStatus"].ToString() };

                        if (offerreader["IdSalesStatusType"] != DBNull.Value)
                        {
                            offer.GeosStatus.IdSalesStatusType = Convert.ToByte(offerreader["IdSalesStatusType"].ToString());

                            offer.GeosStatus.SalesStatusType = new SalesStatusType();
                            offer.GeosStatus.SalesStatusType.IdSalesStatusType = Convert.ToByte(offerreader["IdSalesStatusType"].ToString());
                            offer.GeosStatus.SalesStatusType.Name = offerreader["SalesStatus"].ToString();
                        }

                        offer.IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString());
                        offer.ModifiedBy = Convert.ToInt32(offerreader["ModifiedBy"].ToString());

                        if (offerreader["IdBusinessUnit"] != DBNull.Value)
                            offer.IdBusinessUnit = Convert.ToByte(offerreader["IdBusinessUnit"].ToString());

                        if (offerreader["IdSource"] != DBNull.Value)
                            offer.IdSource = Convert.ToByte(offerreader["IdSource"].ToString());

                        offer.Description = offerreader["OfferTitle"].ToString();
                        offer.Site = new Company() { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["SiteName"].ToString().Trim(), Country = new Country { Name = offerreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offerreader["CustomerZone"].ToString() } } };
                        offer.Site.ConnectPlantId = company.ConnectPlantId;
                        offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } };

                        if (offerreader["OfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["OfferAmount"].ToString());

                        if (offerreader["IdProject"] != DBNull.Value)
                            offer.IdProject = Convert.ToInt32(offerreader["IdProject"].ToString());

                        if (offerreader["IdCarProject"] != DBNull.Value)
                            offer.IdCarProject = Convert.ToInt32(offerreader["IdCarProject"].ToString());

                        if (offerreader["OfferConfidentialLevel"] != DBNull.Value)
                            offer.ProbabilityOfSuccess = Convert.ToSByte(offerreader["OfferConfidentialLevel"].ToString());

                        if (offerreader["OfferExpectedDate"] != DBNull.Value)
                            offer.OfferExpectedDate = Convert.ToDateTime(offerreader["OfferExpectedDate"].ToString());
                        else
                            offer.OfferExpectedDate = null;

                        if (offerreader["RFQReception"] != DBNull.Value)
                            offer.RFQReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        else
                            offer.RFQReception = null;

                        if (offerreader["sendIn"] != DBNull.Value)
                            offer.SendIn = Convert.ToDateTime(offerreader["sendIn"].ToString());
                        else
                            offer.SendIn = null;

                        if (offerreader["DeliveryDate"] != DBNull.Value)
                            offer.DeliveryDate = Convert.ToDateTime(offerreader["DeliveryDate"].ToString());
                        else
                            offer.DeliveryDate = null;

                        if (offerreader["otsDeliveryDate"] != DBNull.Value)
                            offer.OTSDeliveryDate = Convert.ToDateTime(offerreader["otsDeliveryDate"].ToString());
                        else
                            offer.OTSDeliveryDate = null;

                        if (offerreader["POReceivedInDate"] != DBNull.Value)
                            offer.POReceivedInDate = Convert.ToDateTime(offerreader["POReceivedInDate"].ToString());
                        else
                            offer.POReceivedInDate = null;

                        offer.Rfq = offerreader["Rfq"].ToString();
                        offer.Comments = offerreader["Comments"].ToString();
                        offer.Currency = new Currency { IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString()), Name = offerreader["CurrencyName"].ToString() };

                        if (offerreader["ModifiedIn"].ToString() == "01/01/1000 0:00:00")
                        {
                            offer.ModifiedIn = null;
                        }
                        else
                        {
                            offer.ModifiedIn = Convert.ToDateTime(offerreader["ModifiedIn"].ToString());
                        }

                        if (offerreader["CreatedIn"] != DBNull.Value)
                            offer.CreatedIn = Convert.ToDateTime(offerreader["CreatedIn"].ToString());

                        if (offerreader["IdCarOEM"] != DBNull.Value)
                            offer.IdCarOEM = Convert.ToInt32(offerreader["IdCarOEM"].ToString());

                        if (offerreader["OfferedBy"] != DBNull.Value)
                        {
                            offer.OfferedBy = Convert.ToInt32(offerreader["OfferedBy"]);
                            offer.OfferedByPerson = new People { IdPerson = Convert.ToInt32(offer.OfferedBy), Name = Convert.ToString(offerreader["OfferedByName"]), Surname = Convert.ToString(offerreader["OfferedBySurName"]), Email = Convert.ToString(offerreader["OfferedByEmail"]) };
                        }

                        if (offerreader["IsManualCategory"] != DBNull.Value)
                        {
                            offer.IsManualCategory = Convert.ToSByte(offerreader["IsManualCategory"]);
                        }

                        if (offerreader["IdProductCategory"] != DBNull.Value)
                        {
                            offer.IdProductCategory = Convert.ToInt64(offerreader["IdProductCategory"]);
                        }

                        if (offerreader["IdProductCategory"] != DBNull.Value)
                        {
                            offer.ProductCategory = new ProductCategory();

                            offer.ProductCategory.IdProductCategory = Convert.ToInt64(offerreader["IdProductCategory"]);
                            offer.ProductCategory.Name = offerreader["ProductSubCategory"].ToString();

                            if (offerreader["IdProductCategory"] != DBNull.Value)
                            {
                                offer.ProductCategory.Category = new ProductCategory();
                                if (offerreader["IdCategory"] != DBNull.Value)
                                    offer.ProductCategory.Category.IdProductCategory = Convert.ToInt64(offerreader["IdCategory"].ToString());
                                offer.ProductCategory.Category.Name = offerreader["ProductCategory"].ToString();
                            }
                        }

                        if (offerreader["AssignedTo"] != DBNull.Value)
                        {
                            offer.AssignedTo = Convert.ToInt32(offerreader["AssignedTo"]);
                            offer.AssignedToPerson = new People { IdPerson = Convert.ToInt32(offer.AssignedTo), Name = Convert.ToString(offerreader["AssignedName"]), Surname = Convert.ToString(offerreader["AssignedSurName"]), Email = Convert.ToString(offerreader["AssignedEmail"]) };
                        }

                        if (offerreader["OfferValue"] != DBNull.Value)
                            offer.OfferValue = Convert.ToDouble(offerreader["OfferValue"].ToString());

                        if (offerreader["IdOfferCurrency"] != DBNull.Value)
                            offer.IdOfferCurrency = Convert.ToByte(offerreader["IdOfferCurrency"].ToString());

                        offer.OptionsByOffers = new List<OptionsByOffer>();
                        using (MySqlConnection conoptionsbyoffer = new MySqlConnection(company.ConnectPlantConstr))
                        {
                            conoptionsbyoffer.Open();
                            MySqlCommand conoptionsbyoffercommand = new MySqlCommand("optionsbyoffer_GetOptionsByOfferId", conoptionsbyoffer);
                            conoptionsbyoffercommand.CommandType = CommandType.StoredProcedure;
                            conoptionsbyoffercommand.Parameters.AddWithValue("_offerId", offer.IdOffer);
                            using (MySqlDataReader optionsbyofferreader = conoptionsbyoffercommand.ExecuteReader())
                            {
                                while (optionsbyofferreader.Read())
                                {

                                    OptionsByOffer optionsbyoffer = new OptionsByOffer();
                                    optionsbyoffer.IdOffer = Convert.ToInt64(optionsbyofferreader["IdOffer"].ToString());
                                    optionsbyoffer.IdOption = Convert.ToInt64(optionsbyofferreader["IdOption"].ToString());
                                    if (optionsbyofferreader["Quantity"] != DBNull.Value)
                                    {
                                        optionsbyoffer.Quantity = Convert.ToInt32(optionsbyofferreader["Quantity"].ToString());
                                        if (optionsbyoffer.Quantity > 0)
                                            optionsbyoffer.IsSelected = true;
                                        else
                                            optionsbyoffer.IsSelected = false;
                                    }
                                    else
                                    {
                                        optionsbyoffer.IsSelected = false;
                                    }
                                    optionsbyoffer.OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(optionsbyofferreader["IdOption"].ToString()), Name = optionsbyofferreader["offeroption"].ToString(), OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(optionsbyofferreader["IdOfferOptionType"].ToString()), Name = optionsbyofferreader["offeroptiontype"].ToString() } };

                                    if (offer.OptionsByOffers.Any(obo => obo.IdOffer == optionsbyoffer.IdOffer && obo.IdOption == optionsbyoffer.IdOption))
                                    {

                                    }
                                    else
                                    {
                                        offer.OptionsByOffers.Add(optionsbyoffer);
                                    }
                                }
                            }


                            if (offer.OptionsByOffers.Any(x => x.IdOption == 25))
                            {
                                List<Quotation> quotationByIdOffer = GetOfferQuotationByIdOffer(offer.IdOffer, company.ConnectPlantConstr).ToList();

                                Quotation quot = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == 23);

                                if (quot != null)
                                {
                                    EngineeringAnalysis engineeringAnalysis = new EngineeringAnalysis();
                                    Ots ot = GetOTByQuotationId(quot, company.ConnectPlantConstr);

                                    if (ot != null)
                                    {
                                        engineeringAnalysis.DueDate = ot.DeliveryDate.Value;

                                        List<OtItem> otitems = GetOtItemsByIdOT(ot, company.ConnectPlantConstr);
                                        if (otitems.Count > 0)
                                        {
                                            engineeringAnalysis.Comments = otitems[0].CustomerComment;

                                            //If Analysis status is shipped then iscompleted is true.
                                            if (otitems[0].Status.IdItemOtStatus == 10)
                                            {
                                                engineeringAnalysis.IsCompleted = true;
                                            }
                                        }
                                    }

                                    engineeringAnalysis.Attachments = new List<Attachment>();

                                    string path = workingOrdersPath + @"\" + offer.Year + @"\" + offer.Code + @"\01 Project Specifications\";
                                    if (Directory.Exists(path))
                                    {
                                        string[] files = Directory.GetFiles(path);

                                        foreach (string file in files)
                                        {
                                            Attachment attachment = new Attachment();
                                            attachment.OriginalFileName = Path.GetFileName(file);
                                            attachment.FilePath = Path.GetFullPath(file);
                                            engineeringAnalysis.Attachments.Add(attachment);
                                        }
                                    }

                                    offer.EngineeringAnalysis = engineeringAnalysis;
                                }
                            }
                        }

                        offer.OfferStatusTracking = new List<OfferStatusTracking>();
                        using (MySqlConnection conofferstatus = new MySqlConnection(company.ConnectPlantConstr))
                        {
                            conofferstatus.Open();
                            MySqlCommand conofferstatuscommand = new MySqlCommand("offerstatustracking_GetOfferStatusTrackingByIdOffer", conofferstatus);
                            conofferstatuscommand.CommandType = CommandType.StoredProcedure;
                            conofferstatuscommand.Parameters.AddWithValue("_idOffer", offer.IdOffer);
                            using (MySqlDataReader offerstatusreader = conofferstatuscommand.ExecuteReader())
                            {
                                while (offerstatusreader.Read())
                                {
                                    if (offer.OfferStatusTracking.Any(ofs => ofs.SalesStatusType.IdSalesStatusType == Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString())))
                                    {
                                        OfferStatusTracking offerStatusTrackingtemp = offer.OfferStatusTracking.Where(ofs => ofs.SalesStatusType.IdSalesStatusType == Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString())).FirstOrDefault();
                                        offerStatusTrackingtemp.IdOfferStatusTracking = Convert.ToInt64(offerstatusreader["IdOfferStatusTracking"].ToString());
                                        offerStatusTrackingtemp.IdOffer = Convert.ToInt64(offerstatusreader["IdOffer"].ToString());
                                        offerStatusTrackingtemp.IdOfferStatusType = Convert.ToInt64(offerstatusreader["IdOfferStatusType"].ToString());
                                        offerStatusTrackingtemp.SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString()), Name = offerstatusreader["Name"].ToString(), HtmlColor = offerstatusreader["HtmlColor"].ToString() };
                                        offerStatusTrackingtemp.StartDate = Convert.ToDateTime(offerstatusreader["StartDate"].ToString());

                                        if (offerstatusreader["EndDate"] != DBNull.Value)
                                        {
                                            offerStatusTrackingtemp.EndDate = offerstatusreader["EndDate"].ToString();
                                        }
                                        else
                                        {
                                            offerStatusTrackingtemp.EndDate = DateTime.Now.ToString();
                                        }

                                        try
                                        {
                                            offerStatusTrackingtemp.NoOfDays = offerStatusTrackingtemp.NoOfDays + (Convert.ToDateTime(Convert.ToDateTime(offerStatusTrackingtemp.EndDate).ToString("yyyy-MM-dd")) - Convert.ToDateTime(offerStatusTrackingtemp.StartDate.ToString("yyyy-MM-dd"))).TotalDays;
                                        }
                                        catch (Exception ex)
                                        {

                                        }
                                    }
                                    else
                                    {
                                        OfferStatusTracking offerStatusTracking = new OfferStatusTracking();
                                        offerStatusTracking.IdOfferStatusTracking = Convert.ToInt64(offerstatusreader["IdOfferStatusTracking"].ToString());
                                        offerStatusTracking.IdOffer = Convert.ToInt64(offerstatusreader["IdOffer"].ToString());
                                        offerStatusTracking.IdOfferStatusType = Convert.ToInt64(offerstatusreader["IdOfferStatusType"].ToString());
                                        offerStatusTracking.SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString()), Name = offerstatusreader["Name"].ToString(), HtmlColor = offerstatusreader["HtmlColor"].ToString() };
                                        offerStatusTracking.StartDate = Convert.ToDateTime(offerstatusreader["StartDate"].ToString());

                                        if (offerstatusreader["EndDate"] != DBNull.Value)
                                        {
                                            offerStatusTracking.EndDate = offerstatusreader["EndDate"].ToString();
                                        }
                                        else
                                        {
                                            offerStatusTracking.EndDate = DateTime.Now.ToString();
                                        }

                                        try
                                        {
                                            offerStatusTracking.NoOfDays = (Convert.ToDateTime(Convert.ToDateTime(offerStatusTracking.EndDate).ToString("yyyy-MM-dd")) - Convert.ToDateTime(offerStatusTracking.StartDate.ToString("yyyy-MM-dd"))).TotalDays;
                                        }
                                        catch (Exception ex)
                                        {

                                        }

                                        offer.OfferStatusTracking.Add(offerStatusTracking);
                                    }
                                }
                            }
                        }
                    }
                }
            }


            return offer;
        }



        /// <summary>
        /// This method is to get dashboard details company wise
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="companyDetails">Get company details</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>Offer details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offer = mgr.GetDashboardDetailsCompanyWise(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission);
        ///          SP :-  sites_GetForecastedByCustomer,sites_GetSalesByCustomer,sites_GetQuotedByCustomer,sites_GetQualifiedByCustomer,sites_GetRFQByCustomer
        ///     }
        /// }
        /// </code>
        /// </example>  
        public Offer GetDashboardDetailsCompanyWise(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission)
        {


            List<CustomerPurchaseOrder> customerSales = new List<CustomerPurchaseOrder>();
            List<CustomerPurchaseOrder> customerforecasted = new List<CustomerPurchaseOrder>();
            List<CustomerPurchaseOrder> customerQualified = new List<CustomerPurchaseOrder>();
            List<CustomerPurchaseOrder> customerRFQ = new List<CustomerPurchaseOrder>();
            List<CustomerPurchaseOrder> customerQuoted = new List<CustomerPurchaseOrder>();

            using (MySqlConnection concustomerforecast = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                concustomerforecast.Open();
                MySqlCommand concustomerforecastcommand = new MySqlCommand("sites_GetForecastedByCustomer", concustomerforecast);
                concustomerforecastcommand.CommandType = CommandType.StoredProcedure;
                concustomerforecastcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concustomerforecastcommand.Parameters.AddWithValue("_idUser", idUser);
                concustomerforecastcommand.Parameters.AddWithValue("_idZone", idZone);
                concustomerforecastcommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                concustomerforecastcommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader customerforecastreader = concustomerforecastcommand.ExecuteReader())
                {
                    while (customerforecastreader.Read())
                    {
                        CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                        customerPurchaseOrder.Offer = new Offer { IdCustomer = Convert.ToInt32(customerforecastreader["idCustomer"].ToString()) };
                        customerPurchaseOrder.Year = customerforecastreader["ForecastedYear"].ToString();
                        customerPurchaseOrder.Quarter = customerforecastreader["ForecastedQuarter"].ToString();
                        customerPurchaseOrder.Value = Convert.ToDouble(customerforecastreader["ForecastedAmount"].ToString());
                        customerPurchaseOrder.Currency = new Currency { Name = customerforecastreader["ForecastedCurrency"].ToString() };
                        customerforecasted.Add(customerPurchaseOrder);
                    }
                }
            }
            using (MySqlConnection concustomerSales = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                concustomerSales.Open();
                MySqlCommand concustomerSalescommand = new MySqlCommand("sites_GetSalesByCustomer", concustomerSales);
                concustomerSalescommand.CommandType = CommandType.StoredProcedure;
                concustomerSalescommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concustomerSalescommand.Parameters.AddWithValue("_idUser", idUser);
                concustomerSalescommand.Parameters.AddWithValue("_idZone", idZone);
                concustomerSalescommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                concustomerSalescommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader customerSalesreader = concustomerSalescommand.ExecuteReader())
                {
                    while (customerSalesreader.Read())
                    {
                        CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                        customerPurchaseOrder.Offer = new Offer { IdCustomer = Convert.ToInt32(customerSalesreader["idCustomer"].ToString()) };
                        customerPurchaseOrder.Year = customerSalesreader["SalesYear"].ToString();
                        customerPurchaseOrder.Quarter = customerSalesreader["SalesQuarter"].ToString();
                        customerPurchaseOrder.Value = Convert.ToDouble(customerSalesreader["OfferAmount"].ToString());
                        customerPurchaseOrder.Currency = new Currency { Name = customerSalesreader["OfferCurrency"].ToString() };
                        customerSales.Add(customerPurchaseOrder);
                    }
                }
            }
            using (MySqlConnection concustomerQuoted = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                concustomerQuoted.Open();
                MySqlCommand concustomerQuotedcommand = new MySqlCommand("sites_GetQuotedByCustomer", concustomerQuoted);
                concustomerQuotedcommand.CommandType = CommandType.StoredProcedure;
                concustomerQuotedcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concustomerQuotedcommand.Parameters.AddWithValue("_idUser", idUser);
                concustomerQuotedcommand.Parameters.AddWithValue("_idZone", idZone);
                concustomerQuotedcommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                concustomerQuotedcommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader customerQuotedreader = concustomerQuotedcommand.ExecuteReader())
                {
                    while (customerQuotedreader.Read())
                    {
                        CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                        customerPurchaseOrder.Offer = new Offer { IdCustomer = Convert.ToInt32(customerQuotedreader["idCustomer"].ToString()) };
                        customerPurchaseOrder.Year = customerQuotedreader["QuotedYear"].ToString();
                        customerPurchaseOrder.Quarter = customerQuotedreader["QuotedQuarter"].ToString();
                        customerPurchaseOrder.Value = Convert.ToDouble(customerQuotedreader["QuotedAmount"].ToString());
                        customerPurchaseOrder.Currency = new Currency { Name = customerQuotedreader["QuotedCurrency"].ToString() };
                        customerQuoted.Add(customerPurchaseOrder);
                    }
                }
            }

            using (MySqlConnection concustomerforecast = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                concustomerforecast.Open();
                MySqlCommand concustomerforecastcommand = new MySqlCommand("sites_GetQualifiedByCustomer", concustomerforecast);
                concustomerforecastcommand.CommandType = CommandType.StoredProcedure;
                concustomerforecastcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concustomerforecastcommand.Parameters.AddWithValue("_idUser", idUser);
                concustomerforecastcommand.Parameters.AddWithValue("_idZone", idZone);
                concustomerforecastcommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                concustomerforecastcommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader customerforecastreader = concustomerforecastcommand.ExecuteReader())
                {
                    while (customerforecastreader.Read())
                    {
                        CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                        customerPurchaseOrder.Offer = new Offer { IdCustomer = Convert.ToInt32(customerforecastreader["idCustomer"].ToString()) };
                        customerPurchaseOrder.Year = customerforecastreader["QualifiedYear"].ToString();
                        customerPurchaseOrder.Quarter = customerforecastreader["QualifiedQuarter"].ToString();
                        customerPurchaseOrder.Value = Convert.ToDouble(customerforecastreader["QualifiedAmount"].ToString());
                        customerPurchaseOrder.Currency = new Currency { Name = customerforecastreader["QualifiedCurrency"].ToString() };
                        customerQualified.Add(customerPurchaseOrder);
                    }
                }
            }

            using (MySqlConnection concustomerforecast = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                concustomerforecast.Open();
                MySqlCommand concustomerforecastcommand = new MySqlCommand("sites_GetRFQByCustomer", concustomerforecast);
                concustomerforecastcommand.CommandType = CommandType.StoredProcedure;
                concustomerforecastcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concustomerforecastcommand.Parameters.AddWithValue("_idUser", idUser);
                concustomerforecastcommand.Parameters.AddWithValue("_idZone", idZone);
                concustomerforecastcommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                concustomerforecastcommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader customerforecastreader = concustomerforecastcommand.ExecuteReader())
                {
                    while (customerforecastreader.Read())
                    {
                        CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                        customerPurchaseOrder.Offer = new Offer { IdCustomer = Convert.ToInt32(customerforecastreader["idCustomer"].ToString()) };
                        customerPurchaseOrder.Year = customerforecastreader["RFQYear"].ToString();
                        customerPurchaseOrder.Quarter = customerforecastreader["RFQQuarter"].ToString();
                        customerPurchaseOrder.Value = Convert.ToDouble(customerforecastreader["RFQAmount"].ToString());
                        customerPurchaseOrder.Currency = new Currency { Name = customerforecastreader["RFQCurrency"].ToString() };
                        customerRFQ.Add(customerPurchaseOrder);
                    }
                }
            }


            Offer offertarget = new Offer();
            offertarget.QualifiedByCustomers = customerQualified.ToList();
            offertarget.RFQByCustomers = customerRFQ.ToList();
            offertarget.ForecastedByCustomers = customerforecasted.ToList();
            offertarget.QuotedByCustomers = customerQuoted.ToList();
            offertarget.SalesByCustomers = customerSales.ToList();

            return offertarget;

        }


        /// <summary>
        /// This method is to get list of offer
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          offer = mgr.GetTargetByCustomer(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Int32 idUserPermission);
        ///          SP :-  sites_GetTargetByCustomer
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<Offer> GetTargetByCustomer(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Int32 idUserPermission)
        {
            List<Offer> offers = new List<Offer>();
            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();
                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetTargetByCustomer", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;
                conoffertargetcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);
                conoffertargetcommand.Parameters.AddWithValue("_idZone", idZone);
                conoffertargetcommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conoffertargetcommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {
                        Offer offertarget = new Offer();
                        offertarget.Site = new Company { IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString()), Name = offertargetreader["CustomerName"].ToString(), Country = new Country { Name = offertargetreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offertargetreader["CustomerZone"].ToString() } }, Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } } };

                        offertarget.QualifiedByCustomers = new List<CustomerPurchaseOrder>();
                        offertarget.TotalQualified = 0.00;

                        offertarget.RFQByCustomers = new List<CustomerPurchaseOrder>();
                        offertarget.TotalRFQ = 0.00;

                        offertarget.ForecastedByCustomers = new List<CustomerPurchaseOrder>();
                        offertarget.TotalForecasted = 0.00;

                        offertarget.QuotedByCustomers = new List<CustomerPurchaseOrder>();
                        offertarget.TotalQuotated = 0.00;

                        offertarget.SalesByCustomers = new List<CustomerPurchaseOrder>();
                        offertarget.TotalSales = 0.00;

                        if (offertargetreader["TargetSalesAmount"] != DBNull.Value)
                        {
                            offertarget.Site.SalesTargetBySite = new SalesTargetBySite
                            {
                                TargetAmount = Convert.ToDecimal(offertargetreader["TargetSalesAmount"].ToString()),
                                Currency = new Currency { Name = offertargetreader["TargetSalesCurrency"].ToString() }
                            };
                            double sales = offertarget.TotalSales.Value;
                            double targetAmount = Convert.ToDouble(offertarget.Site.SalesTargetBySite.TargetAmount);
                            if (targetAmount != 0)
                                offertarget.Site.SalesTargetBySite.TargetPercentage = Math.Round((sales / targetAmount) * 100, 2);
                            else
                                offertarget.Site.SalesTargetBySite.TargetPercentage = 0;
                        }

                        offers.Add(offertarget);
                    }

                }
            }
            return offers;
        }

        /// <summary>
        /// This method is to get offer details
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="companyDetails">Get company details</param>
        /// <returns>Offer details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          offer = mgr.GetSelectedUsersDashboardDetailsCompanyWise(byte idCurrency, Int64 accountingYear, string idUser, Company companyDetails);
        ///          SP :-  sites_GetSelectedUsersForecastedByCustomer,sites_GetSelectedUsersSalesByCustomer,sites_GetSelectedUserQuotedByCustomer,sites_GetSelectedUsersQualifiedByCustomer,sites_GetSelectedUsersRFQByCustomer,
        ///     }
        /// }
        /// </code>
        /// </example>  
        public Offer GetSelectedUsersDashboardDetailsCompanyWise(byte idCurrency, Int64 accountingYear, string idUser, Company companyDetails)
        {
            List<CustomerPurchaseOrder> customerSales = new List<CustomerPurchaseOrder>();
            List<CustomerPurchaseOrder> customerforecasted = new List<CustomerPurchaseOrder>();
            List<CustomerPurchaseOrder> customerQualified = new List<CustomerPurchaseOrder>();
            List<CustomerPurchaseOrder> customerRFQ = new List<CustomerPurchaseOrder>();
            List<CustomerPurchaseOrder> customerQuoted = new List<CustomerPurchaseOrder>();

            using (MySqlConnection concustomerforecast = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                concustomerforecast.Open();
                MySqlCommand concustomerforecastcommand = new MySqlCommand("sites_GetSelectedUsersForecastedByCustomer", concustomerforecast);
                concustomerforecastcommand.CommandType = CommandType.StoredProcedure;
                concustomerforecastcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concustomerforecastcommand.Parameters.AddWithValue("_idUser", idUser);
                concustomerforecastcommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                using (MySqlDataReader customerforecastreader = concustomerforecastcommand.ExecuteReader())
                {
                    while (customerforecastreader.Read())
                    {
                        CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                        customerPurchaseOrder.Offer = new Offer { IdCustomer = Convert.ToInt32(customerforecastreader["idCustomer"].ToString()) };
                        customerPurchaseOrder.Year = customerforecastreader["ForecastedYear"].ToString();
                        customerPurchaseOrder.Quarter = customerforecastreader["ForecastedQuarter"].ToString();
                        customerPurchaseOrder.Value = Convert.ToDouble(customerforecastreader["ForecastedAmount"].ToString());
                        customerPurchaseOrder.Currency = new Currency { Name = customerforecastreader["ForecastedCurrency"].ToString() };
                        customerforecasted.Add(customerPurchaseOrder);
                    }
                }
            }
            using (MySqlConnection concustomerSales = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                concustomerSales.Open();
                MySqlCommand concustomerSalescommand = new MySqlCommand("sites_GetSelectedUsersSalesByCustomer", concustomerSales);
                concustomerSalescommand.CommandType = CommandType.StoredProcedure;
                concustomerSalescommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concustomerSalescommand.Parameters.AddWithValue("_idUser", idUser);
                concustomerSalescommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                using (MySqlDataReader customerSalesreader = concustomerSalescommand.ExecuteReader())
                {
                    while (customerSalesreader.Read())
                    {
                        CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                        customerPurchaseOrder.Offer = new Offer { IdCustomer = Convert.ToInt32(customerSalesreader["idCustomer"].ToString()) };
                        customerPurchaseOrder.Year = customerSalesreader["SalesYear"].ToString();
                        customerPurchaseOrder.Quarter = customerSalesreader["SalesQuarter"].ToString();
                        customerPurchaseOrder.Value = Convert.ToDouble(customerSalesreader["OfferAmount"].ToString());
                        customerPurchaseOrder.Currency = new Currency { Name = customerSalesreader["OfferCurrency"].ToString() };
                        customerSales.Add(customerPurchaseOrder);
                    }
                }
            }
            using (MySqlConnection concustomerQuoted = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                concustomerQuoted.Open();
                MySqlCommand concustomerQuotedcommand = new MySqlCommand("sites_GetSelectedUserQuotedByCustomer", concustomerQuoted);
                concustomerQuotedcommand.CommandType = CommandType.StoredProcedure;
                concustomerQuotedcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concustomerQuotedcommand.Parameters.AddWithValue("_idUser", idUser);
                concustomerQuotedcommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                using (MySqlDataReader customerQuotedreader = concustomerQuotedcommand.ExecuteReader())
                {
                    while (customerQuotedreader.Read())
                    {
                        CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                        customerPurchaseOrder.Offer = new Offer { IdCustomer = Convert.ToInt32(customerQuotedreader["idCustomer"].ToString()) };
                        customerPurchaseOrder.Year = customerQuotedreader["QuotedYear"].ToString();
                        customerPurchaseOrder.Quarter = customerQuotedreader["QuotedQuarter"].ToString();
                        customerPurchaseOrder.Value = Convert.ToDouble(customerQuotedreader["QuotedAmount"].ToString());
                        customerPurchaseOrder.Currency = new Currency { Name = customerQuotedreader["QuotedCurrency"].ToString() };
                        customerQuoted.Add(customerPurchaseOrder);
                    }
                }
            }

            using (MySqlConnection concustomerforecast = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                concustomerforecast.Open();
                MySqlCommand concustomerforecastcommand = new MySqlCommand("sites_GetSelectedUsersQualifiedByCustomer", concustomerforecast);
                concustomerforecastcommand.CommandType = CommandType.StoredProcedure;
                concustomerforecastcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concustomerforecastcommand.Parameters.AddWithValue("_idUser", idUser);
                concustomerforecastcommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                using (MySqlDataReader customerforecastreader = concustomerforecastcommand.ExecuteReader())
                {
                    while (customerforecastreader.Read())
                    {
                        CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                        customerPurchaseOrder.Offer = new Offer { IdCustomer = Convert.ToInt32(customerforecastreader["idCustomer"].ToString()) };
                        customerPurchaseOrder.Year = customerforecastreader["QualifiedYear"].ToString();
                        customerPurchaseOrder.Quarter = customerforecastreader["QualifiedQuarter"].ToString();
                        customerPurchaseOrder.Value = Convert.ToDouble(customerforecastreader["QualifiedAmount"].ToString());
                        customerPurchaseOrder.Currency = new Currency { Name = customerforecastreader["QualifiedCurrency"].ToString() };
                        customerQualified.Add(customerPurchaseOrder);
                    }
                }
            }

            using (MySqlConnection concustomerforecast = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                concustomerforecast.Open();
                MySqlCommand concustomerforecastcommand = new MySqlCommand("sites_GetSelectedUsersRFQByCustomer", concustomerforecast);
                concustomerforecastcommand.CommandType = CommandType.StoredProcedure;
                concustomerforecastcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concustomerforecastcommand.Parameters.AddWithValue("_idUser", idUser);
                concustomerforecastcommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                using (MySqlDataReader customerforecastreader = concustomerforecastcommand.ExecuteReader())
                {
                    while (customerforecastreader.Read())
                    {
                        CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                        customerPurchaseOrder.Offer = new Offer { IdCustomer = Convert.ToInt32(customerforecastreader["idCustomer"].ToString()) };
                        customerPurchaseOrder.Year = customerforecastreader["RFQYear"].ToString();
                        customerPurchaseOrder.Quarter = customerforecastreader["RFQQuarter"].ToString();
                        customerPurchaseOrder.Value = Convert.ToDouble(customerforecastreader["RFQAmount"].ToString());
                        customerPurchaseOrder.Currency = new Currency { Name = customerforecastreader["RFQCurrency"].ToString() };
                        customerRFQ.Add(customerPurchaseOrder);
                    }
                }
            }

            Offer offertarget = new Offer();
            offertarget.QualifiedByCustomers = customerQualified.ToList();
            offertarget.RFQByCustomers = customerRFQ.ToList();
            offertarget.ForecastedByCustomers = customerforecasted.ToList();
            offertarget.QuotedByCustomers = customerQuoted.ToList();
            offertarget.SalesByCustomers = customerSales.ToList();

            return offertarget;

        }

        /// <summary>
        /// This method is to get list of offer
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          offers = mgr.GetSelectedUsersTargetByCustomer(string connectionstring, byte idCurrency, string idUser, Int64 accountingYear);
        ///          SP :-  sites_GetSelectedUsersTargetByCustomer
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<Offer> GetSelectedUsersTargetByCustomer(string connectionstring, byte idCurrency, string idUser, Int64 accountingYear)
        {
            List<Offer> offers = new List<Offer>();
            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();
                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetSelectedUsersTargetByCustomer", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;
                conoffertargetcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);
                conoffertargetcommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {
                        Offer offertarget = new Offer();
                        offertarget.Site = new Company { IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString()), Name = offertargetreader["CustomerName"].ToString(), Country = new Country { Name = offertargetreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offertargetreader["CustomerZone"].ToString() } }, Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } } };

                        offertarget.QualifiedByCustomers = new List<CustomerPurchaseOrder>();
                        offertarget.TotalQualified = 0.00;

                        offertarget.RFQByCustomers = new List<CustomerPurchaseOrder>();
                        offertarget.TotalRFQ = 0.00;

                        offertarget.ForecastedByCustomers = new List<CustomerPurchaseOrder>();
                        offertarget.TotalForecasted = 0.00;

                        offertarget.QuotedByCustomers = new List<CustomerPurchaseOrder>();
                        offertarget.TotalQuotated = 0.00;

                        offertarget.SalesByCustomers = new List<CustomerPurchaseOrder>();
                        offertarget.TotalSales = 0.00;

                        if (offertargetreader["TargetSalesAmount"] != DBNull.Value)
                        {
                            offertarget.Site.SalesTargetBySite = new SalesTargetBySite
                            {
                                TargetAmount = Convert.ToDecimal(offertargetreader["TargetSalesAmount"].ToString()),
                                Currency = new Currency { Name = offertargetreader["TargetSalesCurrency"].ToString() }
                            };
                            double sales = offertarget.TotalSales.Value;
                            double targetAmount = Convert.ToDouble(offertarget.Site.SalesTargetBySite.TargetAmount);
                            if (targetAmount != 0)
                                offertarget.Site.SalesTargetBySite.TargetPercentage = Math.Round((sales / targetAmount) * 100, 2);
                            else
                                offertarget.Site.SalesTargetBySite.TargetPercentage = 0;
                        }

                        offers.Add(offertarget);
                    }

                }
            }
            return offers;
        }

        /// <summary>
        /// This method is to get list of customer
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="customerLimit">Get customer limit</param>
        /// <param name="companyDetails">Get company details</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of customer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          customers = mgr.GetDashboardDetailsByCustomerCompanywiseDatatable(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Int32 customerLimit, Company companyDetails, Int32 idUserPermission);
        ///          SP :-  sites_GetTopOtherCustomersDashboardDetails
        ///     }
        /// }
        /// </code>
        /// </example>  
        public IList<Customer> GetDashboardDetailsByCustomerCompanywiseDatatable(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Int32 customerLimit, Company companyDetails, Int32 idUserPermission)
        {

            IList<Customer> customers = new List<Customer>();
            List<Company> companiesSortLst = new List<Company>();
            List<CustomerSort> Lstsort = new List<CustomerSort>();
            Customer customer = new Customer();
            DataSet ds = new DataSet();

            using (MySqlConnection conoffertarget = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conoffertarget.Open();
                MySqlCommand concompaniescommand = new MySqlCommand("sites_GetTopOtherCustomersDashboardDetails", conoffertarget);
                concompaniescommand.CommandType = CommandType.StoredProcedure;
                concompaniescommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concompaniescommand.Parameters.AddWithValue("_idUser", idUser);
                concompaniescommand.Parameters.AddWithValue("_idZone", idZone);
                concompaniescommand.Parameters.AddWithValue("_customerLimit", customerLimit);
                concompaniescommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                concompaniescommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                MySqlDataAdapter da = new MySqlDataAdapter(concompaniescommand);
                //DataSet ds = new DataSet();
                da.Fill(ds);
            }
            foreach (DataRow itemRow in ds.Tables[0].Rows)
            {
                if (customers.Any(cust => cust.IdCustomer == Convert.ToInt32(itemRow["idCustomer"].ToString())))
                {
                    Customer custold = new Customer();
                    custold = customers.Where(cust => cust.IdCustomer == Convert.ToInt32(itemRow["idCustomer"].ToString())).SingleOrDefault();
                    if (custold.Companies.Any(comp => comp.IdCompany == Convert.ToInt32(itemRow["IdSite"].ToString())))
                    {
                        Company compold = new Company();
                        compold = custold.Companies.Where(comp => comp.IdCompany == Convert.ToInt32(itemRow["IdSite"].ToString())).SingleOrDefault();
                        if (compold.SalesStatusTypes.Any(ss => ss.Name == itemRow["Name"].ToString()))
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType = compold.SalesStatusTypes.Where(ss => ss.Name == itemRow["Name"].ToString()).SingleOrDefault();
                            salesStatusType.TotalAmount = salesStatusType.TotalAmount + Convert.ToDouble(itemRow["Amount"].ToString());
                            if (salesStatusType.IdSalesStatusType == 4)
                            {
                                if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany))
                                {
                                    CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany).FirstOrDefault();
                                    custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                }
                                else
                                {
                                    CustomerSort custsort = new CustomerSort();
                                    custsort.IdCustomer = custold.IdCustomer;
                                    custsort.IdSite = compold.IdCompany;
                                    custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                    Lstsort.Add(custsort);
                                }

                            }
                        }
                        else
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                            salesStatusType.Name = itemRow["Name"].ToString();
                            salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());

                            compold.SalesStatusTypes.Add(salesStatusType);
                            if (salesStatusType.IdSalesStatusType == 4)
                            {
                                if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany))
                                {
                                    CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany).FirstOrDefault();
                                    custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                }
                                else
                                {
                                    CustomerSort custsort = new CustomerSort();
                                    custsort.IdCustomer = custold.IdCustomer;
                                    custsort.IdSite = compold.IdCompany;
                                    custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                    Lstsort.Add(custsort);
                                }
                            }
                        }

                    }
                    else
                    {
                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                        company.Name = itemRow["CustomerPlant"].ToString();
                        company.SiteNameWithoutCountry = itemRow["SiteName"].ToString();
                        company.Country = new Country { Name = itemRow["Country"].ToString() };

                        company.SalesStatusTypes = new List<SalesStatusType>() { new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["Name"].ToString(), TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString()) } };
                        if (itemRow["IdSalesStatusType"].ToString() == "4")
                        {
                            if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == company.IdCompany))
                            {
                                CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == company.IdCompany).FirstOrDefault();
                                custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                            }
                            else
                            {
                                CustomerSort custsort = new CustomerSort();
                                custsort.IdCustomer = custold.IdCustomer;
                                custsort.IdSite = company.IdCompany;
                                custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                Lstsort.Add(custsort);
                            }
                        }
                        custold.Companies.Add(company);
                    }
                }
                else
                {
                    customer = new Customer();
                    customer.IdCustomer = Convert.ToInt32(itemRow["idCustomer"].ToString());
                    customer.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                    customer.CustomerName = itemRow["CustomerGroup"].ToString();
                    customer.Companies = new List<Company>();
                    Company company = new Company();
                    company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                    company.Name = itemRow["CustomerPlant"].ToString();
                    company.SiteNameWithoutCountry = itemRow["SiteName"].ToString();
                    company.Country = new Country { Name = itemRow["Country"].ToString() };

                    company.SalesStatusTypes = new List<SalesStatusType>() { new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["Name"].ToString(), TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString()) } };
                    if (itemRow["IdSalesStatusType"].ToString() == "4")
                    {
                        if (Lstsort.Any(ls => ls.IdCustomer == customer.IdCustomer && ls.IdSite == company.IdCompany))
                        {
                            CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == customer.IdCustomer && ls.IdSite == company.IdCompany).FirstOrDefault();
                            custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                        }
                        else
                        {
                            CustomerSort custsort = new CustomerSort();
                            custsort.IdCustomer = customer.IdCustomer;
                            custsort.IdSite = company.IdCompany;
                            custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                            Lstsort.Add(custsort);
                        }
                    }

                    customer.Companies.Add(company);
                    customers.Add(customer);
                }
            }


            if (customers.Count > 0)
            {
                customers[0].CustomerSorts = new List<CustomerSort>();
                customers[0].CustomerSorts.AddRange(Lstsort);
            }

            if (ds.Tables[1].Rows.Count > 0)
            {
                if (customers.Any(cust => cust.CustomerName == "OTHERS"))
                {
                    Customer custother = customers.Where(cust => cust.CustomerName == "OTHERS").FirstOrDefault();
                    foreach (DataRow itemRow in ds.Tables[1].Rows)
                    {
                        if (custother.Companies[0].SalesStatusTypes.Any(ss => ss.Name == itemRow["Name"].ToString()))
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType = custother.Companies[0].SalesStatusTypes.Where(ss => ss.Name == itemRow["Name"].ToString()).SingleOrDefault();
                            salesStatusType.TotalAmount = salesStatusType.TotalAmount + Convert.ToDouble(itemRow["Amount"].ToString());
                        }
                        else
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                            salesStatusType.Name = itemRow["Name"].ToString();
                            salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());
                            custother.Companies[0].SalesStatusTypes.Add(salesStatusType);
                        }
                    }

                }
                else
                {
                    customer = new Customer();
                    customer.IdCustomer = 0;
                    customer.IdCompany = 0;
                    customer.CustomerName = "OTHERS";
                    customer.Companies = new List<Company>();
                    Company company = new Company();
                    company.IdCompany = 0;
                    company.Name = "";
                    company.SalesStatusTypes = new List<SalesStatusType>();
                    foreach (DataRow itemRow in ds.Tables[1].Rows)
                    {

                        SalesStatusType salesStatusType = new SalesStatusType();
                        salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                        salesStatusType.Name = itemRow["Name"].ToString();
                        salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());
                        company.SalesStatusTypes.Add(salesStatusType);
                    }
                    if (company.SalesStatusTypes.Count > 0)
                    {
                        customer.Companies.Add(company);
                        customers.Add(customer);
                    }
                }
            }

            return customers.ToList();
        }



        /// <summary>
        /// This method is to get list of customer
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYearFrom">Get accounting year From</param>
        /// <param name="accountingYearTo">Get accounting year To</param>
        /// <param name="customerLimit">Get customer limit</param>
        /// <param name="companyDetails">Get company details</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of customer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          customers = mgr.GetDashboardDetailsByCustomerCompanywiseDatatable(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Int32 customerLimit, Company companyDetails, Int32 idUserPermission);
        ///          SP :-  sites_GetTopOtherCustomersDashboardDetails
        ///     }
        /// }
        /// </code>
        /// </example>  
        public IList<Customer> GetDashboardDetailsByCustomerCompanywiseDatatable(byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Int32 customerLimit, Company companyDetails, Int32 idUserPermission)
        {

            IList<Customer> customers = new List<Customer>();
            List<Company> companiesSortLst = new List<Company>();
            List<CustomerSort> Lstsort = new List<CustomerSort>();
            Customer customer = new Customer();
            DataSet ds = new DataSet();

            using (MySqlConnection conoffertarget = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conoffertarget.Open();
                MySqlCommand concompaniescommand = new MySqlCommand("sites_GetTopOtherCustomersDashboardDetailsDateWise", conoffertarget);
                concompaniescommand.CommandType = CommandType.StoredProcedure;
                concompaniescommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concompaniescommand.Parameters.AddWithValue("_idUser", idUser);
                concompaniescommand.Parameters.AddWithValue("_idCurrentUser", idUser);
                concompaniescommand.Parameters.AddWithValue("_customerLimit", customerLimit);
                concompaniescommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                concompaniescommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                concompaniescommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                MySqlDataAdapter da = new MySqlDataAdapter(concompaniescommand);
                //DataSet ds = new DataSet();
                da.Fill(ds);
            }
            foreach (DataRow itemRow in ds.Tables[0].Rows)
            {
                if (customers.Any(cust => cust.IdCustomer == Convert.ToInt32(itemRow["idCustomer"].ToString())))
                {
                    Customer custold = new Customer();
                    custold = customers.Where(cust => cust.IdCustomer == Convert.ToInt32(itemRow["idCustomer"].ToString())).SingleOrDefault();
                    if (custold.Companies.Any(comp => comp.IdCompany == Convert.ToInt32(itemRow["IdSite"].ToString())))
                    {
                        Company compold = new Company();
                        compold = custold.Companies.Where(comp => comp.IdCompany == Convert.ToInt32(itemRow["IdSite"].ToString())).SingleOrDefault();
                        if (compold.SalesStatusTypes.Any(ss => ss.Name == itemRow["Name"].ToString()))
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType = compold.SalesStatusTypes.Where(ss => ss.Name == itemRow["Name"].ToString()).SingleOrDefault();
                            salesStatusType.TotalAmount = salesStatusType.TotalAmount + Convert.ToDouble(itemRow["Amount"].ToString());
                            if (salesStatusType.IdSalesStatusType == 4)
                            {
                                if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany))
                                {
                                    CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany).FirstOrDefault();
                                    custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                }
                                else
                                {
                                    CustomerSort custsort = new CustomerSort();
                                    custsort.IdCustomer = custold.IdCustomer;
                                    custsort.IdSite = compold.IdCompany;
                                    custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                    Lstsort.Add(custsort);
                                }

                            }
                        }
                        else
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                            salesStatusType.Name = itemRow["Name"].ToString();
                            salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());

                            compold.SalesStatusTypes.Add(salesStatusType);
                            if (salesStatusType.IdSalesStatusType == 4)
                            {
                                if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany))
                                {
                                    CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany).FirstOrDefault();
                                    custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                }
                                else
                                {
                                    CustomerSort custsort = new CustomerSort();
                                    custsort.IdCustomer = custold.IdCustomer;
                                    custsort.IdSite = compold.IdCompany;
                                    custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                    Lstsort.Add(custsort);
                                }
                            }
                        }

                    }
                    else
                    {
                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                        company.Name = itemRow["CustomerPlant"].ToString();
                        company.SiteNameWithoutCountry = itemRow["SiteName"].ToString();
                        company.Country = new Country { Name = itemRow["Country"].ToString() };

                        company.SalesStatusTypes = new List<SalesStatusType>() { new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["Name"].ToString(), TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString()) } };
                        if (itemRow["IdSalesStatusType"].ToString() == "4")
                        {
                            if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == company.IdCompany))
                            {
                                CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == company.IdCompany).FirstOrDefault();
                                custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                            }
                            else
                            {
                                CustomerSort custsort = new CustomerSort();
                                custsort.IdCustomer = custold.IdCustomer;
                                custsort.IdSite = company.IdCompany;
                                custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                Lstsort.Add(custsort);
                            }
                        }
                        custold.Companies.Add(company);
                    }
                }
                else
                {
                    customer = new Customer();
                    customer.IdCustomer = Convert.ToInt32(itemRow["idCustomer"].ToString());
                    customer.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                    customer.CustomerName = itemRow["CustomerGroup"].ToString();
                    customer.Companies = new List<Company>();
                    Company company = new Company();
                    company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                    company.Name = itemRow["CustomerPlant"].ToString();
                    company.SiteNameWithoutCountry = itemRow["SiteName"].ToString();
                    company.Country = new Country { Name = itemRow["Country"].ToString() };

                    company.SalesStatusTypes = new List<SalesStatusType>() { new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["Name"].ToString(), TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString()) } };
                    if (itemRow["IdSalesStatusType"].ToString() == "4")
                    {
                        if (Lstsort.Any(ls => ls.IdCustomer == customer.IdCustomer && ls.IdSite == company.IdCompany))
                        {
                            CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == customer.IdCustomer && ls.IdSite == company.IdCompany).FirstOrDefault();
                            custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                        }
                        else
                        {
                            CustomerSort custsort = new CustomerSort();
                            custsort.IdCustomer = customer.IdCustomer;
                            custsort.IdSite = company.IdCompany;
                            custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                            Lstsort.Add(custsort);
                        }
                    }

                    customer.Companies.Add(company);
                    customers.Add(customer);
                }
            }


            if (customers.Count > 0)
            {
                customers[0].CustomerSorts = new List<CustomerSort>();
                customers[0].CustomerSorts.AddRange(Lstsort);
            }

            if (ds.Tables[1].Rows.Count > 0)
            {
                if (customers.Any(cust => cust.CustomerName == "OTHERS"))
                {
                    Customer custother = customers.Where(cust => cust.CustomerName == "OTHERS").FirstOrDefault();
                    foreach (DataRow itemRow in ds.Tables[1].Rows)
                    {
                        if (custother.Companies[0].SalesStatusTypes.Any(ss => ss.Name == itemRow["Name"].ToString()))
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType = custother.Companies[0].SalesStatusTypes.Where(ss => ss.Name == itemRow["Name"].ToString()).SingleOrDefault();
                            salesStatusType.TotalAmount = salesStatusType.TotalAmount + Convert.ToDouble(itemRow["Amount"].ToString());
                        }
                        else
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                            salesStatusType.Name = itemRow["Name"].ToString();
                            salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());
                            custother.Companies[0].SalesStatusTypes.Add(salesStatusType);
                        }
                    }

                }
                else
                {
                    customer = new Customer();
                    customer.IdCustomer = 0;
                    customer.IdCompany = 0;
                    customer.CustomerName = "OTHERS";
                    customer.Companies = new List<Company>();
                    Company company = new Company();
                    company.IdCompany = 0;
                    company.Name = "";
                    company.SalesStatusTypes = new List<SalesStatusType>();
                    foreach (DataRow itemRow in ds.Tables[1].Rows)
                    {

                        SalesStatusType salesStatusType = new SalesStatusType();
                        salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                        salesStatusType.Name = itemRow["Name"].ToString();
                        salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());
                        company.SalesStatusTypes.Add(salesStatusType);
                    }
                    if (company.SalesStatusTypes.Count > 0)
                    {
                        customer.Companies.Add(company);
                        customers.Add(customer);
                    }
                }
            }

            return customers.ToList();
        }

        /// <summary>
        /// This method is to get list of customers
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="customerLimit">Get customer limit</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="companyDetails">Get company details</param>
        /// <returns>List of customer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          customers = mgr.GetSelectedUsersDashboardDetailsByCustomerCompanywiseDatatable(byte idCurrency, Int64 accountingYear, Int32 customerLimit, string idUser, Company companyDetails);
        ///          SP :-  sites_GetSelectedUsersTopOthersCustomersDashboardDetails
        ///     }
        /// }
        /// </code>
        /// </example>  
        public IList<Customer> GetSelectedUsersDashboardDetailsByCustomerCompanywiseDatatable(byte idCurrency, Int64 accountingYear, Int32 customerLimit, string idUser, Company companyDetails, Int32 idCurrentUser = 0)
        {

            IList<Customer> customers = new List<Customer>();
            List<Company> companiesSortLst = new List<Company>();
            List<CustomerSort> Lstsort = new List<CustomerSort>();
            Customer customer = new Customer();
            DataSet ds = new DataSet();
            using (MySqlConnection conoffertarget = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conoffertarget.Open();
                MySqlCommand concompaniescommand = new MySqlCommand("sites_GetSelectedUsersTopOthersCustomersDashboardDetails", conoffertarget);
                concompaniescommand.CommandType = CommandType.StoredProcedure;
                concompaniescommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concompaniescommand.Parameters.AddWithValue("_idUser", idUser);
                concompaniescommand.Parameters.AddWithValue("_customerLimit", customerLimit);
                concompaniescommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                concompaniescommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                MySqlDataAdapter da = new MySqlDataAdapter(concompaniescommand);
                //DataSet ds = new DataSet();
                da.Fill(ds);
            }


            foreach (DataRow itemRow in ds.Tables[0].Rows)
            {
                if (customers.Any(cust => cust.IdCustomer == Convert.ToInt32(itemRow["idCustomer"].ToString())))
                {
                    Customer custold = new Customer();
                    custold = customers.Where(cust => cust.IdCustomer == Convert.ToInt32(itemRow["idCustomer"].ToString())).SingleOrDefault();
                    if (custold.Companies.Any(comp => comp.IdCompany == Convert.ToInt32(itemRow["IdSite"].ToString())))
                    {
                        Company compold = new Company();
                        compold = custold.Companies.Where(comp => comp.IdCompany == Convert.ToInt32(itemRow["IdSite"].ToString())).SingleOrDefault();
                        if (compold.SalesStatusTypes.Any(ss => ss.Name == itemRow["Name"].ToString()))
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType = compold.SalesStatusTypes.Where(ss => ss.Name == itemRow["Name"].ToString()).SingleOrDefault();
                            salesStatusType.TotalAmount = salesStatusType.TotalAmount + Convert.ToDouble(itemRow["Amount"].ToString());
                            if (salesStatusType.IdSalesStatusType == 4)
                            {
                                if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany))
                                {
                                    CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany).FirstOrDefault();
                                    custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                }
                                else
                                {
                                    CustomerSort custsort = new CustomerSort();
                                    custsort.IdCustomer = custold.IdCustomer;
                                    custsort.IdSite = compold.IdCompany;
                                    custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                    Lstsort.Add(custsort);
                                }

                            }
                        }
                        else
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                            salesStatusType.Name = itemRow["Name"].ToString();
                            salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());

                            compold.SalesStatusTypes.Add(salesStatusType);
                            if (salesStatusType.IdSalesStatusType == 4)
                            {
                                if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany))
                                {
                                    CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany).FirstOrDefault();
                                    custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                }
                                else
                                {
                                    CustomerSort custsort = new CustomerSort();
                                    custsort.IdCustomer = custold.IdCustomer;
                                    custsort.IdSite = compold.IdCompany;
                                    custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                    Lstsort.Add(custsort);
                                }
                            }
                        }

                    }
                    else
                    {
                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                        company.Name = itemRow["CustomerPlant"].ToString();
                        company.SiteNameWithoutCountry = itemRow["SiteName"].ToString();
                        company.Country = new Country { Name = itemRow["Country"].ToString() };

                        company.SalesStatusTypes = new List<SalesStatusType>() { new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["Name"].ToString(), TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString()) } };
                        if (itemRow["IdSalesStatusType"].ToString() == "4")
                        {
                            if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == company.IdCompany))
                            {
                                CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == company.IdCompany).FirstOrDefault();
                                custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                            }
                            else
                            {
                                CustomerSort custsort = new CustomerSort();
                                custsort.IdCustomer = custold.IdCustomer;
                                custsort.IdSite = company.IdCompany;
                                custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                Lstsort.Add(custsort);
                            }
                        }
                        custold.Companies.Add(company);
                    }
                }
                else
                {
                    customer = new Customer();
                    customer.IdCustomer = Convert.ToInt32(itemRow["idCustomer"].ToString());
                    customer.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                    customer.CustomerName = itemRow["CustomerGroup"].ToString();
                    customer.Companies = new List<Company>();
                    Company company = new Company();
                    company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                    company.Name = itemRow["CustomerPlant"].ToString();
                    company.SiteNameWithoutCountry = itemRow["SiteName"].ToString();
                    company.Country = new Country { Name = itemRow["Country"].ToString() };

                    company.SalesStatusTypes = new List<SalesStatusType>() { new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["Name"].ToString(), TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString()) } };
                    if (itemRow["IdSalesStatusType"].ToString() == "4")
                    {
                        if (Lstsort.Any(ls => ls.IdCustomer == customer.IdCustomer && ls.IdSite == company.IdCompany))
                        {
                            CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == customer.IdCustomer && ls.IdSite == company.IdCompany).FirstOrDefault();
                            custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                        }
                        else
                        {
                            CustomerSort custsort = new CustomerSort();
                            custsort.IdCustomer = customer.IdCustomer;
                            custsort.IdSite = company.IdCompany;
                            custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                            Lstsort.Add(custsort);
                        }
                    }

                    customer.Companies.Add(company);
                    customers.Add(customer);
                }
            }

            if (customers.Count > 0)
            {
                customers[0].CustomerSorts = new List<CustomerSort>();
                customers[0].CustomerSorts.AddRange(Lstsort);
            }


            if (ds.Tables[1].Rows.Count > 0)
            {
                if (customers.Any(cust => cust.CustomerName == "OTHERS"))
                {
                    Customer custother = customers.Where(cust => cust.CustomerName == "OTHERS").FirstOrDefault();
                    foreach (DataRow itemRow in ds.Tables[1].Rows)
                    {
                        if (custother.Companies[0].SalesStatusTypes.Any(ss => ss.Name == itemRow["Name"].ToString()))
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType = custother.Companies[0].SalesStatusTypes.Where(ss => ss.Name == itemRow["Name"].ToString()).SingleOrDefault();
                            salesStatusType.TotalAmount = salesStatusType.TotalAmount + Convert.ToDouble(itemRow["Amount"].ToString());
                        }
                        else
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                            salesStatusType.Name = itemRow["Name"].ToString();
                            salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());
                            custother.Companies[0].SalesStatusTypes.Add(salesStatusType);
                        }
                    }

                }
                else
                {
                    customer = new Customer();
                    customer.IdCustomer = 0;
                    customer.IdCompany = 0;
                    customer.CustomerName = "OTHERS";
                    customer.Companies = new List<Company>();
                    Company company = new Company();
                    company.IdCompany = 0;
                    company.Name = "";
                    company.SalesStatusTypes = new List<SalesStatusType>();
                    foreach (DataRow itemRow in ds.Tables[1].Rows)
                    {
                        SalesStatusType salesStatusType = new SalesStatusType();
                        salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                        salesStatusType.Name = itemRow["Name"].ToString();
                        salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());
                        company.SalesStatusTypes.Add(salesStatusType);
                    }
                    if (company.SalesStatusTypes.Count > 0)
                    {
                        customer.Companies.Add(company);
                        customers.Add(customer);
                    }
                }
            }


            return customers.ToList();
        }


        /// <summary>
        /// This method is to get list of customers
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="accountingYearFrom">Get accounting year From</param>
        /// <param name="accountingYearTo">Get accounting year To</param>
        /// <param name="customerLimit">Get customer limit</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="companyDetails">Get company details</param>
        /// <returns>List of customer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          customers = mgr.GetSelectedUsersDashboardDetailsByCustomerCompanywiseDatatable(byte idCurrency, Int64 accountingYear, Int32 customerLimit, string idUser, Company companyDetails);
        ///          SP :-  sites_GetSelectedUsersTopOthersCustomersDashboardDetails
        ///     }
        /// }
        /// </code>
        /// </example>  
        public IList<Customer> GetSelectedUsersDashboardDetailsByCustomerCompanywiseDatatable(byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, Int32 customerLimit, string idUser, Company companyDetails, Int32 idCurrentUser = 0)
        {

            IList<Customer> customers = new List<Customer>();
            List<Company> companiesSortLst = new List<Company>();
            List<CustomerSort> Lstsort = new List<CustomerSort>();
            Customer customer = new Customer();
            DataSet ds = new DataSet();
            using (MySqlConnection conoffertarget = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conoffertarget.Open();
                MySqlCommand concompaniescommand = new MySqlCommand("sites_GetTopOtherCustomersDashboardDetailsDateWise", conoffertarget);
                concompaniescommand.CommandType = CommandType.StoredProcedure;
                concompaniescommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concompaniescommand.Parameters.AddWithValue("_idUser", idUser);
                concompaniescommand.Parameters.AddWithValue("_customerLimit", customerLimit);
                concompaniescommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                concompaniescommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                concompaniescommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                concompaniescommand.Parameters.AddWithValue("_idPermission", 21);

                MySqlDataAdapter da = new MySqlDataAdapter(concompaniescommand);
                //DataSet ds = new DataSet();
                da.Fill(ds);
            }


            foreach (DataRow itemRow in ds.Tables[0].Rows)
            {
                if (customers.Any(cust => cust.IdCustomer == Convert.ToInt32(itemRow["idCustomer"].ToString())))
                {
                    Customer custold = new Customer();
                    custold = customers.Where(cust => cust.IdCustomer == Convert.ToInt32(itemRow["idCustomer"].ToString())).SingleOrDefault();
                    if (custold.Companies.Any(comp => comp.IdCompany == Convert.ToInt32(itemRow["IdSite"].ToString())))
                    {
                        Company compold = new Company();
                        compold = custold.Companies.Where(comp => comp.IdCompany == Convert.ToInt32(itemRow["IdSite"].ToString())).SingleOrDefault();
                        if (compold.SalesStatusTypes.Any(ss => ss.Name == itemRow["Name"].ToString()))
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType = compold.SalesStatusTypes.Where(ss => ss.Name == itemRow["Name"].ToString()).SingleOrDefault();
                            salesStatusType.TotalAmount = salesStatusType.TotalAmount + Convert.ToDouble(itemRow["Amount"].ToString());
                            if (salesStatusType.IdSalesStatusType == 4)
                            {
                                if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany))
                                {
                                    CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany).FirstOrDefault();
                                    custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                }
                                else
                                {
                                    CustomerSort custsort = new CustomerSort();
                                    custsort.IdCustomer = custold.IdCustomer;
                                    custsort.IdSite = compold.IdCompany;
                                    custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                    Lstsort.Add(custsort);
                                }

                            }
                        }
                        else
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                            salesStatusType.Name = itemRow["Name"].ToString();
                            salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());

                            compold.SalesStatusTypes.Add(salesStatusType);
                            if (salesStatusType.IdSalesStatusType == 4)
                            {
                                if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany))
                                {
                                    CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany).FirstOrDefault();
                                    custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                }
                                else
                                {
                                    CustomerSort custsort = new CustomerSort();
                                    custsort.IdCustomer = custold.IdCustomer;
                                    custsort.IdSite = compold.IdCompany;
                                    custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                    Lstsort.Add(custsort);
                                }
                            }
                        }

                    }
                    else
                    {
                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                        company.Name = itemRow["CustomerPlant"].ToString();
                        company.SiteNameWithoutCountry = itemRow["SiteName"].ToString();
                        company.Country = new Country { Name = itemRow["Country"].ToString() };

                        company.SalesStatusTypes = new List<SalesStatusType>() { new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["Name"].ToString(), TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString()) } };
                        if (itemRow["IdSalesStatusType"].ToString() == "4")
                        {
                            if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == company.IdCompany))
                            {
                                CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == company.IdCompany).FirstOrDefault();
                                custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                            }
                            else
                            {
                                CustomerSort custsort = new CustomerSort();
                                custsort.IdCustomer = custold.IdCustomer;
                                custsort.IdSite = company.IdCompany;
                                custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                Lstsort.Add(custsort);
                            }
                        }
                        custold.Companies.Add(company);
                    }
                }
                else
                {
                    customer = new Customer();
                    customer.IdCustomer = Convert.ToInt32(itemRow["idCustomer"].ToString());
                    customer.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                    customer.CustomerName = itemRow["CustomerGroup"].ToString();
                    customer.Companies = new List<Company>();
                    Company company = new Company();
                    company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                    company.Name = itemRow["CustomerPlant"].ToString();
                    company.SiteNameWithoutCountry = itemRow["SiteName"].ToString();
                    company.Country = new Country { Name = itemRow["Country"].ToString() };

                    company.SalesStatusTypes = new List<SalesStatusType>() { new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["Name"].ToString(), TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString()) } };
                    if (itemRow["IdSalesStatusType"].ToString() == "4")
                    {
                        if (Lstsort.Any(ls => ls.IdCustomer == customer.IdCustomer && ls.IdSite == company.IdCompany))
                        {
                            CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == customer.IdCustomer && ls.IdSite == company.IdCompany).FirstOrDefault();
                            custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                        }
                        else
                        {
                            CustomerSort custsort = new CustomerSort();
                            custsort.IdCustomer = customer.IdCustomer;
                            custsort.IdSite = company.IdCompany;
                            custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                            Lstsort.Add(custsort);
                        }
                    }

                    customer.Companies.Add(company);
                    customers.Add(customer);
                }
            }

            if (customers.Count > 0)
            {
                customers[0].CustomerSorts = new List<CustomerSort>();
                customers[0].CustomerSorts.AddRange(Lstsort);
            }


            if (ds.Tables[1].Rows.Count > 0)
            {
                if (customers.Any(cust => cust.CustomerName == "OTHERS"))
                {
                    Customer custother = customers.Where(cust => cust.CustomerName == "OTHERS").FirstOrDefault();
                    foreach (DataRow itemRow in ds.Tables[1].Rows)
                    {
                        if (custother.Companies[0].SalesStatusTypes.Any(ss => ss.Name == itemRow["Name"].ToString()))
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType = custother.Companies[0].SalesStatusTypes.Where(ss => ss.Name == itemRow["Name"].ToString()).SingleOrDefault();
                            salesStatusType.TotalAmount = salesStatusType.TotalAmount + Convert.ToDouble(itemRow["Amount"].ToString());
                        }
                        else
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                            salesStatusType.Name = itemRow["Name"].ToString();
                            salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());
                            custother.Companies[0].SalesStatusTypes.Add(salesStatusType);
                        }
                    }

                }
                else
                {
                    customer = new Customer();
                    customer.IdCustomer = 0;
                    customer.IdCompany = 0;
                    customer.CustomerName = "OTHERS";
                    customer.Companies = new List<Company>();
                    Company company = new Company();
                    company.IdCompany = 0;
                    company.Name = "";
                    company.SalesStatusTypes = new List<SalesStatusType>();
                    foreach (DataRow itemRow in ds.Tables[1].Rows)
                    {
                        SalesStatusType salesStatusType = new SalesStatusType();
                        salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                        salesStatusType.Name = itemRow["Name"].ToString();
                        salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());
                        company.SalesStatusTypes.Add(salesStatusType);
                    }
                    if (company.SalesStatusTypes.Count > 0)
                    {
                        customer.Companies.Add(company);
                        customers.Add(customer);
                    }
                }
            }


            return customers.ToList();
        }

        private Customer GetAllOtherCustomerAmountStatusWise(List<Customer> customerLst, string connectionstring, IList<Customer> customers)
        {
            Customer customer = new Customer();
            customer.IdCustomer = 0;
            customer.IdCompany = 0;
            customer.CustomerName = "OTHERS";
            customer.Companies = new List<Company>();
            Company company = new Company();
            company.IdCompany = 0;
            company.Name = "";
            company.SalesTargetBySite = new SalesTargetBySite();
            company.SalesTargetBySite.TargetAmount = 0;
            company.SalesStatusTypes = new List<SalesStatusType>();
            foreach (SalesStatusType item in GetAllSalesStatusType(connectionstring))
            {
                SalesStatusType salesStatusType = new SalesStatusType();
                salesStatusType.Name = item.Name;

                salesStatusType.TotalAmount = 0;
                company.SalesStatusTypes.Add(salesStatusType);
            }
            foreach (Customer itemCustomer in customerLst)
            {

                foreach (SalesStatusType item in GetAllSalesStatusType(connectionstring))
                {
                    SalesStatusType salesStatusType = company.SalesStatusTypes.Where(sstype => sstype.Name == item.Name).FirstOrDefault();

                    salesStatusType.TotalAmount = salesStatusType.TotalAmount + Convert.ToDouble(itemCustomer.Companies[0].SalesStatusTypes.Where(sst => sst.Name == item.Name).Select(sstamt => sstamt.TotalAmount).ToList().Sum());
                }

                company.SalesTargetBySite.TargetAmount = company.SalesTargetBySite.TargetAmount + Convert.ToDecimal(itemCustomer.Companies[0].SalesTargetBySite.TargetAmount);
            }

            customer.Companies.Add(company);
            return customer;
        }

        /// <summary>
        /// This method is to get lost reasons by offer
        /// </summary>
        /// <param name="idOffer">Get offer id</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>Lost reasons by offer details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          LostReasonsByOffer lostReasonsByOffer = mgr.GetLostReasonsByOffer(Int64 idOffer, string connectionstring);
        ///          SP :-  GetlostReasonsByOffer
        ///     }
        /// }
        /// </code>
        /// </example>  
        public LostReasonsByOffer GetLostReasonsByOffer(Int64 idOffer, string connectionstring)
        {
            LostReasonsByOffer lostReasonsByOffer = new LostReasonsByOffer();
            using (MySqlConnection conlostReasonsByOffers = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffers.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("GetlostReasonsByOffer", conlostReasonsByOffers);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_IdOffer", idOffer);
                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    if (lostReasonsByOfferreader.Read())
                    {
                        lostReasonsByOffer.IdOffer = Convert.ToInt64(lostReasonsByOfferreader["Idoffer"].ToString());
                        lostReasonsByOffer.IdLostReasonList = lostReasonsByOfferreader["IdLostReasonList"].ToString();
                        if (lostReasonsByOfferreader["IdCompetitor"] != DBNull.Value)
                            lostReasonsByOffer.IdCompetitor = Convert.ToInt64(lostReasonsByOfferreader["IdCompetitor"].ToString());
                        lostReasonsByOffer.Comments = lostReasonsByOfferreader["Comments"].ToString();
                    }
                }
                return lostReasonsByOffer;
            }
        }


        /// <summary>
        /// This method is to get list of lost reasons by offer
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idActiveUser">Get login user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="companyDetails">Get company details</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of Lost reasons by offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          lostReasonsByOfferLst = mgr.GetOfferLostReasonsDetailsCompanyWise(string connectionstring, byte idCurrency, Int32 idActiveUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission);
        ///          SP :-  lostreasonsbyoffer_GetOfferLostReasonsDetails,
        ///          QUERY :- "select * from offerlostreasons";
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<LostReasonsByOffer> GetOfferLostReasonsDetailsCompanyWise(string connectionstring, byte idCurrency, Int32 idActiveUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission)
        {
            List<LostReasonsByOffer> lostReasonsByOfferLst = new List<LostReasonsByOffer>();


            using (MySqlConnection conofferlostreasons = new MySqlConnection(connectionstring))
            {
                conofferlostreasons.Open();
                //string query = "select * from offerlostreasons";
                MySqlCommand conofferlostreasoncommand = new MySqlCommand("offerlostreasons_GetAllOfferLostReasons", conofferlostreasons);
                conofferlostreasoncommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader offerlostreasonsreader = conofferlostreasoncommand.ExecuteReader())
                {
                    while (offerlostreasonsreader.Read())
                    {

                        using (MySqlConnection conlostReasonsByOffers = new MySqlConnection(companyDetails.ConnectPlantConstr))
                        {
                            conlostReasonsByOffers.Open();
                            MySqlCommand conlostReasonsByOfferscommand = new MySqlCommand("lostreasonsbyoffer_GetOfferLostReasonsDetails", conlostReasonsByOffers);
                            conlostReasonsByOfferscommand.CommandType = CommandType.StoredProcedure;
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idUser", idActiveUser);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idZone", idZone);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idLostReason", Convert.ToByte(offerlostreasonsreader["IdLostReason"].ToString()));
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                            using (MySqlDataReader lostReasonsByOffersreader = conlostReasonsByOfferscommand.ExecuteReader())
                            {
                                if (lostReasonsByOffersreader.Read())
                                {
                                    LostReasonsByOffer lostReasonsByOffer = new LostReasonsByOffer();

                                    lostReasonsByOffer.OfferLostReason = new OfferLostReason() { IdLostReason = Convert.ToByte(offerlostreasonsreader["IdLostReason"].ToString()), Name = offerlostreasonsreader["Name"].ToString() };

                                    lostReasonsByOffer.NumberOfOffers = Convert.ToInt64(lostReasonsByOffersreader["NumberOfOffers"].ToString());
                                    if (lostReasonsByOffersreader["IdCompetitor"] != DBNull.Value)
                                        lostReasonsByOffer.IdCompetitor = Convert.ToInt64(lostReasonsByOffersreader["IdCompetitor"].ToString());

                                    lostReasonsByOffer.Competitor = new Competitor();
                                    if (lostReasonsByOffersreader["IdCompetitor"] != DBNull.Value)
                                        lostReasonsByOffer.Competitor.IdCompetitor = Convert.ToInt32(lostReasonsByOffersreader["IdCompetitor"].ToString());

                                    lostReasonsByOffer.Competitor.Name = lostReasonsByOffersreader["Competitor"].ToString();

                                    lostReasonsByOfferLst.Add(lostReasonsByOffer);
                                }
                            }
                        }

                    }

                }

                return lostReasonsByOfferLst;
            }
        }

        public List<LostReasonsByOffer> GetOfferLostReasonsDetailsCompanyWise(string connectionstring, byte idCurrency, Int32 idActiveUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, Int32 idUserPermission)
        {
            List<LostReasonsByOffer> lostReasonsByOfferLst = new List<LostReasonsByOffer>();


            using (MySqlConnection conofferlostreasons = new MySqlConnection(connectionstring))
            {
                conofferlostreasons.Open();
                //string query = "select * from offerlostreasons";
                MySqlCommand conofferlostreasoncommand = new MySqlCommand("offerlostreasons_GetAllOfferLostReasons", conofferlostreasons);
                conofferlostreasoncommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader offerlostreasonsreader = conofferlostreasoncommand.ExecuteReader())
                {
                    while (offerlostreasonsreader.Read())
                    {

                        using (MySqlConnection conlostReasonsByOffers = new MySqlConnection(companyDetails.ConnectPlantConstr))
                        {
                            conlostReasonsByOffers.Open();
                            MySqlCommand conlostReasonsByOfferscommand = new MySqlCommand("lostreasonsbyoffer_GetOfferLostReasonsDetailsDatewise", conlostReasonsByOffers);
                            conlostReasonsByOfferscommand.CommandType = CommandType.StoredProcedure;
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idCurrentUser", idActiveUser);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idUser", idActiveUser);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idLostReason", Convert.ToByte(offerlostreasonsreader["IdLostReason"].ToString()));
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                            using (MySqlDataReader lostReasonsByOffersreader = conlostReasonsByOfferscommand.ExecuteReader())
                            {
                                if (lostReasonsByOffersreader.Read())
                                {
                                    LostReasonsByOffer lostReasonsByOffer = new LostReasonsByOffer();

                                    lostReasonsByOffer.OfferLostReason = new OfferLostReason() { IdLostReason = Convert.ToByte(offerlostreasonsreader["IdLostReason"].ToString()), Name = offerlostreasonsreader["Name"].ToString() };

                                    lostReasonsByOffer.NumberOfOffers = Convert.ToInt64(lostReasonsByOffersreader["NumberOfOffers"].ToString());
                                    if (lostReasonsByOffersreader["IdCompetitor"] != DBNull.Value)
                                        lostReasonsByOffer.IdCompetitor = Convert.ToInt64(lostReasonsByOffersreader["IdCompetitor"].ToString());

                                    lostReasonsByOffer.Competitor = new Competitor();
                                    if (lostReasonsByOffersreader["IdCompetitor"] != DBNull.Value)
                                        lostReasonsByOffer.Competitor.IdCompetitor = Convert.ToInt32(lostReasonsByOffersreader["IdCompetitor"].ToString());

                                    lostReasonsByOffer.Competitor.Name = lostReasonsByOffersreader["Competitor"].ToString();

                                    lostReasonsByOfferLst.Add(lostReasonsByOffer);
                                }
                            }
                        }

                    }

                }

                return lostReasonsByOfferLst;
            }
        }

        /// <summary>
        /// This method is to get list of lost reasons by offer
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="companyDetails">Get company details</param>
        /// <returns>List of lost reasons by offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          lostReasonsByOfferLst = mgr.GetSelectedUsersOfferLostReasonsDetailsCompanyWise(string connectionstring, byte idCurrency, Int64 accountingYear, string idUser, Company companyDetails);
        ///          SP :-  lostreasonsbyoffer_GetSelectedUsersOfferLostReasonsDetails
        ///          QUERY :- "select * from offerlostreasons";
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<LostReasonsByOffer> GetSelectedUsersOfferLostReasonsDetailsCompanyWise(string connectionstring, byte idCurrency, Int64 accountingYear, string idUser, Company companyDetails, Int32 idCurrentUser = 0)
        {
            List<LostReasonsByOffer> lostReasonsByOfferLst = new List<LostReasonsByOffer>();

            using (MySqlConnection conofferlostreasons = new MySqlConnection(connectionstring))
            {
                conofferlostreasons.Open();
                MySqlCommand conofferlostreasoncommand = new MySqlCommand("offerlostreasons_GetAllOfferLostReasons", conofferlostreasons);
                conofferlostreasoncommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader offerlostreasonsreader = conofferlostreasoncommand.ExecuteReader())
                {
                    while (offerlostreasonsreader.Read())
                    {

                        using (MySqlConnection conlostReasonsByOffers = new MySqlConnection(companyDetails.ConnectPlantConstr))
                        {
                            conlostReasonsByOffers.Open();
                            MySqlCommand conlostReasonsByOfferscommand = new MySqlCommand("lostreasonsbyoffer_GetSelectedUsersOfferLostReasonsDetails", conlostReasonsByOffers);
                            conlostReasonsByOfferscommand.CommandType = CommandType.StoredProcedure;
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idUser", idUser);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idLostReason", Convert.ToByte(offerlostreasonsreader["IdLostReason"].ToString()));
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                            using (MySqlDataReader lostReasonsByOffersreader = conlostReasonsByOfferscommand.ExecuteReader())
                            {
                                if (lostReasonsByOffersreader.Read())
                                {
                                    LostReasonsByOffer lostReasonsByOffer = new LostReasonsByOffer();

                                    lostReasonsByOffer.OfferLostReason = new OfferLostReason() { IdLostReason = Convert.ToByte(offerlostreasonsreader["IdLostReason"].ToString()), Name = offerlostreasonsreader["Name"].ToString() };

                                    lostReasonsByOffer.NumberOfOffers = Convert.ToInt64(lostReasonsByOffersreader["NumberOfOffers"].ToString());
                                    if (lostReasonsByOffersreader["IdCompetitor"] != DBNull.Value)
                                        lostReasonsByOffer.IdCompetitor = Convert.ToInt64(lostReasonsByOffersreader["IdCompetitor"].ToString());

                                    lostReasonsByOffer.Competitor = new Competitor();
                                    if (lostReasonsByOffersreader["IdCompetitor"] != DBNull.Value)
                                        lostReasonsByOffer.Competitor.IdCompetitor = Convert.ToInt32(lostReasonsByOffersreader["IdCompetitor"].ToString());

                                    lostReasonsByOffer.Competitor.Name = lostReasonsByOffersreader["Competitor"].ToString();

                                    lostReasonsByOfferLst.Add(lostReasonsByOffer);
                                }
                            }
                        }

                    }


                }

                return lostReasonsByOfferLst;
            }
        }

        public List<LostReasonsByOffer> GetSelectedUsersOfferLostReasonsDetailsCompanyWise(string connectionstring, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, string idUser, Company companyDetails, Int32 idCurrentUser = 0)
        {
            List<LostReasonsByOffer> lostReasonsByOfferLst = new List<LostReasonsByOffer>();

            using (MySqlConnection conofferlostreasons = new MySqlConnection(connectionstring))
            {
                conofferlostreasons.Open();
                MySqlCommand conofferlostreasoncommand = new MySqlCommand("offerlostreasons_GetAllOfferLostReasons", conofferlostreasons);
                conofferlostreasoncommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader offerlostreasonsreader = conofferlostreasoncommand.ExecuteReader())
                {
                    while (offerlostreasonsreader.Read())
                    {

                        using (MySqlConnection conlostReasonsByOffers = new MySqlConnection(companyDetails.ConnectPlantConstr))
                        {
                            conlostReasonsByOffers.Open();
                            MySqlCommand conlostReasonsByOfferscommand = new MySqlCommand("lostreasonsbyoffer_GetOfferLostReasonsDetailsDatewise", conlostReasonsByOffers);
                            conlostReasonsByOfferscommand.CommandType = CommandType.StoredProcedure;
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idUser", idUser);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idLostReason", Convert.ToByte(offerlostreasonsreader["IdLostReason"].ToString()));
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                            conlostReasonsByOfferscommand.Parameters.AddWithValue("_idPermission", 21);

                            using (MySqlDataReader lostReasonsByOffersreader = conlostReasonsByOfferscommand.ExecuteReader())
                            {
                                if (lostReasonsByOffersreader.Read())
                                {
                                    LostReasonsByOffer lostReasonsByOffer = new LostReasonsByOffer();

                                    lostReasonsByOffer.OfferLostReason = new OfferLostReason() { IdLostReason = Convert.ToByte(offerlostreasonsreader["IdLostReason"].ToString()), Name = offerlostreasonsreader["Name"].ToString() };

                                    lostReasonsByOffer.NumberOfOffers = Convert.ToInt64(lostReasonsByOffersreader["NumberOfOffers"].ToString());
                                    if (lostReasonsByOffersreader["IdCompetitor"] != DBNull.Value)
                                        lostReasonsByOffer.IdCompetitor = Convert.ToInt64(lostReasonsByOffersreader["IdCompetitor"].ToString());

                                    lostReasonsByOffer.Competitor = new Competitor();
                                    if (lostReasonsByOffersreader["IdCompetitor"] != DBNull.Value)
                                        lostReasonsByOffer.Competitor.IdCompetitor = Convert.ToInt32(lostReasonsByOffersreader["IdCompetitor"].ToString());

                                    lostReasonsByOffer.Competitor.Name = lostReasonsByOffersreader["Competitor"].ToString();

                                    lostReasonsByOfferLst.Add(lostReasonsByOffer);
                                }
                            }
                        }

                    }


                }

                return lostReasonsByOfferLst;
            }
        }

        /// <summary>
        /// This method is to get list of companies
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingFromYear">Get accounting from year</param>
        /// <param name="accountingToYear">Get accounting to year</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of company</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          companies = mgr.GetSitesTarget(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingFromYear, Int64 accountingToYear, Int32 idUserPermission);
        ///          SP :-  sites_GetTargetByCustomerYearwise
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<Company> GetSitesTarget(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingFromYear, Int64 accountingToYear, Int32 idUserPermission)
        {
            List<Company> companies = new List<Company>();
            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();

                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetTargetByCustomerYearwise", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;
                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);
                conoffertargetcommand.Parameters.AddWithValue("_idZone", idZone);
                conoffertargetcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conoffertargetcommand.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
                conoffertargetcommand.Parameters.AddWithValue("_accountingToYear", accountingToYear);
                conoffertargetcommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {

                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString());
                        company.Name = offertargetreader["CustomerName"].ToString();
                        company.Country = new Country { Name = offertargetreader["CustomerCountry"].ToString() };

                        company.Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } };
                        company.SalesTargetBySite = new SalesTargetBySite
                        {
                            TargetAmount = Convert.ToDecimal(offertargetreader["TargetSalesAmount"].ToString()),
                            Currency = new Currency { Name = offertargetreader["TargetSalesCurrency"].ToString(), Symbol = offertargetreader["TargetSalesCurrencySymbol"].ToString() },
                            Year = Convert.ToInt32(offertargetreader["Year"].ToString())
                        };

                        companies.Add(company);
                    }

                }
            }
            return companies;
        }




        /// <summary>
        /// This method is to get list of company
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="accountingFromYear">Get accounting from year</param>
        /// <param name="accountingToYear">Get accounting to year</param>
        /// <param name="idUser">Get user id</param>
        /// <returns>List of company</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          companies = mgr.GetSelectedUsersSitesTarget(string connectionstring, byte idCurrency, Int64 accountingFromYear, Int64 accountingToYear, string idUser);
        ///          SP :-  sites_GetSelectedUsersTargetByCustomerYearwise
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<Company> GetSelectedUsersSitesTarget(string connectionstring, byte idCurrency, Int64 accountingFromYear, Int64 accountingToYear, string idUser)
        {
            List<Company> companies = new List<Company>();
            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();
                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetSelectedUsersTargetByCustomerYearwise", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;
                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);
                conoffertargetcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conoffertargetcommand.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
                conoffertargetcommand.Parameters.AddWithValue("_accountingToYear", accountingToYear);
                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {

                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString());
                        company.Name = offertargetreader["CustomerName"].ToString();
                        company.Country = new Country { Name = offertargetreader["CustomerCountry"].ToString() };

                        company.Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } };
                        company.SalesTargetBySite = new SalesTargetBySite
                        {
                            TargetAmount = Convert.ToDecimal(offertargetreader["TargetSalesAmount"].ToString()),
                            Currency = new Currency { Name = offertargetreader["TargetSalesCurrency"].ToString(), Symbol = offertargetreader["TargetSalesCurrencySymbol"].ToString() },
                            Year = Convert.ToInt32(offertargetreader["Year"].ToString())
                        };

                        companies.Add(company);
                    }

                }
            }
            return companies;
        }

        /// <summary>
        /// This method is to get target forecast details
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingFromYear">Get accounting from year</param>
        /// <param name="accountingToYear">Get accounting to year</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          offers = mgr.GetTargetForecast(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingFromYear, Int64 accountingToYear, Int32 idUserPermission);
        ///          SP :-  sites_GetForecastedByCustomerYearwise,sites_GetTargetByCustomerYearwise,sites_GetCustomerDetails
        ///     }
        /// }
        /// </code>
        /// </example>  
        public IList<Offer> GetTargetForecast(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingFromYear, Int64 accountingToYear, Int32 idUserPermission)
        {
            IList<Offer> offers = new List<Offer>();

            IList<CustomerPurchaseOrder> customerforecasted = new List<CustomerPurchaseOrder>();
            IList<Company> companies = new List<Company>();
            using (MySqlConnection concustomerforecast = new MySqlConnection(connectionstring))
            {
                concustomerforecast.Open();
                MySqlCommand concustomerforecastcommand = new MySqlCommand("sites_GetForecastedByCustomerYearwise", concustomerforecast);
                concustomerforecastcommand.CommandType = CommandType.StoredProcedure;
                concustomerforecastcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concustomerforecastcommand.Parameters.AddWithValue("_idUser", idUser);
                concustomerforecastcommand.Parameters.AddWithValue("_idZone", idZone);
                concustomerforecastcommand.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
                concustomerforecastcommand.Parameters.AddWithValue("_accountingToYear", accountingToYear);
                concustomerforecastcommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader customerforecastreader = concustomerforecastcommand.ExecuteReader())
                {
                    while (customerforecastreader.Read())
                    {
                        CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                        customerPurchaseOrder.Offer = new Offer { IdCustomer = Convert.ToInt32(customerforecastreader["idCustomer"].ToString()) };
                        customerPurchaseOrder.Year = customerforecastreader["ForecastedYear"].ToString();
                        customerPurchaseOrder.Value = Convert.ToDouble(customerforecastreader["Amount"].ToString());
                        customerPurchaseOrder.Currency = new Currency { Name = customerforecastreader["Currency"].ToString(), Symbol = customerforecastreader["CurrencySymbol"].ToString() };
                        customerforecasted.Add(customerPurchaseOrder);
                    }
                }
            }

            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();
                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetTargetByCustomerYearwise", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;
                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);
                conoffertargetcommand.Parameters.AddWithValue("_idZone", idZone);
                conoffertargetcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conoffertargetcommand.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
                conoffertargetcommand.Parameters.AddWithValue("_accountingToYear", accountingToYear);
                conoffertargetcommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {

                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString());
                        company.Name = offertargetreader["CustomerName"].ToString();
                        company.Country = new Country { Name = offertargetreader["CustomerCountry"].ToString() };

                        company.Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } };
                        company.SalesTargetBySite = new SalesTargetBySite
                        {
                            IdSite = Convert.ToInt32(offertargetreader["IdSite"].ToString()),
                            TargetAmount = Convert.ToDecimal(offertargetreader["TargetSalesAmount"].ToString()),
                            Currency = new Currency { IdCurrency = Convert.ToByte(offertargetreader["TargetSalesIdCurrency"].ToString()), Name = offertargetreader["TargetSalesCurrency"].ToString(), Symbol = offertargetreader["TargetSalesCurrencySymbol"].ToString() },
                            Year = Convert.ToInt32(offertargetreader["Year"].ToString())
                        };

                        companies.Add(company);
                    }

                }
            }

            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();
                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetCustomerDetails", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;
                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);
                conoffertargetcommand.Parameters.AddWithValue("_idZone", idZone);
                conoffertargetcommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {

                        Offer offertarget = new Offer();
                        offertarget.Site = new Company { IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString()), Name = offertargetreader["CustomerName"].ToString(), Country = new Country { Name = offertargetreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offertargetreader["CustomerZone"].ToString() } }, Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } } };
                        offertarget.ForecastedByCustomers = customerforecasted.Where(customerforecast => customerforecast.Offer.IdCustomer == offertarget.Site.IdCompany).ToList();
                        if (offertarget.ForecastedByCustomers.Count > 0)
                            offertarget.TotalForecasted = offertarget.ForecastedByCustomers.Sum(i => i.Value);
                        else
                            offertarget.TotalForecasted = 0.00;

                        offertarget.Site.SalesTargetBySiteLst = companies.Where(comp => comp.IdCompany == offertarget.Site.IdCompany).Select(saletarget => saletarget.SalesTargetBySite).ToList();

                        offers.Add(offertarget);
                    }

                }
            }

            return offers;

        }

        /// <summary>
        /// This method is to get list of offers
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="accountingFromYear">Get accounting from year</param>
        /// <param name="accountingToYear">Get accounting to year</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          offers = mgr.GetSelectedUsersTargetForecast(string connectionstring, byte idCurrency, string idUser, Int64 accountingFromYear, Int64 accountingToYear);
        ///          SP :-  sites_GetSelectedUsersForecastedByCustomerYearwise,sites_GetSelectedUsersTargetByCustomerYearwise,sites_GetSelectedUsersCustomerDetails
        ///     }
        /// }
        /// </code>
        /// </example>  
        public IList<Offer> GetSelectedUsersTargetForecast(string connectionstring, byte idCurrency, string idUser, Int64 accountingFromYear, Int64 accountingToYear)
        {
            IList<Offer> offers = new List<Offer>();

            IList<CustomerPurchaseOrder> customerforecasted = new List<CustomerPurchaseOrder>();
            IList<Company> companies = new List<Company>();
            //using (MySqlConnection concustomerforecast = new MySqlConnection(connectionstring))
            //{
            //    concustomerforecast.Open();
            //    MySqlCommand concustomerforecastcommand = new MySqlCommand("sites_GetSelectedUsersForecastedByCustomerYearwise", concustomerforecast);
            //    concustomerforecastcommand.CommandType = CommandType.StoredProcedure;
            //    concustomerforecastcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
            //    concustomerforecastcommand.Parameters.AddWithValue("_idUser", idUser);
            //    concustomerforecastcommand.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
            //    concustomerforecastcommand.Parameters.AddWithValue("_accountingToYear", accountingToYear);
            //    using (MySqlDataReader customerforecastreader = concustomerforecastcommand.ExecuteReader())
            //    {
            //        while (customerforecastreader.Read())
            //        {
            //            CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
            //            customerPurchaseOrder.Offer = new Offer { IdCustomer = Convert.ToInt32(customerforecastreader["idCustomer"].ToString()) };
            //            customerPurchaseOrder.Year = customerforecastreader["ForecastedYear"].ToString();
            //            customerPurchaseOrder.Value = Convert.ToDouble(customerforecastreader["Amount"].ToString());
            //            customerPurchaseOrder.Currency = new Currency { Name = customerforecastreader["Currency"].ToString(), Symbol = customerforecastreader["CurrencySymbol"].ToString() };
            //            customerforecasted.Add(customerPurchaseOrder);
            //        }
            //    }
            //}

            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();
                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetSelectedUsersTargetByCustomerYearwise", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;
                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);

                conoffertargetcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conoffertargetcommand.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
                conoffertargetcommand.Parameters.AddWithValue("_accountingToYear", accountingToYear);
                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {

                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString());
                        company.Name = offertargetreader["CustomerName"].ToString();
                        company.Country = new Country { Name = offertargetreader["CustomerCountry"].ToString() };

                        company.Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } };
                        company.SalesTargetBySite = new SalesTargetBySite
                        {
                            IdSite = Convert.ToInt32(offertargetreader["IdSite"].ToString()),
                            TargetAmount = Convert.ToDecimal(offertargetreader["TargetSalesAmount"].ToString()),
                            Currency = new Currency { IdCurrency = Convert.ToByte(offertargetreader["TargetSalesIdCurrency"].ToString()), Name = offertargetreader["TargetSalesCurrency"].ToString(), Symbol = offertargetreader["TargetSalesCurrencySymbol"].ToString() },
                            Year = Convert.ToInt32(offertargetreader["Year"].ToString())
                        };

                        companies.Add(company);
                    }

                }
            }

            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();
                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetSelectedUsersCustomerDetails", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;
                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);

                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {

                        Offer offertarget = new Offer();
                        offertarget.Site = new Company { IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString()), Name = offertargetreader["CustomerName"].ToString(), Country = new Country { Name = offertargetreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offertargetreader["CustomerZone"].ToString() } }, Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } } };

                        //offertarget.ForecastedByCustomers = customerforecasted.Where(customerforecast => customerforecast.Offer.IdCustomer == offertarget.Site.IdCompany).ToList();
                        //if (offertarget.ForecastedByCustomers.Count > 0)
                        //    offertarget.TotalForecasted = offertarget.ForecastedByCustomers.Sum(i => i.Value);
                        //else
                        //    offertarget.TotalForecasted = 0.00;

                        offertarget.Site.SalesTargetBySiteLst = companies.Where(comp => comp.IdCompany == offertarget.Site.IdCompany).Select(saletarget => saletarget.SalesTargetBySite).ToList();

                        offers.Add(offertarget);
                    }

                }
            }

            return offers;

        }

        /// <summary>
        /// This method is to get list of orders
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          OffersOptionsList = mgr.GetOrdersDatatable(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission);
        ///          SP :-  offers_GetInvoicesAmount,offers_GetOrdersDatatable
        ///     }
        /// }
        /// </code>
        /// </example> 

        public OffersOptionsList GetOrdersDatatable(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission)
        {
            OffersOptionsList OffersOptionsList = new OffersOptionsList();
            OffersOptionsList.Offers = new List<Offer>();
            OffersOptionsList.OptionsByOffers = new List<OptionsByOffer>();
            //DataSet ds = new DataSet();

            IList<Offer> offerInvoices = new List<Offer>();
            using (MySqlConnection conofferinvoice = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferinvoice.Open();
                MySqlCommand conofferinvoicecommand = new MySqlCommand("offers_GetInvoicesAmount", conofferinvoice);
                conofferinvoicecommand.CommandType = CommandType.StoredProcedure;
                conofferinvoicecommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferinvoicecommand.Parameters.AddWithValue("_idUser", idUser);
                conofferinvoicecommand.Parameters.AddWithValue("_idZone", idZone);
                conofferinvoicecommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferinvoicecommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offerinvoicereader = conofferinvoicecommand.ExecuteReader())
                {
                    while (offerinvoicereader.Read())
                    {
                        Offer offerInvoice = new Offer();
                        offerInvoice.IdOffer = Convert.ToInt64(offerinvoicereader["IdOffer"].ToString());
                        offerInvoice.Value = Convert.ToDouble(offerinvoicereader["InvoiceAmount"].ToString());
                        offerInvoice.Currency = new Currency { Name = offerinvoicereader["InvoiceCurrency"].ToString() };
                        offerInvoices.Add(offerInvoice);
                    }
                }
            }


            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOrdersDatatable", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
                //DataSet ds = new DataSet();
                //da.Fill(ds);

                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            Offer offer = new Offer();
                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());
                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();
                            offer.Site = new Company { Name = itemRow["CustomerName"].ToString() };

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());
                            }

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());
                            }

                            offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;
                            offer.Site.Customers = new List<Customer> { new Customer { CustomerName = itemRow["CustomerGroup"].ToString() } };
                            offer.Site.Country = new Country { Name = itemRow["CustomerCountry"].ToString(), Zone = new Zone { Name = itemRow["CustomerZone"].ToString() } };
                            offer.GeosStatus = new GeosStatus { Name = itemRow["OfferStatus"].ToString(), HtmlColor = itemRow["OfferStatusColor"].ToString() };

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());
                            else
                                offer.Value = 0;

                            offer.InvoiceAmount = (from record in offerInvoices where record.IdOffer == offer.IdOffer select record.Value).SingleOrDefault();
                            offer.Currency = new Currency { Name = itemRow["OfferCurrency"].ToString() };

                            if (itemRow["PoReceptionDate"] != DBNull.Value)
                                offer.CustomerPurchaseOrdersByOffers = new List<CustomerPurchaseOrdersByOffer>() { new CustomerPurchaseOrdersByOffer { CustomerPurchaseOrder = new CustomerPurchaseOrder { ReceivedIn = Convert.ToDateTime(itemRow["PoReceptionDate"].ToString()) } } };

                            if (itemRow["DeliveryDate"] != DBNull.Value)
                                offer.DeliveryDate = Convert.ToDateTime(itemRow["DeliveryDate"].ToString());
                            else
                                offer.DeliveryDate = null;

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RFQReception = Convert.ToDateTime(itemRow["RFQReception"].ToString());
                            else
                                offer.RFQReception = null;

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.SendIn = Convert.ToDateTime(itemRow["SendIn"].ToString());
                            else
                                offer.SendIn = null;

                            if (itemRow["IdSource"] != DBNull.Value)
                            {
                                offer.IdSource = Convert.ToByte(itemRow["IdSource"].ToString());
                                offer.Source = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdSource"].ToString()), Value = itemRow["Source"].ToString() };
                            }

                            if (itemRow["IdBusinessUnit"] != DBNull.Value)
                            {
                                offer.IdBusinessUnit = Convert.ToByte(itemRow["IdBusinessUnit"].ToString());
                                offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdBusinessUnit"].ToString()), Value = itemRow["BusinessUnit"].ToString() };
                            }

                            if (itemRow["IdCarProject"] != DBNull.Value)
                            {
                                offer.IdCarProject = Convert.ToInt64(itemRow["IdCarProject"].ToString());
                                offer.CarProject = new CarProject();

                                offer.CarProject.IdCarProject = Convert.ToInt32(itemRow["IdCarProject"].ToString());
                                offer.CarProject.Name = itemRow["CarProjectName"].ToString();
                            }

                            if (itemRow["IdCarOEM"] != DBNull.Value)
                            {
                                offer.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM = new CarOEM();
                                offer.CarOEM.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM.Name = itemRow["CarOEM"].ToString();
                            }

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                offer.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory = new ProductCategory();
                                offer.ProductCategory.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory.Name = itemRow["ProductSubCategory"].ToString();

                                if (itemRow["IdCategory"] != DBNull.Value)
                                {
                                    offer.ProductCategory.IdParent = Convert.ToInt64(itemRow["IdCategory"].ToString());
                                    offer.ProductCategory.Category = new ProductCategory();
                                    offer.ProductCategory.Category.IdProductCategory = Convert.ToInt64(itemRow["IdCategory"].ToString());
                                    offer.ProductCategory.Category.Name = itemRow["Category"].ToString();
                                }
                            }

                            //IList<CustomerPurchaseOrder> cpos = customerPurchaseOrders.Where(x => x.IdOffer == offer.IdOffer).ToList();
                            //if (cpos != null && cpos.Count > 0)
                            //{
                            //    offer.CustomerPOCodes = string.Join("\n", cpos.Select(x => x.Code).ToList());
                            //}

                            offer.OptionsByOffers = new List<OptionsByOffer>();

                            OffersOptionsList.Offers.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            OptionsByOffer optionsbyoffer = new OptionsByOffer();
                            optionsbyoffer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsbyoffer.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsbyoffer.IdOfferPlant = Convert.ToInt32(companyDetails.ConnectPlantId);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsbyoffer.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsbyoffer.Quantity > 0)
                                    optionsbyoffer.IsSelected = true;
                                else
                                    optionsbyoffer.IsSelected = false;
                            }
                            else
                            {
                                optionsbyoffer.IsSelected = false;
                            }
                            optionsbyoffer.OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(itemRow["IdOption"].ToString()), Name = itemRow["offeroption"].ToString(), OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(itemRow["IdOfferOptionType"].ToString()), Name = itemRow["offeroptiontype"].ToString() } };

                            OffersOptionsList.OptionsByOffers.Add(optionsbyoffer);
                        }
                    }
                }
            }



            IList<CustomerPurchaseOrder> customerPurchaseOrders = new List<CustomerPurchaseOrder>();
            try
            {
                //string[] array = ds.Tables[0].AsEnumerable().Select(row => row["idoffer"].ToString()).ToArray();
                //string result = string.Join(",", array);

                string result = String.Join(",", ((List<Offer>)OffersOptionsList.Offers).ConvertAll<string>(d => d.IdOffer.ToString()).ToArray());


                using (MySqlConnection connPurchaseOrder = new MySqlConnection(companyDetails.ConnectPlantConstr))
                {
                    connPurchaseOrder.Open();
                    MySqlCommand customerPOCommand = new MySqlCommand("offers_GetOfferPurchaseOrdersByOfferIds", connPurchaseOrder);
                    customerPOCommand.CommandType = CommandType.StoredProcedure;
                    customerPOCommand.Parameters.AddWithValue("_idoffer", result);

                    using (MySqlDataReader poReader = customerPOCommand.ExecuteReader())
                    {
                        while (poReader.Read())
                        {
                            CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                            customerPurchaseOrder.IdOffer = Convert.ToInt64(poReader["IdOffer"].ToString());
                            customerPurchaseOrder.Code = Convert.ToString(poReader["Code"].ToString());
                            customerPurchaseOrder.IdCustomerPurchaseOrders = Convert.ToInt64(poReader["idCustomerPurchaseOrders"].ToString());
                            customerPurchaseOrder.IsGoAhead = Convert.ToByte(poReader["IsGoAhead"].ToString());

                            Offer offer = OffersOptionsList.Offers.FirstOrDefault(x => x.IdOffer == customerPurchaseOrder.IdOffer);
                            if (offer != null)
                            {
                                if (string.IsNullOrEmpty(offer.CustomerPOCodes))
                                {
                                    offer.CustomerPOCodes = string.Format(customerPurchaseOrder.Code);
                                }
                                else
                                {
                                    offer.CustomerPOCodes = string.Format(offer.CustomerPOCodes + "\n" + customerPurchaseOrder.Code);
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
            }


            return OffersOptionsList;
        }





        /// <summary>
        /// This method is to get list of orders
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="AccountingYearFrom">Get accounting year From</param>
        /// <param name="AccountingYearTo">Get accounting year To</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          OffersOptionsList = mgr.GetOrdersDatatable(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission);
        ///          SP :-  offers_GetInvoicesAmount,offers_GetOrdersDatatable
        ///     }
        /// }
        /// </code>
        /// </example> 

        public OffersOptionsList GetOrdersDatatable(byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, Int32 idUserPermission)
        {
            OffersOptionsList OffersOptionsList = new OffersOptionsList();
            OffersOptionsList.Offers = new List<Offer>();
            OffersOptionsList.OptionsByOffers = new List<OptionsByOffer>();
            //OffersOptionsList.LostReasonsByOffers = new List<LostReasonsByOffer>();
            //DataSet ds = new DataSet();

            IList<Offer> offerInvoices = new List<Offer>();
            using (MySqlConnection conofferinvoice = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferinvoice.Open();
                MySqlCommand conofferinvoicecommand = new MySqlCommand("offers_GetInvoicesAmountDateWise", conofferinvoice);
                conofferinvoicecommand.CommandType = CommandType.StoredProcedure;
                conofferinvoicecommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferinvoicecommand.Parameters.AddWithValue("_idUser", idUser);
                conofferinvoicecommand.Parameters.AddWithValue("_idCurrentUser", idUser);
                conofferinvoicecommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferinvoicecommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferinvoicecommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offerinvoicereader = conofferinvoicecommand.ExecuteReader())
                {
                    while (offerinvoicereader.Read())
                    {
                        Offer offerInvoice = new Offer();
                        offerInvoice.IdOffer = Convert.ToInt64(offerinvoicereader["IdOffer"].ToString());
                        offerInvoice.Value = Convert.ToDouble(offerinvoicereader["InvoiceAmount"].ToString());
                        offerInvoice.Currency = new Currency { Name = offerinvoicereader["InvoiceCurrency"].ToString() };
                        offerInvoices.Add(offerInvoice);
                    }
                }
            }


            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOrdersDatatableDateWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.CommandTimeout = 3000;

                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
                //DataSet ds = new DataSet();
                //da.Fill(ds);

                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            Offer offer = new Offer();
                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());
                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();
                            offer.Site = new Company { Name = itemRow["CustomerName"].ToString() };

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());
                            }

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());
                            }

                            offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;
                            offer.Site.Customers = new List<Customer> { new Customer { CustomerName = itemRow["CustomerGroup"].ToString() } };
                            offer.Site.Country = new Country { Name = itemRow["CustomerCountry"].ToString(), Zone = new Zone { Name = itemRow["CustomerZone"].ToString() } };
                            offer.GeosStatus = new GeosStatus { Name = itemRow["OfferStatus"].ToString(), HtmlColor = itemRow["OfferStatusColor"].ToString() };

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());
                            else
                                offer.Value = 0;

                            offer.InvoiceAmount = (from record in offerInvoices where record.IdOffer == offer.IdOffer select record.Value).SingleOrDefault();
                            offer.Currency = new Currency { Name = itemRow["OfferCurrency"].ToString() };

                            if (itemRow["PoReceptionDate"] != DBNull.Value)
                                offer.CustomerPurchaseOrdersByOffers = new List<CustomerPurchaseOrdersByOffer>() { new CustomerPurchaseOrdersByOffer { CustomerPurchaseOrder = new CustomerPurchaseOrder { ReceivedIn = Convert.ToDateTime(itemRow["PoReceptionDate"].ToString()) } } };

                            if (itemRow["DeliveryDate"] != DBNull.Value)
                                offer.DeliveryDate = Convert.ToDateTime(itemRow["DeliveryDate"].ToString());
                            else
                                offer.DeliveryDate = null;

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RFQReception = Convert.ToDateTime(itemRow["RFQReception"].ToString());
                            else
                                offer.RFQReception = null;

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.SendIn = Convert.ToDateTime(itemRow["SendIn"].ToString());
                            else
                                offer.SendIn = null;

                            if (itemRow["IdSource"] != DBNull.Value)
                            {
                                offer.IdSource = Convert.ToByte(itemRow["IdSource"].ToString());
                                offer.Source = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdSource"].ToString()), Value = itemRow["Source"].ToString() };
                            }

                            if (itemRow["IdBusinessUnit"] != DBNull.Value)
                            {
                                offer.IdBusinessUnit = Convert.ToByte(itemRow["IdBusinessUnit"].ToString());
                                offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdBusinessUnit"].ToString()), Value = itemRow["BusinessUnit"].ToString() };
                            }

                            if (itemRow["IdCarProject"] != DBNull.Value)
                            {
                                offer.IdCarProject = Convert.ToInt64(itemRow["IdCarProject"].ToString());
                                offer.CarProject = new CarProject();

                                offer.CarProject.IdCarProject = Convert.ToInt32(itemRow["IdCarProject"].ToString());
                                offer.CarProject.Name = itemRow["CarProjectName"].ToString();
                            }

                            if (itemRow["IdCarOEM"] != DBNull.Value)
                            {
                                offer.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM = new CarOEM();
                                offer.CarOEM.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM.Name = itemRow["CarOEM"].ToString();
                            }

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                offer.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory = new ProductCategory();
                                offer.ProductCategory.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory.Name = itemRow["ProductSubCategory"].ToString();

                                if (itemRow["IdCategory"] != DBNull.Value)
                                {
                                    offer.ProductCategory.IdParent = Convert.ToInt64(itemRow["IdCategory"].ToString());
                                    offer.ProductCategory.Category = new ProductCategory();
                                    offer.ProductCategory.Category.IdProductCategory = Convert.ToInt64(itemRow["IdCategory"].ToString());
                                    offer.ProductCategory.Category.Name = itemRow["Category"].ToString();
                                }
                            }

                            //IList<CustomerPurchaseOrder> cpos = customerPurchaseOrders.Where(x => x.IdOffer == offer.IdOffer).ToList();
                            //if (cpos != null && cpos.Count > 0)
                            //{
                            //    offer.CustomerPOCodes = string.Join("\n", cpos.Select(x => x.Code).ToList());
                            //}

                            offer.OptionsByOffers = new List<OptionsByOffer>();
                            // offer.LostReasonsByOffers = new List<LostReasonsByOffer>();
                            OffersOptionsList.Offers.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            OptionsByOffer optionsbyoffer = new OptionsByOffer();
                            optionsbyoffer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsbyoffer.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsbyoffer.IdOfferPlant = Convert.ToInt32(companyDetails.ConnectPlantId);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsbyoffer.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsbyoffer.Quantity > 0)
                                    optionsbyoffer.IsSelected = true;
                                else
                                    optionsbyoffer.IsSelected = false;
                            }
                            else
                            {
                                optionsbyoffer.IsSelected = false;
                            }
                            optionsbyoffer.OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(itemRow["IdOption"].ToString()), Name = itemRow["offeroption"].ToString(), OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(itemRow["IdOfferOptionType"].ToString()), Name = itemRow["offeroptiontype"].ToString() } };

                            OffersOptionsList.OptionsByOffers.Add(optionsbyoffer);
                        }
                    }

                    //if (itemRow.NextResult())
                    //{
                    //    while (itemRow.Read())
                    //    {
                    //        if (itemRow["idoffer"] != DBNull.Value)
                    //        {
                    //            Offer offer = OffersOptionsList.Offers.Where(i => i.IdOffer == Convert.ToInt64(itemRow["idoffer"].ToString())).FirstOrDefault();
                    //            if (offer != null && itemRow["ShipmentDate"] != DBNull.Value)
                    //                offer.ShipmentDate = Convert.ToDateTime(itemRow["ShipmentDate"].ToString());
                    //        }
                    //    }
                    //}
                }
            }

            string result = String.Join(",", ((List<Offer>)OffersOptionsList.Offers).ConvertAll<string>(d => d.IdOffer.ToString()).ToArray());

            try
            {
                using (MySqlConnection conn = new MySqlConnection(companyDetails.ConnectPlantConstr))
                {
                    conn.Open();
                    MySqlCommand Command = new MySqlCommand("offers_GetAllShipmentDateBySelectedIdOffer", conn);
                    Command.CommandType = CommandType.StoredProcedure;
                    Command.Parameters.AddWithValue("_idoffer", result);

                    using (MySqlDataReader reader = Command.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            if (reader["idoffer"] != DBNull.Value)
                            {
                                Offer offer = OffersOptionsList.Offers.Where(i => i.IdOffer == Convert.ToInt64(reader["idoffer"].ToString())).FirstOrDefault();
                                if (reader["ShipmentDate"] != DBNull.Value)
                                    offer.ShipmentDate = Convert.ToDateTime(reader["ShipmentDate"].ToString());
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
            }

            IList<CustomerPurchaseOrder> customerPurchaseOrders = new List<CustomerPurchaseOrder>();
            try
            {
                using (MySqlConnection connPurchaseOrder = new MySqlConnection(companyDetails.ConnectPlantConstr))
                {
                    connPurchaseOrder.Open();
                    MySqlCommand customerPOCommand = new MySqlCommand("offers_GetOfferPurchaseOrdersByOfferIds", connPurchaseOrder);
                    customerPOCommand.CommandType = CommandType.StoredProcedure;
                    customerPOCommand.Parameters.AddWithValue("_idoffer", result);

                    using (MySqlDataReader poReader = customerPOCommand.ExecuteReader())
                    {
                        while (poReader.Read())
                        {
                            CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                            customerPurchaseOrder.IdOffer = Convert.ToInt64(poReader["IdOffer"].ToString());
                            customerPurchaseOrder.Code = Convert.ToString(poReader["Code"].ToString());
                            customerPurchaseOrder.IdCustomerPurchaseOrders = Convert.ToInt64(poReader["idCustomerPurchaseOrders"].ToString());
                            customerPurchaseOrder.IsGoAhead = Convert.ToByte(poReader["IsGoAhead"].ToString());

                            Offer offer = OffersOptionsList.Offers.FirstOrDefault(x => x.IdOffer == customerPurchaseOrder.IdOffer);
                            if (offer != null)
                            {
                                if (string.IsNullOrEmpty(offer.CustomerPOCodes))
                                {
                                    offer.CustomerPOCodes = string.Format(customerPurchaseOrder.Code);
                                }
                                else
                                {
                                    offer.CustomerPOCodes = string.Format(offer.CustomerPOCodes + "\n" + customerPurchaseOrder.Code);
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
            }


            return OffersOptionsList;
        }

        /// <summary>
        /// This method is to get offer details
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="companydetails">Get company details</param>
        /// <returns>offer details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          OffersOptionsList = mgr.GetSelectedUsersOrdersDatatable(byte idCurrency, string idUser, Int64 accountingYear, Company companydetails);
        ///          SP :-  offers_GetSelectedUserInvoicesAmount,offers_GetSelectedUsersOrdersDatatable
        ///     }
        /// }
        /// </code>
        /// </example> 
        public OffersOptionsList GetSelectedUsersOrdersDatatable(byte idCurrency, string idUser, Int64 accountingYear, Company companydetails, Int32 idCurrentUser = 0)
        {
            OffersOptionsList OffersOptionsList = new OffersOptionsList();
            OffersOptionsList.Offers = new List<Offer>();
            OffersOptionsList.OptionsByOffers = new List<OptionsByOffer>();
            //DataSet ds = new DataSet();

            IList<Offer> offerInvoices = new List<Offer>();
            using (MySqlConnection conofferinvoice = new MySqlConnection(companydetails.ConnectPlantConstr))
            {
                conofferinvoice.Open();
                MySqlCommand conofferinvoicecommand = new MySqlCommand("offers_GetSelectedUserInvoicesAmount", conofferinvoice);
                conofferinvoicecommand.CommandType = CommandType.StoredProcedure;
                conofferinvoicecommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferinvoicecommand.Parameters.AddWithValue("_idUser", idUser);
                conofferinvoicecommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferinvoicecommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                using (MySqlDataReader offerinvoicereader = conofferinvoicecommand.ExecuteReader())
                {
                    while (offerinvoicereader.Read())
                    {
                        Offer offerInvoice = new Offer();
                        offerInvoice.IdOffer = Convert.ToInt64(offerinvoicereader["IdOffer"].ToString());
                        offerInvoice.Value = Convert.ToDouble(offerinvoicereader["InvoiceAmount"].ToString());
                        offerInvoice.Currency = new Currency { Name = offerinvoicereader["InvoiceCurrency"].ToString() };
                        offerInvoices.Add(offerInvoice);
                    }
                }
            }

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companydetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUsersOrdersDatatable", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
                //DataSet ds = new DataSet();
                //da.Fill(ds);





                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            Offer offer = new Offer();
                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());
                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();
                            offer.Site = new Company { Name = itemRow["CustomerName"].ToString() };
                            offer.Site.ConnectPlantId = companydetails.ConnectPlantId;
                            //offer.Site.ConnectPlantConstr = dictconnectstr.Value;

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());
                            }

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());
                            }

                            offer.Site.Customers = new List<Customer> { new Customer { CustomerName = itemRow["CustomerGroup"].ToString() } };
                            offer.Site.Country = new Country { Name = itemRow["CustomerCountry"].ToString(), Zone = new Zone { Name = itemRow["CustomerZone"].ToString() } };
                            offer.GeosStatus = new GeosStatus { Name = itemRow["OfferStatus"].ToString(), HtmlColor = itemRow["OfferStatusColor"].ToString() };

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());
                            else
                                offer.Value = 0;

                            offer.InvoiceAmount = (from record in offerInvoices where record.IdOffer == offer.IdOffer select record.Value).SingleOrDefault();
                            offer.Currency = new Currency { Name = itemRow["OfferCurrency"].ToString() };

                            if (itemRow["PoReceptionDate"] != DBNull.Value)
                                offer.CustomerPurchaseOrdersByOffers = new List<CustomerPurchaseOrdersByOffer>() { new CustomerPurchaseOrdersByOffer { CustomerPurchaseOrder = new CustomerPurchaseOrder { ReceivedIn = Convert.ToDateTime(itemRow["PoReceptionDate"].ToString()) } } };

                            if (itemRow["DeliveryDate"] != DBNull.Value)
                                offer.DeliveryDate = Convert.ToDateTime(itemRow["DeliveryDate"].ToString());
                            else
                                offer.DeliveryDate = null;

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RFQReception = Convert.ToDateTime(itemRow["RFQReception"].ToString());
                            else
                                offer.RFQReception = null;

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.SendIn = Convert.ToDateTime(itemRow["SendIn"].ToString());
                            else
                                offer.SendIn = null;

                            if (itemRow["IdSource"] != DBNull.Value)
                            {
                                offer.IdSource = Convert.ToByte(itemRow["IdSource"].ToString());
                                offer.Source = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdSource"].ToString()), Value = itemRow["Source"].ToString() };
                            }

                            if (itemRow["IdBusinessUnit"] != DBNull.Value)
                            {
                                offer.IdBusinessUnit = Convert.ToByte(itemRow["IdBusinessUnit"].ToString());
                                offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdBusinessUnit"].ToString()), Value = itemRow["BusinessUnit"].ToString() };
                            }

                            if (itemRow["IdCarProject"] != DBNull.Value)
                            {
                                offer.IdCarProject = Convert.ToInt64(itemRow["IdCarProject"].ToString());
                                offer.CarProject = new CarProject();

                                offer.CarProject.IdCarProject = Convert.ToInt32(itemRow["IdCarProject"].ToString());
                                offer.CarProject.Name = itemRow["CarProjectName"].ToString();
                            }

                            if (itemRow["IdCarOEM"] != DBNull.Value)
                            {
                                offer.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM = new CarOEM();
                                offer.CarOEM.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM.Name = itemRow["CarOEM"].ToString();
                            }

                            ////PO code column
                            //IList<CustomerPurchaseOrder> cpos = customerPurchaseOrders.Where(x => x.IdOffer == offer.IdOffer).ToList();
                            //if (cpos != null && cpos.Count > 0)
                            //{
                            //    offer.CustomerPOCodes = string.Join("\n", cpos.Select(x => x.Code).ToList());
                            //}

                            offer.OptionsByOffers = new List<OptionsByOffer>();

                            OffersOptionsList.Offers.Add(offer);
                        }

                    }
                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            OptionsByOffer optionsbyoffer = new OptionsByOffer();
                            optionsbyoffer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsbyoffer.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsbyoffer.IdOfferPlant = Convert.ToInt32(companydetails.ConnectPlantId);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsbyoffer.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsbyoffer.Quantity > 0)
                                    optionsbyoffer.IsSelected = true;
                                else
                                    optionsbyoffer.IsSelected = false;
                            }
                            else
                            {
                                optionsbyoffer.IsSelected = false;
                            }

                            optionsbyoffer.OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(itemRow["IdOption"].ToString()), Name = itemRow["offeroption"].ToString(), OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(itemRow["IdOfferOptionType"].ToString()), Name = itemRow["offeroptiontype"].ToString() } };
                            OffersOptionsList.OptionsByOffers.Add(optionsbyoffer);
                        }
                    }
                }
            }

            //Code to get all Po codes from customer purchase orders by idoffers from above query. 
            IList<CustomerPurchaseOrder> customerPurchaseOrders = new List<CustomerPurchaseOrder>();
            try
            {
                string result = String.Join(",", ((List<Offer>)OffersOptionsList.Offers).ConvertAll<string>(d => d.IdOffer.ToString()).ToArray());

                //string[] array = ds.Tables[0].AsEnumerable().Select(row => row["idoffer"].ToString()).ToArray();
                //string result = string.Join(",", array);

                using (MySqlConnection connPurchaseOrder = new MySqlConnection(companydetails.ConnectPlantConstr))
                {
                    connPurchaseOrder.Open();
                    MySqlCommand customerPOCommand = new MySqlCommand("offers_GetOfferPurchaseOrdersByOfferIds", connPurchaseOrder);
                    customerPOCommand.CommandType = CommandType.StoredProcedure;
                    customerPOCommand.Parameters.AddWithValue("_idoffer", result);

                    using (MySqlDataReader poReader = customerPOCommand.ExecuteReader())
                    {
                        while (poReader.Read())
                        {
                            CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                            customerPurchaseOrder.IdOffer = Convert.ToInt64(poReader["IdOffer"].ToString());
                            customerPurchaseOrder.Code = Convert.ToString(poReader["Code"].ToString());
                            customerPurchaseOrder.IdCustomerPurchaseOrders = Convert.ToInt64(poReader["idCustomerPurchaseOrders"].ToString());
                            customerPurchaseOrder.IsGoAhead = Convert.ToByte(poReader["IsGoAhead"].ToString());

                            Offer offer = OffersOptionsList.Offers.FirstOrDefault(x => x.IdOffer == customerPurchaseOrder.IdOffer);
                            if (offer != null)
                            {
                                if (string.IsNullOrEmpty(offer.CustomerPOCodes))
                                {
                                    offer.CustomerPOCodes = string.Format(customerPurchaseOrder.Code);
                                }
                                else
                                {
                                    offer.CustomerPOCodes = string.Format(offer.CustomerPOCodes + "\n" + customerPurchaseOrder.Code);
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
            }

            return OffersOptionsList;
        }

        /// <summary>
        /// This method is to get offer details
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="AccountingYearFrom">Get accounting year From</param>
        /// <param name="AccountingYearTo">Get accounting year To</param>
        /// <param name="companydetails">Get company details</param>
        /// <returns>offer details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          OffersOptionsList = mgr.GetSelectedUsersOrdersDatatable(byte idCurrency, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company companydetails, Int32 idCurrentUser = 0)
        ///          SP :-  offers_GetSelectedUserInvoicesAmount,offers_GetSelectedUsersOrdersDatatable
        ///     }
        /// }
        /// </code>
        /// </example> 
        public OffersOptionsList GetSelectedUsersOrdersDatatable(byte idCurrency, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company companydetails, Int32 idCurrentUser = 0)
        {
            OffersOptionsList OffersOptionsList = new OffersOptionsList();
            OffersOptionsList.Offers = new List<Offer>();
            OffersOptionsList.OptionsByOffers = new List<OptionsByOffer>();
            //OffersOptionsList.LostReasonsByOffers = new List<LostReasonsByOffer>();

            IList<Offer> offerInvoices = new List<Offer>();
            using (MySqlConnection conofferinvoice = new MySqlConnection(companydetails.ConnectPlantConstr))
            {
                conofferinvoice.Open();
                MySqlCommand conofferinvoicecommand = new MySqlCommand("offers_GetInvoicesAmountDateWise", conofferinvoice);
                conofferinvoicecommand.CommandType = CommandType.StoredProcedure;
                conofferinvoicecommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferinvoicecommand.Parameters.AddWithValue("_idUser", idUser);
                conofferinvoicecommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferinvoicecommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferinvoicecommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                conofferinvoicecommand.Parameters.AddWithValue("_idPermission", 21);

                using (MySqlDataReader offerinvoicereader = conofferinvoicecommand.ExecuteReader())
                {
                    while (offerinvoicereader.Read())
                    {
                        Offer offerInvoice = new Offer();
                        offerInvoice.IdOffer = Convert.ToInt64(offerinvoicereader["IdOffer"].ToString());
                        offerInvoice.Value = Convert.ToDouble(offerinvoicereader["InvoiceAmount"].ToString());
                        offerInvoice.Currency = new Currency { Name = offerinvoicereader["InvoiceCurrency"].ToString() };
                        offerInvoices.Add(offerInvoice);
                    }
                }
            }

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companydetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOrdersDatatableDateWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.CommandTimeout = 3000;

                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 21);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            Offer offer = new Offer();
                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());
                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();
                            offer.Site = new Company { Name = itemRow["CustomerName"].ToString() };
                            offer.Site.ConnectPlantId = companydetails.ConnectPlantId;
                            //offer.Site.ConnectPlantConstr = dictconnectstr.Value;

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());
                            }

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());
                            }

                            offer.Site.Customers = new List<Customer> { new Customer { CustomerName = itemRow["CustomerGroup"].ToString() } };
                            offer.Site.Country = new Country { Name = itemRow["CustomerCountry"].ToString(), Zone = new Zone { Name = itemRow["CustomerZone"].ToString() } };
                            offer.GeosStatus = new GeosStatus { Name = itemRow["OfferStatus"].ToString(), HtmlColor = itemRow["OfferStatusColor"].ToString() };

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());
                            else
                                offer.Value = 0;

                            offer.InvoiceAmount = (from record in offerInvoices where record.IdOffer == offer.IdOffer select record.Value).SingleOrDefault();
                            offer.Currency = new Currency { Name = itemRow["OfferCurrency"].ToString() };

                            if (itemRow["PoReceptionDate"] != DBNull.Value)
                                offer.CustomerPurchaseOrdersByOffers = new List<CustomerPurchaseOrdersByOffer>() { new CustomerPurchaseOrdersByOffer { CustomerPurchaseOrder = new CustomerPurchaseOrder { ReceivedIn = Convert.ToDateTime(itemRow["PoReceptionDate"].ToString()) } } };

                            if (itemRow["DeliveryDate"] != DBNull.Value)
                                offer.DeliveryDate = Convert.ToDateTime(itemRow["DeliveryDate"].ToString());
                            else
                                offer.DeliveryDate = null;

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RFQReception = Convert.ToDateTime(itemRow["RFQReception"].ToString());
                            else
                                offer.RFQReception = null;

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.SendIn = Convert.ToDateTime(itemRow["SendIn"].ToString());
                            else
                                offer.SendIn = null;

                            if (itemRow["IdSource"] != DBNull.Value)
                            {
                                offer.IdSource = Convert.ToByte(itemRow["IdSource"].ToString());
                                offer.Source = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdSource"].ToString()), Value = itemRow["Source"].ToString() };
                            }

                            if (itemRow["IdBusinessUnit"] != DBNull.Value)
                            {
                                offer.IdBusinessUnit = Convert.ToByte(itemRow["IdBusinessUnit"].ToString());
                                offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdBusinessUnit"].ToString()), Value = itemRow["BusinessUnit"].ToString() };
                            }

                            if (itemRow["IdCarProject"] != DBNull.Value)
                            {
                                offer.IdCarProject = Convert.ToInt64(itemRow["IdCarProject"].ToString());
                                offer.CarProject = new CarProject();

                                offer.CarProject.IdCarProject = Convert.ToInt32(itemRow["IdCarProject"].ToString());
                                offer.CarProject.Name = itemRow["CarProjectName"].ToString();
                            }

                            if (itemRow["IdCarOEM"] != DBNull.Value)
                            {
                                offer.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM = new CarOEM();
                                offer.CarOEM.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                                offer.CarOEM.Name = itemRow["CarOEM"].ToString();
                            }

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                offer.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory = new ProductCategory();
                                offer.ProductCategory.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory.Name = itemRow["ProductSubCategory"].ToString();

                                if (itemRow["IdCategory"] != DBNull.Value)
                                {
                                    offer.ProductCategory.IdParent = Convert.ToInt64(itemRow["IdCategory"].ToString());
                                    offer.ProductCategory.Category = new ProductCategory();
                                    offer.ProductCategory.Category.IdProductCategory = Convert.ToInt64(itemRow["IdCategory"].ToString());
                                    offer.ProductCategory.Category.Name = itemRow["Category"].ToString();
                                }
                            }

                            ////PO code column
                            //IList<CustomerPurchaseOrder> cpos = customerPurchaseOrders.Where(x => x.IdOffer == offer.IdOffer).ToList();
                            //if (cpos != null && cpos.Count > 0)
                            //{
                            //    offer.CustomerPOCodes = string.Join("\n", cpos.Select(x => x.Code).ToList());
                            //}

                            offer.OptionsByOffers = new List<OptionsByOffer>();
                            // offer.LostReasonsByOffers = new List<LostReasonsByOffer>();
                            OffersOptionsList.Offers.Add(offer);
                        }

                    }
                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            OptionsByOffer optionsbyoffer = new OptionsByOffer();
                            optionsbyoffer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsbyoffer.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsbyoffer.IdOfferPlant = Convert.ToInt32(companydetails.ConnectPlantId);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsbyoffer.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsbyoffer.Quantity > 0)
                                    optionsbyoffer.IsSelected = true;
                                else
                                    optionsbyoffer.IsSelected = false;
                            }
                            else
                            {
                                optionsbyoffer.IsSelected = false;
                            }

                            optionsbyoffer.OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(itemRow["IdOption"].ToString()), Name = itemRow["offeroption"].ToString(), OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(itemRow["IdOfferOptionType"].ToString()), Name = itemRow["offeroptiontype"].ToString() } };
                            OffersOptionsList.OptionsByOffers.Add(optionsbyoffer);
                        }
                    }

                    //if (itemRow.NextResult())
                    //{
                    //    while (itemRow.Read())
                    //    {
                    //        if (itemRow["idoffer"] != DBNull.Value)
                    //        {
                    //            Offer offer = OffersOptionsList.Offers.Where(i => i.IdOffer == Convert.ToInt64(itemRow["idoffer"].ToString())).FirstOrDefault();
                    //            if (offer != null && itemRow["ShipmentDate"] != DBNull.Value)
                    //                offer.ShipmentDate = Convert.ToDateTime(itemRow["ShipmentDate"].ToString());
                    //        }
                    //    }
                    //}
                }
            }

            string result = String.Join(",", ((List<Offer>)OffersOptionsList.Offers).ConvertAll<string>(d => d.IdOffer.ToString()).ToArray());

            try
            {
                using (MySqlConnection conn = new MySqlConnection(companydetails.ConnectPlantConstr))
                {
                    conn.Open();
                    MySqlCommand Command = new MySqlCommand("offers_GetAllShipmentDateBySelectedIdOffer", conn);
                    Command.CommandType = CommandType.StoredProcedure;
                    Command.Parameters.AddWithValue("_idoffer", result);

                    using (MySqlDataReader reader = Command.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            if (reader["idoffer"] != DBNull.Value)
                            {
                                Offer offer = OffersOptionsList.Offers.Where(i => i.IdOffer == Convert.ToInt64(reader["idoffer"].ToString())).FirstOrDefault();
                                if (reader["ShipmentDate"] != DBNull.Value)
                                    offer.ShipmentDate = Convert.ToDateTime(reader["ShipmentDate"].ToString());
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
            }

            //Code to get all Po codes from customer purchase orders by idoffers from above query. 
            IList<CustomerPurchaseOrder> customerPurchaseOrders = new List<CustomerPurchaseOrder>();
            try
            {
                using (MySqlConnection connPurchaseOrder = new MySqlConnection(companydetails.ConnectPlantConstr))
                {
                    connPurchaseOrder.Open();
                    MySqlCommand customerPOCommand = new MySqlCommand("offers_GetOfferPurchaseOrdersByOfferIds", connPurchaseOrder);
                    customerPOCommand.CommandType = CommandType.StoredProcedure;
                    customerPOCommand.Parameters.AddWithValue("_idoffer", result);

                    using (MySqlDataReader poReader = customerPOCommand.ExecuteReader())
                    {
                        while (poReader.Read())
                        {
                            CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                            customerPurchaseOrder.IdOffer = Convert.ToInt64(poReader["IdOffer"].ToString());
                            customerPurchaseOrder.Code = Convert.ToString(poReader["Code"].ToString());
                            customerPurchaseOrder.IdCustomerPurchaseOrders = Convert.ToInt64(poReader["idCustomerPurchaseOrders"].ToString());
                            customerPurchaseOrder.IsGoAhead = Convert.ToByte(poReader["IsGoAhead"].ToString());

                            Offer offer = OffersOptionsList.Offers.FirstOrDefault(x => x.IdOffer == customerPurchaseOrder.IdOffer);
                            if (offer != null)
                            {
                                if (string.IsNullOrEmpty(offer.CustomerPOCodes))
                                {
                                    offer.CustomerPOCodes = string.Format(customerPurchaseOrder.Code);
                                }
                                else
                                {
                                    offer.CustomerPOCodes = string.Format(offer.CustomerPOCodes + "\n" + customerPurchaseOrder.Code);
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
            }

            return OffersOptionsList;
        }



        /// <summary>
        /// This method is to get list of people details
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <returns>List of people details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          peoples = mgr.GetContactsBySalesOwnerId(string connectionstring, Int32 idUser, Int32 idZone, Int32 idUserPermission);
        ///          SP :-  people_GetContactsBySalesOwnerId
        ///     }
        /// }
        /// </code>
        /// </example> 
        public List<People> GetContactsBySalesOwnerId(string connectionstring, Int32 idUser, Int32 idZone, Int32 idUserPermission)
        {
            List<People> peoples = new List<People>();

            using (MySqlConnection conPeople = new MySqlConnection(connectionstring))
            {
                conPeople.Open();
                MySqlCommand conPeoplecommand = new MySqlCommand("people_GetContactsBySalesOwnerId", conPeople);

                conPeoplecommand.CommandType = CommandType.StoredProcedure;
                conPeoplecommand.Parameters.AddWithValue("_idUser", idUser);
                conPeoplecommand.Parameters.AddWithValue("_idZone", idZone);
                conPeoplecommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader peoplereader = conPeoplecommand.ExecuteReader())
                {
                    while (peoplereader.Read())
                    {
                        People people = new People();
                        people.IdPerson = Convert.ToInt32(peoplereader["IdPerson"].ToString());
                        people.Name = peoplereader["FirstName"].ToString();
                        people.Surname = peoplereader["LastName"].ToString();
                        people.Phone = peoplereader["Telephone"].ToString();
                        people.Email = peoplereader["Email"].ToString();
                        if (peoplereader["IdPersonGender"] != DBNull.Value)
                        {
                            people.IdPersonGender = Convert.ToByte(peoplereader["IdPersonGender"].ToString());
                            if (people.IdPersonGender == 1)
                                people.UserGender = "Female";
                            else if (people.IdPersonGender == 2)
                                people.UserGender = "Male";
                        }

                        people.IdPersonType = Convert.ToByte(peoplereader["IdPersonType"].ToString());
                        people.PeopleType = new PeopleType();
                        people.PeopleType.IdPersonType = Convert.ToByte(peoplereader["IdPersonType"].ToString());
                        people.PeopleType.Name = Convert.ToString(peoplereader["PersonTypeName"]);

                        if (peoplereader["CreatedIn"] != DBNull.Value)
                            people.CreatedIn = Convert.ToDateTime(peoplereader["CreatedIn"].ToString());

                        people.Company = new Company() { IdCompany = Convert.ToInt32(peoplereader["IdCompany"].ToString()), Name = peoplereader["CustomerPlant"].ToString(), Country = new Country { IdCountry = Convert.ToByte(peoplereader["IdCountry"].ToString()), Name = peoplereader["Country"].ToString(), Zone = new Zone { Name = peoplereader["Zone"].ToString() } } };
                        people.Company.Address = peoplereader["SiteAddress"].ToString();
                        people.Observations = peoplereader["Observations"].ToString();
                        people.Company.City = peoplereader["SiteCity"].ToString();
                        people.Company.CIF = peoplereader["SiteCIF"].ToString();
                        people.Company.Telephone = peoplereader["SiteTelephone"].ToString();
                        people.Company.Fax = peoplereader["SiteFax"].ToString();
                        people.Company.PostCode = peoplereader["SitePostCode"].ToString();
                        people.Company.ZipCode = peoplereader["SitePostCode"].ToString();
                        people.Company.Region = peoplereader["SiteRegion"].ToString();
                        people.Company.RegisteredName = peoplereader["SiteRegisteredName"].ToString();
                        people.Company.Website = peoplereader["SiteWebsite"].ToString();
                        people.Company.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(peoplereader["IdCustomer"].ToString()), CustomerName = peoplereader["CustomerGroup"].ToString() } };

                        if (peoplereader["IdCompanyDepartment"] != DBNull.Value)
                        {
                            people.IdCompanyDepartment = Convert.ToInt32(peoplereader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment = new LookupValue();
                            people.CompanyDepartment.IdLookupValue = Convert.ToInt32(peoplereader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment.Value = peoplereader["Value"].ToString();

                            if (peoplereader["IdImage"] != DBNull.Value)
                                people.CompanyDepartment.IdImage = Convert.ToInt64(peoplereader["IdImage"].ToString());

                            //if (peoplereader["InUse"] != DBNull.Value)
                            //    people.CompanyDepartment.InUse = Convert.ToBoolean(peoplereader["InUse"].ToString());
                        }

                        people.JobTitle = peoplereader["JobTitle"].ToString();
                        people.ImageText = peoplereader["Image"].ToString();

                        if (peoplereader["IdContactInfluenceLevel"] != DBNull.Value)
                        {
                            people.IdContactInfluenceLevel = Convert.ToInt32(peoplereader["IdContactInfluenceLevel"].ToString());
                            people.InfluenceLevel = new LookupValue();
                            people.InfluenceLevel.IdLookupValue = Convert.ToInt32(peoplereader["IdContactInfluenceLevel"].ToString());
                            people.InfluenceLevel.Value = peoplereader["InfluenceLevel"].ToString();
                            people.InfluenceLevel.HtmlColor = peoplereader["InfluenceLevelHtmlcolor"].ToString();

                            if (peoplereader["InfluenceLevelIdImage"] != DBNull.Value)
                                people.InfluenceLevel.IdImage = Convert.ToInt64(peoplereader["InfluenceLevelIdImage"].ToString());

                            //if (peoplereader["InfluenceLevelInUse"] != DBNull.Value)
                            //    people.InfluenceLevel.InUse = Convert.ToBoolean(peoplereader["InfluenceLevelInUse"].ToString());
                        }

                        if (peoplereader["IdContactEmdepAffinity"] != DBNull.Value)
                        {
                            people.IdContactEmdepAffinity = Convert.ToInt32(peoplereader["IdContactEmdepAffinity"].ToString());
                            people.EmdepAffinity = new LookupValue();
                            people.EmdepAffinity.IdLookupValue = Convert.ToInt32(peoplereader["IdContactEmdepAffinity"].ToString());
                            people.EmdepAffinity.Value = peoplereader["EmdepAffinity"].ToString();
                            people.EmdepAffinity.HtmlColor = peoplereader["EmdepAffinityHtmlcolor"].ToString();

                            if (peoplereader["EmdepAffinityIdImage"] != DBNull.Value)
                                people.EmdepAffinity.IdImage = Convert.ToInt64(peoplereader["EmdepAffinityIdImage"].ToString());

                            //if (peoplereader["EmdepAffinityInUse"] != DBNull.Value)
                            //    people.EmdepAffinity.InUse = Convert.ToBoolean(peoplereader["EmdepAffinityInUse"].ToString());
                        }


                        if (peoplereader["IdContactProductInvolved"] != DBNull.Value)
                        {
                            people.IdContactProductInvolved = Convert.ToInt32(peoplereader["IdContactProductInvolved"].ToString());
                            people.ProductInvolved = new LookupValue();
                            people.ProductInvolved.IdLookupValue = Convert.ToInt32(peoplereader["IdContactProductInvolved"].ToString());
                            people.ProductInvolved.Value = peoplereader["ProductInvolved"].ToString();
                            people.ProductInvolved.HtmlColor = peoplereader["ProductInvolvedLevelHtmlcolor"].ToString();

                            if (peoplereader["ProductInvolvedLevelIdImage"] != DBNull.Value)
                                people.ProductInvolved.IdImage = Convert.ToInt64(peoplereader["ProductInvolvedLevelIdImage"].ToString());

                            //if (peoplereader["ProductInvolvedInUse"] != DBNull.Value)
                            //    people.ProductInvolved.InUse = Convert.ToBoolean(peoplereader["ProductInvolvedInUse"].ToString());
                        }

                        if (peoplereader["IdCompetitor"] != DBNull.Value)
                        {
                            people.IdCompetitor = Convert.ToInt32(peoplereader["IdCompetitor"].ToString());
                            people.Competitor = new Competitor();
                            people.Competitor.IdCompetitor = Convert.ToInt32(peoplereader["IdCompetitor"].ToString());
                            people.Competitor.Name = peoplereader["Competitor"].ToString();
                        }

                        peoples.Add(people);
                    }
                }
            }
            return peoples;
        }


        public List<Shipment> GetAllShipmentsByOfferId(Company company, Int64 idOffer)
        {

            List<Shipment> shipments = new List<Shipment>();

            using (MySqlConnection conShipment = new MySqlConnection(company.ConnectPlantConstr))
            {
                conShipment.Open();
                MySqlCommand conShipmentcommand = new MySqlCommand("shipments_GetAllShipmentsByIdOffer", conShipment);

                conShipmentcommand.CommandType = CommandType.StoredProcedure;
                conShipmentcommand.Parameters.AddWithValue("_idOffer", idOffer);

                using (MySqlDataReader shipmentreader = conShipmentcommand.ExecuteReader())
                {
                    while (shipmentreader.Read())
                    {
                        Shipment shipment = new Shipment();
                        shipment.IdShipment = Convert.ToInt64(shipmentreader["IdShipment"].ToString());
                        shipment.EmdepCode = shipmentreader["EmdepCode"].ToString();
                        shipment.DeliveryDate = Convert.ToDateTime(shipmentreader["DeliveryDate"].ToString());
                        shipment.IdTransportAgency = Convert.ToInt32(shipmentreader["IdTransportAgency"].ToString());
                        shipment.ShipmentNumber = shipmentreader["ShipmentNumber"].ToString();
                        if (shipmentreader["CreatedIn"] != DBNull.Value)
                        {
                            shipment.CreatedIn = Convert.ToDateTime(shipmentreader["CreatedIn"].ToString());
                        }
                        if (shipmentreader["IdTransportAgency"] != DBNull.Value)
                        {
                            shipment.TransportAgency = new TransportAgency();
                            shipment.TransportAgency.IdAgency = Convert.ToInt32(shipmentreader["IdTransportAgency"].ToString());
                            shipment.TransportAgency.Name = shipmentreader["TransportAgnecy"].ToString();
                        }
                        if (shipmentreader["CreatedBy"] != DBNull.Value)
                        {
                            shipment.People = new People();
                            shipment.People.IdPerson = Convert.ToInt32(shipmentreader["CreatedBy"].ToString());
                            shipment.People.Name = shipmentreader["Name"].ToString();
                            shipment.People.Surname = shipmentreader["Surname"].ToString();
                        }
                        shipments.Add(shipment);
                    }
                }
            }
            return shipments;
        }

        public List<PackingBox> GetAllPackingBoxesByShipmentId(Company company, Int64 idShipment)
        {

            List<PackingBox> packingBoxes = new List<PackingBox>();

            using (MySqlConnection conShipment = new MySqlConnection(company.ConnectPlantConstr))
            {
                conShipment.Open();
                MySqlCommand conShipmentcommand = new MySqlCommand("packingboxes_GetAllPackingBoxesByIdShipment", conShipment);

                conShipmentcommand.CommandType = CommandType.StoredProcedure;
                conShipmentcommand.Parameters.AddWithValue("_IdShipment", idShipment);

                using (MySqlDataReader shipmentreader = conShipmentcommand.ExecuteReader())
                {
                    while (shipmentreader.Read())
                    {
                        PackingBox packingBox = new PackingBox();
                        packingBox.IdShipment = Convert.ToInt64(shipmentreader["IdShipment"].ToString());
                        packingBox.Quantity = Convert.ToInt64(shipmentreader["Quantity"].ToString());
                        packingBox.IdPackingBox = Convert.ToInt64(shipmentreader["IdPackingBox"].ToString());
                        packingBox.IdSite = Convert.ToInt32(shipmentreader["IdSite"].ToString());
                        packingBox.BoxNumber = shipmentreader["BoxNumber"].ToString();
                        packingBox.Comments = shipmentreader["attComment"].ToString();
                        packingBox.Length = Convert.ToDouble(shipmentreader["Length"].ToString());
                        packingBox.Width = Convert.ToDouble(shipmentreader["Width"].ToString());
                        packingBox.Height = Convert.ToDouble(shipmentreader["Height"].ToString());
                        packingBox.SizeMeasurementUnit = shipmentreader["SizeMeasurementUnit"].ToString();
                        packingBox.WeightMeasurementUnit = shipmentreader["WeightMeasurementUnit"].ToString();
                        packingBox.NetWeight = Convert.ToDouble(shipmentreader["NetWeight"].ToString());
                        packingBox.GrossWeight = Convert.ToDouble(shipmentreader["GrossWeight"].ToString());
                        packingBox.Shipment = new Shipment();
                        packingBox.Shipment.IdShipment = Convert.ToInt64(shipmentreader["IdShipment"].ToString());
                        packingBox.Shipment.Comments = shipmentreader["comments"].ToString();
                        packingBox.Shipment.DeliveryDate = Convert.ToDateTime(shipmentreader["DeliveryDate"].ToString());
                        packingBoxes.Add(packingBox);
                    }
                }
            }
            return packingBoxes;
        }

        /// <summary>
        /// This method is to get list of people
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idUser">Get user id</param>
        /// <returns>List of people</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          peoples = mgr.GetSelectedUserContactsBySalesOwnerId(string connectionstring, string idUser);
        ///          SP :-  people_GetSelectedUserContactsBySalesOwnerId
        ///     }
        /// }
        /// </code>
        /// </example> 
        public List<People> GetSelectedUserContactsBySalesOwnerId(string connectionstring, string idUser)
        {

            List<People> peoples = new List<People>();

            using (MySqlConnection conPeople = new MySqlConnection(connectionstring))
            {
                conPeople.Open();
                MySqlCommand conPeoplecommand = new MySqlCommand("people_GetSelectedUserContactsBySalesOwnerId", conPeople);

                conPeoplecommand.CommandType = CommandType.StoredProcedure;
                conPeoplecommand.Parameters.AddWithValue("_idUser", idUser);
                using (MySqlDataReader peoplereader = conPeoplecommand.ExecuteReader())
                {
                    while (peoplereader.Read())
                    {
                        People people = new People();
                        people.IdPerson = Convert.ToInt32(peoplereader["IdPerson"].ToString());
                        people.Name = peoplereader["FirstName"].ToString();
                        people.Surname = peoplereader["LastName"].ToString();
                        people.Phone = peoplereader["Telephone"].ToString();
                        people.Email = peoplereader["Email"].ToString();
                        if (peoplereader["IdPersonGender"] != DBNull.Value)
                        {
                            people.IdPersonGender = Convert.ToByte(peoplereader["IdPersonGender"].ToString());
                            if (people.IdPersonGender == 1)
                                people.UserGender = "Female";
                            else if (people.IdPersonGender == 2)
                                people.UserGender = "Male";
                        }

                        people.IdPersonType = Convert.ToByte(peoplereader["IdPersonType"].ToString());
                        people.PeopleType = new PeopleType();
                        people.PeopleType.IdPersonType = Convert.ToByte(peoplereader["IdPersonType"].ToString());
                        people.PeopleType.Name = Convert.ToString(peoplereader["PersonTypeName"]);

                        if (peoplereader["CreatedIn"] != DBNull.Value)
                            people.CreatedIn = Convert.ToDateTime(peoplereader["CreatedIn"].ToString());

                        people.Company = new Company() { IdCompany = Convert.ToInt32(peoplereader["IdCompany"].ToString()), Name = peoplereader["CustomerPlant"].ToString(), Country = new Country { IdCountry = Convert.ToByte(peoplereader["IdCountry"].ToString()), Name = peoplereader["Country"].ToString(), Zone = new Zone { Name = peoplereader["Zone"].ToString() } } };
                        people.Company.Address = peoplereader["SiteAddress"].ToString();
                        people.Observations = peoplereader["Observations"].ToString();
                        people.Company.City = peoplereader["SiteCity"].ToString();
                        people.Company.CIF = peoplereader["SiteCIF"].ToString();
                        people.Company.Telephone = peoplereader["SiteTelephone"].ToString();
                        people.Company.Fax = peoplereader["SiteFax"].ToString();
                        people.Company.PostCode = peoplereader["SitePostCode"].ToString();
                        people.Company.ZipCode = peoplereader["SitePostCode"].ToString();
                        people.Company.Region = peoplereader["SiteRegion"].ToString();
                        people.Company.RegisteredName = peoplereader["SiteRegisteredName"].ToString();
                        people.Company.Website = peoplereader["SiteWebsite"].ToString();
                        people.Company.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(peoplereader["IdCustomer"].ToString()), CustomerName = peoplereader["CustomerGroup"].ToString() } };
                        people.Company.Region = peoplereader["SiteRegion"].ToString();
                        people.Company.RegisteredName = peoplereader["SiteRegisteredName"].ToString();
                        people.Company.Website = peoplereader["SiteWebsite"].ToString();

                        if (peoplereader["IdCompanyDepartment"] != DBNull.Value)
                        {
                            people.IdCompanyDepartment = Convert.ToInt32(peoplereader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment = new LookupValue();
                            people.CompanyDepartment.IdLookupValue = Convert.ToInt32(peoplereader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment.Value = peoplereader["Value"].ToString();
                            if (peoplereader["IdImage"] != DBNull.Value)
                                people.CompanyDepartment.IdImage = Convert.ToInt64(peoplereader["IdImage"].ToString());
                            //if (peoplereader["InUse"] != DBNull.Value)
                            //    people.CompanyDepartment.InUse = Convert.ToBoolean(peoplereader["InUse"].ToString());
                        }

                        people.JobTitle = peoplereader["JobTitle"].ToString();
                        people.ImageText = peoplereader["Image"].ToString();

                        if (peoplereader["IdContactInfluenceLevel"] != DBNull.Value)
                        {
                            people.IdContactInfluenceLevel = Convert.ToInt32(peoplereader["IdContactInfluenceLevel"].ToString());
                            people.InfluenceLevel = new LookupValue();
                            people.InfluenceLevel.IdLookupValue = Convert.ToInt32(peoplereader["IdContactInfluenceLevel"].ToString());
                            people.InfluenceLevel.Value = peoplereader["InfluenceLevel"].ToString();
                            people.InfluenceLevel.HtmlColor = peoplereader["InfluenceLevelHtmlcolor"].ToString();

                            if (peoplereader["InfluenceLevelIdImage"] != DBNull.Value)
                                people.InfluenceLevel.IdImage = Convert.ToInt64(peoplereader["InfluenceLevelIdImage"].ToString());

                            //if (peoplereader["InfluenceLevelInUse"] != DBNull.Value)
                            //    people.InfluenceLevel.InUse = Convert.ToBoolean(peoplereader["InfluenceLevelInUse"].ToString());
                        }

                        if (peoplereader["IdContactEmdepAffinity"] != DBNull.Value)
                        {
                            people.IdContactEmdepAffinity = Convert.ToInt32(peoplereader["IdContactEmdepAffinity"].ToString());
                            people.EmdepAffinity = new LookupValue();
                            people.EmdepAffinity.IdLookupValue = Convert.ToInt32(peoplereader["IdContactEmdepAffinity"].ToString());
                            people.EmdepAffinity.Value = peoplereader["EmdepAffinity"].ToString();
                            people.EmdepAffinity.HtmlColor = peoplereader["EmdepAffinityHtmlcolor"].ToString();

                            if (peoplereader["EmdepAffinityIdImage"] != DBNull.Value)
                                people.EmdepAffinity.IdImage = Convert.ToInt64(peoplereader["EmdepAffinityIdImage"].ToString());
                            //if (peoplereader["EmdepAffinityInUse"] != DBNull.Value)
                            //    people.EmdepAffinity.InUse = Convert.ToBoolean(peoplereader["EmdepAffinityInUse"].ToString());
                        }


                        if (peoplereader["IdContactProductInvolved"] != DBNull.Value)
                        {
                            people.IdContactProductInvolved = Convert.ToInt32(peoplereader["IdContactProductInvolved"].ToString());
                            people.ProductInvolved = new LookupValue();
                            people.ProductInvolved.IdLookupValue = Convert.ToInt32(peoplereader["IdContactProductInvolved"].ToString());
                            people.ProductInvolved.Value = peoplereader["ProductInvolved"].ToString();
                            people.ProductInvolved.HtmlColor = peoplereader["ProductInvolvedLevelHtmlcolor"].ToString();

                            if (peoplereader["ProductInvolvedLevelIdImage"] != DBNull.Value)
                                people.ProductInvolved.IdImage = Convert.ToInt64(peoplereader["ProductInvolvedLevelIdImage"].ToString());

                            //if (peoplereader["ProductInvolvedInUse"] != DBNull.Value)
                            //    people.ProductInvolved.InUse = Convert.ToBoolean(peoplereader["ProductInvolvedInUse"].ToString());
                        }

                        if (peoplereader["IdCompetitor"] != DBNull.Value)
                        {
                            people.IdCompetitor = Convert.ToInt32(peoplereader["IdCompetitor"].ToString());
                            people.Competitor = new Competitor();
                            people.Competitor.IdCompetitor = Convert.ToInt32(peoplereader["IdCompetitor"].ToString());
                            people.Competitor.Name = peoplereader["Competitor"].ToString();
                        }

                        peoples.Add(people);
                    }
                }
            }
            return peoples;
        }

        /// <summary>
        /// This method is to update contact or not
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="people">Get people detail</param>
        /// <returns>Is updated contact or not</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          bool isUpdated = mgr.UpdateContact(string connectionstring, People people);
        ///          SP :-  people_UpdateContact
        ///     }
        /// }
        /// </code>
        /// </example> 
        public bool UpdateContact(string mainServerConnectionString, People people)
        {
            TransactionScope transactionScope = null;
            List<People> peoples = new List<People>();

            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection concompany = new MySqlConnection(mainServerConnectionString))
                    {
                        concompany.Open();

                        MySqlCommand concompanycommand = new MySqlCommand("people_UpdateContact", concompany);
                        concompanycommand.CommandType = CommandType.StoredProcedure;
                        concompanycommand.Parameters.AddWithValue("_IdPerson", people.IdPerson);
                        concompanycommand.Parameters.AddWithValue("_Name", people.Name);
                        concompanycommand.Parameters.AddWithValue("_Surname", people.Surname);
                        concompanycommand.Parameters.AddWithValue("_Email", people.Email);
                        concompanycommand.Parameters.AddWithValue("_IdSite", people.IdSite);
                        concompanycommand.Parameters.AddWithValue("_Phone", people.Phone);
                        concompanycommand.Parameters.AddWithValue("_Observations", people.Observations);
                        concompanycommand.Parameters.AddWithValue("_IdPersonGender", people.IdPersonGender);
                        concompanycommand.Parameters.AddWithValue("_IdCompany", people.Company.IdCompany);
                        concompanycommand.Parameters.AddWithValue("_IdCountry", people.Company.IdCountry);
                        concompanycommand.Parameters.AddWithValue("_Address", people.Company.Address);
                        concompanycommand.Parameters.AddWithValue("_Telephone", people.Company.Telephone);
                        concompanycommand.Parameters.AddWithValue("_CompanyEmail", people.Company.Email);
                        concompanycommand.Parameters.AddWithValue("_Region", people.Company.Region);
                        concompanycommand.Parameters.AddWithValue("_City", people.Company.City);
                        concompanycommand.Parameters.AddWithValue("_PostCode", people.Company.ZipCode);
                        concompanycommand.Parameters.AddWithValue("_ModifiedBy", people.Company.ModifiedBy);
                        concompanycommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        concompanycommand.Parameters.AddWithValue("_IdCompanyDepartment", people.IdCompanyDepartment);
                        concompanycommand.Parameters.AddWithValue("_JobTitle", people.JobTitle);
                        concompanycommand.Parameters.AddWithValue("_Image", people.ImageText);
                        concompanycommand.Parameters.AddWithValue("_IdContactInfluenceLevel", people.IdContactInfluenceLevel);
                        concompanycommand.Parameters.AddWithValue("_IdContactEmdepAffinity", people.IdContactEmdepAffinity);
                        concompanycommand.Parameters.AddWithValue("_IdContactProductInvolved", people.IdContactProductInvolved);
                        concompanycommand.Parameters.AddWithValue("_IdCompetitor", people.IdCompetitor);

                        concompanycommand.ExecuteNonQuery();
                        concompany.Close();
                    }

                    if (people.CommentsByContact != null && people.CommentsByContact.Count > 0)
                        AddUpdateDeleteCommentsByContact(people.IdPerson, people.CommentsByContact, mainServerConnectionString);

                    if (people.LogEntriesByContact != null && people.LogEntriesByContact.Count > 0)
                        AddLogEntriesByContact(people.IdPerson, people.LogEntriesByContact, mainServerConnectionString);

                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();

                throw;
            }

            return true;
        }

        /// <summary>
        /// This method is to add contact
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="people">Get people details</param>
        /// <returns>Added people details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          People people = mgr.AddContact(string connectionstring, People people);
        ///          SP :-  people_InsertContact
        ///     }
        /// }
        /// </code>
        /// </example> 
        public People AddContact(string mainServerConnectionString, People people)
        {
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("people_InsertContact", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdPersonType", people.IdPersonType);
                        mySqlCommand.Parameters.AddWithValue("_Name", people.Name);
                        mySqlCommand.Parameters.AddWithValue("_Surname", people.Surname);
                        mySqlCommand.Parameters.AddWithValue("_Email", people.Email);
                        mySqlCommand.Parameters.AddWithValue("_Phone", people.Phone);
                        mySqlCommand.Parameters.AddWithValue("_Observations", people.Observations);
                        mySqlCommand.Parameters.AddWithValue("_IdPersonGender", people.IdPersonGender);
                        mySqlCommand.Parameters.AddWithValue("_IdCompany", people.Company.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdCountry", people.Company.IdCountry);
                        mySqlCommand.Parameters.AddWithValue("_Address", people.Company.Address);
                        mySqlCommand.Parameters.AddWithValue("_Telephone", people.Company.Telephone);
                        mySqlCommand.Parameters.AddWithValue("_CompanyEmail", people.Company.Email);
                        mySqlCommand.Parameters.AddWithValue("_Region", people.Company.Region);
                        mySqlCommand.Parameters.AddWithValue("_City", people.Company.City);
                        mySqlCommand.Parameters.AddWithValue("_PostCode", people.Company.ZipCode);
                        mySqlCommand.Parameters.AddWithValue("_ModifiedBy", people.Company.ModifiedBy);
                        mySqlCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                        mySqlCommand.Parameters.AddWithValue("_IdCompanyDepartment", people.IdCompanyDepartment);
                        mySqlCommand.Parameters.AddWithValue("_JobTitle", people.JobTitle);
                        mySqlCommand.Parameters.AddWithValue("_Image", people.ImageText);
                        mySqlCommand.Parameters.AddWithValue("_IdContactInfluenceLevel", people.IdContactInfluenceLevel);
                        mySqlCommand.Parameters.AddWithValue("_IdContactEmdepAffinity", people.IdContactEmdepAffinity);
                        mySqlCommand.Parameters.AddWithValue("_IdContactProductInvolved", people.IdContactProductInvolved);
                        mySqlCommand.Parameters.AddWithValue("_IdCompetitor", people.IdCompetitor);

                        people.IdPerson = Convert.ToInt32(mySqlCommand.ExecuteScalar());
                        mySqlConnection.Close();
                    }

                    if (people.CommentsByContact != null && people.CommentsByContact.Count > 0)
                        AddUpdateDeleteCommentsByContact(people.IdPerson, people.CommentsByContact, mainServerConnectionString);

                    if (people.LogEntriesByContact != null && people.LogEntriesByContact.Count > 0)
                        AddLogEntriesByContact(people.IdPerson, people.LogEntriesByContact, mainServerConnectionString);

                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();

                throw;
            }

            return people;
        }

        /// <summary>
        /// This method is to add customer
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="customer">Get customer details</param>
        /// <returns>Added customer details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          Customer customer = mgr.AddCustomer(string connectionstring, Customer customer);
        ///          SP :-  customers_InsertCustomer
        ///     }
        /// }
        /// </code>
        /// </example> 
        public Customer AddCustomer(string connectionstring, Customer customer)
        {
            using (MySqlConnection concompany = new MySqlConnection(connectionstring))
            {
                concompany.Open();
                using (MySqlTransaction trans = concompany.BeginTransaction())
                {
                    try
                    {
                        MySqlCommand concompanycommand = new MySqlCommand("customers_InsertCustomer", concompany);
                        concompanycommand.CommandType = CommandType.StoredProcedure;
                        concompanycommand.Parameters.AddWithValue("_Name", customer.CustomerName);
                        concompanycommand.Parameters.AddWithValue("_IdCustomerType", customer.IdCustomerType);
                        concompanycommand.Parameters.AddWithValue("_Logo", customer.Logo);
                        concompanycommand.Parameters.AddWithValue("_PatternForConnectorReferences", customer.PatternForConnectorReferences);
                        concompanycommand.Parameters.AddWithValue("_Web", customer.Web);
                        concompanycommand.Parameters.AddWithValue("_IsStillActive", customer.IsStillActive);
                        concompanycommand.Transaction = trans;
                        customer.IdCustomer = Convert.ToInt32(concompanycommand.ExecuteScalar());
                        trans.Commit();
                    }
                    catch (Exception ex)
                    {
                        trans.Rollback();
                        throw;
                    }
                }
            }
            return customer;
        }

        /// <summary>
        /// This method is to get all countries
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>List of countries</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          countries = mgr.GetAllCountries(string connectionstring);
        ///          QUERY :-  "select name, idCountry from countries order by name;";
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<Country> GetAllCountries(string connectionstring)
        {

            List<Country> countries = new List<Country>();

            using (MySqlConnection conCountry = new MySqlConnection(connectionstring))
            {
                conCountry.Open();
                //string query = "select name, idCountry from countries order by name;";
                MySqlCommand conCountrycommand = new MySqlCommand("countries_GetAllCountries", conCountry);
                conCountrycommand.CommandType = CommandType.StoredProcedure;
                using (MySqlDataReader countryreader = conCountrycommand.ExecuteReader())
                {
                    while (countryreader.Read())
                    {
                        Country country = new Country();
                        country.IdCountry = Convert.ToByte(countryreader["idCountry"].ToString());
                        country.Name = countryreader["name"].ToString();
                        countries.Add(country);
                    }
                }
            }

            return countries;
        }


        public List<SalesUserQuota> GetAllSalesUserDetails(string connectionString, byte idCurrency, Int32 accountingYear)
        {

            List<SalesUserQuota> salesUsers = new List<SalesUserQuota>();

            using (MySqlConnection conSalesUser = new MySqlConnection(connectionString))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("salesusers_GetAllSalesUserDetails", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                using (MySqlDataReader salesUserreader = conSalesUsercommand.ExecuteReader())
                {
                    while (salesUserreader.Read())
                    {
                        SalesUserQuota salesUser = new SalesUserQuota();
                        if (salesUserreader["IdSalesUser"] != DBNull.Value)
                            salesUser.IdSalesUser = Convert.ToInt32(salesUserreader["IdSalesUser"].ToString());

                        if (salesUserreader["IdSalesQuotaCurrency"] != DBNull.Value)
                            salesUser.IdSalesQuotaCurrency = Convert.ToByte(salesUserreader["IdSalesQuotaCurrency"].ToString());
                        if (salesUserreader["SalesQuotaAmount"] != DBNull.Value)
                            salesUser.SalesQuotaAmount = Convert.ToDouble(salesUserreader["SalesQuotaAmount"].ToString());
                        if (salesUserreader["Year"] != DBNull.Value)
                            salesUser.Year = Convert.ToInt32(salesUserreader["Year"].ToString());
                        if (salesUserreader["IdPerson"] != DBNull.Value)
                        {
                            salesUser.People = new People();

                            salesUser.People.IdPerson = Convert.ToInt32(salesUserreader["IdPerson"].ToString());
                            salesUser.People.Name = salesUserreader["Name"].ToString();
                            salesUser.People.Surname = salesUserreader["Surname"].ToString();
                        }
                        salesUsers.Add(salesUser);
                    }
                }
            }

            return salesUsers;
        }



        public double GetWonValueByIdSaleUser(Company company, byte idCurrency, Int32 idUser, Int64 accountingYear)
        {
            double amount = 0.00;

            using (MySqlConnection conSalesUser = new MySqlConnection(company.ConnectPlantConstr))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("offers_GetWonValueByIdSaleUser", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conSalesUsercommand.Parameters.AddWithValue("_idUser", idUser);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                using (MySqlDataReader salesUserreader = conSalesUsercommand.ExecuteReader())
                {
                    if (salesUserreader.Read())
                    {
                        if (salesUserreader["Amount"] != DBNull.Value)
                            amount = Convert.ToDouble(salesUserreader["Amount"].ToString());
                    }
                }
            }

            return amount;
        }


        public double GetWonValueByIdSaleUser(Company company, byte idCurrency, Int32 idUser, DateTime accountingYearFrom, DateTime accountingYearTo)
        {
            double amount = 0.00;

            using (MySqlConnection conSalesUser = new MySqlConnection(company.ConnectPlantConstr))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("offers_GetWonValueByIdSaleUserDateWise", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conSalesUsercommand.Parameters.AddWithValue("_idUser", idUser);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                using (MySqlDataReader salesUserreader = conSalesUsercommand.ExecuteReader())
                {
                    if (salesUserreader.Read())
                    {
                        if (salesUserreader["Amount"] != DBNull.Value)
                            amount = Convert.ToDouble(salesUserreader["Amount"].ToString());
                    }
                }
            }

            return amount;
        }


        /// <summary>
        /// This method is to get all offer options
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>List of offer option</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          countries = mgr.GetAllOfferOptions(string connectionstring);
        ///          SP :-  offeroptions_GetAllofferoptions
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<OfferOption> GetAllOfferOptions(string connectionstring)
        {

            List<OfferOption> offerOptions = new List<OfferOption>();
            using (MySqlConnection conofferOptions = new MySqlConnection(connectionstring))
            {
                conofferOptions.Open();
                MySqlCommand conofferOptionscommand = new MySqlCommand("offeroptions_GetAllofferoptions", conofferOptions);
                conofferOptionscommand.CommandType = CommandType.StoredProcedure;
                using (MySqlDataReader offerOptionsreader = conofferOptionscommand.ExecuteReader())
                {
                    while (offerOptionsreader.Read())
                    {
                        OfferOption offerOption = new OfferOption();
                        offerOption.IdOfferOption = Convert.ToInt64(offerOptionsreader["idOfferOption"]);
                        offerOption.Name = Convert.ToString(offerOptionsreader["Name"]);
                        offerOption.IdOfferOptionType = Convert.ToInt32(offerOptionsreader["IdOfferOptionType"]);
                        offerOption.OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(offerOptionsreader["IdOfferOptionType"].ToString()), Name = offerOptionsreader["offeroptiontype"].ToString() };

                        if (offerOptionsreader["IsObsolete"] != DBNull.Value)
                            offerOption.IsObsolete = Convert.ToSByte(offerOptionsreader.GetByte(offerOptionsreader.GetOrdinal("IsObsolete")));

                        offerOptions.Add(offerOption);
                    }
                }
            }
            return offerOptions;
        }

        /// <summary>
        /// This method is to get sales owner by customer id
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCustomer">Get customer id</param>
        /// <returns>list of people</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          peoples = mgr.GetSalesOwnerBySiteId(string connectionstring, Int32 idSite);
        ///          SP :-  sites_GetSalesOwnerBySiteId
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<People> GetSalesOwnerBySiteId(string connectionstring, Int32 idSite)
        {

            List<People> peoples = new List<People>();
            using (MySqlConnection conPeople = new MySqlConnection(connectionstring))
            {
                conPeople.Open();
                MySqlCommand conPeoplecommand = new MySqlCommand("sites_GetSalesOwnerBySiteId", conPeople);
                conPeoplecommand.CommandType = CommandType.StoredProcedure;
                conPeoplecommand.Parameters.AddWithValue("_idSite", idSite);
                using (MySqlDataReader peoplereader = conPeoplecommand.ExecuteReader())
                {
                    while (peoplereader.Read())
                    {
                        People people = new People();
                        people.IdPerson = Convert.ToInt32(peoplereader["IdPerson"].ToString());
                        people.Name = peoplereader["Name"].ToString();
                        people.Surname = peoplereader["Surname"].ToString();
                        people.Email = peoplereader["Email"].ToString();

                        if (peoplereader["IdSalesResponsible"] != DBNull.Value && peoplereader["IdPerson"] != DBNull.Value)
                        {
                            if (Convert.ToInt32(peoplereader["IdPerson"].ToString()) == Convert.ToInt32(peoplereader["IdSalesResponsible"].ToString()))
                            {
                                people.IsSalesResponsible = true;
                                people.IsSelected = true;
                            }
                        }
                        peoples.Add(people);
                    }
                }
            }
            return peoples;
        }

        /// <summary>
        /// This method is to get list of car oems
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>list of CarOEMs</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          carOEMs = mgr.GetCarOEM(string connectionstring);
        ///          SP :-  caroems_GetCarOEM
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<CarOEM> GetCarOEM(string connectionstring)
        {

            List<CarOEM> carOEMs = new List<CarOEM>();
            using (MySqlConnection conCarOEM = new MySqlConnection(connectionstring))
            {
                conCarOEM.Open();
                MySqlCommand conCarOEMcommand = new MySqlCommand("caroems_GetCarOEM", conCarOEM);
                conCarOEMcommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader CarOEMreader = conCarOEMcommand.ExecuteReader())
                {
                    while (CarOEMreader.Read())
                    {
                        CarOEM carOEM = new CarOEM();
                        carOEM.IdCarOEM = Convert.ToInt32(CarOEMreader["IdCarOEM"].ToString());
                        carOEM.Name = CarOEMreader["Name"].ToString();
                        carOEMs.Add(carOEM);
                    }
                }
            }
            return carOEMs;
        }

        /// <summary>
        /// This method is to get list of competitors
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>List of competitors</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          competitors = mgr.GetCompetitors(string connectionstring);
        ///          SP :-  competitors_GetCompetitors
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<Competitor> GetCompetitors(string connectionstring)
        {

            List<Competitor> competitors = new List<Competitor>();
            using (MySqlConnection concompetitor = new MySqlConnection(connectionstring))
            {
                concompetitor.Open();
                MySqlCommand concompetitorcommand = new MySqlCommand("competitors_GetCompetitors", concompetitor);
                concompetitorcommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader competitorreader = concompetitorcommand.ExecuteReader())
                {
                    while (competitorreader.Read())
                    {
                        Competitor competitor = new Competitor();
                        competitor.IdCompetitor = Convert.ToInt32(competitorreader["IdCompetitor"].ToString());
                        competitor.Name = competitorreader["Name"].ToString();
                        competitors.Add(competitor);
                    }
                }
            }
            return competitors;
        }

        /// <summary>
        /// This method is to get list of geos project
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCustomer">Get customer id</param>
        /// <returns>List of geos project</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          geosProjects = mgr.GetProjectByCustomerId(string connectionstring, Int64 idCustomer);
        ///          SP :-  projects_GetProjectsByCustomerId
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<GeosProject> GetProjectByCustomerId(string connectionstring, Int64 idCustomer)
        {

            List<GeosProject> geosProjects = new List<GeosProject>();
            using (MySqlConnection congeosProject = new MySqlConnection(connectionstring))
            {
                congeosProject.Open();
                MySqlCommand congeosProjectcommand = new MySqlCommand("projects_GetProjectsByCustomerId", congeosProject);
                congeosProjectcommand.CommandType = CommandType.StoredProcedure;
                congeosProjectcommand.Parameters.AddWithValue("_IdCustomer", idCustomer);

                using (MySqlDataReader geosProjectreader = congeosProjectcommand.ExecuteReader())
                {
                    while (geosProjectreader.Read())
                    {
                        GeosProject geosProject = new GeosProject();
                        geosProject.IdProject = Convert.ToInt32(geosProjectreader["IdProject"].ToString());
                        geosProject.Code = geosProjectreader["Code"].ToString();
                        geosProject.Title = geosProjectreader["Title"].ToString();
                        geosProjects.Add(geosProject);
                    }
                }
            }
            return geosProjects;
        }

        /// <summary>
        /// This method is to get list of company 
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of companies</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          companies = mgr.GetCustomersBySalesOwnerId(string connectionstring, Int32 idUser, Int32 idZone, Int32 idUserPermission);
        ///          SP :-  sites_GetCustomersBySalesOwnerId
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<Company> GetCustomersBySalesOwnerId(string connectionstring, Int32 idUser, Int32 idZone, Int32 idUserPermission)
        {

            List<Company> companies = new List<Company>();
            DataTable dt = new DataTable();
            using (MySqlConnection concompany = new MySqlConnection(connectionstring))
            {
                concompany.Open();
                MySqlCommand concompanycommand = new MySqlCommand("sites_GetCustomersBySalesOwnerId", concompany);
                concompanycommand.CommandType = CommandType.StoredProcedure;
                concompanycommand.Parameters.AddWithValue("_idUser", idUser);
                concompanycommand.Parameters.AddWithValue("_idZone", idZone);
                concompanycommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                MySqlDataAdapter da = new MySqlDataAdapter(concompanycommand);
                //DataSet ds = new DataSet();
                da.Fill(dt);
            }
            foreach (DataRow companyreader in dt.Rows)
            {
                Company company = new Company();
                company.IdCompany = Convert.ToInt32(companyreader["IdSite"].ToString());
                company.Name = companyreader["CustomerPlant"].ToString();
                company.RegisteredName = companyreader["RegisteredName"].ToString();
                company.CIF = companyreader["RegistrationNumber"].ToString();
                company.IdCountry = Convert.ToByte(companyreader["idCountry"].ToString());
                company.Country = new Country { IdCountry = Convert.ToByte(companyreader["idCountry"].ToString()), Name = companyreader["Country"].ToString() };
                company.City = companyreader["City"].ToString();
                company.Address = companyreader["Address"].ToString();
                company.Telephone = companyreader["Phone"].ToString();
                company.ZipCode = companyreader["PostCode"].ToString();
                company.Fax = companyreader["Fax"].ToString();
                company.Website = companyreader["WebSite"].ToString();
                company.Email = companyreader["Email"].ToString();
                company.Region = companyreader["Region"].ToString();
                company.ShortName = companyreader["ShortName"].ToString();
                if (companyreader["IdSalesResponsible"] != DBNull.Value)
                {
                    company.IdSalesResponsible = Convert.ToInt32(companyreader["IdSalesResponsible"].ToString());
                    company.People = new People { IdPerson = Convert.ToInt32(companyreader["IdSalesResponsible"].ToString()), Name = companyreader["SalesResponsibleName"].ToString(), Surname = companyreader["SalesResponsibleSurname"].ToString() };
                }

                if (companyreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                {
                    company.IdSalesResponsibleAssemblyBU = Convert.ToInt32(companyreader["IdSalesResponsibleAssemblyBU"].ToString());
                    company.PeopleSalesResponsibleAssemblyBU = new People { IdPerson = Convert.ToInt32(companyreader["IdSalesResponsibleAssemblyBU"].ToString()), Name = companyreader["SalesResponsiblebuName"].ToString(), Surname = companyreader["SalesResponsiblebuSurname"].ToString() };
                }

                company.Country.Zone = new Zone { Name = companyreader["SalesZone"].ToString() };
                company.IdCustomer = Convert.ToInt32(companyreader["IdCustomer"].ToString());
                company.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(companyreader["IdCustomer"].ToString()), CustomerName = companyreader["CustomerGroup"].ToString() } };
                if (companyreader["Line"] != DBNull.Value)
                    company.Line = Convert.ToInt32(companyreader["Line"].ToString());
                if (companyreader["CuttingMachines"] != DBNull.Value)
                    company.CuttingMachines = Convert.ToInt32(companyreader["CuttingMachines"].ToString());
                if (companyreader["Size"] != DBNull.Value)
                    company.Size = Convert.ToDouble(companyreader["Size"].ToString());
                if (companyreader["NumberOfEmployees"] != DBNull.Value)
                    company.NumberOfEmployees = Convert.ToInt32(companyreader["NumberOfEmployees"].ToString());
                if (companyreader["IdBusinessField"] != DBNull.Value)
                {
                    company.IdBusinessField = Convert.ToByte(companyreader["IdBusinessField"].ToString());
                    company.BusinessField = new LookupValue { IdLookupValue = Convert.ToByte(companyreader["IdBusinessField"].ToString()), Value = companyreader["BusinessField"].ToString() };
                }
                if (companyreader["IdBusinessCenter"] != DBNull.Value)
                {
                    company.IdBusinessCenter = Convert.ToByte(companyreader["IdBusinessCenter"].ToString());
                    company.BusinessCenter = new LookupValue { IdLookupValue = Convert.ToByte(companyreader["IdBusinessCenter"].ToString()), Value = companyreader["BusinessCenter"].ToString() };
                }

                if (companyreader["IdBusinessType"] != DBNull.Value)
                {
                    company.IdBusinessType = Convert.ToByte(companyreader["IdBusinessType"].ToString());
                    company.BusinessType = new LookupValue { IdLookupValue = Convert.ToByte(companyreader["IdBusinessType"].ToString()), Value = companyreader["BusinessType"].ToString() };
                }
                if (companyreader["Latitude"] != DBNull.Value)
                {
                    company.Latitude = Convert.ToDouble(companyreader["Latitude"].ToString());
                    company.BothLongitudeLatitude = company.Latitude.ToString();
                }
                if (companyreader["Longitude"] != DBNull.Value)
                {
                    company.Longitude = Convert.ToDouble(companyreader["Longitude"].ToString());
                    company.BothLongitudeLatitude = company.BothLongitudeLatitude + company.Longitude.ToString();
                }
                if (companyreader["ModifiedIn"] != DBNull.Value)
                    company.ModifiedIn = Convert.ToDateTime(companyreader["ModifiedIn"].ToString());
                if (companyreader["CreatedIn"] != DBNull.Value)
                    company.CreatedIn = Convert.ToDateTime(companyreader["CreatedIn"].ToString());

                company.GroupPlantName = companyreader["GroupPlantName"].ToString();

                if (companyreader["CreatedBy"] != DBNull.Value)
                {
                    company.CreatedBy = Convert.ToInt32(companyreader["CreatedBy"].ToString());
                    company.PeopleCreatedBy = new People { IdPerson = Convert.ToInt32(companyreader["CreatedBy"].ToString()), Name = companyreader["CreatedByName"].ToString(), Surname = companyreader["CreatedBySurname"].ToString() };
                }

                company.BusinessProductList = new List<SitesByBusinessProduct>();
                List<string> bpstring = new List<string>();
                using (MySqlConnection concompanybusinessproduct = new MySqlConnection(connectionstring))
                {
                    concompanybusinessproduct.Open();
                    MySqlCommand concompanycommandbusinessproduct = new MySqlCommand("sitesbybusinessproduct_GetBusinessProduct", concompanybusinessproduct);
                    concompanycommandbusinessproduct.CommandType = CommandType.StoredProcedure;
                    concompanycommandbusinessproduct.Parameters.AddWithValue("_idCompany", company.IdCompany);

                    using (MySqlDataReader companybusinessproductreader = concompanycommandbusinessproduct.ExecuteReader())
                    {
                        while (companybusinessproductreader.Read())
                        {
                            if (companybusinessproductreader["IdBusinessProduct"] != DBNull.Value)
                            {
                                if (company.BusinessProductList.Any(bpl => bpl.IdBusinessProduct == Convert.ToInt32(companybusinessproductreader["IdBusinessProduct"].ToString())))
                                {

                                }
                                else
                                {
                                    SitesByBusinessProduct sitesByBusinessProduct = new SitesByBusinessProduct();
                                    if (companybusinessproductreader["IdSite"] != DBNull.Value)
                                        sitesByBusinessProduct.IdSite = Convert.ToInt32(companybusinessproductreader["IdSite"].ToString());

                                    if (companybusinessproductreader["IdBusinessProduct"] != DBNull.Value)
                                    {
                                        sitesByBusinessProduct.IdBusinessProduct = Convert.ToInt32(companybusinessproductreader["IdBusinessProduct"].ToString());
                                        sitesByBusinessProduct.BusinessProduct = Convert.ToString(companybusinessproductreader["Value"]);
                                        bpstring.Add(companybusinessproductreader["Value"].ToString());
                                    }

                                    sitesByBusinessProduct.IsAdded = true;
                                    company.BusinessProductList.Add(sitesByBusinessProduct);
                                }
                            }

                        }
                    }
                    if (bpstring.Count > 0)
                        company.BusinessProductString = string.Join("\n", bpstring.ToArray());
                    else
                        company.BusinessProductString = string.Empty;
                }
                companies.Add(company);
            }

            return companies;
        }

        /// <summary>
        /// This method is to get company details
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idSite">Get site id</param>
        /// <returns>Company details</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          company = mgr.GetCompanyDetailsById(string connectionstring, Int32 idSite);
        ///          SP :-  sites_GetCompanyDetailsById
        ///          QUERY :- "select * from sites_by_businessproduct where idSite = " + company.IdCompany + "";
        ///     }
        /// }
        /// </code>
        /// </example>  
        public Company GetCompanyDetailsById(string connectionstring, Int32 idSite)
        {

            Company company = new Company();
            DataTable dt = new DataTable();
            using (MySqlConnection concompany = new MySqlConnection(connectionstring))
            {
                concompany.Open();
                MySqlCommand concompanycommand = new MySqlCommand("sites_GetCompanyDetailsById", concompany);
                concompanycommand.CommandType = CommandType.StoredProcedure;
                concompanycommand.Parameters.AddWithValue("_IdSite", idSite);
                MySqlDataAdapter da = new MySqlDataAdapter(concompanycommand);
                //DataSet ds = new DataSet();
                da.Fill(dt);
            }
            foreach (DataRow companyreader in dt.Rows)
            {

                company.IdCompany = Convert.ToInt32(companyreader["IdSite"].ToString());
                company.Name = companyreader["CustomerPlant"].ToString();
                company.RegisteredName = companyreader["RegisteredName"].ToString();
                company.CIF = companyreader["RegistrationNumber"].ToString();
                company.IdCountry = Convert.ToByte(companyreader["idCountry"].ToString());
                company.Country = new Country { IdCountry = Convert.ToByte(companyreader["idCountry"].ToString()), Name = companyreader["Country"].ToString() };
                company.City = companyreader["City"].ToString();
                company.Address = companyreader["Address"].ToString();
                company.Telephone = companyreader["Phone"].ToString();
                company.ZipCode = companyreader["PostCode"].ToString();
                company.Fax = companyreader["Fax"].ToString();
                company.Website = companyreader["WebSite"].ToString();
                company.Email = companyreader["Email"].ToString();
                company.Region = companyreader["Region"].ToString();
                company.ShortName = companyreader["ShortName"].ToString();
                if (companyreader["IdSalesResponsible"] != DBNull.Value)
                {
                    company.IdSalesResponsible = Convert.ToInt32(companyreader["IdSalesResponsible"].ToString());
                    company.People = new People { IdPerson = Convert.ToInt32(companyreader["IdSalesResponsible"].ToString()), Name = companyreader["SalesResponsibleName"].ToString(), Surname = companyreader["SalesResponsibleSurname"].ToString(), IsSalesResponsible = true };
                }

                if (companyreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                {
                    company.IdSalesResponsibleAssemblyBU = Convert.ToInt32(companyreader["IdSalesResponsibleAssemblyBU"].ToString());
                    company.PeopleSalesResponsibleAssemblyBU = new People { IdPerson = Convert.ToInt32(companyreader["IdSalesResponsibleAssemblyBU"].ToString()), Name = companyreader["SalesResponsiblebuName"].ToString(), Surname = companyreader["SalesResponsiblebuSurname"].ToString(), IsSalesResponsible = false };
                }

                company.Country.Zone = new Zone { Name = companyreader["SalesZone"].ToString() };
                company.IdCustomer = Convert.ToInt32(companyreader["IdCustomer"].ToString());
                company.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(companyreader["IdCustomer"].ToString()), CustomerName = companyreader["CustomerGroup"].ToString() } };
                if (companyreader["Line"] != DBNull.Value)
                    company.Line = Convert.ToInt32(companyreader["Line"].ToString());
                if (companyreader["ModifiedIn"] != DBNull.Value)
                    company.ModifiedIn = Convert.ToDateTime(companyreader["ModifiedIn"].ToString());
                else
                    company.ModifiedIn = null;
                if (companyreader["CreatedIn"] != DBNull.Value)
                    company.CreatedIn = Convert.ToDateTime(companyreader["CreatedIn"].ToString());
                if (companyreader["CuttingMachines"] != DBNull.Value)
                    company.CuttingMachines = Convert.ToInt32(companyreader["CuttingMachines"].ToString());
                if (companyreader["Size"] != DBNull.Value)
                    company.Size = Convert.ToDouble(companyreader["Size"].ToString());
                if (companyreader["NumberOfEmployees"] != DBNull.Value)
                    company.NumberOfEmployees = Convert.ToInt32(companyreader["NumberOfEmployees"].ToString());
                if (companyreader["IdBusinessField"] != DBNull.Value)
                {
                    company.IdBusinessField = Convert.ToByte(companyreader["IdBusinessField"].ToString());
                    company.BusinessField = new LookupValue { IdLookupValue = Convert.ToByte(companyreader["IdBusinessField"].ToString()), Value = companyreader["BusinessField"].ToString() };
                }
                if (companyreader["IdBusinessCenter"] != DBNull.Value)
                {
                    company.IdBusinessCenter = Convert.ToByte(companyreader["IdBusinessCenter"].ToString());
                    company.BusinessCenter = new LookupValue { IdLookupValue = Convert.ToByte(companyreader["IdBusinessCenter"].ToString()), Value = companyreader["BusinessCenter"].ToString() };
                }

                if (companyreader["IdBusinessType"] != DBNull.Value)
                {
                    company.IdBusinessType = Convert.ToByte(companyreader["IdBusinessType"].ToString());
                    company.BusinessType = new LookupValue { IdLookupValue = Convert.ToByte(companyreader["IdBusinessType"].ToString()), Value = companyreader["BusinessType"].ToString() };
                }
                if (companyreader["Latitude"] != DBNull.Value)
                {
                    company.Latitude = Convert.ToDouble(companyreader["Latitude"].ToString());
                }
                if (companyreader["Longitude"] != DBNull.Value)
                {
                    company.Longitude = Convert.ToDouble(companyreader["Longitude"].ToString());
                }
                company.BusinessProductList = new List<SitesByBusinessProduct>();
                using (MySqlConnection concompanybusinessproduct = new MySqlConnection(connectionstring))
                {
                    concompanybusinessproduct.Open();
                    MySqlCommand concompanycommandbusinessproduct = new MySqlCommand("sitesbybusinessproduct_GetBusinessproductByIdSite", concompanybusinessproduct);
                    concompanycommandbusinessproduct.CommandType = CommandType.StoredProcedure;
                    concompanycommandbusinessproduct.Parameters.AddWithValue("_idSite", company.IdCompany);
                    using (MySqlDataReader companybusinessproductreader = concompanycommandbusinessproduct.ExecuteReader())
                    {
                        while (companybusinessproductreader.Read())
                        {
                            SitesByBusinessProduct sitesByBusinessProduct = new SitesByBusinessProduct();
                            sitesByBusinessProduct.IdSite = Convert.ToInt32(companybusinessproductreader["IdSite"].ToString());
                            sitesByBusinessProduct.IdBusinessProduct = Convert.ToInt32(companybusinessproductreader["IdBusinessProduct"].ToString());
                            sitesByBusinessProduct.IsAdded = true;
                            company.BusinessProductList.Add(sitesByBusinessProduct);
                        }
                    }
                }

            }

            return company;
        }

        /// <summary>
        /// This method is to get list of company
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idUser">Get user id</param>
        /// <returns>List of company</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          companies = mgr.GetSelectedUserCustomersBySalesOwnerId(string connectionstring, string idUser);
        ///          SP :-  sites_GetSelectedUserCustomersBySalesOwnerId
        ///     }
        /// }
        /// </code>
        /// </example> 
        public List<Company> GetSelectedUserCustomersBySalesOwnerId(string connectionstring, string idUser)
        {

            List<Company> companies = new List<Company>();
            DataTable dt = new DataTable();
            using (MySqlConnection concompany = new MySqlConnection(connectionstring))
            {
                concompany.Open();
                MySqlCommand concompanycommand = new MySqlCommand("sites_GetSelectedUserCustomersBySalesOwnerId", concompany);
                concompanycommand.CommandType = CommandType.StoredProcedure;
                concompanycommand.Parameters.AddWithValue("_idUser", idUser);
                MySqlDataAdapter da = new MySqlDataAdapter(concompanycommand);
                //DataSet ds = new DataSet();
                da.Fill(dt);
            }
            foreach (DataRow companyreader in dt.Rows)
            {
                Company company = new Company();
                company.IdCompany = Convert.ToInt32(companyreader["IdSite"].ToString());
                company.Name = companyreader["CustomerPlant"].ToString();
                company.RegisteredName = companyreader["RegisteredName"].ToString();
                company.CIF = companyreader["RegistrationNumber"].ToString();
                company.IdCountry = Convert.ToByte(companyreader["idCountry"].ToString());
                company.Country = new Country { IdCountry = Convert.ToByte(companyreader["idCountry"].ToString()), Name = companyreader["Country"].ToString() };
                company.City = companyreader["City"].ToString();
                company.Address = companyreader["Address"].ToString();
                company.Telephone = companyreader["Phone"].ToString();
                company.ZipCode = companyreader["PostCode"].ToString();
                company.Fax = companyreader["Fax"].ToString();
                company.Website = companyreader["WebSite"].ToString();
                company.Email = companyreader["Email"].ToString();
                company.Region = companyreader["Region"].ToString();
                company.ShortName = companyreader["ShortName"].ToString();
                if (companyreader["IdSalesResponsible"] != DBNull.Value)
                {
                    company.IdSalesResponsible = Convert.ToInt32(companyreader["IdSalesResponsible"].ToString());
                    company.People = new People { IdPerson = Convert.ToInt32(companyreader["IdSalesResponsible"].ToString()), Name = companyreader["SalesResponsibleName"].ToString(), Surname = companyreader["SalesResponsibleSurname"].ToString() };
                }

                if (companyreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                {
                    company.IdSalesResponsibleAssemblyBU = Convert.ToInt32(companyreader["IdSalesResponsibleAssemblyBU"].ToString());
                    company.PeopleSalesResponsibleAssemblyBU = new People { IdPerson = Convert.ToInt32(companyreader["IdSalesResponsibleAssemblyBU"].ToString()), Name = companyreader["SalesResponsiblebuName"].ToString(), Surname = companyreader["SalesResponsiblebuSurname"].ToString() };
                }

                company.Country.Zone = new Zone { Name = companyreader["SalesZone"].ToString() };
                company.IdCustomer = Convert.ToInt32(companyreader["IdCustomer"].ToString());
                company.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(companyreader["IdCustomer"].ToString()), CustomerName = companyreader["CustomerGroup"].ToString() } };
                if (companyreader["Line"] != DBNull.Value)
                    company.Line = Convert.ToInt32(companyreader["Line"].ToString());
                if (companyreader["CuttingMachines"] != DBNull.Value)
                    company.CuttingMachines = Convert.ToInt32(companyreader["CuttingMachines"].ToString());
                if (companyreader["Size"] != DBNull.Value)
                    company.Size = Convert.ToDouble(companyreader["Size"].ToString());
                if (companyreader["NumberOfEmployees"] != DBNull.Value)
                    company.NumberOfEmployees = Convert.ToInt32(companyreader["NumberOfEmployees"].ToString());
                if (companyreader["IdBusinessField"] != DBNull.Value)
                {
                    company.IdBusinessField = Convert.ToByte(companyreader["IdBusinessField"].ToString());
                    company.BusinessField = new LookupValue { IdLookupValue = Convert.ToByte(companyreader["IdBusinessField"].ToString()), Value = companyreader["BusinessField"].ToString() };
                }
                if (companyreader["IdBusinessCenter"] != DBNull.Value)
                {
                    company.IdBusinessCenter = Convert.ToByte(companyreader["IdBusinessCenter"].ToString());
                    company.BusinessCenter = new LookupValue { IdLookupValue = Convert.ToByte(companyreader["IdBusinessCenter"].ToString()), Value = companyreader["BusinessCenter"].ToString() };
                }
                if (companyreader["IdBusinessType"] != DBNull.Value)
                {
                    company.IdBusinessType = Convert.ToByte(companyreader["IdBusinessType"].ToString());
                    company.BusinessType = new LookupValue { IdLookupValue = Convert.ToByte(companyreader["IdBusinessType"].ToString()), Value = companyreader["BusinessType"].ToString() };
                }
                if (companyreader["Latitude"] != DBNull.Value)
                {
                    company.Latitude = Convert.ToDouble(companyreader["Latitude"].ToString());
                    company.BothLongitudeLatitude = company.Latitude.ToString();
                }
                if (companyreader["Longitude"] != DBNull.Value)
                {
                    company.Longitude = Convert.ToDouble(companyreader["Longitude"].ToString());
                    company.BothLongitudeLatitude = company.BothLongitudeLatitude + company.Longitude.ToString();
                }
                if (companyreader["ModifiedIn"] != DBNull.Value)
                    company.ModifiedIn = Convert.ToDateTime(companyreader["ModifiedIn"].ToString());
                if (companyreader["CreatedIn"] != DBNull.Value)
                    company.CreatedIn = Convert.ToDateTime(companyreader["CreatedIn"].ToString());


                company.GroupPlantName = companyreader["GroupPlantName"].ToString();

                if (companyreader["CreatedBy"] != DBNull.Value)
                {
                    company.CreatedBy = Convert.ToInt32(companyreader["CreatedBy"].ToString());
                    company.PeopleCreatedBy = new People { IdPerson = Convert.ToInt32(companyreader["CreatedBy"].ToString()), Name = companyreader["CreatedByName"].ToString(), Surname = companyreader["CreatedBySurname"].ToString() };
                }

                company.BusinessProductList = new List<SitesByBusinessProduct>();
                List<string> bpstring = new List<string>();
                using (MySqlConnection concompanybusinessproduct = new MySqlConnection(connectionstring))
                {
                    concompanybusinessproduct.Open();
                    MySqlCommand concompanycommandbusinessproduct = new MySqlCommand("sitesbybusinessproduct_GetBusinessProduct", concompanybusinessproduct);
                    concompanycommandbusinessproduct.CommandType = CommandType.StoredProcedure;
                    concompanycommandbusinessproduct.Parameters.AddWithValue("_idCompany", company.IdCompany);

                    using (MySqlDataReader companybusinessproductreader = concompanycommandbusinessproduct.ExecuteReader())
                    {
                        while (companybusinessproductreader.Read())
                        {
                            if (companybusinessproductreader["IdBusinessProduct"] != DBNull.Value)
                            {
                                if (company.BusinessProductList.Any(bpl => bpl.IdBusinessProduct == Convert.ToInt32(companybusinessproductreader["IdBusinessProduct"].ToString())))
                                {

                                }
                                else
                                {
                                    SitesByBusinessProduct sitesByBusinessProduct = new SitesByBusinessProduct();
                                    if (companybusinessproductreader["IdSite"] != DBNull.Value)
                                        sitesByBusinessProduct.IdSite = Convert.ToInt32(companybusinessproductreader["IdSite"].ToString());
                                    if (companybusinessproductreader["IdBusinessProduct"] != DBNull.Value)
                                    {
                                        sitesByBusinessProduct.IdBusinessProduct = Convert.ToInt32(companybusinessproductreader["IdBusinessProduct"].ToString());
                                        bpstring.Add(companybusinessproductreader["Value"].ToString());
                                    }

                                    sitesByBusinessProduct.IsAdded = true;
                                    company.BusinessProductList.Add(sitesByBusinessProduct);
                                }
                            }

                        }
                    }
                }
                //company.BusinessProductString = string.Join(" , ", bpstring.ToArray()); 
                if (bpstring.Count > 0)
                    company.BusinessProductString = string.Join("\n", bpstring.ToArray());
                else
                    company.BusinessProductString = string.Empty;
                companies.Add(company);
            }
            return companies;
        }

        /// <summary>
        /// This method is to get list of offers
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="companyDetails">Get company details</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of offers</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          offers = mgr.GetOfferQuantitySalesStatusByMonthCompanyWise(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear,Company companyDetails,Int32 idUserPermission);
        ///          SP :-  offers_GetOfferQuantitySalesStatusByMonth
        ///     }
        /// }
        /// </code>
        /// </example> 
        public List<Offer> GetOfferQuantitySalesStatusByMonthCompanyWise(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOfferQuantitySalesStatusByMonth", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdCustomer = Convert.ToInt32(offerreader["IdSite"].ToString());
                        offer.Site = new Company { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["CustomerPlant"].ToString(), IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } } };
                        offer.CurrentMonth = Convert.ToInt32(offerreader["CurrentMonth"].ToString());
                        offer.CurrentWeek = Convert.ToInt32(offerreader["CurrentWeek"].ToString());
                        offer.IdStatus = Convert.ToInt64(offerreader["OfferStatusId"].ToString());
                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["OfferStatusId"].ToString()), Name = offerreader["OfferStatusName"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["Status"].ToString() } };
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        Int32? quat = null;
                        if (offerreader["OfferQuantity"] != DBNull.Value)
                            quat = Convert.ToInt32(offerreader["OfferQuantity"].ToString());
                        offer.OptionsByOffers = new List<OptionsByOffer> { new OptionsByOffer { IdOption = Convert.ToInt64(offerreader["IdOption"].ToString()), Quantity = quat, OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(offerreader["IdOption"].ToString()), Name = offerreader["OfferOption"].ToString() } } };

                        offers.Add(offer);
                    }
                }
            }

            return offers;
        }

        public List<Offer> GetOfferQuantitySalesStatusByMonthCompanyWise(byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, Int32 idUserPermission)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetOfferQuantitySalesStatusByMonthDateWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdCustomer = Convert.ToInt32(offerreader["IdSite"].ToString());
                        offer.Site = new Company { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["CustomerPlant"].ToString(), IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } } };

                        offer.CurrentMonth = Convert.ToInt32(offerreader["CurrentMonth"].ToString());
                        offer.CurrentWeek = Convert.ToInt32(offerreader["CurrentWeek"].ToString());
                        offer.CurrentYear = Convert.ToInt32(offerreader["CurrentYear"].ToString());

                        offer.IdStatus = Convert.ToInt64(offerreader["OfferStatusId"].ToString());
                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["OfferStatusId"].ToString()), Name = offerreader["OfferStatusName"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["Status"].ToString() } };
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        Int32? quat = null;
                        if (offerreader["OfferQuantity"] != DBNull.Value)
                            quat = Convert.ToInt32(offerreader["OfferQuantity"].ToString());
                        offer.OptionsByOffers = new List<OptionsByOffer> { new OptionsByOffer { IdOption = Convert.ToInt64(offerreader["IdOption"].ToString()), Quantity = quat, OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(offerreader["IdOption"].ToString()), Name = offerreader["OfferOption"].ToString() } } };

                        //offer.CurrentWeek = Convert.ToInt32(offer.CurrentYear.ToString() + offer.CurrentWeek.ToString().PadLeft(2, '0'));

                        offers.Add(offer);
                    }
                }
            }

            return offers;
        }

        /// <summary>
        /// This method is to get list of offers
        /// </summary>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="companyDetails">Get company details</param>
        /// <returns>List of offers </returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          offers = mgr.GetSelectedUsersOfferQuantitySalesStatusByMonthCompanyWise( byte idCurrency, Int64 accountingYear, string idUser,Company companyDetails);
        ///          SP :-  offers_GetSelectedUsersOfferQuantitySalesStatusByMonth
        ///     }
        /// }
        /// </code>
        /// </example> 
        public List<Offer> GetSelectedUsersOfferQuantitySalesStatusByMonthCompanyWise(byte idCurrency, Int64 accountingYear, string idUser, Company companyDetails)
        {

            List<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUsersOfferQuantitySalesStatusByMonth", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdCustomer = Convert.ToInt32(offerreader["IdSite"].ToString());
                        offer.Site = new Company { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["CustomerPlant"].ToString(), IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } } };
                        offer.CurrentMonth = Convert.ToInt32(offerreader["CurrentMonth"].ToString());
                        offer.CurrentWeek = Convert.ToInt32(offerreader["CurrentWeek"].ToString());
                        offer.IdStatus = Convert.ToInt64(offerreader["OfferStatusId"].ToString());
                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["OfferStatusId"].ToString()), Name = offerreader["OfferStatusName"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["Status"].ToString() } };
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        Int32? quat = null;
                        if (offerreader["OfferQuantity"] != DBNull.Value)
                            quat = Convert.ToInt32(offerreader["OfferQuantity"].ToString());
                        offer.OptionsByOffers = new List<OptionsByOffer> { new OptionsByOffer { IdOption = Convert.ToInt64(offerreader["IdOption"].ToString()), Quantity = quat, OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(offerreader["IdOption"].ToString()), Name = offerreader["OfferOption"].ToString() } } };

                        offers.Add(offer);
                    }
                }
            }

            return offers;
        }

        public List<Offer> GetSelectedUsersOfferQuantitySalesStatusByMonthCompanyWise(byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, string idUser, Company companyDetails, Int32 idCurrentUser = 0)
        {

            List<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetSelectedUsersOfferQtySalesStatusByMonthDatewise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_currentUser", idCurrentUser);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdCustomer = Convert.ToInt32(offerreader["IdSite"].ToString());
                        offer.Site = new Company { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["CustomerPlant"].ToString(), IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } } };

                        offer.CurrentMonth = Convert.ToInt32(offerreader["CurrentMonth"].ToString());
                        offer.CurrentWeek = Convert.ToInt32(offerreader["CurrentWeek"].ToString());
                        offer.CurrentYear = Convert.ToInt32(offerreader["CurrentYear"].ToString());

                        offer.IdStatus = Convert.ToInt64(offerreader["OfferStatusId"].ToString());
                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["OfferStatusId"].ToString()), Name = offerreader["OfferStatusName"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["Status"].ToString() } };
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        Int32? quat = null;
                        if (offerreader["OfferQuantity"] != DBNull.Value)
                            quat = Convert.ToInt32(offerreader["OfferQuantity"].ToString());
                        offer.OptionsByOffers = new List<OptionsByOffer> { new OptionsByOffer { IdOption = Convert.ToInt64(offerreader["IdOption"].ToString()), Quantity = quat, OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(offerreader["IdOption"].ToString()), Name = offerreader["OfferOption"].ToString() } } };

                        //offer.CurrentWeek = Convert.ToInt32(offer.CurrentYear.ToString() + offer.CurrentWeek.ToString().PadLeft(2, '0'));

                        offers.Add(offer);
                    }
                }
            }

            return offers;
        }

        /// <summary>
        /// This method is to get countries
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>List of country</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          countries = mgr.GetCountries(string connectionstring);
        ///          QUERY :-  "select co.name As CountryName,co.idCountry,zo.IdZone,zo.Name As ZoneName from countries co inner join zones zo on co.IdZone = zo.IdZone order by co.name asc"
        ///     }
        /// }
        /// </code>
        /// </example> 
        public List<Country> GetCountries(string connectionstring)
        {
            List<Country> countries = new List<Country>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionstring))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("countries_GetCountriesDetails", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Country country = new Country();
                        country.IdCountry = Convert.ToByte(offerreader["idCountry"].ToString());
                        country.Name = offerreader["CountryName"].ToString();
                        country.Zone = new Zone();
                        country.Zone.IdZone = Convert.ToInt32(offerreader["IdZone"].ToString());
                        country.Zone.Name = offerreader["ZoneName"].ToString();
                        countries.Add(country);
                    }
                }
            }

            return countries;
        }



        /// <summary>
        /// This method is to get list of peoples
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>List of people</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          peoples = mgr.GetPeoples(string connectionstring);
        ///          QUERY :-  "select IdPerson, Name, Surname from people"
        ///     }
        /// }
        /// </code>
        /// </example> 
        public List<People> GetPeoples(string connectionstring)
        {
            List<People> peoples = new List<People>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionstring))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("people_GetAllPeoples", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        People people = new People();
                        people.IdPerson = Convert.ToInt32(offerreader["IdPerson"].ToString());
                        people.Name = offerreader["Name"].ToString();
                        people.Surname = offerreader["Surname"].ToString();
                        people.Email = offerreader["Email"].ToString();

                        peoples.Add(people);
                    }
                }
            }

            return peoples;
        }

        /// <summary>
        /// This method is to get list of geos status
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <returns>List of geos status</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          geosStatus = mgr.GetGeosOfferStatus(string connectionstring);
        ///          SP :-  offers_GeosOfferStatus
        ///     }
        /// }
        /// </code>
        /// </example> 
        public IList<GeosStatus> GetGeosOfferStatus(string connectionstring)
        {
            IList<GeosStatus> geosStatus = new List<GeosStatus>();
            List<int> idstatus = new List<int>() { 3, 5, 9, 7, 4, 10, 11, 12, 13, 14 };
            using (MySqlConnection con = new MySqlConnection(connectionstring))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("offers_GeosOfferStatus", con);
                concommand.CommandType = CommandType.StoredProcedure;
                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        GeosStatus gstatus = new GeosStatus();
                        gstatus.IdOfferStatusType = Convert.ToInt32(reader["IdOfferStatusType"].ToString());
                        gstatus.Name = reader["Name"].ToString();
                        gstatus.Position = Convert.ToInt64(reader["Position"].ToString());
                        gstatus.HtmlColor = reader["HtmlColor"].ToString();
                        if (reader["IdSalesStatusType"] != DBNull.Value)
                        {
                            gstatus.IdSalesStatusType = Convert.ToInt64(reader["IdSalesStatusType"].ToString());
                            gstatus.SalesStatusType = new SalesStatusType();
                            gstatus.SalesStatusType.IdSalesStatusType = Convert.ToInt64(reader["IdSalesStatusType"].ToString());
                            gstatus.SalesStatusType.Name = reader["SalesStatusType"].ToString();
                            gstatus.SalesStatusType.IdImage = Convert.ToInt64(reader["IdImage"].ToString());
                            gstatus.SalesStatusType.HtmlColor = reader["SalesStatusTypeHtmlColor"].ToString();
                        }
                        gstatus.IsEnabled = true;
                        if (idstatus.Contains(Convert.ToInt32(reader["IdOfferStatusType"].ToString())))
                            gstatus.IsEnabled = false;
                        geosStatus.Add(gstatus);
                    }
                }
            }
            return geosStatus;
        }


        public List<Company> GetAllCompanies(string connectionstring, Int32 idUser)
        {
            List<Company> companies = new List<Company>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionstring))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("sites_GetAllCompaniesUserWise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString());
                        company.Name = offerreader["SiteName"].ToString();
                        company.ShortName = offerreader["ShortName"].ToString();
                        company.Country = new Country();
                        if (offerreader["IdCountry"] != DBNull.Value)
                        {
                            company.Country.IdCountry = Convert.ToByte(offerreader["IdCountry"].ToString());
                            company.Country.Name = offerreader["Country"].ToString();
                        }
                        company.Country.Zone = new Zone();
                        if (offerreader["IdZone"] != DBNull.Value)
                        {
                            company.Country.Zone.IdZone = Convert.ToInt32(offerreader["IdZone"].ToString());
                            company.Country.Zone.Name = offerreader["Zone"].ToString();
                        }
                        companies.Add(company);
                    }
                }
            }

            return companies;
        }


        public List<EmdepSite> GetAllEmdepSites(string connectionstring, Int32 idUser)
        {
            List<EmdepSite> companies = new List<EmdepSite>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionstring))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("emdepsites_GetUserPermissionSites", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        EmdepSite company = new EmdepSite();
                        company.IdSite = Convert.ToInt32(offerreader["IdSite"].ToString());
                        company.ShortName = offerreader["ShortName"].ToString();
                        company.DatabaseIP = offerreader["DatabaseIP"].ToString();
                        if (Convert.ToInt32(offerreader["IsSitePermission"].ToString()) == 0)
                            company.IsSitePermission = false;
                        else
                            company.IsSitePermission = true;
                        companies.Add(company);
                    }
                }
            }

            return companies;
        }


        public SalesUser GetUserAllSalesQuota(string connectionstring, Int32 idUser, byte idCurrency)
        {
            SalesUser salesUser = new SalesUser();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionstring))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("SalesUserQuotas_GetUserAllSalesQuota", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_userId", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                salesUser.SalesUserQuotas = new List<SalesUserQuota>();
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        if (offerreader["IdSalesUser"] != DBNull.Value)
                            salesUser.IdSalesUser = Convert.ToInt32(offerreader["IdSalesUser"].ToString());
                        if (offerreader["IdSalesTeam"] != DBNull.Value)
                            salesUser.IdSalesTeam = Convert.ToInt32(offerreader["IdSalesTeam"].ToString());
                        if (salesUser.SalesUserQuotas.Any(i => i.IdSalesUser == Convert.ToInt32(offerreader["IdSalesUser"].ToString()) && i.Year == Convert.ToInt32(offerreader["Year"].ToString())))
                        {
                            //SalesUserQuota salesUserQuota = new SalesUserQuota();
                            //salesUserQuota.IdSalesUser = Convert.ToInt32(offerreader["IdSalesUser"].ToString());
                            //salesUserQuota.SalesQuotaAmount = Convert.ToDouble(offerreader["SalesQuotaAmount"].ToString());
                            //salesUserQuota.IdSalesQuotaCurrency = Convert.ToByte(offerreader["IdSalesQuotaCurrency"].ToString());
                            //salesUserQuota.Year = Convert.ToInt32(offerreader["Year"].ToString());

                            //salesUser.SalesUserQuotas.Add(salesUserQuota);
                        }
                        else
                        {
                            SalesUserQuota salesUserQuota = new SalesUserQuota();
                            salesUserQuota.IdSalesUser = Convert.ToInt32(offerreader["IdSalesUser"].ToString());
                            if (offerreader["SalesQuotaAmount"] != DBNull.Value)
                                salesUserQuota.SalesQuotaAmount = Convert.ToDouble(offerreader["SalesQuotaAmount"].ToString());
                            if (offerreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                salesUserQuota.IdSalesQuotaCurrency = Convert.ToByte(offerreader["IdSalesQuotaCurrency"].ToString());
                            if (offerreader["Year"] != DBNull.Value)
                                salesUserQuota.Year = Convert.ToInt32(offerreader["Year"].ToString());

                            salesUser.SalesUserQuotas.Add(salesUserQuota);
                        }

                    }
                }
            }

            return salesUser;
        }


        public bool AddSaleUserQuota(List<SalesUserQuota> salesUserQuotas, string connectionstring)
        {
            bool isAddedSalesUserQuota = false;
            int isadded = 0;
            foreach (SalesUserQuota salesUserQuota in salesUserQuotas)
            {
                using (MySqlConnection concompany = new MySqlConnection(connectionstring))
                {
                    concompany.Open();
                    using (MySqlTransaction trans = concompany.BeginTransaction())
                    {
                        try
                        {
                            MySqlCommand concompanycommand = new MySqlCommand("sales_user_quotas_Insert", concompany);
                            concompanycommand.CommandType = CommandType.StoredProcedure;
                            concompanycommand.Parameters.AddWithValue("_IdSalesUser", salesUserQuota.IdSalesUser);
                            concompanycommand.Parameters.AddWithValue("_Year", salesUserQuota.Year);
                            concompanycommand.Parameters.AddWithValue("_SalesQuotaAmount", salesUserQuota.SalesQuotaAmount);
                            concompanycommand.Parameters.AddWithValue("_IdSalesQuotaCurrency", salesUserQuota.IdSalesQuotaCurrency);

                            concompanycommand.Transaction = trans;
                            concompanycommand.ExecuteNonQuery();
                            isAddedSalesUserQuota = true;
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
            }
            return isAddedSalesUserQuota;
        }



        public List<SalesUserQuota> GetAllSalesUserDetailsPlantWise(string connectionString, byte idCurrency, Int32 accountingYear, string assignedPlants)
        {

            List<SalesUserQuota> salesUsers = new List<SalesUserQuota>();

            using (MySqlConnection conSalesUser = new MySqlConnection(connectionString))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("salesusers_GetAllSalesUserDetailsPlantWise", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conSalesUsercommand.Parameters.AddWithValue("_assignedPlants", assignedPlants);

                using (MySqlDataReader salesUserreader = conSalesUsercommand.ExecuteReader())
                {
                    while (salesUserreader.Read())
                    {
                        SalesUserQuota salesUser = new SalesUserQuota();
                        if (salesUserreader["IdSalesUser"] != DBNull.Value)
                            salesUser.IdSalesUser = Convert.ToInt32(salesUserreader["IdSalesUser"].ToString());
                        if (salesUserreader["IdSalesQuotaCurrency"] != DBNull.Value)
                            salesUser.IdSalesQuotaCurrency = Convert.ToByte(salesUserreader["IdSalesQuotaCurrency"].ToString());
                        if (salesUserreader["SalesQuotaAmount"] != DBNull.Value)
                            salesUser.SalesQuotaAmount = Convert.ToDouble(salesUserreader["SalesQuotaAmount"].ToString());
                        if (salesUserreader["Year"] != DBNull.Value)
                            salesUser.Year = Convert.ToInt32(salesUserreader["Year"].ToString());
                        if (salesUserreader["IdPerson"] != DBNull.Value)
                        {
                            salesUser.People = new People();

                            salesUser.People.IdPerson = Convert.ToInt32(salesUserreader["IdPerson"].ToString());
                            salesUser.People.Name = salesUserreader["Name"].ToString();
                            salesUser.People.Surname = salesUserreader["Surname"].ToString();
                        }
                        salesUsers.Add(salesUser);
                    }
                }
            }

            return salesUsers;
        }


        public List<SalesUserQuota> GetAllSalesUserDetailsPlantWise(string connectionString, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, string assignedPlants)
        {

            List<SalesUserQuota> salesUsers = new List<SalesUserQuota>();

            using (MySqlConnection conSalesUser = new MySqlConnection(connectionString))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("salesusers_GetAllSalesUserDetailsPlantWiseDatewise", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conSalesUsercommand.Parameters.AddWithValue("_assignedPlants", assignedPlants);

                using (MySqlDataReader salesUserreader = conSalesUsercommand.ExecuteReader())
                {
                    while (salesUserreader.Read())
                    {
                        SalesUserQuota salesUser = new SalesUserQuota();
                        if (salesUserreader["IdSalesUser"] != DBNull.Value)
                            salesUser.IdSalesUser = Convert.ToInt32(salesUserreader["IdSalesUser"].ToString());
                        if (salesUserreader["IdSalesQuotaCurrency"] != DBNull.Value)
                            salesUser.IdSalesQuotaCurrency = Convert.ToByte(salesUserreader["IdSalesQuotaCurrency"].ToString());
                        if (salesUserreader["SalesQuotaAmount"] != DBNull.Value)
                            salesUser.SalesQuotaAmount = Convert.ToDouble(salesUserreader["SalesQuotaAmount"].ToString());
                        if (salesUserreader["Year"] != DBNull.Value)
                            salesUser.Year = Convert.ToInt32(salesUserreader["Year"].ToString());
                        if (salesUserreader["IdPerson"] != DBNull.Value)
                        {
                            salesUser.People = new People();

                            salesUser.People.IdPerson = Convert.ToInt32(salesUserreader["IdPerson"].ToString());
                            salesUser.People.Name = salesUserreader["Name"].ToString();
                            salesUser.People.Surname = salesUserreader["Surname"].ToString();
                        }
                        salesUsers.Add(salesUser);
                    }
                }
            }

            return salesUsers;
        }

        public SalesUserQuota GetTotalSalesQuotaBySelectedUserIdAndYearPlantWise(string connectionstring, string userIds, byte idCurrency, Int32 accountingYear, string assignedPlants)
        {
            SalesUserQuota salesUser = new SalesUserQuota();
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("SalesUserQuotas_GetSalesQuotaAmountByUserIdAndYearPlantWise", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_userId", userIds);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_assignedPlant", assignedPlants);

                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    if (lostReasonsByOfferreader.Read())
                    {
                        if (lostReasonsByOfferreader["Year"] != DBNull.Value)
                            salesUser.Year = Convert.ToInt32(lostReasonsByOfferreader["Year"].ToString());
                        if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                            salesUser.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                        if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                            salesUser.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                    }
                }
            }

            return salesUser;
        }


        public bool UpdateSaleUser(SalesUser salesUser, string connectionstring)
        {
            bool isUpdatedSalesUsers = false;

            using (MySqlConnection concompany = new MySqlConnection(connectionstring))
            {
                concompany.Open();
                using (MySqlTransaction trans = concompany.BeginTransaction())
                {
                    try
                    {
                        MySqlCommand concompanycommand = new MySqlCommand("salesusers_Update", concompany);
                        concompanycommand.CommandType = CommandType.StoredProcedure;
                        concompanycommand.Parameters.AddWithValue("_IdSalesUser", salesUser.IdSalesUser);
                        concompanycommand.Parameters.AddWithValue("_IdSalesTeam", salesUser.IdSalesTeam);
                        concompanycommand.Parameters.AddWithValue("_IdSalesPlant", salesUser.IdSalesPlant);
                        concompanycommand.Parameters.AddWithValue("_SalesQuotaAmount", salesUser.SalesQuotaAmount);
                        concompanycommand.Parameters.AddWithValue("_IdSalesQuotaCurrency", salesUser.IdSalesQuotaCurrency);
                        concompanycommand.Transaction = trans;
                        concompanycommand.ExecuteNonQuery();
                        isUpdatedSalesUsers = true;
                        trans.Commit();
                    }
                    catch (Exception ex)
                    {
                        trans.Rollback();
                        isUpdatedSalesUsers = false;
                        throw;
                    }
                }
                return isUpdatedSalesUsers;
            }
        }



        public bool UpdateOrderForParticularColumn(Offer offer, string connectionString)
        {
            bool isupdated = false;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            try
            {
                using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                {
                    conoffer.Open();
                    using (MySqlTransaction trans = conoffer.BeginTransaction())
                    {
                        try
                        {
                            MySqlCommand conoffercommand = new MySqlCommand("offers_UpdateOrderParticularColumnGrid", conoffer);

                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                            conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                            conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                            conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                            conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                            conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                            conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                            conoffercommand.Transaction = trans;
                            conoffercommand.ExecuteNonQuery();
                            isupdated = true;
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
                if (isupdated)
                {

                    AddLogEntryByOffer(offer, connectionString, offer.Site.ConnectPlantConstr);

                }

            }
            catch (Exception ex)
            {
                throw;
                //isupdated = false;
            }

            return isupdated;
        }


        /// <summary>
        /// This method is to add offer
        /// </summary>
        /// <param name="offer">Get offer details</param>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="offerCodeConnectionString">Get offer code connection string</param>
        /// <param name="idSite">Get site id</param>
        /// <param name="commericalPath">Get commerical path</param>
        /// <param name="workingOrdersPath">Get working order path</param>
        /// <param name="mainserverConnectionString">Get main server connection string</param>
        /// <returns>Get added offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// {
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string offerCodeConnectionString = ConfigurationManager.ConnectionStrings["OfferCodeContext"].ConnectionString;
        ///          string mainServerConnectionString = ConfigurationManager.ConnectionStrings["MainServerContext"].ConnectionString;
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          Offer offer = mgr.AddOffer(offer, connectionString, offerCodeConnectionString, idSite, Properties.Settings.Default.CommericalPath, Properties.Settings.Default.WorkingOrdersPath,mainServerConnectionString);
        ///          Method :-  if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
        ///                      offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
        ///                     else
        ///                      UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
        ///          SP :- offers_Insert
        ///          Methods :-   AddQuotations(offer, offer.Site.ConnectPlantConstr);
        ///                       AddLogEntryByOffer(offer, offer.Site.ConnectPlantConstr, null);
        ///                       AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);
        ///                   
        ///     }
        /// }
        /// </code>
        /// </example>
        public Offer AddOfferWithIdSourceOffer(Offer offer, string connectionString, string offerCodeConnectionString, Int32 idSite, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {
            Int64 offerId = 0;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
            {
                if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                    UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                else
                    offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
            }
            else
                UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);

            if (offerInsertedInGCM)
            {
                using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                {
                    conoffer.Open();
                    using (MySqlTransaction trans = conoffer.BeginTransaction())
                    {
                        try
                        {
                            //MySqlCommand conoffercommand = new MySqlCommand("offers_InsertWithIdSourceOffer", conoffer);
                            MySqlCommand conoffercommand = new MySqlCommand("offers_InsertWithIdSourceOffer_Sprint59", conoffer);
                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                            conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                            conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                            conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                            conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                            conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                            conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                            conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                            conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                            conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                            conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                            conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                            conoffercommand.Parameters.AddWithValue("_CreatedBy", offer.CreatedBy);
                            conoffercommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                            conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                            conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                            conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                            conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                            conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                            conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                            conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                            conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                            conoffercommand.Parameters.AddWithValue("_IdSourceOffer", offer.IdSourceOffer);
                            conoffercommand.Parameters.AddWithValue("_Rfq", offer.Rfq);
                            conoffercommand.Transaction = trans;
                            offerId = Convert.ToInt64(conoffercommand.ExecuteScalar());
                            offer.IdOffer = offerId;
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }

                    }
                }
            }
            if (offerInsertedInGCM && offer.IdOffer > 0)
            {

                AddQuotations(offer, offer.Site.ConnectPlantConstr, dotProjectConnectionString, mailServer, workbenchConnectionString);
                AddLogEntryByOffer(offer, offer.Site.ConnectPlantConstr, null);
                AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);

            }
            return offer;
        }


        public List<CustomerPurchaseOrder> GetOfferPurchaseOrders(Company company, byte idCurrency, Int64 idOffer, Int64 accountingYear)
        {
            List<CustomerPurchaseOrder> customerPurchaseOrders = new List<CustomerPurchaseOrder>();
            using (MySqlConnection conoffer = new MySqlConnection(company.ConnectPlantConstr))
            {
                conoffer.Open();
                MySqlCommand conoffercommand = new MySqlCommand("offers_GetOfferPurchaseOrders", conoffer);
                conoffercommand.CommandType = CommandType.StoredProcedure;
                conoffercommand.Parameters.AddWithValue("_idCurrency", idCurrency);
                conoffercommand.Parameters.AddWithValue("_idoffer", idOffer);
                conoffercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                        if (offerreader["idCustomerPurchaseOrders"] != DBNull.Value)
                        {
                            customerPurchaseOrder.IdCustomerPurchaseOrders = Convert.ToInt64(offerreader["IdCustomerPurchaseOrders"].ToString());
                            customerPurchaseOrder.Code = offerreader["Code"].ToString();
                            if (offerreader["ReceivedIn"] != DBNull.Value)
                                customerPurchaseOrder.ReceivedIn = Convert.ToDateTime(offerreader["ReceivedIn"].ToString());
                            customerPurchaseOrder.ReceivedBy = offerreader["ReceivedBy"].ToString();
                            if (offerreader["Amount"] != DBNull.Value)
                                customerPurchaseOrder.Value = Convert.ToDouble(offerreader["Amount"].ToString());
                            customerPurchaseOrder.IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString());
                            if (offerreader["CreatedIn"] != DBNull.Value)
                                customerPurchaseOrder.CreatedIn = Convert.ToDateTime(offerreader["CreatedIn"].ToString());
                            if (offerreader["ModifiedIn"] != DBNull.Value)
                                customerPurchaseOrder.ModifiedIn = Convert.ToDateTime(offerreader["ModifiedIn"].ToString());
                            if (offerreader["CreatedBy"] != DBNull.Value)
                            {
                                customerPurchaseOrder.CreatedBy = Convert.ToInt32(offerreader["CreatedBy"].ToString());
                                customerPurchaseOrder.PeopleCreatedBy = new People();
                                customerPurchaseOrder.PeopleCreatedBy.IdPerson = Convert.ToInt32(offerreader["CreatedBy"].ToString());
                                customerPurchaseOrder.PeopleCreatedBy.Name = offerreader["CreatedByName"].ToString();
                                customerPurchaseOrder.PeopleCreatedBy.Surname = offerreader["CreatedBySurname"].ToString();
                            }

                            if (offerreader["ModifiedBy"] != DBNull.Value)
                            {
                                customerPurchaseOrder.IdModifiedBy = Convert.ToInt32(offerreader["ModifiedBy"].ToString());
                                customerPurchaseOrder.PeopleModifiedBy = new People();
                                customerPurchaseOrder.PeopleModifiedBy.IdPerson = Convert.ToInt32(offerreader["ModifiedBy"].ToString());
                                customerPurchaseOrder.PeopleModifiedBy.Name = offerreader["ModifiedByName"].ToString();
                                customerPurchaseOrder.PeopleModifiedBy.Surname = offerreader["ModifiedBySurname"].ToString();
                            }
                            if (offerreader["IsGoAhead"] != DBNull.Value)
                                customerPurchaseOrder.IsGoAhead = Convert.ToByte(offerreader["IsGoAhead"].ToString());
                            if (offerreader["IdSite"] != DBNull.Value)
                            {
                                customerPurchaseOrder.IdSite = Convert.ToInt32(offerreader["IdSite"].ToString());
                                customerPurchaseOrder.Company = new Company();
                                customerPurchaseOrder.Company.IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString());
                                customerPurchaseOrder.Company.Name = offerreader["SiteName"].ToString();
                                customerPurchaseOrder.Company.SiteNameWithoutCountry = offerreader["SiteNameWithoutCountry"].ToString();
                                customerPurchaseOrder.Company.ShortName = offerreader["SiteShortName"].ToString();
                            }
                            if (offerreader["IdShippingAddress"] != DBNull.Value)
                                customerPurchaseOrder.IdShippingAddress = Convert.ToInt64(offerreader["IdShippingAddress"].ToString());
                            if (offerreader["IsPartial"] != DBNull.Value)
                                customerPurchaseOrder.IsPartial = Convert.ToByte(offerreader["IsPartial"].ToString());

                            if (offerreader["IdPOType"] != DBNull.Value)
                            {
                                customerPurchaseOrder.IdPOType = Convert.ToInt32(offerreader["IdPOType"].ToString());
                                customerPurchaseOrder.CustomerPurchaseOrderType = new CustomerPurchaseOrderType();
                                customerPurchaseOrder.CustomerPurchaseOrderType.IdPOType = Convert.ToInt32(offerreader["IdPOType"].ToString());
                                customerPurchaseOrder.CustomerPurchaseOrderType.POType = Convert.ToString(offerreader["POType"].ToString());
                            }

                            customerPurchaseOrders.Add(customerPurchaseOrder);
                        }


                    }
                }
            }

            return customerPurchaseOrders;
        }



        public List<SalesUser> GetAllSalesUserPeopleDetailsWithPlantAndPermission(byte idCurrency, string connectionString, string connectionWorkbenchString, Int32 accountingYear)
        {
            List<SalesUser> salesUsers = new List<SalesUser>();
            DataTable dtsalesUser = new DataTable();
            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("salesusers_GetAllSalesUserPeopleDetailsWithPlant", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);

                da.Fill(dtsalesUser);
            }
            foreach (DataRow itemRow in dtsalesUser.Rows)
            {
                SalesUser salesUser = new SalesUser();
                if (itemRow["IdSalesTeam"] != DBNull.Value)
                    salesUser.IdSalesTeam = Convert.ToInt32(itemRow["IdSalesTeam"].ToString());

                if (itemRow["IdSalesUser"] != DBNull.Value)
                    salesUser.IdSalesUser = Convert.ToInt32(itemRow["IdSalesUser"].ToString());

                if (itemRow["IdSalesQuotaCurrency"] != DBNull.Value)
                    salesUser.IdSalesQuotaCurrency = Convert.ToByte(itemRow["IdSalesQuotaCurrency"].ToString());

                if (itemRow["SalesQuotaAmount"] != DBNull.Value)
                    salesUser.SalesQuotaAmount = Convert.ToDouble(itemRow["SalesQuotaAmount"].ToString());

                if (itemRow["IdSalesPlant"] != DBNull.Value)
                {
                    salesUser.IdSalesPlant = Convert.ToInt32(itemRow["IdSalesPlant"].ToString());
                    salesUser.Company = new Company();
                    salesUser.Company.IdCompany = Convert.ToInt32(itemRow["IdSalesPlant"].ToString());
                    salesUser.Company.ShortName = itemRow["Plant"].ToString();
                }

                salesUser.LookupValue = new LookupValue();
                salesUser.LookupValue.IdLookupValue = Convert.ToInt32(itemRow["IdSalesTeam"].ToString());
                salesUser.LookupValue.Value = itemRow["TeamUser"].ToString();
                if (itemRow["IdPerson"] != DBNull.Value)
                {
                    salesUser.People = new People();
                    salesUser.People.IdPerson = Convert.ToInt32(itemRow["IdPerson"].ToString());
                    salesUser.People.Name = itemRow["Name"].ToString();
                    salesUser.People.Surname = itemRow["Surname"].ToString();
                    salesUser.People.Email = itemRow["Email"].ToString();
                    salesUser.People.IsStillActive = Convert.ToByte(itemRow["IsStillActive"]);
                    salesUser.People.Phone = itemRow["Phone"].ToString();
                    if (itemRow["IdPersonGender"] != DBNull.Value)
                    {
                        salesUser.People.IdPersonGender = Convert.ToByte(itemRow["IdPersonGender"].ToString());
                        if (salesUser.People.IdPersonGender == 1)
                            salesUser.People.UserGender = "Female";
                        else if (salesUser.People.IdPersonGender == 2)
                            salesUser.People.UserGender = "Male";
                    }
                    salesUser.People.Company = new Company();
                    salesUser.People.Company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                    salesUser.People.Company.ShortName = itemRow["Office"].ToString();
                    salesUser.People.Company.Country = new Country();
                    salesUser.People.Company.Country.IdCountry = Convert.ToByte(itemRow["IdCountry"].ToString());
                    salesUser.People.Company.Country.Name = itemRow["Country"].ToString();
                    salesUser.People.Company.Country.Zone = new Zone();
                    salesUser.People.Company.Country.Zone.IdZone = Convert.ToInt32(itemRow["IdZone"].ToString());
                    salesUser.People.Company.Country.Zone.Name = itemRow["Region"].ToString();
                }
                salesUser.UserPermission = new List<UserPermission>();
                if (itemRow["IdSalesUser"] != DBNull.Value)
                {
                    using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionWorkbenchString))
                    {
                        conofferwithoutpurchaseorder.Open();
                        //MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("select up.IdUser, up.IdPermission,p.PermissionName from user_permissions up inner join permissions p on up.IdPermission=p.IdPermission where IdUser = " + salesUser.IdSalesUser + "  group by up.IdUser, up.IdPermission;", conofferwithoutpurchaseorder);
                        //conofferwithoutpurchaseordercommand.CommandType = CommandType.Text;

                        MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("users_GetUserPermission", conofferwithoutpurchaseorder);
                        conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                        conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_IdUser", salesUser.IdSalesUser);
                        using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                        {
                            while (offerreader.Read())
                            {
                                UserPermission userPermission = new UserPermission();
                                if (offerreader["IdUser"] != DBNull.Value)
                                    userPermission.IdUser = Convert.ToInt32(offerreader["IdUser"].ToString());
                                if (offerreader["IdPermission"] != DBNull.Value)
                                {
                                    userPermission.IdPermission = Convert.ToInt32(offerreader["IdPermission"].ToString());
                                    userPermission.Permission = new Permission();
                                    userPermission.Permission.IdPermission = Convert.ToInt32(offerreader["IdPermission"].ToString());
                                    userPermission.Permission.PermissionName = offerreader["PermissionName"].ToString();
                                }
                                salesUser.UserPermission.Add(userPermission);
                            }
                        }
                    }
                }
                salesUser.SiteUserPermission = new List<SiteUserPermission>();
                if (itemRow["IdSalesUser"] != DBNull.Value)
                {
                    using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionWorkbenchString))
                    {
                        conofferwithoutpurchaseorder.Open();
                        //MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("select sup.IdCompany, sup.IdUser,si.ShortName from site_user_permission sup inner join geos.sites si on sup.IdCompany=si.IdSite where IdUser = " + salesUser.IdSalesUser + " group by IdUser, IdCompany;", conofferwithoutpurchaseorder);
                        //conofferwithoutpurchaseordercommand.CommandType = CommandType.Text;
                        MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("users_GetSiteUserPermission", conofferwithoutpurchaseorder);
                        conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                        conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_IdUser", salesUser.IdSalesUser);
                        using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                        {
                            while (offerreader.Read())
                            {
                                SiteUserPermission siteUserPermission = new SiteUserPermission();
                                if (offerreader["IdUser"] != DBNull.Value)
                                    siteUserPermission.IdUser = Convert.ToInt32(offerreader["IdUser"].ToString());
                                if (offerreader["IdCompany"] != DBNull.Value)
                                {
                                    siteUserPermission.IdCompany = Convert.ToInt32(offerreader["IdCompany"].ToString());
                                    siteUserPermission.Company = new Company();
                                    siteUserPermission.Company.IdCompany = Convert.ToInt32(offerreader["IdCompany"].ToString());
                                    siteUserPermission.Company.ShortName = offerreader["ShortName"].ToString();
                                }
                                salesUser.SiteUserPermission.Add(siteUserPermission);
                            }
                        }
                    }
                }
                salesUsers.Add(salesUser);
            }
            return salesUsers;
        }


        public People GetPeopleDetailByIdPerson(string connectionstring, Int32 idPerson)
        {

            People people = new People();
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("people_GetPeopleDetailByIdPerson", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idperson", idPerson);

                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    if (lostReasonsByOfferreader.Read())
                    {
                        people.IdPerson = Convert.ToInt32(lostReasonsByOfferreader["IdPerson"].ToString());
                        people.Name = lostReasonsByOfferreader["Name"].ToString();
                        people.Surname = lostReasonsByOfferreader["Surname"].ToString();
                        people.Email = lostReasonsByOfferreader["Email"].ToString();
                        people.Phone = lostReasonsByOfferreader["Phone"].ToString();
                        if (lostReasonsByOfferreader["IdPersonGender"] != DBNull.Value)
                        {
                            people.IdPersonGender = Convert.ToByte(lostReasonsByOfferreader["IdPersonGender"].ToString());
                            if (people.IdPersonGender == 1)
                                people.UserGender = "Female";
                            else if (people.IdPersonGender == 2)
                                people.UserGender = "Male";
                        }
                        people.Company = new Company();
                        people.Company.IdCompany = Convert.ToInt32(lostReasonsByOfferreader["IdSite"].ToString());
                        people.Company.ShortName = lostReasonsByOfferreader["ShortName"].ToString();
                        people.Company.Country = new Country();
                        people.Company.Country.IdCountry = Convert.ToByte(lostReasonsByOfferreader["IdCountry"].ToString());
                        people.Company.Country.Name = lostReasonsByOfferreader["Country"].ToString();
                        people.Company.Country.Zone = new Zone();
                        people.Company.Country.Zone.IdZone = Convert.ToInt32(lostReasonsByOfferreader["IdZone"].ToString());
                        people.Company.Country.Zone.Name = lostReasonsByOfferreader["Region"].ToString();
                    }
                }
            }
            return people;
        }




        public Activity AddActivity(Activity activity, string mainServerConnectionString, string activityAttachmentFilePath, string workbenchConnectionString, string MailServerName, string MailServerPort, string MailFrom, string EmailTemplate)
        {
            TransactionScope transactionScope = null;
            TransactionScope transactionScopeNew = null;

            using (transactionScope = new System.Transactions.TransactionScope())
            {
                try
                {
                    using (MySqlConnection connActivity = new MySqlConnection(mainServerConnectionString))
                    {
                        connActivity.Open();

                        MySqlCommand insertActivityCommand = new MySqlCommand("activities_Insert", connActivity);
                        insertActivityCommand.CommandType = CommandType.StoredProcedure;

                        insertActivityCommand.Parameters.AddWithValue("_ToDate", activity.ToDate);
                        insertActivityCommand.Parameters.AddWithValue("_Subject", activity.Subject);
                        insertActivityCommand.Parameters.AddWithValue("_Location", activity.Location);
                        insertActivityCommand.Parameters.AddWithValue("_IdOwner", activity.IdOwner);
                        insertActivityCommand.Parameters.AddWithValue("_IdActivityType", activity.IdActivityType);
                        insertActivityCommand.Parameters.AddWithValue("_FromDate", activity.FromDate);
                        insertActivityCommand.Parameters.AddWithValue("_Description", activity.Description);
                        insertActivityCommand.Parameters.AddWithValue("_CreatedBy", activity.CreatedBy);
                        insertActivityCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                        insertActivityCommand.Parameters.AddWithValue("_Longitude", activity.Longitude);
                        insertActivityCommand.Parameters.AddWithValue("_Latitude", activity.Latitude);
                        insertActivityCommand.Parameters.AddWithValue("_IdActivityStatus", activity.IdActivityStatus);
                        insertActivityCommand.Parameters.AddWithValue("_IsCompleted", activity.IsCompleted);
                        insertActivityCommand.Parameters.AddWithValue("_IsDeleted", activity.IsDeleted);
                        insertActivityCommand.Parameters.AddWithValue("_ReminderDateTime", activity.ActivityReminderDateTime);
                        insertActivityCommand.Parameters.AddWithValue("_IsSentMail", activity.IsSentMail);
                        insertActivityCommand.Parameters.AddWithValue("_IsInternal", activity.IsInternal);

                        if (activity.IsCompleted == 1)
                        {
                            insertActivityCommand.Parameters.AddWithValue("_CloseDate", DateTime.Now);
                        }
                        else
                        {
                            insertActivityCommand.Parameters.AddWithValue("_CloseDate", DBNull.Value);
                        }

                        //concompanycommand.Transaction = transactionScope;
                        activity.IdActivity = Convert.ToInt32(insertActivityCommand.ExecuteScalar());

                        connActivity.Close();

                        if (activity.IdActivity > 0)
                        {
                            AddActivityAttendees(activity.IdActivity, activity.ActivityAttendees, mainServerConnectionString);
                            AddActivityWatchers(activity.IdActivity, activity.ActivityWatchers, mainServerConnectionString); //Sprint22

                            AddLogEntriesByActivity(activity.IdActivity, activity.LogEntriesByActivity, mainServerConnectionString);
                            AddLogEntriesByActivity(activity.IdActivity, activity.CommentsByActivity, mainServerConnectionString);
                            AddActivityLinkedItem(activity.IdActivity, activity.ActivityLinkedItem, mainServerConnectionString);

                            if (activity.ActivityAttachment != null && activity.ActivityAttachment.Count > 0)
                                AddActivityAttachment(activity, activity.ActivityAttachment, mainServerConnectionString, activityAttachmentFilePath);

                            AddActivityTags(activity.IdActivity, activity.ActivityTags, mainServerConnectionString);

                            using (transactionScopeNew = new TransactionScope(TransactionScopeOption.RequiresNew))
                            {
                                if (activity.Notification != null)
                                {
                                    Notification notification = AddNotification(activity.Notification, activity.ActivityMail, workbenchConnectionString, MailServerName, MailServerPort, MailFrom, EmailTemplate);
                                    transactionScopeNew.Complete();

                                    if (notification.Id > 0)
                                    {
                                        ApplicationManager applicationManager = new ApplicationManager();
                                        if (activity.ActivityMail != null)
                                            applicationManager.SendActivityMail(activity.ActivityMail, MailServerName, MailServerPort, MailFrom, EmailTemplate);
                                    }
                                }
                            }

                            transactionScope.Complete();
                        }
                    }
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    if (transactionScopeNew != null)
                        transactionScopeNew.Dispose();

                    throw;
                }
            }


            //return null;

            //try
            //{
            //    using (MySqlConnection concompany = new MySqlConnection(mainServerConnectionString))
            //    {
            //        concompany.Open();

            //        using (MySqlTransaction trans = concompany.BeginTransaction())
            //        {
            //            try
            //            {
            //                MySqlCommand concompanycommand = new MySqlCommand("activities_Insert", concompany);
            //                concompanycommand.CommandType = CommandType.StoredProcedure;
            //                concompanycommand.Parameters.AddWithValue("_ToDate", activity.ToDate);
            //                concompanycommand.Parameters.AddWithValue("_Subject", activity.Subject);
            //                concompanycommand.Parameters.AddWithValue("_Location", activity.Location);
            //                concompanycommand.Parameters.AddWithValue("_IdOwner", activity.IdOwner);
            //                concompanycommand.Parameters.AddWithValue("_IdActivityType", activity.IdActivityType);
            //                concompanycommand.Parameters.AddWithValue("_FromDate", activity.FromDate);
            //                concompanycommand.Parameters.AddWithValue("_Description", activity.Description);
            //                concompanycommand.Parameters.AddWithValue("_CreatedBy", activity.CreatedBy);
            //                concompanycommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
            //                concompanycommand.Parameters.AddWithValue("_Longitude", activity.Longitude);
            //                concompanycommand.Parameters.AddWithValue("_Latitude", activity.Latitude);
            //                concompanycommand.Parameters.AddWithValue("_IdActivityStatus", activity.IdActivityStatus);
            //                concompanycommand.Parameters.AddWithValue("_IsCompleted", activity.IsCompleted);
            //                concompanycommand.Parameters.AddWithValue("_IsDeleted", activity.IsDeleted);
            //                concompanycommand.Parameters.AddWithValue("_ReminderDateTime", activity.ActivityReminderDateTime);
            //                concompanycommand.Parameters.AddWithValue("_IsSentMail", activity.IsSentMail);

            //                if (activity.IsCompleted == 1)
            //                {
            //                    concompanycommand.Parameters.AddWithValue("_CloseDate", DateTime.Now);
            //                }
            //                else
            //                {
            //                    concompanycommand.Parameters.AddWithValue("_CloseDate", DBNull.Value);
            //                }

            //                concompanycommand.Transaction = trans;
            //                activity.IdActivity = Convert.ToInt32(concompanycommand.ExecuteScalar());

            //                //AddActivityWatchers(concompany ,trans, activity.IdActivity, activity.ActivityWatchers, mainconnectionstring); //Sprint22

            //                trans.Commit();

            //                if (activity.IdActivity > 0)
            //                {
            //                    AddActivityAttendees(activity.IdActivity, activity.ActivityAttendees, mainServerConnectionString);
            //                    AddLogEntriesByActivity(activity.IdActivity, activity.LogEntriesByActivity, mainServerConnectionString);
            //                    AddLogEntriesByActivity(activity.IdActivity, activity.CommentsByActivity, mainServerConnectionString);
            //                    AddActivityLinkedItem(activity.IdActivity, activity.ActivityLinkedItem, mainServerConnectionString);

            //                    if (activity.ActivityAttachment != null && activity.ActivityAttachment.Count > 0)
            //                        AddActivityAttachment(activity, activity.ActivityAttachment, mainServerConnectionString, activityAttachmentFilePath);

            //                    AddActivityTags(activity.IdActivity, activity.ActivityTags, mainServerConnectionString);

            //                    if (activity.Notification != null)
            //                        AddNotification(activity.Notification, activity.ActivityMail, workbenchConnectionString, MailServerName, MailServerPort, MailFrom, EmailTemplate);
            //                }
            //            }
            //            catch (Exception ex)
            //            {
            //                try
            //                {
            //                    //Delete activity if causes exception while save because it creates activity with some empty data
            //                    activity.IsDeleted = 1;
            //                    activity.LogEntriesByActivity = null;
            //                    DeleteActivity(activity, mainServerConnectionString);
            //                }
            //                catch { }
            //                trans.Rollback();
            //                throw;
            //            }
            //        }
            //    }

            //}
            //catch (Exception ex)
            //{
            //    throw;
            //}

            return activity;
        }

        public bool AddActivityAttendees(Int64 idActivity, List<ActivityAttendees> activityAttendees, string mainServerConnectionString)
        {
            bool isInserted = false;

            if (activityAttendees != null)
            {
                try
                {
                    foreach (ActivityAttendees item in activityAttendees)
                    {
                        if (item.IsDeleted == true)
                        {
                            isInserted = DeleteActivityAttendees(item, mainServerConnectionString);
                        }
                        else
                        {
                            using (MySqlConnection connAttendees = new MySqlConnection(mainServerConnectionString))
                            {
                                connAttendees.Open();
                                //using (MySqlTransaction trans = concompany.BeginTransaction())
                                //{
                                try
                                {
                                    MySqlCommand conAttendeesCommand = new MySqlCommand("activityAttendees_Insert", connAttendees);
                                    conAttendeesCommand.CommandType = CommandType.StoredProcedure;
                                    conAttendeesCommand.Parameters.AddWithValue("_IdUser", item.IdUser);
                                    conAttendeesCommand.Parameters.AddWithValue("_IdActivity", idActivity);
                                    //concompanycommand.Transaction = trans;
                                    item.IdActivityAttendees = Convert.ToInt32(conAttendeesCommand.ExecuteScalar());

                                    //trans.Commit();

                                    if (item.IdActivityAttendees > 0)
                                    {
                                        isInserted = true;
                                    }

                                    connAttendees.Close();
                                }
                                catch (Exception ex)
                                {
                                    //trans.Rollback();
                                    throw;
                                }
                                //}
                            }
                        }
                    }


                }
                catch (Exception ex)
                {
                    throw;
                }
            }
            return isInserted;
        }

        public bool AddLogEntriesByActivity(Int64 idActivity, List<LogEntriesByActivity> logEntriesByActivity, string mainconnectionstring)
        {
            bool isInserted = false;

            if (logEntriesByActivity != null)
            {
                try
                {
                    foreach (LogEntriesByActivity item in logEntriesByActivity)
                    {
                        using (MySqlConnection connLogEntries = new MySqlConnection(mainconnectionstring))
                        {
                            connLogEntries.Open();

                            try
                            {
                                MySqlCommand logEntriesCommand = new MySqlCommand("logEntriesByActivity_Insert", connLogEntries);
                                logEntriesCommand.CommandType = CommandType.StoredProcedure;
                                logEntriesCommand.Parameters.AddWithValue("_IdUser", item.IdUser);
                                logEntriesCommand.Parameters.AddWithValue("_IdActivity", idActivity);
                                logEntriesCommand.Parameters.AddWithValue("_IdLogEntryType", item.IdLogEntryType);
                                logEntriesCommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                                logEntriesCommand.Parameters.AddWithValue("_Comments", item.Comments);
                                logEntriesCommand.Parameters.AddWithValue("_IsRtfText", item.IsRtfText);

                                item.IdLogEntryByActivity = Convert.ToInt32(logEntriesCommand.ExecuteScalar());

                                connLogEntries.Close();

                                if (item.IdLogEntryByActivity > 0)
                                {
                                    isInserted = true;
                                }
                            }
                            catch (Exception ex)
                            {
                                throw;
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    throw;
                }
            }

            return isInserted;
        }

        public bool UpdateCommentsByActivity(List<LogEntriesByActivity> logEntriesByActivity, string mainServerConnectionString)
        {
            bool isInserted = false;

            if (logEntriesByActivity != null)
            {
                try
                {
                    foreach (LogEntriesByActivity item in logEntriesByActivity)
                    {
                        if (item.IsUpdated)
                        {
                            using (MySqlConnection connCommentsActivity = new MySqlConnection(mainServerConnectionString))
                            {
                                connCommentsActivity.Open();

                                try
                                {
                                    MySqlCommand updateCommentsCommand = new MySqlCommand("logEntriesByActivity_Update", connCommentsActivity);
                                    updateCommentsCommand.CommandType = CommandType.StoredProcedure;
                                    updateCommentsCommand.Parameters.AddWithValue("_IdLogEntryByActivity", item.IdLogEntryByActivity);
                                    updateCommentsCommand.Parameters.AddWithValue("_Comments", item.Comments);
                                    updateCommentsCommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                                    updateCommentsCommand.Parameters.AddWithValue("_IsRtfText", item.IsRtfText);

                                    item.IdLogEntryByActivity = Convert.ToInt32(updateCommentsCommand.ExecuteScalar());

                                    connCommentsActivity.Close();
                                    if (item.IdLogEntryByActivity > 0)
                                    {
                                        isInserted = true;
                                    }
                                }
                                catch (Exception ex)
                                {
                                    throw;
                                }
                            }
                        }
                        else if (item.IsDeleted)
                        {
                            using (MySqlConnection connCommentsActivity = new MySqlConnection(mainServerConnectionString))
                            {
                                connCommentsActivity.Open();
                                try
                                {
                                    MySqlCommand deleteCommentsCommand = new MySqlCommand("logEntriesByActivity_Delete", connCommentsActivity);
                                    deleteCommentsCommand.CommandType = CommandType.StoredProcedure;
                                    deleteCommentsCommand.Parameters.AddWithValue("_IdLogEntryByActivity", item.IdLogEntryByActivity);

                                    deleteCommentsCommand.ExecuteNonQuery();
                                    connCommentsActivity.Close();
                                }
                                catch (Exception ex)
                                {
                                    throw;
                                }
                            }
                        }
                        else
                        {
                            using (MySqlConnection connCommentsActivity = new MySqlConnection(mainServerConnectionString))
                            {
                                connCommentsActivity.Open();

                                try
                                {
                                    MySqlCommand insertCommentsCommand = new MySqlCommand("logEntriesByActivity_Insert", connCommentsActivity);
                                    insertCommentsCommand.CommandType = CommandType.StoredProcedure;
                                    insertCommentsCommand.Parameters.AddWithValue("_IdUser", item.IdUser);
                                    insertCommentsCommand.Parameters.AddWithValue("_IdActivity", item.IdActivity);
                                    insertCommentsCommand.Parameters.AddWithValue("_IdLogEntryType", item.IdLogEntryType);
                                    insertCommentsCommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                                    insertCommentsCommand.Parameters.AddWithValue("_Comments", item.Comments);
                                    insertCommentsCommand.Parameters.AddWithValue("_IsRtfText", item.IsRtfText);

                                    item.IdLogEntryByActivity = Convert.ToInt32(insertCommentsCommand.ExecuteScalar());
                                    connCommentsActivity.Close();

                                    if (item.IdLogEntryByActivity > 0)
                                    {
                                        isInserted = true;
                                    }
                                }
                                catch (Exception ex)
                                {
                                    throw;
                                }
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    throw;
                }
            }

            return isInserted;
        }

        public bool UpdateActivity(Activity activity, string mainServerConnectionString, string activityAttachmentPath)
        {

            bool isUpdated = false;

            TransactionScope transactionScope = null;

            try
            {
                using (transactionScope = new System.Transactions.TransactionScope())
                {
                    using (MySqlConnection connUpdateActivity = new MySqlConnection(mainServerConnectionString))
                    {
                        connUpdateActivity.Open();

                        MySqlCommand updateActivityCommand = new MySqlCommand("activities_Update", connUpdateActivity);
                        updateActivityCommand.CommandType = CommandType.StoredProcedure;
                        updateActivityCommand.Parameters.AddWithValue("_ToDate", activity.ToDate);
                        updateActivityCommand.Parameters.AddWithValue("_Subject", activity.Subject);
                        updateActivityCommand.Parameters.AddWithValue("_Location", activity.Location);
                        updateActivityCommand.Parameters.AddWithValue("_IdOwner", activity.IdOwner);
                        updateActivityCommand.Parameters.AddWithValue("_IdActivityType", activity.IdActivityType);
                        updateActivityCommand.Parameters.AddWithValue("_FromDate", activity.FromDate);
                        updateActivityCommand.Parameters.AddWithValue("_Description", activity.Description);
                        updateActivityCommand.Parameters.AddWithValue("_ModifiedBy", activity.ModifiedBy);
                        updateActivityCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        updateActivityCommand.Parameters.AddWithValue("_IdActivity", activity.IdActivity);
                        updateActivityCommand.Parameters.AddWithValue("_Longitude", activity.Longitude);
                        updateActivityCommand.Parameters.AddWithValue("_Latitude", activity.Latitude);
                        updateActivityCommand.Parameters.AddWithValue("_IdActivityStatus", activity.IdActivityStatus);
                        updateActivityCommand.Parameters.AddWithValue("_IsCompleted", activity.IsCompleted);
                        updateActivityCommand.Parameters.AddWithValue("_ReminderDateTime", activity.ActivityReminderDateTime);
                        updateActivityCommand.Parameters.AddWithValue("_IsSentMail", activity.IsSentMail);
                        updateActivityCommand.Parameters.AddWithValue("_IsInternal", activity.IsInternal);

                        if (activity.IsCompleted == 1)
                        {
                            updateActivityCommand.Parameters.AddWithValue("_CloseDate", DateTime.Now);
                        }
                        else
                        {
                            updateActivityCommand.Parameters.AddWithValue("_CloseDate", DBNull.Value);
                        }

                        updateActivityCommand.Parameters.AddWithValue("_IsDeleted", activity.IsDeleted);
                        //concompanycommand.Transaction = trans;
                        updateActivityCommand.ExecuteNonQuery();

                        connUpdateActivity.Close();

                        isUpdated = true;
                        //trans.Commit();

                        if (isUpdated == true)
                        {
                            AddActivityAttendees(activity.IdActivity, activity.ActivityAttendees, mainServerConnectionString);
                            AddActivityWatchers(activity.IdActivity, activity.ActivityWatchers, mainServerConnectionString);
                            AddActivityLinkedItem(activity.IdActivity, activity.ActivityLinkedItem, mainServerConnectionString);
                            AddLogEntriesByActivity(activity.IdActivity, activity.LogEntriesByActivity, mainServerConnectionString);
                            UpdateCommentsByActivity(activity.CommentsByActivity, mainServerConnectionString);

                            if (activity.ActivityAttachment != null && activity.ActivityAttachment.Count > 0)
                                AddActivityAttachment(activity, activity.ActivityAttachment, mainServerConnectionString, activityAttachmentPath);

                            AddActivityTags(activity.IdActivity, activity.ActivityTags, mainServerConnectionString);
                        }

                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                transactionScope.Dispose();
                throw;
            }

            return isUpdated;


            //bool isUpdated = false;
            //try
            //{
            //    using (MySqlConnection myConnection = new MySqlConnection(mainconnectionstring))
            //    {
            //        myConnection.Open();
            //        using (MySqlTransaction trans = myConnection.BeginTransaction())
            //        {
            //            try
            //            {
            //                MySqlCommand concompanycommand = new MySqlCommand("activities_Update", myConnection);
            //                concompanycommand.CommandType = CommandType.StoredProcedure;
            //                concompanycommand.Parameters.AddWithValue("_ToDate", activity.ToDate);
            //                concompanycommand.Parameters.AddWithValue("_Subject", activity.Subject);
            //                concompanycommand.Parameters.AddWithValue("_Location", activity.Location);
            //                concompanycommand.Parameters.AddWithValue("_IdOwner", activity.IdOwner);
            //                concompanycommand.Parameters.AddWithValue("_IdActivityType", activity.IdActivityType);
            //                concompanycommand.Parameters.AddWithValue("_FromDate", activity.FromDate);
            //                concompanycommand.Parameters.AddWithValue("_Description", activity.Description);
            //                concompanycommand.Parameters.AddWithValue("_ModifiedBy", activity.ModifiedBy);
            //                concompanycommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
            //                concompanycommand.Parameters.AddWithValue("_IdActivity", activity.IdActivity);
            //                concompanycommand.Parameters.AddWithValue("_Longitude", activity.Longitude);
            //                concompanycommand.Parameters.AddWithValue("_Latitude", activity.Latitude);
            //                concompanycommand.Parameters.AddWithValue("_IdActivityStatus", activity.IdActivityStatus);
            //                concompanycommand.Parameters.AddWithValue("_IsCompleted", activity.IsCompleted);
            //                concompanycommand.Parameters.AddWithValue("_ReminderDateTime", activity.ActivityReminderDateTime);
            //                concompanycommand.Parameters.AddWithValue("_IsSentMail", activity.IsSentMail);

            //                if (activity.IsCompleted == 1)
            //                {
            //                    concompanycommand.Parameters.AddWithValue("_CloseDate", DateTime.Now);
            //                }
            //                else
            //                {
            //                    concompanycommand.Parameters.AddWithValue("_CloseDate", DBNull.Value);
            //                }

            //                concompanycommand.Parameters.AddWithValue("_IsDeleted", activity.IsDeleted);
            //                concompanycommand.Transaction = trans;
            //                concompanycommand.ExecuteNonQuery();

            //                isUpdated = true;
            //                trans.Commit();
            //                if (isUpdated == true)
            //                {
            //                    AddActivityAttendees(activity.IdActivity, activity.ActivityAttendees, mainconnectionstring);
            //                    AddActivityLinkedItem(activity.IdActivity, activity.ActivityLinkedItem, mainconnectionstring);
            //                    AddLogEntriesByActivity(activity.IdActivity, activity.LogEntriesByActivity, mainconnectionstring);
            //                    UpdateCommentsByActivity(activity.CommentsByActivity, mainconnectionstring);

            //                    if (activity.ActivityAttachment != null && activity.ActivityAttachment.Count > 0)
            //                        AddActivityAttachment(activity, activity.ActivityAttachment, mainconnectionstring, activityAttachmentPath);

            //                    AddActivityTags(activity.IdActivity, activity.ActivityTags, mainconnectionstring);
            //                }
            //            }
            //            catch (Exception ex)
            //            {
            //                trans.Rollback();
            //                throw;
            //            }
            //        }
            //    }
            //}
            //catch (Exception ex)
            //{
            //    throw;
            //}

            //return isUpdated;
        }


        public bool DeleteActivityAttendees(ActivityAttendees activityAttendees, string mainconnectionstring)
        {
            bool isDeleted = false;

            try
            {
                using (MySqlConnection connAttendees = new MySqlConnection(mainconnectionstring))
                {
                    connAttendees.Open();
                    //using (MySqlTransaction trans = myConnection.BeginTransaction())
                    //{
                    try
                    {
                        MySqlCommand attendeesCommand = new MySqlCommand("activityAttendees_Delete", connAttendees);
                        attendeesCommand.CommandType = CommandType.StoredProcedure;
                        attendeesCommand.Parameters.AddWithValue("_IdUser", activityAttendees.IdUser);
                        attendeesCommand.Parameters.AddWithValue("_IdActivity", activityAttendees.IdActivity);
                        //concompanycommand.Transaction = trans;
                        attendeesCommand.ExecuteNonQuery();

                        isDeleted = true;
                        //trans.Commit();
                        connAttendees.Close();
                    }
                    catch (Exception ex)
                    {
                        //trans.Rollback();
                        throw;
                    }
                    //}
                }
            }
            catch (Exception ex)
            {
                throw;
            }

            return isDeleted;
        }


        public List<Activity> GetActivities(Int32 idOwner, string mainconnectionstring)
        {
            List<Activity> listactivity = new List<Activity>();

            using (MySqlConnection congetactivities = new MySqlConnection(mainconnectionstring))
            {
                congetactivities.Open();
                MySqlCommand congetactivitiescommand = new MySqlCommand("activities_Getactivities", congetactivities);
                congetactivitiescommand.CommandType = CommandType.StoredProcedure;
                congetactivitiescommand.Parameters.AddWithValue("_IdOwner", idOwner);
                using (MySqlDataReader activityreader = congetactivitiescommand.ExecuteReader())
                {
                    while (activityreader.Read())
                    {
                        Activity activity = new Activity();
                        activity.IdActivity = Convert.ToInt64(activityreader["IdActivity"].ToString());
                        activity.Subject = activityreader["Subject"].ToString();
                        if (activityreader["IdActivityType"] != DBNull.Value)
                        {
                            activity.LookupValue = new LookupValue();
                            activity.LookupValue.IdLookupValue = Convert.ToInt32(activityreader["IdActivityType"].ToString());
                            activity.LookupValue.Value = activityreader["ActivityType"].ToString();
                            activity.LookupValue.HtmlColor = activityreader["ActivityTypeHtmlColor"].ToString();
                            if (activityreader["ActivityTypeImage"] != DBNull.Value)
                                activity.LookupValue.IdImage = Convert.ToInt64(activityreader["ActivityTypeImage"].ToString());
                            if (activityreader["ActivityTypePosition"] != DBNull.Value)
                                activity.LookupValue.Position = Convert.ToInt32(activityreader["ActivityTypePosition"].ToString());


                        }
                        if (activityreader["FromDate"] != DBNull.Value)
                            activity.FromDate = Convert.ToDateTime(activityreader["FromDate"].ToString());
                        if (activityreader["ToDate"] != DBNull.Value)
                            activity.ToDate = Convert.ToDateTime(activityreader["ToDate"].ToString());

                        activity.Location = activityreader["Location"].ToString();

                        if (activityreader["IdOwner"] != DBNull.Value)
                            activity.IdOwner = Convert.ToInt32(activityreader["IdOwner"].ToString());

                        if (activityreader["IdPerson"] != DBNull.Value)
                        {
                            activity.People = new People();

                            activity.People.Name = activityreader["Name"].ToString();
                            activity.People.Surname = activityreader["Surname"].ToString();
                        }
                        if (activityreader["Latitude"] != DBNull.Value)
                            activity.Latitude = Convert.ToDouble(activityreader["Latitude"].ToString());
                        if (activityreader["Longitude"] != DBNull.Value)
                            activity.Longitude = Convert.ToDouble(activityreader["Longitude"].ToString());
                        if (activityreader["IsCompleted"] != DBNull.Value)
                            activity.IsCompleted = Convert.ToByte(activityreader["IsCompleted"].ToString());
                        if (activityreader["IdActivityStatus"] != DBNull.Value)
                        {
                            activity.ActivityStatus = new LookupValue();
                            activity.ActivityStatus.IdLookupValue = Convert.ToInt32(activityreader["IdActivityStatus"].ToString());
                            activity.ActivityStatus.Value = activityreader["ActivityStatus"].ToString();
                            activity.ActivityStatus.HtmlColor = activityreader["ActivityStatusHtmlColor"].ToString();
                            if (activityreader["ActivityStatusImage"] != DBNull.Value)
                                activity.ActivityStatus.IdImage = Convert.ToInt64(activityreader["ActivityStatusImage"].ToString());
                            if (activityreader["ActivityStatusPosition"] != DBNull.Value)
                                activity.ActivityStatus.Position = Convert.ToInt32(activityreader["ActivityStatusPosition"].ToString());
                        }
                        listactivity.Add(activity);
                    }
                }
            }

            return listactivity;
        }



        public List<LogEntriesByActivity> GetlogEntriesByActivity(Int64 idActivity, byte idLogEntryType, string mainConnectionString)
        {
            List<LogEntriesByActivity> listLogEntriesByActivity = new List<LogEntriesByActivity>();

            using (MySqlConnection congetactivities = new MySqlConnection(mainConnectionString))
            {
                congetactivities.Open();

                MySqlCommand congetactivitiescommand = new MySqlCommand("logEntryActivity_GetlogEntriesByActivity", congetactivities);
                congetactivitiescommand.CommandType = CommandType.StoredProcedure;
                congetactivitiescommand.Parameters.AddWithValue("_IdActivity", idActivity);
                congetactivitiescommand.Parameters.AddWithValue("_IdLogEntryType", idLogEntryType);

                using (MySqlDataReader activityreader = congetactivitiescommand.ExecuteReader())
                {
                    while (activityreader.Read())
                    {
                        LogEntriesByActivity logEntriesByActivity = new LogEntriesByActivity();

                        logEntriesByActivity.IdLogEntryByActivity = Convert.ToInt64(activityreader["IdLogEntryByActivity"]);

                        if (activityreader["IdUser"] != DBNull.Value)
                            logEntriesByActivity.IdUser = Convert.ToInt32(activityreader["IdUser"].ToString());

                        if (activityreader["IdActivity"] != DBNull.Value)
                            logEntriesByActivity.IdActivity = Convert.ToInt64(activityreader["IdActivity"].ToString());

                        if (activityreader["IdPerson"] != DBNull.Value)
                        {
                            logEntriesByActivity.People = new People();
                            logEntriesByActivity.People.IdPerson = Convert.ToInt32(activityreader["IdPerson"].ToString());
                            logEntriesByActivity.People.Name = activityreader["Name"].ToString();
                            logEntriesByActivity.People.Surname = activityreader["Surname"].ToString();

                            if (activityreader["Login"] != DBNull.Value)
                                logEntriesByActivity.People.Login = Convert.ToString(activityreader["Login"]);

                            if (activityreader["IdUserGender"] != DBNull.Value)
                                logEntriesByActivity.People.IdPersonGender = Convert.ToByte(activityreader["IdUserGender"]);
                        }

                        if (activityreader["Datetime"] != DBNull.Value)
                            logEntriesByActivity.Datetime = Convert.ToDateTime(activityreader["Datetime"].ToString());

                        if (activityreader["Comments"] != DBNull.Value)
                            logEntriesByActivity.Comments = activityreader["Comments"].ToString();

                        if (activityreader["IdLogEntryType"] != DBNull.Value)
                            logEntriesByActivity.IdLogEntryType = Convert.ToByte(activityreader["IdLogEntryType"]);

                        if (activityreader["IsRtfText"] != DBNull.Value)
                            logEntriesByActivity.IsRtfText = Convert.ToBoolean(activityreader["IsRtfText"]);

                        listLogEntriesByActivity.Add(logEntriesByActivity);
                    }
                }
            }

            return listLogEntriesByActivity;
        }

        public List<ActivityAttachment> GetActivityAttachmentByIdActivity(Int64 idActivity, string mainconnectionstring)
        {
            List<ActivityAttachment> activityAttachments = new List<ActivityAttachment>();
            using (MySqlConnection congetactivities = new MySqlConnection(mainconnectionstring))
            {
                congetactivities.Open();
                MySqlCommand congetactivitiescommand = new MySqlCommand("activities_GetAttachmentByIdActivity", congetactivities);
                congetactivitiescommand.CommandType = CommandType.StoredProcedure;
                congetactivitiescommand.Parameters.AddWithValue("_IdActivity", idActivity);

                using (MySqlDataReader activityreader = congetactivitiescommand.ExecuteReader())
                {
                    while (activityreader.Read())
                    {
                        ActivityAttachment activityAttachment = new ActivityAttachment();
                        if (activityreader["IdActivityAttachment"] != DBNull.Value)
                            activityAttachment.IdActivityAttachment = Convert.ToInt64(activityreader["IdActivityAttachment"].ToString());
                        if (activityreader["IdActivity"] != DBNull.Value)
                            activityAttachment.IdActivity = Convert.ToInt64(activityreader["IdActivity"].ToString());
                        if (activityreader["FileSize"] != DBNull.Value)
                            activityAttachment.FileSize = Convert.ToInt64(activityreader["FileSize"].ToString());
                        activityAttachment.OriginalFileName = activityreader["OriginalFileName"].ToString();
                        activityAttachment.SavedFileName = activityreader["SavedFileName"].ToString();
                        activityAttachment.FileType = activityreader["FileType"].ToString();
                        if (activityreader["UploadedIn"] != DBNull.Value)
                            activityAttachment.UploadedIn = Convert.ToDateTime(activityreader["UploadedIn"].ToString());
                        if (activityreader["IsDeleted"] != DBNull.Value)
                            activityAttachment.IsDeleted = Convert.ToByte(activityreader["IsDeleted"].ToString());

                        activityAttachments.Add(activityAttachment);
                    }
                }
            }

            return activityAttachments;
        }


        public Activity GetActivityByIdActivity(Int64 idActivity, string connectionString)
        {
            Activity activity = new Activity();

            using (MySqlConnection connActivities = new MySqlConnection(connectionString))
            {
                connActivities.Open();
                MySqlCommand getActivitiesCommand = new MySqlCommand("Activity_GetActivityByIdActivity", connActivities);
                getActivitiesCommand.CommandType = CommandType.StoredProcedure;
                getActivitiesCommand.Parameters.AddWithValue("_IdActivity", idActivity);
                using (MySqlDataReader activityReader = getActivitiesCommand.ExecuteReader())
                {
                    while (activityReader.Read())
                    {
                        activity.Subject = activityReader["Subject"].ToString();

                        if (activityReader["IdActivityType"] != DBNull.Value)
                        {
                            activity.IdActivityType = Convert.ToInt32(activityReader["IdActivityType"].ToString());
                            activity.LookupValue = new LookupValue();
                            activity.LookupValue.IdLookupValue = Convert.ToInt32(activityReader["IdActivityType"].ToString());
                            activity.LookupValue.Value = activityReader["ActivityType"].ToString();
                            activity.LookupValue.HtmlColor = activityReader["ActivityTypeHtmlColor"].ToString();

                            if (activityReader["ActivityTypeImage"] != DBNull.Value)
                                activity.LookupValue.IdImage = Convert.ToInt64(activityReader["ActivityTypeImage"].ToString());

                            if (activityReader["ActivityTypePosition"] != DBNull.Value)
                                activity.LookupValue.Position = Convert.ToInt32(activityReader["ActivityTypePosition"].ToString());
                        }

                        activity.IdActivity = Convert.ToInt64(activityReader["IdActivity"].ToString());
                        if (activityReader["IdOwner"] != DBNull.Value)
                            activity.IdOwner = Convert.ToInt32(activityReader["IdOwner"].ToString());

                        if (activityReader["FromDate"] != DBNull.Value)
                        {
                            var ordinal = activityReader.GetOrdinal("FromDate");
                            activity.FromDate = Convert.ToDateTime(activityReader.GetMySqlDateTime(ordinal));
                        }

                        if (activityReader["ToDate"] != DBNull.Value)
                        {
                            var ordinal = activityReader.GetOrdinal("ToDate");
                            activity.ToDate = Convert.ToDateTime(activityReader.GetMySqlDateTime(ordinal));
                        }

                        //if (activityreader["FromDate"] != DBNull.Value)
                        //    activity.FromDate = Convert.ToDateTime(activityreader["FromDate"].ToString());
                        //if (activityreader["ToDate"] != DBNull.Value)
                        //    activity.ToDate = Convert.ToDateTime(activityreader["ToDate"].ToString());

                        activity.Description = activityReader["Description"].ToString();
                        activity.Location = activityReader["Location"].ToString();

                        if (activityReader["CreatedIn"] != DBNull.Value)
                            activity.CreatedIn = Convert.ToDateTime(activityReader["CreatedIn"].ToString());

                        if (activityReader["ModifiedIn"] != DBNull.Value)
                            activity.ModifiedIn = Convert.ToDateTime(activityReader["ModifiedIn"].ToString());

                        if (activityReader["CreatedBy"] != DBNull.Value)
                            activity.CreatedBy = Convert.ToInt32(activityReader["CreatedBy"].ToString());

                        if (activityReader["ModifiedBy"] != DBNull.Value)
                            activity.ModifiedBy = Convert.ToInt32(activityReader["ModifiedBy"].ToString());

                        if (activityReader["Latitude"] != DBNull.Value)
                        {
                            activity.Latitude = Convert.ToDouble(activityReader["Latitude"].ToString());
                            activity.BothLongitudeLatitude = activity.Latitude.ToString();
                        }

                        if (activityReader["Longitude"] != DBNull.Value)
                        {
                            activity.Longitude = Convert.ToDouble(activityReader["Longitude"].ToString());
                            activity.BothLongitudeLatitude = activity.BothLongitudeLatitude + activity.Longitude.ToString();
                        }

                        if (activityReader["IdPerson"] != DBNull.Value)
                        {
                            activity.People = new People();
                            activity.People.Name = activityReader["Name"].ToString();
                            activity.People.IdPerson = Convert.ToInt32(activityReader["IdPerson"].ToString());
                            activity.People.Surname = activityReader["Surname"].ToString();

                            if (activityReader["IdPersonGender"] != DBNull.Value)
                                activity.People.IdPersonGender = Convert.ToByte(activityReader["IdPersonGender"].ToString());
                        }

                        if (activityReader["IsCompleted"] != DBNull.Value)
                        {
                            activity.IsCompleted = Convert.ToByte(activityReader["IsCompleted"].ToString());

                            if (activityReader["CloseDate"] != DBNull.Value)
                                activity.CloseDate = Convert.ToDateTime(activityReader["CloseDate"].ToString());
                        }

                        if (activityReader["IsInternal"] != DBNull.Value)
                        {
                            activity.IsInternal = Convert.ToByte(activityReader["IsInternal"].ToString());
                        }

                        if (activityReader["IdActivityStatus"] != DBNull.Value)
                        {
                            activity.IdActivityStatus = Convert.ToInt32(activityReader["IdActivityStatus"].ToString());
                            activity.ActivityStatus = new LookupValue();
                            activity.ActivityStatus.IdLookupValue = Convert.ToInt32(activityReader["IdActivityStatus"].ToString());
                            activity.ActivityStatus.Value = activityReader["ActivityStatus"].ToString();
                            activity.ActivityStatus.HtmlColor = activityReader["ActivityStatusHtmlColor"].ToString();
                            if (activityReader["ActivityStatusImage"] != DBNull.Value)
                                activity.ActivityStatus.IdImage = Convert.ToInt64(activityReader["ActivityStatusImage"].ToString());
                            if (activityReader["ActivityStatusPosition"] != DBNull.Value)
                                activity.ActivityStatus.Position = Convert.ToInt32(activityReader["ActivityStatusPosition"].ToString());
                        }

                        if (activityReader["ReminderDateTime"] != DBNull.Value)
                            activity.ActivityReminderDateTime = Convert.ToDateTime(activityReader["ReminderDateTime"].ToString());

                        if (activityReader["IsSentMail"] != DBNull.Value)
                            activity.IsSentMail = Convert.ToByte(activityReader["IsSentMail"].ToString());

                        activity.LogEntriesByActivity = new List<LogEntriesByActivity>();
                        activity.LogEntriesByActivity = GetlogEntriesByActivity(idActivity, 2, connectionString);

                        activity.CommentsByActivity = new List<LogEntriesByActivity>();
                        activity.CommentsByActivity = GetlogEntriesByActivity(idActivity, 1, connectionString);

                        activity.ActivityAttendees = new List<ActivityAttendees>();
                        activity.ActivityAttendees = GetActivityAttendeesByIdActivity(idActivity, connectionString);

                        activity.ActivityWatchers = GetActivityWatchersByIdActivity(idActivity, connectionString);

                        activity.ActivityLinkedItem = new List<ActivityLinkedItem>();
                        activity.ActivityLinkedItem = GetActivityLinkedItemsByIdActivity(idActivity, connectionString);

                        activity.ActivityAttachment = new List<ActivityAttachment>();
                        activity.ActivityAttachment = GetActivityAttachmentByIdActivity(idActivity, connectionString);

                        activity.ActivityTags = new List<ActivityTag>();
                        activity.ActivityTags = GetActivityTagsByIdActivity(idActivity, connectionString);
                        //listactivity.Add(activity);
                    }
                }
            }
            return activity;
        }


        public List<ActivityAttendees> GetActivityAttendeesByIdActivity(Int64 idActivity, string mainconnectionstring)
        {
            List<ActivityAttendees> listactivity = new List<ActivityAttendees>();

            using (MySqlConnection congetactivities = new MySqlConnection(mainconnectionstring))
            {
                congetactivities.Open();
                MySqlCommand congetactivitiescommand = new MySqlCommand("activityAttendees_GetAttendeesByIdActivity", congetactivities);
                congetactivitiescommand.CommandType = CommandType.StoredProcedure;
                congetactivitiescommand.Parameters.AddWithValue("_IdActivity", idActivity);
                using (MySqlDataReader activityreader = congetactivitiescommand.ExecuteReader())
                {
                    while (activityreader.Read())
                    {
                        ActivityAttendees activityAttendees = new ActivityAttendees();
                        if (activityreader["IdActivity"] != DBNull.Value)
                            activityAttendees.IdActivity = Convert.ToInt64(activityreader["IdActivity"].ToString());
                        if (activityreader["IdUser"] != DBNull.Value)
                            activityAttendees.IdUser = Convert.ToInt32(activityreader["IdUser"].ToString());
                        if (activityreader["IdActivityAttendees"] != DBNull.Value)
                            activityAttendees.IdActivityAttendees = Convert.ToInt64(activityreader["IdActivityAttendees"].ToString());
                        if (activityreader["IdPerson"] != DBNull.Value)
                        {
                            activityAttendees.People = new People();
                            activityAttendees.People.IdPerson = Convert.ToInt32(activityreader["IdPerson"].ToString());
                            activityAttendees.People.Name = activityreader["Name"].ToString();
                            activityAttendees.People.Surname = activityreader["Surname"].ToString();
                            activityAttendees.People.Email = activityreader["Email"].ToString();
                            activityAttendees.People.Phone = activityreader["Phone"].ToString();
                        }
                        listactivity.Add(activityAttendees);
                    }
                }
            }

            return listactivity;
        }

        public List<Company> GetAllCustomerCompanies(string connectionstring)
        {
            List<Company> companies = new List<Company>();

            using (MySqlConnection consite = new MySqlConnection(connectionstring))
            {
                consite.Open();
                MySqlCommand consitecommand = new MySqlCommand("sites_GetAllSites", consite);
                consitecommand.CommandType = CommandType.StoredProcedure;
                using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                {
                    while (sitereader.Read())
                    {
                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(sitereader["IdCompany"].ToString());
                        company.Name = sitereader["SiteName"].ToString();

                        if (sitereader["IdCustomer"] != DBNull.Value)
                        {
                            company.IdCustomer = Convert.ToInt32(sitereader["IdCustomer"].ToString());
                            Customer customer = new Customer();
                            customer.IdCustomer = Convert.ToInt32(sitereader["IdCustomer"].ToString());
                            customer.CustomerName = sitereader["CustomerName"].ToString();

                            company.Customer = customer;
                        }

                        companies.Add(company);
                    }
                }
            }
            return companies;
        }



        public List<People> GetAllActivePeoples(string connectionstring)
        {
            List<People> peoples = new List<People>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionstring))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("SalesUser_GetSalesUser", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        People people = new People();
                        people.IdPerson = Convert.ToInt32(offerreader["IdPerson"].ToString());
                        people.Name = offerreader["Name"].ToString();
                        people.Surname = offerreader["Surname"].ToString();
                        people.Email = offerreader["Email"].ToString();
                        people.Phone = offerreader["phone"].ToString();
                        peoples.Add(people);
                    }
                }
            }

            return peoples;
        }

        public void AddActivityLinkedItem(Int64 idActivity, List<ActivityLinkedItem> activityLinkedItems, string connectionstring)
        {
            if (activityLinkedItems != null)
            {
                foreach (ActivityLinkedItem activityLinkedItem in activityLinkedItems)
                {
                    activityLinkedItem.IdActivity = idActivity;
                    if (activityLinkedItem.IsDeleted)
                    {
                        using (MySqlConnection connLinkedItem = new MySqlConnection(connectionstring))
                        {
                            connLinkedItem.Open();
                            try
                            {
                                MySqlCommand linkedItemCommand = new MySqlCommand("activityLinkedItems_Delete", connLinkedItem);
                                linkedItemCommand.CommandType = CommandType.StoredProcedure;
                                linkedItemCommand.Parameters.AddWithValue("_IdActivityLinkedItem", activityLinkedItem.IdActivityLinkedItem);
                                linkedItemCommand.ExecuteNonQuery();

                                connLinkedItem.Close();
                            }
                            catch (Exception ex)
                            {
                                throw;
                            }
                        }
                    }
                    else if (activityLinkedItem.IsUpdated)
                    {
                        if (activityLinkedItem.IdActivityLinkedItem > 0)
                        {
                            using (MySqlConnection connLinkedItem = new MySqlConnection(connectionstring))
                            {
                                connLinkedItem.Open();
                                //using (MySqlTransaction trans = concompany.BeginTransaction())
                                //{
                                try
                                {
                                    MySqlCommand linkedItemCommand = new MySqlCommand("activityLinkedItems_Update", connLinkedItem);
                                    linkedItemCommand.CommandType = CommandType.StoredProcedure;

                                    linkedItemCommand.Parameters.AddWithValue("_IdActivityLinkedItem", activityLinkedItem.IdActivityLinkedItem);
                                    linkedItemCommand.Parameters.AddWithValue("_IdActivity", activityLinkedItem.IdActivity);
                                    linkedItemCommand.Parameters.AddWithValue("_IdLinkedItemType", activityLinkedItem.IdLinkedItemType);
                                    linkedItemCommand.Parameters.AddWithValue("_IdSite", activityLinkedItem.IdSite);
                                    linkedItemCommand.Parameters.AddWithValue("_IdCarProject", activityLinkedItem.IdCarProject);
                                    linkedItemCommand.Parameters.AddWithValue("_IdPerson", activityLinkedItem.IdPerson);

                                    linkedItemCommand.Parameters.AddWithValue("_IdOffer", activityLinkedItem.IdOffer);
                                    linkedItemCommand.Parameters.AddWithValue("_IdEmdepSite", activityLinkedItem.IdEmdepSite);
                                    linkedItemCommand.Parameters.AddWithValue("_IdCompetitor", activityLinkedItem.IdCompetitor);

                                    //concompanycommand.Transaction = trans;
                                    activityLinkedItem.IdActivityLinkedItem = Convert.ToInt32(linkedItemCommand.ExecuteScalar());
                                    //trans.Commit();
                                    connLinkedItem.Close();
                                }
                                catch (Exception ex)
                                {
                                    //trans.Rollback();
                                    throw;
                                }
                                //}
                            }
                        }
                    }
                    else
                    {
                        using (MySqlConnection connLinkedItem = new MySqlConnection(connectionstring))
                        {
                            connLinkedItem.Open();
                            //using (MySqlTransaction trans = concompany.BeginTransaction())
                            //{
                            try
                            {
                                MySqlCommand linkedItemCommand = new MySqlCommand("activityLinkedItems_Insert", connLinkedItem);
                                linkedItemCommand.CommandType = CommandType.StoredProcedure;
                                linkedItemCommand.Parameters.AddWithValue("_IdActivity", activityLinkedItem.IdActivity);
                                linkedItemCommand.Parameters.AddWithValue("_IdLinkedItemType", activityLinkedItem.IdLinkedItemType);

                                linkedItemCommand.Parameters.AddWithValue("_IdSite", activityLinkedItem.IdSite);
                                linkedItemCommand.Parameters.AddWithValue("_IdCarProject", activityLinkedItem.IdCarProject);
                                linkedItemCommand.Parameters.AddWithValue("_IdPerson", activityLinkedItem.IdPerson);

                                linkedItemCommand.Parameters.AddWithValue("_IdOffer", activityLinkedItem.IdOffer);
                                linkedItemCommand.Parameters.AddWithValue("_IdEmdepSite", activityLinkedItem.IdEmdepSite);
                                linkedItemCommand.Parameters.AddWithValue("_IdCompetitor", activityLinkedItem.IdCompetitor);

                                //concompanycommand.Transaction = trans;
                                activityLinkedItem.IdActivityLinkedItem = Convert.ToInt32(linkedItemCommand.ExecuteScalar());
                                //trans.Commit();
                                connLinkedItem.Close();
                            }
                            catch (Exception ex)
                            {
                                //trans.Rollback();
                                throw;
                            }
                            //}
                        }
                    }
                }

            }

        }

        public List<ActivityLinkedItem> GetActivityLinkedItemsByIdActivity(Int64 idActivity, string mainconnectionstring)
        {
            List<ActivityLinkedItem> activityLinkedItems = new List<ActivityLinkedItem>();

            using (MySqlConnection congetactivities = new MySqlConnection(mainconnectionstring))
            {
                congetactivities.Open();
                MySqlCommand congetactivitiescommand = new MySqlCommand("activityLinkedItems_GetactivityLinkedItemsByIdActivity", congetactivities);
                congetactivitiescommand.CommandType = CommandType.StoredProcedure;
                congetactivitiescommand.Parameters.AddWithValue("_IdActivity", idActivity);

                using (MySqlDataReader activityreader = congetactivitiescommand.ExecuteReader())
                {
                    while (activityreader.Read())
                    {
                        ActivityLinkedItem activityLinkedItem = new ActivityLinkedItem();
                        activityLinkedItem.IdActivity = Convert.ToInt64(activityreader["IdActivity"].ToString());
                        activityLinkedItem.IdActivityLinkedItem = Convert.ToInt64(activityreader["IdActivityLinkedItem"].ToString());
                        activityLinkedItem.Customer = new Customer();
                        if (activityreader["IdCustomer"] != DBNull.Value)
                        {
                            activityLinkedItem.IdCustomer = Convert.ToInt32(activityreader["IdCustomer"].ToString());

                            activityLinkedItem.Customer.IdCustomer = Convert.ToInt32(activityreader["IdCustomer"].ToString());
                            activityLinkedItem.Customer.CustomerName = activityreader["Group"].ToString();
                        }

                        activityLinkedItem.Company = new Company();
                        if (activityreader["IdSite"] != DBNull.Value)
                        {
                            activityLinkedItem.IdSite = Convert.ToInt32(activityreader["IdSite"].ToString());

                            activityLinkedItem.Company.IdCompany = Convert.ToInt32(activityreader["IdSite"].ToString());
                            activityLinkedItem.Company.SiteNameWithoutCountry = activityreader["SiteWithCountryName"].ToString();
                            activityLinkedItem.Company.Name = activityreader["Plant"].ToString();

                            if (activityreader["IdCustomer"] != DBNull.Value)
                            {
                                activityLinkedItem.Company.Customers = new List<Customer>();
                                Customer cust = new Customer();
                                cust.IdCustomer = Convert.ToInt32(activityreader["IdCustomer"].ToString());
                                cust.CustomerName = activityreader["Group"].ToString();
                                activityLinkedItem.Company.Customers.Add(cust);
                            }
                            activityLinkedItem.Name = activityLinkedItem.Customer.CustomerName + " - " + activityLinkedItem.Company.SiteNameWithoutCountry;
                        }

                        if (activityreader["IdCarProject"] != DBNull.Value)
                        {
                            activityLinkedItem.IdCarProject = Convert.ToInt64(activityreader["IdCarProject"].ToString());
                            activityLinkedItem.CarProject = new CarProject();
                            activityLinkedItem.CarProject.IdCarProject = Convert.ToInt64(activityreader["IdCarProject"].ToString());
                            activityLinkedItem.CarProject.Name = activityreader["CarProject"].ToString();
                            activityLinkedItem.CarProject.CarOEM = new CarOEM();
                            if (activityreader["IdCarOem"] != DBNull.Value)
                            {
                                activityLinkedItem.CarProject.CarOEM.IdCarOEM = Convert.ToInt32(activityreader["IdCarOem"].ToString());
                                activityLinkedItem.CarProject.CarOEM.Name = activityreader["Caroem"].ToString();
                            }
                            activityLinkedItem.Name = activityLinkedItem.CarProject.Name + " - " + activityLinkedItem.CarProject.CarOEM.Name;
                        }

                        if (activityreader["IdPerson"] != DBNull.Value)
                        {
                            activityLinkedItem.IdPerson = Convert.ToInt32(activityreader["IdPerson"].ToString());
                            activityLinkedItem.People = new People();
                            activityLinkedItem.People.IdPerson = Convert.ToInt32(activityreader["IdPerson"].ToString());
                            activityLinkedItem.People.Name = activityreader["FirstName"].ToString();
                            activityLinkedItem.People.Surname = activityreader["Surname"].ToString();
                            if (activityreader["IdPersonGender"] != DBNull.Value)
                            {
                                activityLinkedItem.People.IdPersonGender = Convert.ToByte(activityreader["IdPersonGender"].ToString());
                            }
                            activityLinkedItem.People.Phone = activityreader["Phone"].ToString();
                            activityLinkedItem.People.ImageText = activityreader["Image"].ToString();

                            activityLinkedItem.Name = activityLinkedItem.People.FullName;
                        }

                        if (activityreader["IdOffer"] != DBNull.Value)
                        {
                            activityLinkedItem.IdOffer = Convert.ToInt64(activityreader["IdOffer"].ToString());
                            activityLinkedItem.IdEmdepSite = Convert.ToInt32(activityreader["IdEmdepSite"].ToString());
                        }

                        if (activityreader["IdLinkedItemType"] != DBNull.Value)
                        {
                            activityLinkedItem.IdLinkedItemType = Convert.ToByte(activityreader["IdLinkedItemType"].ToString());
                            activityLinkedItem.LinkedItemType = new LookupValue();
                            activityLinkedItem.LinkedItemType.IdLookupValue = Convert.ToInt32(activityreader["IdLinkedItemType"].ToString());
                            activityLinkedItem.LinkedItemType.Value = activityreader["ItemType"].ToString();
                        }

                        if (activityreader["IdCompetitor"] != DBNull.Value)
                        {
                            activityLinkedItem.IdCompetitor = Convert.ToByte(activityreader["IdCompetitor"].ToString());
                            activityLinkedItem.Competitor = new Competitor();
                            activityLinkedItem.Competitor.IdCompetitor = Convert.ToInt32(activityreader["IdCompetitor"].ToString());
                            activityLinkedItem.Competitor.Name = activityreader["Competitor"].ToString();
                            activityLinkedItem.Name = activityreader["Competitor"].ToString();
                        }



                        activityLinkedItems.Add(activityLinkedItem);
                    }
                }
            }

            return activityLinkedItems;
        }

        public List<Activity> GetActivitiesByIdPermission(string idOwner, Int32 idPermission, string idPlant, string mainconnectionstring)
        {
            List<Activity> listactivity = new List<Activity>();

            using (MySqlConnection congetactivities = new MySqlConnection(mainconnectionstring))
            {
                congetactivities.Open();
                MySqlCommand congetactivitiescommand = new MySqlCommand("activities_GetactivitiesByIdPermission", congetactivities);
                congetactivitiescommand.CommandType = CommandType.StoredProcedure;
                congetactivitiescommand.Parameters.AddWithValue("_IdOwner", idOwner);
                congetactivitiescommand.Parameters.AddWithValue("_IdPermission", idPermission);
                congetactivitiescommand.Parameters.AddWithValue("_IdPlant", idPlant);

                using (MySqlDataReader activityreader = congetactivitiescommand.ExecuteReader())
                {
                    while (activityreader.Read())
                    {
                        Activity activity = new Activity();
                        try
                        {
                            activity.IdActivity = Convert.ToInt64(activityreader["IdActivity"].ToString());

                            activity.Subject = activityreader["Subject"].ToString();

                            if (activityreader["IdActivityType"] != DBNull.Value)
                            {
                                activity.LookupValue = new LookupValue();
                                activity.LookupValue.IdLookupValue = Convert.ToInt32(activityreader["IdActivityType"].ToString());
                                activity.LookupValue.Value = activityreader["ActivityType"].ToString();
                                activity.LookupValue.HtmlColor = activityreader["ActivityTypeHtmlColor"].ToString();

                                //if (activityreader["ActivityTypeImage"] != DBNull.Value)
                                //    activity.LookupValue.IdImage = Convert.ToInt64(activityreader["ActivityTypeImage"].ToString());
                                //if (activityreader["ActivityTypePosition"] != DBNull.Value)
                                //    activity.LookupValue.Position = Convert.ToInt32(activityreader["ActivityTypePosition"].ToString());
                            }

                            if (activityreader["FromDate"] != DBNull.Value)
                                activity.FromDate = Convert.ToDateTime(activityreader["FromDate"].ToString());

                            if (activityreader["ToDate"] != DBNull.Value)
                                activity.ToDate = Convert.ToDateTime(activityreader["ToDate"].ToString());

                            //activity.Location = activityreader["Location"].ToString();

                            if (activityreader["IdOwner"] != DBNull.Value)
                                activity.IdOwner = Convert.ToInt32(activityreader["IdOwner"].ToString());

                            //if (activityreader["IdPerson"] != DBNull.Value)
                            //{
                            //    activity.People = new People();

                            //    activity.People.Name = activityreader["Name"].ToString();
                            //    activity.People.Surname = activityreader["Surname"].ToString();
                            //}

                            //if (activityreader["Latitude"] != DBNull.Value)
                            //    activity.Latitude = Convert.ToDouble(activityreader["Latitude"].ToString());
                            //if (activityreader["Longitude"] != DBNull.Value)
                            //    activity.Longitude = Convert.ToDouble(activityreader["Longitude"].ToString());

                            //if (activityreader["IsCompleted"] != DBNull.Value)
                            //{
                            //    activity.IsCompleted = Convert.ToByte(activityreader["IsCompleted"].ToString());

                            //    //close filled when completing some activity.
                            //    if (activity.IsCompleted == 1)
                            //    {
                            //        activity.ActivityGridStatus = "Completed";

                            //        if (activityreader["CloseDate"] != DBNull.Value)
                            //            activity.CloseDate = Convert.ToDateTime(activityreader["CloseDate"].ToString());
                            //    }
                            //}

                            //if (activityreader["IdActivityStatus"] != DBNull.Value)
                            //{
                            //    activity.ActivityStatus = new LookupValue();
                            //    activity.ActivityStatus.IdLookupValue = Convert.ToInt32(activityreader["IdActivityStatus"].ToString());
                            //    activity.ActivityStatus.Value = activityreader["ActivityStatus"].ToString();
                            //    activity.ActivityStatus.HtmlColor = activityreader["ActivityStatusHtmlColor"].ToString();
                            //    if (activityreader["ActivityStatusImage"] != DBNull.Value)
                            //        activity.ActivityStatus.IdImage = Convert.ToInt64(activityreader["ActivityStatusImage"].ToString());
                            //    if (activityreader["ActivityStatusPosition"] != DBNull.Value)
                            //        activity.ActivityStatus.Position = Convert.ToInt32(activityreader["ActivityStatusPosition"].ToString());

                            //    if (activity.ActivityStatus.IdLookupValue == 48)
                            //    {
                            //        activity.ActivityGridStatus = "Completed";
                            //    }
                            //    else
                            //    {
                            //        activity.ActivityGridStatus = activityreader["ActivityStatus"].ToString();
                            //    }
                            //}

                            //if (activityreader["ReminderDateTime"] != DBNull.Value)
                            //    activity.ActivityReminderDateTime = Convert.ToDateTime(activityreader["ReminderDateTime"].ToString());

                            //if (activityreader["IsSentMail"] != DBNull.Value)
                            //    activity.IsSentMail = Convert.ToByte(activityreader["IsSentMail"].ToString());
                            //activity.ActivityLinkedItem = GetActivityAccountByIdActivity(activity.IdActivity, mainconnectionstring);

                            //activity.ActivityLinkedItem = new List<ActivityLinkedItem>();

                            //if (activityreader["IdActivityLinkedItem"] != DBNull.Value)
                            //{
                            //    ActivityLinkedItem ali = new ActivityLinkedItem();
                            //    ali.IdActivity = activity.IdActivity;

                            //    ali.IdActivityLinkedItem = Convert.ToInt64(activityreader["IdActivityLinkedItem"]);

                            //    //42 - Account
                            //    if (activityreader["IdLinkedItemType"] != DBNull.Value)
                            //        ali.IdLinkedItemType = Convert.ToInt32(activityreader["IdLinkedItemType"]);

                            //    if (activityreader["IdSite"] != DBNull.Value)
                            //        ali.IdSite = Convert.ToInt32(activityreader["IdSite"]);

                            //    activity.ActivityLinkedItem.Add(ali);
                            //}

                            listactivity.Add(activity);
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }

                    }
                }
            }

            return listactivity;
        }


        public Activity GetPlannedAndActualActivity(Int32 idOwner, string connectionString)
        {
            Activity activity = new Activity();
            DataSet ds = new DataSet();
            using (MySqlConnection conSalesUser = new MySqlConnection(connectionString))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("Activity_GetPlannedAndActual", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_IdOwner", idOwner);
                MySqlDataAdapter da = new MySqlDataAdapter(conSalesUsercommand);
                da.Fill(ds);
            }
            foreach (DataRow itemRow in ds.Tables[0].Rows)
            {
                if (itemRow["PlannedAppoinment"] != DBNull.Value)
                    activity.PlannedAppointment = Convert.ToInt64(itemRow["PlannedAppoinment"].ToString());
            }

            foreach (DataRow itemRow in ds.Tables[1].Rows)
            {
                if (itemRow["ActualAppoinment"] != DBNull.Value)
                    activity.ActualAppointment = Convert.ToInt64(itemRow["ActualAppoinment"].ToString());
            }

            return activity;
        }

        public Activity GetPlannedAndActualActivity(Int32 idOwner, string connectionString, DateTime accountingYearFrom, DateTime accountingYearTo)
        {
            Activity activity = new Activity();
            DataSet ds = new DataSet();
            using (MySqlConnection conSalesUser = new MySqlConnection(connectionString))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("Activity_GetPlannedAndActualDatewise", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_IdOwner", idOwner);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                MySqlDataAdapter da = new MySqlDataAdapter(conSalesUsercommand);
                da.Fill(ds);
            }
            foreach (DataRow itemRow in ds.Tables[0].Rows)
            {
                if (itemRow["PlannedAppoinment"] != DBNull.Value)
                    activity.PlannedAppointment = Convert.ToInt64(itemRow["PlannedAppoinment"].ToString());
            }

            foreach (DataRow itemRow in ds.Tables[1].Rows)
            {
                if (itemRow["ActualAppoinment"] != DBNull.Value)
                    activity.ActualAppointment = Convert.ToInt64(itemRow["ActualAppoinment"].ToString());
            }

            return activity;
        }

        public void AddActivityAttachment(Activity activity, List<ActivityAttachment> activityAttachments, string connectionstring, string activityAttachmentFilePath)
        {
            string[] files = null;
            try
            {
                if (activityAttachments != null)
                {
                    if (!string.IsNullOrEmpty(activity.GUIDString))
                    {
                        if (!Directory.Exists(activityAttachmentFilePath))
                        {
                            CreateDirectory(activityAttachmentFilePath);
                        }

                        if (!Directory.Exists(activityAttachmentFilePath + @"\" + activity.IdActivity))
                        {
                            CreateDirectory(activityAttachmentFilePath + @"\" + activity.IdActivity);
                        }

                        ZipFile.ExtractToDirectory(activityAttachmentFilePath + @"\_tmp\" + activity.GUIDString.ToString() + ".Zip", activityAttachmentFilePath + @"\_tmp\" + activity.GUIDString.ToString());
                        //Delete Zip Folder
                        File.Delete(activityAttachmentFilePath + @"\_tmp\" + activity.GUIDString.ToString() + ".Zip");
                        //Get all files in Extract folder in _tmp
                        files = Directory.GetFiles(activityAttachmentFilePath + @"\_tmp\" + activity.GUIDString.ToString());
                    }

                    foreach (ActivityAttachment activityAttachment in activityAttachments)
                    {
                        activityAttachment.IdActivity = activity.IdActivity;
                        if (Convert.ToBoolean(activityAttachment.IsDeleted))
                        {
                            using (MySqlConnection connAttachment = new MySqlConnection(connectionstring))
                            {
                                connAttachment.Open();
                                //using (MySqlTransaction trans = connAttachment.BeginTransaction())
                                //{
                                try
                                {
                                    MySqlCommand attachmentUpdateCommand = new MySqlCommand("activityAttachment_Update", connAttachment);
                                    attachmentUpdateCommand.CommandType = CommandType.StoredProcedure;
                                    attachmentUpdateCommand.Parameters.AddWithValue("_IdActivityAttachment", activityAttachment.IdActivityAttachment);
                                    attachmentUpdateCommand.Parameters.AddWithValue("_OriginalFileName", activityAttachment.OriginalFileName);
                                    attachmentUpdateCommand.Parameters.AddWithValue("_SavedFileName", activityAttachment.SavedFileName);
                                    attachmentUpdateCommand.Parameters.AddWithValue("_UploadedIn", DateTime.Now);
                                    attachmentUpdateCommand.Parameters.AddWithValue("_FileType", activityAttachment.FileType);
                                    attachmentUpdateCommand.Parameters.AddWithValue("_FileSize", activityAttachment.FileSize);
                                    attachmentUpdateCommand.Parameters.AddWithValue("_IsDeleted", activityAttachment.IsDeleted);
                                    attachmentUpdateCommand.Parameters.AddWithValue("_IdActivity", activityAttachment.IdActivity);

                                    //concompanycommand.Transaction = trans;
                                    attachmentUpdateCommand.ExecuteNonQuery();

                                    if (File.Exists(activityAttachmentFilePath + @"\" + activityAttachment.IdActivity + @"\" + activityAttachment.FileUploadName))
                                    {
                                        File.Delete(activityAttachmentFilePath + @"\" + activityAttachment.IdActivity + @"\" + activityAttachment.FileUploadName);
                                    }

                                    //trans.Commit();
                                    connAttachment.Close();
                                }
                                catch (Exception ex)
                                {
                                    //trans.Rollback();
                                    throw;
                                }
                                //}
                            }
                        }
                        else
                        {
                            using (MySqlConnection connAttachment = new MySqlConnection(connectionstring))
                            {
                                connAttachment.Open();
                                //using (MySqlTransaction trans = concompany.BeginTransaction())
                                //{
                                try
                                {
                                    MySqlCommand attachmentInsertCommand = new MySqlCommand("activityAttachment_Insert", connAttachment);
                                    attachmentInsertCommand.CommandType = CommandType.StoredProcedure;
                                    attachmentInsertCommand.Parameters.AddWithValue("_OriginalFileName", activityAttachment.OriginalFileName);
                                    attachmentInsertCommand.Parameters.AddWithValue("_SavedFileName", activityAttachment.SavedFileName);
                                    attachmentInsertCommand.Parameters.AddWithValue("_UploadedIn", DateTime.Now);
                                    attachmentInsertCommand.Parameters.AddWithValue("_FileType", activityAttachment.FileType);
                                    attachmentInsertCommand.Parameters.AddWithValue("_FileSize", activityAttachment.FileSize);
                                    attachmentInsertCommand.Parameters.AddWithValue("_IsDeleted", activityAttachment.IsDeleted);
                                    attachmentInsertCommand.Parameters.AddWithValue("_IdActivity", activityAttachment.IdActivity);

                                    //attachmentInsertCommand.Transaction = trans;
                                    activityAttachment.IdActivityAttachment = Convert.ToInt32(attachmentInsertCommand.ExecuteScalar());

                                    foreach (string file in files)
                                    {
                                        if (activityAttachment.FileUploadName == Path.GetFileName(file))
                                        {
                                            System.IO.File.Copy(file, activityAttachmentFilePath + @"\" + activityAttachment.IdActivity + @"\" + activityAttachment.FileUploadName, true);
                                            File.Delete(file);

                                            break;
                                        }
                                    }

                                    //trans.Commit();
                                    connAttachment.Close();
                                }
                                catch (Exception ex)
                                {
                                    //trans.Rollback();
                                    throw;
                                }
                                //}
                            }
                        }
                    }

                    if (!string.IsNullOrEmpty(activity.GUIDString))
                    {
                        Directory.Delete(activityAttachmentFilePath + @"\_tmp\" + activity.GUIDString.ToString());
                    }
                }
            }
            catch (Exception)
            {
                throw;
            }
        }


        //public List<ActivityAttachment> UploadActivityAttachment(List<ActivityAttachment> activityAttachments, string filepath)
        //{
        //    if (activityAttachments != null)
        //    {
        //        foreach (ActivityAttachment activityAttachment in activityAttachments)
        //        {
        //            FileStream fileStream = null;
        //            string fileUploadPath = filepath + @"\" + activityAttachment.IdActivity + @"\" + activityAttachment.FileUploadName;

        //            if(!Directory.Exists(filepath))
        //            {
        //                CreateDirectory(filepath);
        //            }

        //            if (!Directory.Exists(filepath + @"\" + activityAttachment.IdActivity))
        //            {
        //                CreateDirectory(filepath + @"\" + activityAttachment.IdActivity);
        //            }

        //            if (Convert.ToBoolean(activityAttachment.IsDeleted))
        //            {
        //                if (File.Exists(fileUploadPath))
        //                {
        //                    File.Delete(fileUploadPath);
        //                    activityAttachment.IsUploaded = false;
        //                }
        //            }
        //            else
        //            {
        //                try
        //                {
        //                    if (!File.Exists(fileUploadPath))
        //                    {
        //                        if (activityAttachment.FileByte.Length > 0 && activityAttachment.FileByte != null)
        //                        {
        //                            if (!string.IsNullOrEmpty(fileUploadPath))
        //                            {
        //                                fileStream = new FileStream(fileUploadPath, FileMode.OpenOrCreate, FileAccess.ReadWrite);
        //                                // write file stream into the specified file  
        //                                using (System.IO.FileStream fs = fileStream)
        //                                {
        //                                    fs.Write(activityAttachment.FileByte, 0, activityAttachment.FileByte.Length);
        //                                }
        //                                activityAttachment.IsUploaded = true;
        //                            }
        //                        }
        //                    }
        //                }
        //                catch (FileNotFoundException ex)
        //                {
        //                    throw;
        //                }
        //                catch (DirectoryNotFoundException ex)
        //                {
        //                    throw;
        //                }
        //                catch (Exception ex)
        //                {
        //                    throw;
        //                }
        //            }
        //        }
        //    }
        //    return activityAttachments;
        //}

        public ActivityAttachment DownloadActivityAttachment(ActivityAttachment activityAttachment, string filepath)
        {
            if (activityAttachment != null)
            {
                byte[] bytes = null;
                FileStream fileStream = null;
                string fileUploadPath = filepath + @"\" + activityAttachment.IdActivity + @"\" + activityAttachment.FileUploadName;
                try
                {
                    using (System.IO.FileStream stream = new System.IO.FileStream(fileUploadPath, System.IO.FileMode.Open, System.IO.FileAccess.Read))
                    {
                        bytes = new byte[stream.Length];
                        int numBytesToRead = (int)stream.Length;
                        int numBytesRead = 0;
                        while (numBytesToRead > 0)
                        {
                            // Read may return anything from 0 to numBytesToRead.
                            int n = stream.Read(bytes, numBytesRead, numBytesToRead);

                            // Break when the end of the file is reached.
                            if (n == 0)
                                break;

                            numBytesRead += n;
                            numBytesToRead -= n;
                        }
                    }
                    activityAttachment.FileByte = bytes;

                }
                catch (FileNotFoundException ex)
                {
                    throw;
                }
                catch (DirectoryNotFoundException ex)
                {
                    throw;
                }
                catch (Exception ex)
                {
                    throw;
                }

            }
            return activityAttachment;
        }

        public List<UserManagerDtl> GetSalesUserByPlant(string idPlants, string connectionString)
        {
            List<UserManagerDtl> userManagers = new List<UserManagerDtl>();
            DataSet ds = new DataSet();
            using (MySqlConnection conSalesUser = new MySqlConnection(connectionString))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("salesusers_GetSalesUserByPlant", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_idPlant", idPlants);
                MySqlDataAdapter da = new MySqlDataAdapter(conSalesUsercommand);
                da.Fill(ds);
            }

            foreach (DataRow itemRow in ds.Tables[0].Rows)
            {
                //People people = new People();
                //if (itemRow["IdPerson"] != DBNull.Value)
                //    people.IdPerson = Convert.ToInt32(itemRow["IdPerson"].ToString());

                //people.Name = itemRow["Name"].ToString();
                //people.Surname = itemRow["Surname"].ToString();

                //if (itemRow["IdPersonGender"] != DBNull.Value)
                //    people.IdPersonGender = Convert.ToByte(itemRow["IdPersonGender"].ToString());

                UserManagerDtl userManagerDtl = new UserManagerDtl();
                if (itemRow["IdPerson"] != DBNull.Value)
                {
                    userManagerDtl.IdUser = Convert.ToInt32(itemRow["IdPerson"].ToString());
                    userManagerDtl.User = new User { IdUser = Convert.ToInt32(itemRow["IdPerson"].ToString()), FirstName = itemRow["Name"].ToString(), LastName = itemRow["Surname"].ToString(), CompanyEmail = itemRow["Email"].ToString() };
                }
                userManagers.Add(userManagerDtl);

                //peoples.Add(userManagerDtl);
            }

            return userManagers;
        }

        public List<Activity> GetActivityReportDetails(string idSalesOwner, DateTime fromDate, DateTime toDate, string idSite, string connectionString)
        {
            List<Activity> activities = new List<Activity>();
            DataSet ds = new DataSet();
            using (MySqlConnection conSalesUser = new MySqlConnection(connectionString))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("GetActivityReportDetails", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_idSalesOwner", idSalesOwner);
                conSalesUsercommand.Parameters.AddWithValue("_fromDate", fromDate);
                conSalesUsercommand.Parameters.AddWithValue("_toDate", toDate);
                conSalesUsercommand.Parameters.AddWithValue("_idSite", idSite);
                MySqlDataAdapter da = new MySqlDataAdapter(conSalesUsercommand);
                da.Fill(ds);
            }
            foreach (DataRow itemRow in ds.Tables[0].Rows)
            {
                Activity activity = new Activity();
                if (itemRow["IdActivity"] != DBNull.Value)
                    activity.IdActivity = Convert.ToInt64(itemRow["IdActivity"].ToString());
                if (itemRow["IdActivityType"] != DBNull.Value)
                {
                    activity.IdActivityType = Convert.ToInt32(itemRow["IdActivityType"].ToString());
                    activity.LookupValue = new LookupValue();
                    activity.LookupValue.IdLookupValue = Convert.ToInt32(itemRow["IdActivityType"].ToString());
                    activity.LookupValue.Value = itemRow["Value"].ToString();
                    activity.LookupValue.HtmlColor = itemRow["HtmlColor"].ToString();
                    if (itemRow["IdImage"] != DBNull.Value)
                        activity.LookupValue.IdImage = Convert.ToInt64(itemRow["IdImage"].ToString());
                    if (itemRow["Position"] != DBNull.Value)
                        activity.LookupValue.Position = Convert.ToInt32(itemRow["Position"].ToString());

                }

                activity.Subject = itemRow["Subject"].ToString();
                activity.Description = itemRow["Description"].ToString();
                if (itemRow["FromDate"] != DBNull.Value)
                    activity.FromDate = Convert.ToDateTime(itemRow["FromDate"].ToString());
                if (itemRow["ToDate"] != DBNull.Value)
                    activity.ToDate = Convert.ToDateTime(itemRow["ToDate"].ToString());
                if (itemRow["IdOwner"] != DBNull.Value)
                    activity.IdOwner = Convert.ToInt32(itemRow["IdOwner"].ToString());
                if (itemRow["IdActivityStatus"] != DBNull.Value)
                {
                    activity.IdActivityStatus = Convert.ToInt32(itemRow["IdActivityStatus"].ToString());
                    activity.ActivityStatus = new LookupValue();
                    activity.ActivityStatus.IdLookupValue = Convert.ToInt32(itemRow["IdActivityStatus"].ToString());
                    activity.ActivityStatus.Value = itemRow["ActivityStatus"].ToString();
                    activity.ActivityStatus.HtmlColor = itemRow["ActivityStatusHtmlColor"].ToString();
                    if (itemRow["ActivityStatusIdImage"] != DBNull.Value)
                        activity.ActivityStatus.IdImage = Convert.ToInt64(itemRow["ActivityStatusIdImage"].ToString());
                    if (itemRow["ActivityStatusPosition"] != DBNull.Value)
                        activity.ActivityStatus.Position = Convert.ToInt32(itemRow["ActivityStatusPosition"].ToString());
                }

                if (itemRow["IsCompleted"] != DBNull.Value)
                    activity.IsCompleted = Convert.ToByte(itemRow["IsCompleted"].ToString());
                activity.ReportGroup = itemRow["ReportGroup"].ToString();

                activities.Add(activity);
            }

            return activities;
        }

        public List<Offer> GetOfferReportDetails(string idSalesOwner, DateTime fromDate, DateTime toDate, string idbusinessUnit, string idSite, byte idCurrency, Company company)
        {
            List<Offer> offers = new List<Offer>();
            DataSet ds = new DataSet();
            using (MySqlConnection conSalesUser = new MySqlConnection(company.ConnectPlantConstr))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("GetOfferReportDetails", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_idSalesOwner", idSalesOwner);
                conSalesUsercommand.Parameters.AddWithValue("_fromDate", fromDate);
                conSalesUsercommand.Parameters.AddWithValue("_toDate", toDate);
                conSalesUsercommand.Parameters.AddWithValue("_idbusinessUnit", idbusinessUnit);
                conSalesUsercommand.Parameters.AddWithValue("_idSite", idSite);
                conSalesUsercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                MySqlDataAdapter da = new MySqlDataAdapter(conSalesUsercommand);
                da.Fill(ds);
            }
            foreach (DataRow itemRow in ds.Tables[0].Rows)
            {
                Offer offer = new Offer();
                if (itemRow["IdOffer"] != DBNull.Value)
                    offer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());

                offer.Code = itemRow["Code"].ToString();
                offer.Title = itemRow["OfferTitle"].ToString();
                offer.Description = itemRow["OfferTitle"].ToString();

                if (itemRow["IdSite"] != DBNull.Value)
                {
                    offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };
                    offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };
                }
                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                if (itemRow["PoReceptionDate"] != DBNull.Value)
                    offer.DeliveryDate = Convert.ToDateTime(itemRow["PoReceptionDate"].ToString());
                else
                    offer.DeliveryDate = null;

                if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                    offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());
                offer.ReportGroup = itemRow["ReportGroup"].ToString();
                offers.Add(offer);
            }

            foreach (DataRow itemRow in ds.Tables[1].Rows)
            {
                Offer offer = new Offer();
                if (itemRow["IdOffer"] != DBNull.Value)
                    offer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());

                offer.Code = itemRow["Code"].ToString();
                offer.Title = itemRow["OfferTitle"].ToString();
                offer.Description = itemRow["OfferTitle"].ToString();
                offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };
                offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };
                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                    offer.DeliveryDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString());
                else
                    offer.DeliveryDate = null;

                if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                    offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());
                offer.ReportGroup = itemRow["ReportGroup"].ToString();
                offers.Add(offer);
            }

            foreach (DataRow itemRow in ds.Tables[2].Rows)
            {
                Offer offer = new Offer();
                if (itemRow["IdOffer"] != DBNull.Value)
                    offer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());

                offer.Code = itemRow["Code"].ToString();
                offer.Title = itemRow["OfferTitle"].ToString();
                offer.Description = itemRow["OfferTitle"].ToString();
                offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };
                offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };
                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                    offer.DeliveryDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString());
                else
                    offer.DeliveryDate = null;

                if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                    offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());
                offer.ReportGroup = itemRow["ReportGroup"].ToString();
                offers.Add(offer);
            }

            return offers;
        }


        public List<ActivityLinkedItem> GetActivityAccountByIdActivity(Int64 idActivity, string mainconnectionstring)
        {
            List<ActivityLinkedItem> activityLinkedItems = new List<ActivityLinkedItem>();

            using (MySqlConnection congetactivities = new MySqlConnection(mainconnectionstring))
            {
                congetactivities.Open();
                MySqlCommand congetactivitiescommand = new MySqlCommand("activityLinkedItems_GetactivityAccountByIdActivity", congetactivities);
                congetactivitiescommand.CommandType = CommandType.StoredProcedure;
                congetactivitiescommand.Parameters.AddWithValue("_IdActivity", idActivity);
                using (MySqlDataReader activityreader = congetactivitiescommand.ExecuteReader())
                {
                    while (activityreader.Read())
                    {
                        ActivityLinkedItem activityLinkedItem = new ActivityLinkedItem();
                        activityLinkedItem.IdActivity = Convert.ToInt64(activityreader["IdActivity"].ToString());
                        activityLinkedItem.IdActivityLinkedItem = Convert.ToInt64(activityreader["IdActivityLinkedItem"].ToString());
                        if (activityreader["IdCustomer"] != DBNull.Value)
                        {
                            activityLinkedItem.IdCustomer = Convert.ToInt32(activityreader["IdCustomer"].ToString());
                            activityLinkedItem.Customer = new Customer();
                            activityLinkedItem.Customer.IdCustomer = Convert.ToInt32(activityreader["IdCustomer"].ToString());
                            activityLinkedItem.Customer.CustomerName = activityreader["Group"].ToString();
                        }


                        if (activityreader["IdSite"] != DBNull.Value)
                        {
                            activityLinkedItem.IdSite = Convert.ToInt32(activityreader["IdSite"].ToString());
                            activityLinkedItem.Company = new Company();
                            activityLinkedItem.Company.IdCompany = Convert.ToInt32(activityreader["IdSite"].ToString());
                            activityLinkedItem.Company.Name = activityreader["Plant"].ToString();

                            activityLinkedItem.Company.SiteNameWithoutCountry = Convert.ToString(activityreader["PlantNameWithcountry"]);
                        }

                        if (activityreader["IdLinkedItemType"] != DBNull.Value)
                        {
                            activityLinkedItem.IdLinkedItemType = Convert.ToByte(activityreader["IdLinkedItemType"].ToString());
                            activityLinkedItem.LinkedItemType = new LookupValue();
                            activityLinkedItem.LinkedItemType.IdLookupValue = Convert.ToInt32(activityreader["IdLinkedItemType"].ToString());
                            activityLinkedItem.LinkedItemType.Value = activityreader["ItemType"].ToString();
                        }
                        activityLinkedItem.Name = activityreader["CustomerPlantName"].ToString();
                        activityLinkedItems.Add(activityLinkedItem);
                    }
                }
            }

            return activityLinkedItems;
        }


        public List<People> GetContactsByLinkedItemAccount(string idSite, string mainconnectionstring)
        {
            List<People> peoples = new List<People>();

            using (MySqlConnection congetactivities = new MySqlConnection(mainconnectionstring))
            {
                congetactivities.Open();
                MySqlCommand congetactivitiescommand = new MySqlCommand("people_GetContactsByLinkedItemAccount", congetactivities);
                congetactivitiescommand.CommandType = CommandType.StoredProcedure;
                congetactivitiescommand.Parameters.AddWithValue("_IdSite", idSite);
                using (MySqlDataReader activityreader = congetactivitiescommand.ExecuteReader())
                {
                    while (activityreader.Read())
                    {
                        People people = new People();
                        if (activityreader["IdPerson"] != DBNull.Value)
                            people.IdPerson = Convert.ToInt32(activityreader["IdPerson"].ToString());

                        if (activityreader["IdPersonType"] != DBNull.Value)
                            people.IdPersonType = Convert.ToByte(activityreader["IdPersonType"].ToString());
                        if (activityreader["IdPersonGender"] != DBNull.Value)
                            people.IdPersonGender = Convert.ToByte(activityreader["IdPersonGender"].ToString());

                        people.Email = activityreader["Email"].ToString();
                        people.Name = activityreader["Name"].ToString();
                        people.Surname = activityreader["Surname"].ToString();
                        people.Observations = activityreader["Observations"].ToString();
                        people.Phone = activityreader["Phone"].ToString();
                        people.ImageText = activityreader["Image"].ToString();

                        peoples.Add(people);
                    }
                }
            }

            return peoples;
        }


        public List<People> GetAllAttendesList(string idSite, string mainconnectionstring)
        {
            List<People> peoples = new List<People>();

            using (MySqlConnection congetactivities = new MySqlConnection(mainconnectionstring))
            {
                congetactivities.Open();
                MySqlCommand congetactivitiescommand = new MySqlCommand("people_GetAllSalesUsersANDSiteWise", congetactivities);
                congetactivitiescommand.CommandType = CommandType.StoredProcedure;
                congetactivitiescommand.Parameters.AddWithValue("_IdSite", idSite);
                using (MySqlDataReader activityreader = congetactivitiescommand.ExecuteReader())
                {
                    while (activityreader.Read())
                    {
                        People people = new People();
                        if (activityreader["IdPerson"] != DBNull.Value)
                            people.IdPerson = Convert.ToInt32(activityreader["IdPerson"].ToString());

                        if (activityreader["IdPersonType"] != DBNull.Value)
                            people.IdPersonType = Convert.ToByte(activityreader["IdPersonType"].ToString());

                        if (activityreader["IdPersonGender"] != DBNull.Value)
                            people.IdPersonGender = Convert.ToByte(activityreader["IdPersonGender"].ToString());

                        people.Email = activityreader["Email"].ToString();
                        people.Name = activityreader["Name"].ToString();
                        people.Surname = activityreader["Surname"].ToString();
                        people.Observations = activityreader["Observations"].ToString();
                        people.Phone = activityreader["Phone"].ToString();
                        people.IsStillActive = Convert.ToByte(activityreader["IsStillActive"]);

                        if (activityreader["Image"] != DBNull.Value)
                            people.ImageText = activityreader["Image"].ToString();

                        peoples.Add(people);
                    }
                }
            }

            return peoples;
        }

        public bool DeleteActivity(Activity activity, string mainconnectionstring)
        {
            bool isDeleted = false;
            try
            {
                using (MySqlConnection myConnection = new MySqlConnection(mainconnectionstring))
                {
                    myConnection.Open();
                    using (MySqlTransaction trans = myConnection.BeginTransaction())
                    {
                        try
                        {
                            MySqlCommand concompanycommand = new MySqlCommand("activities_Delete", myConnection);
                            concompanycommand.CommandType = CommandType.StoredProcedure;

                            concompanycommand.Parameters.AddWithValue("_IdActivity", activity.IdActivity);
                            concompanycommand.Parameters.AddWithValue("_IsDeleted", activity.IsDeleted);

                            concompanycommand.Transaction = trans;
                            concompanycommand.ExecuteNonQuery();

                            isDeleted = true;
                            trans.Commit();

                            if (isDeleted == true)
                            {
                                AddLogEntriesByActivity(activity.IdActivity, activity.LogEntriesByActivity, mainconnectionstring);
                            }

                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }

            return isDeleted;
        }


        public bool DeleteMultipleActivities(string MainServerConnectionString, List<Activity> activities, LogEntriesByActivity deleteLogEntry)
        {
            using (TransactionScope transactionScope = new TransactionScope())
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(MainServerConnectionString))
                {
                    try
                    {
                        mySqlConnection.Open();

                        MySqlCommand concompanycommand = new MySqlCommand("activities_Delete", mySqlConnection);
                        concompanycommand.CommandType = CommandType.StoredProcedure;

                        MySqlCommand logEntriesCommand = new MySqlCommand("logEntriesByActivity_Insert", mySqlConnection);
                        logEntriesCommand.CommandType = CommandType.StoredProcedure;

                        foreach (Activity activity in activities)
                        {
                            // Delete activity
                            concompanycommand.Parameters.Clear();
                            concompanycommand.Parameters.AddWithValue("_IdActivity", activity.IdActivity);
                            concompanycommand.Parameters.AddWithValue("_IsDeleted", 1);

                            concompanycommand.ExecuteNonQuery();

                            // Delete log entry
                            logEntriesCommand.Parameters.Clear();
                            logEntriesCommand.Parameters.AddWithValue("_IdUser", deleteLogEntry.IdUser);
                            logEntriesCommand.Parameters.AddWithValue("_IdActivity", activity.IdActivity);
                            logEntriesCommand.Parameters.AddWithValue("_IdLogEntryType", deleteLogEntry.IdLogEntryType);
                            logEntriesCommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                            logEntriesCommand.Parameters.AddWithValue("_Comments", string.Format(deleteLogEntry.Comments, activity.Subject));
                            logEntriesCommand.Parameters.AddWithValue("_IsRtfText", deleteLogEntry.IsRtfText);

                            logEntriesCommand.ExecuteNonQuery();
                        }

                        mySqlConnection.Close();

                        transactionScope.Complete();
                        transactionScope.Dispose();
                    }
                    catch (Exception)
                    {
                        if (Transaction.Current != null)
                            Transaction.Current.Rollback();

                        if (transactionScope != null)
                            transactionScope.Dispose();

                        throw;
                    }
                }
            }

            return true;
        }

        /// <summary>
        /// Sprint 18 - This method is to get list of company by plant (for role 22).
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idUser">Get Site id</param>
        /// <returns>List of company</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          companies = mgr.GetSelectedUserCustomersByPlant(string connectionstring, string idSite);
        ///          SP :-  sites_GetSelectedUserCustomersByPlant
        ///     }
        /// }
        /// </code>
        /// </example> 
        public List<Company> GetSelectedUserCustomersByPlant(string connectionstring, string idSite)
        {

            List<Company> companies = new List<Company>();
            DataTable dt = new DataTable();

            using (MySqlConnection concompany = new MySqlConnection(connectionstring))
            {
                concompany.Open();
                MySqlCommand concompanycommand = new MySqlCommand("sites_GetSelectedUserCustomersByPlant", concompany);
                concompanycommand.CommandType = CommandType.StoredProcedure;
                concompanycommand.Parameters.AddWithValue("_idSite", idSite);
                MySqlDataAdapter da = new MySqlDataAdapter(concompanycommand);
                //DataSet ds = new DataSet();
                da.Fill(dt);
            }

            foreach (DataRow companyreader in dt.Rows)
            {
                Company company = new Company();
                company.IdCompany = Convert.ToInt32(companyreader["IdSite"].ToString());
                company.Name = companyreader["CustomerPlant"].ToString();
                company.RegisteredName = companyreader["RegisteredName"].ToString();
                company.CIF = companyreader["RegistrationNumber"].ToString();
                company.IdCountry = Convert.ToByte(companyreader["idCountry"].ToString());
                company.Country = new Country { IdCountry = Convert.ToByte(companyreader["idCountry"].ToString()), Name = companyreader["Country"].ToString() };
                company.City = companyreader["City"].ToString();
                company.Address = companyreader["Address"].ToString();
                company.Telephone = companyreader["Phone"].ToString();
                company.ZipCode = companyreader["PostCode"].ToString();
                company.Fax = companyreader["Fax"].ToString();
                company.Website = companyreader["WebSite"].ToString();
                company.Email = companyreader["Email"].ToString();
                company.Region = companyreader["Region"].ToString();
                company.ShortName = companyreader["ShortName"].ToString();

                if (companyreader["IdSalesResponsible"] != DBNull.Value)
                {
                    company.IdSalesResponsible = Convert.ToInt32(companyreader["IdSalesResponsible"].ToString());
                    company.People = new People { IdPerson = Convert.ToInt32(companyreader["IdSalesResponsible"].ToString()), Name = companyreader["SalesResponsibleName"].ToString(), Surname = companyreader["SalesResponsibleSurname"].ToString() };
                }

                if (companyreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                {
                    company.IdSalesResponsibleAssemblyBU = Convert.ToInt32(companyreader["IdSalesResponsibleAssemblyBU"].ToString());
                    company.PeopleSalesResponsibleAssemblyBU = new People { IdPerson = Convert.ToInt32(companyreader["IdSalesResponsibleAssemblyBU"].ToString()), Name = companyreader["SalesResponsiblebuName"].ToString(), Surname = companyreader["SalesResponsiblebuSurname"].ToString() };
                }

                company.Country.Zone = new Zone { Name = companyreader["SalesZone"].ToString() };
                company.IdCustomer = Convert.ToInt32(companyreader["IdCustomer"].ToString());
                company.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(companyreader["IdCustomer"].ToString()), CustomerName = companyreader["CustomerGroup"].ToString() } };

                if (companyreader["Line"] != DBNull.Value)
                    company.Line = Convert.ToInt32(companyreader["Line"].ToString());

                if (companyreader["CuttingMachines"] != DBNull.Value)
                    company.CuttingMachines = Convert.ToInt32(companyreader["CuttingMachines"].ToString());

                if (companyreader["Size"] != DBNull.Value)
                    company.Size = Convert.ToDouble(companyreader["Size"].ToString());

                if (companyreader["NumberOfEmployees"] != DBNull.Value)
                    company.NumberOfEmployees = Convert.ToInt32(companyreader["NumberOfEmployees"].ToString());

                if (companyreader["IdBusinessField"] != DBNull.Value)
                {
                    company.IdBusinessField = Convert.ToByte(companyreader["IdBusinessField"].ToString());
                    company.BusinessField = new LookupValue { IdLookupValue = Convert.ToByte(companyreader["IdBusinessField"].ToString()), Value = companyreader["BusinessField"].ToString() };
                }
                if (companyreader["IdBusinessCenter"] != DBNull.Value)
                {
                    company.IdBusinessCenter = Convert.ToByte(companyreader["IdBusinessCenter"].ToString());
                    company.BusinessCenter = new LookupValue { IdLookupValue = Convert.ToByte(companyreader["IdBusinessCenter"].ToString()), Value = companyreader["BusinessCenter"].ToString() };
                }
                if (companyreader["IdBusinessType"] != DBNull.Value)
                {
                    company.IdBusinessType = Convert.ToByte(companyreader["IdBusinessType"].ToString());
                    company.BusinessType = new LookupValue { IdLookupValue = Convert.ToByte(companyreader["IdBusinessType"].ToString()), Value = companyreader["BusinessType"].ToString() };
                }
                if (companyreader["Latitude"] != DBNull.Value)
                {
                    company.Latitude = Convert.ToDouble(companyreader["Latitude"].ToString());
                    company.BothLongitudeLatitude = company.Latitude.ToString();
                }
                if (companyreader["Longitude"] != DBNull.Value)
                {
                    company.Longitude = Convert.ToDouble(companyreader["Longitude"].ToString());
                    company.BothLongitudeLatitude = company.BothLongitudeLatitude + company.Longitude.ToString();
                }
                if (companyreader["ModifiedIn"] != DBNull.Value)
                    company.ModifiedIn = Convert.ToDateTime(companyreader["ModifiedIn"].ToString());

                if (companyreader["CreatedIn"] != DBNull.Value)
                    company.CreatedIn = Convert.ToDateTime(companyreader["CreatedIn"].ToString());

                company.GroupPlantName = companyreader["GroupPlantName"].ToString();


                if (companyreader["CreatedBy"] != DBNull.Value)
                {
                    company.CreatedBy = Convert.ToInt32(companyreader["CreatedBy"].ToString());
                    company.PeopleCreatedBy = new People { IdPerson = Convert.ToInt32(companyreader["CreatedBy"].ToString()), Name = companyreader["CreatedByName"].ToString(), Surname = companyreader["CreatedBySurname"].ToString() };
                }

                company.BusinessProductList = new List<SitesByBusinessProduct>();
                List<string> bpstring = new List<string>();
                using (MySqlConnection concompanybusinessproduct = new MySqlConnection(connectionstring))
                {
                    concompanybusinessproduct.Open();
                    MySqlCommand concompanycommandbusinessproduct = new MySqlCommand("sitesbybusinessproduct_GetBusinessProduct", concompanybusinessproduct);
                    concompanycommandbusinessproduct.CommandType = CommandType.StoredProcedure;
                    concompanycommandbusinessproduct.Parameters.AddWithValue("_idCompany", company.IdCompany);

                    using (MySqlDataReader companybusinessproductreader = concompanycommandbusinessproduct.ExecuteReader())
                    {
                        while (companybusinessproductreader.Read())
                        {
                            if (companybusinessproductreader["IdBusinessProduct"] != DBNull.Value)
                            {
                                if (company.BusinessProductList.Any(bpl => bpl.IdBusinessProduct == Convert.ToInt32(companybusinessproductreader["IdBusinessProduct"].ToString())))
                                {

                                }
                                else
                                {
                                    SitesByBusinessProduct sitesByBusinessProduct = new SitesByBusinessProduct();
                                    if (companybusinessproductreader["IdSite"] != DBNull.Value)
                                        sitesByBusinessProduct.IdSite = Convert.ToInt32(companybusinessproductreader["IdSite"].ToString());
                                    if (companybusinessproductreader["IdBusinessProduct"] != DBNull.Value)
                                    {
                                        sitesByBusinessProduct.IdBusinessProduct = Convert.ToInt32(companybusinessproductreader["IdBusinessProduct"].ToString());
                                        bpstring.Add(companybusinessproductreader["Value"].ToString());
                                    }

                                    sitesByBusinessProduct.IsAdded = true;
                                    company.BusinessProductList.Add(sitesByBusinessProduct);
                                }
                            }

                        }
                    }
                }
                //company.BusinessProductString = string.Join(" , ", bpstring.ToArray()); 
                if (bpstring.Count > 0)
                    company.BusinessProductString = string.Join("\n", bpstring.ToArray());
                else
                    company.BusinessProductString = string.Empty;
                companies.Add(company);
            }
            return companies;
        }

        /// <summary>
        /// Sprint 18 - This method is to get list of people by plant for Role 22 .
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idUser">Get site id</param>
        /// <returns>List of people</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          peoples = mgr.GetSelectedUserContactsByPlant(string connectionstring, string idUser);
        ///          SP :-  people_GetSelectedUserContactsByPlant
        ///     }
        /// }
        /// </code>
        /// </example>
        public List<People> GetSelectedUserContactsByPlant(string connectionstring, string idSite)
        {
            List<People> peoples = new List<People>();

            using (MySqlConnection conPeople = new MySqlConnection(connectionstring))
            {
                conPeople.Open();
                MySqlCommand conPeoplecommand = new MySqlCommand("people_GetSelectedUserContactsByPlant", conPeople);

                conPeoplecommand.CommandType = CommandType.StoredProcedure;
                conPeoplecommand.Parameters.AddWithValue("_idSite", idSite);
                using (MySqlDataReader peoplereader = conPeoplecommand.ExecuteReader())
                {
                    while (peoplereader.Read())
                    {
                        People people = new People();
                        people.IdPerson = Convert.ToInt32(peoplereader["IdPerson"].ToString());
                        people.Name = peoplereader["FirstName"].ToString();
                        people.Surname = peoplereader["LastName"].ToString();
                        people.Phone = peoplereader["Telephone"].ToString();
                        people.Email = peoplereader["Email"].ToString();

                        if (peoplereader["IdPersonGender"] != DBNull.Value)
                        {
                            people.IdPersonGender = Convert.ToByte(peoplereader["IdPersonGender"].ToString());
                            if (people.IdPersonGender == 1)
                                people.UserGender = "Female";
                            else if (people.IdPersonGender == 2)
                                people.UserGender = "Male";
                        }

                        people.IdPersonType = Convert.ToByte(peoplereader["IdPersonType"].ToString());
                        people.PeopleType = new PeopleType();
                        people.PeopleType.IdPersonType = Convert.ToByte(peoplereader["IdPersonType"].ToString());
                        people.PeopleType.Name = Convert.ToString(peoplereader["PersonTypeName"]);

                        if (peoplereader["CreatedIn"] != DBNull.Value)
                            people.CreatedIn = Convert.ToDateTime(peoplereader["CreatedIn"].ToString());

                        people.Company = new Company() { IdCompany = Convert.ToInt32(peoplereader["IdCompany"].ToString()), Name = peoplereader["CustomerPlant"].ToString(), Country = new Country { IdCountry = Convert.ToByte(peoplereader["IdCountry"].ToString()), Name = peoplereader["Country"].ToString(), Zone = new Zone { Name = peoplereader["Zone"].ToString() } } };
                        people.Company.Address = peoplereader["SiteAddress"].ToString();
                        people.Observations = peoplereader["Observations"].ToString();
                        people.Company.City = peoplereader["SiteCity"].ToString();
                        people.Company.CIF = peoplereader["SiteCIF"].ToString();
                        people.Company.Telephone = peoplereader["SiteTelephone"].ToString();
                        people.Company.Fax = peoplereader["SiteFax"].ToString();
                        people.Company.PostCode = peoplereader["SitePostCode"].ToString();
                        people.Company.ZipCode = peoplereader["SitePostCode"].ToString();
                        people.Company.Region = peoplereader["SiteRegion"].ToString();
                        people.Company.RegisteredName = peoplereader["SiteRegisteredName"].ToString();
                        people.Company.Website = peoplereader["SiteWebsite"].ToString();
                        people.Company.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(peoplereader["IdCustomer"].ToString()), CustomerName = peoplereader["CustomerGroup"].ToString() } };

                        if (peoplereader["IdCompanyDepartment"] != DBNull.Value)
                        {
                            people.IdCompanyDepartment = Convert.ToInt32(peoplereader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment = new LookupValue();
                            people.CompanyDepartment.IdLookupValue = Convert.ToInt32(peoplereader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment.Value = peoplereader["Value"].ToString();

                            if (peoplereader["IdImage"] != DBNull.Value)
                                people.CompanyDepartment.IdImage = Convert.ToInt64(peoplereader["IdImage"].ToString());

                            //if (peoplereader["InUse"] != DBNull.Value)
                            //    people.CompanyDepartment.InUse = Convert.ToBoolean(peoplereader["InUse"].ToString());
                        }

                        people.JobTitle = peoplereader["JobTitle"].ToString();
                        people.ImageText = peoplereader["Image"].ToString();

                        if (peoplereader["IdContactInfluenceLevel"] != DBNull.Value)
                        {
                            people.IdContactInfluenceLevel = Convert.ToInt32(peoplereader["IdContactInfluenceLevel"].ToString());
                            people.InfluenceLevel = new LookupValue();
                            people.InfluenceLevel.IdLookupValue = Convert.ToInt32(peoplereader["IdContactInfluenceLevel"].ToString());
                            people.InfluenceLevel.Value = peoplereader["InfluenceLevel"].ToString();
                            people.InfluenceLevel.HtmlColor = peoplereader["InfluenceLevelHtmlcolor"].ToString();

                            if (peoplereader["InfluenceLevelIdImage"] != DBNull.Value)
                                people.InfluenceLevel.IdImage = Convert.ToInt64(peoplereader["InfluenceLevelIdImage"].ToString());

                            //if (peoplereader["InfluenceLevelInUse"] != DBNull.Value)
                            //    people.InfluenceLevel.InUse = Convert.ToBoolean(peoplereader["InfluenceLevelInUse"].ToString());
                        }

                        if (peoplereader["IdContactEmdepAffinity"] != DBNull.Value)
                        {
                            people.IdContactEmdepAffinity = Convert.ToInt32(peoplereader["IdContactEmdepAffinity"].ToString());
                            people.EmdepAffinity = new LookupValue();
                            people.EmdepAffinity.IdLookupValue = Convert.ToInt32(peoplereader["IdContactEmdepAffinity"].ToString());
                            people.EmdepAffinity.Value = peoplereader["EmdepAffinity"].ToString();
                            people.EmdepAffinity.HtmlColor = peoplereader["EmdepAffinityHtmlcolor"].ToString();

                            if (peoplereader["EmdepAffinityIdImage"] != DBNull.Value)
                                people.EmdepAffinity.IdImage = Convert.ToInt64(peoplereader["EmdepAffinityIdImage"].ToString());

                            //if (peoplereader["EmdepAffinityInUse"] != DBNull.Value)
                            //    people.EmdepAffinity.InUse = Convert.ToBoolean(peoplereader["EmdepAffinityInUse"].ToString());
                        }

                        if (peoplereader["IdContactProductInvolved"] != DBNull.Value)
                        {
                            people.IdContactProductInvolved = Convert.ToInt32(peoplereader["IdContactProductInvolved"].ToString());
                            people.ProductInvolved = new LookupValue();
                            people.ProductInvolved.IdLookupValue = Convert.ToInt32(peoplereader["IdContactProductInvolved"].ToString());
                            people.ProductInvolved.Value = peoplereader["ProductInvolved"].ToString();
                            people.ProductInvolved.HtmlColor = peoplereader["ProductInvolvedLevelHtmlcolor"].ToString();

                            if (peoplereader["ProductInvolvedLevelIdImage"] != DBNull.Value)
                                people.ProductInvolved.IdImage = Convert.ToInt64(peoplereader["ProductInvolvedLevelIdImage"].ToString());

                            //if (peoplereader["ProductInvolvedInUse"] != DBNull.Value)
                            //    people.ProductInvolved.InUse..
                        }

                        if (peoplereader["IdCompetitor"] != DBNull.Value)
                        {
                            people.IdCompetitor = Convert.ToInt32(peoplereader["IdCompetitor"].ToString());
                            people.Competitor = new Competitor();
                            people.Competitor.IdCompetitor = Convert.ToInt32(peoplereader["IdCompetitor"].ToString());
                            people.Competitor.Name = peoplereader["Competitor"].ToString();
                        }

                        peoples.Add(people);
                    }
                }
            }
            return peoples;
        }


        public List<People> GetContactsByIdPermission(string connectionstring, Int32 idActiveUser, string idUser, string idSite, Int32 idPermission)
        {
            List<People> peoples = new List<People>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("people_GetContactsByIdPermission", mySqlConnection);

                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_idActiveUser", idActiveUser);
                mySqlCommand.Parameters.AddWithValue("_idUser", idUser);
                mySqlCommand.Parameters.AddWithValue("_idSite", idSite);
                mySqlCommand.Parameters.AddWithValue("_idPermission", idPermission);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        People people = new People();
                        people.IdPerson = Convert.ToInt32(reader["IdPerson"]);
                        people.Name = Convert.ToString(reader["FirstName"]);
                        people.Surname = Convert.ToString(reader["LastName"]);
                        people.Phone = Convert.ToString(reader["Telephone"]);
                        people.Email = Convert.ToString(reader["Email"]);

                        if (reader["IdPersonGender"] != DBNull.Value)
                        {
                            people.IdPersonGender = Convert.ToByte(reader["IdPersonGender"]);
                            if (people.IdPersonGender == 1)
                                people.UserGender = "Female";
                            else if (people.IdPersonGender == 2)
                                people.UserGender = "Male";
                        }

                        people.IdPersonType = Convert.ToByte(reader["IdPersonType"].ToString());
                        people.PeopleType = new PeopleType();
                        people.PeopleType.IdPersonType = Convert.ToByte(reader["IdPersonType"].ToString());
                        people.PeopleType.Name = Convert.ToString(reader["PersonTypeName"]);

                        if (reader["CreatedIn"] != DBNull.Value)
                            people.CreatedIn = Convert.ToDateTime(reader["CreatedIn"].ToString());

                        people.Company = new Company() { IdCompany = Convert.ToInt32(reader["IdCompany"].ToString()), Name = reader["CustomerPlant"].ToString().Trim(), Country = new Country { IdCountry = Convert.ToByte(reader["IdCountry"].ToString()), Name = reader["Country"].ToString(), Zone = new Zone { Name = reader["Zone"].ToString() } } };

                        if (idPermission == 21 || idPermission == 22)
                        {
                            if (reader["IdSalesResponsible"] != DBNull.Value)
                            {
                                people.Company.IdSalesResponsible = Convert.ToInt32(reader["IdSalesResponsible"]);
                                people.Company.People = new People();
                                people.Company.People.IdPerson = (Int32)people.Company.IdSalesResponsible;

                                if (reader["SalesResponsibleFirstName"] != DBNull.Value)
                                    people.Company.People.Name = Convert.ToString(reader["SalesResponsibleFirstName"]);

                                if (reader["SalesResponsibleLastName"] != DBNull.Value)
                                    people.Company.People.Surname = Convert.ToString(reader["SalesResponsibleLastName"]);
                            }

                            if (reader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            {
                                people.Company.IdSalesResponsibleAssemblyBU = Convert.ToInt32(reader["IdSalesResponsibleAssemblyBU"]);

                                people.Company.PeopleSalesResponsibleAssemblyBU = new People();
                                people.Company.PeopleSalesResponsibleAssemblyBU.IdPerson = (Int32)people.Company.IdSalesResponsibleAssemblyBU;

                                if (reader["SalesResponsibleBUFirstName"] != DBNull.Value)
                                    people.Company.PeopleSalesResponsibleAssemblyBU.Name = Convert.ToString(reader["SalesResponsibleBUFirstName"]);

                                if (reader["SalesResponsibleBULastName"] != DBNull.Value)
                                    people.Company.PeopleSalesResponsibleAssemblyBU.Surname = Convert.ToString(reader["SalesResponsibleBULastName"]);
                            }
                        }

                        people.Company.Address = Convert.ToString(reader["SiteAddress"]);
                        people.Observations = Convert.ToString(reader["Observations"]);
                        people.Company.City = Convert.ToString(reader["SiteCity"]);
                        people.Company.CIF = Convert.ToString(reader["SiteCIF"]);
                        people.Company.Telephone = Convert.ToString(reader["SiteTelephone"]);
                        people.Company.Fax = Convert.ToString(reader["SiteFax"]);
                        people.Company.PostCode = Convert.ToString(reader["SitePostCode"]);
                        people.Company.ZipCode = Convert.ToString(reader["SitePostCode"]);
                        people.Company.Region = Convert.ToString(reader["SiteRegion"]);
                        people.Company.RegisteredName = Convert.ToString(reader["SiteRegisteredName"]);
                        people.Company.Website = Convert.ToString(reader["SiteWebsite"]);
                        people.Company.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(reader["IdCustomer"].ToString()), CustomerName = reader["CustomerGroup"].ToString() } };

                        if (reader["IdCompanyDepartment"] != DBNull.Value)
                        {
                            people.IdCompanyDepartment = Convert.ToInt32(reader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment = new LookupValue();
                            people.CompanyDepartment.IdLookupValue = Convert.ToInt32(reader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment.Value = reader["Value"].ToString();

                            if (reader["IdImage"] != DBNull.Value)
                                people.CompanyDepartment.IdImage = Convert.ToInt64(reader["IdImage"].ToString());

                            //if (peoplereader["InUse"] != DBNull.Value)
                            //    people.CompanyDepartment.InUse = Convert.ToBoolean(peoplereader["InUse"].ToString());
                        }

                        people.JobTitle = reader["JobTitle"].ToString();
                        people.ImageText = reader["Image"].ToString();

                        if (reader["IdContactInfluenceLevel"] != DBNull.Value)
                        {
                            people.IdContactInfluenceLevel = Convert.ToInt32(reader["IdContactInfluenceLevel"].ToString());
                            people.InfluenceLevel = new LookupValue();
                            people.InfluenceLevel.IdLookupValue = Convert.ToInt32(reader["IdContactInfluenceLevel"].ToString());
                            people.InfluenceLevel.Value = reader["InfluenceLevel"].ToString();
                            people.InfluenceLevel.HtmlColor = reader["InfluenceLevelHtmlcolor"].ToString();

                            if (reader["InfluenceLevelIdImage"] != DBNull.Value)
                                people.InfluenceLevel.IdImage = Convert.ToInt64(reader["InfluenceLevelIdImage"].ToString());

                            //if (peoplereader["InfluenceLevelInUse"] != DBNull.Value)
                            //    people.InfluenceLevel.InUse = Convert.ToBoolean(peoplereader["InfluenceLevelInUse"].ToString());
                        }

                        if (reader["IdContactEmdepAffinity"] != DBNull.Value)
                        {
                            people.IdContactEmdepAffinity = Convert.ToInt32(reader["IdContactEmdepAffinity"].ToString());
                            people.EmdepAffinity = new LookupValue();
                            people.EmdepAffinity.IdLookupValue = Convert.ToInt32(reader["IdContactEmdepAffinity"].ToString());
                            people.EmdepAffinity.Value = reader["EmdepAffinity"].ToString();
                            people.EmdepAffinity.HtmlColor = reader["EmdepAffinityHtmlcolor"].ToString();

                            if (reader["EmdepAffinityIdImage"] != DBNull.Value)
                                people.EmdepAffinity.IdImage = Convert.ToInt64(reader["EmdepAffinityIdImage"].ToString());

                            //if (peoplereader["EmdepAffinityInUse"] != DBNull.Value)
                            //    people.EmdepAffinity.InUse = Convert.ToBoolean(peoplereader["EmdepAffinityInUse"].ToString());
                        }

                        if (reader["IdContactProductInvolved"] != DBNull.Value)
                        {
                            people.IdContactProductInvolved = Convert.ToInt32(reader["IdContactProductInvolved"].ToString());
                            people.ProductInvolved = new LookupValue();
                            people.ProductInvolved.IdLookupValue = Convert.ToInt32(reader["IdContactProductInvolved"].ToString());
                            people.ProductInvolved.Value = reader["ProductInvolved"].ToString();
                            people.ProductInvolved.HtmlColor = reader["ProductInvolvedLevelHtmlcolor"].ToString();

                            if (reader["ProductInvolvedLevelIdImage"] != DBNull.Value)
                                people.ProductInvolved.IdImage = Convert.ToInt64(reader["ProductInvolvedLevelIdImage"].ToString());

                            //if (peoplereader["ProductInvolvedInUse"] != DBNull.Value)
                            //    people.ProductInvolved.InUse..
                        }

                        if (reader["IdCompetitor"] != DBNull.Value)
                        {
                            people.IdCompetitor = Convert.ToInt32(reader["IdCompetitor"].ToString());
                            people.Competitor = new Competitor();
                            people.Competitor.IdCompetitor = Convert.ToInt32(reader["IdCompetitor"].ToString());
                            people.Competitor.Name = reader["Competitor"].ToString();
                        }

                        peoples.Add(people);
                    }
                }
            }
            return peoples;
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="idOwner"></param>
        /// <param name="mainconnectionstring"></param>
        /// <returns></returns>
        public List<Activity> GetActivitiesByIdSite(Int32 idSite, string mainconnectionstring)
        {
            List<Activity> listActivity = new List<Activity>();

            using (MySqlConnection congetactivities = new MySqlConnection(mainconnectionstring))
            {
                congetactivities.Open();
                MySqlCommand congetactivitiescommand = new MySqlCommand("activities_GetactivitiesByIdSite", congetactivities);
                congetactivitiescommand.CommandType = CommandType.StoredProcedure;
                congetactivitiescommand.Parameters.AddWithValue("_IdSite", idSite);
                using (MySqlDataReader activityreader = congetactivitiescommand.ExecuteReader())
                {
                    while (activityreader.Read())
                    {
                        Activity activity = new Activity();
                        activity.IdActivity = Convert.ToInt64(activityreader["IdActivity"].ToString());
                        activity.Subject = activityreader["Subject"].ToString();
                        activity.Description = activityreader["Description"].ToString();

                        if (activityreader["IdActivityType"] != DBNull.Value)
                        {
                            activity.LookupValue = new LookupValue();
                            activity.LookupValue.IdLookupValue = Convert.ToInt32(activityreader["IdActivityType"].ToString());
                            activity.LookupValue.Value = activityreader["ActivityType"].ToString();
                            activity.LookupValue.HtmlColor = activityreader["ActivityTypeHtmlColor"].ToString();
                            if (activityreader["ActivityTypeImage"] != DBNull.Value)
                                activity.LookupValue.IdImage = Convert.ToInt64(activityreader["ActivityTypeImage"].ToString());
                            if (activityreader["ActivityTypePosition"] != DBNull.Value)
                                activity.LookupValue.Position = Convert.ToInt32(activityreader["ActivityTypePosition"].ToString());
                        }

                        if (activityreader["FromDate"] != DBNull.Value)
                            activity.FromDate = Convert.ToDateTime(activityreader["FromDate"].ToString());

                        if (activityreader["ToDate"] != DBNull.Value)
                            activity.ToDate = Convert.ToDateTime(activityreader["ToDate"].ToString());

                        if (activityreader["CloseDate"] != DBNull.Value)
                            activity.CloseDate = Convert.ToDateTime(activityreader["CloseDate"].ToString());

                        activity.Location = activityreader["Location"].ToString();

                        if (activityreader["IdOwner"] != DBNull.Value)
                            activity.IdOwner = Convert.ToInt32(activityreader["IdOwner"].ToString());

                        if (activityreader["IdOwner"] != DBNull.Value)
                        {
                            activity.People = new People();
                            activity.People.Name = activityreader["Name"].ToString();
                            activity.People.Surname = activityreader["Surname"].ToString();
                        }

                        if (activityreader["Latitude"] != DBNull.Value)
                            activity.Latitude = Convert.ToDouble(activityreader["Latitude"].ToString());
                        if (activityreader["Longitude"] != DBNull.Value)
                            activity.Longitude = Convert.ToDouble(activityreader["Longitude"].ToString());
                        if (activityreader["IsCompleted"] != DBNull.Value)
                        {
                            activity.IsCompleted = Convert.ToByte(activityreader["IsCompleted"].ToString());

                            //close filled when completing some activity.
                            if (activity.IsCompleted == 1)
                            {
                                activity.ActivityGridStatus = "Completed";

                                if (activityreader["CloseDate"] != DBNull.Value)
                                    activity.CloseDate = Convert.ToDateTime(activityreader["CloseDate"].ToString());
                            }
                        }

                        if (activityreader["IdActivityStatus"] != DBNull.Value)
                        {
                            activity.ActivityStatus = new LookupValue();
                            activity.ActivityStatus.IdLookupValue = Convert.ToInt32(activityreader["IdActivityStatus"].ToString());
                            activity.ActivityStatus.Value = activityreader["ActivityStatus"].ToString();
                            activity.ActivityStatus.HtmlColor = activityreader["ActivityStatusHtmlColor"].ToString();

                            if (activityreader["ActivityStatusImage"] != DBNull.Value)
                                activity.ActivityStatus.IdImage = Convert.ToInt64(activityreader["ActivityStatusImage"].ToString());

                            if (activityreader["ActivityStatusPosition"] != DBNull.Value)
                                activity.ActivityStatus.Position = Convert.ToInt32(activityreader["ActivityStatusPosition"].ToString());

                            if (activity.ActivityStatus.IdLookupValue == 48)
                            {
                                activity.ActivityGridStatus = "Completed";
                            }
                            else
                            {
                                activity.ActivityGridStatus = activityreader["ActivityStatus"].ToString();
                            }
                        }
                        listActivity.Add(activity);
                    }
                }
            }

            return listActivity;
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="idOwner"></param>
        /// <param name="mainconnectionstring"></param>
        /// <returns></returns>
        public List<Activity> GetActivitiesByIdContact(Int32 idContact, string mainconnectionstring)
        {
            List<Activity> listActivity = new List<Activity>();

            using (MySqlConnection congetactivities = new MySqlConnection(mainconnectionstring))
            {
                congetactivities.Open();
                MySqlCommand congetactivitiescommand = new MySqlCommand("activities_GetactivitiesByIdPerson", congetactivities);
                congetactivitiescommand.CommandType = CommandType.StoredProcedure;
                congetactivitiescommand.Parameters.AddWithValue("_IdPerson", idContact);
                using (MySqlDataReader activityreader = congetactivitiescommand.ExecuteReader())
                {
                    while (activityreader.Read())
                    {
                        Activity activity = new Activity();
                        activity.IdActivity = Convert.ToInt64(activityreader["IdActivity"].ToString());
                        activity.Subject = activityreader["Subject"].ToString();
                        activity.Description = activityreader["Description"].ToString();

                        if (activityreader["IdActivityType"] != DBNull.Value)
                        {
                            activity.LookupValue = new LookupValue();
                            activity.LookupValue.IdLookupValue = Convert.ToInt32(activityreader["IdActivityType"].ToString());
                            activity.LookupValue.Value = activityreader["ActivityType"].ToString();
                            activity.LookupValue.HtmlColor = activityreader["ActivityTypeHtmlColor"].ToString();
                            if (activityreader["ActivityTypeImage"] != DBNull.Value)
                                activity.LookupValue.IdImage = Convert.ToInt64(activityreader["ActivityTypeImage"].ToString());
                            if (activityreader["ActivityTypePosition"] != DBNull.Value)
                                activity.LookupValue.Position = Convert.ToInt32(activityreader["ActivityTypePosition"].ToString());
                        }

                        if (activityreader["FromDate"] != DBNull.Value)
                            activity.FromDate = Convert.ToDateTime(activityreader["FromDate"].ToString());

                        if (activityreader["ToDate"] != DBNull.Value)
                            activity.ToDate = Convert.ToDateTime(activityreader["ToDate"].ToString());

                        if (activityreader["CloseDate"] != DBNull.Value)
                            activity.CloseDate = Convert.ToDateTime(activityreader["CloseDate"].ToString());

                        activity.Location = activityreader["Location"].ToString();

                        if (activityreader["IdOwner"] != DBNull.Value)
                            activity.IdOwner = Convert.ToInt32(activityreader["IdOwner"].ToString());

                        if (activityreader["IdOwner"] != DBNull.Value)
                        {
                            activity.People = new People();

                            activity.People.Name = activityreader["Name"].ToString();
                            activity.People.Surname = activityreader["Surname"].ToString();
                        }

                        if (activityreader["Latitude"] != DBNull.Value)
                            activity.Latitude = Convert.ToDouble(activityreader["Latitude"].ToString());

                        if (activityreader["Longitude"] != DBNull.Value)
                            activity.Longitude = Convert.ToDouble(activityreader["Longitude"].ToString());

                        if (activityreader["IsCompleted"] != DBNull.Value)
                        {
                            activity.IsCompleted = Convert.ToByte(activityreader["IsCompleted"].ToString());

                            //close filled when completing some activity.
                            if (activity.IsCompleted == 1)
                            {
                                activity.ActivityGridStatus = "Completed";

                                if (activityreader["CloseDate"] != DBNull.Value)
                                    activity.CloseDate = Convert.ToDateTime(activityreader["CloseDate"].ToString());
                            }
                        }

                        if (activityreader["IdActivityStatus"] != DBNull.Value)
                        {
                            activity.ActivityStatus = new LookupValue();
                            activity.ActivityStatus.IdLookupValue = Convert.ToInt32(activityreader["IdActivityStatus"].ToString());
                            activity.ActivityStatus.Value = activityreader["ActivityStatus"].ToString();
                            activity.ActivityStatus.HtmlColor = activityreader["ActivityStatusHtmlColor"].ToString();

                            if (activityreader["ActivityStatusImage"] != DBNull.Value)
                                activity.ActivityStatus.IdImage = Convert.ToInt64(activityreader["ActivityStatusImage"].ToString());

                            if (activityreader["ActivityStatusPosition"] != DBNull.Value)
                                activity.ActivityStatus.Position = Convert.ToInt32(activityreader["ActivityStatusPosition"].ToString());

                            if (activity.ActivityStatus.IdLookupValue == 48)
                            {
                                activity.ActivityGridStatus = "Completed";
                            }
                            else
                            {
                                activity.ActivityGridStatus = activityreader["ActivityStatus"].ToString();
                            }
                        }

                        listActivity.Add(activity);
                    }
                }
            }

            return listActivity;
        }

        public bool IsExistTagName(string connectionString, string Name)
        {
            bool isExist = false;

            using (MySqlConnection myConnection = new MySqlConnection(connectionString))
            {
                myConnection.Open();

                MySqlCommand myCommand = new MySqlCommand("tags_GetTagNameExist", myConnection);
                myCommand.CommandType = CommandType.StoredProcedure;
                myCommand.Parameters.AddWithValue("_Name", Name.Trim());

                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        isExist = true;
                    }
                }
            }
            return isExist;
        }

        public Tag AddTag(Tag tag, string mainconnectionstring)
        {
            try
            {
                using (MySqlConnection conoffer = new MySqlConnection(mainconnectionstring))
                {
                    conoffer.Open();
                    MySqlCommand conoffercommand = new MySqlCommand("tags_GetTagNameExist", conoffer);
                    conoffercommand.CommandType = CommandType.StoredProcedure;
                    conoffercommand.Parameters.AddWithValue("_Name", tag.Name.Trim());

                    using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                    {
                        if (offerreader.Read())
                        {
                            tag.IdTag = -1;
                        }
                        else
                        {
                            using (MySqlConnection concompany = new MySqlConnection(mainconnectionstring))
                            {
                                concompany.Open();
                                using (MySqlTransaction trans = concompany.BeginTransaction())
                                {
                                    try
                                    {
                                        MySqlCommand concompanycommand = new MySqlCommand("tags_Insert", concompany);
                                        concompanycommand.CommandType = CommandType.StoredProcedure;

                                        concompanycommand.Parameters.AddWithValue("_Name", tag.Name.Trim());
                                        concompanycommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                        concompanycommand.Parameters.AddWithValue("_CreatedBy", tag.CreatedBy);
                                        tag.IdTag = Convert.ToInt64(concompanycommand.ExecuteScalar());

                                        trans.Commit();
                                    }
                                    catch (Exception ex)
                                    {
                                        trans.Rollback();
                                        throw;
                                    }
                                }

                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }

            return tag;
        }

        public bool AddActivityTags(Int64 idActivity, List<ActivityTag> activityTags, string mainServerConnectionString)
        {
            bool isInserted = false;

            if (activityTags != null)
            {
                try
                {
                    foreach (ActivityTag item in activityTags)
                    {
                        if (item.IsDeleted == true)
                        {
                            isInserted = DeleteActivityTags(item, mainServerConnectionString);
                        }
                        else
                        {
                            using (MySqlConnection connTag = new MySqlConnection(mainServerConnectionString))
                            {
                                connTag.Open();
                                //using (MySqlTransaction trans = concompany.BeginTransaction())
                                //{
                                try
                                {
                                    MySqlCommand connTagCommand = new MySqlCommand("activityTags_Insert", connTag);
                                    connTagCommand.CommandType = CommandType.StoredProcedure;
                                    connTagCommand.Parameters.AddWithValue("_IdTag", item.IdTag);
                                    connTagCommand.Parameters.AddWithValue("_IdActivity", idActivity);
                                    //concompanycommand.Transaction = trans;
                                    item.IdActivityTag = Convert.ToInt32(connTagCommand.ExecuteScalar());
                                    //trans.Commit();
                                    if (item.IdActivityTag > 0)
                                    {
                                        isInserted = true;
                                    }

                                    connTag.Close();
                                }
                                catch (Exception ex)
                                {
                                    //trans.Rollback();
                                    throw;
                                }
                                //}
                            }
                        }
                    }
                }
                catch (Exception ex)
                {

                    throw;
                }
            }
            return isInserted;
        }

        public bool DeleteActivityTags(ActivityTag activityTag, string mainServerConnectionString)
        {
            bool isDeleted = false;
            try
            {
                using (MySqlConnection connTag = new MySqlConnection(mainServerConnectionString))
                {
                    connTag.Open();
                    //using (MySqlTransaction trans = myConnection.BeginTransaction())
                    //{
                    try
                    {
                        MySqlCommand conTagCommand = new MySqlCommand("activityTag_Delete", connTag);
                        conTagCommand.CommandType = CommandType.StoredProcedure;
                        conTagCommand.Parameters.AddWithValue("_IdTag", activityTag.IdTag);
                        conTagCommand.Parameters.AddWithValue("_IdActivity", activityTag.IdActivity);
                        //conTagCommand.Transaction = trans;
                        conTagCommand.ExecuteNonQuery();

                        isDeleted = true;
                        //trans.Commit();
                        connTag.Close();
                    }
                    catch (Exception ex)
                    {
                        //trans.Rollback();
                        throw;
                    }
                    //}
                }
            }
            catch (Exception ex)
            {
                throw;
            }

            return isDeleted;
        }

        public List<Tag> GetAllTags(string connectionstring)
        {
            List<Tag> tags = new List<Tag>();
            try
            {
                using (MySqlConnection consite = new MySqlConnection(connectionstring))
                {
                    consite.Open();
                    MySqlCommand consitecommand = new MySqlCommand("tags_GetAllTags", consite);
                    consitecommand.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                    {
                        while (sitereader.Read())
                        {
                            Tag tag = new Tag();
                            tag.IdTag = Convert.ToInt64(sitereader["IdTag"].ToString());
                            tag.Name = sitereader["Name"].ToString();
                            tag.CreatedBy = Convert.ToInt32(sitereader["CreatedBy"].ToString());
                            tag.CreatedIn = Convert.ToDateTime(sitereader["CreatedIn"].ToString());

                            tags.Add(tag);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }
            return tags;
        }

        public List<ActivityTag> GetActivityTagsByIdActivity(Int64 idActivity, string connectionString)
        {
            List<ActivityTag> listActivityTags = new List<ActivityTag>();

            using (MySqlConnection connActivityTags = new MySqlConnection(connectionString))
            {
                connActivityTags.Open();
                MySqlCommand activityTagsCommand = new MySqlCommand("activityTags_GetActivityTagsByIdActivity", connActivityTags);
                activityTagsCommand.CommandType = CommandType.StoredProcedure;
                activityTagsCommand.Parameters.AddWithValue("_IdActivity", idActivity);

                using (MySqlDataReader activityReader = activityTagsCommand.ExecuteReader())
                {
                    while (activityReader.Read())
                    {
                        ActivityTag ActivityTag = new ActivityTag();

                        if (activityReader["IdActivity"] != DBNull.Value)
                            ActivityTag.IdActivity = Convert.ToInt64(activityReader["IdActivity"].ToString());

                        if (activityReader["IdTag"] != DBNull.Value)
                        {
                            ActivityTag.IdTag = Convert.ToInt64(activityReader["IdTag"].ToString());

                            ActivityTag.Tag = new Tag();
                            ActivityTag.Tag.IdTag = Convert.ToInt64(activityReader["IdTag"].ToString());
                            ActivityTag.Tag.Name = activityReader["Name"].ToString();
                        }

                        if (activityReader["IdActivityTag"] != DBNull.Value)
                            ActivityTag.IdActivityTag = Convert.ToInt64(activityReader["IdActivityTag"].ToString());

                        listActivityTags.Add(ActivityTag);
                    }
                }
            }

            return listActivityTags;
        }

        public Notification AddNotification(Notification notification, ActivityMail activityMail, string mainconnectionstring, string MailServerName, string MailServerPort, string MailFrom, string EmailTemplate)
        {
            try
            {
                using (MySqlConnection connNotification = new MySqlConnection(mainconnectionstring))
                {
                    connNotification.Open();

                    //using (MySqlTransaction trans = connNotification.BeginTransaction())
                    //{
                    try
                    {
                        MySqlCommand notificationCommand = new MySqlCommand("notifications_Insert", connNotification);
                        notificationCommand.CommandType = CommandType.StoredProcedure;

                        notificationCommand.Parameters.AddWithValue("_Time", DateTime.Now);
                        notificationCommand.Parameters.AddWithValue("_FromUser", notification.FromUser);
                        notificationCommand.Parameters.AddWithValue("_ToUser", notification.ToUser);
                        notificationCommand.Parameters.AddWithValue("_Message", notification.Message.Trim());
                        notificationCommand.Parameters.AddWithValue("_Title", notification.Title.Trim());
                        notificationCommand.Parameters.AddWithValue("_IdModule", notification.IdModule);
                        notificationCommand.Parameters.AddWithValue("_Status", notification.Status);
                        notificationCommand.Parameters.AddWithValue("_IsNew", notification.IsNew);
                        //concompanycommand.Transaction = trans;
                        notification.Id = Convert.ToInt64(notificationCommand.ExecuteScalar());

                        //trans.Commit();
                        connNotification.Close();
                    }
                    catch (Exception ex)
                    {
                        //trans.Rollback();
                        throw;
                    }
                    //}
                }

                //if (notification.Id > 0)
                //{
                //    ApplicationManager applicationManager = new ApplicationManager();
                //    if (activityMail != null)
                //        applicationManager.SendActivityMail(activityMail, MailServerName, MailServerPort, MailFrom, EmailTemplate);
                //}
            }
            catch (Exception ex)
            {
                throw;
            }

            return notification;
        }

        /// <summary>
        /// This method is used to get all admin users.
        /// </summary>
        /// <param name="connectionstring"></param>
        /// <returns></returns>
        public List<User> GetAllAdminUsers(string connectionstring)
        {
            List<User> users = new List<User>();
            try
            {
                using (MySqlConnection consite = new MySqlConnection(connectionstring))
                {
                    consite.Open();
                    MySqlCommand consitecommand = new MySqlCommand("users_GetAllAdminUsers", consite);
                    consitecommand.CommandType = CommandType.StoredProcedure;

                    using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                    {
                        while (sitereader.Read())
                        {
                            User user = new User();
                            user.IdUser = Convert.ToInt32(sitereader["IdUser"].ToString());
                            user.FirstName = sitereader["FirstName"].ToString();
                            user.LastName = sitereader["LastName"].ToString();
                            user.CompanyEmail = sitereader["CompanyEmail"].ToString();
                            users.Add(user);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }
            return users;
        }

        /// <summary>
        /// This method is used to save notifications to main server.
        /// </summary>
        /// <param name="notification">The Notification</param>
        /// <param name="mainconnectionstring">The MainConnectionString for emdep_geos</param>
        /// <param name="workbenchConnectionString"></param>
        /// <param name="MailServerName">The MailServerName</param>
        /// <param name="MailServerPort">The MailServerPort</param>
        /// <param name="MailFrom">The MailFrom</param>
        /// <param name="EmailTemplate">The EmailTemplate</param>
        /// <returns>Notification</returns>
        public Notification AddCommonNotification(Notification notification, string mainconnectionstring, string workbenchConnectionString, string MailServerName, string MailServerPort, string MailFrom, string EmailTemplate)
        {
            try
            {
                List<User> users = GetAllAdminUsers(workbenchConnectionString);

                foreach (User user in users)
                {
                    if (user.IdUser != notification.FromUser)   // If same user then no need to add notification.
                    {
                        using (MySqlConnection concompany = new MySqlConnection(mainconnectionstring))
                        {
                            concompany.Open();
                            using (MySqlTransaction trans = concompany.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand concompanycommand = new MySqlCommand("notifications_Insert", concompany);
                                    concompanycommand.CommandType = CommandType.StoredProcedure;

                                    concompanycommand.Parameters.AddWithValue("_Time", DateTime.Now);
                                    concompanycommand.Parameters.AddWithValue("_FromUser", notification.FromUser);
                                    concompanycommand.Parameters.AddWithValue("_ToUser", user.IdUser); // notification.ToUser);
                                    concompanycommand.Parameters.AddWithValue("_Message", notification.Message.Trim());
                                    concompanycommand.Parameters.AddWithValue("_Title", notification.Title.Trim());
                                    concompanycommand.Parameters.AddWithValue("_IdModule", notification.IdModule);
                                    concompanycommand.Parameters.AddWithValue("_Status", notification.Status);
                                    concompanycommand.Parameters.AddWithValue("_IsNew", notification.IsNew);
                                    concompanycommand.Transaction = trans;
                                    notification.Id = Convert.ToInt64(concompanycommand.ExecuteScalar());

                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }

                        if (notification.Id > 0)
                        {
                            ApplicationManager applicationManager = new ApplicationManager();
                            if (notification.MailTemplateFormat != null)
                            {
                                notification.MailTemplateFormat.SendToUserName = user.FullName;
                                notification.MailTemplateFormat.SentToMail = user.CompanyEmail;
                                if (notification.MailTemplateFormat.EmailForSection == "Account")
                                {
                                    applicationManager.SendNewAccountMail(notification.MailTemplateFormat, MailServerName, MailServerPort, MailFrom, EmailTemplate);
                                }
                                else if (notification.MailTemplateFormat.EmailForSection == "Project")
                                {
                                    applicationManager.SendNewProjectMail(notification.MailTemplateFormat, MailServerName, MailServerPort, MailFrom, EmailTemplate);
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }

            return notification;
        }

        /// <summary>
        /// This method is used to get activities related to offer by idoffer.
        /// </summary>
        /// <param name="idOffer">The offer id.</param>
        /// <param name="idEmdepSite">The emdep site of offer</param>
        /// <param name="mainConnectionString"></param>
        /// <returns></returns>
        public List<Activity> GetActivitiesByIdOffer(Int64 idOffer, Int32 idEmdepSite, string mainConnectionString)
        {
            List<Activity> listActivity = new List<Activity>();

            using (MySqlConnection connActivities = new MySqlConnection(mainConnectionString))
            {
                connActivities.Open();
                MySqlCommand getActivitiesCommand = new MySqlCommand("activities_GetactivitiesByIdOffer", connActivities);
                getActivitiesCommand.CommandType = CommandType.StoredProcedure;
                getActivitiesCommand.Parameters.AddWithValue("_IdOffer", idOffer);
                getActivitiesCommand.Parameters.AddWithValue("_IdEmdepSite", idEmdepSite);

                using (MySqlDataReader activityReader = getActivitiesCommand.ExecuteReader())
                {
                    while (activityReader.Read())
                    {
                        Activity activity = new Activity();
                        activity.IdActivity = Convert.ToInt64(activityReader["IdActivity"].ToString());
                        activity.Subject = activityReader["Subject"].ToString();
                        activity.Description = activityReader["Description"].ToString();

                        if (activityReader["IdActivityType"] != DBNull.Value)
                        {
                            activity.LookupValue = new LookupValue();
                            activity.LookupValue.IdLookupValue = Convert.ToInt32(activityReader["IdActivityType"].ToString());
                            activity.LookupValue.Value = activityReader["ActivityType"].ToString();
                            activity.LookupValue.HtmlColor = activityReader["ActivityTypeHtmlColor"].ToString();
                            if (activityReader["ActivityTypeImage"] != DBNull.Value)
                                activity.LookupValue.IdImage = Convert.ToInt64(activityReader["ActivityTypeImage"].ToString());
                            if (activityReader["ActivityTypePosition"] != DBNull.Value)
                                activity.LookupValue.Position = Convert.ToInt32(activityReader["ActivityTypePosition"].ToString());
                        }

                        if (activityReader["FromDate"] != DBNull.Value)
                            activity.FromDate = Convert.ToDateTime(activityReader["FromDate"].ToString());

                        if (activityReader["ToDate"] != DBNull.Value)
                            activity.ToDate = Convert.ToDateTime(activityReader["ToDate"].ToString());

                        if (activityReader["CloseDate"] != DBNull.Value)
                            activity.CloseDate = Convert.ToDateTime(activityReader["CloseDate"].ToString());

                        activity.Location = activityReader["Location"].ToString();

                        if (activityReader["IdOwner"] != DBNull.Value)
                            activity.IdOwner = Convert.ToInt32(activityReader["IdOwner"].ToString());

                        if (activityReader["IdOwner"] != DBNull.Value)
                        {
                            activity.People = new People();

                            activity.People.Name = activityReader["Name"].ToString();
                            activity.People.Surname = activityReader["Surname"].ToString();
                        }

                        if (activityReader["Latitude"] != DBNull.Value)
                            activity.Latitude = Convert.ToDouble(activityReader["Latitude"].ToString());

                        if (activityReader["Longitude"] != DBNull.Value)
                            activity.Longitude = Convert.ToDouble(activityReader["Longitude"].ToString());

                        if (activityReader["IsCompleted"] != DBNull.Value)
                        {
                            activity.IsCompleted = Convert.ToByte(activityReader["IsCompleted"].ToString());

                            //close filled when completing some activity.
                            if (activity.IsCompleted == 1)
                            {
                                activity.ActivityGridStatus = "Completed";

                                if (activityReader["CloseDate"] != DBNull.Value)
                                    activity.CloseDate = Convert.ToDateTime(activityReader["CloseDate"].ToString());
                            }
                        }

                        if (activityReader["IdActivityStatus"] != DBNull.Value)
                        {
                            activity.ActivityStatus = new LookupValue();
                            activity.ActivityStatus.IdLookupValue = Convert.ToInt32(activityReader["IdActivityStatus"].ToString());
                            activity.ActivityStatus.Value = activityReader["ActivityStatus"].ToString();
                            activity.ActivityStatus.HtmlColor = activityReader["ActivityStatusHtmlColor"].ToString();

                            if (activityReader["ActivityStatusImage"] != DBNull.Value)
                                activity.ActivityStatus.IdImage = Convert.ToInt64(activityReader["ActivityStatusImage"].ToString());

                            if (activityReader["ActivityStatusPosition"] != DBNull.Value)
                                activity.ActivityStatus.Position = Convert.ToInt32(activityReader["ActivityStatusPosition"].ToString());

                            if (activity.ActivityStatus.IdLookupValue == 48)
                            {
                                activity.ActivityGridStatus = "Completed";
                            }
                            else
                            {
                                activity.ActivityGridStatus = activityReader["ActivityStatus"].ToString();
                            }
                        }

                        if (activityReader["CreatedIn"] != DBNull.Value)
                        {
                            activity.CreatedIn = Convert.ToDateTime(activityReader["CreatedIn"].ToString());
                        }

                        listActivity.Add(activity);
                    }
                }
            }

            return listActivity;
        }

        /// <summary>
        /// This method is used to get offer id, code for activity linked items.
        /// </summary>
        /// <param name="idOffer">if offer</param>
        /// <param name="connectionstring">get string by idEmdepSite from activity linked items.</param>
        /// <returns></returns>
        public Offer GetOfferByIdOfferAndEmdepSite(Int64 idOffer, string connectionstring)
        {
            Offer offer = new Offer();
            using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
            {
                conoffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("GetOfferByIdOfferAndEmdepSite", conoffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_IdOffer", idOffer);
                using (MySqlDataReader offerReader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    if (offerReader.Read())
                    {
                        offer.IdOffer = Convert.ToInt64(offerReader["Idoffer"].ToString());
                        offer.Code = Convert.ToString(offerReader["Code"].ToString());
                        offer.Description = Convert.ToString(offerReader["Title"].ToString());
                        offer.IdCustomer = Convert.ToInt32(offerReader["IdCustomer"].ToString());

                        offer.Site = new Company() { IdCompany = Convert.ToInt32(offerReader["IdSite"].ToString()), Name = offerReader["SiteName"].ToString(), SiteNameWithoutCountry = offerReader["SiteWithCountryName"].ToString() };
                        offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerReader["IdCustomer"].ToString()), CustomerName = offerReader["CustomerGroup"].ToString() } };
                    }
                }
                return offer;
            }
        }

        /// <summary>
        /// This method is used to get Contact by ID when double click on contact.
        /// </summary>
        /// <param name="idPerson">Id Person</param>
        /// <param name="connectionstring">Crm Connection string</param>
        /// <returns>People</returns>
        public People GetContactsByIdPerson(Int32 idPerson, string connectionstring)
        {
            People people = new People();

            using (MySqlConnection conPeople = new MySqlConnection(connectionstring))
            {
                conPeople.Open();
                MySqlCommand conPeoplecommand = new MySqlCommand("people_GetContactsByIdPerson", conPeople);

                conPeoplecommand.CommandType = CommandType.StoredProcedure;
                conPeoplecommand.Parameters.AddWithValue("_idPerson", idPerson);
                using (MySqlDataReader peopleReader = conPeoplecommand.ExecuteReader())
                {
                    while (peopleReader.Read())
                    {
                        people.IdPerson = Convert.ToInt32(peopleReader["IdPerson"].ToString());
                        people.Name = peopleReader["FirstName"].ToString();
                        people.Surname = peopleReader["LastName"].ToString();
                        people.Phone = peopleReader["Telephone"].ToString();
                        people.Email = peopleReader["Email"].ToString();

                        if (peopleReader["IdPersonGender"] != DBNull.Value)
                        {
                            people.IdPersonGender = Convert.ToByte(peopleReader["IdPersonGender"].ToString());
                            if (people.IdPersonGender == 1)
                                people.UserGender = "Female";
                            else if (people.IdPersonGender == 2)
                                people.UserGender = "Male";
                        }

                        people.Company = new Company() { IdCompany = Convert.ToInt32(peopleReader["IdCompany"].ToString()), Name = peopleReader["CustomerPlant"].ToString(), Country = new Country { IdCountry = Convert.ToByte(peopleReader["IdCountry"].ToString()), Name = peopleReader["Country"].ToString(), Zone = new Zone { Name = peopleReader["Zone"].ToString() } } };
                        people.Company.Address = peopleReader["SiteAddress"].ToString();
                        people.Observations = peopleReader["Observations"].ToString();
                        people.Company.City = peopleReader["SiteCity"].ToString();
                        people.Company.CIF = peopleReader["SiteCIF"].ToString();
                        people.Company.Telephone = peopleReader["SiteTelephone"].ToString();
                        people.Company.Fax = peopleReader["SiteFax"].ToString();
                        people.Company.PostCode = peopleReader["SitePostCode"].ToString();
                        people.Company.ZipCode = peopleReader["SitePostCode"].ToString();
                        people.Company.Region = peopleReader["SiteRegion"].ToString();
                        people.Company.RegisteredName = peopleReader["SiteRegisteredName"].ToString();
                        people.Company.Website = peopleReader["SiteWebsite"].ToString();
                        people.Company.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(peopleReader["IdCustomer"].ToString()), CustomerName = peopleReader["CustomerGroup"].ToString() } };

                        if (peopleReader["IdPersonType"] != DBNull.Value)
                        {
                            people.PeopleType = new PeopleType();
                            people.IdPersonType = Convert.ToByte(peopleReader["IdPersonType"].ToString());
                            people.PeopleType.IdPersonType = Convert.ToByte(peopleReader["IdPersonType"].ToString());
                            people.PeopleType.Name = peopleReader["PersonTypeName"].ToString();
                        }

                        if (peopleReader["CreatedIn"] != DBNull.Value)
                            people.CreatedIn = Convert.ToDateTime(peopleReader["CreatedIn"].ToString());

                        if (peopleReader["IdCompanyDepartment"] != DBNull.Value)
                        {
                            people.IdCompanyDepartment = Convert.ToInt32(peopleReader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment = new LookupValue();
                            people.CompanyDepartment.IdLookupValue = Convert.ToInt32(peopleReader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment.Value = peopleReader["Value"].ToString();

                            if (peopleReader["IdImage"] != DBNull.Value)
                                people.CompanyDepartment.IdImage = Convert.ToInt64(peopleReader["IdImage"].ToString());

                            //if (sitereader["InUse"] != DBNull.Value)
                            //    people.CompanyDepartment.InUse = Convert.ToBoolean(sitereader["InUse"].ToString());
                        }

                        people.JobTitle = peopleReader["JobTitle"].ToString();
                        people.ImageText = peopleReader["Image"].ToString();

                        if (peopleReader["IdContactInfluenceLevel"] != DBNull.Value)
                        {
                            people.IdContactInfluenceLevel = Convert.ToInt32(peopleReader["IdContactInfluenceLevel"].ToString());
                            people.InfluenceLevel = new LookupValue();
                            people.InfluenceLevel.IdLookupValue = Convert.ToInt32(peopleReader["IdContactInfluenceLevel"].ToString());
                            people.InfluenceLevel.Value = peopleReader["InfluenceLevel"].ToString();
                            people.InfluenceLevel.HtmlColor = peopleReader["InfluenceLevelHtmlcolor"].ToString();

                            if (peopleReader["InfluenceLevelIdImage"] != DBNull.Value)
                                people.InfluenceLevel.IdImage = Convert.ToInt64(peopleReader["InfluenceLevelIdImage"].ToString());

                            //if (peoplereader["InfluenceLevelInUse"] != DBNull.Value)
                            //    people.InfluenceLevel.InUse = Convert.ToBoolean(peoplereader["InfluenceLevelInUse"].ToString());
                        }

                        if (peopleReader["IdContactEmdepAffinity"] != DBNull.Value)
                        {
                            people.IdContactEmdepAffinity = Convert.ToInt32(peopleReader["IdContactEmdepAffinity"].ToString());
                            people.EmdepAffinity = new LookupValue();
                            people.EmdepAffinity.IdLookupValue = Convert.ToInt32(peopleReader["IdContactEmdepAffinity"].ToString());
                            people.EmdepAffinity.Value = peopleReader["EmdepAffinity"].ToString();
                            people.EmdepAffinity.HtmlColor = peopleReader["EmdepAffinityHtmlcolor"].ToString();

                            if (peopleReader["EmdepAffinityIdImage"] != DBNull.Value)
                                people.EmdepAffinity.IdImage = Convert.ToInt64(peopleReader["EmdepAffinityIdImage"].ToString());

                            //if (peoplereader["EmdepAffinityInUse"] != DBNull.Value)
                            //    people.EmdepAffinity.InUse = Convert.ToBoolean(peoplereader["EmdepAffinityInUse"].ToString());
                        }


                        if (peopleReader["IdContactProductInvolved"] != DBNull.Value)
                        {
                            people.IdContactProductInvolved = Convert.ToInt32(peopleReader["IdContactProductInvolved"].ToString());
                            people.ProductInvolved = new LookupValue();
                            people.ProductInvolved.IdLookupValue = Convert.ToInt32(peopleReader["IdContactProductInvolved"].ToString());
                            people.ProductInvolved.Value = peopleReader["ProductInvolved"].ToString();
                            people.ProductInvolved.HtmlColor = peopleReader["ProductInvolvedLevelHtmlcolor"].ToString();

                            if (peopleReader["ProductInvolvedLevelIdImage"] != DBNull.Value)
                                people.ProductInvolved.IdImage = Convert.ToInt64(peopleReader["ProductInvolvedLevelIdImage"].ToString());

                            //if (peoplereader["ProductInvolvedInUse"] != DBNull.Value)
                            //    people.ProductInvolved.InUse = Convert.ToBoolean(peoplereader["ProductInvolvedInUse"].ToString());
                        }

                        if (peopleReader["IdCompetitor"] != DBNull.Value)
                        {
                            people.IdCompetitor = Convert.ToInt32(peopleReader["IdCompetitor"].ToString());
                            people.Competitor = new Competitor();
                            people.Competitor.IdCompetitor = Convert.ToInt32(peopleReader["IdCompetitor"].ToString());
                            people.Competitor.Name = peopleReader["Competitor"].ToString();
                        }
                    }
                }
            }

            return people;
        }

        /// <summary>
        /// This method is used to show not restrcited BU in dashboard ops.
        /// </summary>
        /// <param name="idCurrentUser">The Current User like 666</param>
        /// <param name="connectionstring">local</param>
        /// <returns>Business units</returns>
        public IList<LookupValue> GetBusinessUnitsWithoutRestrictedBU(Int32 idCurrentUser, string connectionstring)
        {
            IList<LookupValue> listBU = new List<LookupValue>();

            using (MySqlConnection con = new MySqlConnection(connectionstring))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("businessunit_GetBusinessUnitsWithoutRestrictedBU", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                using (MySqlDataReader offerreader = concommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        LookupValue lookupValue = new LookupValue();
                        lookupValue.IdLookupValue = Convert.ToInt32(offerreader["IdLookupValue"].ToString());
                        lookupValue.Value = offerreader["Value"].ToString();
                        lookupValue.IdLookupKey = Convert.ToByte(offerreader["IdLookupKey"].ToString());

                        if (offerreader["IdImage"] != DBNull.Value)
                            lookupValue.IdImage = Convert.ToInt64(offerreader["IdImage"].ToString());

                        if (offerreader["HtmlColor"] != DBNull.Value)
                            lookupValue.HtmlColor = offerreader["HtmlColor"].ToString();

                        if (offerreader["Position"] != DBNull.Value)
                            lookupValue.Position = Convert.ToInt32(offerreader["Position"].ToString());

                        listBU.Add(lookupValue);
                    }
                }
            }

            return listBU;
        }

        /// <summary>
        /// Activity Reminder in the application when the date will be reached, we will send some email to the user.
        /// </summary>
        /// <param name="mainConnectionString"></param>
        /// <returns></returns>
        public List<Activity> GetActivitiesForActivityReminder(string mainConnectionString)
        {
            List<Activity> listActivity = new List<Activity>();

            using (MySqlConnection conGetActivities = new MySqlConnection(mainConnectionString))
            {
                conGetActivities.Open();
                MySqlCommand conGetActivitiesCommand = new MySqlCommand("activities_GetActivitiesForActivityReminder", conGetActivities);
                conGetActivitiesCommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader activityReader = conGetActivitiesCommand.ExecuteReader())
                {
                    while (activityReader.Read())
                    {
                        Activity activity = new Activity();
                        try
                        {
                            activity.IdActivity = Convert.ToInt64(activityReader["IdActivity"].ToString());

                            activity.Subject = activityReader["Subject"].ToString();
                            activity.Description = activityReader["Description"].ToString();

                            if (activityReader["IdActivityType"] != DBNull.Value)
                            {
                                activity.LookupValue = new LookupValue();
                                activity.LookupValue.IdLookupValue = Convert.ToInt32(activityReader["IdActivityType"].ToString());
                                activity.LookupValue.Value = activityReader["ActivityType"].ToString();
                                activity.LookupValue.HtmlColor = activityReader["ActivityTypeHtmlColor"].ToString();

                                if (activityReader["ActivityTypeImage"] != DBNull.Value)
                                    activity.LookupValue.IdImage = Convert.ToInt64(activityReader["ActivityTypeImage"].ToString());

                                if (activityReader["ActivityTypePosition"] != DBNull.Value)
                                    activity.LookupValue.Position = Convert.ToInt32(activityReader["ActivityTypePosition"].ToString());
                            }

                            if (activityReader["FromDate"] != DBNull.Value)
                                activity.FromDate = Convert.ToDateTime(activityReader["FromDate"].ToString());

                            if (activityReader["ToDate"] != DBNull.Value)
                                activity.ToDate = Convert.ToDateTime(activityReader["ToDate"].ToString());
                            activity.Location = activityReader["Location"].ToString();

                            if (activityReader["IdOwner"] != DBNull.Value)
                                activity.IdOwner = Convert.ToInt32(activityReader["IdOwner"].ToString());

                            if (activityReader["IdPerson"] != DBNull.Value)
                            {
                                activity.People = new People();
                                activity.People.IdPerson = Convert.ToInt32(activityReader["IdPerson"].ToString());
                                activity.People.Name = activityReader["Name"].ToString();
                                activity.People.Surname = activityReader["Surname"].ToString();
                                activity.People.Email = activityReader["Email"].ToString();
                            }

                            if (activityReader["Latitude"] != DBNull.Value)
                                activity.Latitude = Convert.ToDouble(activityReader["Latitude"].ToString());

                            if (activityReader["Longitude"] != DBNull.Value)
                                activity.Longitude = Convert.ToDouble(activityReader["Longitude"].ToString());

                            if (activityReader["IsCompleted"] != DBNull.Value)
                            {
                                activity.IsCompleted = Convert.ToByte(activityReader["IsCompleted"].ToString());

                                //close filled when completing some activity.
                                if (activity.IsCompleted == 1)
                                {
                                    activity.ActivityGridStatus = "Completed";

                                    if (activityReader["CloseDate"] != DBNull.Value)
                                        activity.CloseDate = Convert.ToDateTime(activityReader["CloseDate"].ToString());
                                }
                            }

                            if (activityReader["IdActivityStatus"] != DBNull.Value)
                            {
                                activity.ActivityStatus = new LookupValue();
                                activity.ActivityStatus.IdLookupValue = Convert.ToInt32(activityReader["IdActivityStatus"].ToString());
                                activity.ActivityStatus.Value = activityReader["ActivityStatus"].ToString();
                                activity.ActivityStatus.HtmlColor = activityReader["ActivityStatusHtmlColor"].ToString();

                                if (activityReader["ActivityStatusImage"] != DBNull.Value)
                                    activity.ActivityStatus.IdImage = Convert.ToInt64(activityReader["ActivityStatusImage"].ToString());

                                if (activityReader["ActivityStatusPosition"] != DBNull.Value)
                                    activity.ActivityStatus.Position = Convert.ToInt32(activityReader["ActivityStatusPosition"].ToString());

                                if (activity.ActivityStatus.IdLookupValue == 48)    // Done
                                {
                                    activity.ActivityGridStatus = "Completed";
                                }
                                else
                                {
                                    activity.ActivityGridStatus = activityReader["ActivityStatus"].ToString();
                                }
                            }

                            listActivity.Add(activity);
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }

                    }
                }
            }

            return listActivity;
        }


        public bool UpdateActivityReminder(Activity activity, string mainConnectionString)
        {
            bool isUpdated = false;
            try
            {
                using (MySqlConnection myConnection = new MySqlConnection(mainConnectionString))
                {
                    myConnection.Open();
                    using (MySqlTransaction trans = myConnection.BeginTransaction())
                    {
                        try
                        {
                            MySqlCommand mySqlCommand = new MySqlCommand("activityReminder_Update", myConnection);
                            mySqlCommand.CommandType = CommandType.StoredProcedure;
                            mySqlCommand.Parameters.AddWithValue("_IdActivity", activity.IdActivity);
                            mySqlCommand.Parameters.AddWithValue("_IsSentMail", activity.IsSentMail);
                            mySqlCommand.Transaction = trans;
                            mySqlCommand.ExecuteNonQuery();

                            isUpdated = true;
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }

            return isUpdated;
        }

        /// <summary>
        /// This method is used to show open and close engineering analysis.
        /// </summary>
        /// <param name="idCurrency">idCurrency added but not used</param>
        /// <param name="idCurrentUser">The idCurrentUser</param>
        /// <param name="idZone">added but not used</param>
        /// <param name="accountingYear">The Current Year</param>
        /// <param name="companyDetails">The Company details</param>
        /// <param name="idUserPermission">idUserPermission - added but not used - always 22</param>
        /// <returns>List of offers</returns>
        public List<Offer> GetOffersEngineeringAnalysis(byte idCurrency, Int32 idCurrentUser, Int32 idZone, Int64 accountingYear, Company companyDetails, Int32 idUserPermission)
        {
            List<Offer> offers = new List<Offer>();

            //DataSet ds = new DataSet();

            using (MySqlConnection conOffersEngineeringAnalysis = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conOffersEngineeringAnalysis.Open();
                MySqlCommand sqlCommand = new MySqlCommand("offers_GetOffersEngineeringAnalysis", conOffersEngineeringAnalysis);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                sqlCommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                sqlCommand.Parameters.AddWithValue("_idZone", idZone);
                sqlCommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                sqlCommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader offerDataReader = sqlCommand.ExecuteReader())
                {
                    while (offerDataReader.Read())
                    {
                        Offer offer = new Offer();
                        try
                        {
                            offer.IdOffer = Convert.ToInt64(offerDataReader["idoffer"].ToString());

                            if (offerDataReader["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(offerDataReader["IdSalesOwner"].ToString());
                            }

                            offer.IdOfferType = Convert.ToByte(offerDataReader["IdOfferType"].ToString());
                            offer.Code = offerDataReader["OfferCode"].ToString();
                            offer.Description = offerDataReader["OfferTitle"].ToString();

                            offer.Site = new Company();
                            offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;

                            offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerDataReader["OfferStatusid"].ToString()), Name = offerDataReader["OfferStatus"].ToString(), HtmlColor = offerDataReader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerDataReader["IdSalesStatusType"].ToString()), Name = offerDataReader["SalesStatusType"].ToString(), HtmlColor = offerDataReader["SalesStatusTypeColor"].ToString() } };

                            if (offerDataReader["DeliveryDate"] != DBNull.Value)
                                offer.DeliveryDate = Convert.ToDateTime(offerDataReader["DeliveryDate"].ToString());

                            if (offerDataReader["IdBusinessUnit"] != DBNull.Value)
                            {
                                offer.IdBusinessUnit = Convert.ToByte(offerDataReader["IdBusinessUnit"].ToString());
                                offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(offerDataReader["IdBusinessUnit"].ToString()), Value = offerDataReader["BusinessUnit"].ToString() };
                            }

                            offer.PartNumber = new PartNumbers();
                            offer.PartNumber.IdPartNumber = Convert.ToInt32(offerDataReader["idPartNumber"].ToString());
                            offer.PartNumber.Code = Convert.ToString(offerDataReader["PartNumberCode"]);

                            offer.PartNumber.PartNumbersTracking = new PartNumbersTracking();
                            if (offerDataReader["StartDate"] != DBNull.Value)
                                offer.PartNumber.PartNumbersTracking.StartDate = Convert.ToDateTime(offerDataReader["StartDate"].ToString());

                            if (offerDataReader["EndDate"] != DBNull.Value)
                                offer.PartNumber.PartNumbersTracking.EndDate = Convert.ToDateTime(offerDataReader["EndDate"].ToString());

                            offer.PartNumber.PartNumbersTracking.StageOperator = new People();
                            if (offerDataReader["IdOperator"] != DBNull.Value)
                            {
                                offer.PartNumber.PartNumbersTracking.StageOperator.IdPerson = Convert.ToInt32(offerDataReader["IdOperator"].ToString());
                                offer.PartNumber.PartNumbersTracking.StageOperator.Name = Convert.ToString(offerDataReader["Name"]);
                                offer.PartNumber.PartNumbersTracking.StageOperator.Surname = Convert.ToString(offerDataReader["Surname"]);
                            }

                            offers.Add(offer);
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }
                    }
                }
            }

            return offers;
        }

        /// <summary>
        /// This method is used to show open and close engineering analysis.
        /// </summary>
        /// <param name="idCurrency">idCurrency added but not used</param>
        /// <param name="idCurrentUser">The idCurrentUser</param>
        /// <param name="idZone">added but not used</param>
        /// <param name="accountingYearFrom">Get accounting year From</param>
        /// <param name="accountingYearTo">Get accounting year To</param>
        /// <param name="companyDetails">The Company details</param>
        /// <param name="idUserPermission">idUserPermission - added but not used - always 22</param>
        /// <returns>List of offers</returns>
        public List<Offer> GetOffersEngineeringAnalysis(byte idCurrency, Int32 idCurrentUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, Int32 idUserPermission)
        {
            List<Offer> offers = new List<Offer>();

            //DataSet ds = new DataSet();

            using (MySqlConnection conOffersEngineeringAnalysis = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conOffersEngineeringAnalysis.Open();
                MySqlCommand sqlCommand = new MySqlCommand("offers_GetOffersEngineeringAnalysisDateWise", conOffersEngineeringAnalysis);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                sqlCommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                sqlCommand.Parameters.AddWithValue("_idZone", idZone);
                sqlCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                sqlCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                sqlCommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader offerDataReader = sqlCommand.ExecuteReader())
                {
                    while (offerDataReader.Read())
                    {
                        Offer offer = new Offer();
                        try
                        {
                            offer.IdOffer = Convert.ToInt64(offerDataReader["idoffer"].ToString());

                            if (offerDataReader["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(offerDataReader["IdSalesOwner"].ToString());
                            }

                            offer.IdOfferType = Convert.ToByte(offerDataReader["IdOfferType"].ToString());
                            offer.Code = offerDataReader["OfferCode"].ToString();
                            offer.Description = offerDataReader["OfferTitle"].ToString();

                            offer.Site = new Company();
                            offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;

                            offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerDataReader["OfferStatusid"].ToString()), Name = offerDataReader["OfferStatus"].ToString(), HtmlColor = offerDataReader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerDataReader["IdSalesStatusType"].ToString()), Name = offerDataReader["SalesStatusType"].ToString(), HtmlColor = offerDataReader["SalesStatusTypeColor"].ToString() } };

                            if (offerDataReader["DeliveryDate"] != DBNull.Value)
                                offer.DeliveryDate = Convert.ToDateTime(offerDataReader["DeliveryDate"].ToString());

                            if (offerDataReader["IdBusinessUnit"] != DBNull.Value)
                            {
                                offer.IdBusinessUnit = Convert.ToByte(offerDataReader["IdBusinessUnit"].ToString());
                                offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(offerDataReader["IdBusinessUnit"].ToString()), Value = offerDataReader["BusinessUnit"].ToString() };
                            }

                            offer.PartNumber = new PartNumbers();
                            offer.PartNumber.IdPartNumber = Convert.ToInt32(offerDataReader["idPartNumber"].ToString());
                            offer.PartNumber.Code = Convert.ToString(offerDataReader["PartNumberCode"]);

                            offer.PartNumber.PartNumbersTracking = new PartNumbersTracking();
                            if (offerDataReader["StartDate"] != DBNull.Value)
                                offer.PartNumber.PartNumbersTracking.StartDate = Convert.ToDateTime(offerDataReader["StartDate"].ToString());

                            if (offerDataReader["EndDate"] != DBNull.Value)
                                offer.PartNumber.PartNumbersTracking.EndDate = Convert.ToDateTime(offerDataReader["EndDate"].ToString());

                            offer.PartNumber.PartNumbersTracking.StageOperator = new People();
                            if (offerDataReader["IdOperator"] != DBNull.Value)
                            {
                                offer.PartNumber.PartNumbersTracking.StageOperator.IdPerson = Convert.ToInt32(offerDataReader["IdOperator"].ToString());
                                offer.PartNumber.PartNumbersTracking.StageOperator.Name = Convert.ToString(offerDataReader["Name"]);
                                offer.PartNumber.PartNumbersTracking.StageOperator.Surname = Convert.ToString(offerDataReader["Surname"]);
                            }

                            offers.Add(offer);
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }
                    }
                }
            }

            return offers;
        }

        public Double GetOfferMaxValueById(string connectionString, Int16 idMaxValue)
        {
            Double max_value = 0;

            using (MySqlConnection myConnection = new MySqlConnection(connectionString))
            {
                myConnection.Open();

                MySqlCommand myCommand = new MySqlCommand("offers_GetOfferMaxValue", myConnection);
                myCommand.CommandType = CommandType.StoredProcedure;
                myCommand.Parameters.AddWithValue("_idMaxValue", idMaxValue);
                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        max_value = Convert.ToDouble(reader["Max_Value"].ToString());
                    }
                }
            }

            return max_value;
        }

        /// <summary>
        /// This activity is get report from Activity report section.
        /// </summary>
        /// <param name="idSalesOwner"></param>
        /// <param name="fromDate"></param>
        /// <param name="toDate"></param>
        /// <param name="idSite"></param>
        /// <param name="idContacts">IdContacts depend on the selected idSite</param>
        /// <param name="connectionString"></param>
        /// <returns></returns>
        public List<Activity> GetAllActivityReportDetails(string idSalesOwner, DateTime fromDate, DateTime toDate, string idSite, string idContacts, string connectionString)
        {
            List<Activity> activities = new List<Activity>();
            DataSet ds = new DataSet();

            using (MySqlConnection conSalesUser = new MySqlConnection(connectionString))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("GetAllActivityReportDetails", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_idSalesOwner", idSalesOwner);
                conSalesUsercommand.Parameters.AddWithValue("_fromDate", fromDate);
                conSalesUsercommand.Parameters.AddWithValue("_toDate", toDate);
                conSalesUsercommand.Parameters.AddWithValue("_idSite", idSite);
                conSalesUsercommand.Parameters.AddWithValue("_idContacts", idContacts);
                MySqlDataAdapter da = new MySqlDataAdapter(conSalesUsercommand);
                da.Fill(ds);
            }

            foreach (DataRow itemRow in ds.Tables[0].Rows)
            {
                Activity activity = new Activity();
                if (itemRow["IdActivity"] != DBNull.Value)
                    activity.IdActivity = Convert.ToInt64(itemRow["IdActivity"].ToString());

                if (itemRow["IdActivityType"] != DBNull.Value)
                {
                    activity.IdActivityType = Convert.ToInt32(itemRow["IdActivityType"].ToString());
                    activity.LookupValue = new LookupValue();
                    activity.LookupValue.IdLookupValue = Convert.ToInt32(itemRow["IdActivityType"].ToString());
                    activity.LookupValue.Value = itemRow["Value"].ToString();
                    activity.LookupValue.HtmlColor = itemRow["HtmlColor"].ToString();
                    if (itemRow["IdImage"] != DBNull.Value)
                        activity.LookupValue.IdImage = Convert.ToInt64(itemRow["IdImage"].ToString());
                    if (itemRow["Position"] != DBNull.Value)
                        activity.LookupValue.Position = Convert.ToInt32(itemRow["Position"].ToString());
                }

                activity.Subject = itemRow["Subject"].ToString();
                activity.Description = itemRow["Description"].ToString();

                if (itemRow["FromDate"] != DBNull.Value)
                    activity.FromDate = Convert.ToDateTime(itemRow["FromDate"].ToString());
                if (itemRow["ToDate"] != DBNull.Value)
                    activity.ToDate = Convert.ToDateTime(itemRow["ToDate"].ToString());
                if (itemRow["IdOwner"] != DBNull.Value)
                    activity.IdOwner = Convert.ToInt32(itemRow["IdOwner"].ToString());

                if (itemRow["IdActivityStatus"] != DBNull.Value)
                {
                    activity.IdActivityStatus = Convert.ToInt32(itemRow["IdActivityStatus"].ToString());
                    activity.ActivityStatus = new LookupValue();
                    activity.ActivityStatus.IdLookupValue = Convert.ToInt32(itemRow["IdActivityStatus"].ToString());
                    activity.ActivityStatus.Value = itemRow["ActivityStatus"].ToString();
                    activity.ActivityStatus.HtmlColor = itemRow["ActivityStatusHtmlColor"].ToString();
                    if (itemRow["ActivityStatusIdImage"] != DBNull.Value)
                        activity.ActivityStatus.IdImage = Convert.ToInt64(itemRow["ActivityStatusIdImage"].ToString());
                    if (itemRow["ActivityStatusPosition"] != DBNull.Value)
                        activity.ActivityStatus.Position = Convert.ToInt32(itemRow["ActivityStatusPosition"].ToString());
                }

                if (itemRow["IsCompleted"] != DBNull.Value)
                    activity.IsCompleted = Convert.ToByte(itemRow["IsCompleted"].ToString());
                activity.ReportGroup = itemRow["ReportGroup"].ToString();

                activities.Add(activity);
            }

            return activities;
        }

        /// <summary>
        /// Created new function same as GetOfferReportDetails because new field Contact is added in Activity Report in sprint 20 
        /// </summary>
        /// <param name="idSalesOwner"></param>
        /// <param name="fromDate"></param>
        /// <param name="toDate"></param>
        /// <param name="idbusinessUnit"></param>
        /// <param name="idSite"></param>
        /// <param name="idCurrency"></param>
        /// <param name="company"></param>
        /// <param name="idContacts">These contacts are related to offer contacts</param>
        /// <returns></returns>
        public List<Offer> GetAllOfferReportDetails(string idSalesOwner, DateTime fromDate, DateTime toDate, string idbusinessUnit, string idSite, byte idCurrency, Company company, string idContacts)
        {
            List<Offer> offers = new List<Offer>();
            DataSet ds = new DataSet();
            using (MySqlConnection conSalesUser = new MySqlConnection(company.ConnectPlantConstr))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("GetOfferReportDetailsTest", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_idSalesOwner", idSalesOwner);
                conSalesUsercommand.Parameters.AddWithValue("_fromDate", fromDate);
                conSalesUsercommand.Parameters.AddWithValue("_toDate", toDate);
                conSalesUsercommand.Parameters.AddWithValue("_idbusinessUnit", idbusinessUnit);
                conSalesUsercommand.Parameters.AddWithValue("_idSite", idSite);
                conSalesUsercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conSalesUsercommand.Parameters.AddWithValue("_idContacts", idContacts);

                MySqlDataAdapter da = new MySqlDataAdapter(conSalesUsercommand);
                da.Fill(ds);
            }

            foreach (DataRow itemRow in ds.Tables[0].Rows)
            {
                Offer offer = new Offer();
                if (itemRow["IdOffer"] != DBNull.Value)
                    offer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());

                offer.Code = itemRow["Code"].ToString();
                offer.Title = itemRow["OfferTitle"].ToString();
                offer.Description = itemRow["OfferTitle"].ToString();

                if (itemRow["IdSite"] != DBNull.Value)
                {
                    offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };
                    offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };
                }
                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                if (itemRow["PoReceptionDate"] != DBNull.Value)
                    offer.DeliveryDate = Convert.ToDateTime(itemRow["PoReceptionDate"].ToString());
                else
                    offer.DeliveryDate = null;

                if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                    offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());
                offer.ReportGroup = itemRow["ReportGroup"].ToString();
                offers.Add(offer);
            }

            foreach (DataRow itemRow in ds.Tables[1].Rows)
            {
                Offer offer = new Offer();
                if (itemRow["IdOffer"] != DBNull.Value)
                    offer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());

                offer.Code = itemRow["Code"].ToString();
                offer.Title = itemRow["OfferTitle"].ToString();
                offer.Description = itemRow["OfferTitle"].ToString();
                offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };
                offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };
                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                    offer.DeliveryDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString());
                else
                    offer.DeliveryDate = null;

                if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                    offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());
                offer.ReportGroup = itemRow["ReportGroup"].ToString();
                offers.Add(offer);
            }

            foreach (DataRow itemRow in ds.Tables[2].Rows)
            {
                Offer offer = new Offer();
                if (itemRow["IdOffer"] != DBNull.Value)
                    offer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());

                offer.Code = itemRow["Code"].ToString();
                offer.Title = itemRow["OfferTitle"].ToString();
                offer.Description = itemRow["OfferTitle"].ToString();
                offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };
                offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };
                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                    offer.DeliveryDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString());
                else
                    offer.DeliveryDate = null;

                if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                    offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());
                offer.ReportGroup = itemRow["ReportGroup"].ToString();
                offers.Add(offer);
            }

            return offers;
        }

        /// <summary>
        /// Sprint 20 - This method is used to check if Offer or Order by CustomerPurchaseOrder Table 
        /// (Connection string - emdepSite).
        /// </summary>
        /// <param name="idOffer">The Id Offer</param>
        /// <param name="company">The Company</param>
        /// <returns>True (Order) if Has purchase order else False (Offer)/returns>
        public bool IsPurchaseOrderDoneByIdOffer(Int64 idOffer, Company company)
        {
            bool IsPurchaseOrderDone = false;

            using (MySqlConnection conOfferPurchaseOrder = new MySqlConnection(company.ConnectPlantConstr))
            {
                conOfferPurchaseOrder.Open();
                MySqlCommand conOfferPurchaseOrderCommand = new MySqlCommand("offers_IsPurchaseOrderDoneByIdOffer", conOfferPurchaseOrder);
                conOfferPurchaseOrderCommand.CommandType = CommandType.StoredProcedure;

                conOfferPurchaseOrderCommand.Parameters.AddWithValue("_OfferId", idOffer);

                using (MySqlDataReader offerreader = conOfferPurchaseOrderCommand.ExecuteReader())
                {
                    if (offerreader.Read())
                    {
                        IsPurchaseOrderDone = true;
                    }
                }
            }

            return IsPurchaseOrderDone;
        }

        /// <summary>
        /// Sprint 21 - This method is used to Disable Contact.
        /// </summary>
        /// <param name="people">The people</param>
        /// <returns>True if Disabled account else False</returns>
        public bool DisableContact(People people, string mainConnectionString)
        {
            bool isDeleted = false;
            try
            {
                using (MySqlConnection myConnection = new MySqlConnection(mainConnectionString))
                {
                    myConnection.Open();
                    using (MySqlTransaction trans = myConnection.BeginTransaction())
                    {
                        try
                        {
                            MySqlCommand concompanycommand = new MySqlCommand("people_Delete", myConnection);
                            concompanycommand.CommandType = CommandType.StoredProcedure;

                            concompanycommand.Parameters.AddWithValue("_IdPerson", people.IdPerson);
                            concompanycommand.Parameters.AddWithValue("_IsDeleted", people.IsStillActive);

                            concompanycommand.Transaction = trans;
                            concompanycommand.ExecuteNonQuery();

                            isDeleted = true;
                            trans.Commit();

                            //if (isDeleted == true)
                            //{
                            //    AddLogEntriesByActivity(activity.IdActivity, activity.LogEntriesByActivity, mainConnectionString);
                            //}
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }

            return isDeleted;
        }

        /// <summary>
        /// Sprint 21 - This method is used to Disable account.
        /// </summary>
        /// <param name="company">The Company with idCompany</param>
        /// <returns>True if Disabled account else False.</returns>
        public bool DisableAccount(Company company, string mainConnectionString)
        {
            bool isDeleted = false;
            try
            {
                using (MySqlConnection myConnection = new MySqlConnection(mainConnectionString))
                {
                    myConnection.Open();
                    using (MySqlTransaction trans = myConnection.BeginTransaction())
                    {
                        try
                        {
                            MySqlCommand concompanycommand = new MySqlCommand("sites_Delete", myConnection);
                            concompanycommand.CommandType = CommandType.StoredProcedure;

                            concompanycommand.Parameters.AddWithValue("_IdSite", company.IdCompany);
                            concompanycommand.Parameters.AddWithValue("_IsDeleted", company.IsStillActive);

                            concompanycommand.Transaction = trans;
                            concompanycommand.ExecuteNonQuery();

                            isDeleted = true;
                            trans.Commit();

                            if (isDeleted == true)
                            {
                                AddLogEntryBySite(company, mainConnectionString);
                            }
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }

            return isDeleted;
        }


        /// <summary>
        /// Sprint 21 - This method is to get list of companies for Role 22
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingFromYear">Get accounting from year</param>
        /// <param name="accountingToYear">Get accounting to year</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of company</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          companies = mgr.GetSitesTarget(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingFromYear, Int64 accountingToYear, Int32 idUserPermission);
        ///          SP :-  sites_GetTargetByCustomerYearwise
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<Company> GetSitesTargetByPlant(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingFromYear, Int64 accountingToYear, string idSite)
        {
            List<Company> companies = new List<Company>();
            using (MySqlConnection conOfferTarget = new MySqlConnection(connectionstring))
            {

                conOfferTarget.Open();

                MySqlCommand conCompanyTargetCommand = new MySqlCommand("sites_GetTargetByCustomerYearwiseByPlant", conOfferTarget);
                conCompanyTargetCommand.CommandType = CommandType.StoredProcedure;
                conCompanyTargetCommand.Parameters.AddWithValue("_idUser", idUser);
                conCompanyTargetCommand.Parameters.AddWithValue("_idZone", idZone);
                conCompanyTargetCommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conCompanyTargetCommand.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
                conCompanyTargetCommand.Parameters.AddWithValue("_accountingToYear", accountingToYear);
                conCompanyTargetCommand.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader offertargetreader = conCompanyTargetCommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {

                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString());
                        company.Name = offertargetreader["CustomerName"].ToString();
                        company.Country = new Country { Name = offertargetreader["CustomerCountry"].ToString() };

                        company.Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } };
                        company.SalesTargetBySite = new SalesTargetBySite
                        {
                            TargetAmount = Convert.ToDecimal(offertargetreader["TargetSalesAmount"].ToString()),
                            Currency = new Currency { Name = offertargetreader["TargetSalesCurrency"].ToString(), Symbol = offertargetreader["TargetSalesCurrencySymbol"].ToString() },
                            Year = Convert.ToInt32(offertargetreader["Year"].ToString())
                        };

                        companies.Add(company);
                    }
                }
            }

            return companies;
        }






        /// <summary>
        /// Sprint 21 - This method is to get list of companies for Role 22
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingFromYear">Get accounting from year</param>
        /// <param name="accountingToYear">Get accounting to year</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <returns>List of company</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          companies = mgr.GetSitesTarget(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingFromYear, Int64 accountingToYear, Int32 idUserPermission);
        ///          SP :-  sites_GetTargetByCustomerYearwise
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<Company> GetSitesTargetByPlant(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, string idSite)
        {
            List<Company> companies = new List<Company>();
            using (MySqlConnection conOfferTarget = new MySqlConnection(connectionstring))
            {

                conOfferTarget.Open();
                MySqlCommand conCompanyTargetCommand = new MySqlCommand("sites_GetTargetByCustomerYearwiseByPlantDateWise", conOfferTarget);
                conCompanyTargetCommand.CommandType = CommandType.StoredProcedure;
                conCompanyTargetCommand.Parameters.AddWithValue("_idUser", idUser);
                conCompanyTargetCommand.Parameters.AddWithValue("_idZone", idZone);
                conCompanyTargetCommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conCompanyTargetCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conCompanyTargetCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conCompanyTargetCommand.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader offertargetreader = conCompanyTargetCommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {

                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString());
                        company.Name = offertargetreader["CustomerName"].ToString();
                        company.Country = new Country { Name = offertargetreader["CustomerCountry"].ToString() };

                        company.Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } };
                        company.SalesTargetBySite = new SalesTargetBySite
                        {
                            TargetAmount = Convert.ToDecimal(offertargetreader["TargetSalesAmount"].ToString()),
                            Currency = new Currency { Name = offertargetreader["TargetSalesCurrency"].ToString(), Symbol = offertargetreader["TargetSalesCurrencySymbol"].ToString() },
                            Year = Convert.ToInt32(offertargetreader["Year"].ToString())
                        };

                        companies.Add(company);
                    }
                }
            }

            return companies;
        }


        /// <summary>
        /// Sprint 21 This method is to get target forecast details by Role 22
        /// </summary>
        /// <param name="connectionstring">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingFromYear">Get accounting from year</param>
        /// <param name="accountingToYear">Get accounting to year</param>
        /// <param name="idUserPermission">Get user permission id</param>
        /// <param name="idSite">Get idSite for Role 22</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          offers = mgr.GetTargetForecastByPlant(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingFromYear, Int64 accountingToYear, Int32 idUserPermission);
        ///          SP :-  sites_GetForecastedByCustomerYearwise,sites_GetTargetByCustomerYearwise,sites_GetCustomerDetails
        ///     }
        /// }
        /// </code>
        /// </example>  
        public IList<Offer> GetTargetForecastByPlant(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYearFrom, Int64 accountingYearTo, Int32 idUserPermission, string idSite)
        {
            IList<Offer> offers = new List<Offer>();

            IList<CustomerPurchaseOrder> customerforecasted = new List<CustomerPurchaseOrder>();
            IList<Company> companies = new List<Company>();
            using (MySqlConnection concustomerforecast = new MySqlConnection(connectionstring))
            {
                concustomerforecast.Open();
                MySqlCommand concustomerforecastcommand = new MySqlCommand("sites_GetForecastedByCustomerYearwise", concustomerforecast);
                concustomerforecastcommand.CommandType = CommandType.StoredProcedure;
                concustomerforecastcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concustomerforecastcommand.Parameters.AddWithValue("_idUser", idUser);
                concustomerforecastcommand.Parameters.AddWithValue("_idZone", idZone);
                concustomerforecastcommand.Parameters.AddWithValue("_accountingFromYear", accountingYearFrom);
                concustomerforecastcommand.Parameters.AddWithValue("_accountingToYear", accountingYearTo);
                concustomerforecastcommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader customerforecastreader = concustomerforecastcommand.ExecuteReader())
                {
                    while (customerforecastreader.Read())
                    {
                        CustomerPurchaseOrder customerPurchaseOrder = new CustomerPurchaseOrder();
                        customerPurchaseOrder.Offer = new Offer { IdCustomer = Convert.ToInt32(customerforecastreader["idCustomer"].ToString()) };
                        customerPurchaseOrder.Year = customerforecastreader["ForecastedYear"].ToString();
                        customerPurchaseOrder.Value = Convert.ToDouble(customerforecastreader["Amount"].ToString());
                        customerPurchaseOrder.Currency = new Currency { Name = customerforecastreader["Currency"].ToString(), Symbol = customerforecastreader["CurrencySymbol"].ToString() };
                        customerforecasted.Add(customerPurchaseOrder);
                    }
                }
            }

            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();
                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetTargetByCustomerYearwiseByPlant", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;
                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);
                conoffertargetcommand.Parameters.AddWithValue("_idZone", idZone);
                conoffertargetcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conoffertargetcommand.Parameters.AddWithValue("_accountingFromYear", accountingYearFrom);
                conoffertargetcommand.Parameters.AddWithValue("_accountingToYear", accountingYearTo);
                //conoffertargetcommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                conoffertargetcommand.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {
                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString());
                        company.Name = offertargetreader["CustomerName"].ToString();
                        company.Country = new Country { Name = offertargetreader["CustomerCountry"].ToString() };

                        company.Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } };
                        company.SalesTargetBySite = new SalesTargetBySite
                        {
                            IdSite = Convert.ToInt32(offertargetreader["IdSite"].ToString()),
                            TargetAmount = Convert.ToDecimal(offertargetreader["TargetSalesAmount"].ToString()),
                            Currency = new Currency { IdCurrency = Convert.ToByte(offertargetreader["TargetSalesIdCurrency"].ToString()), Name = offertargetreader["TargetSalesCurrency"].ToString(), Symbol = offertargetreader["TargetSalesCurrencySymbol"].ToString() },
                            Year = Convert.ToInt32(offertargetreader["Year"].ToString())
                        };

                        companies.Add(company);
                    }
                }
            }

            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();
                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetCustomerDetailsByPlant", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;
                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);
                conoffertargetcommand.Parameters.AddWithValue("_idZone", idZone);
                conoffertargetcommand.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {
                        Offer offertarget = new Offer();
                        offertarget.Site = new Company { IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString()), Name = offertargetreader["CustomerName"].ToString(), Country = new Country { Name = offertargetreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offertargetreader["CustomerZone"].ToString() } }, Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } } };
                        offertarget.ForecastedByCustomers = customerforecasted.Where(customerforecast => customerforecast.Offer.IdCustomer == offertarget.Site.IdCompany).ToList();

                        if (offertarget.ForecastedByCustomers.Count > 0)
                            offertarget.TotalForecasted = offertarget.ForecastedByCustomers.Sum(i => i.Value);
                        else
                            offertarget.TotalForecasted = 0.00;

                        offertarget.Site.SalesTargetBySiteLst = companies.Where(comp => comp.IdCompany == offertarget.Site.IdCompany).Select(saletarget => saletarget.SalesTargetBySite).ToList();

                        offers.Add(offertarget);
                    }
                }
            }

            return offers;
        }


        /// <summary>
        /// Sprint 21
        /// Report Dashboard - TargetByCustomerByPlant - Role 22
        /// This method is to get list of offer .
        /// </summary>
        /// <param name="connectionString">Get connection string</param>
        /// <param name="idCurrency">Get currency id</param>
        /// <param name="idUser">Get user id</param>
        /// <param name="idZone">Get zone id</param>
        /// <param name="accountingYear">Get accounting year</param>
        /// <param name="idSite">Get idSite</param>
        /// <returns>List of offer</returns>
        /// <example>
        /// This sample shows how to call the method
        /// <code>
        /// class TestClass 
        /// { 
        ///     static void Main(string[] args)
        ///     {
        ///          CrmManager mgr = new CrmManager();
        ///          string connectionstring = ConfigurationManager.ConnectionStrings["CrmContext"].ConnectionString;
        ///          offer = mgr.GetTargetByCustomer(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, string idSite);
        ///          SP :-  sites_GetTargetByCustomer
        ///     }
        /// }
        /// </code>
        /// </example>  
        public List<Offer> GetTargetByCustomerByPlant(string connectionString, byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, string idSite)
        {
            List<Offer> offers = new List<Offer>();
            using (MySqlConnection conOfferTarget = new MySqlConnection(connectionString))
            {
                conOfferTarget.Open();
                MySqlCommand conOfferTargetCommand = new MySqlCommand("sites_GetTargetByCustomerByPlant", conOfferTarget);
                conOfferTargetCommand.CommandType = CommandType.StoredProcedure;
                conOfferTargetCommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conOfferTargetCommand.Parameters.AddWithValue("_idUser", idUser);
                conOfferTargetCommand.Parameters.AddWithValue("_idZone", idZone);
                conOfferTargetCommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conOfferTargetCommand.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader offerTargetReader = conOfferTargetCommand.ExecuteReader())
                {
                    while (offerTargetReader.Read())
                    {
                        Offer offerTarget = new Offer();
                        offerTarget.Site = new Company { IdCompany = Convert.ToInt32(offerTargetReader["IdSite"].ToString()), Name = offerTargetReader["CustomerName"].ToString(), Country = new Country { Name = offerTargetReader["CustomerCountry"].ToString(), Zone = new Zone { Name = offerTargetReader["CustomerZone"].ToString() } }, Customers = new List<Customer> { new Customer { CustomerName = offerTargetReader["CustomerGroup"].ToString() } } };

                        offerTarget.QualifiedByCustomers = new List<CustomerPurchaseOrder>();
                        offerTarget.TotalQualified = 0.00;

                        offerTarget.RFQByCustomers = new List<CustomerPurchaseOrder>();
                        offerTarget.TotalRFQ = 0.00;

                        offerTarget.ForecastedByCustomers = new List<CustomerPurchaseOrder>();
                        offerTarget.TotalForecasted = 0.00;

                        offerTarget.QuotedByCustomers = new List<CustomerPurchaseOrder>();
                        offerTarget.TotalQuotated = 0.00;

                        offerTarget.SalesByCustomers = new List<CustomerPurchaseOrder>();
                        offerTarget.TotalSales = 0.00;

                        if (offerTargetReader["TargetSalesAmount"] != DBNull.Value)
                        {
                            offerTarget.Site.SalesTargetBySite = new SalesTargetBySite
                            {
                                TargetAmount = Convert.ToDecimal(offerTargetReader["TargetSalesAmount"].ToString()),
                                Currency = new Currency { Name = offerTargetReader["TargetSalesCurrency"].ToString() }
                            };

                            double sales = offerTarget.TotalSales.Value;
                            double targetAmount = Convert.ToDouble(offerTarget.Site.SalesTargetBySite.TargetAmount);

                            if (targetAmount != 0)
                                offerTarget.Site.SalesTargetBySite.TargetPercentage = Math.Round((sales / targetAmount) * 100, 2);
                            else
                                offerTarget.Site.SalesTargetBySite.TargetPercentage = 0;
                        }

                        offers.Add(offerTarget);
                    }

                }
            }
            return offers;
        }


        /// <summary>
        /// Sprint 22 - This method is used to add activity watchers.
        /// </summary>
        /// <param name="idActivity">The Activity Id</param>
        /// <param name="activityWatchers">The Activity Watchers list</param>
        /// <param name="mainServerConnectionString">The main server connection string.</param>
        /// <returns>true, If Successful else false.</returns>
        public bool AddActivityWatchers(Int64 idActivity, List<ActivityWatcher> activityWatchers, string mainServerConnectionString)
        {
            bool isInserted = false;

            if (activityWatchers != null)
            {
                try
                {
                    foreach (ActivityWatcher item in activityWatchers)
                    {
                        if (item.IsDeleted == true)
                        {
                            isInserted = DeleteActivityWatcher(mainServerConnectionString, item);
                        }
                        else
                        {
                            using (MySqlConnection connWatcher = new MySqlConnection(mainServerConnectionString))
                            {
                                connWatcher.Open();

                                //using (MySqlTransaction trans = concompany.BeginTransaction())
                                //{
                                try
                                {
                                    MySqlCommand conWatcherCommand = new MySqlCommand("activityWatchers_Insert", connWatcher);
                                    conWatcherCommand.CommandType = CommandType.StoredProcedure;
                                    conWatcherCommand.Parameters.AddWithValue("_IdUser", item.IdUser);
                                    conWatcherCommand.Parameters.AddWithValue("_IdActivity", idActivity);

                                    //concompanycommand.Transaction = trans;
                                    //concompanycommand.Transaction = transaction;

                                    item.IdActivityWatcher = Convert.ToInt32(conWatcherCommand.ExecuteScalar());

                                    //trans.Commit();
                                    connWatcher.Close();

                                    if (item.IdActivityWatcher > 0)
                                    {
                                        isInserted = true;
                                    }
                                }
                                catch (Exception ex)
                                {
                                    //transaction.Rollback();
                                    //trans.Rollback();
                                    throw;
                                }
                                //}
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    throw;
                }
            }

            return isInserted;
        }

        /// <summary>
        /// Sprint 22 - This method is used to delete activity watcher.
        /// </summary>
        /// <param name="activityWatcher">The existing Activity Watcher</param>
        /// <param name="mainServerConnectionString">The Main Server connection string. </param>
        /// <returns>True, if deleted successful, else False</returns>
        public bool DeleteActivityWatcher(string mainServerConnectionString, ActivityWatcher activityWatcher)
        {
            bool isDeleted = false;

            try
            {
                using (MySqlConnection connWatcher = new MySqlConnection(mainServerConnectionString))
                {
                    connWatcher.Open();

                    //using (MySqlTransaction trans = myConnection.BeginTransaction())
                    //{

                    try
                    {
                        MySqlCommand watcherCommand = new MySqlCommand("activityWatchers_Delete", connWatcher);
                        watcherCommand.CommandType = CommandType.StoredProcedure;
                        watcherCommand.Parameters.AddWithValue("_IdUser", activityWatcher.IdUser);
                        watcherCommand.Parameters.AddWithValue("_IdActivity", activityWatcher.IdActivity);
                        //concompanycommand.Transaction = trans;
                        watcherCommand.ExecuteNonQuery();

                        isDeleted = true;
                        //trans.Commit();
                    }
                    catch (Exception ex)
                    {
                        //trans.Rollback();
                        throw;
                    }

                    //}

                    connWatcher.Close();
                }
            }
            catch (Exception ex)
            {
                throw;
            }

            return isDeleted;
        }

        /// <summary>
        /// Sprint 22 - This method is used to get all watchers related to activity (Table - activityWatchers)
        /// </summary>
        /// <param name="idActivity">The activity</param>
        /// <param name="connectionString">The CRMConetxt Connection String</param>
        /// <returns>The List of activity watchers.</returns>
        public List<ActivityWatcher> GetActivityWatchersByIdActivity(Int64 idActivity, string connectionString)
        {
            List<ActivityWatcher> activityWatchers = new List<ActivityWatcher>();

            using (MySqlConnection connWatchers = new MySqlConnection(connectionString))
            {
                connWatchers.Open();
                MySqlCommand watchersCommand = new MySqlCommand("activityWatchers_GetWatchersByIdActivity", connWatchers);
                watchersCommand.CommandType = CommandType.StoredProcedure;
                watchersCommand.Parameters.AddWithValue("_IdActivity", idActivity);

                using (MySqlDataReader activityreader = watchersCommand.ExecuteReader())
                {
                    while (activityreader.Read())
                    {
                        ActivityWatcher activityWatcher = new ActivityWatcher();

                        if (activityreader["IdActivity"] != DBNull.Value)
                            activityWatcher.IdActivity = Convert.ToInt64(activityreader["IdActivity"].ToString());

                        if (activityreader["IdUser"] != DBNull.Value)
                            activityWatcher.IdUser = Convert.ToInt32(activityreader["IdUser"].ToString());

                        if (activityreader["IdActivityWatcher"] != DBNull.Value)
                            activityWatcher.IdActivityWatcher = Convert.ToInt64(activityreader["IdActivityWatcher"].ToString());

                        if (activityreader["IdPerson"] != DBNull.Value)
                        {
                            activityWatcher.People = new People();
                            activityWatcher.People.IdPerson = Convert.ToInt32(activityreader["IdPerson"].ToString());
                            activityWatcher.People.Name = activityreader["Name"].ToString();
                            activityWatcher.People.Surname = activityreader["Surname"].ToString();
                            activityWatcher.People.Email = activityreader["Email"].ToString();
                            activityWatcher.People.Phone = activityreader["Phone"].ToString();
                        }

                        activityWatchers.Add(activityWatcher);
                    }
                }
            }

            return activityWatchers;
        }

        /// <summary>
        /// Sprint 22 - GetSharedActivitiesByIdPermission - This method used to show activities.
        /// The ones where the Sales Owner is someone from the combobox selection && The ones where the logged user has been included in the Watchers field
        /// </summary>
        /// <param name="idActiveUser">The active user</param>
        /// <param name="idOwner">The id owner</param>
        /// <param name="idPermission">The id permission like 20,21,22</param>
        /// <param name="idPlant">IdPlant</param>
        /// <param name="connectionString">Connections String crm context</param>
        /// <returns>The list of activities.</returns>
        public List<Activity> GetSharedActivitiesByIdPermission(Int32 idActiveUser, string idOwner, Int32 idPermission, string idPlant, string connectionString)
        {
            List<Activity> listActivity = new List<Activity>();

            using (MySqlConnection connActivities = new MySqlConnection(connectionString))
            {
                connActivities.Open();

                MySqlCommand activitiesCommand = new MySqlCommand("activities_GetSharedActivitiesByIdPermission", connActivities);
                activitiesCommand.CommandType = CommandType.StoredProcedure;
                activitiesCommand.Parameters.AddWithValue("_IdAciveUser", idActiveUser);
                activitiesCommand.Parameters.AddWithValue("_IdOwner", idOwner);
                activitiesCommand.Parameters.AddWithValue("_IdPermission", idPermission);
                activitiesCommand.Parameters.AddWithValue("_IdPlant", idPlant);

                using (MySqlDataReader activityReader = activitiesCommand.ExecuteReader())
                {
                    while (activityReader.Read())
                    {
                        Activity activity = new Activity();
                        try
                        {
                            activity.IdActivity = Convert.ToInt64(activityReader["IdActivity"].ToString());
                            activity.Subject = activityReader["Subject"].ToString();
                            activity.Description = activityReader["Description"].ToString();

                            if (activityReader["IdActivityType"] != DBNull.Value)
                            {
                                activity.LookupValue = new LookupValue();
                                activity.LookupValue.IdLookupValue = Convert.ToInt32(activityReader["IdActivityType"].ToString());
                                activity.LookupValue.Value = activityReader["ActivityType"].ToString();
                                activity.LookupValue.HtmlColor = activityReader["ActivityTypeHtmlColor"].ToString();

                                if (activityReader["ActivityTypeImage"] != DBNull.Value)
                                    activity.LookupValue.IdImage = Convert.ToInt64(activityReader["ActivityTypeImage"].ToString());
                                if (activityReader["ActivityTypePosition"] != DBNull.Value)
                                    activity.LookupValue.Position = Convert.ToInt32(activityReader["ActivityTypePosition"].ToString());
                            }

                            if (activityReader["FromDate"] != DBNull.Value)
                                activity.FromDate = Convert.ToDateTime(activityReader["FromDate"].ToString());

                            if (activityReader["ToDate"] != DBNull.Value)
                                activity.ToDate = Convert.ToDateTime(activityReader["ToDate"].ToString());
                            activity.Location = activityReader["Location"].ToString();

                            if (activityReader["IdOwner"] != DBNull.Value)
                                activity.IdOwner = Convert.ToInt32(activityReader["IdOwner"].ToString());

                            if (activityReader["IdPerson"] != DBNull.Value)
                            {
                                activity.People = new People();

                                activity.People.Name = activityReader["Name"].ToString();
                                activity.People.Surname = activityReader["Surname"].ToString();
                            }

                            if (activityReader["Latitude"] != DBNull.Value)
                                activity.Latitude = Convert.ToDouble(activityReader["Latitude"].ToString());
                            if (activityReader["Longitude"] != DBNull.Value)
                                activity.Longitude = Convert.ToDouble(activityReader["Longitude"].ToString());

                            if (activityReader["IsCompleted"] != DBNull.Value)
                            {
                                activity.IsCompleted = Convert.ToByte(activityReader["IsCompleted"].ToString());

                                //close filled when completing some activity.
                                if (activity.IsCompleted == 1)
                                {
                                    activity.ActivityGridStatus = "Completed";

                                    if (activityReader["CloseDate"] != DBNull.Value)
                                        activity.CloseDate = Convert.ToDateTime(activityReader["CloseDate"].ToString());
                                }
                            }

                            if (activityReader["IdActivityStatus"] != DBNull.Value)
                            {
                                activity.ActivityStatus = new LookupValue();
                                activity.ActivityStatus.IdLookupValue = Convert.ToInt32(activityReader["IdActivityStatus"].ToString());
                                activity.ActivityStatus.Value = activityReader["ActivityStatus"].ToString();
                                activity.ActivityStatus.HtmlColor = activityReader["ActivityStatusHtmlColor"].ToString();
                                if (activityReader["ActivityStatusImage"] != DBNull.Value)
                                    activity.ActivityStatus.IdImage = Convert.ToInt64(activityReader["ActivityStatusImage"].ToString());
                                if (activityReader["ActivityStatusPosition"] != DBNull.Value)
                                    activity.ActivityStatus.Position = Convert.ToInt32(activityReader["ActivityStatusPosition"].ToString());

                                if (activity.ActivityStatus.IdLookupValue == 48)
                                {
                                    activity.ActivityGridStatus = "Completed";
                                }
                                else
                                {
                                    activity.ActivityGridStatus = activityReader["ActivityStatus"].ToString();
                                }
                            }

                            if (activityReader["ReminderDateTime"] != DBNull.Value)
                                activity.ActivityReminderDateTime = Convert.ToDateTime(activityReader["ReminderDateTime"].ToString());

                            if (activityReader["IsSentMail"] != DBNull.Value)
                                activity.IsSentMail = Convert.ToByte(activityReader["IsSentMail"].ToString());

                            activity.ActivityLinkedItem = new List<ActivityLinkedItem>();
                            activity.ActivityLinkedItem = GetActivityAccountByIdActivity(activity.IdActivity, connectionString);
                            listActivity.Add(activity);

                            activity.ActivityTags = GetActivityTagsByIdActivity(activity.IdActivity, connectionString);
                            activity.ActivityTagsString = string.Join("\n", activity.ActivityTags.Select(c => c.Tag.Name.ToString()).ToArray<string>());

                            activity.ActivityAttendees = GetActivityAttendeesByIdActivity(activity.IdActivity, connectionString);
                            activity.ActivityAttendeesString = string.Join("\n", activity.ActivityAttendees.Select(c => c.People.FullName.ToString()).ToArray<string>());
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }
                    }
                }
            }

            return listActivity;
        }

        public List<Activity> GetSharedActivitiesByIdPermission(Int32 idActiveUser, string idOwner, Int32 idPermission, string idPlant, string connectionString, DateTime accountingYearFrom, DateTime accountingYearTo, string userProfileImagePath)
        {
            List<Activity> listActivity = new List<Activity>();

            Dictionary<string, byte[]> resourceImages = new Dictionary<string, byte[]>();

            using (MySqlConnection connActivities = new MySqlConnection(connectionString))
            {
                connActivities.Open();

                MySqlCommand activitiesCommand = new MySqlCommand("activities_GetSharedActivitiesByIdPermissionDatewise", connActivities);
                activitiesCommand.CommandType = CommandType.StoredProcedure;
                activitiesCommand.Parameters.AddWithValue("_IdAciveUser", idActiveUser);
                activitiesCommand.Parameters.AddWithValue("_IdOwner", idOwner);
                activitiesCommand.Parameters.AddWithValue("_IdPermission", idPermission);
                activitiesCommand.Parameters.AddWithValue("_IdPlant", idPlant);
                activitiesCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                activitiesCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);

                using (MySqlDataReader activityReader = activitiesCommand.ExecuteReader())
                {
                    while (activityReader.Read())
                    {
                        Activity activity = new Activity();
                        try
                        {
                            activity.IdActivity = Convert.ToInt64(activityReader["IdActivity"].ToString());
                            activity.Subject = activityReader["Subject"].ToString();
                            activity.Description = activityReader["Description"].ToString();

                            if (activityReader["IdActivityType"] != DBNull.Value)
                            {
                                activity.LookupValue = new LookupValue();
                                activity.LookupValue.IdLookupValue = Convert.ToInt32(activityReader["IdActivityType"].ToString());
                                activity.LookupValue.Value = activityReader["ActivityType"].ToString();
                                activity.LookupValue.HtmlColor = activityReader["ActivityTypeHtmlColor"].ToString();

                                if (activityReader["ActivityTypeImage"] != DBNull.Value)
                                    activity.LookupValue.IdImage = Convert.ToInt64(activityReader["ActivityTypeImage"].ToString());
                                if (activityReader["ActivityTypePosition"] != DBNull.Value)
                                    activity.LookupValue.Position = Convert.ToInt32(activityReader["ActivityTypePosition"].ToString());
                            }

                            if (activityReader["FromDate"] != DBNull.Value)
                                activity.FromDate = Convert.ToDateTime(activityReader["FromDate"].ToString());

                            if (activityReader["ToDate"] != DBNull.Value)
                                activity.ToDate = Convert.ToDateTime(activityReader["ToDate"].ToString());
                            activity.Location = activityReader["Location"].ToString();

                            if (activityReader["IdOwner"] != DBNull.Value)
                                activity.IdOwner = Convert.ToInt32(activityReader["IdOwner"].ToString());

                            if (activityReader["IdPerson"] != DBNull.Value)
                            {
                                activity.People = new People();

                                activity.People.Name = activityReader["Name"].ToString();
                                activity.People.Surname = activityReader["Surname"].ToString();

                                if (activityReader["Login"] != DBNull.Value)
                                {
                                    activity.People.Login = Convert.ToString(activityReader["Login"]);

                                    //if (!resourceImages.ContainsKey(activity.People.Login))
                                    //{
                                    //    activity.People.ImageBytes = GetUserProfileImage(activity.People.Login, userProfileImagePath);
                                    //    resourceImages.Add(activity.People.Login, activity.People.ImageBytes);
                                    //}
                                    //else
                                    //{
                                    //    activity.People.ImageBytes = resourceImages[activity.People.Login];
                                    //}
                                }
                            }

                            if (activityReader["Latitude"] != DBNull.Value)
                                activity.Latitude = Convert.ToDouble(activityReader["Latitude"].ToString());
                            if (activityReader["Longitude"] != DBNull.Value)
                                activity.Longitude = Convert.ToDouble(activityReader["Longitude"].ToString());

                            activity.ActivityGridStatus = string.Empty;
                            if (activityReader["IsCompleted"] != DBNull.Value)
                            {
                                activity.IsCompleted = Convert.ToByte(activityReader["IsCompleted"].ToString());

                                //close filled when completing some activity.
                                if (activity.IsCompleted == 1)
                                {
                                    activity.ActivityGridStatus = "Completed";

                                    if (activityReader["CloseDate"] != DBNull.Value)
                                        activity.CloseDate = Convert.ToDateTime(activityReader["CloseDate"].ToString());
                                }
                            }

                            if (activityReader["IdActivityStatus"] != DBNull.Value)
                            {
                                activity.ActivityStatus = new LookupValue();
                                activity.ActivityStatus.IdLookupValue = Convert.ToInt32(activityReader["IdActivityStatus"].ToString());
                                activity.ActivityStatus.Value = activityReader["ActivityStatus"].ToString();
                                activity.ActivityStatus.HtmlColor = activityReader["ActivityStatusHtmlColor"].ToString();
                                if (activityReader["ActivityStatusImage"] != DBNull.Value)
                                    activity.ActivityStatus.IdImage = Convert.ToInt64(activityReader["ActivityStatusImage"].ToString());
                                if (activityReader["ActivityStatusPosition"] != DBNull.Value)
                                    activity.ActivityStatus.Position = Convert.ToInt32(activityReader["ActivityStatusPosition"].ToString());

                                if (activity.ActivityStatus.IdLookupValue == 48)
                                {
                                    activity.ActivityGridStatus = "Completed";
                                }
                                else
                                {
                                    activity.ActivityGridStatus = activityReader["ActivityStatus"].ToString();
                                }
                            }

                            if (activityReader["ReminderDateTime"] != DBNull.Value)
                                activity.ActivityReminderDateTime = Convert.ToDateTime(activityReader["ReminderDateTime"].ToString());

                            if (activityReader["IsSentMail"] != DBNull.Value)
                                activity.IsSentMail = Convert.ToByte(activityReader["IsSentMail"].ToString());

                            activity.ActivityLinkedItem = new List<ActivityLinkedItem>();
                            activity.ActivityLinkedItem = GetActivityAccountByIdActivity(activity.IdActivity, connectionString);

                            //activity.ActivityTags = GetActivityTagsByIdActivity(activity.IdActivity, connectionString);
                            //activity.ActivityTagsString = string.Join("\n", activity.ActivityTags.Select(c => c.Tag.Name.ToString()).ToArray<string>());

                            if (activityReader["ActivityTagsString"] != DBNull.Value)
                                activity.ActivityTagsString = Convert.ToString(activityReader["ActivityTagsString"]);

                            //activity.ActivityAttendees = GetActivityAttendeesByIdActivity(activity.IdActivity, connectionString);
                            //activity.ActivityAttendeesString = string.Join("\n", activity.ActivityAttendees.Select(c => c.People.FullName.ToString()).ToArray<string>());

                            if (activityReader["ActivityAttendeesString"] != DBNull.Value)
                                activity.ActivityAttendeesString = Convert.ToString(activityReader["ActivityAttendeesString"]);

                            listActivity.Add(activity);
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }
                    }
                }
            }

            return listActivity;
        }

        /// <summary>
        /// Sprint 22 - Edit fields in Orders - comments, activities, activities - Used Transaction scope for same.
        /// </summary>
        /// <param name="offer">The Order details</param>
        /// <param name="connectionString">Emdep Site connection String</param>
        /// <returns>True, if successful else false.</returns>
        public bool UpdateOrderByIdOffer(Offer offer, string connectionString, string mainServerConnectionString)
        {
            TransactionScope transactionScopeGeos = null;
            TransactionScope transactionScopeEmdepGeos = null;
            bool isUpdated = false;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            try
            {
                using (transactionScopeGeos = new TransactionScope())
                {
                    Int64? nullProductCategory = null;
                    if (offer.IdProductCategory > 0)
                    {
                        nullProductCategory = offer.IdProductCategory;
                    }

                    using (MySqlConnection connOrder = new MySqlConnection(offer.Site.ConnectPlantConstr))
                    {
                        connOrder.Open();

                        MySqlCommand orderCommand = new MySqlCommand("offers_UpdateOrderParticularColumn", connOrder);

                        orderCommand.CommandType = CommandType.StoredProcedure;
                        orderCommand.Parameters.AddWithValue("_Code", offer.Code);
                        orderCommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                        orderCommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                        orderCommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                        orderCommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                        orderCommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                        orderCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        orderCommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                        orderCommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                        orderCommand.ExecuteNonQuery();
                        isUpdated = true;

                        connOrder.Close();

                        if (isUpdated)
                        {
                            if (offer.OfferContacts != null && offer.OfferContacts.Count > 0)
                                AddOrderContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);

                            if (offer.CommentsByOffers != null && offer.CommentsByOffers.Count > 0)     //Comments
                                AddLogEntryByOrder(offer.IdOffer, offer.CommentsByOffers, connectionString, offer.Site.ConnectPlantConstr);

                            if (offer.LogEntryByOffers != null && offer.LogEntryByOffers.Count > 0)     //Log entries.
                                AddLogEntryByOrder(offer.IdOffer, offer.LogEntryByOffers, connectionString, offer.Site.ConnectPlantConstr);
                        }
                    }

                    using (transactionScopeEmdepGeos = new TransactionScope(TransactionScopeOption.RequiresNew))
                    {
                        if (offer.NewlyLinkedActivities != null && offer.NewlyLinkedActivities.Count > 0)
                        {
                            AddLinkExistingActivityToOffer(mainServerConnectionString, offer.NewlyLinkedActivities, offer.Site, offer.IdOffer);
                            transactionScopeEmdepGeos.Complete();
                        }
                    }

                    transactionScopeGeos.Complete();
                }
            }
            catch (Exception ex)
            {
                isUpdated = false;

                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScopeGeos != null)
                    transactionScopeGeos.Dispose();

                if (transactionScopeEmdepGeos != null)
                    transactionScopeEmdepGeos.Dispose();

                throw;
            }

            return isUpdated;
        }

        /// <summary>
        /// Sprint 22 - This method is used add logEntries/Comments to Db in table logentriesbyoffer
        /// </summary>
        /// <param name="IdOffer">The Offer id</param>
        /// <param name="entriesByOffer">The list of LogEntries/Comments</param>
        /// <param name="connectionString">The Connection string</param>
        /// <param name="offerPlantConnectionString">offerPlantConnectionString</param>
        public void AddLogEntryByOrder(Int64 IdOffer, List<LogEntryByOffer> entriesByOffer, string connectionString, string offerPlantConnectionString)
        {
            try
            {
                if (offerPlantConnectionString == null)
                    offerPlantConnectionString = connectionString;

                foreach (LogEntryByOffer logEntryByOffer in entriesByOffer)
                {
                    if (logEntryByOffer.IsUpdate && logEntryByOffer.IdLogEntry > 0)     //To update offer comments used this block.
                    {
                        using (MySqlConnection connlogEntryByOffer = new MySqlConnection(offerPlantConnectionString))
                        {
                            connlogEntryByOffer.Open();

                            try
                            {
                                MySqlCommand conlogEntryByOffercommand = new MySqlCommand("logEntryByOffer_Update", connlogEntryByOffer);
                                conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                                conlogEntryByOffercommand.Parameters.AddWithValue("_IdLogEntry", logEntryByOffer.IdLogEntry);
                                conlogEntryByOffercommand.Parameters.AddWithValue("_Comment", logEntryByOffer.Comments);
                                conlogEntryByOffercommand.Parameters.AddWithValue("_logDatetime", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                conlogEntryByOffercommand.Parameters.AddWithValue("_IsRtfText", logEntryByOffer.IsRtfText);

                                conlogEntryByOffercommand.ExecuteNonQuery();
                                connlogEntryByOffer.Close();
                            }
                            catch (Exception ex)
                            {
                                throw;
                            }
                        }
                    }
                    else if (logEntryByOffer.IsDeleted && logEntryByOffer.IdLogEntry > 0)   //To delete offer comments used this block.
                    {
                        using (MySqlConnection connlogEntryByOffer = new MySqlConnection(offerPlantConnectionString))
                        {
                            connlogEntryByOffer.Open();

                            try
                            {
                                MySqlCommand conlogEntryByOffercommand = new MySqlCommand("logEntryByOffer_Delete", connlogEntryByOffer);
                                conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                                conlogEntryByOffercommand.Parameters.AddWithValue("_IdLogEntry", logEntryByOffer.IdLogEntry);

                                conlogEntryByOffercommand.ExecuteNonQuery();
                                connlogEntryByOffer.Close();
                            }
                            catch (Exception ex)
                            {
                                throw;
                            }

                        }
                    }
                    else    //To insert comments and log entries used this block.
                    {
                        using (MySqlConnection connlogEntryByOffer = new MySqlConnection(offerPlantConnectionString))
                        {
                            connlogEntryByOffer.Open();

                            try
                            {
                                MySqlCommand conlogEntryByOffercommand = new MySqlCommand("logEntryByOffer_Insert", connlogEntryByOffer);
                                conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                                conlogEntryByOffercommand.Parameters.AddWithValue("_IdOffer", IdOffer);
                                conlogEntryByOffercommand.Parameters.AddWithValue("_IdUser", logEntryByOffer.IdUser);
                                conlogEntryByOffercommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                                conlogEntryByOffercommand.Parameters.AddWithValue("_Comments", logEntryByOffer.Comments);
                                conlogEntryByOffercommand.Parameters.AddWithValue("_IdLogEntryType", logEntryByOffer.IdLogEntryType);
                                conlogEntryByOffercommand.Parameters.AddWithValue("_IsRtfText", logEntryByOffer.IsRtfText);

                                conlogEntryByOffercommand.ExecuteNonQuery();
                                connlogEntryByOffer.Close();
                            }
                            catch (Exception ex)
                            {
                                throw;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }
        }

        /// <summary>
        /// Sprint 22 - This method is added to add Offer contact to db. (Used transaction)
        /// </summary>
        /// <param name="offerContacts">The List of Offer Contacts</param>
        /// <param name="connectionString">The Emdep Site Connection string.</param>
        /// <param name="idOffer">The Id Offer.</param>
        public void AddOrderContact(List<OfferContact> offerContacts, string connectionString, Int64 idOffer)
        {
            try
            {
                if (offerContacts != null)
                {
                    foreach (OfferContact offerContact in offerContacts)
                    {
                        if (offerContact.IsDeleted)
                        {
                            bool isdelete = DeleteOrderContact(offerContact, connectionString);
                        }
                        else
                        {
                            using (MySqlConnection connlogEntryByOffer = new MySqlConnection(connectionString))
                            {
                                connlogEntryByOffer.Open();

                                try
                                {
                                    MySqlCommand conlogEntryByOffercommand = new MySqlCommand("offercontact_Insert", connlogEntryByOffer);
                                    conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                                    conlogEntryByOffercommand.Parameters.AddWithValue("_IdOffer", idOffer);
                                    conlogEntryByOffercommand.Parameters.AddWithValue("_IdContact", offerContact.IdContact);
                                    conlogEntryByOffercommand.Parameters.AddWithValue("_IsPrimaryOfferContact", offerContact.IsPrimaryOfferContact);

                                    int idOfferContact = Convert.ToInt32(conlogEntryByOffercommand.ExecuteScalar());

                                    connlogEntryByOffer.Close();
                                }
                                catch (Exception ex)
                                {
                                    throw;
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }
        }

        /// <summary>
        /// Sprint 22 - This method is used to delete order contact from order section. (Used in transaction)
        /// </summary>
        /// <param name="offerContact">The Offer contact details.</param>
        /// <param name="connectionString">The Emdep Site Connection string.</param>
        /// <returns>True, if Successful else False</returns>
        private bool DeleteOrderContact(OfferContact offerContact, string connectionString)
        {
            bool isDeleted = false;

            try
            {
                using (MySqlConnection connlogEntryByOffer = new MySqlConnection(connectionString))
                {
                    connlogEntryByOffer.Open();

                    try
                    {
                        MySqlCommand conlogEntryByOffercommand = new MySqlCommand("offercontacts_Delete", connlogEntryByOffer);
                        conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                        conlogEntryByOffercommand.Parameters.AddWithValue("_IdOffer", offerContact.IdOffer);
                        conlogEntryByOffercommand.Parameters.AddWithValue("_IdContact", offerContact.IdContact);

                        conlogEntryByOffercommand.ExecuteNonQuery();
                        isDeleted = true;

                        connlogEntryByOffer.Close();
                    }
                    catch (Exception ex)
                    {
                        throw;
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }

            return isDeleted;
        }

        /// <summary>
        /// Sprint 22 - This method is used to show all available activities with linked to offer account except current offer.
        /// </summary>
        /// <param name="idSite">The Site Id</param>
        /// <param name="idOffer">The IdOffer</param>
        /// <param name="idEmdepSite">The Emdep Site id.</param>
        /// <param name="connectionString">The connection string.</param>
        /// <returns></returns>
        public List<Activity> GetActivitiesLinkedToAccount(string idOwner, Int32 idPermission, string idPlant, Int32 idOfferAccount, Int64 idOffer, Int32 idEmdepSite, string connectionString)
        {
            List<Activity> listActivity = new List<Activity>();

            using (MySqlConnection connActivities = new MySqlConnection(connectionString))
            {
                connActivities.Open();
                MySqlCommand activitiesCommand = new MySqlCommand("activities_GetActivitiesLinkedToAccount", connActivities);
                activitiesCommand.CommandType = CommandType.StoredProcedure;

                activitiesCommand.Parameters.AddWithValue("_IdOwner", idOwner);
                activitiesCommand.Parameters.AddWithValue("_IdPermission", idPermission);
                activitiesCommand.Parameters.AddWithValue("_IdPlant", idPlant);
                activitiesCommand.Parameters.AddWithValue("_IdOfferAccount", idOfferAccount);
                activitiesCommand.Parameters.AddWithValue("_IdOffer", idOffer);
                activitiesCommand.Parameters.AddWithValue("_IdEmdepSite", idEmdepSite);

                using (MySqlDataReader activityReader = activitiesCommand.ExecuteReader())
                {
                    while (activityReader.Read())
                    {
                        Activity activity = new Activity();
                        activity.IdActivity = Convert.ToInt64(activityReader["IdActivity"].ToString());
                        activity.Subject = activityReader["Subject"].ToString();
                        activity.Description = activityReader["Description"].ToString();

                        if (activityReader["IdActivityType"] != DBNull.Value)
                        {
                            activity.LookupValue = new LookupValue();
                            activity.LookupValue.IdLookupValue = Convert.ToInt32(activityReader["IdActivityType"].ToString());
                            activity.LookupValue.Value = activityReader["ActivityType"].ToString();
                            activity.LookupValue.HtmlColor = activityReader["ActivityTypeHtmlColor"].ToString();

                            if (activityReader["ActivityTypeImage"] != DBNull.Value)
                                activity.LookupValue.IdImage = Convert.ToInt64(activityReader["ActivityTypeImage"].ToString());

                            if (activityReader["ActivityTypePosition"] != DBNull.Value)
                                activity.LookupValue.Position = Convert.ToInt32(activityReader["ActivityTypePosition"].ToString());
                        }

                        if (activityReader["FromDate"] != DBNull.Value)
                            activity.FromDate = Convert.ToDateTime(activityReader["FromDate"].ToString());

                        if (activityReader["ToDate"] != DBNull.Value)
                            activity.ToDate = Convert.ToDateTime(activityReader["ToDate"].ToString());

                        if (activityReader["CloseDate"] != DBNull.Value)
                            activity.CloseDate = Convert.ToDateTime(activityReader["CloseDate"].ToString());

                        //activity.Location = activityReader["Location"].ToString();

                        if (activityReader["IdOwner"] != DBNull.Value)
                            activity.IdOwner = Convert.ToInt32(activityReader["IdOwner"].ToString());

                        if (activityReader["IdOwner"] != DBNull.Value)
                        {
                            activity.People = new People();
                            activity.People.IdPerson = Convert.ToInt32(activityReader["IdOwner"].ToString());
                            activity.People.Name = activityReader["Name"].ToString();
                            activity.People.Surname = activityReader["Surname"].ToString();
                        }

                        //if (activityReader["Latitude"] != DBNull.Value)
                        //    activity.Latitude = Convert.ToDouble(activityReader["Latitude"].ToString());

                        //if (activityReader["Longitude"] != DBNull.Value)
                        //    activity.Longitude = Convert.ToDouble(activityReader["Longitude"].ToString());

                        if (activityReader["IsCompleted"] != DBNull.Value)
                        {
                            activity.IsCompleted = Convert.ToByte(activityReader["IsCompleted"].ToString());

                            //close filled when completing some activity.
                            if (activity.IsCompleted == 1)
                            {
                                activity.ActivityGridStatus = "Completed";

                                if (activityReader["CloseDate"] != DBNull.Value)
                                    activity.CloseDate = Convert.ToDateTime(activityReader["CloseDate"].ToString());
                            }
                        }

                        if (activityReader["IdActivityStatus"] != DBNull.Value)
                        {
                            activity.ActivityStatus = new LookupValue();
                            activity.ActivityStatus.IdLookupValue = Convert.ToInt32(activityReader["IdActivityStatus"].ToString());
                            activity.ActivityStatus.Value = activityReader["ActivityStatus"].ToString();
                            activity.ActivityStatus.HtmlColor = activityReader["ActivityStatusHtmlColor"].ToString();

                            if (activityReader["ActivityStatusImage"] != DBNull.Value)
                                activity.ActivityStatus.IdImage = Convert.ToInt64(activityReader["ActivityStatusImage"].ToString());

                            if (activityReader["ActivityStatusPosition"] != DBNull.Value)
                                activity.ActivityStatus.Position = Convert.ToInt32(activityReader["ActivityStatusPosition"].ToString());

                            if (activity.ActivityStatus.IdLookupValue == 48)
                            {
                                activity.ActivityGridStatus = "Completed";
                            }
                            else
                            {
                                activity.ActivityGridStatus = activityReader["ActivityStatus"].ToString();
                            }
                        }

                        listActivity.Add(activity);
                    }
                }
            }

            return listActivity;
        }

        /// <summary>
        /// Sprint 22 - This method is used to Add link Existing activity to Offer.
        /// </summary>
        /// <param name="NewlyLinkedActivities">The List of Newly linked the Activitites to Offer.</param>
        /// <param name="site">The Site with Connection string and Emdep Site od.</param>
        /// <param name="idOffer">The offer id to be linked.</param>
        public void AddLinkExistingActivityToOffer(string mainServerConnectionString, List<Activity> NewlyLinkedActivities, Company site, Int64 idOffer)
        {
            try
            {
                foreach (Activity activity in NewlyLinkedActivities)
                {
                    using (MySqlConnection connActivityLinkedItem = new MySqlConnection(mainServerConnectionString))
                    {
                        connActivityLinkedItem.Open();
                        //using (MySqlTransaction trans = connActivityLinkedItem.BeginTransaction())
                        //{
                        try
                        {
                            MySqlCommand linkedItemCommand = new MySqlCommand("activityLinkedItems_Insert", connActivityLinkedItem);
                            linkedItemCommand.CommandType = CommandType.StoredProcedure;

                            linkedItemCommand.Parameters.AddWithValue("_IdActivity", activity.IdActivity);
                            linkedItemCommand.Parameters.AddWithValue("_IdLinkedItemType", 44);
                            linkedItemCommand.Parameters.AddWithValue("_IdSite", null);
                            linkedItemCommand.Parameters.AddWithValue("_IdCarProject", null);
                            linkedItemCommand.Parameters.AddWithValue("_IdPerson", null);
                            linkedItemCommand.Parameters.AddWithValue("_IdOffer", idOffer);
                            linkedItemCommand.Parameters.AddWithValue("_IdEmdepSite", Convert.ToInt32(site.ConnectPlantId));
                            linkedItemCommand.Parameters.AddWithValue("_IdCompetitor", null);

                            //linkedItemCommand.Transaction = trans;
                            int idOfferContact = Convert.ToInt32(linkedItemCommand.ExecuteScalar());
                            //trans.Commit();
                            connActivityLinkedItem.Close();
                        }
                        catch (Exception ex)
                        {
                            //trans.Rollback();
                            throw;
                        }
                        //}
                    }

                    //if (offerContact.IsDeleted == true)
                    //{
                    //    Delete - Unlink
                    //    bool isdelete = IsDeletedOfferContact(offerContact, connectionstring);
                    //}
                    //else
                    //{
                    //    //insert - Link
                    //}
                }
            }
            catch (Exception ex)
            {
                throw;
            }
        }


        public List<Offer> GetReportOffersPerSalesUser(byte idCurrency, Int32 idUser, Int32 idZone, Int64 accountingYear, Company company, string Interval)
        {
            List<Offer> offers = new List<Offer>();

            DataSet ds = new DataSet();

            using (MySqlConnection connOffersPerSalesUser = new MySqlConnection(company.ConnectPlantConstr))
            {
                connOffersPerSalesUser.Open();

                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetReportOffersPerSalesUser", connOffersPerSalesUser);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idZone", idZone);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_interval", Interval);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);
                da.Fill(ds);
            }

            foreach (DataRow itemRow in ds.Tables[0].Rows)
            {
                Offer offer = new Offer();

                offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());
                if (itemRow["IdSalesOwner"] != DBNull.Value)
                {
                    offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                }
                offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());
                offer.Code = itemRow["OfferCode"].ToString();
                offer.Description = itemRow["OfferTitle"].ToString();

                offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };
                if (itemRow["IdSalesResponsible"] != DBNull.Value)
                {
                    offer.Site.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());
                }
                if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                {
                    offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());
                }
                offer.Site.ConnectPlantId = company.ConnectPlantId;

                offer.Site.Customer = new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() };
                offer.Site.Country = new Country { Name = itemRow["CustomerCountry"].ToString(), Zone = new Zone { Name = itemRow["CustomerZone"].ToString() } };
                offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(itemRow["OfferStatusid"].ToString()), Name = itemRow["OfferStatus"].ToString(), HtmlColor = itemRow["OfferStatusColor"].ToString() };
                //, SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["SalesStatusType"].ToString(), HtmlColor = itemRow["SalesStatusTypeColor"].ToString() } 

                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                offer.Currency = new Currency { IdCurrency = Convert.ToByte(itemRow["IdCurrency"].ToString()), Name = itemRow["OfferCurrency"].ToString() };
                if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                    offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                    offer.DeliveryDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString());
                else
                    offer.DeliveryDate = null;

                //if (itemRow["Rfq"] != DBNull.Value)
                //    offer.Rfq = itemRow["Rfq"].ToString();

                //if (itemRow["RFQReception"] != DBNull.Value)
                //    offer.RFQReception = Convert.ToDateTime(itemRow["RFQReception"].ToString());
                //else
                //    offer.RFQReception = null;

                if (itemRow["SendIn"] != DBNull.Value)
                    offer.SendIn = Convert.ToDateTime(itemRow["SendIn"].ToString());
                else
                    offer.SendIn = null;

                //if (itemRow["IdSource"] != DBNull.Value)
                //{
                //    offer.IdSource = Convert.ToByte(itemRow["IdSource"].ToString());
                //    offer.Source = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdSource"].ToString()), Value = itemRow["Source"].ToString() };
                //}

                //if (itemRow["IdBusinessUnit"] != DBNull.Value)
                //{
                //    offer.IdBusinessUnit = Convert.ToByte(itemRow["IdBusinessUnit"].ToString());
                //    offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdBusinessUnit"].ToString()), Value = itemRow["BusinessUnit"].ToString() };
                //}

                //if (itemRow["IdProject"] != DBNull.Value)
                //{
                //    offer.IdProject = Convert.ToInt32(itemRow["IdProject"].ToString());
                //    offer.Projects = new List<Project>();
                //    Project project = new Project();
                //    project.IdProject = Convert.ToInt32(itemRow["IdProject"].ToString());
                //    project.ProjectCode = itemRow["Code"].ToString();
                //    project.ProjectName = itemRow["Title"].ToString();
                //    offer.Projects.Add(project);
                //}

                //if (itemRow["IdCarProject"] != DBNull.Value)
                //{
                //    offer.IdCarProject = Convert.ToInt64(itemRow["IdCarProject"].ToString());
                //    offer.CarProject = new CarProject();

                //    offer.CarProject.IdCarProject = Convert.ToInt32(itemRow["IdCarProject"].ToString());
                //    offer.CarProject.Name = itemRow["CarProjectName"].ToString();
                //}

                //if (itemRow["IdCarOEM"] != DBNull.Value)
                //{
                //    offer.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                //    offer.CarOEM = new CarOEM();
                //    offer.CarOEM.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                //    offer.CarOEM.Name = itemRow["CarOEM"].ToString();
                //}

                if (offer.GeosStatus != null && offer.GeosStatus.IdOfferStatusType == 1)
                {
                    ///If some comment or some activity exists then Last activity date = latest comment or activity date
                    /// To get last activity date = latest comment date.
                    List<LogEntryByOffer> ListLogComments = GetAllCommentsByIdOffer(offer.IdOffer, company.ConnectPlantConstr).ToList();
                    if (ListLogComments.Count > 0)
                    {
                        int result = Nullable.Compare<DateTime>(ListLogComments[0].DateTime, offer.LastActivityDate);

                        if (result > 0)
                            offer.LastActivityDate = ListLogComments[0].DateTime;
                    }

                    /// To get Last activity date= latest activity creation date.
                    List<Activity> activities = GetActivitiesByIdOffer(offer.IdOffer, Convert.ToInt32(company.ConnectPlantId), company.ConnectPlantConstr).OrderByDescending(x => x.CreatedIn).ToList();
                    if (activities.Count > 0)
                    {
                        var activityDate = activities.Max(x => x.CreatedIn);
                        int result = Nullable.Compare<DateTime>(activityDate, offer.LastActivityDate);

                        if (result > 0)
                            offer.LastActivityDate = activityDate;
                    }

                    //If no comments and no linked activities then Last_activity_date= quote sent date
                    if (ListLogComments.Count == 0 && activities.Count == 0)
                    {
                        offer.LastActivityDate = offer.SendIn;
                    }
                }

                offers.Add(offer);
            }

            return offers;
        }

        public List<Activity> GetActivitiesGoingToDueInInverval(string mainConnectionString, string Interval)
        {
            List<Activity> listActivity = new List<Activity>();

            using (MySqlConnection connGetActivities = new MySqlConnection(mainConnectionString))
            {
                connGetActivities.Open();
                MySqlCommand conGetActivitiesCommand = new MySqlCommand("activities_GetActivitiesGoingToDueInInverval", connGetActivities);
                conGetActivitiesCommand.CommandType = CommandType.StoredProcedure;
                conGetActivitiesCommand.Parameters.AddWithValue("_interval", Interval);

                using (MySqlDataReader activityReader = conGetActivitiesCommand.ExecuteReader())
                {
                    while (activityReader.Read())
                    {
                        Activity activity = new Activity();
                        try
                        {
                            activity.IdActivity = Convert.ToInt64(activityReader["IdActivity"].ToString());

                            activity.Subject = activityReader["Subject"].ToString();
                            activity.Description = activityReader["Description"].ToString();

                            if (activityReader["IdActivityType"] != DBNull.Value)
                            {
                                activity.LookupValue = new LookupValue();
                                activity.LookupValue.IdLookupValue = Convert.ToInt32(activityReader["IdActivityType"].ToString());
                                activity.LookupValue.Value = activityReader["ActivityType"].ToString();
                                activity.LookupValue.HtmlColor = activityReader["ActivityTypeHtmlColor"].ToString();

                                if (activityReader["ActivityTypeImage"] != DBNull.Value)
                                    activity.LookupValue.IdImage = Convert.ToInt64(activityReader["ActivityTypeImage"].ToString());

                                if (activityReader["ActivityTypePosition"] != DBNull.Value)
                                    activity.LookupValue.Position = Convert.ToInt32(activityReader["ActivityTypePosition"].ToString());
                            }

                            if (activityReader["FromDate"] != DBNull.Value)
                                activity.FromDate = Convert.ToDateTime(activityReader["FromDate"].ToString());

                            if (activityReader["ToDate"] != DBNull.Value)
                                activity.ToDate = Convert.ToDateTime(activityReader["ToDate"].ToString());

                            activity.Location = activityReader["Location"].ToString();

                            if (activityReader["IdOwner"] != DBNull.Value)
                                activity.IdOwner = Convert.ToInt32(activityReader["IdOwner"].ToString());

                            if (activityReader["IdPerson"] != DBNull.Value)
                            {
                                activity.People = new People();
                                activity.People.IdPerson = Convert.ToInt32(activityReader["IdPerson"].ToString());
                                activity.People.Name = activityReader["Name"].ToString();
                                activity.People.Surname = activityReader["Surname"].ToString();
                                activity.People.Email = activityReader["Email"].ToString();
                            }

                            if (activityReader["Latitude"] != DBNull.Value)
                                activity.Latitude = Convert.ToDouble(activityReader["Latitude"].ToString());

                            if (activityReader["Longitude"] != DBNull.Value)
                                activity.Longitude = Convert.ToDouble(activityReader["Longitude"].ToString());

                            if (activityReader["IsCompleted"] != DBNull.Value)
                            {
                                activity.IsCompleted = Convert.ToByte(activityReader["IsCompleted"].ToString());

                                //close filled when completing some activity.
                                if (activity.IsCompleted == 1)
                                {
                                    activity.ActivityGridStatus = "Completed";

                                    if (activityReader["CloseDate"] != DBNull.Value)
                                        activity.CloseDate = Convert.ToDateTime(activityReader["CloseDate"].ToString());
                                }
                            }

                            if (activityReader["IdActivityStatus"] != DBNull.Value)
                            {
                                activity.ActivityStatus = new LookupValue();
                                activity.ActivityStatus.IdLookupValue = Convert.ToInt32(activityReader["IdActivityStatus"].ToString());
                                activity.ActivityStatus.Value = activityReader["ActivityStatus"].ToString();
                                activity.ActivityStatus.HtmlColor = activityReader["ActivityStatusHtmlColor"].ToString();

                                if (activityReader["ActivityStatusImage"] != DBNull.Value)
                                    activity.ActivityStatus.IdImage = Convert.ToInt64(activityReader["ActivityStatusImage"].ToString());

                                if (activityReader["ActivityStatusPosition"] != DBNull.Value)
                                    activity.ActivityStatus.Position = Convert.ToInt32(activityReader["ActivityStatusPosition"].ToString());

                                if (activity.ActivityStatus.IdLookupValue == 48)    // Done
                                {
                                    activity.ActivityGridStatus = "Completed";
                                }
                                else
                                {
                                    activity.ActivityGridStatus = activityReader["ActivityStatus"].ToString();
                                }
                            }

                            listActivity.Add(activity);
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }

                    }
                }
            }

            return listActivity;
        }


        public List<SalesUser> GetAllSalesUsersForReport(string connectionString)
        {
            List<SalesUser> salesUsers = new List<SalesUser>();
            DataTable dtsalesUser = new DataTable();

            using (MySqlConnection connSalesUsers = new MySqlConnection(connectionString))
            {
                connSalesUsers.Open();
                MySqlCommand salesUsersCommand = new MySqlCommand("salesusers_GetAllSalesUsersForReport", connSalesUsers);
                salesUsersCommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader salesUserReader = salesUsersCommand.ExecuteReader())
                {
                    while (salesUserReader.Read())
                    {
                        SalesUser salesUser = new SalesUser();

                        if (salesUserReader["IdSalesUser"] != DBNull.Value)
                            salesUser.IdSalesUser = Convert.ToInt32(salesUserReader["IdSalesUser"].ToString());

                        if (salesUserReader["IdSalesTeam"] != DBNull.Value)
                            salesUser.IdSalesTeam = Convert.ToInt32(salesUserReader["IdSalesTeam"].ToString());

                        salesUser.LookupValue = new LookupValue();
                        salesUser.LookupValue.IdLookupValue = Convert.ToInt32(salesUserReader["IdSalesTeam"].ToString());
                        salesUser.LookupValue.Value = salesUserReader["TeamUser"].ToString();

                        if (salesUserReader["IdPerson"] != DBNull.Value)
                        {
                            salesUser.People = new People();
                            salesUser.People.IdPerson = Convert.ToInt32(salesUserReader["IdPerson"].ToString());
                            salesUser.People.Name = salesUserReader["Name"].ToString();
                            salesUser.People.Surname = salesUserReader["Surname"].ToString();
                            salesUser.People.Email = salesUserReader["Email"].ToString();
                            salesUser.People.IsStillActive = Convert.ToByte(salesUserReader["IsStillActive"]);
                            salesUser.People.Phone = salesUserReader["Phone"].ToString();

                            if (salesUserReader["IdPersonGender"] != DBNull.Value)
                            {
                                salesUser.People.IdPersonGender = Convert.ToByte(salesUserReader["IdPersonGender"].ToString());
                                if (salesUser.People.IdPersonGender == 1)
                                    salesUser.People.UserGender = "Female";
                                else if (salesUser.People.IdPersonGender == 2)
                                    salesUser.People.UserGender = "Male";
                            }

                            salesUser.People.Company = new Company();
                            salesUser.People.Company.IdCompany = Convert.ToInt32(salesUserReader["IdSite"].ToString());
                            salesUser.People.Company.ShortName = salesUserReader["Office"].ToString();
                            salesUser.People.Company.Country = new Country();
                            salesUser.People.Company.Country.IdCountry = Convert.ToByte(salesUserReader["IdCountry"].ToString());
                            salesUser.People.Company.Country.Name = salesUserReader["Country"].ToString();
                            salesUser.People.Company.Country.Zone = new Zone();
                            salesUser.People.Company.Country.Zone.IdZone = Convert.ToInt32(salesUserReader["IdZone"].ToString());
                            salesUser.People.Company.Country.Zone.Name = salesUserReader["Region"].ToString();
                        }

                        salesUsers.Add(salesUser);
                    }
                }
            }

            return salesUsers;
        }


        public List<Offer> GetOffersByIdSiteToLinkedWithActivities(byte idCurrency, Int32 idUser, Int64 accountingYear, Company compdetails, Int32 idUserPermission, Int32 idSite)
        {
            List<Offer> offers = new List<Offer>();

            //DataSet ds = new DataSet();

            using (MySqlConnection connOffersByIdSiteForActivities = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                connOffersByIdSiteForActivities.Open();
                MySqlCommand offersCommand = new MySqlCommand("offers_GetOffersByIdSiteForActivities", connOffersByIdSiteForActivities);
                offersCommand.CommandType = CommandType.StoredProcedure;
                offersCommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                offersCommand.Parameters.AddWithValue("_idUser", idUser);
                offersCommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                offersCommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                offersCommand.Parameters.AddWithValue("_IdSite", idSite);
                MySqlDataAdapter da = new MySqlDataAdapter(offersCommand);
                //DataSet ds = new DataSet();
                //da.Fill(ds);

                using (MySqlDataReader itemRow = offersCommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            Offer offer = new Offer();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());
                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());
                            }

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());
                            }

                            offer.Site.ConnectPlantId = compdetails.ConnectPlantId;
                            offer.Site.Alias = compdetails.ShortName;

                            offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };
                            offer.Site.Country = new Country { Name = itemRow["CustomerCountry"].ToString(), Zone = new Zone { Name = itemRow["CustomerZone"].ToString() } };
                            offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(itemRow["OfferStatusid"].ToString()), Name = itemRow["OfferStatus"].ToString(), HtmlColor = itemRow["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["SalesStatusType"].ToString(), HtmlColor = itemRow["SalesStatusTypeColor"].ToString() } };
                            offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            offer.Currency = new Currency { IdCurrency = Convert.ToByte(itemRow["IdCurrency"].ToString()), Name = itemRow["OfferCurrency"].ToString() };
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            //if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                            //    offer.DeliveryDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString());
                            //else
                            //    offer.DeliveryDate = null;

                            //if (itemRow["Rfq"] != DBNull.Value)
                            //    offer.Rfq = itemRow["Rfq"].ToString();

                            //if (itemRow["RFQReception"] != DBNull.Value)
                            //    offer.RFQReception = Convert.ToDateTime(itemRow["RFQReception"].ToString());
                            //else
                            //    offer.RFQReception = null;

                            //if (itemRow["SendIn"] != DBNull.Value)
                            //    offer.SendIn = Convert.ToDateTime(itemRow["SendIn"].ToString());
                            //else
                            //    offer.SendIn = null;

                            //if (itemRow["IdSource"] != DBNull.Value)
                            //{
                            //    offer.IdSource = Convert.ToByte(itemRow["IdSource"].ToString());
                            //    offer.Source = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdSource"].ToString()), Value = itemRow["Source"].ToString() };
                            //}

                            //if (itemRow["IdBusinessUnit"] != DBNull.Value)
                            //{
                            //    offer.IdBusinessUnit = Convert.ToByte(itemRow["IdBusinessUnit"].ToString());
                            //    offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdBusinessUnit"].ToString()), Value = itemRow["BusinessUnit"].ToString() };
                            //}

                            //if (itemRow["IdProject"] != DBNull.Value)
                            //{
                            //    offer.IdProject = Convert.ToInt32(itemRow["IdProject"].ToString());
                            //    offer.Projects = new List<Project>();
                            //    Project project = new Project();
                            //    project.IdProject = Convert.ToInt32(itemRow["IdProject"].ToString());
                            //    project.ProjectCode = itemRow["Code"].ToString();
                            //    project.ProjectName = itemRow["Title"].ToString();
                            //    offer.Projects.Add(project);
                            //}

                            //if (itemRow["IdCarProject"] != DBNull.Value)
                            //{
                            //    offer.IdCarProject = Convert.ToInt64(itemRow["IdCarProject"].ToString());
                            //    offer.CarProject = new CarProject();

                            //    offer.CarProject.IdCarProject = Convert.ToInt32(itemRow["IdCarProject"].ToString());
                            //    offer.CarProject.Name = itemRow["CarProjectName"].ToString();
                            //}

                            //if (itemRow["IdCarOEM"] != DBNull.Value)
                            //{
                            //    offer.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                            //    offer.CarOEM = new CarOEM();
                            //    offer.CarOEM.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                            //    offer.CarOEM.Name = itemRow["CarOEM"].ToString();
                            //}

                            offers.Add(offer);
                        }
                    }
                }
            }

            return offers;
        }

        public List<Offer> GetOffersByIdSiteToLinkedWithActivities(byte idCurrency, Int32 idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company compdetails, Int32 idUserPermission, Int32 idSite)
        {
            List<Offer> offers = new List<Offer>();

            //DataSet ds = new DataSet();

            using (MySqlConnection connOffersByIdSiteForActivities = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                connOffersByIdSiteForActivities.Open();
                MySqlCommand offersCommand = new MySqlCommand("offers_GetOffersByIdSiteForActivitiesDatewise", connOffersByIdSiteForActivities);
                offersCommand.CommandType = CommandType.StoredProcedure;
                offersCommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                offersCommand.Parameters.AddWithValue("_idUser", idUser);
                offersCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                offersCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                offersCommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                offersCommand.Parameters.AddWithValue("_IdSite", idSite);
                MySqlDataAdapter da = new MySqlDataAdapter(offersCommand);
                //DataSet ds = new DataSet();
                //da.Fill(ds);

                using (MySqlDataReader itemRow = offersCommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            Offer offer = new Offer();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());
                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());
                            }

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());
                            }

                            offer.Site.ConnectPlantId = compdetails.ConnectPlantId;
                            offer.Site.Alias = compdetails.ShortName;

                            offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };
                            offer.Site.Country = new Country { Name = itemRow["CustomerCountry"].ToString(), Zone = new Zone { Name = itemRow["CustomerZone"].ToString() } };
                            offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(itemRow["OfferStatusid"].ToString()), Name = itemRow["OfferStatus"].ToString(), HtmlColor = itemRow["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["SalesStatusType"].ToString(), HtmlColor = itemRow["SalesStatusTypeColor"].ToString() } };
                            offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            offer.Currency = new Currency { IdCurrency = Convert.ToByte(itemRow["IdCurrency"].ToString()), Name = itemRow["OfferCurrency"].ToString() };
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            //if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                            //    offer.DeliveryDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString());
                            //else
                            //    offer.DeliveryDate = null;

                            //if (itemRow["Rfq"] != DBNull.Value)
                            //    offer.Rfq = itemRow["Rfq"].ToString();

                            //if (itemRow["RFQReception"] != DBNull.Value)
                            //    offer.RFQReception = Convert.ToDateTime(itemRow["RFQReception"].ToString());
                            //else
                            //    offer.RFQReception = null;

                            //if (itemRow["SendIn"] != DBNull.Value)
                            //    offer.SendIn = Convert.ToDateTime(itemRow["SendIn"].ToString());
                            //else
                            //    offer.SendIn = null;

                            //if (itemRow["IdSource"] != DBNull.Value)
                            //{
                            //    offer.IdSource = Convert.ToByte(itemRow["IdSource"].ToString());
                            //    offer.Source = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdSource"].ToString()), Value = itemRow["Source"].ToString() };
                            //}

                            //if (itemRow["IdBusinessUnit"] != DBNull.Value)
                            //{
                            //    offer.IdBusinessUnit = Convert.ToByte(itemRow["IdBusinessUnit"].ToString());
                            //    offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(itemRow["IdBusinessUnit"].ToString()), Value = itemRow["BusinessUnit"].ToString() };
                            //}

                            //if (itemRow["IdProject"] != DBNull.Value)
                            //{
                            //    offer.IdProject = Convert.ToInt32(itemRow["IdProject"].ToString());
                            //    offer.Projects = new List<Project>();
                            //    Project project = new Project();
                            //    project.IdProject = Convert.ToInt32(itemRow["IdProject"].ToString());
                            //    project.ProjectCode = itemRow["Code"].ToString();
                            //    project.ProjectName = itemRow["Title"].ToString();
                            //    offer.Projects.Add(project);
                            //}

                            //if (itemRow["IdCarProject"] != DBNull.Value)
                            //{
                            //    offer.IdCarProject = Convert.ToInt64(itemRow["IdCarProject"].ToString());
                            //    offer.CarProject = new CarProject();

                            //    offer.CarProject.IdCarProject = Convert.ToInt32(itemRow["IdCarProject"].ToString());
                            //    offer.CarProject.Name = itemRow["CarProjectName"].ToString();
                            //}

                            //if (itemRow["IdCarOEM"] != DBNull.Value)
                            //{
                            //    offer.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                            //    offer.CarOEM = new CarOEM();
                            //    offer.CarOEM.IdCarOEM = Convert.ToInt32(itemRow["IdCarOEM"].ToString());
                            //    offer.CarOEM.Name = itemRow["CarOEM"].ToString();
                            //}

                            offers.Add(offer);
                        }
                    }
                }
            }

            return offers;
        }


        /// <summary>
        /// [CRM-M025-04] Automatic task suggestion wizzard.
        /// This method is used to get task 
        /// </summary>
        /// <param name="workbenchConnectionString">The workbench connection string.</param>
        /// <returns></returns>
        public List<ActivityTemplateTrigger> GetActivityTemplateTriggers(string workbenchConnectionString)
        {
            List<ActivityTemplateTrigger> activityTemplateTriggers = new List<ActivityTemplateTrigger>();

            using (MySqlConnection connActivityTemplateTriggers = new MySqlConnection(workbenchConnectionString))
            {
                connActivityTemplateTriggers.Open();

                MySqlCommand activityTriggersCommand = new MySqlCommand("activities_GetActivityTriggers", connActivityTemplateTriggers);
                activityTriggersCommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader activityTriggersReader = activityTriggersCommand.ExecuteReader())
                {
                    while (activityTriggersReader.Read())
                    {
                        ActivityTemplateTrigger activityTemplateTrigger = null;

                        if (activityTriggersReader["IdActivityTemplateTrigger"] != DBNull.Value)
                        {
                            if (activityTemplateTriggers.Exists(x => x.IdActivityTemplateTrigger == Convert.ToInt16(activityTriggersReader["IdActivityTemplateTrigger"])))
                            {
                                activityTemplateTrigger = activityTemplateTriggers.FirstOrDefault(x => x.IdActivityTemplateTrigger == Convert.ToInt16(activityTriggersReader["IdActivityTemplateTrigger"]));
                            }
                            else
                            {
                                activityTemplateTrigger = new ActivityTemplateTrigger();
                                activityTemplateTrigger.IdActivityTemplateTrigger = Convert.ToInt16(activityTriggersReader["IdActivityTemplateTrigger"].ToString());

                                if (activityTriggersReader["IdLinkedObject"] != DBNull.Value)
                                {
                                    activityTemplateTrigger.IdLinkedObject = Convert.ToInt16(activityTriggersReader["IdLinkedObject"].ToString());

                                    activityTemplateTrigger.LinkedObject = new LookupValue();
                                    activityTemplateTrigger.LinkedObject.IdLookupValue = Convert.ToInt16(activityTriggersReader["IdLinkedObject"].ToString());
                                    activityTemplateTrigger.LinkedObject.Value = Convert.ToString(activityTriggersReader["Value"]);
                                }

                                if (activityTriggersReader["LinkedObjectFieldName"] != DBNull.Value)
                                {
                                    activityTemplateTrigger.LinkedObjectFieldName = Convert.ToString(activityTriggersReader["LinkedObjectFieldName"]);
                                }

                                if (activityTriggersReader["LinkedObjectFieldValue"] != DBNull.Value)
                                {
                                    activityTemplateTrigger.LinkedObjectFieldValue = Convert.ToString(activityTriggersReader["LinkedObjectFieldValue"]);
                                }

                                // Trigger Condition.
                                if (activityTriggersReader["IdActivityTemplateTriggerCondition"] != DBNull.Value)
                                {
                                    ActivityTemplateTriggerCondition activityTemplateTriggerCondition = new ActivityTemplateTriggerCondition();

                                    activityTemplateTriggerCondition.IdActivityTemplateTriggerCondition = Convert.ToInt16(activityTriggersReader["IdActivityTemplateTriggerCondition"]);

                                    if (activityTriggersReader["ConditionFieldName"] != DBNull.Value)
                                    {
                                        activityTemplateTriggerCondition.ConditionFieldName = Convert.ToString(activityTriggersReader["ConditionFieldName"]);
                                    }

                                    if (activityTriggersReader["ConditionOperator"] != DBNull.Value)
                                    {
                                        activityTemplateTriggerCondition.ConditionOperator = Convert.ToString(activityTriggersReader["ConditionOperator"]);
                                    }

                                    if (activityTriggersReader["ConditionFieldValue"] != DBNull.Value)
                                    {
                                        activityTemplateTriggerCondition.ConditionFieldValue = Convert.ToString(activityTriggersReader["ConditionFieldValue"]);
                                    }

                                    if (activityTriggersReader["ConditionFieldType"] != DBNull.Value)
                                    {
                                        activityTemplateTriggerCondition.ConditionFieldType = Convert.ToString(activityTriggersReader["ConditionFieldType"]);
                                    }

                                    if (activityTriggersReader["IsUserConfirmationRequired"] != DBNull.Value)
                                    {
                                        activityTemplateTriggerCondition.IsUserConfirmationRequired = Convert.ToByte(activityTriggersReader["IsUserConfirmationRequired"]);
                                    }

                                    activityTemplateTrigger.ActivityTemplateTriggerCondition = activityTemplateTriggerCondition;
                                }

                                // Activity Templates
                                activityTemplateTrigger.ActivityTemplates = new List<ActivityTemplate>();

                                activityTemplateTriggers.Add(activityTemplateTrigger);
                            }
                        }

                        // Templates based on condition
                        if (activityTriggersReader["IdActivityTemplate"] != DBNull.Value)
                        {
                            if (!activityTemplateTrigger.ActivityTemplates.Any(x => x.IdActivityTemplate == Convert.ToInt16(activityTriggersReader["IdActivityTemplate"])))
                            {
                                ActivityTemplate activityTemplate = new ActivityTemplate();

                                if (activityTriggersReader["IdActivityType"] != DBNull.Value)
                                {
                                    activityTemplate.IdActivityTemplate = Convert.ToInt16(activityTriggersReader["IdActivityTemplate"]);

                                    if (activityTriggersReader["ActivityType"] != DBNull.Value)
                                    {
                                        activityTemplate.IdActivityType = Convert.ToInt16(activityTriggersReader["IdActivityType"]);

                                        activityTemplate.ActivityType = new LookupValue();
                                        activityTemplate.ActivityType.IdLookupValue = activityTemplate.IdActivityType;
                                        activityTemplate.ActivityType.Value = Convert.ToString(activityTriggersReader["ActivityType"]);
                                    }
                                }

                                if (activityTriggersReader["Subject"] != DBNull.Value)
                                {
                                    activityTemplate.Subject = Convert.ToString(activityTriggersReader["Subject"]);
                                }

                                if (activityTriggersReader["Description"] != DBNull.Value)
                                {
                                    activityTemplate.Description = Convert.ToString(activityTriggersReader["Description"]);
                                }

                                if (activityTriggersReader["DueDaysAfterCreation"] != DBNull.Value)
                                {
                                    activityTemplate.DueDaysAfterCreation = Convert.ToInt16(activityTriggersReader["DueDaysAfterCreation"]);
                                }

                                activityTemplateTrigger.ActivityTemplates.Add(activityTemplate);
                            }
                        }
                    }
                }
            }

            return activityTemplateTriggers;
        }


        public void AddLogEntriesByContact(Int32 idContact, List<LogEntriesByContact> logEntriesByContact, string mainServerConnectionString)
        {
            if (logEntriesByContact != null)
            {
                foreach (LogEntriesByContact logEntryContact in logEntriesByContact)
                {
                    using (MySqlConnection connLogEntries = new MySqlConnection(mainServerConnectionString))
                    {
                        connLogEntries.Open();

                        MySqlCommand logEntriesCommand = new MySqlCommand("logEntriesByContact_Insert", connLogEntries);
                        logEntriesCommand.CommandType = CommandType.StoredProcedure;

                        logEntriesCommand.Parameters.AddWithValue("_IdContact", idContact);
                        logEntriesCommand.Parameters.AddWithValue("_IdUser", logEntryContact.IdUser);
                        logEntriesCommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                        logEntriesCommand.Parameters.AddWithValue("_IdLogEntryType", logEntryContact.IdLogEntryType);
                        logEntriesCommand.Parameters.AddWithValue("_Comments", logEntryContact.Comments);
                        logEntriesCommand.Parameters.AddWithValue("_IsRtfText", logEntryContact.IsRtfText);

                        logEntriesCommand.ExecuteScalar();
                        connLogEntries.Close();
                    }
                }
            }
        }


        public void AddUpdateDeleteCommentsByContact(Int32 idContact, List<LogEntriesByContact> logEntriesByContact, string mainServerConnectionString)
        {
            if (logEntriesByContact != null)
            {
                try
                {
                    foreach (LogEntriesByContact logEntryContact in logEntriesByContact)
                    {
                        if (logEntryContact.IsUpdated)
                        {
                            using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                            {
                                mySqlConnection.Open();

                                MySqlCommand updateCommentCommand = new MySqlCommand("logEntriesByContact_Update", mySqlConnection);
                                updateCommentCommand.CommandType = CommandType.StoredProcedure;
                                updateCommentCommand.Parameters.AddWithValue("_IdLogEntryByContact", logEntryContact.IdLogEntryByContact);
                                updateCommentCommand.Parameters.AddWithValue("_Comments", logEntryContact.Comments);
                                updateCommentCommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                                updateCommentCommand.Parameters.AddWithValue("_IsRtfText", logEntryContact.IsRtfText);

                                updateCommentCommand.ExecuteScalar();
                                mySqlConnection.Close();
                            }
                        }
                        else if (logEntryContact.IsDeleted)
                        {
                            using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                            {
                                mySqlConnection.Open();

                                MySqlCommand deleteCommentCommand = new MySqlCommand("logEntriesByContact_Delete", mySqlConnection);
                                deleteCommentCommand.CommandType = CommandType.StoredProcedure;
                                deleteCommentCommand.Parameters.AddWithValue("_IdLogEntryByContact", logEntryContact.IdLogEntryByContact);

                                deleteCommentCommand.ExecuteNonQuery();
                                mySqlConnection.Close();
                            }
                        }
                        else
                        {
                            using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                            {
                                mySqlConnection.Open();

                                MySqlCommand insertCommentsCommand = new MySqlCommand("logEntriesByContact_Insert", mySqlConnection);
                                insertCommentsCommand.CommandType = CommandType.StoredProcedure;

                                insertCommentsCommand.Parameters.AddWithValue("_IdContact", idContact);
                                insertCommentsCommand.Parameters.AddWithValue("_IdUser", logEntryContact.IdUser);
                                insertCommentsCommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                                insertCommentsCommand.Parameters.AddWithValue("_IdLogEntryType", logEntryContact.IdLogEntryType);
                                insertCommentsCommand.Parameters.AddWithValue("_Comments", logEntryContact.Comments);
                                insertCommentsCommand.Parameters.AddWithValue("_IsRtfText", logEntryContact.IsRtfText);

                                logEntryContact.IdLogEntryByContact = Convert.ToInt32(insertCommentsCommand.ExecuteScalar());
                                mySqlConnection.Close();
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    throw;
                }
            }
        }

        public List<LogEntriesByContact> GetLogEntriesByContact(Int32 idContact, byte idLogEntryType, string mainConnectionString)
        {
            List<LogEntriesByContact> listLogEntriesByActivity = new List<LogEntriesByContact>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(mainConnectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("logEntryContact_GetlogEntriesByContact", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdContact", idContact);
                mySqlCommand.Parameters.AddWithValue("_IdLogEntryType", idLogEntryType);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        LogEntriesByContact logEntryContact = new LogEntriesByContact();
                        logEntryContact.IdContact = idContact;
                        logEntryContact.IdLogEntryByContact = Convert.ToInt64(reader["IdLogEntryByContact"]);

                        if (reader["IdUser"] != DBNull.Value)
                        {
                            logEntryContact.IdUser = Convert.ToInt32(reader["IdUser"]);

                            logEntryContact.User = new People();
                            logEntryContact.User.IdPerson = logEntryContact.IdUser;
                            logEntryContact.User.Name = Convert.ToString(reader["Name"]);
                            logEntryContact.User.Surname = Convert.ToString(reader["Surname"]);

                            if (reader["Login"] != DBNull.Value)
                                logEntryContact.User.Login = Convert.ToString(reader["Login"]);

                            if (reader["IdUserGender"] != DBNull.Value)
                                logEntryContact.User.IdPersonGender = Convert.ToByte(reader["IdUserGender"]);
                        }

                        if (reader["Datetime"] != DBNull.Value)
                            logEntryContact.Datetime = Convert.ToDateTime(reader["Datetime"]);

                        if (reader["Comments"] != DBNull.Value)
                            logEntryContact.Comments = Convert.ToString(reader["Comments"]);

                        if (reader["IdLogEntryType"] != DBNull.Value)
                            logEntryContact.IdLogEntryType = Convert.ToByte(reader["IdLogEntryType"]);

                        if (reader["IsRtfText"] != DBNull.Value)
                            logEntryContact.IsRtfText = Convert.ToBoolean(reader["IsRtfText"]);

                        listLogEntriesByActivity.Add(logEntryContact);
                    }
                }
            }

            return listLogEntriesByActivity;
        }

        public List<People> GetAllSalesUserByIdSalesTeam(Int32 idSalesTeam, string connectionstring)
        {
            List<People> listpeople = new List<People>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("salesusers_GetAllSalesUserByIdSalesTeam", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdSalesTeam", idSalesTeam);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        People people = new People();
                        people.IdPerson = Convert.ToInt32(reader["IdSalesUser"].ToString());
                        people.Name = reader["Name"].ToString();
                        people.Surname = reader["Surname"].ToString();
                        if (reader["IdPersonGender"] != DBNull.Value)
                            people.IdPersonGender = Convert.ToByte(reader["IdPersonGender"]);
                        listpeople.Add(people);
                    }
                }
            }

            return listpeople;


        }


        public List<Competitor> GetAllCompetitor(string connectionstring)
        {
            List<Competitor> listCompetitor = new List<Competitor>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("competitors_GetCompetitors", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Competitor competitor = new Competitor();
                        competitor.IdCompetitor = Convert.ToInt32(reader["IdCompetitor"].ToString());
                        competitor.Name = reader["Name"].ToString();

                        listCompetitor.Add(competitor);
                    }
                }
            }

            return listCompetitor;
        }

        public List<People> GetAllSalesUser(string connectionstring)
        {
            List<People> listPeople = new List<People>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("salesusers_GetAllSalesUser", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        People people = new People();
                        people.IdPerson = Convert.ToInt32(reader["IdSalesUser"].ToString());
                        if (reader["IdSalesTeam"] != DBNull.Value)
                            people.IdSalesTeam = Convert.ToInt32(reader["IdSalesTeam"].ToString());

                        people.Name = reader["Name"].ToString();
                        people.Surname = reader["Surname"].ToString();

                        if (reader["IdPersonGender"] != DBNull.Value)
                            people.IdPersonGender = Convert.ToByte(reader["IdPersonGender"].ToString());
                        listPeople.Add(people);
                    }
                }
            }

            return listPeople;
        }



        public People GetIdSalesTeamByIdSalesUser(Int32 idSalesUser, string connectionstring)
        {
            People peopleSaleUser = new People();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("salesusers_GetIdSalesTeamByIdSalesUser", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdSalesUser", idSalesUser);
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {

                        peopleSaleUser.IdPerson = Convert.ToInt32(reader["IdSalesUser"].ToString());
                        if (reader["IdSalesTeam"] != DBNull.Value)
                            peopleSaleUser.IdSalesTeam = Convert.ToInt32(reader["IdSalesTeam"].ToString());
                        peopleSaleUser.Name = reader["Name"].ToString();
                        peopleSaleUser.FullName = reader["Surname"].ToString();
                        if (reader["IdPersonGender"] != DBNull.Value)
                            peopleSaleUser.IdPersonGender = Convert.ToByte(reader["IdPersonGender"].ToString());

                    }
                }
            }

            return peopleSaleUser;
        }

        /// <summary>
        /// [001][2018-07-06][skhade][CRM-M042-05] Replacement of current exchange rates section.
        /// This method is used to get all daily currency conversions by date.
        /// </summary>
        /// <param name="workbenchConnectionString">The workbench connection string (emdep_geos).</param>
        /// <param name="fromDate">The fromdate from custom period.</param>
        /// <param name="toDate">The toDate from custom period.</param>
        /// <returns>The list of daily currency Conversions.</returns>
        public List<DailyCurrencyConversion> GetAllDailyCurrencyConversionsByDate(string workbenchConnectionString, DateTime fromDate, DateTime toDate)
        {
            List<DailyCurrencyConversion> dailyCurrencyConversions = new List<DailyCurrencyConversion>();

            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(workbenchConnectionString))
                {
                    mySqlConnection.Open();
                    MySqlCommand mySqlCommand = new MySqlCommand("currency_conversions_GetAllCurrencyConversionsByDate", mySqlConnection);
                    mySqlCommand.CommandType = CommandType.StoredProcedure;
                    mySqlCommand.Parameters.AddWithValue("_FromDate", fromDate);
                    mySqlCommand.Parameters.AddWithValue("_ToDate", toDate);

                    using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            DailyCurrencyConversion dailyCurrencyConversion = new DailyCurrencyConversion();

                            if (reader["IdCurrencyConversion"] != DBNull.Value)
                                dailyCurrencyConversion.IdCurrencyConversion = Convert.ToInt64(reader["IdCurrencyConversion"]);

                            if (reader["CurrencyConversionDate"] != DBNull.Value)
                                dailyCurrencyConversion.CurrencyConversionDate = Convert.ToDateTime(reader["CurrencyConversionDate"]);

                            if (reader["IdCurrencyConversionFrom"] != DBNull.Value)
                            {
                                dailyCurrencyConversion.IdCurrencyConversionFrom = Convert.ToByte(reader["IdCurrencyConversionFrom"]);

                                dailyCurrencyConversion.CurrencyFrom = new Currency();
                                dailyCurrencyConversion.CurrencyFrom.Name = Convert.ToString(reader["CurrencyFrom"]);
                            }

                            if (reader["IdCurrencyConversionTo"] != DBNull.Value)
                            {
                                dailyCurrencyConversion.IdCurrencyConversionTo = Convert.ToByte(reader["IdCurrencyConversionTo"]);

                                dailyCurrencyConversion.CurrencyTo = new Currency();
                                dailyCurrencyConversion.CurrencyTo.Name = Convert.ToString(reader["CurrencyTo"]);
                            }

                            if (reader["CurrencyConversionRate"] != DBNull.Value)
                                dailyCurrencyConversion.CurrencyConversationRate = Convert.ToSingle(reader["CurrencyConversionRate"]);

                            if (reader["IsCorrect"] != DBNull.Value)
                                dailyCurrencyConversion.IsCorrect = Convert.ToByte(reader["IsCorrect"]);

                            dailyCurrencyConversions.Add(dailyCurrencyConversion);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }

            return dailyCurrencyConversions;
        }

        public DailyCurrencyConversion AddCurrencyConversion(string mainServerConnectionString, DailyCurrencyConversion dailyCurrencyConversion)
        {
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("currency_conversions_Insert", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_CurrencyConversionDate", dailyCurrencyConversion.CurrencyConversionDate);
                        mySqlCommand.Parameters.AddWithValue("_IdCurrencyConversionFrom", dailyCurrencyConversion.IdCurrencyConversionFrom);
                        mySqlCommand.Parameters.AddWithValue("_IdCurrencyConversionTo", dailyCurrencyConversion.IdCurrencyConversionTo);
                        mySqlCommand.Parameters.AddWithValue("_CurrencyConversionRate", dailyCurrencyConversion.CurrencyConversationRate);
                        mySqlCommand.Parameters.AddWithValue("_IsCorrect", dailyCurrencyConversion.IsCorrect);
                        dailyCurrencyConversion.IdCurrencyConversion = Convert.ToInt32(mySqlCommand.ExecuteScalar());
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();

                throw;
            }

            return dailyCurrencyConversion;
        }

        public DailyCurrencyConversion UpdateCurrencyConversionDaily(string mainServerConnectionString, DailyCurrencyConversion dailyCurrencyConversion)
        {
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("currency_conversions_Update", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_CurrencyConversionDate", dailyCurrencyConversion.CurrencyConversionDate);
                        mySqlCommand.Parameters.AddWithValue("_IdCurrencyConversionFrom", dailyCurrencyConversion.IdCurrencyConversionFrom);
                        mySqlCommand.Parameters.AddWithValue("_IdCurrencyConversionTo", dailyCurrencyConversion.IdCurrencyConversionTo);
                        mySqlCommand.Parameters.AddWithValue("_CurrencyConversionRate", dailyCurrencyConversion.CurrencyConversationRate);
                        mySqlCommand.Parameters.AddWithValue("_IsCorrect", dailyCurrencyConversion.IsCorrect);
                        dailyCurrencyConversion.IdCurrencyConversion = Convert.ToInt32(mySqlCommand.ExecuteScalar());
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();

                throw;
            }

            return dailyCurrencyConversion;
        }

        public bool UpdateCurrencyConversionListDaily(string mainServerConnectionString, List<DailyCurrencyConversion> dailyCurrencyConversionList)
        {
            using (TransactionScope transactionScope = new TransactionScope())
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                {
                    try
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("currency_conversions_Update", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        foreach (DailyCurrencyConversion dailyCurrencyConversion in dailyCurrencyConversionList)
                        {
                            mySqlCommand.Parameters.Clear();

                            mySqlCommand.Parameters.AddWithValue("_CurrencyConversionDate", dailyCurrencyConversion.CurrencyConversionDate);
                            mySqlCommand.Parameters.AddWithValue("_IdCurrencyConversionFrom", dailyCurrencyConversion.IdCurrencyConversionFrom);
                            mySqlCommand.Parameters.AddWithValue("_IdCurrencyConversionTo", dailyCurrencyConversion.IdCurrencyConversionTo);
                            mySqlCommand.Parameters.AddWithValue("_CurrencyConversionRate", dailyCurrencyConversion.CurrencyConversationRate);
                            mySqlCommand.Parameters.AddWithValue("_IsCorrect", dailyCurrencyConversion.IsCorrect);

                            mySqlCommand.ExecuteNonQuery();

                            //dailyCurrencyConversion.IdCurrencyConversion = Convert.ToInt32(mySqlCommand.ExecuteScalar());
                        }

                        mySqlConnection.Close();
                        transactionScope.Complete();
                        transactionScope.Dispose();
                    }
                    catch (Exception ex)
                    {
                        if (Transaction.Current != null)
                            Transaction.Current.Rollback();

                        if (transactionScope != null)
                            transactionScope.Dispose();

                        throw;
                    }
                }
            }

            return true;
        }

        public bool UpdateReadOnlyActivityLogs(Activity activity, string mainServerConnectionString, string activityAttachmentPath)
        {

            bool isUpdated = false;

            TransactionScope transactionScope = null;

            try
            {
                using (transactionScope = new System.Transactions.TransactionScope())
                {
                    using (MySqlConnection connUpdateActivity = new MySqlConnection(mainServerConnectionString))
                    {
                        connUpdateActivity.Open();

                        MySqlCommand updateActivityCommand = new MySqlCommand("activitiesReadOnly_Update", connUpdateActivity);
                        updateActivityCommand.CommandType = CommandType.StoredProcedure;

                        updateActivityCommand.Parameters.AddWithValue("_ModifiedBy", activity.ModifiedBy);
                        updateActivityCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        updateActivityCommand.Parameters.AddWithValue("_IdActivity", activity.IdActivity);

                        //concompanycommand.Transaction = trans;
                        updateActivityCommand.ExecuteNonQuery();

                        connUpdateActivity.Close();

                        isUpdated = true;
                        //trans.Commit();

                        if (isUpdated == true)
                        {
                            AddLogEntriesByActivity(activity.IdActivity, activity.LogEntriesByActivity, mainServerConnectionString);
                            UpdateCommentsByActivity(activity.CommentsByActivity, mainServerConnectionString);

                            if (activity.ActivityAttachment != null && activity.ActivityAttachment.Count > 0)
                                AddActivityAttachment(activity, activity.ActivityAttachment, mainServerConnectionString, activityAttachmentPath);
                        }

                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                transactionScope.Dispose();
                throw;
            }

            return isUpdated;
        }

        public List<Activity> GetPlannedAppointmentAndAppointment(string connectionstring, Int32 idOwner, DateTime accountingYearFrom, DateTime accountingYearTo)
        {
            List<Activity> listActivities = new List<Activity>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("activities_GetAppoinmentActivities", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdOwner", idOwner);
                mySqlCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                mySqlCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Activity activity = new Activity();
                        activity.IdActivity = Convert.ToInt32(reader["IdActivity"].ToString());
                        if (reader["FromDate"] != DBNull.Value)
                            activity.FromDate = Convert.ToDateTime(reader["FromDate"].ToString());
                        if (reader["ToDate"] != DBNull.Value)
                            activity.ToDate = Convert.ToDateTime(reader["ToDate"].ToString());
                        if (reader["CloseDate"] != DBNull.Value)
                            activity.CloseDate = Convert.ToDateTime(reader["CloseDate"].ToString());
                        if (reader["IsCompleted"] != DBNull.Value)
                            activity.IsCompleted = Convert.ToByte(reader["IsCompleted"].ToString());
                        if (reader["IdActivityType"] != DBNull.Value)
                            activity.IdActivityType = Convert.ToByte(reader["IdActivityType"].ToString());

                        listActivities.Add(activity);
                    }
                }
            }

            return listActivities;
        }

        public List<Activity> GetPlannedAppiontmentByUserId(string connectionstring, Int32 idActiveUser, DateTime accountingYearFrom, DateTime accountingYearTo)
        {
            List<Activity> listActivities = new List<Activity>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("activities_GetPlannedAppiontmentByUserId", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdActiveUser", idActiveUser);
                mySqlCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                mySqlCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Activity activity = new Activity();

                        activity.IdActivity = Convert.ToInt32(reader["IdActivity"].ToString());
                        if (reader["FromDate"] != DBNull.Value)
                            activity.FromDate = Convert.ToDateTime(reader["FromDate"].ToString());
                        if (reader["ToDate"] != DBNull.Value)
                            activity.ToDate = Convert.ToDateTime(reader["ToDate"].ToString());
                        if (reader["CloseDate"] != DBNull.Value)
                            activity.CloseDate = Convert.ToDateTime(reader["CloseDate"].ToString());
                        if (reader["IdActivityType"] != DBNull.Value)
                            activity.IdActivityType = Convert.ToByte(reader["IdActivityType"].ToString());
                        if (reader["IdOwner"] != DBNull.Value)
                            activity.IdOwner = Convert.ToInt32(reader["IdOwner"].ToString());

                        activity.ActivityLinkedItem = new List<ActivityLinkedItem>();
                        ActivityLinkedItem activityLinkedItem = new ActivityLinkedItem();

                        if (reader["IdActivityLinkedItem"] != DBNull.Value)
                            activityLinkedItem.IdActivityLinkedItem = Convert.ToInt32(reader["IdActivityLinkedItem"].ToString());
                        if (reader["IdSite"] != DBNull.Value)
                            activityLinkedItem.IdSite = Convert.ToInt32(reader["IdSite"].ToString());
                        if (reader["IdLinkedItemType"] != DBNull.Value)
                            activityLinkedItem.IdLinkedItemType = Convert.ToInt32(reader["IdLinkedItemType"].ToString());

                        activity.ActivityLinkedItem.Add(activityLinkedItem);

                        listActivities.Add(activity);
                    }
                }
            }

            return listActivities;
        }

        public List<Offer> GetOffersEngineeringAnalysisByPermission(byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, Int32 idUserPermission, string rdDotProjectConnectionString)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                mySqlConnection.Open();

                MySqlCommand sqlCommand = new MySqlCommand("offers_GetOffersEngAnalysisDateWiseAndpermission", mySqlConnection);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.CommandTimeout = 3000;
                sqlCommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                sqlCommand.Parameters.AddWithValue("_idUser", idUser);
                sqlCommand.Parameters.AddWithValue("_idZone", idZone);
                sqlCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                sqlCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                sqlCommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader reader = sqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Offer offer = new Offer();
                        try
                        {
                            offer.IdOffer = Convert.ToInt64(reader["idoffer"].ToString());

                            if (reader["IdSalesOwner"] != DBNull.Value)
                                offer.IdSalesOwner = Convert.ToInt32(reader["IdSalesOwner"]);

                            offer.IdOfferType = Convert.ToByte(reader["IdOfferType"]);
                            offer.Code = Convert.ToString(reader["OfferCode"]);
                            offer.Description = Convert.ToString(reader["OfferTitle"]);

                            offer.Site = new Company();
                            offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;

                            offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(reader["OfferStatusid"].ToString()), Name = reader["OfferStatus"].ToString(), HtmlColor = reader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(reader["IdSalesStatusType"].ToString()), Name = reader["SalesStatusType"].ToString(), HtmlColor = reader["SalesStatusTypeColor"].ToString() } };

                            if (reader["DeliveryDate"] != DBNull.Value)
                                offer.DeliveryDate = Convert.ToDateTime(reader["OtDeliveryDate"]);

                            if (reader["IdBusinessUnit"] != DBNull.Value)
                            {
                                offer.IdBusinessUnit = Convert.ToByte(reader["IdBusinessUnit"].ToString());
                                offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(reader["IdBusinessUnit"].ToString()), Value = reader["BusinessUnit"].ToString() };
                            }

                            offer.PartNumber = new PartNumbers();
                            offer.PartNumber.IdPartNumber = Convert.ToInt32(reader["idPartNumber"].ToString());
                            offer.PartNumber.Code = Convert.ToString(reader["PartNumberCode"]);

                            offer.PartNumber.PartNumbersTracking = new PartNumbersTracking();
                            if (reader["StartDate"] != DBNull.Value)
                                offer.PartNumber.PartNumbersTracking.StartDate = Convert.ToDateTime(reader["StartDate"].ToString());

                            if (reader["EndDate"] != DBNull.Value)
                                offer.PartNumber.PartNumbersTracking.EndDate = Convert.ToDateTime(reader["EndDate"].ToString());

                            offer.PartNumber.PartNumbersTracking.StageOperator = new People();
                            if (reader["IdOperator"] != DBNull.Value)
                            {
                                offer.PartNumber.PartNumbersTracking.StageOperator.IdPerson = Convert.ToInt32(reader["IdOperator"].ToString());
                                offer.PartNumber.PartNumbersTracking.StageOperator.Name = Convert.ToString(reader["Name"]);
                                offer.PartNumber.PartNumbersTracking.StageOperator.Surname = Convert.ToString(reader["Surname"]);
                            }

                            //offer.TaskAssigned = new People();
                            offer.TaskAssigned = GetTaskOwnerOfProjectByOfferCode(offer.Code, rdDotProjectConnectionString);

                            offers.Add(offer);
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }
                    }
                }
            }

            return offers;
        }

        public List<Offer> GetSelectedOffersEngAnalysisDateWise(string idUser, byte idCurrency, Int32 idCurrentUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, string rdDotProjectConnectionString)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                mySqlConnection.Open();
                MySqlCommand sqlCommand = new MySqlCommand("offers_GetSelectedOffersEngAnalysisDateWise", mySqlConnection);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.CommandTimeout = 3000;
                sqlCommand.Parameters.AddWithValue("_idUser", idUser);
                sqlCommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                sqlCommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                sqlCommand.Parameters.AddWithValue("_idZone", idZone);
                sqlCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                sqlCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);


                using (MySqlDataReader reader = sqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Offer offer = new Offer();
                        try
                        {
                            offer.IdOffer = Convert.ToInt64(reader["idoffer"]);

                            if (reader["IdSalesOwner"] != DBNull.Value)
                                offer.IdSalesOwner = Convert.ToInt32(reader["IdSalesOwner"]);

                            offer.IdOfferType = Convert.ToByte(reader["IdOfferType"]);
                            offer.Code = Convert.ToString(reader["OfferCode"]);
                            offer.Description = Convert.ToString(reader["OfferTitle"]);

                            offer.Site = new Company();
                            offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;

                            offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(reader["OfferStatusid"]), Name = Convert.ToString(reader["OfferStatus"]), HtmlColor = Convert.ToString(reader["OfferStatusColor"]), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(reader["IdSalesStatusType"]), Name = Convert.ToString(reader["SalesStatusType"]), HtmlColor = Convert.ToString(reader["SalesStatusTypeColor"]) } };

                            if (reader["DeliveryDate"] != DBNull.Value)
                                offer.DeliveryDate = Convert.ToDateTime(reader["OtDeliveryDate"]);

                            if (reader["IdBusinessUnit"] != DBNull.Value)
                            {
                                offer.IdBusinessUnit = Convert.ToByte(reader["IdBusinessUnit"]);
                                offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(reader["IdBusinessUnit"]), Value = Convert.ToString(reader["BusinessUnit"]) };
                            }

                            offer.PartNumber = new PartNumbers();
                            offer.PartNumber.IdPartNumber = Convert.ToInt32(reader["idPartNumber"]);
                            offer.PartNumber.Code = Convert.ToString(reader["PartNumberCode"]);

                            offer.PartNumber.PartNumbersTracking = new PartNumbersTracking();
                            if (reader["StartDate"] != DBNull.Value)
                                offer.PartNumber.PartNumbersTracking.StartDate = Convert.ToDateTime(reader["StartDate"]);

                            if (reader["EndDate"] != DBNull.Value)
                                offer.PartNumber.PartNumbersTracking.EndDate = Convert.ToDateTime(reader["EndDate"]);

                            offer.PartNumber.PartNumbersTracking.StageOperator = new People();
                            if (reader["IdOperator"] != DBNull.Value)
                            {
                                offer.PartNumber.PartNumbersTracking.StageOperator.IdPerson = Convert.ToInt32(reader["IdOperator"]);
                                offer.PartNumber.PartNumbersTracking.StageOperator.Name = Convert.ToString(reader["Name"]);
                                offer.PartNumber.PartNumbersTracking.StageOperator.Surname = Convert.ToString(reader["Surname"]);
                            }

                            //offer.TaskAssigned = new People();
                            offer.TaskAssigned = GetTaskOwnerOfProjectByOfferCode(offer.Code, rdDotProjectConnectionString);

                            offers.Add(offer);
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }
                    }
                }
            }

            return offers;
        }

        public People GetTaskOwnerOfProjectByOfferCode(string offerCode, string rdDotProjectconnectionString)
        {
            People people = new People();

            using (MySqlConnection conpeople = new MySqlConnection(rdDotProjectconnectionString))
            {
                conpeople.Open();
                MySqlCommand sqlCommand = new MySqlCommand("people_GetTaskOwnerByOfferCode", conpeople);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.Parameters.AddWithValue("_offerCode", offerCode);
                using (MySqlDataReader peopleDataReader = sqlCommand.ExecuteReader())
                {
                    if (peopleDataReader.Read())
                    {
                        try
                        {
                            people.Name = peopleDataReader["Name"].ToString();
                            people.Surname = peopleDataReader["Surname"].ToString();
                            people.Email = peopleDataReader["Email"].ToString();
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }
                    }
                }
            }

            return people;
        }

        public List<WarehouseCategory> GetWarehouseCategories(string connectionString)
        {
            try
            {
                List<ArticleCategory> articleCategories = GetArticleCategories(connectionString);
                List<Article> articles = GetAllArticles(connectionString);

                List<WarehouseCategory> warehouseCategories = new List<WarehouseCategory>();

                foreach (ArticleCategory articleCategory in articleCategories)
                {
                    WarehouseCategory wc = new WarehouseCategory();

                    wc.IdKey = articleCategory.IdArticleCategory;
                    wc.BaseName = articleCategory.Name;
                    wc.IdParent = articleCategory.Parent;
                    wc.IdArticleCategory = articleCategory.IdArticleCategory;
                    warehouseCategories.Add(wc);
                }

                int index = -1;
                foreach (Article article in articles)
                {
                    WarehouseCategory wc = new WarehouseCategory();

                    wc.IdKey = index;
                    wc.BaseName = article.Reference;
                    wc.IdParent = articleCategories.FirstOrDefault(x => x.IdArticleCategory == article.IdArticleCategory).IdArticleCategory;
                    wc.IdArticle = article.IdArticle;
                    wc.IdArticleCategory = article.IdArticleCategory;
                    warehouseCategories.Add(wc);

                    index--;
                }


                return warehouseCategories;
            }
            catch (Exception ex)
            {
                throw;
            }

            return null;
        }


        public List<ArticleCategory> GetArticleCategories(string connectionstring)
        {

            List<ArticleCategory> articleCategories = new List<ArticleCategory>();

            using (MySqlConnection conCountry = new MySqlConnection(connectionstring))
            {
                conCountry.Open();

                MySqlCommand conCountrycommand = new MySqlCommand("crm_GetArticleCategories", conCountry);
                conCountrycommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader reader = conCountrycommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ArticleCategory articleCategory = new ArticleCategory();
                        articleCategory.IdArticleCategory = Convert.ToInt64(reader["IdArticleCategory"]);

                        if (reader["Name"] != DBNull.Value)
                            articleCategory.Name = Convert.ToString(reader["Name"]);

                        if (reader["Parent"] != DBNull.Value)
                            articleCategory.Parent = Convert.ToInt64(reader["Parent"]);

                        if (reader["IsLeaf"] != DBNull.Value)
                            articleCategory.IsLeaf = Convert.ToByte(reader["IsLeaf"]);

                        if (reader["Position"] != DBNull.Value)
                            articleCategory.Position = Convert.ToInt64(reader["Position"]);

                        if (reader["TaricCode"] != DBNull.Value)
                            articleCategory.TaricCode = Convert.ToString(reader["TaricCode"]);

                        if (reader["NCM_Code"] != DBNull.Value)
                            articleCategory.NCM_Code = Convert.ToString(reader["NCM_Code"]);

                        if (reader["HS_Code"] != DBNull.Value)
                            articleCategory.HS_Code = Convert.ToString(reader["HS_Code"]);

                        articleCategories.Add(articleCategory);
                    }
                }
            }

            return articleCategories;
        }


        public List<Article> GetAllArticles(string connectionString)
        {
            List<Article> articles = new List<Article>();

            using (MySqlConnection conCountry = new MySqlConnection(connectionString))
            {
                conCountry.Open();

                MySqlCommand conCountrycommand = new MySqlCommand("Crm_GetAllArticles", conCountry);
                conCountrycommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader reader = conCountrycommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Article article = new Article();

                        article.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                        if (reader["Reference"] != DBNull.Value)
                            article.Reference = Convert.ToString(reader["Reference"]);

                        if (reader["IdArticleCategory"] != DBNull.Value)
                            article.IdArticleCategory = Convert.ToInt32(reader["IdArticleCategory"]);

                        articles.Add(article);
                    }
                }
            }

            return articles;
        }

        public List<ArticleBySupplier> GetArticlesBySupplier(string connectionstring, string idCompanies = null)
        {
            List<ArticleBySupplier> articlesBySupplier = new List<ArticleBySupplier>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("crm_GetArticlesBySupplier", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdCompanies", idCompanies);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    Int64 childIndex = -1;
                    while (reader.Read())
                    {
                        ArticleBySupplier articleBySupplier = new ArticleBySupplier();

                        if (reader["IdArticleSupplier"] != DBNull.Value)
                        {
                            articleBySupplier.IdArticleSupplier = Convert.ToInt64(reader["IdArticleSupplier"]);

                            articleBySupplier.ArticleSupplier = new ArticleSupplier();
                            articleBySupplier.ArticleSupplier.IdArticleSupplier = articleBySupplier.IdArticleSupplier;

                            if (reader["SupplierName"] != DBNull.Value)
                                articleBySupplier.ArticleSupplier.Name = Convert.ToString(reader["SupplierName"]);
                        }

                        if (reader["IdArticle"] != DBNull.Value)
                        {
                            articleBySupplier.IdArticle = Convert.ToInt64(reader["IdArticle"]);

                            articleBySupplier.Article = new Article();
                            articleBySupplier.Article.IdArticle = Convert.ToInt32(articleBySupplier.IdArticle);

                            if (reader["Reference"] != DBNull.Value)
                                articleBySupplier.Article.Reference = Convert.ToString(reader["Reference"]);

                            if (reader["Description"] != DBNull.Value)
                                articleBySupplier.Article.Description = Convert.ToString(reader["Description"]);
                        }

                        articleBySupplier.IdChild = childIndex;
                        childIndex--;

                        articlesBySupplier.Add(articleBySupplier);
                    }
                }
            }

            return articlesBySupplier;
        }


        public List<Offer> GetArticlesReportDetails(string connectionString, Int32 idActiveUser, Company company, DateTime fromDate, DateTime toDate, byte idCurrency, string idArticles)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection connOffersByIdSiteForActivities = new MySqlConnection(company.ConnectPlantConstr))
            {
                connOffersByIdSiteForActivities.Open();
                MySqlCommand offersCommand = new MySqlCommand("GetArticlesReportDetails", connOffersByIdSiteForActivities);
                offersCommand.CommandType = CommandType.StoredProcedure;

                offersCommand.Parameters.AddWithValue("_IdActiveUser", idActiveUser);
                offersCommand.Parameters.AddWithValue("_FromDate", fromDate);
                offersCommand.Parameters.AddWithValue("_ToDate", toDate);
                offersCommand.Parameters.AddWithValue("_IdCurrency", idCurrency);
                offersCommand.Parameters.AddWithValue("_IdArticles", idArticles);

                using (MySqlDataReader reader = offersCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            Offer offer = new Offer();

                            offer.IdOffer = Convert.ToInt64(reader["idoffer"]);
                            offer.Code = reader["OfferCode"].ToString();

                            offer.Site = new Company();
                            offer.Site.IdCompany = Convert.ToInt32(reader["IdSite"].ToString());
                            offer.Site.Name = Convert.ToString(reader["SiteName"]);
                            offer.Site.ConnectPlantId = company.ConnectPlantId;
                            offer.Site.Alias = company.Alias;
                            offer.Site.ShortName = company.ShortName;
                            offer.Site.Country = new Country { Zone = new Zone { Name = Convert.ToString(reader["CustomerZone"]) } };

                            offer.Site.Customer = new Customer();
                            offer.Site.Customer.IdCustomer = Convert.ToInt32(reader["IdCustomer"].ToString());
                            offer.Site.Customer.CustomerName = Convert.ToString(reader["CustomerName"]);

                            offer.Quotations = new List<Quotation>();
                            Quotation quot = new Quotation();
                            quot.IdQuotation = Convert.ToInt32(reader["IdQuotation"]);

                            quot.Template = new Template();
                            quot.Template.IdTemplate = Convert.ToByte(reader["IdDetectionsTemplate"]);
                            quot.Template.Name = Convert.ToString(reader["TemplateName"]);
                            quot.Template.Type = Convert.ToInt64(reader["TemplateType"]);

                            quot.Ots = new List<Ots>();
                            Ots ot = new Ots();
                            ot.Code = Convert.ToString(reader["OTCode"]);
                            ot.NumOT = Convert.ToByte(reader["NumOT"]);

                            ot.OtItems = new List<OtItem>();
                            OtItem otitem = new OtItem();
                            otitem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                            otitem.RevisionItem = new RevisionItem();
                            otitem.RevisionItem.IdRevisionItem = Convert.ToInt64(reader["IdRevisionItem"]);

                            otitem.RevisionItem.NumItem = Convert.ToString(reader["NumItem"]);

                            otitem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                            otitem.RevisionItem.WarehouseProduct.Article = new Article();

                            if (reader["IdArticle"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                            if (reader["IsObsolete"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.IsObsolete = Convert.ToSByte(reader["IsObsolete"]);

                            if (reader["Reference"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.Reference = Convert.ToString(reader["Reference"]);

                            if (reader["ArticleDescription"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.Description = Convert.ToString(reader["ArticleDescription"]);

                            if (reader["Quantity"] != DBNull.Value)
                                otitem.RevisionItem.Quantity = Convert.ToDecimal(reader["Quantity"]);

                            if (reader["DeliveryDate"] != DBNull.Value)
                                otitem.ShippingDate = Convert.ToDateTime(reader["DeliveryDate"]);

                            otitem.RevisionItem.WarehouseProduct.Article.ArticleBySupplier = new ArticleBySupplier();

                            if (reader["ConvertedCostPrice"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.ArticleBySupplier.CostPrice = Convert.ToDouble(reader["ConvertedCostPrice"]);

                            otitem.RevisionItem.WarehouseProduct.Article.ArticleBySupplier.ArticleSupplier = new ArticleSupplier();

                            if (reader["ArticleSupplierName"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.ArticleBySupplier.ArticleSupplier.Name = Convert.ToString(reader["ArticleSupplierName"]);

                            if (reader["ConvertedSellPrice"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.SellPrice = Convert.ToDouble(reader["ConvertedSellPrice"]);

                            ot.OtItems.Add(otitem);
                            quot.Ots.Add(ot);
                            offer.Quotations.Add(quot);
                            offers.Add(offer);
                        }
                    }
                }
            }

            return offers;
        }


        public List<Offer> GetOffersByIdCustomerToLinkedWithActivities(byte idCurrency, Int32 idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company compdetails, Int32 idUserPermission, Int32 idCustomer)
        {
            List<Offer> offers = new List<Offer>();

            //DataSet ds = new DataSet();

            using (MySqlConnection connOffersByIdSiteForActivities = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                connOffersByIdSiteForActivities.Open();
                MySqlCommand offersCommand = new MySqlCommand("offers_GetOffersByIdCustomerForActivitiesDatewise", connOffersByIdSiteForActivities);
                offersCommand.CommandType = CommandType.StoredProcedure;
                offersCommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                offersCommand.Parameters.AddWithValue("_idUser", idUser);
                offersCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                offersCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                offersCommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                offersCommand.Parameters.AddWithValue("_IdCustomer", idCustomer);

                //MySqlDataAdapter da = new MySqlDataAdapter(offersCommand);
                //DataSet ds = new DataSet();
                //da.Fill(ds);

                using (MySqlDataReader itemRow = offersCommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            Offer offer = new Offer();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());
                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString(), SiteNameWithoutCountry = itemRow["SiteWithCountryName"].ToString() };

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());
                            }

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());
                            }

                            offer.Site.ConnectPlantId = compdetails.ConnectPlantId;
                            offer.Site.Alias = compdetails.ShortName;

                            offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };
                            offer.Site.Country = new Country { Name = itemRow["CustomerCountry"].ToString(), Zone = new Zone { Name = itemRow["CustomerZone"].ToString() } };
                            offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(itemRow["OfferStatusid"].ToString()), Name = itemRow["OfferStatus"].ToString(), HtmlColor = itemRow["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["SalesStatusType"].ToString(), HtmlColor = itemRow["SalesStatusTypeColor"].ToString() } };

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            offer.Currency = new Currency { IdCurrency = Convert.ToByte(itemRow["IdCurrency"].ToString()), Name = itemRow["OfferCurrency"].ToString() };
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());



                            offers.Add(offer);
                        }
                    }
                }
            }

            return offers;
        }


        public IList<LookupValue> GetLookupvaluesWithoutRestrictedBU(Int32 idUser, Int32 idUserPermission, string connectionString)
        {
            IList<LookupValue> LstlookupValue = new List<LookupValue>();

            //DataSet ds = new DataSet();

            using (MySqlConnection connOffersByIdSiteForActivities = new MySqlConnection(connectionString))
            {
                connOffersByIdSiteForActivities.Open();
                MySqlCommand offersCommand = new MySqlCommand("lookupvalues_GetlookupvaluesWithoutRestrictedBU", connOffersByIdSiteForActivities);
                offersCommand.CommandType = CommandType.StoredProcedure;
                offersCommand.Parameters.AddWithValue("_idUser", idUser);
                offersCommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                MySqlDataAdapter da = new MySqlDataAdapter(offersCommand);

                using (MySqlDataReader itemRow = offersCommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            LookupValue lookupValue = new LookupValue();
                            if (itemRow["IdLookupValue"] != DBNull.Value)
                                lookupValue.IdLookupValue = Convert.ToInt32(itemRow["IdLookupValue"].ToString());
                            lookupValue.Value = itemRow["Value"].ToString();
                            lookupValue.HtmlColor = itemRow["HtmlColor"].ToString();

                            if (itemRow["IdImage"] != DBNull.Value)
                            {
                                lookupValue.IdImage = Convert.ToInt64(itemRow["IdImage"].ToString());
                            }
                            if (itemRow["Position"] != DBNull.Value)
                            {
                                lookupValue.Position = Convert.ToInt32(itemRow["Position"].ToString());
                            }
                            if (itemRow["InUse"] != DBNull.Value)
                            {
                                lookupValue.InUse = Convert.ToBoolean(itemRow["InUse"].ToString());
                            }
                            LstlookupValue.Add(lookupValue);
                        }
                    }
                }
            }

            return LstlookupValue;
        }


        public List<PlantBusinessUnitSalesQuota> GetPlantSalesQuotaWithYearByIdUserPermissionwise(string connectionstring, Int32 idUser, byte idCurrency, Int32 accountingYear, Int32 idUserPermission)
        {
            List<PlantBusinessUnitSalesQuota> plantBusinessUnitSalesQuotas = new List<PlantBusinessUnitSalesQuota>();
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("GetPlantSalesQuotaWithYearByIdUserPermissionwise", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idUser", idUser);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idCurrency", idCurrency);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    while (lostReasonsByOfferreader.Read())
                    {
                        if (plantBusinessUnitSalesQuotas.Any(pb => pb.ShortName == lostReasonsByOfferreader["ShortName"].ToString()))
                        {
                            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();
                            plantBusinessUnitSalesQuota = plantBusinessUnitSalesQuotas.Where(pb => pb.ShortName == lostReasonsByOfferreader["ShortName"].ToString()).FirstOrDefault();
                            if (lostReasonsByOfferreader["IdPlant"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(lostReasonsByOfferreader["IdPlant"].ToString());
                            if (lostReasonsByOfferreader["IdBusinessUnit"] != DBNull.Value)
                            {
                                plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                LookupValue lv = new LookupValue();
                                lv.IdLookupValue = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                lv.Value = lostReasonsByOfferreader["Value"].ToString();
                                if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                    lv.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                                if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                    lv.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue.Add(lv);
                            }
                            if (lostReasonsByOfferreader["Year"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.Year = Convert.ToInt32(lostReasonsByOfferreader["Year"].ToString());
                            if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                            if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                            plantBusinessUnitSalesQuota.ShortName = lostReasonsByOfferreader["ShortName"].ToString();

                        }
                        else
                        {
                            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();
                            plantBusinessUnitSalesQuota.ShortName = lostReasonsByOfferreader["ShortName"].ToString();
                            if (lostReasonsByOfferreader["IdPlant"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(lostReasonsByOfferreader["IdPlant"].ToString());
                            if (lostReasonsByOfferreader["IdBusinessUnit"] != DBNull.Value)
                            {
                                plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue = new List<LookupValue>();
                                LookupValue lv = new LookupValue();
                                lv.IdLookupValue = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                lv.Value = lostReasonsByOfferreader["Value"].ToString();
                                if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                    lv.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                                if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                    lv.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue.Add(lv);
                            }

                            if (lostReasonsByOfferreader["Year"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.Year = Convert.ToInt32(lostReasonsByOfferreader["Year"].ToString());

                            if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());

                            if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());

                            plantBusinessUnitSalesQuotas.Add(plantBusinessUnitSalesQuota);
                        }
                    }
                }
            }
            return plantBusinessUnitSalesQuotas;
        }


        public List<PlantBusinessUnitSalesQuota> GetPlantSalesQuotaWithYearByIdUserPermissionDatewise(string connectionstring, Int32 idUser, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, Int32 idUserPermission)
        {
            List<PlantBusinessUnitSalesQuota> plantBusinessUnitSalesQuotas = new List<PlantBusinessUnitSalesQuota>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("GetPlantSalesQuotaWithYearByIdUserPermissionDatewise", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;

                mySqlCommand.Parameters.AddWithValue("_idUser", idUser);
                mySqlCommand.Parameters.AddWithValue("_idCurrency", idCurrency);
                mySqlCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                mySqlCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                mySqlCommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        if (reader["Year"] != DBNull.Value && plantBusinessUnitSalesQuotas.Any(pb => pb.IdPlant == Convert.ToInt32(reader["IdPlant"]) && pb.Year == Convert.ToInt32(reader["Year"])))
                        {
                            //PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();
                            //plantBusinessUnitSalesQuota = plantBusinessUnitSalesQuotas.Where(pb => pb.ShortName == reader["ShortName"].ToString()).FirstOrDefault();

                            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = plantBusinessUnitSalesQuotas.FirstOrDefault(pb => pb.IdPlant == Convert.ToInt32(reader["IdPlant"]) && pb.Year == Convert.ToInt32(reader["Year"]));

                            if (plantBusinessUnitSalesQuota != null)
                            {
                                //if (reader["IdPlant"] != DBNull.Value)
                                //    plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(reader["IdPlant"].ToString());

                                if (reader["IdBusinessUnit"] != DBNull.Value)
                                {
                                    //plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(reader["IdBusinessUnit"].ToString());

                                    LookupValue lv = new LookupValue();
                                    lv.IdLookupValue = Convert.ToInt32(reader["IdBusinessUnit"].ToString());
                                    lv.Value = reader["Value"].ToString();

                                    if (reader["IdSalesQuotaCurrency"] != DBNull.Value)
                                        lv.IdSalesQuotaCurrency = Convert.ToByte(reader["IdSalesQuotaCurrency"].ToString());

                                    if (reader["SalesQuotaAmount"] != DBNull.Value)
                                        lv.SalesQuotaAmount = Convert.ToDouble(reader["SalesQuotaAmount"].ToString());

                                    plantBusinessUnitSalesQuota.LookupValue.Add(lv);
                                }

                                //if (reader["Year"] != DBNull.Value)
                                //    plantBusinessUnitSalesQuota.Year = Convert.ToInt32(reader["Year"].ToString());

                                //if (reader["SalesQuotaAmount"] != DBNull.Value)
                                //    plantBusinessUnitSalesQuota.SalesQuotaAmount = Convert.ToDouble(reader["SalesQuotaAmount"].ToString());

                                //if (reader["IdSalesQuotaCurrency"] != DBNull.Value)
                                //    plantBusinessUnitSalesQuota.IdSalesQuotaCurrency = Convert.ToByte(reader["IdSalesQuotaCurrency"].ToString());

                                //plantBusinessUnitSalesQuota.ShortName = reader["ShortName"].ToString();
                            }
                        }
                        else
                        {
                            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();
                            plantBusinessUnitSalesQuota.ShortName = reader["ShortName"].ToString();

                            if (reader["IdPlant"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(reader["IdPlant"].ToString());

                            if (reader["IdBusinessUnit"] != DBNull.Value)
                            {
                                plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(reader["IdBusinessUnit"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue = new List<LookupValue>();

                                LookupValue lv = new LookupValue();
                                lv.IdLookupValue = Convert.ToInt32(reader["IdBusinessUnit"].ToString());
                                lv.Value = reader["Value"].ToString();

                                if (reader["IdSalesQuotaCurrency"] != DBNull.Value)
                                    lv.IdSalesQuotaCurrency = Convert.ToByte(reader["IdSalesQuotaCurrency"].ToString());

                                if (reader["SalesQuotaAmount"] != DBNull.Value)
                                    lv.SalesQuotaAmount = Convert.ToDouble(reader["SalesQuotaAmount"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue.Add(lv);
                            }

                            if (reader["Year"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.Year = Convert.ToInt32(reader["Year"].ToString());

                            if (reader["SalesQuotaAmount"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.SalesQuotaAmount = Convert.ToDouble(reader["SalesQuotaAmount"].ToString());

                            if (reader["IdSalesQuotaCurrency"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdSalesQuotaCurrency = Convert.ToByte(reader["IdSalesQuotaCurrency"].ToString());

                            plantBusinessUnitSalesQuotas.Add(plantBusinessUnitSalesQuota);
                        }
                    }
                }
            }
            return plantBusinessUnitSalesQuotas.OrderBy(x => x.IdPlant).ThenBy(y => y.Year).ToList();
        }


        public List<CpType> GetAllCpTypes(string connectionString)
        {
            List<CpType> cpTypes = new List<CpType>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("Crm_GetAllCpTypes", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        CpType cpType = new CpType();

                        cpType.IdCPType = Convert.ToByte(reader["IdCPType"]);

                        cpType.Name = Convert.ToString(reader["Name"]);

                        cpTypes.Add(cpType);
                    }
                }
            }

            return cpTypes;
        }

        public List<CpType> GetCpTypesByTemplate(string connectionString, byte idTemplate)
        {
            List<CpType> cpTypes = new List<CpType>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("Crm_GetCpTypesByTemplate", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdTemplate", idTemplate);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        CpType cpType = new CpType();

                        cpType.IdCPType = Convert.ToByte(reader["IdCPType"]);

                        cpType.Name = Convert.ToString(reader["Name"]);

                        cpTypes.Add(cpType);
                    }
                }
            }

            return cpTypes;
        }


        public List<Detection> GetDetectionByCpTypeAndTemplate(string connectionString, byte idTemplate, byte idCPType)
        {
            List<Detection> detections = new List<Detection>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString))
            {
                mySqlConnection.Open();

                MySqlCommand conCountrycommand = new MySqlCommand("Crm_GetDetectionByTemplateAndCpType", mySqlConnection);
                conCountrycommand.CommandType = CommandType.StoredProcedure;
                conCountrycommand.Parameters.AddWithValue("_IdTemplate", idTemplate);
                conCountrycommand.Parameters.AddWithValue("_IdCPType", idCPType);

                using (MySqlDataReader reader = conCountrycommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Detection detection = new Detection();

                        detection.IdDetection = Convert.ToUInt32(reader["IdDetection"]);

                        detection.Name = Convert.ToString(reader["Name"]);

                        detection.CpType = new CpType();
                        detection.CpType.IdCPType = Convert.ToByte(reader["IdCPType"]);
                        detection.CpType.Name = Convert.ToString(reader["Name"]);

                        detections.Add(detection);
                    }
                }
            }

            return detections;
        }

        public List<Offer> GetModulesReportDetails(Int32 idActiveUser, Company company, DateTime fromDate, DateTime toDate, Int32? idCompany, byte? idTemplate, byte? idCPType, string idDetections, byte idCurrency, Int32? idCustomer = null)
        {
            //Get all details
            List<Offer> offers = new List<Offer>();
            //Int64[] arrayRevisionItems = new Int64[] { };.
            List<Int64> revisionItemsList = new List<Int64>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(company.ConnectPlantConstr))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("GetModulesReportDetails", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.CommandTimeout = 4000;

                mySqlCommand.Parameters.AddWithValue("_IdActiveUser", idActiveUser);
                mySqlCommand.Parameters.AddWithValue("_FromDate", fromDate);
                mySqlCommand.Parameters.AddWithValue("_ToDate", toDate);
                mySqlCommand.Parameters.AddWithValue("_IdCurrency", idCurrency);
                mySqlCommand.Parameters.AddWithValue("_IdCustomer", idCustomer);
                mySqlCommand.Parameters.AddWithValue("_IdCompany", idCompany);
                mySqlCommand.Parameters.AddWithValue("_IdTemplate", idTemplate);
                mySqlCommand.Parameters.AddWithValue("_IdCPType", idCPType);
                mySqlCommand.Parameters.AddWithValue("_IdDetections", idDetections);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                Offer offer = new Offer();

                                offer.IdOffer = Convert.ToInt64(reader["idoffer"]);
                                offer.Code = Convert.ToString(reader["OfferCode"]);

                                offer.Site = new Company();
                                offer.Site.IdCompany = Convert.ToInt32(reader["IdSite"].ToString());
                                offer.Site.Name = Convert.ToString(reader["SiteName"]);
                                offer.Site.Country = new Country { Zone = new Zone { Name = Convert.ToString(reader["CustomerZone"]) } };

                                offer.Site.Customer = new Customer();
                                offer.Site.Customer.IdCustomer = Convert.ToInt32(reader["IdCustomer"].ToString());
                                offer.Site.Customer.CustomerName = Convert.ToString(reader["CustomerName"]);

                                //SITE column
                                offer.Site.Alias = company.Alias;
                                offer.Site.ShortName = company.ShortName;

                                offer.Quotations = new List<Quotation>();
                                Quotation quot = new Quotation();
                                quot.IdQuotation = Convert.ToInt32(reader["IdQuotation"]);

                                quot.Template = new Template();
                                quot.Template.IdTemplate = Convert.ToByte(reader["IdDetectionsTemplate"]);
                                quot.Template.Name = Convert.ToString(reader["TemplateName"]);
                                quot.Template.Type = Convert.ToInt64(reader["TemplateType"]);

                                // Customer specification/Normative
                                if (reader["IdTechnicalTemplate"] != DBNull.Value)
                                {
                                    quot.IdTechnicalTemplate = Convert.ToUInt32(reader["IdTechnicalTemplate"]);
                                    quot.TechnicalTemplate = new TechnicalTemplate();
                                    quot.TechnicalTemplate.IdTechnicalTemplate = quot.IdTechnicalTemplate;
                                    quot.TechnicalTemplate.Name = Convert.ToString(reader["TechnicalTemplateName"]);
                                }

                                quot.Ots = new List<Ots>();
                                Ots ot = new Ots();
                                ot.Code = Convert.ToString(reader["OTCode"]);
                                ot.NumOT = Convert.ToByte(reader["NumOT"]);

                                ot.OtItems = new List<OtItem>();
                                OtItem otitem = new OtItem();
                                otitem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                                otitem.RevisionItem = new RevisionItem();
                                if (reader["IdRevisionItem"] != DBNull.Value)
                                {
                                    otitem.RevisionItem.IdRevisionItem = Convert.ToInt64(reader["IdRevisionItem"]);
                                    revisionItemsList.Add(otitem.RevisionItem.IdRevisionItem);
                                }

                                otitem.RevisionItem.CpType = new CpType();

                                if (reader["CpName"] != DBNull.Value)
                                    otitem.RevisionItem.CpType.Name = Convert.ToString(reader["CpName"]);

                                if (reader["Ways"] != DBNull.Value)
                                    otitem.RevisionItem.Ways = Convert.ToInt32(reader["Ways"]);

                                if (reader["IdDrawing"] != DBNull.Value)
                                    otitem.RevisionItem.IdDrawing = Convert.ToInt64(reader["IdDrawing"]);

                                if (reader["ConnectorFamily"] != DBNull.Value)
                                    otitem.RevisionItem.ConnectorFamily = Convert.ToString(reader["ConnectorFamily"]);

                                if (reader["NumItem"] != DBNull.Value)
                                    otitem.RevisionItem.NumItem = Convert.ToString(reader["NumItem"]);

                                if (reader["Quantity"] != DBNull.Value)
                                    otitem.RevisionItem.Quantity = Convert.ToDecimal(reader["Quantity"]);

                                if (reader["Reference"] != DBNull.Value)
                                    otitem.RevisionItem.Reference = Convert.ToString(reader["Reference"]);

                                otitem.RevisionItem.CPProduct = new CPProduct();
                                if (reader["Reference"] != DBNull.Value)
                                    otitem.RevisionItem.CPProduct.Reference = Convert.ToString(reader["Reference"]);

                                if (reader["OtherReference"] != DBNull.Value)
                                    otitem.RevisionItem.CPProduct.OtherReference = Convert.ToString(reader["OtherReference"]);

                                otitem.Counterparts = new List<Counterpart>();
                                Counterpart counterpart = new Counterpart();

                                if (reader["CpCode"] != DBNull.Value)
                                    counterpart.Code = Convert.ToString(reader["CpCode"]);

                                otitem.Counterparts.Add(counterpart);

                                if (reader["ShippingDate"] != DBNull.Value)
                                    otitem.ShippingDate = Convert.ToDateTime(reader["ShippingDate"]);

                                if (reader["UnitPrice"] != DBNull.Value)
                                    otitem.RevisionItem.UnitPrice = Convert.ToDecimal(reader["UnitPrice"]);

                                ot.OtItems.Add(otitem);
                                quot.Ots.Add(ot);
                                offer.Quotations.Add(quot);
                                offers.Add(offer);
                            }
                            catch (Exception ex)
                            {
                            }
                        }
                    }
                }
            }

            return offers;
        }

        public List<RevisionItem> GetSellPriceByIdRevisionItem(Int32 idActiveUser, Company company, Int32? idCompany, byte idCurrency, string idsRevisionItems)
        {
            List<RevisionItem> revisionItems = new List<RevisionItem>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(company.ConnectPlantConstr))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("GetSellPriceByIdRevisionItem", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.CommandTimeout = 4000;

                mySqlCommand.Parameters.AddWithValue("_IdActiveUser", idActiveUser);
                mySqlCommand.Parameters.AddWithValue("_IdCompany", idCompany);
                mySqlCommand.Parameters.AddWithValue("_IdCurrency", idCurrency);
                mySqlCommand.Parameters.AddWithValue("_IdsRevisionItems", idsRevisionItems);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            try
                            {
                                RevisionItem revItem = new RevisionItem();
                                if (reader["IdRevisionItem"] != DBNull.Value)
                                    revItem.IdRevisionItem = Convert.ToInt64(reader["IdRevisionItem"]);

                                if (reader["ConvertedSellPrice"] != DBNull.Value)
                                    revItem.SellPrice = Convert.ToDouble(reader["ConvertedSellPrice"]);

                                revisionItems.Add(revItem);
                            }
                            catch (Exception ex)
                            {

                            }
                        }
                    }
                }
            }

            return revisionItems;
        }

        public List<Activity> GetActivityPerformanceTest(Int32 idActiveUser, string idOwner, Int32 idPermission, string idPlant, string connectionString, DateTime accountingYearFrom, DateTime accountingYearTo, string userProfileImagePath)
        {
            List<Activity> listActivity = new List<Activity>();
            System.Diagnostics.Stopwatch stopWatch = new System.Diagnostics.Stopwatch();
            System.Diagnostics.Stopwatch stopWatchsp = new System.Diagnostics.Stopwatch();
            System.Diagnostics.Stopwatch stopWatchReaderForActivity = new System.Diagnostics.Stopwatch();
            System.Diagnostics.Stopwatch stopWatchReaderForActivityLT = new System.Diagnostics.Stopwatch();
            stopWatch.Start();
            StreamWriter sw = new StreamWriter(@"C:\Temp\ActivityLogs.txt");
            using (MySqlConnection connActivities = new MySqlConnection(connectionString))
            {

                connActivities.Open();

                MySqlCommand activitiesCommand = new MySqlCommand("activities_GetActivityPerformanceTest", connActivities);
                activitiesCommand.CommandType = CommandType.StoredProcedure;
                activitiesCommand.Parameters.AddWithValue("_IdAciveUser", idActiveUser);
                activitiesCommand.Parameters.AddWithValue("_IdOwner", idOwner);
                activitiesCommand.Parameters.AddWithValue("_IdPermission", idPermission);
                activitiesCommand.Parameters.AddWithValue("_IdPlant", idPlant);
                activitiesCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                activitiesCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);

                stopWatchsp.Start();
                using (MySqlDataReader activityReader = activitiesCommand.ExecuteReader())
                {
                    stopWatchsp.Stop();
                    stopWatchReaderForActivity.Start();
                    while (activityReader.Read())
                    {

                        Activity activity = new Activity();
                        try
                        {
                            activity.IdActivity = Convert.ToInt64(activityReader["IdActivity"].ToString());
                            activity.Subject = activityReader["Subject"].ToString();
                            activity.Description = activityReader["Description"].ToString();

                            if (activityReader["IdActivityType"] != DBNull.Value)
                            {
                                activity.LookupValue = new LookupValue();
                                activity.LookupValue.IdLookupValue = Convert.ToInt32(activityReader["IdActivityType"].ToString());
                                activity.LookupValue.Value = activityReader["ActivityType"].ToString();
                                activity.LookupValue.HtmlColor = activityReader["ActivityTypeHtmlColor"].ToString();

                                if (activityReader["ActivityTypeImage"] != DBNull.Value)
                                    activity.LookupValue.IdImage = Convert.ToInt64(activityReader["ActivityTypeImage"].ToString());
                                if (activityReader["ActivityTypePosition"] != DBNull.Value)
                                    activity.LookupValue.Position = Convert.ToInt32(activityReader["ActivityTypePosition"].ToString());
                            }

                            if (activityReader["FromDate"] != DBNull.Value)
                                activity.FromDate = Convert.ToDateTime(activityReader["FromDate"].ToString());

                            if (activityReader["ToDate"] != DBNull.Value)
                                activity.ToDate = Convert.ToDateTime(activityReader["ToDate"].ToString());
                            activity.Location = activityReader["Location"].ToString();

                            if (activityReader["IdOwner"] != DBNull.Value)
                                activity.IdOwner = Convert.ToInt32(activityReader["IdOwner"].ToString());

                            if (activityReader["IdPerson"] != DBNull.Value)
                            {
                                activity.People = new People();

                                activity.People.Name = activityReader["Name"].ToString();
                                activity.People.Surname = activityReader["Surname"].ToString();
                                activity.People.Login = Convert.ToString(activityReader["Login"]);
                            }

                            if (activityReader["Latitude"] != DBNull.Value)
                                activity.Latitude = Convert.ToDouble(activityReader["Latitude"].ToString());
                            if (activityReader["Longitude"] != DBNull.Value)
                                activity.Longitude = Convert.ToDouble(activityReader["Longitude"].ToString());

                            activity.ActivityGridStatus = string.Empty;
                            if (activityReader["IsCompleted"] != DBNull.Value)
                            {
                                activity.IsCompleted = Convert.ToByte(activityReader["IsCompleted"].ToString());

                                //close filled when completing some activity.
                                if (activity.IsCompleted == 1)
                                {
                                    activity.ActivityGridStatus = "Completed";

                                    if (activityReader["CloseDate"] != DBNull.Value)
                                        activity.CloseDate = Convert.ToDateTime(activityReader["CloseDate"].ToString());
                                }
                            }

                            if (activityReader["IdActivityStatus"] != DBNull.Value)
                            {
                                activity.ActivityStatus = new LookupValue();
                                activity.ActivityStatus.IdLookupValue = Convert.ToInt32(activityReader["IdActivityStatus"].ToString());
                                activity.ActivityStatus.Value = activityReader["ActivityStatus"].ToString();
                                activity.ActivityStatus.HtmlColor = activityReader["ActivityStatusHtmlColor"].ToString();
                                if (activityReader["ActivityStatusImage"] != DBNull.Value)
                                    activity.ActivityStatus.IdImage = Convert.ToInt64(activityReader["ActivityStatusImage"].ToString());
                                if (activityReader["ActivityStatusPosition"] != DBNull.Value)
                                    activity.ActivityStatus.Position = Convert.ToInt32(activityReader["ActivityStatusPosition"].ToString());

                                if (activity.ActivityStatus.IdLookupValue == 48)
                                {
                                    activity.ActivityGridStatus = "Completed";
                                }
                                else
                                {
                                    activity.ActivityGridStatus = activityReader["ActivityStatus"].ToString();
                                }
                            }

                            if (activityReader["ReminderDateTime"] != DBNull.Value)
                                activity.ActivityReminderDateTime = Convert.ToDateTime(activityReader["ReminderDateTime"].ToString());

                            if (activityReader["IsSentMail"] != DBNull.Value)
                                activity.IsSentMail = Convert.ToByte(activityReader["IsSentMail"].ToString());

                            activity.ActivityLinkedItem = new List<ActivityLinkedItem>();

                            if (activityReader["ActivityTagsString"] != DBNull.Value)
                                activity.ActivityTagsString = Convert.ToString(activityReader["ActivityTagsString"]);

                            if (activityReader["ActivityAttendeesString"] != DBNull.Value)
                                activity.ActivityAttendeesString = Convert.ToString(activityReader["ActivityAttendeesString"]);

                            listActivity.Add(activity);
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }
                    }
                    stopWatchReaderForActivity.Stop();
                    if (activityReader.NextResult())
                    {
                        stopWatchReaderForActivityLT.Start();
                        while (activityReader.Read())
                        {

                            ActivityLinkedItem activityLinkedItem = new ActivityLinkedItem();
                            activityLinkedItem.IdActivity = Convert.ToInt64(activityReader["IdActivity"].ToString());
                            activityLinkedItem.IdActivityLinkedItem = Convert.ToInt64(activityReader["IdActivityLinkedItem"].ToString());
                            if (activityReader["IdCustomer"] != DBNull.Value)
                            {
                                activityLinkedItem.IdCustomer = Convert.ToInt32(activityReader["IdCustomer"].ToString());
                                activityLinkedItem.Customer = new Customer();
                                activityLinkedItem.Customer.IdCustomer = Convert.ToInt32(activityReader["IdCustomer"].ToString());
                                activityLinkedItem.Customer.CustomerName = activityReader["Group"].ToString();
                            }


                            if (activityReader["IdSite"] != DBNull.Value)
                            {
                                activityLinkedItem.IdSite = Convert.ToInt32(activityReader["IdSite"].ToString());
                                activityLinkedItem.Company = new Company();
                                activityLinkedItem.Company.IdCompany = Convert.ToInt32(activityReader["IdSite"].ToString());
                                activityLinkedItem.Company.Name = activityReader["Plant"].ToString();

                                activityLinkedItem.Company.SiteNameWithoutCountry = Convert.ToString(activityReader["PlantNameWithcountry"]);
                            }

                            if (activityReader["IdLinkedItemType"] != DBNull.Value)
                            {
                                activityLinkedItem.IdLinkedItemType = Convert.ToByte(activityReader["IdLinkedItemType"].ToString());
                                activityLinkedItem.LinkedItemType = new LookupValue();
                                activityLinkedItem.LinkedItemType.IdLookupValue = Convert.ToInt32(activityReader["IdLinkedItemType"].ToString());
                                activityLinkedItem.LinkedItemType.Value = activityReader["ItemType"].ToString();
                            }
                            activityLinkedItem.Name = activityReader["CustomerPlantName"].ToString();

                            listActivity.Where(jk => jk.IdActivity == activityLinkedItem.IdActivity).FirstOrDefault().ActivityLinkedItem.Add(activityLinkedItem);


                        }
                        stopWatchReaderForActivityLT.Stop();
                    }
                }
            }
            stopWatch.Stop();

            sw.WriteLine("Activity Main Method. Time: " + stopWatch.ElapsedMilliseconds);
            sw.WriteLine("Activity SP execution . Time: " + stopWatchsp.ElapsedMilliseconds);
            sw.WriteLine("Activity Activity Reader Loop execution . Time: " + stopWatchReaderForActivity.ElapsedMilliseconds);
            sw.WriteLine("Activity Activity Linked Item Reader Loop execution execution . Time: " + stopWatchReaderForActivityLT.ElapsedMilliseconds);
            sw.Close();
            return listActivity;
        }

        public List<ActivityGrid> GetSharedActivitiesByIdPermission(string connectionString, ActivityParams objActivityParams)
        {

            List<ActivityGrid> listActivity = new List<ActivityGrid>();

            using (MySqlConnection connActivities = new MySqlConnection(connectionString))
            {
                connActivities.Open();

                MySqlCommand activitiesCommand = new MySqlCommand("activities_GetActivityRestfulService", connActivities);
                activitiesCommand.CommandType = CommandType.StoredProcedure;
                activitiesCommand.Parameters.AddWithValue("_IdAciveUser", objActivityParams.idActiveUser);
                activitiesCommand.Parameters.AddWithValue("_IdOwner", objActivityParams.idOwner);
                activitiesCommand.Parameters.AddWithValue("_IdPermission", objActivityParams.idPermission);
                activitiesCommand.Parameters.AddWithValue("_IdPlant", objActivityParams.idPlant);
                activitiesCommand.Parameters.AddWithValue("_accountingYearFrom", objActivityParams.accountingYearFrom);
                activitiesCommand.Parameters.AddWithValue("_accountingYearTo", objActivityParams.accountingYearTo);
                activitiesCommand.CommandTimeout = 2000;
                using (MySqlDataReader activityReader = activitiesCommand.ExecuteReader())
                {
                    while (activityReader.Read())
                    {
                        ActivityGrid activity = new ActivityGrid();
                        try
                        {
                            activity.IdActivity = Convert.ToInt64(activityReader["IdActivity"].ToString());
                            activity.IdOwner = Convert.ToInt32(activityReader["IdOwner"].ToString());
                            activity.Subject = activityReader["Subject"].ToString();
                            activity.Description = activityReader["Description"].ToString();
                            if (activityReader["Login"] != DBNull.Value)
                            {
                                activity.Login = Convert.ToString(activityReader["Login"]);
                            }

                            if (activityReader["IsCompleted"] != DBNull.Value)
                            {
                                activity.IsCompleted = Convert.ToByte(activityReader["IsCompleted"].ToString());
                                if (activity.IsCompleted == 1)
                                {
                                    activity.ActivityGridStatus = "Completed";

                                    if (activityReader["CloseDate"] != DBNull.Value)
                                        activity.CloseDate = Convert.ToDateTime(activityReader["CloseDate"].ToString());
                                }
                            }

                            if (activityReader["IdActivityType"] != DBNull.Value)
                            {
                                activity.IdActivityType = Convert.ToInt32(activityReader["IdActivityType"].ToString());
                                activity.ActivityType = activityReader["ActivityType"].ToString();

                                if (activityReader["ActivityTypeImage"] != DBNull.Value)
                                    activity.IdImageActivityType = Convert.ToInt64(activityReader["ActivityTypeImage"].ToString());

                            }
                            if (activityReader["FromDate"] != DBNull.Value)
                                activity.FromDate = Convert.ToDateTime(activityReader["FromDate"].ToString());

                            if (activityReader["ToDate"] != DBNull.Value)
                                activity.ToDate = Convert.ToDateTime(activityReader["ToDate"].ToString());

                            activity.Location = activityReader["Location"].ToString();

                            if (activityReader["IdPerson"] != DBNull.Value)
                            {
                                activity.FullName = activityReader["Name"].ToString() + " " + activityReader["Surname"].ToString();
                            }



                            if (activityReader["IdActivityStatus"] != DBNull.Value)
                            {
                                activity.IdActivityStatus = Convert.ToInt32(activityReader["IdActivityStatus"].ToString());
                                if (activityReader["ActivityStatusImage"] != DBNull.Value)
                                    activity.IdImageActivityGridStatus = Convert.ToInt64(activityReader["ActivityStatusImage"].ToString());

                                if (Convert.ToInt32(activityReader["IdActivityStatus"].ToString()) == 48)
                                {
                                    activity.ActivityGridStatus = "Completed";
                                }
                                else
                                {
                                    activity.ActivityGridStatus = activityReader["ActivityStatus"].ToString();
                                }
                            }

                            //if (activityReader["IdCustomer"] != DBNull.Value)
                            //{
                            //    activity.CustomerName = activityReader["Group"].ToString();
                            //}
                            //if (activityReader["IdSite"] != DBNull.Value)
                            //{
                            //    activity.IdSite = Convert.ToInt32(activityReader["IdSite"].ToString());
                            //    activity.CompanyName = activityReader["Plant"].ToString();
                            //    activity.SiteNameWithoutCountry = activityReader["PlantNameWithcountry"].ToString();
                            //}

                            //if (activityReader["ActivityTagsString"] != DBNull.Value)
                            //    activity.ActivityTagsString = Convert.ToString(activityReader["ActivityTagsString"]);

                            //if (activityReader["ActivityAttendeesString"] != DBNull.Value)
                            //    activity.ActivityAttendeesString = Convert.ToString(activityReader["ActivityAttendeesString"]);

                            listActivity.Add(activity);
                        }
                        catch (Exception ex)
                        {
                            throw ex;
                        }
                    }


                    if (activityReader.NextResult())
                    {
                        while (activityReader.Read())
                        {
                            if (activityReader["IdActivity"] != DBNull.Value)
                            {
                                ActivityGrid activity = listActivity.Where(i => i.IdActivity == Convert.ToInt64(activityReader["IdActivity"].ToString())).FirstOrDefault();
                                activity.CustomerName = activityReader["Group"].ToString();
                                if (activityReader["IdSite"] != DBNull.Value)
                                {
                                    activity.IdSite = Convert.ToInt32(activityReader["IdSite"].ToString());
                                    activity.CompanyName = activityReader["Plant"].ToString();
                                    activity.SiteNameWithoutCountry = activityReader["PlantNameWithcountry"].ToString();
                                }

                            }
                        }
                    }

                    if (activityReader.NextResult())
                    {
                        while (activityReader.Read())
                        {
                            if (activityReader["IdActivity"] != DBNull.Value)
                            {
                                ActivityGrid activity = listActivity.Where(i => i.IdActivity == Convert.ToInt64(activityReader["IdActivity"].ToString())).FirstOrDefault();
                                activity.ActivityAttendeesString = activityReader["ActivityAttendeesString"].ToString();
                            }
                        }
                    }

                    if (activityReader.NextResult())
                    {
                        while (activityReader.Read())
                        {
                            if (activityReader["IdActivity"] != DBNull.Value)
                            {
                                ActivityGrid activity = listActivity.Where(i => i.IdActivity == Convert.ToInt64(activityReader["IdActivity"].ToString())).FirstOrDefault();
                                activity.ActivityTagsString = activityReader["ActivityTagsString"].ToString();
                            }
                        }
                    }

                }
            }

            return listActivity;
        }

        public SalesUser GetUserAllSalesQuotaByDate(string connectionstring, Int32 idUser, byte idCurrency)
        {
            SalesUser salesUser = new SalesUser();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionstring))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("SalesUserQuotas_GetUserAllSalesQuotaByDate", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_userId", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                salesUser.SalesUserQuotas = new List<SalesUserQuota>();
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        if (offerreader["IdSalesUser"] != DBNull.Value)
                            salesUser.IdSalesUser = Convert.ToInt32(offerreader["IdSalesUser"].ToString());
                        if (offerreader["IdSalesTeam"] != DBNull.Value)
                            salesUser.IdSalesTeam = Convert.ToInt32(offerreader["IdSalesTeam"].ToString());
                        if (salesUser.SalesUserQuotas.Any(i => i.IdSalesUser == Convert.ToInt32(offerreader["IdSalesUser"].ToString()) && i.Year == Convert.ToInt32(offerreader["Year"].ToString())))
                        {
                            //SalesUserQuota salesUserQuota = new SalesUserQuota();
                            //salesUserQuota.IdSalesUser = Convert.ToInt32(offerreader["IdSalesUser"].ToString());
                            //salesUserQuota.SalesQuotaAmount = Convert.ToDouble(offerreader["SalesQuotaAmount"].ToString());
                            //salesUserQuota.IdSalesQuotaCurrency = Convert.ToByte(offerreader["IdSalesQuotaCurrency"].ToString());
                            //salesUserQuota.Year = Convert.ToInt32(offerreader["Year"].ToString());

                            //salesUser.SalesUserQuotas.Add(salesUserQuota);
                        }
                        else
                        {
                            SalesUserQuota salesUserQuota = new SalesUserQuota();
                            salesUserQuota.IdSalesUser = Convert.ToInt32(offerreader["IdSalesUser"].ToString());
                            if (offerreader["SalesQuotaAmount"] != DBNull.Value)
                                salesUserQuota.SalesQuotaAmount = Convert.ToDouble(offerreader["SalesQuotaAmount"].ToString());
                            if (offerreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                salesUserQuota.IdSalesQuotaCurrency = Convert.ToByte(offerreader["IdSalesQuotaCurrency"].ToString());
                            if (offerreader["Year"] != DBNull.Value)
                                salesUserQuota.Year = Convert.ToInt32(offerreader["Year"].ToString());
                            if (offerreader["ExchangeRateDate"] != DBNull.Value)
                                salesUserQuota.ExchangeRateDate = Convert.ToDateTime(offerreader["ExchangeRateDate"].ToString());
                            if (offerreader["SalesQuotaAmountWithExchangeRate"] != DBNull.Value)
                                salesUserQuota.SalesQuotaAmountWithExchangeRate = Convert.ToDouble(offerreader["SalesQuotaAmountWithExchangeRate"].ToString());
                            salesUser.SalesUserQuotas.Add(salesUserQuota);
                        }

                    }
                }
            }

            return salesUser;
        }

        public List<SalesUser> GetAllSalesUserPeopleDetailsWithPlantAndPermissionByDate(byte idCurrency, string connectionString, string connectionWorkbenchString, Int32 accountingYear)
        {
            List<SalesUser> salesUsers = new List<SalesUser>();
            DataTable dtsalesUser = new DataTable();
            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("salesusers_GetAllSalesUserPeopleDetailsWithPlantByDate", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);

                da.Fill(dtsalesUser);
            }
            foreach (DataRow itemRow in dtsalesUser.Rows)
            {
                SalesUser salesUser = new SalesUser();
                if (itemRow["IdSalesTeam"] != DBNull.Value)
                    salesUser.IdSalesTeam = Convert.ToInt32(itemRow["IdSalesTeam"].ToString());

                if (itemRow["IdSalesUser"] != DBNull.Value)
                    salesUser.IdSalesUser = Convert.ToInt32(itemRow["IdSalesUser"].ToString());

                if (itemRow["IdSalesQuotaCurrency"] != DBNull.Value)
                    salesUser.IdSalesQuotaCurrency = Convert.ToByte(itemRow["IdSalesQuotaCurrency"].ToString());

                if (itemRow["SalesQuotaAmount"] != DBNull.Value)
                    salesUser.SalesQuotaAmount = Convert.ToDouble(itemRow["SalesQuotaAmount"].ToString());

                if (itemRow["ExchangeRateDate"] != DBNull.Value)
                    salesUser.ExchangeRateDate = Convert.ToDateTime(itemRow["ExchangeRateDate"].ToString());

                if (itemRow["IdSalesPlant"] != DBNull.Value)
                {
                    salesUser.IdSalesPlant = Convert.ToInt32(itemRow["IdSalesPlant"].ToString());
                    salesUser.Company = new Company();
                    salesUser.Company.IdCompany = Convert.ToInt32(itemRow["IdSalesPlant"].ToString());
                    salesUser.Company.ShortName = itemRow["Plant"].ToString();
                }

                salesUser.LookupValue = new LookupValue();
                salesUser.LookupValue.IdLookupValue = Convert.ToInt32(itemRow["IdSalesTeam"].ToString());
                salesUser.LookupValue.Value = itemRow["TeamUser"].ToString();
                if (itemRow["IdPerson"] != DBNull.Value)
                {
                    salesUser.People = new People();
                    salesUser.People.IdPerson = Convert.ToInt32(itemRow["IdPerson"].ToString());
                    salesUser.People.Name = itemRow["Name"].ToString();
                    salesUser.People.Surname = itemRow["Surname"].ToString();
                    salesUser.People.Email = itemRow["Email"].ToString();
                    salesUser.People.IsStillActive = Convert.ToByte(itemRow["IsStillActive"]);
                    salesUser.People.Phone = itemRow["Phone"].ToString();
                    if (itemRow["IdPersonGender"] != DBNull.Value)
                    {
                        salesUser.People.IdPersonGender = Convert.ToByte(itemRow["IdPersonGender"].ToString());
                        if (salesUser.People.IdPersonGender == 1)
                            salesUser.People.UserGender = "Female";
                        else if (salesUser.People.IdPersonGender == 2)
                            salesUser.People.UserGender = "Male";
                    }
                    salesUser.People.Company = new Company();
                    salesUser.People.Company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                    salesUser.People.Company.ShortName = itemRow["Office"].ToString();
                    salesUser.People.Company.Country = new Country();
                    salesUser.People.Company.Country.IdCountry = Convert.ToByte(itemRow["IdCountry"].ToString());
                    salesUser.People.Company.Country.Name = itemRow["Country"].ToString();
                    salesUser.People.Company.Country.Zone = new Zone();
                    salesUser.People.Company.Country.Zone.IdZone = Convert.ToInt32(itemRow["IdZone"].ToString());
                    salesUser.People.Company.Country.Zone.Name = itemRow["Region"].ToString();
                }
                salesUser.UserPermission = new List<UserPermission>();
                if (itemRow["IdSalesUser"] != DBNull.Value)
                {
                    using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionWorkbenchString))
                    {
                        conofferwithoutpurchaseorder.Open();
                        //MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("select up.IdUser, up.IdPermission,p.PermissionName from user_permissions up inner join permissions p on up.IdPermission=p.IdPermission where IdUser = " + salesUser.IdSalesUser + "  group by up.IdUser, up.IdPermission;", conofferwithoutpurchaseorder);
                        //conofferwithoutpurchaseordercommand.CommandType = CommandType.Text;

                        MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("users_GetUserPermission", conofferwithoutpurchaseorder);
                        conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                        conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_IdUser", salesUser.IdSalesUser);
                        using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                        {
                            while (offerreader.Read())
                            {
                                UserPermission userPermission = new UserPermission();
                                if (offerreader["IdUser"] != DBNull.Value)
                                    userPermission.IdUser = Convert.ToInt32(offerreader["IdUser"].ToString());
                                if (offerreader["IdPermission"] != DBNull.Value)
                                {
                                    userPermission.IdPermission = Convert.ToInt32(offerreader["IdPermission"].ToString());
                                    userPermission.Permission = new Permission();
                                    userPermission.Permission.IdPermission = Convert.ToInt32(offerreader["IdPermission"].ToString());
                                    userPermission.Permission.PermissionName = offerreader["PermissionName"].ToString();
                                }
                                salesUser.UserPermission.Add(userPermission);
                            }
                        }
                    }
                }
                salesUser.SiteUserPermission = new List<SiteUserPermission>();
                if (itemRow["IdSalesUser"] != DBNull.Value)
                {
                    using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionWorkbenchString))
                    {
                        conofferwithoutpurchaseorder.Open();
                        //MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("select sup.IdCompany, sup.IdUser,si.ShortName from site_user_permission sup inner join geos.sites si on sup.IdCompany=si.IdSite where IdUser = " + salesUser.IdSalesUser + " group by IdUser, IdCompany;", conofferwithoutpurchaseorder);
                        //conofferwithoutpurchaseordercommand.CommandType = CommandType.Text;
                        MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("users_GetSiteUserPermission", conofferwithoutpurchaseorder);
                        conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                        conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_IdUser", salesUser.IdSalesUser);
                        using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                        {
                            while (offerreader.Read())
                            {
                                SiteUserPermission siteUserPermission = new SiteUserPermission();
                                if (offerreader["IdUser"] != DBNull.Value)
                                    siteUserPermission.IdUser = Convert.ToInt32(offerreader["IdUser"].ToString());
                                if (offerreader["IdCompany"] != DBNull.Value)
                                {
                                    siteUserPermission.IdCompany = Convert.ToInt32(offerreader["IdCompany"].ToString());
                                    siteUserPermission.Company = new Company();
                                    siteUserPermission.Company.IdCompany = Convert.ToInt32(offerreader["IdCompany"].ToString());
                                    siteUserPermission.Company.ShortName = offerreader["ShortName"].ToString();
                                }
                                salesUser.SiteUserPermission.Add(siteUserPermission);
                            }
                        }
                    }
                }
                salesUsers.Add(salesUser);
            }
            return salesUsers;
        }

        public List<DateTime> GetAllCurrencyConversionDates(string mainServerConnectionString)
        {
            List<DateTime> dateTimes = new List<DateTime>();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand concommand = new MySqlCommand("currencyconversions_GetAllCurrencyConversionDates", mySqlConnection);
                    concommand.CommandType = CommandType.StoredProcedure;
                    using (MySqlDataReader reader = concommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            if (reader["CurrencyConversionDate"] != DBNull.Value)
                                dateTimes.Add(Convert.ToDateTime(reader["CurrencyConversionDate"].ToString()));
                        }
                    }

                    mySqlConnection.Close();
                }

            }
            catch (Exception ex)
            {
                throw;
            }

            return dateTimes;
        }


        public DailyCurrencyConversion GetCurrencyRateByDateAndId(string mainServerConnectionString, DailyCurrencyConversion dailyCurrencyConversion)
        {

            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand concommand = new MySqlCommand("currencyconversions_GetCurrencyRateByDateAndId", mySqlConnection);
                    concommand.CommandType = CommandType.StoredProcedure;
                    concommand.Parameters.AddWithValue("_CurrencyConversionDate", dailyCurrencyConversion.CurrencyConversionDate);
                    concommand.Parameters.AddWithValue("_IdCurrencyConversionFrom", dailyCurrencyConversion.IdCurrencyConversionFrom);
                    concommand.Parameters.AddWithValue("_IdCurrencyConversionTo", dailyCurrencyConversion.IdCurrencyConversionTo);
                    using (MySqlDataReader reader = concommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            if (reader["CurrencyConversionRate"] != DBNull.Value)
                                dailyCurrencyConversion.CurrencyConversationRate = float.Parse(reader["CurrencyConversionRate"].ToString());
                        }
                    }

                    mySqlConnection.Close();
                }

            }
            catch (Exception ex)
            {
                throw;
            }

            return dailyCurrencyConversion;
        }

        public bool AddSaleUserQuotaWithDate(List<SalesUserQuota> salesUserQuotas, string connectionstring)
        {
            bool isAddedSalesUserQuota = false;
            int isadded = 0;
            foreach (SalesUserQuota salesUserQuota in salesUserQuotas)
            {
                using (MySqlConnection concompany = new MySqlConnection(connectionstring))
                {
                    concompany.Open();
                    using (MySqlTransaction trans = concompany.BeginTransaction())
                    {
                        try
                        {
                            MySqlCommand concompanycommand = new MySqlCommand("sales_user_quotas_InsertWithDate", concompany);
                            concompanycommand.CommandType = CommandType.StoredProcedure;
                            concompanycommand.Parameters.AddWithValue("_IdSalesUser", salesUserQuota.IdSalesUser);
                            concompanycommand.Parameters.AddWithValue("_Year", salesUserQuota.Year);
                            concompanycommand.Parameters.AddWithValue("_SalesQuotaAmount", salesUserQuota.SalesQuotaAmount);
                            concompanycommand.Parameters.AddWithValue("_IdSalesQuotaCurrency", salesUserQuota.IdSalesQuotaCurrency);
                            concompanycommand.Parameters.AddWithValue("_ExchangeRateDate", salesUserQuota.ExchangeRateDate);
                            concompanycommand.Transaction = trans;
                            concompanycommand.ExecuteNonQuery();
                            isAddedSalesUserQuota = true;
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
            }
            return isAddedSalesUserQuota;
        }

        public bool UpdatePlantBusinessUnitSalesQuotaWithYearAndDate(PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota, string connectionString)
        {
            bool isUpdated = false;
            try
            {
                foreach (LookupValue itemplantBusinessUnitSalesQuota in plantBusinessUnitSalesQuota.LookupValue)
                {
                    using (MySqlConnection myConnection = new MySqlConnection(connectionString))
                    {
                        myConnection.Open();
                        using (MySqlTransaction trans = myConnection.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand concommand = new MySqlCommand("plantBusinessUnitSalesQuota_UpdateWithYearAndDate", myConnection);
                                concommand.CommandType = CommandType.StoredProcedure;
                                concommand.Parameters.AddWithValue("_IdPlant", plantBusinessUnitSalesQuota.IdPlant);
                                concommand.Parameters.AddWithValue("_IdBusinessUnit", itemplantBusinessUnitSalesQuota.IdLookupValue);
                                concommand.Parameters.AddWithValue("_AccountingYear", plantBusinessUnitSalesQuota.Year);
                                concommand.Parameters.AddWithValue("_SalesQuotaAmount", itemplantBusinessUnitSalesQuota.SalesQuotaAmount);
                                concommand.Parameters.AddWithValue("_IdSalesQuotaCurrency", itemplantBusinessUnitSalesQuota.IdSalesQuotaCurrency);
                                concommand.Parameters.AddWithValue("_ExchangeRateDate", itemplantBusinessUnitSalesQuota.ExchangeRateDate);
                                concommand.Transaction = trans;
                                concommand.ExecuteNonQuery();

                                isUpdated = true;
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                throw;
            }

            return isUpdated;
        }


        public List<PlantBusinessUnitSalesQuota> GetPlantSalesQuotaWithYearByIdUserPermissionwiseByDate(string connectionstring, Int32 idUser, byte idCurrency, Int32 accountingYear, Int32 idUserPermission)
        {
            List<PlantBusinessUnitSalesQuota> plantBusinessUnitSalesQuotas = new List<PlantBusinessUnitSalesQuota>();
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("GetPlantSalesQuotaWithYearByIdUserPermissionwiseByDate", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idUser", idUser);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idCurrency", idCurrency);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_accountingYear", accountingYear);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    while (lostReasonsByOfferreader.Read())
                    {
                        if (plantBusinessUnitSalesQuotas.Any(pb => pb.ShortName == lostReasonsByOfferreader["ShortName"].ToString()))
                        {
                            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();
                            plantBusinessUnitSalesQuota = plantBusinessUnitSalesQuotas.Where(pb => pb.ShortName == lostReasonsByOfferreader["ShortName"].ToString()).FirstOrDefault();
                            if (lostReasonsByOfferreader["IdPlant"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(lostReasonsByOfferreader["IdPlant"].ToString());
                            if (lostReasonsByOfferreader["IdBusinessUnit"] != DBNull.Value)
                            {
                                plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                LookupValue lv = new LookupValue();
                                lv.IdLookupValue = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                lv.Value = lostReasonsByOfferreader["Value"].ToString();
                                if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                    lv.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                                if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                    lv.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                                if (lostReasonsByOfferreader["ExchangeRateDate"] != DBNull.Value)
                                    lv.ExchangeRateDate = Convert.ToDateTime(lostReasonsByOfferreader["ExchangeRateDate"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue.Add(lv);
                            }
                            if (lostReasonsByOfferreader["Year"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.Year = Convert.ToInt32(lostReasonsByOfferreader["Year"].ToString());
                            if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                            if (lostReasonsByOfferreader["SalesQuotaAmountWithExchangeRate"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.QuotaAmountWithExchangeRate = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmountWithExchangeRate"].ToString());
                            if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                            if (lostReasonsByOfferreader["ExchangeRateDate"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.ExchangeRateDate = Convert.ToDateTime(lostReasonsByOfferreader["ExchangeRateDate"].ToString());
                            plantBusinessUnitSalesQuota.ShortName = lostReasonsByOfferreader["ShortName"].ToString();

                        }
                        else
                        {
                            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();
                            plantBusinessUnitSalesQuota.ShortName = lostReasonsByOfferreader["ShortName"].ToString();
                            if (lostReasonsByOfferreader["IdPlant"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(lostReasonsByOfferreader["IdPlant"].ToString());
                            if (lostReasonsByOfferreader["IdBusinessUnit"] != DBNull.Value)
                            {
                                plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue = new List<LookupValue>();
                                LookupValue lv = new LookupValue();
                                lv.IdLookupValue = Convert.ToInt32(lostReasonsByOfferreader["IdBusinessUnit"].ToString());
                                lv.Value = lostReasonsByOfferreader["Value"].ToString();
                                if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                    lv.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                                if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                    lv.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                                if (lostReasonsByOfferreader["SalesQuotaAmountWithExchangeRate"] != DBNull.Value)
                                    lv.SalesQuotaAmountWithExchangeRate = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmountWithExchangeRate"].ToString());
                                if (lostReasonsByOfferreader["ExchangeRateDate"] != DBNull.Value)
                                    lv.ExchangeRateDate = Convert.ToDateTime(lostReasonsByOfferreader["ExchangeRateDate"].ToString());
                                plantBusinessUnitSalesQuota.LookupValue.Add(lv);
                            }

                            if (lostReasonsByOfferreader["Year"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.Year = Convert.ToInt32(lostReasonsByOfferreader["Year"].ToString());

                            if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());

                            if (lostReasonsByOfferreader["SalesQuotaAmountWithExchangeRate"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.QuotaAmountWithExchangeRate = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmountWithExchangeRate"].ToString());

                            if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());

                            if (lostReasonsByOfferreader["ExchangeRateDate"] != DBNull.Value)
                                plantBusinessUnitSalesQuota.ExchangeRateDate = Convert.ToDateTime(lostReasonsByOfferreader["ExchangeRateDate"].ToString());

                            plantBusinessUnitSalesQuotas.Add(plantBusinessUnitSalesQuota);
                        }
                    }
                }
            }
            return plantBusinessUnitSalesQuotas;
        }

        public IList<Offer> GetSelectedUsersTargetForecastDate(string connectionstring, byte idCurrency, string idUser, Int64 accountingFromYear, Int64 accountingToYear)
        {
            IList<Offer> offers = new List<Offer>();
            IList<Company> companies = new List<Company>();

            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();

                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetSelectedUsersTargetByCustomerYearwiseWithDate", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;

                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);
                conoffertargetcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conoffertargetcommand.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
                conoffertargetcommand.Parameters.AddWithValue("_accountingToYear", accountingToYear);

                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {
                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString());
                        company.Name = offertargetreader["CustomerName"].ToString();
                        company.Country = new Country { Name = offertargetreader["CustomerCountry"].ToString() };

                        company.Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } };

                        company.SalesTargetBySite = new SalesTargetBySite();

                        if (offertargetreader["IdSite"] != DBNull.Value)
                            company.SalesTargetBySite.IdSite = Convert.ToInt32(offertargetreader["IdSite"].ToString());

                        if (offertargetreader["TargetIdCurrency"] != DBNull.Value)
                            company.SalesTargetBySite.TargetCurrencyId = Convert.ToByte(offertargetreader["TargetIdCurrency"].ToString());

                        if (offertargetreader["TargetAmount"] != DBNull.Value)
                            company.SalesTargetBySite.TargetAmount = Convert.ToDecimal(offertargetreader["TargetAmount"].ToString());

                        if (offertargetreader["TargetSalesAmountWithExchangeRate"] != DBNull.Value)
                            company.SalesTargetBySite.TargetAmountWithExchangeRate = Convert.ToDecimal(offertargetreader["TargetSalesAmountWithExchangeRate"].ToString());

                        if (offertargetreader["TargetSalesIdCurrency"] != DBNull.Value)
                        {
                            company.SalesTargetBySite.Currency = new Currency();

                            company.SalesTargetBySite.Currency.IdCurrency = Convert.ToByte(offertargetreader["TargetSalesIdCurrency"].ToString());
                            company.SalesTargetBySite.Currency.Name = offertargetreader["TargetSalesCurrency"].ToString();
                            company.SalesTargetBySite.Currency.Symbol = offertargetreader["TargetSalesCurrencySymbol"].ToString();
                        }

                        if (offertargetreader["Year"] != DBNull.Value)
                            company.SalesTargetBySite.Year = Convert.ToInt32(offertargetreader["Year"].ToString());

                        companies.Add(company);
                    }

                }
            }

            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();
                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetSelectedUsersCustomerDetails", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;
                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);

                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {
                        Offer offertarget = new Offer();
                        offertarget.Site = new Company { IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString()), Name = offertargetreader["CustomerName"].ToString(), Country = new Country { Name = offertargetreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offertargetreader["CustomerZone"].ToString() } }, Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } } };
                        offertarget.Site.SalesTargetBySiteLst = companies.Where(comp => comp.IdCompany == offertarget.Site.IdCompany).Select(saletarget => saletarget.SalesTargetBySite).ToList();

                        offers.Add(offertarget);
                    }
                }
            }

            return offers;

        }

        public IList<Offer> GetTargetForecastByPlantDate(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Int32 idUserPermission, string idSite)
        {
            IList<Offer> offers = new List<Offer>();
            IList<Company> companies = new List<Company>();

            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();

                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetTargetByCustomerYearDatewiseByPlant", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;

                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);
                conoffertargetcommand.Parameters.AddWithValue("_idZone", idZone);
                conoffertargetcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conoffertargetcommand.Parameters.AddWithValue("_accountingFromYear", accountingYearFrom);
                conoffertargetcommand.Parameters.AddWithValue("_accountingToYear", accountingYearTo);
                conoffertargetcommand.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {
                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString());
                        company.Name = offertargetreader["CustomerName"].ToString();
                        company.Country = new Country { Name = offertargetreader["CustomerCountry"].ToString() };
                        company.Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } };
                        company.SalesTargetBySite = new SalesTargetBySite();

                        if (offertargetreader["IdSite"] != DBNull.Value)
                            company.SalesTargetBySite.IdSite = Convert.ToInt32(offertargetreader["IdSite"].ToString());

                        if (offertargetreader["TargetIdCurrency"] != DBNull.Value)
                            company.SalesTargetBySite.TargetCurrencyId = Convert.ToByte(offertargetreader["TargetIdCurrency"].ToString());

                        if (offertargetreader["TargetAmount"] != DBNull.Value)
                            company.SalesTargetBySite.TargetAmount = Convert.ToDecimal(offertargetreader["TargetAmount"].ToString());

                        if (offertargetreader["TargetAmountWithExchangeRate"] != DBNull.Value)
                            company.SalesTargetBySite.TargetAmountWithExchangeRate = Convert.ToDecimal(offertargetreader["TargetAmountWithExchangeRate"].ToString());

                        if (offertargetreader["TargetSalesIdCurrency"] != DBNull.Value)
                        {
                            company.SalesTargetBySite.Currency = new Currency();
                            company.SalesTargetBySite.Currency.IdCurrency = Convert.ToByte(offertargetreader["TargetSalesIdCurrency"].ToString());
                            company.SalesTargetBySite.Currency.Name = offertargetreader["TargetSalesCurrency"].ToString();
                            company.SalesTargetBySite.Currency.Symbol = offertargetreader["TargetSalesCurrencySymbol"].ToString();
                        }

                        if (offertargetreader["Year"] != DBNull.Value)
                            company.SalesTargetBySite.Year = Convert.ToInt32(offertargetreader["Year"].ToString());

                        companies.Add(company);
                    }
                }
            }

            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();

                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetCustomerDetailsByPlant", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;

                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);
                conoffertargetcommand.Parameters.AddWithValue("_idZone", idZone);
                conoffertargetcommand.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {
                        Offer offertarget = new Offer();
                        offertarget.Site = new Company { IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString()), Name = offertargetreader["CustomerName"].ToString(), Country = new Country { Name = offertargetreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offertargetreader["CustomerZone"].ToString() } }, Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } } };
                        offertarget.Site.SalesTargetBySiteLst = companies.Where(comp => comp.IdCompany == offertarget.Site.IdCompany).Select(saletarget => saletarget.SalesTargetBySite).ToList();
                        offers.Add(offertarget);
                    }
                }
            }

            return offers;
        }

        public bool UpdateSalesTargetBySiteDate(SalesTargetBySite salesTargetBySite, string connectionString)
        {
            bool isUpdated = false;
            try
            {
                using (MySqlConnection myConnection = new MySqlConnection(connectionString))
                {
                    myConnection.Open();
                    using (MySqlTransaction trans = myConnection.BeginTransaction())
                    {
                        try
                        {
                            MySqlCommand concommand = new MySqlCommand("salestargetbysite_UpdateWithDate", myConnection);
                            concommand.CommandType = CommandType.StoredProcedure;
                            concommand.Parameters.AddWithValue("_IdSite", salesTargetBySite.IdSite);
                            concommand.Parameters.AddWithValue("_Year", salesTargetBySite.Year);
                            concommand.Parameters.AddWithValue("_TargetAmount", salesTargetBySite.TargetAmount);
                            concommand.Parameters.AddWithValue("_IdCurrency", salesTargetBySite.IdCurrency);
                            concommand.Parameters.AddWithValue("_ExchangeRateDate", salesTargetBySite.ExchangeRateDate);
                            concommand.Transaction = trans;
                            concommand.ExecuteNonQuery();

                            isUpdated = true;
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }

            return isUpdated;
        }

        public DateTime GetLatestCurrencyConversionDate(string mainServerConnectionString)
        {
            DateTime dtCurrencyConversionDate = new DateTime();
            try
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                {
                    mySqlConnection.Open();

                    MySqlCommand concommand = new MySqlCommand("currency_conversions_GetLatestCurrencyConversionDate", mySqlConnection);
                    concommand.CommandType = CommandType.StoredProcedure;
                    using (MySqlDataReader reader = concommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            if (reader["CurrencyConversionDate"] != DBNull.Value)
                                dtCurrencyConversionDate = Convert.ToDateTime(reader["CurrencyConversionDate"].ToString());
                        }
                    }

                    mySqlConnection.Close();
                }

            }
            catch (Exception ex)
            {
                throw;
            }

            return dtCurrencyConversionDate;
        }

        public List<DailyCurrencyConversion> GetLatestCurrencyConversion(string mainServerConnectionString)
        {
            List<DailyCurrencyConversion> dailyCurrencyConversions = new List<DailyCurrencyConversion>();
            DateTime dtCurrencyConversionDate = new DateTime();
            dtCurrencyConversionDate = GetLatestCurrencyConversionDate(mainServerConnectionString);
            if (dtCurrencyConversionDate != null)
            {
                try
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand concommand = new MySqlCommand("currency_conversions_GetLatestCurrencyConversionRateByDate", mySqlConnection);
                        concommand.CommandType = CommandType.StoredProcedure;
                        concommand.Parameters.AddWithValue("_CurrencyConversionDate", dtCurrencyConversionDate);
                        using (MySqlDataReader reader = concommand.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                DailyCurrencyConversion DailyCurrencyConversion = new DailyCurrencyConversion();
                                if (reader["IdCurrencyConversion"] != DBNull.Value)
                                    DailyCurrencyConversion.IdCurrencyConversion = Convert.ToInt64(reader["IdCurrencyConversion"].ToString());
                                if (reader["CurrencyConversionDate"] != DBNull.Value)
                                    DailyCurrencyConversion.CurrencyConversionDate = Convert.ToDateTime(reader["CurrencyConversionDate"].ToString());
                                if (reader["IdCurrencyConversionFrom"] != DBNull.Value)
                                    DailyCurrencyConversion.IdCurrencyConversionFrom = Convert.ToByte(reader["IdCurrencyConversionFrom"].ToString());
                                if (reader["IdCurrencyConversionTo"] != DBNull.Value)
                                    DailyCurrencyConversion.IdCurrencyConversionTo = Convert.ToByte(reader["IdCurrencyConversionTo"].ToString());
                                if (reader["CurrencyConversionRate"] != DBNull.Value)
                                    DailyCurrencyConversion.CurrencyConversationRate = (float)(reader["CurrencyConversionRate"]);
                                if (reader["IsCorrect"] != DBNull.Value)
                                    DailyCurrencyConversion.IsCorrect = Convert.ToByte(reader["IsCorrect"]);

                                dailyCurrencyConversions.Add(DailyCurrencyConversion);
                            }
                        }

                        mySqlConnection.Close();
                    }

                }
                catch (Exception ex)
                {
                    throw;
                }
            }
            return dailyCurrencyConversions;
        }

        public PlantBusinessUnitSalesQuota GetTotalPlantQuotaSelectedPlantWiseAndYearWithExchangeDate(string connectionstring, string assignedPlant, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, Int32 idCurrentUser = 0)
        {
            PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuotas = new PlantBusinessUnitSalesQuota();
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("GetSalesQuotaAmountByPlantAndYearWithNewCC", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_assignedPlant", assignedPlant);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    if (lostReasonsByOfferreader.Read())
                    {
                        if (lostReasonsByOfferreader["Year"] != DBNull.Value)
                            plantBusinessUnitSalesQuotas.Year = Convert.ToInt32(lostReasonsByOfferreader["Year"].ToString());
                        if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                            plantBusinessUnitSalesQuotas.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());
                        if (lostReasonsByOfferreader["SalesQuotaAmountWithExchangeRate"] != DBNull.Value)
                            plantBusinessUnitSalesQuotas.QuotaAmountWithExchangeRate = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmountWithExchangeRate"].ToString());
                        if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                            plantBusinessUnitSalesQuotas.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                        if (lostReasonsByOfferreader["ExchangeRateDate"] != DBNull.Value)
                            plantBusinessUnitSalesQuotas.ExchangeRateDate = Convert.ToDateTime(lostReasonsByOfferreader["ExchangeRateDate"].ToString());
                    }
                }
            }

            return plantBusinessUnitSalesQuotas;
        }


        public SalesUserQuota GetTotalSalesQuotaBySelectedUserIdAndYearWithExchangeRate(string connectionstring, string userIds, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo)
        {
            SalesUserQuota salesUser = new SalesUserQuota();
            using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffer.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("GetSalesQuotaAmountByUserIdAndYearWithNewCC", conlostReasonsByOffer);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_userId", userIds);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conlostReasonsByOffercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    if (lostReasonsByOfferreader.Read())
                    {

                        if (lostReasonsByOfferreader["Year"] != DBNull.Value)
                            salesUser.Year = Convert.ToInt32(lostReasonsByOfferreader["Year"].ToString());

                        if (lostReasonsByOfferreader["SalesQuotaAmount"] != DBNull.Value)
                            salesUser.SalesQuotaAmount = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmount"].ToString());

                        if (lostReasonsByOfferreader["SalesQuotaAmountWithExchange"] != DBNull.Value)
                            salesUser.SalesQuotaAmountWithExchangeRate = Convert.ToDouble(lostReasonsByOfferreader["SalesQuotaAmountWithExchange"].ToString());

                        if (lostReasonsByOfferreader["IdSalesQuotaCurrency"] != DBNull.Value)
                            salesUser.IdSalesQuotaCurrency = Convert.ToByte(lostReasonsByOfferreader["IdSalesQuotaCurrency"].ToString());
                    }
                }
            }

            return salesUser;
        }


        public List<Company> GetSitesTargetNewCurrencyConversion(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingFromYear, DateTime accountingToYear, Int32 idUserPermission)
        {
            List<Company> companies = new List<Company>();
            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();

                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetTargetByCustomerNewCurrencyConversion", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;
                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);
                conoffertargetcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conoffertargetcommand.Parameters.AddWithValue("_accountingFromYear", accountingFromYear.Year);
                conoffertargetcommand.Parameters.AddWithValue("_accountingToYear", accountingToYear.Year);
                conoffertargetcommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {

                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString());
                        company.Name = offertargetreader["CustomerName"].ToString();
                        company.Country = new Country { Name = offertargetreader["CustomerCountry"].ToString() };

                        company.Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } };
                        company.SalesTargetBySite = new SalesTargetBySite();
                        if (offertargetreader["IdSite"] != DBNull.Value)
                            company.SalesTargetBySite.IdSite = Convert.ToInt32(offertargetreader["IdSite"].ToString());



                        if (offertargetreader["TargetAmount"] != DBNull.Value)
                            company.SalesTargetBySite.TargetAmount = Convert.ToDecimal(offertargetreader["TargetAmount"].ToString());

                        if (offertargetreader["TargetAmountWithExchangeRate"] != DBNull.Value)
                            company.SalesTargetBySite.TargetAmountWithExchangeRate = Convert.ToDecimal(offertargetreader["TargetAmountWithExchangeRate"].ToString());

                        if (offertargetreader["TargetSalesIdCurrency"] != DBNull.Value)
                            company.SalesTargetBySite.Currency = new Currency { Name = offertargetreader["TargetSalesCurrency"].ToString(), Symbol = offertargetreader["TargetSalesCurrencySymbol"].ToString() };

                        if (offertargetreader["Year"] != DBNull.Value)
                            company.SalesTargetBySite.Year = Convert.ToInt32(offertargetreader["Year"].ToString());


                        companies.Add(company);
                    }

                }
            }
            return companies;
        }


        public List<Company> GetSitesTargetByPlantNewCurrencyConversion(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, string idSite)
        {
            List<Company> companies = new List<Company>();
            using (MySqlConnection conOfferTarget = new MySqlConnection(connectionstring))
            {

                conOfferTarget.Open();
                MySqlCommand conCompanyTargetCommand = new MySqlCommand("sites_GetTargetByCustomerByPlantNewCurrencyConversion", conOfferTarget);
                conCompanyTargetCommand.CommandType = CommandType.StoredProcedure;
                conCompanyTargetCommand.Parameters.AddWithValue("_idUser", idUser);
                conCompanyTargetCommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conCompanyTargetCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conCompanyTargetCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conCompanyTargetCommand.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader offertargetreader = conCompanyTargetCommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {

                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString());
                        company.Name = offertargetreader["CustomerName"].ToString();
                        company.Country = new Country { Name = offertargetreader["CustomerCountry"].ToString() };

                        company.Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } };

                        company.SalesTargetBySite = new SalesTargetBySite();

                        if (offertargetreader["IdSite"] != DBNull.Value)
                            company.SalesTargetBySite.IdSite = Convert.ToInt32(offertargetreader["IdSite"].ToString());



                        if (offertargetreader["TargetSalesAmount"] != DBNull.Value)
                            company.SalesTargetBySite.TargetAmount = Convert.ToDecimal(offertargetreader["TargetSalesAmount"].ToString());

                        if (offertargetreader["TargetSalesAmount"] != DBNull.Value)
                            company.SalesTargetBySite.TargetAmountWithExchangeRate = Convert.ToDecimal(offertargetreader["TargetSalesAmount"].ToString());

                        if (offertargetreader["TargetSalesIdCurrency"] != DBNull.Value)
                            company.SalesTargetBySite.Currency = new Currency { Name = offertargetreader["TargetSalesCurrency"].ToString(), Symbol = offertargetreader["TargetSalesCurrencySymbol"].ToString() };

                        if (offertargetreader["Year"] != DBNull.Value)
                            company.SalesTargetBySite.Year = Convert.ToInt32(offertargetreader["Year"].ToString());


                        companies.Add(company);
                    }
                }
            }

            return companies;
        }


        public List<Company> GetSelectedUsersSitesTargetNewCurrencyConversion(string connectionstring, byte idCurrency, Int64 accountingFromYear, Int64 accountingToYear, string idUser)
        {
            List<Company> companies = new List<Company>();
            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();
                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetTargetByCustomerNewCurrencyConversion", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;
                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);
                conoffertargetcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conoffertargetcommand.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
                conoffertargetcommand.Parameters.AddWithValue("_accountingToYear", accountingToYear);
                conoffertargetcommand.Parameters.AddWithValue("_idPermission", 21);

                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {

                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString());
                        company.Name = offertargetreader["CustomerName"].ToString();
                        company.Country = new Country { Name = offertargetreader["CustomerCountry"].ToString() };

                        company.Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } };
                        company.SalesTargetBySite = new SalesTargetBySite();
                        if (offertargetreader["IdSite"] != DBNull.Value)
                            company.SalesTargetBySite.IdSite = Convert.ToInt32(offertargetreader["IdSite"].ToString());



                        if (offertargetreader["TargetIdCurrency"] != DBNull.Value)
                            company.SalesTargetBySite.TargetCurrencyId = Convert.ToByte(offertargetreader["TargetIdCurrency"].ToString());

                        if (offertargetreader["TargetSalesIdCurrency"] != DBNull.Value)
                            company.SalesTargetBySite.Currency = new Currency { IdCurrency = Convert.ToByte(offertargetreader["TargetSalesIdCurrency"].ToString()), Name = offertargetreader["TargetSalesCurrency"].ToString(), Symbol = offertargetreader["TargetSalesCurrencySymbol"].ToString() };

                        if (offertargetreader["Year"] != DBNull.Value)
                            company.SalesTargetBySite.Year = Convert.ToInt32(offertargetreader["Year"].ToString());

                        if (offertargetreader["TargetAmount"] != DBNull.Value)
                            company.SalesTargetBySite.TargetAmount = Convert.ToDecimal(offertargetreader["TargetAmount"].ToString());

                        if (offertargetreader["TargetAmountWithExchangeRate"] != DBNull.Value)
                            company.SalesTargetBySite.TargetAmountWithExchangeRate = Convert.ToDecimal(offertargetreader["TargetAmountWithExchangeRate"].ToString());

                        companies.Add(company);
                    }

                }
            }
            return companies;
        }

        public IList<Offer> GetTargetForecastNewCurrencyConversion(string connectionstring, byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingFromYear, DateTime accountingToYear, Int32 idUserPermission)
        {
            IList<Offer> offers = new List<Offer>();
            IList<Company> companies = new List<Company>();

            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();

                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetTargetByCustomerNewCurrencyConversion", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;

                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);
                conoffertargetcommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conoffertargetcommand.Parameters.AddWithValue("_accountingFromYear", accountingFromYear.Year);
                conoffertargetcommand.Parameters.AddWithValue("_accountingToYear", accountingToYear.Year);
                conoffertargetcommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {
                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString());
                        company.Name = offertargetreader["CustomerName"].ToString();
                        company.Country = new Country { Name = offertargetreader["CustomerCountry"].ToString() };
                        company.Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } };

                        company.SalesTargetBySite = new SalesTargetBySite();

                        if (offertargetreader["IdSite"] != DBNull.Value)
                            company.SalesTargetBySite.IdSite = Convert.ToInt32(offertargetreader["IdSite"].ToString());

                        if (offertargetreader["TargetIdCurrency"] != DBNull.Value)
                            company.SalesTargetBySite.TargetCurrencyId = Convert.ToByte(offertargetreader["TargetIdCurrency"].ToString());

                        if (offertargetreader["TargetAmount"] != DBNull.Value)
                            company.SalesTargetBySite.TargetAmount = Convert.ToDecimal(offertargetreader["TargetAmount"].ToString());

                        if (offertargetreader["TargetAmountWithExchangeRate"] != DBNull.Value)
                            company.SalesTargetBySite.TargetAmountWithExchangeRate = Convert.ToDecimal(offertargetreader["TargetAmountWithExchangeRate"].ToString());

                        if (offertargetreader["TargetSalesIdCurrency"] != DBNull.Value)
                        {
                            company.SalesTargetBySite.Currency = new Currency();

                            company.SalesTargetBySite.Currency.IdCurrency = Convert.ToByte(offertargetreader["TargetSalesIdCurrency"].ToString());
                            company.SalesTargetBySite.Currency.Name = offertargetreader["TargetSalesCurrency"].ToString();
                            company.SalesTargetBySite.Currency.Symbol = offertargetreader["TargetSalesCurrencySymbol"].ToString();
                        }

                        if (offertargetreader["Year"] != DBNull.Value)
                            company.SalesTargetBySite.Year = Convert.ToInt32(offertargetreader["Year"].ToString());

                        companies.Add(company);
                    }
                }
            }

            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();

                MySqlCommand conoffertargetcommand = new MySqlCommand("sites_GetCustomerDetails", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;

                conoffertargetcommand.Parameters.AddWithValue("_idUser", idUser);
                conoffertargetcommand.Parameters.AddWithValue("_idZone", idZone);
                conoffertargetcommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {
                        Offer offertarget = new Offer();
                        offertarget.Site = new Company { IdCompany = Convert.ToInt32(offertargetreader["IdSite"].ToString()), Name = offertargetreader["CustomerName"].ToString(), Country = new Country { Name = offertargetreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offertargetreader["CustomerZone"].ToString() } }, Customers = new List<Customer> { new Customer { CustomerName = offertargetreader["CustomerGroup"].ToString() } } };

                        offertarget.Site.SalesTargetBySiteLst = companies.Where(comp => comp.IdCompany == offertarget.Site.IdCompany).Select(saletarget => saletarget.SalesTargetBySite).ToList();

                        offers.Add(offertarget);
                    }

                }
            }

            return offers;
        }


        public List<SalesTargetBySite> GetSalesTargetBySiteDetailByIdSite(string connectionstring, Int32 idSite)
        {
            List<SalesTargetBySite> salesTargetBySites = new List<SalesTargetBySite>();

            using (MySqlConnection conoffertarget = new MySqlConnection(connectionstring))
            {
                conoffertarget.Open();

                MySqlCommand conoffertargetcommand = new MySqlCommand("salestargetbysite_GetSalestargetbysiteByIdSite", conoffertarget);
                conoffertargetcommand.CommandType = CommandType.StoredProcedure;

                conoffertargetcommand.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader offertargetreader = conoffertargetcommand.ExecuteReader())
                {
                    while (offertargetreader.Read())
                    {
                        SalesTargetBySite salesTargetBySite = new SalesTargetBySite();

                        if (offertargetreader["IdSite"] != DBNull.Value)
                            salesTargetBySite.IdSite = Convert.ToInt32(offertargetreader["IdSite"].ToString());

                        if (offertargetreader["TargetAmount"] != DBNull.Value)
                            salesTargetBySite.TargetAmount = Convert.ToDecimal(offertargetreader["TargetAmount"].ToString());

                        if (offertargetreader["IdCurrency"] != DBNull.Value)
                        {
                            salesTargetBySite.Currency = new Currency();
                            salesTargetBySite.IdCurrency = Convert.ToByte(offertargetreader["IdCurrency"].ToString());
                            salesTargetBySite.Currency.IdCurrency = Convert.ToByte(offertargetreader["IdCurrency"].ToString());
                            salesTargetBySite.Currency.Name = offertargetreader["Name"].ToString();
                            salesTargetBySite.Currency.Symbol = offertargetreader["Symbol"].ToString();
                        }

                        if (offertargetreader["Year"] != DBNull.Value)
                            salesTargetBySite.Year = Convert.ToInt32(offertargetreader["Year"].ToString());

                        if (offertargetreader["ExchangeRateDate"] != DBNull.Value)
                            salesTargetBySite.ExchangeRateDate = Convert.ToDateTime(offertargetreader["ExchangeRateDate"].ToString());

                        salesTargetBySites.Add(salesTargetBySite);
                    }

                }
            }

            return salesTargetBySites;
        }

        public List<SalesUserQuota> GetAllSalesUserDetailsNewCurrencyConversion(string connectionString, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, string assignedPlants)
        {

            List<SalesUserQuota> salesUsers = new List<SalesUserQuota>();

            using (MySqlConnection conSalesUser = new MySqlConnection(connectionString))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("salesusers_GetAllSalesUserDetailsNewCurrencyConversion", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conSalesUsercommand.Parameters.AddWithValue("_assignedPlants", assignedPlants);

                using (MySqlDataReader salesUserreader = conSalesUsercommand.ExecuteReader())
                {
                    while (salesUserreader.Read())
                    {
                        SalesUserQuota salesUser = new SalesUserQuota();
                        if (salesUserreader["IdSalesUser"] != DBNull.Value)
                            salesUser.IdSalesUser = Convert.ToInt32(salesUserreader["IdSalesUser"].ToString());
                        if (salesUserreader["IdSalesQuotaCurrency"] != DBNull.Value)
                            salesUser.IdSalesQuotaCurrency = Convert.ToByte(salesUserreader["IdSalesQuotaCurrency"].ToString());
                        if (salesUserreader["SalesQuotaAmount"] != DBNull.Value)
                            salesUser.SalesQuotaAmount = Convert.ToDouble(salesUserreader["SalesQuotaAmount"].ToString());
                        if (salesUserreader["Year"] != DBNull.Value)
                            salesUser.Year = Convert.ToInt32(salesUserreader["Year"].ToString());
                        if (salesUserreader["IdPerson"] != DBNull.Value)
                        {
                            salesUser.People = new People();

                            salesUser.People.IdPerson = Convert.ToInt32(salesUserreader["IdPerson"].ToString());
                            salesUser.People.Name = salesUserreader["Name"].ToString();
                            salesUser.People.Surname = salesUserreader["Surname"].ToString();
                        }
                        salesUsers.Add(salesUser);
                    }
                }
            }

            return salesUsers;
        }


        public List<LookupValue> GetPlantQuotaAmountBUWiseNewCurrencyConversion(string assignedPlant, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, string connectionString)
        {
            List<LookupValue> lookupValues = new List<LookupValue>();
            try
            {
                using (MySqlConnection consite = new MySqlConnection(connectionString))
                {
                    consite.Open();
                    MySqlCommand consitecommand = new MySqlCommand("GetPlantQuotaAmountBUWiseNewCurrencyConversion", consite);
                    consitecommand.CommandType = CommandType.StoredProcedure;
                    consitecommand.Parameters.AddWithValue("_assignedPlant", assignedPlant);
                    consitecommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                    consitecommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                    consitecommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                    using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                    {
                        while (sitereader.Read())
                        {
                            if (sitereader["IdBusinessUnit"] != DBNull.Value)
                            {
                                LookupValue lookupValue = new LookupValue();
                                if (sitereader["IdBusinessUnit"] != DBNull.Value)
                                    lookupValue.IdLookupValue = Convert.ToInt32(sitereader["IdBusinessUnit"].ToString());
                                if (sitereader["Value"] != DBNull.Value)
                                    lookupValue.Value = sitereader["Value"].ToString();
                                if (sitereader["SalesQuotaAmount"] != DBNull.Value)
                                    lookupValue.SalesQuotaAmount = Convert.ToDouble(sitereader["SalesQuotaAmount"].ToString());
                                if (sitereader["IdSalesQuotaCurrency"] != DBNull.Value)
                                    lookupValue.IdSalesQuotaCurrency = Convert.ToByte(sitereader["IdSalesQuotaCurrency"].ToString());
                                lookupValues.Add(lookupValue);
                            }
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                throw;
            }
            return lookupValues;
        }

        public List<CompanyGrid> GetCustomersBySalesOwnerId(string connectionstring, CompanyParams companyParams)
        {

            List<CompanyGrid> companies = new List<CompanyGrid>();
            DateTime ModifiedIn = new DateTime();
            DateTime CreatedIn = new DateTime();
            using (MySqlConnection concompany = new MySqlConnection(connectionstring))
            {
                concompany.Open();
                MySqlCommand concompanycommand = new MySqlCommand("sites_GetCustomersBySalesOwnerId", concompany);
                concompanycommand.CommandType = CommandType.StoredProcedure;
                concompanycommand.Parameters.AddWithValue("_idUser", companyParams.idUser);
                concompanycommand.Parameters.AddWithValue("_idZone", companyParams.idZone);
                concompanycommand.Parameters.AddWithValue("_idPermission", companyParams.idUserPermission);

                using (MySqlDataReader companyreader = concompanycommand.ExecuteReader())
                {
                    while (companyreader.Read())
                    {
                        CompanyGrid company = new CompanyGrid();
                        company.IdCompany = Convert.ToInt32(companyreader["IdSite"].ToString());
                        company.Name = companyreader["CustomerPlant"].ToString();
                        company.RegisteredName = companyreader["RegisteredName"].ToString();
                        company.CIF = companyreader["RegistrationNumber"].ToString();
                        ////company.IdCountry = Convert.ToByte(companyreader["idCountry"].ToString());
                        company.CountryName = companyreader["Country"].ToString();
                        company.City = companyreader["City"].ToString();
                        ////company.Address = companyreader["Address"].ToString();
                        company.Telephone = companyreader["Phone"].ToString();
                        company.ZipCode = companyreader["PostCode"].ToString();
                        company.Fax = companyreader["Fax"].ToString();
                        company.Website = companyreader["WebSite"].ToString();
                        company.Email = companyreader["Email"].ToString();
                        company.Region = companyreader["Region"].ToString();
                        ////company.ShortName = companyreader["ShortName"].ToString();
                        if (companyreader["IdSalesResponsible"] != DBNull.Value)
                        {
                            //company.IdSalesResponsible = Convert.ToInt32(companyreader["IdSalesResponsible"].ToString());
                            company.PeopleFullName = companyreader["SalesResponsibleName"].ToString() + " " + companyreader["SalesResponsibleSurname"].ToString();
                        }

                        if (companyreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                        {
                            //company.IdSalesResponsibleAssemblyBU = Convert.ToInt32(companyreader["IdSalesResponsibleAssemblyBU"].ToString());
                            company.PeopleSalesBUFullName = companyreader["SalesResponsiblebuName"].ToString() + " " + companyreader["SalesResponsiblebuSurname"].ToString();
                        }

                        company.CountryZoneName = companyreader["SalesZone"].ToString();
                        ////company.IdCustomer = Convert.ToInt32(companyreader["IdCustomer"].ToString());
                        company.CustomerName = companyreader["CustomerGroup"].ToString();

                        if (companyreader["Line"] != DBNull.Value)
                            company.Line = Convert.ToInt32(companyreader["Line"].ToString());
                        if (companyreader["CuttingMachines"] != DBNull.Value)
                            company.CuttingMachines = Convert.ToInt32(companyreader["CuttingMachines"].ToString());
                        if (companyreader["Size"] != DBNull.Value)
                            company.Size = Convert.ToDouble(companyreader["Size"].ToString());
                        if (companyreader["NumberOfEmployees"] != DBNull.Value)
                            company.NumberOfEmployees = Convert.ToInt32(companyreader["NumberOfEmployees"].ToString());
                        if (companyreader["IdBusinessField"] != DBNull.Value)
                        {
                            //company.IdBusinessField = Convert.ToByte(companyreader["IdBusinessField"].ToString());
                            company.BusinessFieldValue = companyreader["BusinessField"].ToString();
                        }
                        if (companyreader["IdBusinessCenter"] != DBNull.Value)
                        {
                            //company.IdBusinessCenter = Convert.ToByte(companyreader["IdBusinessCenter"].ToString());
                            company.BusinessCenterValue = companyreader["BusinessCenter"].ToString();
                        }

                        company.GroupPlantName = companyreader["GroupPlantName"].ToString();

                        if (companyreader["ModifiedIn"] != DBNull.Value)
                        {
                            ModifiedIn = Convert.ToDateTime(companyreader["ModifiedIn"]);
                            company.ModifiedIn = ModifiedIn.ToString("MM/dd/yyyy");
                        }

                        if (companyreader["CreatedIn"] != DBNull.Value)
                        {
                            CreatedIn = Convert.ToDateTime(companyreader["CreatedIn"].ToString());
                            company.CreatedIn = CreatedIn.ToString("MM/dd/yyyy");
                        }
                        company.GroupPlantName = companyreader["GroupPlantName"].ToString();

                        if (companyreader["CreatedBy"] != DBNull.Value)
                        {
                            // company.CreatedBy = Convert.ToInt32(companyreader["CreatedBy"].ToString());
                            company.PeopleCreatedBy = companyreader["CreatedByName"].ToString() + " " + companyreader["CreatedBySurname"].ToString();
                        }

                        List<SitesByBusinessProduct> BusinessProductList = new List<SitesByBusinessProduct>();
                        company.BusinessProductString = GetBusinessProductString(connectionstring, company.IdCompany, BusinessProductList);

                        company.Age = Math.Round((double)((DateTime.Now.Month - Convert.ToDateTime(companyreader["CreatedIn"].ToString()).Month)
                            + 12 * (DateTime.Now.Year - Convert.ToDateTime(companyreader["CreatedIn"].ToString()).Year)) / 12, 1);
                        companies.Add(company);
                    }
                }

            }
            return companies;
        }

        public List<CompanyGrid> GetSelectedUserCustomersByPlant(string connectionstring, CompanyParams objCompanyParams)
        {

            List<CompanyGrid> companies = new List<CompanyGrid>();
            DateTime ModifiedIn = new DateTime();
            DateTime CreatedIn = new DateTime();

            using (MySqlConnection concompany = new MySqlConnection(connectionstring))
            {
                concompany.Open();
                MySqlCommand concompanycommand = new MySqlCommand("sites_GetSelectedUserCustomersByPlant", concompany);
                concompanycommand.CommandType = CommandType.StoredProcedure;
                concompanycommand.Parameters.AddWithValue("_idSite", objCompanyParams.StringValues);
                using (MySqlDataReader companyreader = concompanycommand.ExecuteReader())
                {
                    while (companyreader.Read())
                    {
                        CompanyGrid company = new CompanyGrid();
                        company.IdCompany = Convert.ToInt32(companyreader["IdSite"].ToString());
                        company.Name = companyreader["CustomerPlant"].ToString();
                        company.RegisteredName = companyreader["RegisteredName"].ToString();
                        company.CIF = companyreader["RegistrationNumber"].ToString();
                        ////company.IdCountry = Convert.ToByte(companyreader["idCountry"].ToString());
                        company.CountryName = companyreader["Country"].ToString();
                        company.City = companyreader["City"].ToString();
                        ////company.Address = companyreader["Address"].ToString();
                        company.Telephone = companyreader["Phone"].ToString();
                        company.ZipCode = companyreader["PostCode"].ToString();
                        company.Fax = companyreader["Fax"].ToString();
                        company.Website = companyreader["WebSite"].ToString();
                        company.Email = companyreader["Email"].ToString();
                        company.Region = companyreader["Region"].ToString();
                        ////company.ShortName = companyreader["ShortName"].ToString();
                        if (companyreader["IdSalesResponsible"] != DBNull.Value)
                        {
                            //company.IdSalesResponsible = Convert.ToInt32(companyreader["IdSalesResponsible"].ToString());
                            company.PeopleFullName = companyreader["SalesResponsibleName"].ToString() + " " + companyreader["SalesResponsibleSurname"].ToString();
                        }

                        if (companyreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                        {
                            //company.IdSalesResponsibleAssemblyBU = Convert.ToInt32(companyreader["IdSalesResponsibleAssemblyBU"].ToString());
                            company.PeopleSalesBUFullName = companyreader["SalesResponsiblebuName"].ToString() + " " + companyreader["SalesResponsiblebuSurname"].ToString();
                        }

                        company.CountryZoneName = companyreader["SalesZone"].ToString();
                        ////company.IdCustomer = Convert.ToInt32(companyreader["IdCustomer"].ToString());
                        company.CustomerName = companyreader["CustomerGroup"].ToString();

                        if (companyreader["Line"] != DBNull.Value)
                            company.Line = Convert.ToInt32(companyreader["Line"].ToString());
                        if (companyreader["CuttingMachines"] != DBNull.Value)
                            company.CuttingMachines = Convert.ToInt32(companyreader["CuttingMachines"].ToString());
                        if (companyreader["Size"] != DBNull.Value)
                            company.Size = Convert.ToDouble(companyreader["Size"].ToString());
                        if (companyreader["NumberOfEmployees"] != DBNull.Value)
                            company.NumberOfEmployees = Convert.ToInt32(companyreader["NumberOfEmployees"].ToString());
                        if (companyreader["IdBusinessField"] != DBNull.Value)
                        {
                            //company.IdBusinessField = Convert.ToByte(companyreader["IdBusinessField"].ToString());
                            company.BusinessFieldValue = companyreader["BusinessField"].ToString();
                        }
                        if (companyreader["IdBusinessCenter"] != DBNull.Value)
                        {
                            //company.IdBusinessCenter = Convert.ToByte(companyreader["IdBusinessCenter"].ToString());
                            company.BusinessCenterValue = companyreader["BusinessCenter"].ToString();
                        }

                        //if (companyreader["IdBusinessType"] != DBNull.Value)
                        //{
                        //    company.IdBusinessType = Convert.ToByte(companyreader["IdBusinessType"].ToString());
                        //    company.BusinessType = new LookupValue { IdLookupValue = Convert.ToByte(companyreader["IdBusinessType"].ToString()), Value = companyreader["BusinessType"].ToString() };
                        //}
                        //if (companyreader["Latitude"] != DBNull.Value)
                        //{
                        //    company.Latitude = Convert.ToDouble(companyreader["Latitude"].ToString());
                        //    company.BothLongitudeLatitude = company.Latitude.ToString();
                        //}
                        //if (companyreader["Longitude"] != DBNull.Value)
                        //{
                        //    company.Longitude = Convert.ToDouble(companyreader["Longitude"].ToString());
                        //    company.BothLongitudeLatitude = company.BothLongitudeLatitude + company.Longitude.ToString();
                        //}

                        if (companyreader["ModifiedIn"] != DBNull.Value)
                        {
                            ModifiedIn = Convert.ToDateTime(companyreader["ModifiedIn"]);
                            company.ModifiedIn = ModifiedIn.ToString("MM/dd/yyyy");
                        }

                        if (companyreader["CreatedIn"] != DBNull.Value)
                        {
                            CreatedIn = Convert.ToDateTime(companyreader["CreatedIn"].ToString());
                            company.CreatedIn = CreatedIn.ToString("MM/dd/yyyy");
                        }


                        //company.GroupPlantName = companyreader["GroupPlantName"].ToString();

                        List<SitesByBusinessProduct> BusinessProductList = new List<SitesByBusinessProduct>();
                        company.BusinessProductString = GetBusinessProductString(connectionstring, company.IdCompany, BusinessProductList);

                        company.Age = Math.Round((double)((DateTime.Now.Month - Convert.ToDateTime(companyreader["CreatedIn"].ToString()).Month)
                            + 12 * (DateTime.Now.Year - Convert.ToDateTime(companyreader["CreatedIn"].ToString()).Year)) / 12, 1);

                        companies.Add(company);
                    }
                }
            }


            return companies;
        }

        public List<CompanyGrid> GetSelectedUserCustomersBySalesOwnerId(string connectionstring, CompanyParams companyParams)
        {

            List<CompanyGrid> companies = new List<CompanyGrid>();
            DateTime ModifiedIn = new DateTime();
            DateTime CreatedIn = new DateTime();
            using (MySqlConnection concompany = new MySqlConnection(connectionstring))
            {
                concompany.Open();
                MySqlCommand concompanycommand = new MySqlCommand("sites_GetSelectedUserCustomersBySalesOwnerId", concompany);
                concompanycommand.CommandType = CommandType.StoredProcedure;
                concompanycommand.Parameters.AddWithValue("_idUser", companyParams.StringValues);
                using (MySqlDataReader companyreader = concompanycommand.ExecuteReader())
                {
                    while (companyreader.Read())
                    {
                        CompanyGrid company = new CompanyGrid();
                        company.IdCompany = Convert.ToInt32(companyreader["IdSite"].ToString());
                        company.Name = companyreader["CustomerPlant"].ToString();
                        company.RegisteredName = companyreader["RegisteredName"].ToString();
                        company.CIF = companyreader["RegistrationNumber"].ToString();
                        company.CountryName = companyreader["Country"].ToString();
                        company.City = companyreader["City"].ToString();
                        company.Telephone = companyreader["Phone"].ToString();
                        company.ZipCode = companyreader["PostCode"].ToString();
                        company.Fax = companyreader["Fax"].ToString();
                        company.Website = companyreader["WebSite"].ToString();
                        company.Email = companyreader["Email"].ToString();
                        company.Region = companyreader["Region"].ToString();

                        if (companyreader["IdSalesResponsible"] != DBNull.Value)
                        {
                            //company.IdSalesResponsible = Convert.ToInt32(companyreader["IdSalesResponsible"].ToString());
                            company.PeopleFullName = companyreader["SalesResponsibleName"].ToString() + " " + companyreader["SalesResponsibleSurname"].ToString();
                        }

                        if (companyreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                        {
                            //company.IdSalesResponsibleAssemblyBU = Convert.ToInt32(companyreader["IdSalesResponsibleAssemblyBU"].ToString());
                            company.PeopleSalesBUFullName = companyreader["SalesResponsiblebuName"].ToString() + " " + companyreader["SalesResponsiblebuSurname"].ToString();
                        }

                        company.CountryZoneName = companyreader["SalesZone"].ToString();
                        ////company.IdCustomer = Convert.ToInt32(companyreader["IdCustomer"].ToString());
                        company.CustomerName = companyreader["CustomerGroup"].ToString();

                        if (companyreader["Line"] != DBNull.Value)
                            company.Line = Convert.ToInt32(companyreader["Line"].ToString());
                        if (companyreader["CuttingMachines"] != DBNull.Value)
                            company.CuttingMachines = Convert.ToInt32(companyreader["CuttingMachines"].ToString());
                        if (companyreader["Size"] != DBNull.Value)
                            company.Size = Convert.ToDouble(companyreader["Size"].ToString());
                        if (companyreader["NumberOfEmployees"] != DBNull.Value)
                            company.NumberOfEmployees = Convert.ToInt32(companyreader["NumberOfEmployees"].ToString());
                        if (companyreader["IdBusinessField"] != DBNull.Value)
                        {
                            //company.IdBusinessField = Convert.ToByte(companyreader["IdBusinessField"].ToString());
                            company.BusinessFieldValue = companyreader["BusinessField"].ToString();
                        }
                        if (companyreader["IdBusinessCenter"] != DBNull.Value)
                        {
                            //company.IdBusinessCenter = Convert.ToByte(companyreader["IdBusinessCenter"].ToString());
                            company.BusinessCenterValue = companyreader["BusinessCenter"].ToString();
                        }

                        company.GroupPlantName = companyreader["GroupPlantName"].ToString();

                        if (companyreader["ModifiedIn"] != DBNull.Value)
                        {
                            ModifiedIn = Convert.ToDateTime(companyreader["ModifiedIn"]);
                            company.ModifiedIn = ModifiedIn.ToString("MM/dd/yyyy");
                        }

                        if (companyreader["CreatedIn"] != DBNull.Value)
                        {
                            CreatedIn = Convert.ToDateTime(companyreader["CreatedIn"].ToString());
                            company.CreatedIn = CreatedIn.ToString("MM/dd/yyyy");
                        }

                        List<SitesByBusinessProduct> BusinessProductList = new List<SitesByBusinessProduct>();
                        company.BusinessProductString = GetBusinessProductString(connectionstring, company.IdCompany, BusinessProductList);

                        company.Age = Math.Round((double)((DateTime.Now.Month - Convert.ToDateTime(companyreader["CreatedIn"].ToString()).Month)
                            + 12 * (DateTime.Now.Year - Convert.ToDateTime(companyreader["CreatedIn"].ToString()).Year)) / 12, 1);
                        companies.Add(company);
                    }
                }
            }

            return companies;
        }


        private string GetBusinessProductString(string connectionstring, int IdCompany, List<SitesByBusinessProduct> BusinessProductList)
        {
            string BusinessProductString = "";
            List<string> bpstring = new List<string>();
            using (MySqlConnection concompanybusinessproduct = new MySqlConnection(connectionstring))
            {
                concompanybusinessproduct.Open();
                MySqlCommand concompanycommandbusinessproduct = new MySqlCommand("sitesbybusinessproduct_GetBusinessProduct", concompanybusinessproduct);
                concompanycommandbusinessproduct.CommandType = CommandType.StoredProcedure;
                concompanycommandbusinessproduct.Parameters.AddWithValue("_idCompany", IdCompany);

                using (MySqlDataReader companybusinessproductreader = concompanycommandbusinessproduct.ExecuteReader())
                {
                    while (companybusinessproductreader.Read())
                    {
                        if (companybusinessproductreader["IdBusinessProduct"] != DBNull.Value)
                        {
                            if (BusinessProductList.Any(bpl => bpl.IdBusinessProduct == Convert.ToInt32(companybusinessproductreader["IdBusinessProduct"].ToString())))
                            {

                            }
                            else
                            {
                                SitesByBusinessProduct sitesByBusinessProduct = new SitesByBusinessProduct();
                                if (companybusinessproductreader["IdSite"] != DBNull.Value)
                                    sitesByBusinessProduct.IdSite = Convert.ToInt32(companybusinessproductreader["IdSite"].ToString());

                                if (companybusinessproductreader["IdBusinessProduct"] != DBNull.Value)
                                {
                                    sitesByBusinessProduct.IdBusinessProduct = Convert.ToInt32(companybusinessproductreader["IdBusinessProduct"].ToString());
                                    sitesByBusinessProduct.BusinessProduct = Convert.ToString(companybusinessproductreader["Value"]);
                                    bpstring.Add(companybusinessproductreader["Value"].ToString());
                                }

                                sitesByBusinessProduct.IsAdded = true;
                                BusinessProductList.Add(sitesByBusinessProduct);
                            }
                        }

                    }
                }
                if (bpstring.Count > 0)
                    BusinessProductString = string.Join("\n", bpstring.ToArray());
                else
                    BusinessProductString = string.Empty;
            }
            return BusinessProductString;
        }

        public List<TimelineGrid> GetTimelineGridDetails(TimelineParams timelineParams)
        {
            List<TimelineGrid> timelineGridRows = new List<TimelineGrid>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(timelineParams.connectSiteDetailParams.ConnectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetRestfulTimeData", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.CommandTimeout = 3000;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", timelineParams.idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", timelineParams.accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", timelineParams.accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", (timelineParams.Roles == RoleType.SalesAssistant) ? 20 : 22);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idEmdepSite", timelineParams.connectSiteDetailParams.idSite);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);


                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid offer = new TimelineGrid();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            if (itemRow["IdSite"] != DBNull.Value)
                            {
                                offer.IdSite = Convert.ToInt32(itemRow["IdSite"].ToString());
                            }

                            if (itemRow["IdOfferType"] != DBNull.Value)
                                offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());

                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.ConnectPlantId = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            offer.Group = itemRow["CustomerGroup"].ToString();
                            offer.Plant = itemRow["SiteName"].ToString();
                            offer.Country = itemRow["CustomerCountry"].ToString();
                            offer.Region = itemRow["CustomerZone"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                                offer.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                                offer.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());

                            offer.Status = itemRow["OfferStatus"].ToString();
                            offer.HtmlColor = itemRow["OfferStatusColor"].ToString();

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Amount = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            if (itemRow["IdSalesStatusType"] != DBNull.Value)
                                offer.IdSalesStatusType = Convert.ToInt32(itemRow["IdSalesStatusType"].ToString());

                            //  offer.Currency = itemRow["OfferCurrency"].ToString();
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.OfferConfidentialLevel = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                                offer.OfferCloseDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.OfferCloseDate = null;

                            if (itemRow["Rfq"] != DBNull.Value)
                                offer.Rfq = itemRow["Rfq"].ToString();

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RfqReceptionDate = Convert.ToDateTime(itemRow["RFQReception"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.RfqReceptionDate = null;

                            if (itemRow["OfferStatusid"] != DBNull.Value)
                                offer.OfferStatusid = Convert.ToInt32(itemRow["OfferStatusid"].ToString());

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.QuoteSentDate = Convert.ToDateTime(itemRow["SendIn"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.QuoteSentDate = null;


                            offer.Project = itemRow["CarProjectName"].ToString();
                            offer.Source = itemRow["Source"].ToString();
                            offer.BusinessUnit = itemRow["BusinessUnit"].ToString();
                            offer.Oem = itemRow["CarOEM"].ToString();

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                offer.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory = new ProductCategoryGrid();

                            }

                            offer.OptionsByOffers = new List<OptionsByOfferGrid>();
                            timelineGridRows.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            OptionsByOfferGrid optionsByOfferGrid = new OptionsByOfferGrid();
                            optionsByOfferGrid.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsByOfferGrid.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsByOfferGrid.IdOfferPlant = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsByOfferGrid.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsByOfferGrid.Quantity > 0)
                                    optionsByOfferGrid.IsSelected = true;
                                else
                                    optionsByOfferGrid.IsSelected = false;
                            }
                            else
                            {
                                optionsByOfferGrid.IsSelected = false;
                            }
                            optionsByOfferGrid.OfferOption = itemRow["offeroption"].ToString();

                            timelineGridRow.OptionsByOffers.Add(optionsByOfferGrid);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            timelineGridRow.LostCompetitor = itemRow["Name"].ToString();
                            timelineGridRow.LostDescription = itemRow["Comments"].ToString();
                            timelineGridRow.LostReason = itemRow["Reason"].ToString();

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {
                                    if (itemRow["CommentLastUpdate"] != DBNull.Value)
                                    {
                                        timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["CommentLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                    }
                                }
                            }

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {

                                    if (itemRow["ActivityLastUpdate"] != DBNull.Value)
                                    {
                                        if (timelineGridRow.LastActivityDate == null)
                                        {
                                            timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                        else
                                        {
                                            int result = Nullable.Compare<DateTime>(Convert.ToDateTime(itemRow["ActivityLastUpdate"]), Convert.ToDateTime(timelineGridRow.LastActivityDate));
                                            if (result > 0)
                                                timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                    }

                                    //if (timelineGridRow.LastActivityDate == null)
                                    //{
                                    //    timelineGridRow.LastActivityDate =Convert.ToDateTime(timelineGridRow.QuoteSentDate).ToString("dd/MM/yyyy"); 
                                    //}
                                }
                            }

                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString()), Name = itemRow["ProductSubCategory"].ToString() }; });

                                if (itemRow["IdCategory"] != DBNull.Value)
                                {
                                    timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory.IdParent = Convert.ToInt64(itemRow["IdCategory"].ToString()); u.ProductCategory.Category = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdCategory"].ToString()), Name = itemRow["Category"].ToString() }; });
                                }
                            }




                        }
                    }
                }
            }

            return timelineGridRows;
        }


        public List<TimelineGrid> GetSelectedUsersTimelineGridDetails(TimelineParams timelineParams)
        {
            List<TimelineGrid> timelineGridRows = new List<TimelineGrid>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(timelineParams.connectSiteDetailParams.ConnectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetRestfulTimeData", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.CommandTimeout = 3000;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", timelineParams.idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", timelineParams.idsSelectedUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", timelineParams.accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", timelineParams.accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idEmdepSite", timelineParams.connectSiteDetailParams.idSite);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 21);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);

                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid offer = new TimelineGrid();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            if (itemRow["IdSite"] != DBNull.Value)
                            {
                                offer.IdSite = Convert.ToInt32(itemRow["IdSite"].ToString());
                            }

                            if (itemRow["IdOfferType"] != DBNull.Value)
                                offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());

                            if (itemRow["OfferStatusid"] != DBNull.Value)
                                offer.OfferStatusid = Convert.ToInt32(itemRow["OfferStatusid"].ToString());

                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.ConnectPlantId = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            offer.Group = itemRow["CustomerGroup"].ToString();
                            offer.Plant = itemRow["SiteName"].ToString();
                            offer.Country = itemRow["CustomerCountry"].ToString();
                            offer.Region = itemRow["CustomerZone"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                                offer.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                                offer.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());

                            offer.Status = itemRow["OfferStatus"].ToString();
                            offer.HtmlColor = itemRow["OfferStatusColor"].ToString();

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Amount = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            if (itemRow["IdSalesStatusType"] != DBNull.Value)
                                offer.IdSalesStatusType = Convert.ToInt32(itemRow["IdSalesStatusType"].ToString());

                            //  offer.Currency = itemRow["OfferCurrency"].ToString();
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.OfferConfidentialLevel = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                                offer.OfferCloseDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.OfferCloseDate = null;

                            if (itemRow["Rfq"] != DBNull.Value)
                                offer.Rfq = itemRow["Rfq"].ToString();

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RfqReceptionDate = Convert.ToDateTime(itemRow["RFQReception"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.RfqReceptionDate = null;

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.QuoteSentDate = Convert.ToDateTime(itemRow["SendIn"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.QuoteSentDate = null;

                            offer.Project = itemRow["CarProjectName"].ToString();
                            offer.Source = itemRow["Source"].ToString();
                            offer.BusinessUnit = itemRow["BusinessUnit"].ToString();
                            offer.Oem = itemRow["CarOEM"].ToString();

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                offer.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory = new ProductCategoryGrid();

                            }

                            offer.OptionsByOffers = new List<OptionsByOfferGrid>();
                            timelineGridRows.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            OptionsByOfferGrid optionsByOfferGrid = new OptionsByOfferGrid();
                            optionsByOfferGrid.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsByOfferGrid.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsByOfferGrid.IdOfferPlant = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsByOfferGrid.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsByOfferGrid.Quantity > 0)
                                    optionsByOfferGrid.IsSelected = true;
                                else
                                    optionsByOfferGrid.IsSelected = false;
                            }
                            else
                            {
                                optionsByOfferGrid.IsSelected = false;
                            }
                            optionsByOfferGrid.OfferOption = itemRow["offeroption"].ToString();

                            timelineGridRow.OptionsByOffers.Add(optionsByOfferGrid);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            timelineGridRow.LostCompetitor = itemRow["Name"].ToString();
                            timelineGridRow.LostDescription = itemRow["Comments"].ToString();
                            timelineGridRow.LostReason = itemRow["Reason"].ToString();

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {
                                    if (itemRow["CommentLastUpdate"] != DBNull.Value)
                                    {
                                        timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["CommentLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                    }
                                }
                            }

                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {

                                    if (itemRow["ActivityLastUpdate"] != DBNull.Value)
                                    {
                                        if (timelineGridRow.LastActivityDate == null)
                                        {
                                            timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                        else
                                        {
                                            int result = Nullable.Compare<DateTime>(Convert.ToDateTime(itemRow["ActivityLastUpdate"]), Convert.ToDateTime(timelineGridRow.LastActivityDate));
                                            if (result > 0)
                                                timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                    }

                                }
                            }

                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString()), Name = itemRow["ProductSubCategory"].ToString() }; });

                                if (itemRow["IdCategory"] != DBNull.Value)
                                {
                                    timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory.IdParent = Convert.ToInt64(itemRow["IdCategory"].ToString()); u.ProductCategory.Category = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdCategory"].ToString()), Name = itemRow["Category"].ToString() }; });
                                }
                            }

                        }
                    }
                }
            }

            return timelineGridRows;
        }


        //public List<ProductCategory> GetAllProductCategory(string connectionString)
        //{
        //    List<ProductCategory> productCategories = new List<ProductCategory>();

        //    using (MySqlConnection conn = new MySqlConnection(connectionString))
        //    {
        //        conn.Open();
        //        MySqlCommand command = new MySqlCommand("productcategories_GetAllProductCategories", conn);
        //        command.CommandType = CommandType.StoredProcedure;


        //        using (MySqlDataReader reader = command.ExecuteReader())
        //        {
        //            while (reader.Read())
        //            {
        //                ProductCategory productCategory = new ProductCategory();

        //                if (reader["IdCategory"] == DBNull.Value)
        //                {
        //                    productCategory.IdProductCategory = Convert.ToInt64(reader["IdProductSubCategory"]);
        //                    if (reader["ProductSubCategory"] != DBNull.Value)
        //                        productCategory.Name = reader["ProductSubCategory"].ToString();
        //                   // productCategory.IdParent = null;
        //                    productCategories.Add(productCategory);
        //                }
        //                else
        //                {
        //                    if (productCategories.Any(i => i.IdProductCategory == Convert.ToInt64(reader["IdCategory"])))
        //                    {
        //                        ProductCategory childProductCategory = new ProductCategory();

        //                        if (reader["IdProductSubCategory"] != DBNull.Value)
        //                            childProductCategory.IdProductCategory = Convert.ToInt64(reader["IdProductSubCategory"]);

        //                        if (reader["ProductSubCategory"] != DBNull.Value)
        //                            childProductCategory.Name = reader["ProductSubCategory"].ToString();

        //                        if (reader["IdCategory"] != DBNull.Value)
        //                            childProductCategory.IdParent = Convert.ToInt64(reader["IdCategory"]);


        //                        ProductCategory promain = productCategories.Where(i => i.IdProductCategory == Convert.ToInt64(reader["IdCategory"])).FirstOrDefault();
        //                        promain.ChildProductCategory.Add(childProductCategory);
        //                    }
        //                    else
        //                    {
        //                        if (reader["IdCategory"] != DBNull.Value)
        //                            productCategory.IdProductCategory = Convert.ToInt64(reader["IdCategory"]);
        //                        if (reader["Category"] != DBNull.Value)
        //                            productCategory.Name = reader["Category"].ToString();

        //                        productCategory.ChildProductCategory = new List<ProductCategory>();

        //                        ProductCategory childProductCategory = new ProductCategory();

        //                        if (reader["IdProductSubCategory"] != DBNull.Value)
        //                            childProductCategory.IdProductCategory = Convert.ToInt64(reader["IdProductSubCategory"]);

        //                        if (reader["ProductSubCategory"] != DBNull.Value)
        //                            childProductCategory.Name = reader["ProductSubCategory"].ToString();

        //                        if (reader["IdCategory"] != DBNull.Value)
        //                            childProductCategory.IdParent = Convert.ToInt64(reader["IdCategory"]);

        //                        productCategory.ChildProductCategory.Add(childProductCategory);
        //                        productCategories.Add(productCategory);
        //                    }
        //                }
        //            }

        //        }
        //    }

        //    return productCategories;
        //}

        //public List<ProductCategory> GetAllProductCategories(string connectionString)
        //{
        //    List<ProductCategory> productCategories = new List<ProductCategory>();

        //    using (MySqlConnection conn = new MySqlConnection(connectionString))
        //    {
        //        conn.Open();
        //        MySqlCommand command = new MySqlCommand("productcategories_GetAllProductCategories", conn);
        //        command.CommandType = CommandType.StoredProcedure;


        //        using (MySqlDataReader reader = command.ExecuteReader())
        //        {
        //            while (reader.Read())
        //            {
        //                ProductCategory productCategory = new ProductCategory();

        //                if (reader["IdCategory"] != DBNull.Value)
        //                {
        //                    productCategory.IdParent = Convert.ToInt64(reader["IdCategory"]);
        //                }
        //                else
        //                {
        //                    productCategory.IdProductCategory = Convert.ToInt64(reader["IdProductSubCategory"]);
        //                  //  productCategory.IdParent = null;
        //                }

        //                if (reader["Category"] != DBNull.Value)
        //                    productCategory.Name = reader["Category"].ToString();

        //                if (reader["IdProductSubCategory"] != DBNull.Value)
        //                {
        //                    productCategory.Category = new ProductCategory();
        //                    productCategory.Category.IdProductCategory= Convert.ToInt64(reader["IdProductSubCategory"]);
        //                    productCategory.Category.Name = reader["ProductSubCategory"].ToString();


        //                }
        //                if (reader["IdCategory"] != DBNull.Value)
        //                    productCategory.MergedCategoryAndProduct = productCategory.Name + " -> " + productCategory.Category.Name;
        //                else
        //                    productCategory.MergedCategoryAndProduct = productCategory.Category.Name;


        //                productCategories.Add(productCategory);
        //            }

        //        }
        //    }

        //    return productCategories;
        //}


        public List<ProductCategory> GetAllCategory(string connectionString)
        {
            List<ProductCategory> productCategories = new List<ProductCategory>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();
                MySqlCommand command = new MySqlCommand("productcategories_GetAllCategory", conn);
                command.CommandType = CommandType.StoredProcedure;


                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ProductCategory productCategory = new ProductCategory();

                        if (reader["IdParent"] != DBNull.Value)
                            productCategory.IdParent = Convert.ToInt64(reader["IdParent"]);
                        if (reader["Name"] != DBNull.Value)
                            productCategory.Name = reader["Name"].ToString();
                        if (reader["IdProductCategory"] != DBNull.Value)
                            productCategory.IdProductCategory = Convert.ToInt64(reader["IdProductCategory"].ToString());
                        if (reader["Level"] != DBNull.Value)
                            productCategory.Level = Convert.ToInt32(reader["Level"].ToString());
                        if (reader["Position"] != DBNull.Value)
                            productCategory.Position = Convert.ToInt64(reader["Position"].ToString());

                        productCategories.Add(productCategory);
                    }

                }
            }

            return productCategories;
        }


        public List<ProductCategoryOfferOption> GetAllCategoryOfferOption(string connectionString)
        {
            List<ProductCategoryOfferOption> productCategories = new List<ProductCategoryOfferOption>();

            using (MySqlConnection conn = new MySqlConnection(connectionString))
            {
                conn.Open();
                MySqlCommand command = new MySqlCommand("productcategories_GetAllCategoryOfferOption", conn);
                command.CommandType = CommandType.StoredProcedure;


                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ProductCategoryOfferOption productCategory = new ProductCategoryOfferOption();

                        if (reader["IdProductCategoryOfferOption"] != DBNull.Value)
                            productCategory.IdProductCategoryOfferOption = Convert.ToInt64(reader["IdProductCategoryOfferOption"]);
                        if (reader["IdProductCategory"] != DBNull.Value)
                            productCategory.IdProductCategory = Convert.ToInt64(reader["IdProductCategory"].ToString());
                        if (reader["IdOfferOption"] != DBNull.Value)
                            productCategory.IdOfferOption = Convert.ToInt64(reader["IdOfferOption"].ToString());
                        if (reader["IsPermitted"] != DBNull.Value)
                            productCategory.IsPermitted = Convert.ToSByte(reader["IsPermitted"].ToString());

                        productCategories.Add(productCategory);
                    }

                }
            }

            return productCategories;
        }

        public Int64? GetIdProductCategoryByIdOffer(Int64 idOffer, string connectPlant)
        {
            Int64? idProductCategory = null;

            using (MySqlConnection conn = new MySqlConnection(connectPlant))
            {
                conn.Open();
                MySqlCommand command = new MySqlCommand("productcategories_GetIdProductCategoryByIdOffer", conn);
                command.CommandType = CommandType.StoredProcedure;

                command.Parameters.AddWithValue("_idOffer", idOffer);
                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        if (reader["IdProductCategory"] != DBNull.Value)
                            idProductCategory = Convert.ToInt64(reader["IdProductCategory"].ToString());
                    }
                }
            }

            return idProductCategory;
        }

        public List<SalesUser> GetAllSalesUserQuotaPeopleDetailsByDatewise(byte idCurrency, string connectionString, string connectionWorkbenchString, Int32 accountingFromYear, Int32 accountingToYear)
        {
            List<SalesUser> salesUsers = new List<SalesUser>();
            DataTable dtsalesUser = new DataTable();
            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("salesusers_GetAllSalesUserQuotaPeopleDetailsByDatewise", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingToYear", accountingToYear);
                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);

                da.Fill(dtsalesUser);
            }
            foreach (DataRow itemRow in dtsalesUser.Rows)
            {
                if (!salesUsers.Any(su => su.IdSalesUser == Convert.ToInt32(itemRow["IdSalesUser"].ToString())))
                {
                    SalesUser salesUser = new SalesUser();
                    if (itemRow["IdSalesTeam"] != DBNull.Value)
                        salesUser.IdSalesTeam = Convert.ToInt32(itemRow["IdSalesTeam"].ToString());

                    if (itemRow["IdSalesUser"] != DBNull.Value)
                        salesUser.IdSalesUser = Convert.ToInt32(itemRow["IdSalesUser"].ToString());

                    //if (itemRow["IdSalesQuotaCurrency"] != DBNull.Value)
                    //    salesUser.IdSalesQuotaCurrency = Convert.ToByte(itemRow["IdSalesQuotaCurrency"].ToString());

                    //if (itemRow["SalesQuotaAmount"] != DBNull.Value)
                    //    salesUser.SalesQuotaAmount = Convert.ToDouble(itemRow["SalesQuotaAmount"].ToString());

                    //if (itemRow["ExchangeRateDate"] != DBNull.Value)
                    //    salesUser.ExchangeRateDate = Convert.ToDateTime(itemRow["ExchangeRateDate"].ToString());

                    if (itemRow["IdSalesPlant"] != DBNull.Value)
                    {
                        salesUser.IdSalesPlant = Convert.ToInt32(itemRow["IdSalesPlant"].ToString());
                        salesUser.Company = new Company();
                        salesUser.Company.IdCompany = Convert.ToInt32(itemRow["IdSalesPlant"].ToString());
                        salesUser.Company.ShortName = itemRow["Plant"].ToString();
                    }

                    salesUser.LookupValue = new LookupValue();
                    salesUser.LookupValue.IdLookupValue = Convert.ToInt32(itemRow["IdSalesTeam"].ToString());
                    salesUser.LookupValue.Value = itemRow["TeamUser"].ToString();
                    if (itemRow["IdPerson"] != DBNull.Value)
                    {
                        salesUser.People = new People();
                        salesUser.People.IdPerson = Convert.ToInt32(itemRow["IdPerson"].ToString());
                        salesUser.People.Name = itemRow["Name"].ToString();
                        salesUser.People.Surname = itemRow["Surname"].ToString();
                        salesUser.People.Email = itemRow["Email"].ToString();
                        salesUser.People.IsStillActive = Convert.ToByte(itemRow["IsStillActive"]);
                        salesUser.People.Phone = itemRow["Phone"].ToString();
                        if (itemRow["IdPersonGender"] != DBNull.Value)
                        {
                            salesUser.People.IdPersonGender = Convert.ToByte(itemRow["IdPersonGender"].ToString());
                            if (salesUser.People.IdPersonGender == 1)
                                salesUser.People.UserGender = "Female";
                            else if (salesUser.People.IdPersonGender == 2)
                                salesUser.People.UserGender = "Male";
                        }
                        salesUser.People.Company = new Company();
                        salesUser.People.Company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                        salesUser.People.Company.ShortName = itemRow["Office"].ToString();
                        salesUser.People.Company.Country = new Country();
                        salesUser.People.Company.Country.IdCountry = Convert.ToByte(itemRow["IdCountry"].ToString());
                        salesUser.People.Company.Country.Name = itemRow["Country"].ToString();
                        salesUser.People.Company.Country.Zone = new Zone();
                        salesUser.People.Company.Country.Zone.IdZone = Convert.ToInt32(itemRow["IdZone"].ToString());
                        salesUser.People.Company.Country.Zone.Name = itemRow["Region"].ToString();
                    }

                    salesUser.SalesUserQuotas = new List<SalesUserQuota>();
                    SalesUserQuota salesUserQuota = new SalesUserQuota();

                    if (itemRow["IdSalesUser"] != DBNull.Value)
                        salesUserQuota.IdSalesUser = Convert.ToInt32(itemRow["IdSalesUser"].ToString());

                    if (itemRow["IdSalesQuotaCurrency"] != DBNull.Value)
                        salesUserQuota.IdSalesQuotaCurrency = Convert.ToByte(itemRow["IdSalesQuotaCurrency"].ToString());

                    if (itemRow["SalesQuotaAmount"] != DBNull.Value)
                        salesUserQuota.SalesQuotaAmount = Convert.ToDouble(itemRow["SalesQuotaAmount"].ToString());

                    if (itemRow["SalesQuotaAmountWithExchangeRate"] != DBNull.Value)
                        salesUserQuota.SalesQuotaAmountWithExchangeRate = Convert.ToDouble(itemRow["SalesQuotaAmountWithExchangeRate"].ToString());

                    if (itemRow["ExchangeRateDate"] != DBNull.Value)
                        salesUserQuota.ExchangeRateDate = Convert.ToDateTime(itemRow["ExchangeRateDate"].ToString());

                    if (itemRow["Year"] != DBNull.Value)
                        salesUserQuota.Year = Convert.ToInt32(itemRow["Year"].ToString());

                    salesUser.SalesUserQuotas.Add(salesUserQuota);

                    salesUser.UserPermission = new List<UserPermission>();
                    if (itemRow["IdSalesUser"] != DBNull.Value)
                    {
                        using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionWorkbenchString))
                        {
                            conofferwithoutpurchaseorder.Open();
                            //MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("select up.IdUser, up.IdPermission,p.PermissionName from user_permissions up inner join permissions p on up.IdPermission=p.IdPermission where IdUser = " + salesUser.IdSalesUser + "  group by up.IdUser, up.IdPermission;", conofferwithoutpurchaseorder);
                            //conofferwithoutpurchaseordercommand.CommandType = CommandType.Text;

                            MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("users_GetUserPermission", conofferwithoutpurchaseorder);
                            conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                            conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_IdUser", salesUser.IdSalesUser);
                            using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                            {
                                while (offerreader.Read())
                                {
                                    UserPermission userPermission = new UserPermission();
                                    if (offerreader["IdUser"] != DBNull.Value)
                                        userPermission.IdUser = Convert.ToInt32(offerreader["IdUser"].ToString());
                                    if (offerreader["IdPermission"] != DBNull.Value)
                                    {
                                        userPermission.IdPermission = Convert.ToInt32(offerreader["IdPermission"].ToString());
                                        userPermission.Permission = new Permission();
                                        userPermission.Permission.IdPermission = Convert.ToInt32(offerreader["IdPermission"].ToString());
                                        userPermission.Permission.PermissionName = offerreader["PermissionName"].ToString();
                                    }
                                    salesUser.UserPermission.Add(userPermission);
                                }
                            }
                        }
                    }
                    salesUser.SiteUserPermission = new List<SiteUserPermission>();
                    if (itemRow["IdSalesUser"] != DBNull.Value)
                    {
                        using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionWorkbenchString))
                        {
                            conofferwithoutpurchaseorder.Open();
                            MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("users_GetSiteUserPermission", conofferwithoutpurchaseorder);
                            conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                            conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_IdUser", salesUser.IdSalesUser);
                            using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                            {
                                while (offerreader.Read())
                                {
                                    SiteUserPermission siteUserPermission = new SiteUserPermission();
                                    if (offerreader["IdUser"] != DBNull.Value)
                                        siteUserPermission.IdUser = Convert.ToInt32(offerreader["IdUser"].ToString());
                                    if (offerreader["IdCompany"] != DBNull.Value)
                                    {
                                        siteUserPermission.IdCompany = Convert.ToInt32(offerreader["IdCompany"].ToString());
                                        siteUserPermission.Company = new Company();
                                        siteUserPermission.Company.IdCompany = Convert.ToInt32(offerreader["IdCompany"].ToString());
                                        siteUserPermission.Company.ShortName = offerreader["ShortName"].ToString();
                                    }
                                    salesUser.SiteUserPermission.Add(siteUserPermission);
                                }
                            }
                        }
                    }
                    salesUsers.Add(salesUser);
                }
                else
                {
                    SalesUser salesUser = salesUsers.Where(i => i.IdSalesUser == Convert.ToInt32(itemRow["IdSalesUser"].ToString())).FirstOrDefault();
                    if (salesUser != null)
                    {
                        SalesUserQuota salesUserQuota = new SalesUserQuota();

                        if (itemRow["IdSalesUser"] != DBNull.Value)
                            salesUserQuota.IdSalesUser = Convert.ToInt32(itemRow["IdSalesUser"].ToString());

                        if (itemRow["IdSalesQuotaCurrency"] != DBNull.Value)
                            salesUserQuota.IdSalesQuotaCurrency = Convert.ToByte(itemRow["IdSalesQuotaCurrency"].ToString());

                        if (itemRow["SalesQuotaAmount"] != DBNull.Value)
                            salesUserQuota.SalesQuotaAmount = Convert.ToDouble(itemRow["SalesQuotaAmount"].ToString());

                        if (itemRow["SalesQuotaAmountWithExchangeRate"] != DBNull.Value)
                            salesUserQuota.SalesQuotaAmountWithExchangeRate = Convert.ToDouble(itemRow["SalesQuotaAmountWithExchangeRate"].ToString());

                        if (itemRow["ExchangeRateDate"] != DBNull.Value)
                            salesUserQuota.ExchangeRateDate = Convert.ToDateTime(itemRow["ExchangeRateDate"].ToString());

                        if (itemRow["Year"] != DBNull.Value)
                            salesUserQuota.Year = Convert.ToInt32(itemRow["Year"].ToString());

                        salesUser.SalesUserQuotas.Add(salesUserQuota);
                    }

                }

            }
            return salesUsers;
        }

        public List<Activity> GetPlannedAppiontmentByUserIdIsInternal(string connectionstring, Int32 idActiveUser, DateTime accountingYearFrom, DateTime accountingYearTo)
        {
            List<Activity> listActivities = new List<Activity>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("activities_GetPlannedAppiontmentByUserIdIsInternal", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdActiveUser", idActiveUser);
                mySqlCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                mySqlCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Activity activity = new Activity();

                        activity.IdActivity = Convert.ToInt32(reader["IdActivity"].ToString());
                        if (reader["FromDate"] != DBNull.Value)
                            activity.FromDate = Convert.ToDateTime(reader["FromDate"].ToString());

                        if (reader["ToDate"] != DBNull.Value)
                            activity.ToDate = Convert.ToDateTime(reader["ToDate"].ToString());

                        if (reader["CloseDate"] != DBNull.Value)
                            activity.CloseDate = Convert.ToDateTime(reader["CloseDate"].ToString());

                        if (reader["IdActivityType"] != DBNull.Value)
                            activity.IdActivityType = Convert.ToByte(reader["IdActivityType"].ToString());

                        if (reader["IdOwner"] != DBNull.Value)
                            activity.IdOwner = Convert.ToInt32(reader["IdOwner"].ToString());

                        listActivities.Add(activity);
                    }
                }
            }

            return listActivities;
        }

        public List<ActivitiesRecurrence> GetActivitiesRecurrence(string connectionstring, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo, string idSite, Int32 idPermission)
        {
            List<ActivitiesRecurrence> activitiesRecurrences = new List<ActivitiesRecurrence>();
            List<ActivitiesRecurrence> mergedList = new List<ActivitiesRecurrence>();
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("activitiesrecurrence_GetAllActivitiesRecurrence", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_idUser", idUser);
                mySqlCommand.Parameters.AddWithValue("_accountingFromYear", accountingYearFrom);
                mySqlCommand.Parameters.AddWithValue("_accountingToYear", accountingYearTo);
                mySqlCommand.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ActivitiesRecurrence activitiesRecurrence = new ActivitiesRecurrence();
                        if (reader["IdActivityRecurrence"] != DBNull.Value)
                            activitiesRecurrence.IdActivityRecurrence = Convert.ToInt64(reader["IdActivityRecurrence"].ToString());

                        if (reader["IdSite"] != DBNull.Value)
                            activitiesRecurrence.IdSite = Convert.ToInt32(reader["IdSite"].ToString());

                        if (reader["IdActivityType"] != DBNull.Value)
                            activitiesRecurrence.IdActivityType = Convert.ToInt32(reader["IdActivityType"].ToString());

                        if (reader["WeekDay"] != DBNull.Value)
                            activitiesRecurrence.WeekDay = Convert.ToString(reader["WeekDay"].ToString());

                        if (reader["Periodicity"] != DBNull.Value)
                            activitiesRecurrence.Periodicity = Convert.ToInt32(reader["Periodicity"].ToString());

                        if (reader["ActivityType"] != DBNull.Value)
                            activitiesRecurrence.ActivityType = Convert.ToString(reader["ActivityType"].ToString());


                        activitiesRecurrences.Add(activitiesRecurrence);
                    }
                }
            }

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("sites_GetCustomerDetailsForActivityRecurrence", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_idUser", idUser);
                mySqlCommand.Parameters.AddWithValue("_idPermission", idPermission);
                mySqlCommand.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ActivitiesRecurrence activitiesRecurrence = new ActivitiesRecurrence();

                        if (reader["IdSite"] != DBNull.Value)
                            activitiesRecurrence.IdSite = Convert.ToInt32(reader["IdSite"].ToString());

                        if (reader["IdCustomer"] != DBNull.Value)
                            activitiesRecurrence.IdCustomer = Convert.ToInt32(reader["IdCustomer"].ToString());

                        if (reader["CustomerCountry"] != DBNull.Value)
                            activitiesRecurrence.Country = Convert.ToString(reader["CustomerCountry"].ToString());

                        if (reader["CustomerZone"] != DBNull.Value)
                            activitiesRecurrence.Region = Convert.ToString(reader["CustomerZone"].ToString());

                        if (reader["CustomerGroup"] != DBNull.Value)
                            activitiesRecurrence.Group = Convert.ToString(reader["CustomerGroup"].ToString());

                        if (reader["SiteName"] != DBNull.Value)
                            activitiesRecurrence.SiteName = Convert.ToString(reader["SiteName"].ToString());

                        if (reader["SiteNameWithoutCountry"] != DBNull.Value)
                            activitiesRecurrence.SiteNameWithoutCountry = Convert.ToString(reader["SiteNameWithoutCountry"].ToString());

                        if (reader["IdSalesResponsible"] != DBNull.Value)
                        {
                            activitiesRecurrence.IdSalesOwner = Convert.ToInt32(reader["IdSalesResponsible"].ToString());

                            if (reader["SalesOwner"] != DBNull.Value)
                                activitiesRecurrence.SalesOwner = Convert.ToString(reader["SalesOwner"].ToString());
                        }

                        ActivitiesRecurrence getInsertedRecurrenceActivity = new ActivitiesRecurrence();
                        getInsertedRecurrenceActivity = activitiesRecurrences.Where(i => i.IdSite == activitiesRecurrence.IdSite).FirstOrDefault();
                        if (getInsertedRecurrenceActivity != null)
                        {
                            activitiesRecurrence.IdActivityRecurrence = getInsertedRecurrenceActivity.IdActivityRecurrence;
                            activitiesRecurrence.IdActivityType = getInsertedRecurrenceActivity.IdActivityType;
                            activitiesRecurrence.WeekDay = getInsertedRecurrenceActivity.WeekDay;
                            activitiesRecurrence.Periodicity = getInsertedRecurrenceActivity.Periodicity;
                        }
                        mergedList.Add(activitiesRecurrence);
                    }
                }
            }

            return mergedList;
        }


        public ActivitiesRecurrence AddActivitiesRecurrence(string mainServerConnectionString, ActivitiesRecurrence activitiesRecurrence)
        {
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("activitiesrecurrence_Insert", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdSite", activitiesRecurrence.IdSite);
                        mySqlCommand.Parameters.AddWithValue("_IdActivityType", activitiesRecurrence.IdActivityType);
                        mySqlCommand.Parameters.AddWithValue("_WeekDay", activitiesRecurrence.WeekDay);
                        mySqlCommand.Parameters.AddWithValue("_Periodicity", activitiesRecurrence.Periodicity);

                        activitiesRecurrence.IdActivityRecurrence = Convert.ToInt32(mySqlCommand.ExecuteScalar());
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();

                throw;
            }

            return activitiesRecurrence;
        }


        public ActivitiesRecurrence UpdateActivitiesRecurrence(string mainServerConnectionString, ActivitiesRecurrence activitiesRecurrence)
        {
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("activitiesrecurrence_Update", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdActivityRecurrence", activitiesRecurrence.IdActivityRecurrence);
                        mySqlCommand.Parameters.AddWithValue("_IdSite", activitiesRecurrence.IdSite);
                        mySqlCommand.Parameters.AddWithValue("_IdActivityType", activitiesRecurrence.IdActivityType);
                        mySqlCommand.Parameters.AddWithValue("_WeekDay", activitiesRecurrence.WeekDay);
                        mySqlCommand.Parameters.AddWithValue("_Periodicity", activitiesRecurrence.Periodicity);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();

                throw;
            }

            return activitiesRecurrence;
        }

        public List<ActivitiesRecurrence> GetAllActivitiesRecurrenceToCreateActivity(string connectionstring)
        {
            List<ActivitiesRecurrence> activitiesRecurrences = new List<ActivitiesRecurrence>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("activitiesrecurrence_GetAllActivitiesRecurrenceToCreateActivity", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ActivitiesRecurrence activitiesRecurrence = new ActivitiesRecurrence();
                        if (reader["IdActivityRecurrence"] != DBNull.Value)
                            activitiesRecurrence.IdActivityRecurrence = Convert.ToInt64(reader["IdActivityRecurrence"].ToString());

                        if (reader["IdActivityType"] != DBNull.Value)
                            activitiesRecurrence.IdActivityType = Convert.ToInt32(reader["IdActivityType"].ToString());

                        if (reader["IdSite"] != DBNull.Value)
                            activitiesRecurrence.IdSite = Convert.ToInt32(reader["IdSite"].ToString());

                        if (reader["WeekDay"] != DBNull.Value)
                            activitiesRecurrence.WeekDay = Convert.ToString(reader["WeekDay"].ToString());

                        if (reader["Periodicity"] != DBNull.Value)
                            activitiesRecurrence.Periodicity = Convert.ToInt32(reader["Periodicity"].ToString());

                        if (reader["Subject"] != DBNull.Value)
                            activitiesRecurrence.Subject = Convert.ToString(reader["Subject"].ToString());

                        if (reader["Description"] != DBNull.Value)
                            activitiesRecurrence.Description = Convert.ToString(reader["Description"].ToString());

                        if (reader["Location"] != DBNull.Value)
                            activitiesRecurrence.Location = Convert.ToString(reader["Location"].ToString());

                        if (reader["IdSalesOwner"] != DBNull.Value)
                            activitiesRecurrence.IdSalesOwner = Convert.ToInt32(reader["IdSalesOwner"].ToString());

                        if (reader["Latitude"] != DBNull.Value)
                            activitiesRecurrence.Latitude = Convert.ToDouble(reader["Latitude"].ToString());

                        if (reader["Longitude"] != DBNull.Value)
                            activitiesRecurrence.Longitude = Convert.ToDouble(reader["Longitude"].ToString());

                        activitiesRecurrences.Add(activitiesRecurrence);
                    }
                }
            }

            return activitiesRecurrences;
        }


        public bool CreateAutomaticPlannedActivity(string connectionString, string mainConnectionString, DateTime startDate, DateTime endDate, Int32 idUser)
        {

            List<ActivitiesRecurrence> activitiesRecurrences = new List<ActivitiesRecurrence>();
            activitiesRecurrences = GetAllActivitiesRecurrenceToCreateActivity(connectionString);
            foreach (var item in activitiesRecurrences)
            {
                if (item.Periodicity != null && item.Periodicity > 0)
                {
                    List<DateTime> allDates = new List<DateTime>();
                    int peroidcity = 1;
                    for (DateTime date = startDate; date <= endDate; date = date.AddDays(peroidcity))
                    {
                        if (date.DayOfWeek.ToString() == item.WeekDay)
                        {

                            peroidcity = item.Periodicity.Value;

                            TransactionScope transactionScope = null;
                            try
                            {

                                using (transactionScope = new TransactionScope())
                                {
                                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainConnectionString))
                                    {
                                        mySqlConnection.Open();

                                        MySqlCommand mySqlCommand = new MySqlCommand("activities_AutomaticInsert", mySqlConnection);
                                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                                        mySqlCommand.Parameters.AddWithValue("_ToDate", date);
                                        mySqlCommand.Parameters.AddWithValue("_Subject", item.Subject);
                                        mySqlCommand.Parameters.AddWithValue("_Location", item.Location);
                                        mySqlCommand.Parameters.AddWithValue("_IdOwner", item.IdSalesOwner);
                                        mySqlCommand.Parameters.AddWithValue("_IdActivityType", item.IdActivityType);
                                        mySqlCommand.Parameters.AddWithValue("_FromDate", date);
                                        mySqlCommand.Parameters.AddWithValue("_Description", item.Description);
                                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                        mySqlCommand.Parameters.AddWithValue("_CreatedBy", idUser);
                                        mySqlCommand.Parameters.AddWithValue("_IdSite", item.IdSite);
                                        mySqlCommand.Parameters.AddWithValue("_Latitude", item.Latitude);
                                        mySqlCommand.Parameters.AddWithValue("_Longitude", item.Longitude);

                                        int lastInsertedId = Convert.ToInt32(mySqlCommand.ExecuteScalar());
                                        mySqlConnection.Close();
                                    }

                                    transactionScope.Complete();
                                }
                            }
                            catch (Exception ex)
                            {
                                if (Transaction.Current != null)
                                    Transaction.Current.Rollback();

                                if (transactionScope != null)
                                    transactionScope.Dispose();

                                throw;
                            }

                        }


                        else
                        {
                            peroidcity = 1;
                        }
                    }

                }
            }
            return true;
        }

        public CustomerTargetDetail GetTop5CustomersDashboardDetails(byte idCurrency, Int32 idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, string assignedPlant, bool isTarget = false)
        {
            CustomerTargetDetail customerTargetDetail = new CustomerTargetDetail();
            customerTargetDetail.CustomerDetail = new List<CustomerDetail>();
            List<CompanyDetail> companiesSortLst = new List<CompanyDetail>();
            List<CustomerSort> Lstsort = new List<CustomerSort>();
            CustomerDetail customer = new CustomerDetail();


            using (MySqlConnection conoffertarget = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conoffertarget.Open();
                MySqlCommand concompaniescommand = new MySqlCommand("sites_GetTop5CustomersDashboardDetails", conoffertarget);
                concompaniescommand.CommandType = CommandType.StoredProcedure;
                concompaniescommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concompaniescommand.Parameters.AddWithValue("_idCurrentUser", idUser);
                concompaniescommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                concompaniescommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                concompaniescommand.Parameters.AddWithValue("_isTarget", isTarget);
                concompaniescommand.Parameters.AddWithValue("_assignedPlant", assignedPlant);

                using (MySqlDataReader itemRow = concompaniescommand.ExecuteReader())
                {
                    while (itemRow.Read())
                    {
                        if (customerTargetDetail.CustomerDetail.Any(cust => cust.IdCustomer == Convert.ToInt32(itemRow["idCustomer"].ToString())))
                        {
                            CustomerDetail custold = new CustomerDetail();
                            custold = customerTargetDetail.CustomerDetail.Where(cust => cust.IdCustomer == Convert.ToInt32(itemRow["idCustomer"].ToString())).SingleOrDefault();
                            if (custold.Companies.Any(comp => comp.IdCompany == Convert.ToInt32(itemRow["IdSite"].ToString())))
                            {
                                CompanyDetail compold = new CompanyDetail();
                                compold = custold.Companies.Where(comp => comp.IdCompany == Convert.ToInt32(itemRow["IdSite"].ToString())).SingleOrDefault();
                                if (compold.SalesStatusTypeDetail.Any(ss => ss.Name == itemRow["Name"].ToString()))
                                {
                                    SalesStatusTypeDetail salesStatusType = new SalesStatusTypeDetail();
                                    salesStatusType = compold.SalesStatusTypeDetail.Where(ss => ss.Name == itemRow["Name"].ToString()).SingleOrDefault();
                                    salesStatusType.TotalAmount = salesStatusType.TotalAmount + Convert.ToDouble(itemRow["Amount"].ToString());
                                    if (salesStatusType.IdSalesStatusType == 4)
                                    {
                                        if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany))
                                        {
                                            CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany).FirstOrDefault();
                                            custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                        }
                                        else
                                        {
                                            CustomerSort custsort = new CustomerSort();
                                            custsort.IdCustomer = custold.IdCustomer;
                                            custsort.IdSite = compold.IdCompany;
                                            custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                            Lstsort.Add(custsort);
                                        }

                                    }
                                }
                                else
                                {
                                    SalesStatusTypeDetail salesStatusType = new SalesStatusTypeDetail();
                                    salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                                    salesStatusType.Name = itemRow["Name"].ToString();
                                    salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());

                                    compold.SalesStatusTypeDetail.Add(salesStatusType);
                                    if (salesStatusType.IdSalesStatusType == 4)
                                    {
                                        if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany))
                                        {
                                            CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany).FirstOrDefault();
                                            custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                        }
                                        else
                                        {
                                            CustomerSort custsort = new CustomerSort();
                                            custsort.IdCustomer = custold.IdCustomer;
                                            custsort.IdSite = compold.IdCompany;
                                            custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                            Lstsort.Add(custsort);
                                        }
                                    }
                                }

                            }
                            else
                            {
                                CompanyDetail company = new CompanyDetail();
                                company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                                company.Name = itemRow["CustomerPlant"].ToString();
                                company.SiteNameWithoutCountry = itemRow["SiteName"].ToString();
                                company.CountryName = itemRow["Country"].ToString();

                                company.SalesStatusTypeDetail = new List<SalesStatusTypeDetail>() { new SalesStatusTypeDetail { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["Name"].ToString(), TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString()) } };
                                if (itemRow["IdSalesStatusType"].ToString() == "4")
                                {
                                    if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == company.IdCompany))
                                    {
                                        CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == company.IdCompany).FirstOrDefault();
                                        custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                    }
                                    else
                                    {
                                        CustomerSort custsort = new CustomerSort();
                                        custsort.IdCustomer = custold.IdCustomer;
                                        custsort.IdSite = company.IdCompany;
                                        custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                        Lstsort.Add(custsort);
                                    }
                                }
                                custold.Companies.Add(company);
                            }
                        }
                        else
                        {
                            customer = new CustomerDetail();
                            customer.IdCustomer = Convert.ToInt32(itemRow["idCustomer"].ToString());
                            customer.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                            customer.CustomerName = itemRow["CustomerGroup"].ToString();
                            customer.Companies = new List<CompanyDetail>();
                            CompanyDetail company = new CompanyDetail();
                            company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                            company.Name = itemRow["CustomerPlant"].ToString();
                            company.SiteNameWithoutCountry = itemRow["SiteName"].ToString();
                            company.CountryName = itemRow["Country"].ToString();

                            company.SalesStatusTypeDetail = new List<SalesStatusTypeDetail>() { new SalesStatusTypeDetail { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["Name"].ToString(), TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString()) } };
                            if (itemRow["IdSalesStatusType"].ToString() == "4")
                            {
                                if (Lstsort.Any(ls => ls.IdCustomer == customer.IdCustomer && ls.IdSite == company.IdCompany))
                                {
                                    CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == customer.IdCustomer && ls.IdSite == company.IdCompany).FirstOrDefault();
                                    custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                }
                                else
                                {
                                    CustomerSort custsort = new CustomerSort();
                                    custsort.IdCustomer = customer.IdCustomer;
                                    custsort.IdSite = company.IdCompany;
                                    custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                    Lstsort.Add(custsort);
                                }
                            }

                            customer.Companies.Add(company);
                            customerTargetDetail.CustomerDetail.Add(customer);
                        }
                    }

                    if (customerTargetDetail.CustomerDetail.Count > 0)
                    {
                        customerTargetDetail.CustomerDetail[0].CustomerSort = new List<CustomerSort>();
                        customerTargetDetail.CustomerDetail[0].CustomerSort.AddRange(Lstsort);
                    }

                    if (isTarget)
                    {

                        if (itemRow.NextResult())
                        {
                            customerTargetDetail.TargetDetail = new List<TargetDetail>();
                            while (itemRow.Read())
                            {
                                TargetDetail company = new TargetDetail();
                                company.IdSite = Convert.ToInt32(itemRow["IdSite"].ToString());
                                company.CustomerName = itemRow["CustomerName"].ToString();
                                company.CountryName = itemRow["CustomerCountry"].ToString();
                                company.CustomerGroup = itemRow["CustomerGroup"].ToString();

                                if (itemRow["TargetAmount"] != DBNull.Value)
                                    company.TargetAmount = Convert.ToDecimal(itemRow["TargetAmount"].ToString());

                                if (itemRow["TargetAmountWithExchangeRate"] != DBNull.Value)
                                    company.TargetAmountWithExchangeRate = Convert.ToDecimal(itemRow["TargetAmountWithExchangeRate"].ToString());

                                if (itemRow["TargetSalesIdCurrency"] != DBNull.Value)
                                    company.TargetIdCurrency = Convert.ToByte(itemRow["TargetSalesIdCurrency"].ToString());

                                company.CurrencyName = itemRow["TargetSalesCurrency"].ToString();
                                company.Symbol = itemRow["TargetSalesCurrencySymbol"].ToString();
                                if (itemRow["Year"] != DBNull.Value)
                                    company.Year = Convert.ToInt32(itemRow["Year"].ToString());


                                customerTargetDetail.TargetDetail.Add(company);
                            }
                        }
                    }
                }
            }

            return customerTargetDetail;
        }



        public List<SalesUserQuota> GetAllSalesTeamUserDetail(string connectionString, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, string assignedPlants)
        {

            List<SalesUserQuota> salesUsers = new List<SalesUserQuota>();

            using (MySqlConnection conSalesUser = new MySqlConnection(connectionString))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("salesusers_GetAllSalesTeamUserDetail", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conSalesUsercommand.Parameters.AddWithValue("_assignedPlants", assignedPlants);

                using (MySqlDataReader salesUserreader = conSalesUsercommand.ExecuteReader())
                {
                    while (salesUserreader.Read())
                    {
                        SalesUserQuota salesUser = new SalesUserQuota();
                        if (salesUserreader["IdSalesUser"] != DBNull.Value)
                            salesUser.IdSalesUser = Convert.ToInt32(salesUserreader["IdSalesUser"].ToString());
                        if (salesUserreader["IdSalesQuotaCurrency"] != DBNull.Value)
                            salesUser.IdSalesQuotaCurrency = Convert.ToByte(salesUserreader["IdSalesQuotaCurrency"].ToString());
                        if (salesUserreader["SalesQuotaAmount"] != DBNull.Value)
                            salesUser.SalesQuotaAmount = Convert.ToDouble(salesUserreader["SalesQuotaAmount"].ToString());
                        if (salesUserreader["Year"] != DBNull.Value)
                            salesUser.Year = Convert.ToInt32(salesUserreader["Year"].ToString());
                        if (salesUserreader["IdPerson"] != DBNull.Value)
                        {
                            salesUser.People = new People();

                            salesUser.People.IdPerson = Convert.ToInt32(salesUserreader["IdPerson"].ToString());
                            salesUser.People.Name = salesUserreader["Name"].ToString();
                            salesUser.People.Surname = salesUserreader["Surname"].ToString();
                        }
                        salesUser.SalesUserActivity = new List<SalesUserActivity>();
                        salesUsers.Add(salesUser);
                    }
                    if (salesUserreader.NextResult())
                    {
                        while (salesUserreader.Read())
                        {
                            if (salesUserreader["IdOwner"] != DBNull.Value)
                            {
                                SalesUserQuota salesUser = salesUsers.Where(i => i.IdSalesUser == Convert.ToInt32(salesUserreader["IdOwner"])).FirstOrDefault();
                                if (salesUser != null)
                                {
                                    SalesUserActivity salesUserActivity = new SalesUserActivity();

                                    if (salesUserreader["IdActivity"] != DBNull.Value)
                                        salesUserActivity.IdActivity = Convert.ToInt64(salesUserreader["IdActivity"]);

                                    if (salesUserreader["FromDate"] != DBNull.Value)
                                        salesUserActivity.FromDate = Convert.ToDateTime(salesUserreader["FromDate"]);

                                    if (salesUserreader["ToDate"] != DBNull.Value)
                                        salesUserActivity.ToDate = Convert.ToDateTime(salesUserreader["ToDate"]);


                                    if (salesUserreader["CloseDate"] != DBNull.Value)
                                        salesUserActivity.CloseDate = Convert.ToDateTime(salesUserreader["CloseDate"]);

                                    if (salesUserreader["IdActivityType"] != DBNull.Value)
                                        salesUserActivity.IdActivityType = Convert.ToInt32(salesUserreader["IdActivityType"]);

                                    if (salesUserreader["IsCompleted"] != DBNull.Value)
                                        salesUserActivity.IsCompleted = Convert.ToByte(salesUserreader["IsCompleted"].ToString());

                                    if (salesUserreader["IdOwner"] != DBNull.Value)
                                        salesUserActivity.IdOwner = Convert.ToInt32(salesUserreader["IdOwner"]);

                                    salesUser.SalesUserActivity.Add(salesUserActivity);

                                    Decimal ytd = 0;
                                    Decimal period = 0;
                                    salesUser.Total = salesUser.Total + 1;
                                    try
                                    {
                                        ytd = (Convert.ToDecimal(salesUser.SalesUserActivity.Where(a => a.IdActivityType == 96 && a.IsCompleted == 1 && a.CloseDate <= DateTime.Now).ToList().Count()) / (salesUser.SalesUserActivity.Where(a => a.IdActivityType == 96 && a.ToDate <= DateTime.Now).ToList().Count())) * 100;
                                    }
                                    catch (DivideByZeroException dbze)
                                    {
                                        ytd = 0;
                                    }

                                    try
                                    {
                                        period = ((decimal)(salesUser.SalesUserActivity.Where(a => a.IdActivityType == 96 && a.IsCompleted == 1 && a.CloseDate >= accountingYearFrom && a.CloseDate <= accountingYearTo).ToList().Count()) / (salesUser.SalesUserActivity.Where(a => a.IdActivityType == 96 && a.ToDate >= accountingYearFrom && a.ToDate <= accountingYearTo).ToList().Count())) * 100;
                                    }
                                    catch (DivideByZeroException dbze)
                                    {
                                        period = 0;
                                    }

                                    salesUser.YTD = Convert.ToDouble(Math.Round(ytd, 2));
                                    salesUser.Period = Convert.ToDouble(Math.Round(period, 2));
                                }
                                else
                                {
                                    salesUser.Total = 0;
                                    salesUser.YTD = 0.0;
                                    salesUser.Period = 0.0;
                                }

                            }
                        }

                    }
                }
            }


            return salesUsers;
        }


        public List<SalesUserWon> GetAllSalesTeamUserWonDetail(Company company, byte idCurrency, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Int32 idCurrentUser)
        {
            List<SalesUserWon> salesUserWons = new List<SalesUserWon>();

            using (MySqlConnection conSalesUser = new MySqlConnection(company.ConnectPlantConstr))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("salesusers_GetAllSalesTeamUserWonDetail", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conSalesUsercommand.Parameters.AddWithValue("_idSalesUser", idUser);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conSalesUsercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                using (MySqlDataReader salesUserreader = conSalesUsercommand.ExecuteReader())
                {
                    while (salesUserreader.Read())
                    {
                        SalesUserWon salesUserWon = new SalesUserWon();
                        if (salesUserreader["Amount"] != DBNull.Value)
                            salesUserWon.Amount = Convert.ToDouble(salesUserreader["Amount"].ToString());

                        if (salesUserreader["OfferCurrency"] != DBNull.Value)
                            salesUserWon.Currency = salesUserreader["OfferCurrency"].ToString();

                        if (salesUserreader["idsalesresponsible"] != DBNull.Value)
                            salesUserWon.Idsalesresponsible = Convert.ToInt32(salesUserreader["idsalesresponsible"].ToString());

                        if (salesUserreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            salesUserWon.IdSalesResponsibleAssemblyBU = Convert.ToInt32(salesUserreader["IdSalesResponsibleAssemblyBU"].ToString());

                        if (salesUserreader["IdSalesOwner"] != DBNull.Value)
                            salesUserWon.IdSalesOwner = Convert.ToInt32(salesUserreader["IdSalesOwner"].ToString());

                        salesUserWons.Add(salesUserWon);
                    }
                }
            }

            return salesUserWons;
        }


        public BusinessUnitTargetDetail GetBusinessUnitStatusWithTarget(byte idCurrency, string assignedPlant, DateTime accountingYearFrom, DateTime accountingYearTo, Int32 idCurrentUser, Company company, bool isTarget = false)
        {
            BusinessUnitTargetDetail businessUnitTargetDetail = new BusinessUnitTargetDetail();
            businessUnitTargetDetail.BusinessUnitDetail = new List<BusinessUnitDetail>();
            try
            {
                using (MySqlConnection consite = new MySqlConnection(company.ConnectPlantConstr))
                {
                    consite.Open();
                    MySqlCommand consitecommand = new MySqlCommand("offers_GetBusinessUnitStatusWithTarget", consite);
                    consitecommand.CommandType = CommandType.StoredProcedure;
                    consitecommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                    consitecommand.Parameters.AddWithValue("_assignedPlant", assignedPlant);
                    consitecommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                    consitecommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                    consitecommand.Parameters.AddWithValue("_isTarget", isTarget);
                    consitecommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                    using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                    {
                        while (sitereader.Read())
                        {
                            if (sitereader["IdBusinessUnit"] != DBNull.Value)
                            {
                                if (businessUnitTargetDetail.BusinessUnitDetail.Any(lv => lv.IdLookupValue == Convert.ToInt32(sitereader["IdBusinessUnit"].ToString())))
                                {
                                    BusinessUnitDetail lookupValue = businessUnitTargetDetail.BusinessUnitDetail.Where(lv => lv.IdLookupValue == Convert.ToInt32(sitereader["IdBusinessUnit"].ToString())).FirstOrDefault();
                                    SalesStatusTypeDetail salesStatusType = new SalesStatusTypeDetail();
                                    if (sitereader["IdSalesStatusType"] != DBNull.Value)
                                        salesStatusType.IdSalesStatusType = Convert.ToInt64(sitereader["IdSalesStatusType"].ToString());
                                    if (sitereader["Status"] != DBNull.Value)
                                        salesStatusType.Name = sitereader["Status"].ToString();
                                    if (sitereader["Amount"] != DBNull.Value)
                                        salesStatusType.TotalAmount = Convert.ToDouble(sitereader["Amount"].ToString());
                                    if (sitereader["IdCurrency"] != DBNull.Value)
                                    {

                                        salesStatusType.IdCurrency = Convert.ToByte(sitereader["IdCurrency"].ToString());
                                        salesStatusType.Name = sitereader["Currency"].ToString();
                                    }
                                    lookupValue.SalesStatusTypeDetail.Add(salesStatusType);
                                }
                                else
                                {
                                    BusinessUnitDetail lookupValue = new BusinessUnitDetail();
                                    lookupValue.IdLookupValue = Convert.ToInt32(sitereader["IdBusinessUnit"].ToString());
                                    lookupValue.Value = sitereader["BusinessUnit"].ToString();
                                    lookupValue.SalesStatusTypeDetail = new List<SalesStatusTypeDetail>();
                                    SalesStatusTypeDetail salesStatusType = new SalesStatusTypeDetail();
                                    if (sitereader["IdSalesStatusType"] != DBNull.Value)
                                        salesStatusType.IdSalesStatusType = Convert.ToInt64(sitereader["IdSalesStatusType"].ToString());
                                    if (sitereader["Status"] != DBNull.Value)
                                        salesStatusType.Name = sitereader["Status"].ToString();
                                    if (sitereader["Amount"] != DBNull.Value)
                                        salesStatusType.TotalAmount = Convert.ToDouble(sitereader["Amount"].ToString());
                                    if (sitereader["IdCurrency"] != DBNull.Value)
                                    {
                                        salesStatusType.IdCurrency = Convert.ToByte(sitereader["IdCurrency"].ToString());
                                        salesStatusType.Name = sitereader["Currency"].ToString();
                                    }
                                    lookupValue.SalesStatusTypeDetail.Add(salesStatusType);
                                    businessUnitTargetDetail.BusinessUnitDetail.Add(lookupValue);
                                }
                            }
                        }
                        if (isTarget)
                        {
                            if (sitereader.NextResult())
                            {
                                businessUnitTargetDetail.TargetDetail = new List<BusinessUnitDetail>();
                                while (sitereader.Read())
                                {
                                    if (sitereader["IdBusinessUnit"] != DBNull.Value)
                                    {
                                        BusinessUnitDetail lookupValue = new BusinessUnitDetail();
                                        if (sitereader["IdBusinessUnit"] != DBNull.Value)
                                            lookupValue.IdLookupValue = Convert.ToInt32(sitereader["IdBusinessUnit"].ToString());
                                        if (sitereader["Value"] != DBNull.Value)
                                            lookupValue.Value = sitereader["Value"].ToString();
                                        if (sitereader["SalesQuotaAmount"] != DBNull.Value)
                                            lookupValue.Amount = Convert.ToDouble(sitereader["SalesQuotaAmount"].ToString());
                                        if (sitereader["IdSalesQuotaCurrency"] != DBNull.Value)
                                            lookupValue.IdCurrency = Convert.ToByte(sitereader["IdSalesQuotaCurrency"].ToString());
                                        businessUnitTargetDetail.TargetDetail.Add(lookupValue);
                                    }
                                }
                            }
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                throw;
            }
            return businessUnitTargetDetail;
        }

        public List<BusinessUnitDetail> GetBusinessUnitsDetails(Int32 idCurrentUser, string connectionstring)
        {
            List<BusinessUnitDetail> listBU = new List<BusinessUnitDetail>();

            using (MySqlConnection con = new MySqlConnection(connectionstring))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("businessunit_GetBusinessUnitsWithoutRestrictedBU", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                using (MySqlDataReader offerreader = concommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        BusinessUnitDetail lookupValue = new BusinessUnitDetail();
                        lookupValue.IdLookupValue = Convert.ToInt32(offerreader["IdLookupValue"].ToString());
                        lookupValue.Value = offerreader["Value"].ToString();
                        if (offerreader["IdImage"] != DBNull.Value)
                            lookupValue.IdImage = Convert.ToInt64(offerreader["IdImage"].ToString());

                        if (offerreader["HtmlColor"] != DBNull.Value)
                            lookupValue.HtmlColor = offerreader["HtmlColor"].ToString();
                        listBU.Add(lookupValue);
                    }
                }
            }

            return listBU;
        }


        public List<SalesStatusTypeDetail> GetSalesStatusTypeDetail(string connectionstring)
        {
            List<SalesStatusTypeDetail> salesStatusTypes = new List<SalesStatusTypeDetail>();

            using (MySqlConnection con = new MySqlConnection(connectionstring))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("salesstatustype_GetAllSalesStatusType", con);
                concommand.CommandType = CommandType.StoredProcedure;
                using (MySqlDataReader offerreader = concommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        SalesStatusTypeDetail salesStatusType = new SalesStatusTypeDetail();
                        salesStatusType.IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString());
                        salesStatusType.Name = offerreader["SalesStatusType"].ToString();
                        salesStatusType.IdImage = Convert.ToInt64(offerreader["IdImage"].ToString());
                        salesStatusType.HtmlColor = offerreader["HtmlColor"].ToString();

                        salesStatusTypes.Add(salesStatusType);
                    }
                }
            }

            return salesStatusTypes;
        }




        private List<PlantBusinessUnitSalesQuota> CreatedPlantBusinessUnit(Int32 idUser, Int32 idUserPermission, string connectionstring, DateTime accountingYearFrom, DateTime accountingYearTo)
        {
            List<PlantBusinessUnitSalesQuota> plantBusinessUnitSalesQuotas = new List<PlantBusinessUnitSalesQuota>();


            List<Int64> years = new List<long>();

            for (int i = accountingYearFrom.Year; i <= accountingYearTo.Year; i++)
            {
                years.Add(i);
            }

            foreach (Int32 itemYear in years)

            {
                PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();
                plantBusinessUnitSalesQuota.LookupValue = new List<LookupValue>();
                foreach (LookupValue item in GetLookupvaluesWithoutRestrictedBU(idUser, idUserPermission, connectionstring))
                {
                    plantBusinessUnitSalesQuota.IdBusinessUnit = item.IdLookupValue;

                    plantBusinessUnitSalesQuota.LookupValue.Add(item);
                    plantBusinessUnitSalesQuota.Year = itemYear;

                }

                plantBusinessUnitSalesQuotas.Add(plantBusinessUnitSalesQuota);

            }

            return plantBusinessUnitSalesQuotas;
        }

        public List<PlantBusinessUnitSalesQuota> GetPlantQuotaDetailsById(string connectionstring, Int32 idUser, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, Int32 idUserPermission, Int32 idCompany, string workbenchconnectionString)
        {
            List<PlantBusinessUnitSalesQuota> plantBusinessUnitSalesQuotas = new List<PlantBusinessUnitSalesQuota>();
            plantBusinessUnitSalesQuotas = CreatedPlantBusinessUnit(idUser, idUserPermission, workbenchconnectionString, accountingYearFrom, accountingYearTo);
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("plantbusq_GetPlantQuotaDetailsById", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;

                mySqlCommand.Parameters.AddWithValue("_idUser", idUser);
                mySqlCommand.Parameters.AddWithValue("_idCurrency", idCurrency);
                mySqlCommand.Parameters.AddWithValue("_IdCompany", idCompany);
                mySqlCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                mySqlCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                mySqlCommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = plantBusinessUnitSalesQuotas.Where(pb => pb.Year == Convert.ToInt32(reader["Year"])).FirstOrDefault();
                        if (reader["IdPlant"] != DBNull.Value)
                            plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(reader["IdPlant"].ToString());
                        LookupValue LookupValueBU = new LookupValue();
                        if (reader["IdBusinessUnit"] != DBNull.Value)
                        {
                            LookupValueBU = plantBusinessUnitSalesQuota.LookupValue.Where(i => i.IdLookupValue == Convert.ToInt32(reader["IdBusinessUnit"])).FirstOrDefault();
                            if (reader["IdSalesQuotaCurrency"] != DBNull.Value)
                                LookupValueBU.IdSalesQuotaCurrency = Convert.ToByte(reader["IdSalesQuotaCurrency"].ToString());

                            if (reader["SalesQuotaAmount"] != DBNull.Value)
                                LookupValueBU.SalesQuotaAmount = Convert.ToDouble(reader["SalesQuotaAmount"].ToString());

                            if (reader["ExchangeRateDate"] != DBNull.Value)
                            {
                                LookupValueBU.ExchangeRateDate = Convert.ToDateTime(reader["ExchangeRateDate"].ToString());
                                plantBusinessUnitSalesQuota.ExchangeRateDate = Convert.ToDateTime(reader["ExchangeRateDate"].ToString());
                            }



                            if (reader["QuotaAmountWithExchangeRate"] != DBNull.Value)
                                LookupValueBU.SalesQuotaAmountWithExchangeRate = Convert.ToDouble(reader["QuotaAmountWithExchangeRate"].ToString());
                        }

                        #region
                        //if (reader["Year"] != DBNull.Value && plantBusinessUnitSalesQuotas.Any(pb => pb.IdPlant == Convert.ToInt32(reader["IdPlant"]) && pb.Year == Convert.ToInt32(reader["Year"])))
                        //{


                        //    PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = plantBusinessUnitSalesQuotas.FirstOrDefault(pb => pb.IdPlant == Convert.ToInt32(reader["IdPlant"]) && pb.Year == Convert.ToInt32(reader["Year"]));

                        //    if (plantBusinessUnitSalesQuota != null)
                        //    {
                        //        //if (reader["IdPlant"] != DBNull.Value)
                        //        //    plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(reader["IdPlant"].ToString());

                        //        if (reader["IdBusinessUnit"] != DBNull.Value)
                        //        {
                        //            //plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(reader["IdBusinessUnit"].ToString());

                        //            LookupValue lv = new LookupValue();
                        //            lv.IdLookupValue = Convert.ToInt32(reader["IdBusinessUnit"].ToString());
                        //            lv.Value = reader["Value"].ToString();
                        //            lv.HtmlColor = reader["HtmlColor"].ToString();
                        //            if (reader["IdImage"] != DBNull.Value)
                        //                lv.IdImage = Convert.ToInt64(reader["IdImage"].ToString());

                        //            if (reader["IdSalesQuotaCurrency"] != DBNull.Value)
                        //                lv.IdSalesQuotaCurrency = Convert.ToByte(reader["IdSalesQuotaCurrency"].ToString());

                        //            if (reader["SalesQuotaAmount"] != DBNull.Value)
                        //                lv.SalesQuotaAmount = Convert.ToDouble(reader["SalesQuotaAmount"].ToString());

                        //            if (reader["ExchangeRateDate"] != DBNull.Value)
                        //            {
                        //                lv.ExchangeRateDate = Convert.ToDateTime(reader["ExchangeRateDate"].ToString());
                        //                plantBusinessUnitSalesQuota.ExchangeRateDate = Convert.ToDateTime(reader["ExchangeRateDate"].ToString());
                        //            }



                        //            if (reader["QuotaAmountWithExchangeRate"] != DBNull.Value)
                        //                lv.SalesQuotaAmountWithExchangeRate = Convert.ToDouble(reader["QuotaAmountWithExchangeRate"].ToString());

                        //            plantBusinessUnitSalesQuota.LookupValue.Add(lv);
                        //        }


                        //    }
                        //}
                        //else
                        //{
                        //    PlantBusinessUnitSalesQuota plantBusinessUnitSalesQuota = new PlantBusinessUnitSalesQuota();


                        //    if (reader["IdPlant"] != DBNull.Value)
                        //        plantBusinessUnitSalesQuota.IdPlant = Convert.ToInt32(reader["IdPlant"].ToString());

                        //    if (reader["IdBusinessUnit"] != DBNull.Value)
                        //    {
                        //        plantBusinessUnitSalesQuota.IdBusinessUnit = Convert.ToInt32(reader["IdBusinessUnit"].ToString());
                        //        plantBusinessUnitSalesQuota.LookupValue = new List<LookupValue>();

                        //        LookupValue lv = new LookupValue();
                        //        lv.IdLookupValue = Convert.ToInt32(reader["IdBusinessUnit"].ToString());
                        //        lv.Value = reader["Value"].ToString();

                        //        lv.HtmlColor = reader["HtmlColor"].ToString();
                        //        if (reader["IdImage"] != DBNull.Value)
                        //            lv.IdImage = Convert.ToInt64(reader["IdImage"].ToString());

                        //        if (reader["IdSalesQuotaCurrency"] != DBNull.Value)
                        //            lv.IdSalesQuotaCurrency = Convert.ToByte(reader["IdSalesQuotaCurrency"].ToString());

                        //        if (reader["SalesQuotaAmount"] != DBNull.Value)
                        //            lv.SalesQuotaAmount = Convert.ToDouble(reader["SalesQuotaAmount"].ToString());

                        //        if (reader["ExchangeRateDate"] != DBNull.Value)
                        //        {
                        //            lv.ExchangeRateDate = Convert.ToDateTime(reader["ExchangeRateDate"].ToString());
                        //            plantBusinessUnitSalesQuota.ExchangeRateDate = Convert.ToDateTime(reader["ExchangeRateDate"].ToString());
                        //        }


                        //        if (reader["QuotaAmountWithExchangeRate"] != DBNull.Value)
                        //            lv.SalesQuotaAmountWithExchangeRate = Convert.ToDouble(reader["QuotaAmountWithExchangeRate"].ToString());
                        //        plantBusinessUnitSalesQuota.LookupValue.Add(lv);
                        //    }

                        //    if (reader["Year"] != DBNull.Value)
                        //        plantBusinessUnitSalesQuota.Year = Convert.ToInt32(reader["Year"].ToString());



                        //    plantBusinessUnitSalesQuotas.Add(plantBusinessUnitSalesQuota);
                        //}
                        #endregion
                    }
                }
            }
            return plantBusinessUnitSalesQuotas.OrderBy(x => x.IdPlant).ThenBy(y => y.Year).ToList();
        }


        public bool UpdatePlantQuota(List<PlantBusinessUnitSalesQuota> plantBusinessUnitSalesQuotas, string connectionString)
        {
            bool isUpdated = false;
            try
            {
                foreach (PlantBusinessUnitSalesQuota itemplantQuota in plantBusinessUnitSalesQuotas)
                {
                    foreach (LookupValue itemplantBusinessUnitSalesQuota in itemplantQuota.LookupValue)
                    {
                        using (MySqlConnection myConnection = new MySqlConnection(connectionString))
                        {
                            myConnection.Open();
                            using (MySqlTransaction trans = myConnection.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand concommand = new MySqlCommand("plantBusinessUnitSalesQuota_UpdateWithYearAndDate", myConnection);
                                    concommand.CommandType = CommandType.StoredProcedure;
                                    concommand.Parameters.AddWithValue("_IdPlant", itemplantQuota.IdPlant);
                                    concommand.Parameters.AddWithValue("_IdBusinessUnit", itemplantBusinessUnitSalesQuota.IdLookupValue);
                                    concommand.Parameters.AddWithValue("_AccountingYear", itemplantQuota.Year);
                                    concommand.Parameters.AddWithValue("_SalesQuotaAmount", itemplantBusinessUnitSalesQuota.SalesQuotaAmount);
                                    concommand.Parameters.AddWithValue("_IdSalesQuotaCurrency", itemplantBusinessUnitSalesQuota.IdSalesQuotaCurrency);
                                    concommand.Parameters.AddWithValue("_ExchangeRateDate", itemplantBusinessUnitSalesQuota.ExchangeRateDate);
                                    concommand.Transaction = trans;
                                    concommand.ExecuteNonQuery();

                                    isUpdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }

                }
            }
            catch (Exception ex)
            {
                throw;
            }

            return isUpdated;
        }

        public PlannedVisitDetail GetPlannedVisitDetail(string connectionString, DateTime accountingYearFrom, DateTime accountingYearTo, string idOwner = null, Int32 idPermission = 0, string idPlant = null)
        {
            PlannedVisitDetail plannedVisitDetail = new PlannedVisitDetail();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("Activity_GetPlannedAppointmentDetails", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                concommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                concommand.Parameters.AddWithValue("_CurrentDate", DateTime.Now);
                concommand.Parameters.AddWithValue("_IdOwner", idOwner);
                concommand.Parameters.AddWithValue("_IdPermission", idPermission);
                concommand.Parameters.AddWithValue("_IdPlant", idPlant);
                using (MySqlDataReader itemRow = concommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        if (itemRow.Read())
                        {
                            if (itemRow["PlannedAppCompletedTillCurrentDate"] != DBNull.Value)
                                plannedVisitDetail.PlannedAppCompletedTillCurrentDate = Convert.ToInt64(itemRow["PlannedAppCompletedTillCurrentDate"]);
                        }
                        if (itemRow.NextResult())
                        {
                            if (itemRow.Read())
                            {
                                if (itemRow["PlannedAppInCurrentDate"] != DBNull.Value)
                                    plannedVisitDetail.PlannedAppInCurrentDate = Convert.ToInt64(itemRow["PlannedAppInCurrentDate"]);
                            }
                        }
                        if (itemRow.NextResult())
                        {
                            if (itemRow.Read())
                            {
                                if (itemRow["PlannedAppCompletedTillCurrentPeriod"] != DBNull.Value)
                                    plannedVisitDetail.PlannedAppCompletedTillCurrentPeriod = Convert.ToInt64(itemRow["PlannedAppCompletedTillCurrentPeriod"]);
                            }
                        }
                        if (itemRow.NextResult())
                        {
                            if (itemRow.Read())
                            {
                                if (itemRow["PlannedAppInCurrentPeriod"] != DBNull.Value)
                                    plannedVisitDetail.PlannedAppInCurrentPeriod = Convert.ToInt64(itemRow["PlannedAppInCurrentPeriod"]);
                            }
                        }

                    }
                }
            }



            return plannedVisitDetail;
        }



        public bool CreateAutomaticPlannedActivitySprint60(string connectionString, string mainConnectionString, DateTime startDate, DateTime endDate, Int32 idUser, List<ActivitiesRecurrence> LstActivitiesRecurrence)
        {

            List<ActivitiesRecurrence> activitiesRecurrences = new List<ActivitiesRecurrence>();
            activitiesRecurrences = GetActivitiesRecurrenceByGridFilter(connectionString, LstActivitiesRecurrence);
            foreach (var item in activitiesRecurrences)
            {
                if (item.Periodicity != null && item.Periodicity > 0)
                {
                    List<DateTime> allDates = new List<DateTime>();
                    int peroidcity = 1;
                    for (DateTime date = startDate; date <= endDate; date = date.AddDays(peroidcity))
                    {
                        if (date.DayOfWeek.ToString() == item.WeekDay)
                        {

                            peroidcity = item.Periodicity.Value;

                            TransactionScope transactionScope = null;
                            try
                            {

                                using (transactionScope = new TransactionScope())
                                {
                                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainConnectionString))
                                    {
                                        mySqlConnection.Open();

                                        MySqlCommand mySqlCommand = new MySqlCommand("activities_AutomaticInsert", mySqlConnection);
                                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                                        mySqlCommand.Parameters.AddWithValue("_ToDate", date);
                                        mySqlCommand.Parameters.AddWithValue("_Subject", item.Subject);
                                        mySqlCommand.Parameters.AddWithValue("_Location", item.Location);
                                        mySqlCommand.Parameters.AddWithValue("_IdOwner", item.IdSalesOwner);
                                        mySqlCommand.Parameters.AddWithValue("_IdActivityType", item.IdActivityType);
                                        mySqlCommand.Parameters.AddWithValue("_FromDate", date);
                                        mySqlCommand.Parameters.AddWithValue("_Description", item.Description);
                                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                        mySqlCommand.Parameters.AddWithValue("_CreatedBy", idUser);
                                        mySqlCommand.Parameters.AddWithValue("_IdSite", item.IdSite);
                                        mySqlCommand.Parameters.AddWithValue("_Latitude", item.Latitude);
                                        mySqlCommand.Parameters.AddWithValue("_Longitude", item.Longitude);

                                        int lastInsertedId = Convert.ToInt32(mySqlCommand.ExecuteScalar());
                                        mySqlConnection.Close();
                                    }

                                    transactionScope.Complete();
                                }
                            }
                            catch (Exception ex)
                            {
                                if (Transaction.Current != null)
                                    Transaction.Current.Rollback();

                                if (transactionScope != null)
                                    transactionScope.Dispose();

                                throw;
                            }

                        }


                        else
                        {
                            peroidcity = 1;
                        }
                    }

                }
            }
            return true;
        }

        public List<ActivitiesRecurrence> GetActivitiesRecurrenceByGridFilter(string connectionstring, List<ActivitiesRecurrence> LstActivityRecurrence)
        {
            List<ActivitiesRecurrence> activitiesRecurrences = new List<ActivitiesRecurrence>();
            string idSites = String.Join(",", (LstActivityRecurrence).ConvertAll<string>(d => d.IdSite.ToString()).ToArray());
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("activitiesrecurrence_GetActivitiesRecurrenceByGridFilter", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdSites", idSites);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ActivitiesRecurrence activitiesRecurrence = new ActivitiesRecurrence();
                        if (reader["IdActivityRecurrence"] != DBNull.Value)
                            activitiesRecurrence.IdActivityRecurrence = Convert.ToInt64(reader["IdActivityRecurrence"].ToString());

                        if (reader["IdActivityType"] != DBNull.Value)
                            activitiesRecurrence.IdActivityType = Convert.ToInt32(reader["IdActivityType"].ToString());

                        if (reader["IdSite"] != DBNull.Value)
                            activitiesRecurrence.IdSite = Convert.ToInt32(reader["IdSite"].ToString());

                        if (reader["WeekDay"] != DBNull.Value)
                            activitiesRecurrence.WeekDay = Convert.ToString(reader["WeekDay"].ToString());

                        if (reader["Periodicity"] != DBNull.Value)
                            activitiesRecurrence.Periodicity = Convert.ToInt32(reader["Periodicity"].ToString());

                        if (reader["Subject"] != DBNull.Value)
                            activitiesRecurrence.Subject = Convert.ToString(reader["Subject"].ToString());

                        if (reader["Description"] != DBNull.Value)
                            activitiesRecurrence.Description = Convert.ToString(reader["Description"].ToString());

                        if (reader["Location"] != DBNull.Value)
                            activitiesRecurrence.Location = Convert.ToString(reader["Location"].ToString());

                        if (reader["IdSalesOwner"] != DBNull.Value)
                            activitiesRecurrence.IdSalesOwner = Convert.ToInt32(reader["IdSalesOwner"].ToString());

                        if (reader["Latitude"] != DBNull.Value)
                            activitiesRecurrence.Latitude = Convert.ToDouble(reader["Latitude"].ToString());

                        if (reader["Longitude"] != DBNull.Value)
                            activitiesRecurrence.Longitude = Convert.ToDouble(reader["Longitude"].ToString());

                        activitiesRecurrences.Add(activitiesRecurrence);
                    }
                }
            }

            return activitiesRecurrences;
        }


        public double GetOfferAmountByCurrencyConversion(string connectionstring, Int64 idOffer, double offerAmount, byte formIdCurrency, byte toIdCurrency, DateTime? deliveryDate, DateTime? sendIn, DateTime? RFQReception, DateTime? CreatedIn, DateTime? ReceivedIn)
        {
            double convertedOfferAmount = 0;
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("offers_GetOfferAmountByCurrencyConversion", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_offerId", idOffer);
                mySqlCommand.Parameters.AddWithValue("_OfferAmount", offerAmount);
                mySqlCommand.Parameters.AddWithValue("_FromIdCurrency", formIdCurrency);
                mySqlCommand.Parameters.AddWithValue("_ToIdCurrency", toIdCurrency);
                mySqlCommand.Parameters.AddWithValue("_DeliveryDate", deliveryDate);
                mySqlCommand.Parameters.AddWithValue("_SendIn", sendIn);
                mySqlCommand.Parameters.AddWithValue("_RFQReception", RFQReception);
                mySqlCommand.Parameters.AddWithValue("_CreatedIn", CreatedIn);
                mySqlCommand.Parameters.AddWithValue("_ReceivedIn", ReceivedIn);


                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    if (reader.Read())
                    {

                        if (reader["OfferAmount"] != DBNull.Value)
                            convertedOfferAmount = Convert.ToDouble(reader["OfferAmount"].ToString());

                    }
                }
            }

            return convertedOfferAmount;
        }


        public List<People> GetAllAttendesList_V2030(string idSite, string mainconnectionstring)
        {
            List<People> peoples = new List<People>();

            using (MySqlConnection congetactivities = new MySqlConnection(mainconnectionstring))
            {
                congetactivities.Open();
                MySqlCommand congetactivitiescommand = new MySqlCommand("people_GetAllSalesUsersANDSiteWise_V2030", congetactivities);
                congetactivitiescommand.CommandType = CommandType.StoredProcedure;
                congetactivitiescommand.Parameters.AddWithValue("_IdSite", idSite);
                using (MySqlDataReader activityreader = congetactivitiescommand.ExecuteReader())
                {
                    while (activityreader.Read())
                    {
                        People people = new People();
                        if (activityreader["IdPerson"] != DBNull.Value)
                            people.IdPerson = Convert.ToInt32(activityreader["IdPerson"].ToString());

                        if (activityreader["IdPersonType"] != DBNull.Value)
                            people.IdPersonType = Convert.ToByte(activityreader["IdPersonType"].ToString());

                        if (activityreader["IdPersonGender"] != DBNull.Value)
                            people.IdPersonGender = Convert.ToByte(activityreader["IdPersonGender"].ToString());

                        people.Email = activityreader["Email"].ToString();
                        people.Name = activityreader["Name"].ToString();
                        people.Surname = activityreader["Surname"].ToString();
                        people.Observations = activityreader["Observations"].ToString();
                        people.Phone = activityreader["Phone"].ToString();
                        people.IsStillActive = Convert.ToByte(activityreader["IsStillActive"]);

                        if (activityreader["Image"] != DBNull.Value)
                            people.ImageText = activityreader["Image"].ToString();

                        peoples.Add(people);
                    }
                }
            }

            return peoples;
        }


        public List<People> GetContactsByLinkedItemAccount_V2030(string idSite, string mainconnectionstring)
        {
            List<People> peoples = new List<People>();

            using (MySqlConnection congetactivities = new MySqlConnection(mainconnectionstring))
            {
                congetactivities.Open();
                MySqlCommand congetactivitiescommand = new MySqlCommand("CRM_GetContactsByLinkedItemAccount_V2030", congetactivities);
                congetactivitiescommand.CommandType = CommandType.StoredProcedure;
                congetactivitiescommand.Parameters.AddWithValue("_IdSite", idSite);
                using (MySqlDataReader activityreader = congetactivitiescommand.ExecuteReader())
                {
                    while (activityreader.Read())
                    {
                        People people = new People();
                        if (activityreader["IdPerson"] != DBNull.Value)
                            people.IdPerson = Convert.ToInt32(activityreader["IdPerson"].ToString());

                        if (activityreader["IdPersonType"] != DBNull.Value)
                            people.IdPersonType = Convert.ToByte(activityreader["IdPersonType"].ToString());
                        if (activityreader["IdPersonGender"] != DBNull.Value)
                            people.IdPersonGender = Convert.ToByte(activityreader["IdPersonGender"].ToString());

                        people.Email = activityreader["Email"].ToString();
                        people.Name = activityreader["Name"].ToString();
                        people.Surname = activityreader["Surname"].ToString();
                        people.Observations = activityreader["Observations"].ToString();
                        people.Phone = activityreader["Phone"].ToString();
                        people.ImageText = activityreader["Image"].ToString();

                        if (activityreader["IdSite"] != DBNull.Value)
                        {
                            people.IdSite = Convert.ToInt32(activityreader["IdSite"].ToString());
                            people.Company = new Company();
                            people.Company.IdCompany = Convert.ToInt32(activityreader["IdSite"].ToString());
                            people.Company.Name = Convert.ToString(activityreader["SiteName"].ToString());
                            people.Company.SiteNameWithoutCountry = Convert.ToString(activityreader["SiteNameWithoutCountry"].ToString());
                        }

                        peoples.Add(people);
                    }
                }
            }

            return peoples;
        }



        public void AddActivityLinkedItem_V2031(Int64 idActivity, List<ActivityLinkedItem> activityLinkedItems, string connectionstring)
        {
            if (activityLinkedItems != null)
            {
                foreach (ActivityLinkedItem activityLinkedItem in activityLinkedItems)
                {
                    activityLinkedItem.IdActivity = idActivity;
                    if (activityLinkedItem.IsDeleted)
                    {
                        using (MySqlConnection connLinkedItem = new MySqlConnection(connectionstring))
                        {
                            connLinkedItem.Open();
                            try
                            {
                                MySqlCommand linkedItemCommand = new MySqlCommand("activityLinkedItems_Delete", connLinkedItem);
                                linkedItemCommand.CommandType = CommandType.StoredProcedure;
                                linkedItemCommand.Parameters.AddWithValue("_IdActivityLinkedItem", activityLinkedItem.IdActivityLinkedItem);
                                linkedItemCommand.ExecuteNonQuery();

                                connLinkedItem.Close();
                            }
                            catch (Exception ex)
                            {
                                throw;
                            }
                        }
                    }
                    else if (activityLinkedItem.IsUpdated)
                    {
                        if (activityLinkedItem.IdActivityLinkedItem > 0)
                        {
                            using (MySqlConnection connLinkedItem = new MySqlConnection(connectionstring))
                            {
                                connLinkedItem.Open();

                                try
                                {
                                    MySqlCommand linkedItemCommand = new MySqlCommand("activityLinkedItems_Update", connLinkedItem);
                                    linkedItemCommand.CommandType = CommandType.StoredProcedure;

                                    linkedItemCommand.Parameters.AddWithValue("_IdActivityLinkedItem", activityLinkedItem.IdActivityLinkedItem);
                                    linkedItemCommand.Parameters.AddWithValue("_IdActivity", activityLinkedItem.IdActivity);
                                    linkedItemCommand.Parameters.AddWithValue("_IdLinkedItemType", activityLinkedItem.IdLinkedItemType);
                                    linkedItemCommand.Parameters.AddWithValue("_IdSite", activityLinkedItem.IdSite);
                                    linkedItemCommand.Parameters.AddWithValue("_IdCarProject", activityLinkedItem.IdCarProject);
                                    linkedItemCommand.Parameters.AddWithValue("_IdPerson", activityLinkedItem.IdPerson);

                                    linkedItemCommand.Parameters.AddWithValue("_IdOffer", activityLinkedItem.IdOffer);
                                    linkedItemCommand.Parameters.AddWithValue("_IdEmdepSite", activityLinkedItem.IdEmdepSite);
                                    linkedItemCommand.Parameters.AddWithValue("_IdCompetitor", activityLinkedItem.IdCompetitor);


                                    activityLinkedItem.IdActivityLinkedItem = Convert.ToInt32(linkedItemCommand.ExecuteScalar());

                                    connLinkedItem.Close();
                                }
                                catch (Exception ex)
                                {
                                    throw;
                                }

                            }
                        }
                    }
                    else
                    {
                        using (MySqlConnection connLinkedItem = new MySqlConnection(connectionstring))
                        {
                            connLinkedItem.Open();

                            try
                            {
                                MySqlCommand linkedItemCommand = new MySqlCommand("CRM_activityLinkedItemsInsert_V2031", connLinkedItem);
                                linkedItemCommand.CommandType = CommandType.StoredProcedure;
                                linkedItemCommand.Parameters.AddWithValue("_IdActivity", activityLinkedItem.IdActivity);
                                linkedItemCommand.Parameters.AddWithValue("_IdLinkedItemType", activityLinkedItem.IdLinkedItemType);

                                linkedItemCommand.Parameters.AddWithValue("_IdSite", activityLinkedItem.IdSite);
                                linkedItemCommand.Parameters.AddWithValue("_IdCarProject", activityLinkedItem.IdCarProject);
                                linkedItemCommand.Parameters.AddWithValue("_IdPerson", activityLinkedItem.IdPerson);

                                linkedItemCommand.Parameters.AddWithValue("_IdOffer", activityLinkedItem.IdOffer);
                                linkedItemCommand.Parameters.AddWithValue("_IdEmdepSite", activityLinkedItem.IdEmdepSite);
                                linkedItemCommand.Parameters.AddWithValue("_IdCompetitor", activityLinkedItem.IdCompetitor);
                                linkedItemCommand.Parameters.AddWithValue("_CreationDate", DateTime.Now);

                                activityLinkedItem.IdActivityLinkedItem = Convert.ToInt32(linkedItemCommand.ExecuteScalar());

                                connLinkedItem.Close();
                            }
                            catch (Exception ex)
                            {
                                throw;
                            }

                        }
                    }
                }

            }

        }

        public Activity AddActivity_V2031(Activity activity, string mainServerConnectionString, string activityAttachmentFilePath, string workbenchConnectionString, string MailServerName, string MailServerPort, string MailFrom, string EmailTemplate)
        {
            TransactionScope transactionScope = null;
            TransactionScope transactionScopeNew = null;

            using (transactionScope = new System.Transactions.TransactionScope())
            {
                try
                {
                    using (MySqlConnection connActivity = new MySqlConnection(mainServerConnectionString))
                    {
                        connActivity.Open();

                        MySqlCommand insertActivityCommand = new MySqlCommand("activities_Insert", connActivity);
                        insertActivityCommand.CommandType = CommandType.StoredProcedure;

                        insertActivityCommand.Parameters.AddWithValue("_ToDate", activity.ToDate);
                        insertActivityCommand.Parameters.AddWithValue("_Subject", activity.Subject);
                        insertActivityCommand.Parameters.AddWithValue("_Location", activity.Location);
                        insertActivityCommand.Parameters.AddWithValue("_IdOwner", activity.IdOwner);
                        insertActivityCommand.Parameters.AddWithValue("_IdActivityType", activity.IdActivityType);
                        insertActivityCommand.Parameters.AddWithValue("_FromDate", activity.FromDate);
                        insertActivityCommand.Parameters.AddWithValue("_Description", activity.Description);
                        insertActivityCommand.Parameters.AddWithValue("_CreatedBy", activity.CreatedBy);
                        insertActivityCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                        insertActivityCommand.Parameters.AddWithValue("_Longitude", activity.Longitude);
                        insertActivityCommand.Parameters.AddWithValue("_Latitude", activity.Latitude);
                        insertActivityCommand.Parameters.AddWithValue("_IdActivityStatus", activity.IdActivityStatus);
                        insertActivityCommand.Parameters.AddWithValue("_IsCompleted", activity.IsCompleted);
                        insertActivityCommand.Parameters.AddWithValue("_IsDeleted", activity.IsDeleted);
                        insertActivityCommand.Parameters.AddWithValue("_ReminderDateTime", activity.ActivityReminderDateTime);
                        insertActivityCommand.Parameters.AddWithValue("_IsSentMail", activity.IsSentMail);
                        insertActivityCommand.Parameters.AddWithValue("_IsInternal", activity.IsInternal);

                        if (activity.IsCompleted == 1)
                        {
                            insertActivityCommand.Parameters.AddWithValue("_CloseDate", DateTime.Now);
                        }
                        else
                        {
                            insertActivityCommand.Parameters.AddWithValue("_CloseDate", DBNull.Value);
                        }

                        //concompanycommand.Transaction = transactionScope;
                        activity.IdActivity = Convert.ToInt32(insertActivityCommand.ExecuteScalar());

                        connActivity.Close();

                        if (activity.IdActivity > 0)
                        {
                            AddActivityAttendees(activity.IdActivity, activity.ActivityAttendees, mainServerConnectionString);
                            AddActivityWatchers(activity.IdActivity, activity.ActivityWatchers, mainServerConnectionString); //Sprint22

                            AddLogEntriesByActivity(activity.IdActivity, activity.LogEntriesByActivity, mainServerConnectionString);
                            AddLogEntriesByActivity(activity.IdActivity, activity.CommentsByActivity, mainServerConnectionString);
                            AddActivityLinkedItem_V2031(activity.IdActivity, activity.ActivityLinkedItem, mainServerConnectionString);

                            if (activity.ActivityAttachment != null && activity.ActivityAttachment.Count > 0)
                                AddActivityAttachment(activity, activity.ActivityAttachment, mainServerConnectionString, activityAttachmentFilePath);

                            AddActivityTags(activity.IdActivity, activity.ActivityTags, mainServerConnectionString);

                            using (transactionScopeNew = new TransactionScope(TransactionScopeOption.RequiresNew))
                            {
                                if (activity.Notification != null)
                                {
                                    Notification notification = AddNotification(activity.Notification, activity.ActivityMail, workbenchConnectionString, MailServerName, MailServerPort, MailFrom, EmailTemplate);
                                    transactionScopeNew.Complete();

                                    if (notification.Id > 0)
                                    {
                                        ApplicationManager applicationManager = new ApplicationManager();
                                        if (activity.ActivityMail != null)
                                            applicationManager.SendActivityMail(activity.ActivityMail, MailServerName, MailServerPort, MailFrom, EmailTemplate);
                                    }
                                }
                            }

                            transactionScope.Complete();
                        }
                    }
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    if (transactionScopeNew != null)
                        transactionScopeNew.Dispose();

                    throw;
                }
            }

            return activity;
        }


        public bool UpdateActivity_V2031(Activity activity, string mainServerConnectionString, string activityAttachmentPath)
        {

            bool isUpdated = false;

            TransactionScope transactionScope = null;

            try
            {
                using (transactionScope = new System.Transactions.TransactionScope())
                {
                    using (MySqlConnection connUpdateActivity = new MySqlConnection(mainServerConnectionString))
                    {
                        connUpdateActivity.Open();

                        MySqlCommand updateActivityCommand = new MySqlCommand("activities_Update", connUpdateActivity);
                        updateActivityCommand.CommandType = CommandType.StoredProcedure;
                        updateActivityCommand.Parameters.AddWithValue("_ToDate", activity.ToDate);
                        updateActivityCommand.Parameters.AddWithValue("_Subject", activity.Subject);
                        updateActivityCommand.Parameters.AddWithValue("_Location", activity.Location);
                        updateActivityCommand.Parameters.AddWithValue("_IdOwner", activity.IdOwner);
                        updateActivityCommand.Parameters.AddWithValue("_IdActivityType", activity.IdActivityType);
                        updateActivityCommand.Parameters.AddWithValue("_FromDate", activity.FromDate);
                        updateActivityCommand.Parameters.AddWithValue("_Description", activity.Description);
                        updateActivityCommand.Parameters.AddWithValue("_ModifiedBy", activity.ModifiedBy);
                        updateActivityCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        updateActivityCommand.Parameters.AddWithValue("_IdActivity", activity.IdActivity);
                        updateActivityCommand.Parameters.AddWithValue("_Longitude", activity.Longitude);
                        updateActivityCommand.Parameters.AddWithValue("_Latitude", activity.Latitude);
                        updateActivityCommand.Parameters.AddWithValue("_IdActivityStatus", activity.IdActivityStatus);
                        updateActivityCommand.Parameters.AddWithValue("_IsCompleted", activity.IsCompleted);
                        updateActivityCommand.Parameters.AddWithValue("_ReminderDateTime", activity.ActivityReminderDateTime);
                        updateActivityCommand.Parameters.AddWithValue("_IsSentMail", activity.IsSentMail);
                        updateActivityCommand.Parameters.AddWithValue("_IsInternal", activity.IsInternal);

                        if (activity.IsCompleted == 1)
                        {
                            updateActivityCommand.Parameters.AddWithValue("_CloseDate", DateTime.Now);
                        }
                        else
                        {
                            updateActivityCommand.Parameters.AddWithValue("_CloseDate", DBNull.Value);
                        }

                        updateActivityCommand.Parameters.AddWithValue("_IsDeleted", activity.IsDeleted);
                        //concompanycommand.Transaction = trans;
                        updateActivityCommand.ExecuteNonQuery();

                        connUpdateActivity.Close();

                        isUpdated = true;
                        //trans.Commit();

                        if (isUpdated == true)
                        {
                            AddActivityAttendees(activity.IdActivity, activity.ActivityAttendees, mainServerConnectionString);
                            AddActivityWatchers(activity.IdActivity, activity.ActivityWatchers, mainServerConnectionString);
                            AddActivityLinkedItem_V2031(activity.IdActivity, activity.ActivityLinkedItem, mainServerConnectionString);
                            AddLogEntriesByActivity(activity.IdActivity, activity.LogEntriesByActivity, mainServerConnectionString);
                            UpdateCommentsByActivity(activity.CommentsByActivity, mainServerConnectionString);

                            if (activity.ActivityAttachment != null && activity.ActivityAttachment.Count > 0)
                                AddActivityAttachment(activity, activity.ActivityAttachment, mainServerConnectionString, activityAttachmentPath);

                            AddActivityTags(activity.IdActivity, activity.ActivityTags, mainServerConnectionString);
                        }

                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                transactionScope.Dispose();
                throw;
            }

            return isUpdated;


        }


        public List<ActivitiesRecurrence> GetActivitiesRecurrence_V2031(string connectionstring, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo, string idSite, Int32 idPermission)
        {
            List<ActivitiesRecurrence> activitiesRecurrences = new List<ActivitiesRecurrence>();
            List<ActivitiesRecurrence> mergedList = new List<ActivitiesRecurrence>();
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("CRM_GetAllActivitiesRecurrence_V2031", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_idUser", idUser);
                mySqlCommand.Parameters.AddWithValue("_accountingFromYear", accountingYearFrom);
                mySqlCommand.Parameters.AddWithValue("_accountingToYear", accountingYearTo);
                mySqlCommand.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ActivitiesRecurrence activitiesRecurrence = new ActivitiesRecurrence();
                        if (reader["IdActivityRecurrence"] != DBNull.Value)
                            activitiesRecurrence.IdActivityRecurrence = Convert.ToInt64(reader["IdActivityRecurrence"].ToString());

                        if (reader["IdSite"] != DBNull.Value)
                            activitiesRecurrence.IdSite = Convert.ToInt32(reader["IdSite"].ToString());

                        if (reader["IdActivityType"] != DBNull.Value)
                            activitiesRecurrence.IdActivityType = Convert.ToInt32(reader["IdActivityType"].ToString());

                        if (reader["WeekDay"] != DBNull.Value)
                            activitiesRecurrence.WeekDay = Convert.ToString(reader["WeekDay"].ToString());

                        if (reader["Periodicity"] != DBNull.Value)
                            activitiesRecurrence.Periodicity = Convert.ToInt32(reader["Periodicity"].ToString());

                        if (reader["ActivityType"] != DBNull.Value)
                            activitiesRecurrence.ActivityType = Convert.ToString(reader["ActivityType"].ToString());

                        if (reader["IsSalesResponsible"] != DBNull.Value)
                            activitiesRecurrence.IsSalesResponsible = Convert.ToByte(reader["IsSalesResponsible"].ToString());

                        activitiesRecurrences.Add(activitiesRecurrence);
                    }
                }
            }

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("CRM_GetCustomerDetailsForActivityRecurrence_V2031", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_idUser", idUser);
                mySqlCommand.Parameters.AddWithValue("_idPermission", idPermission);
                mySqlCommand.Parameters.AddWithValue("_idSite", idSite);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ActivitiesRecurrence activitiesRecurrence = new ActivitiesRecurrence();

                        if (reader["IdSite"] != DBNull.Value)
                            activitiesRecurrence.IdSite = Convert.ToInt32(reader["IdSite"].ToString());

                        if (reader["IdCustomer"] != DBNull.Value)
                            activitiesRecurrence.IdCustomer = Convert.ToInt32(reader["IdCustomer"].ToString());

                        if (reader["CustomerCountry"] != DBNull.Value)
                            activitiesRecurrence.Country = Convert.ToString(reader["CustomerCountry"].ToString());

                        if (reader["CustomerZone"] != DBNull.Value)
                            activitiesRecurrence.Region = Convert.ToString(reader["CustomerZone"].ToString());

                        if (reader["CustomerGroup"] != DBNull.Value)
                            activitiesRecurrence.Group = Convert.ToString(reader["CustomerGroup"].ToString());

                        if (reader["SiteName"] != DBNull.Value)
                            activitiesRecurrence.SiteName = Convert.ToString(reader["SiteName"].ToString());

                        if (reader["SiteNameWithoutCountry"] != DBNull.Value)
                            activitiesRecurrence.SiteNameWithoutCountry = Convert.ToString(reader["SiteNameWithoutCountry"].ToString());

                        if (reader["IdSalesResponsible"] != DBNull.Value)
                        {
                            activitiesRecurrence.IdSalesOwner = Convert.ToInt32(reader["IdSalesResponsible"].ToString());

                            if (reader["SalesResponsible"] != DBNull.Value)
                                activitiesRecurrence.SalesOwner = Convert.ToString(reader["SalesResponsible"].ToString());
                        }



                        ActivitiesRecurrence getInsertedRecurrenceActivity = new ActivitiesRecurrence();
                        getInsertedRecurrenceActivity = activitiesRecurrences.Where(i => i.IdSite == activitiesRecurrence.IdSite && i.IsSalesResponsible == 1).FirstOrDefault();
                        if (getInsertedRecurrenceActivity != null)
                        {
                            activitiesRecurrence.IdActivityRecurrence = getInsertedRecurrenceActivity.IdActivityRecurrence;
                            activitiesRecurrence.IdActivityType = getInsertedRecurrenceActivity.IdActivityType;
                            activitiesRecurrence.WeekDay = getInsertedRecurrenceActivity.WeekDay;
                            activitiesRecurrence.Periodicity = getInsertedRecurrenceActivity.Periodicity;
                            activitiesRecurrence.IsSalesResponsible = 1;
                        }
                        else
                        {
                            activitiesRecurrence.IdActivityRecurrence = 0;
                            activitiesRecurrence.IdActivityType = 0;
                            activitiesRecurrence.WeekDay = null;
                            activitiesRecurrence.Periodicity = null;
                            activitiesRecurrence.IsSalesResponsible = 1;
                        }

                        mergedList.Add(activitiesRecurrence);


                        if (reader["IdSalesResponsibleBU"] != DBNull.Value)
                        {
                            ActivitiesRecurrence activitiesRecurrenceBU = new ActivitiesRecurrence();
                            activitiesRecurrenceBU = (ActivitiesRecurrence)activitiesRecurrence.Clone();

                            activitiesRecurrenceBU.IdSalesOwner = Convert.ToInt32(reader["IdSalesResponsibleBU"].ToString());

                            if (reader["SalesResponsibleBU"] != DBNull.Value)
                                activitiesRecurrenceBU.SalesOwner = Convert.ToString(reader["SalesResponsibleBU"].ToString());

                            ActivitiesRecurrence getInsertedRecurrenceActivityBU = new ActivitiesRecurrence();
                            getInsertedRecurrenceActivityBU = activitiesRecurrences.Where(i => i.IdSite == activitiesRecurrence.IdSite && i.IsSalesResponsible == 0).FirstOrDefault();
                            if (getInsertedRecurrenceActivityBU != null)
                            {
                                activitiesRecurrenceBU.IdActivityRecurrence = getInsertedRecurrenceActivityBU.IdActivityRecurrence;
                                activitiesRecurrenceBU.IdActivityType = getInsertedRecurrenceActivityBU.IdActivityType;
                                activitiesRecurrenceBU.WeekDay = getInsertedRecurrenceActivityBU.WeekDay;
                                activitiesRecurrenceBU.Periodicity = getInsertedRecurrenceActivityBU.Periodicity;
                                activitiesRecurrenceBU.IsSalesResponsible = 0;
                            }
                            else
                            {
                                activitiesRecurrenceBU.IdActivityRecurrence = 0;
                                activitiesRecurrenceBU.IdActivityType = 0;
                                activitiesRecurrenceBU.WeekDay = null;
                                activitiesRecurrenceBU.Periodicity = null;
                                activitiesRecurrenceBU.IsSalesResponsible = 0;
                            }

                            mergedList.Add(activitiesRecurrenceBU);
                        }
                    }
                }
            }

            return mergedList;
        }


        public ActivitiesRecurrence UpdateActivitiesRecurrence_V2031(string mainServerConnectionString, ActivitiesRecurrence activitiesRecurrence)
        {
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("CRM_activitiesrecurrenceUpdate_V2031", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;

                        mySqlCommand.Parameters.AddWithValue("_IdActivityRecurrence", activitiesRecurrence.IdActivityRecurrence);
                        mySqlCommand.Parameters.AddWithValue("_IdSite", activitiesRecurrence.IdSite);
                        mySqlCommand.Parameters.AddWithValue("_IdActivityType", activitiesRecurrence.IdActivityType);
                        mySqlCommand.Parameters.AddWithValue("_WeekDay", activitiesRecurrence.WeekDay);
                        mySqlCommand.Parameters.AddWithValue("_Periodicity", activitiesRecurrence.Periodicity);
                        mySqlCommand.Parameters.AddWithValue("_IsSalesResponsible", activitiesRecurrence.IsSalesResponsible);

                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();

                throw;
            }

            return activitiesRecurrence;
        }


        public bool CreateAutomaticPlannedActivity_V2031(string connectionString, string mainConnectionString, DateTime startDate, DateTime endDate, Int32 idUser, List<ActivitiesRecurrence> LstActivitiesRecurrence)
        {

            List<ActivitiesRecurrence> activitiesRecurrences = new List<ActivitiesRecurrence>();
            activitiesRecurrences = GetActivitiesRecurrenceByGridFilter_V2031(connectionString, LstActivitiesRecurrence);
            foreach (var item in activitiesRecurrences)
            {
                if (item.Periodicity != null && item.Periodicity > 0)
                {
                    List<DateTime> allDates = new List<DateTime>();
                    int peroidcity = 1;
                    for (DateTime date = startDate; date <= endDate; date = date.AddDays(peroidcity))
                    {
                        if (date.DayOfWeek.ToString() == item.WeekDay)
                        {

                            peroidcity = item.Periodicity.Value;

                            TransactionScope transactionScope = null;
                            try
                            {

                                using (transactionScope = new TransactionScope())
                                {
                                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainConnectionString))
                                    {
                                        mySqlConnection.Open();

                                        MySqlCommand mySqlCommand = new MySqlCommand("activities_AutomaticInsert", mySqlConnection);
                                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                                        mySqlCommand.Parameters.AddWithValue("_ToDate", date);
                                        mySqlCommand.Parameters.AddWithValue("_Subject", item.Subject);
                                        mySqlCommand.Parameters.AddWithValue("_Location", item.Location);
                                        mySqlCommand.Parameters.AddWithValue("_IdOwner", item.IdSalesOwner);
                                        mySqlCommand.Parameters.AddWithValue("_IdActivityType", item.IdActivityType);
                                        mySqlCommand.Parameters.AddWithValue("_FromDate", date);
                                        mySqlCommand.Parameters.AddWithValue("_Description", item.Description);
                                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                        mySqlCommand.Parameters.AddWithValue("_CreatedBy", idUser);
                                        mySqlCommand.Parameters.AddWithValue("_IdSite", item.IdSite);
                                        mySqlCommand.Parameters.AddWithValue("_Latitude", item.Latitude);
                                        mySqlCommand.Parameters.AddWithValue("_Longitude", item.Longitude);

                                        int lastInsertedId = Convert.ToInt32(mySqlCommand.ExecuteScalar());
                                        mySqlConnection.Close();
                                    }

                                    transactionScope.Complete();
                                }
                            }
                            catch (Exception ex)
                            {
                                if (Transaction.Current != null)
                                    Transaction.Current.Rollback();

                                if (transactionScope != null)
                                    transactionScope.Dispose();

                                throw;
                            }

                        }


                        else
                        {
                            peroidcity = 1;
                        }
                    }

                }
            }
            return true;
        }



        public List<ActivitiesRecurrence> GetActivitiesRecurrenceByGridFilter_V2031(string connectionstring, List<ActivitiesRecurrence> LstActivityRecurrence)
        {

            string idSites = String.Join(",", (LstActivityRecurrence).ConvertAll<string>(d => d.IdSite.ToString()).ToArray());
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("CRM_GetActivitiesRecurrenceByGridFilter_V2031", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdSites", idSites);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        if (reader["IdSite"] != DBNull.Value)
                        {
                            List<ActivitiesRecurrence> activitiesRecurrences = LstActivityRecurrence.Where(lar => lar.IdSite == Convert.ToInt32(reader["IdSite"].ToString())).ToList();

                            foreach (ActivitiesRecurrence item in activitiesRecurrences)
                            {
                                if (reader["Subject"] != DBNull.Value)
                                    item.Subject = Convert.ToString(reader["Subject"].ToString());

                                if (reader["Description"] != DBNull.Value)
                                    item.Description = Convert.ToString(reader["Description"].ToString());

                                if (reader["Location"] != DBNull.Value)
                                    item.Location = Convert.ToString(reader["Location"].ToString());

                                if (reader["Latitude"] != DBNull.Value)
                                    item.Latitude = Convert.ToDouble(reader["Latitude"].ToString());

                                if (reader["Longitude"] != DBNull.Value)
                                    item.Longitude = Convert.ToDouble(reader["Longitude"].ToString());
                            }

                        }

                    }
                }
            }

            return LstActivityRecurrence;
        }


        public List<Activity> GetActivitiesByIdOffer_V2031(Int64 idOffer, Int32 idEmdepSite, string mainConnectionString)
        {
            List<Activity> listActivity = new List<Activity>();

            using (MySqlConnection connActivities = new MySqlConnection(mainConnectionString))
            {
                connActivities.Open();
                MySqlCommand getActivitiesCommand = new MySqlCommand("activities_GetactivitiesByIdOffer_V2031", connActivities);
                getActivitiesCommand.CommandType = CommandType.StoredProcedure;
                getActivitiesCommand.Parameters.AddWithValue("_IdOffer", idOffer);
                getActivitiesCommand.Parameters.AddWithValue("_IdEmdepSite", idEmdepSite);

                using (MySqlDataReader activityReader = getActivitiesCommand.ExecuteReader())
                {
                    while (activityReader.Read())
                    {
                        Activity activity = new Activity();
                        activity.IdActivity = Convert.ToInt64(activityReader["IdActivity"].ToString());
                        activity.Subject = activityReader["Subject"].ToString();
                        activity.Description = activityReader["Description"].ToString();

                        if (activityReader["IdActivityType"] != DBNull.Value)
                        {
                            activity.LookupValue = new LookupValue();
                            activity.LookupValue.IdLookupValue = Convert.ToInt32(activityReader["IdActivityType"].ToString());
                            activity.LookupValue.Value = activityReader["ActivityType"].ToString();
                            activity.LookupValue.HtmlColor = activityReader["ActivityTypeHtmlColor"].ToString();
                            if (activityReader["ActivityTypeImage"] != DBNull.Value)
                                activity.LookupValue.IdImage = Convert.ToInt64(activityReader["ActivityTypeImage"].ToString());
                            if (activityReader["ActivityTypePosition"] != DBNull.Value)
                                activity.LookupValue.Position = Convert.ToInt32(activityReader["ActivityTypePosition"].ToString());
                        }

                        if (activityReader["FromDate"] != DBNull.Value)
                            activity.FromDate = Convert.ToDateTime(activityReader["FromDate"].ToString());

                        if (activityReader["ToDate"] != DBNull.Value)
                            activity.ToDate = Convert.ToDateTime(activityReader["ToDate"].ToString());

                        if (activityReader["CloseDate"] != DBNull.Value)
                            activity.CloseDate = Convert.ToDateTime(activityReader["CloseDate"].ToString());

                        activity.Location = activityReader["Location"].ToString();

                        if (activityReader["IdOwner"] != DBNull.Value)
                            activity.IdOwner = Convert.ToInt32(activityReader["IdOwner"].ToString());

                        if (activityReader["IdOwner"] != DBNull.Value)
                        {
                            activity.People = new People();

                            activity.People.Name = activityReader["Name"].ToString();
                            activity.People.Surname = activityReader["Surname"].ToString();
                        }

                        if (activityReader["Latitude"] != DBNull.Value)
                            activity.Latitude = Convert.ToDouble(activityReader["Latitude"].ToString());

                        if (activityReader["Longitude"] != DBNull.Value)
                            activity.Longitude = Convert.ToDouble(activityReader["Longitude"].ToString());

                        if (activityReader["IsCompleted"] != DBNull.Value)
                        {
                            activity.IsCompleted = Convert.ToByte(activityReader["IsCompleted"].ToString());

                            //close filled when completing some activity.
                            if (activity.IsCompleted == 1)
                            {
                                activity.ActivityGridStatus = "Completed";

                                if (activityReader["CloseDate"] != DBNull.Value)
                                    activity.CloseDate = Convert.ToDateTime(activityReader["CloseDate"].ToString());
                            }
                        }

                        if (activityReader["IdActivityStatus"] != DBNull.Value)
                        {
                            activity.ActivityStatus = new LookupValue();
                            activity.ActivityStatus.IdLookupValue = Convert.ToInt32(activityReader["IdActivityStatus"].ToString());
                            activity.ActivityStatus.Value = activityReader["ActivityStatus"].ToString();
                            activity.ActivityStatus.HtmlColor = activityReader["ActivityStatusHtmlColor"].ToString();

                            if (activityReader["ActivityStatusImage"] != DBNull.Value)
                                activity.ActivityStatus.IdImage = Convert.ToInt64(activityReader["ActivityStatusImage"].ToString());

                            if (activityReader["ActivityStatusPosition"] != DBNull.Value)
                                activity.ActivityStatus.Position = Convert.ToInt32(activityReader["ActivityStatusPosition"].ToString());

                            if (activity.ActivityStatus.IdLookupValue == 48)
                            {
                                activity.ActivityGridStatus = "Completed";
                            }
                            else
                            {
                                activity.ActivityGridStatus = activityReader["ActivityStatus"].ToString();
                            }
                        }

                        if (activityReader["CreatedIn"] != DBNull.Value)
                        {
                            activity.CreatedIn = Convert.ToDateTime(activityReader["CreatedIn"].ToString());
                        }

                        if (activityReader["IdActivityLinkedItem"] != DBNull.Value)
                        {
                            activity.ActivityLinkedItem = new List<ActivityLinkedItem>();
                            ActivityLinkedItem activityLinkedItem = new ActivityLinkedItem();
                            activityLinkedItem.IdActivityLinkedItem = Convert.ToInt64(activityReader["IdActivityLinkedItem"].ToString());
                            if (activityReader["IdActivity"] != DBNull.Value)
                                activityLinkedItem.IdActivity = Convert.ToInt64(activityReader["IdActivity"].ToString());
                            if (activityReader["IdLinkedItemType"] != DBNull.Value)
                                activityLinkedItem.IdLinkedItemType = Convert.ToInt32(activityReader["IdLinkedItemType"].ToString());
                            if (activityReader["CreationDate"] != DBNull.Value)
                                activityLinkedItem.CreationDate = Convert.ToDateTime(activityReader["CreationDate"].ToString());
                            activity.ActivityLinkedItem.Add(activityLinkedItem);
                        }

                        listActivity.Add(activity);
                    }
                }
            }

            return listActivity;
        }

        public bool UpdateOffer_V2031(Offer offer, string connectionstring, string offerCodeConnectionString, Int32 idSite, Int32 idUser, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {
            bool isupdated = false;
            bool isupdatedLeadToOT = true;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            try
            {
                if (offer.IsUpdateLeadToOT)
                {
                    if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
                    {
                        if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                            UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                        else
                            offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
                    }
                    else
                        UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                }

                if (offerInsertedInGCM)
                {
                    MySqlDataAdapter daGCM;
                    DataTable dtGCM;

                    using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                    {
                        conoffer.Open();
                        string query = "select IdOffer from offers where Code= '" + offer.Code + "' and IdOffer =" + offer.IdOffer + " ;";

                        daGCM = new MySqlDataAdapter(query, conoffer);
                        dtGCM = new DataTable();
                        daGCM.Fill(dtGCM);

                        if (dtGCM.Rows.Count > 0)
                            isupdatedLeadToOT = false;
                    }
                    Int64? nullProductCategory = null;
                    if (offer.IdProductCategory > 0)
                    {
                        nullProductCategory = offer.IdProductCategory;
                    }
                    if (offer.IsUpdateLeadToOT)
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_LeadOTUpdate", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                    conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    trans.Commit();

                                    offer.Year = DateTime.Now.Year;
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                    else
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_Update", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                }

                if (isupdated)
                {
                    UpdateEngAnalysisStatus(dotProjectConnectionString, offer);

                    UpdateQuotation(offer, offer.Site.ConnectPlantConstr, dotProjectConnectionString, mailServer, workbenchConnectionString);

                    LostReasonsByOffer lostReasonsByOffer = UpdateLostReasonsByOffer(offer.LostReasonsByOffer, offer.Site.ConnectPlantConstr);
                    AddLogEntryByOffer(offer, connectionstring, offer.Site.ConnectPlantConstr);
                    AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);

                    if (offer.NewlyLinkedActivities != null && offer.NewlyLinkedActivities.Count > 0)
                    {
                        using (var transactionScope = new TransactionScope())
                        {
                            try
                            {
                                AddLinkExistingActivityToOffer_V2031(mainserverConnectionString, offer.NewlyLinkedActivities, offer.Site, offer.IdOffer);
                                transactionScope.Complete();
                            }
                            catch (Exception ex)
                            {
                                if (Transaction.Current != null)
                                    Transaction.Current.Rollback();

                                if (transactionScope != null)
                                    transactionScope.Dispose();

                                throw;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
                //isupdated = false;
            }

            return isupdated;
        }

        public void AddLinkExistingActivityToOffer_V2031(string mainServerConnectionString, List<Activity> NewlyLinkedActivities, Company site, Int64 idOffer)
        {
            try
            {
                foreach (Activity activity in NewlyLinkedActivities)
                {
                    using (MySqlConnection connActivityLinkedItem = new MySqlConnection(mainServerConnectionString))
                    {
                        connActivityLinkedItem.Open();
                        //using (MySqlTransaction trans = connActivityLinkedItem.BeginTransaction())
                        //{
                        try
                        {
                            MySqlCommand linkedItemCommand = new MySqlCommand("CRM_activityLinkedItemsInsert_V2031", connActivityLinkedItem);
                            linkedItemCommand.CommandType = CommandType.StoredProcedure;

                            linkedItemCommand.Parameters.AddWithValue("_IdActivity", activity.IdActivity);
                            linkedItemCommand.Parameters.AddWithValue("_IdLinkedItemType", 44);
                            linkedItemCommand.Parameters.AddWithValue("_IdSite", null);
                            linkedItemCommand.Parameters.AddWithValue("_IdCarProject", null);
                            linkedItemCommand.Parameters.AddWithValue("_IdPerson", null);
                            linkedItemCommand.Parameters.AddWithValue("_IdOffer", idOffer);
                            linkedItemCommand.Parameters.AddWithValue("_IdEmdepSite", Convert.ToInt32(site.ConnectPlantId));
                            linkedItemCommand.Parameters.AddWithValue("_IdCompetitor", null);
                            linkedItemCommand.Parameters.AddWithValue("_CreationDate", DateTime.Now);
                            //linkedItemCommand.Transaction = trans;
                            int idOfferContact = Convert.ToInt32(linkedItemCommand.ExecuteScalar());
                            //trans.Commit();
                            connActivityLinkedItem.Close();
                        }
                        catch (Exception ex)
                        {
                            //trans.Rollback();
                            throw;
                        }
                        //}
                    }


                }
            }
            catch (Exception ex)
            {
                throw;
            }
        }


        public bool UpdateOrderByIdOffer_V2031(Offer offer, string connectionString, string mainServerConnectionString)
        {
            TransactionScope transactionScopeGeos = null;
            TransactionScope transactionScopeEmdepGeos = null;
            bool isUpdated = false;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            try
            {
                using (transactionScopeGeos = new TransactionScope())
                {
                    Int64? nullProductCategory = null;
                    if (offer.IdProductCategory > 0)
                    {
                        nullProductCategory = offer.IdProductCategory;
                    }

                    using (MySqlConnection connOrder = new MySqlConnection(offer.Site.ConnectPlantConstr))
                    {
                        connOrder.Open();

                        MySqlCommand orderCommand = new MySqlCommand("offers_UpdateOrderParticularColumn", connOrder);

                        orderCommand.CommandType = CommandType.StoredProcedure;
                        orderCommand.Parameters.AddWithValue("_Code", offer.Code);
                        orderCommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                        orderCommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                        orderCommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                        orderCommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                        orderCommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                        orderCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        orderCommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                        orderCommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                        orderCommand.ExecuteNonQuery();
                        isUpdated = true;

                        connOrder.Close();

                        if (isUpdated)
                        {
                            if (offer.OfferContacts != null && offer.OfferContacts.Count > 0)
                                AddOrderContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);

                            if (offer.CommentsByOffers != null && offer.CommentsByOffers.Count > 0)     //Comments
                                AddLogEntryByOrder(offer.IdOffer, offer.CommentsByOffers, connectionString, offer.Site.ConnectPlantConstr);

                            if (offer.LogEntryByOffers != null && offer.LogEntryByOffers.Count > 0)     //Log entries.
                                AddLogEntryByOrder(offer.IdOffer, offer.LogEntryByOffers, connectionString, offer.Site.ConnectPlantConstr);
                        }
                    }

                    using (transactionScopeEmdepGeos = new TransactionScope(TransactionScopeOption.RequiresNew))
                    {
                        if (offer.NewlyLinkedActivities != null && offer.NewlyLinkedActivities.Count > 0)
                        {
                            AddLinkExistingActivityToOffer_V2031(mainServerConnectionString, offer.NewlyLinkedActivities, offer.Site, offer.IdOffer);
                            transactionScopeEmdepGeos.Complete();
                        }
                    }

                    transactionScopeGeos.Complete();
                }
            }
            catch (Exception ex)
            {
                isUpdated = false;

                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScopeGeos != null)
                    transactionScopeGeos.Dispose();

                if (transactionScopeEmdepGeos != null)
                    transactionScopeEmdepGeos.Dispose();

                throw;
            }

            return isUpdated;
        }


        public List<TimelineGrid> GetTimelineGridDetails_V2031(TimelineParams timelineParams)
        {
            List<TimelineGrid> timelineGridRows = new List<TimelineGrid>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(timelineParams.connectSiteDetailParams.ConnectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetRestfulTimeData_V2031", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.CommandTimeout = 3000;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", timelineParams.idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", timelineParams.accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", timelineParams.accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", (timelineParams.Roles == RoleType.SalesAssistant) ? 20 : 22);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idEmdepSite", timelineParams.connectSiteDetailParams.idSite);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);


                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid offer = new TimelineGrid();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            if (itemRow["IdSite"] != DBNull.Value)
                            {
                                offer.IdSite = Convert.ToInt32(itemRow["IdSite"].ToString());
                            }

                            if (itemRow["IdOfferType"] != DBNull.Value)
                                offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());

                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.ConnectPlantId = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            offer.Group = itemRow["CustomerGroup"].ToString();
                            offer.Plant = itemRow["SiteName"].ToString().Trim();
                            offer.Country = itemRow["CustomerCountry"].ToString();
                            offer.Region = itemRow["CustomerZone"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                                offer.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                                offer.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());

                            offer.Status = itemRow["OfferStatus"].ToString();
                            offer.HtmlColor = itemRow["OfferStatusColor"].ToString();

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Amount = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            if (itemRow["IdSalesStatusType"] != DBNull.Value)
                                offer.IdSalesStatusType = Convert.ToInt32(itemRow["IdSalesStatusType"].ToString());

                            //  offer.Currency = itemRow["OfferCurrency"].ToString();
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.OfferConfidentialLevel = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                                offer.OfferCloseDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.OfferCloseDate = null;

                            if (itemRow["Rfq"] != DBNull.Value)
                                offer.Rfq = itemRow["Rfq"].ToString();

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RfqReceptionDate = Convert.ToDateTime(itemRow["RFQReception"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.RfqReceptionDate = null;

                            if (itemRow["OfferStatusid"] != DBNull.Value)
                                offer.OfferStatusid = Convert.ToInt32(itemRow["OfferStatusid"].ToString());

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.QuoteSentDate = Convert.ToDateTime(itemRow["SendIn"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.QuoteSentDate = null;


                            offer.Project = itemRow["CarProjectName"].ToString();
                            offer.Source = itemRow["Source"].ToString();
                            offer.BusinessUnit = itemRow["BusinessUnit"].ToString();
                            offer.Oem = itemRow["CarOEM"].ToString();

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                offer.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory = new ProductCategoryGrid();

                            }


                            offer.OptionsByOffers = new List<OptionsByOfferGrid>();
                            timelineGridRows.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            OptionsByOfferGrid optionsByOfferGrid = new OptionsByOfferGrid();
                            optionsByOfferGrid.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsByOfferGrid.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsByOfferGrid.IdOfferPlant = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsByOfferGrid.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsByOfferGrid.Quantity > 0)
                                    optionsByOfferGrid.IsSelected = true;
                                else
                                    optionsByOfferGrid.IsSelected = false;
                            }
                            else
                            {
                                optionsByOfferGrid.IsSelected = false;
                            }
                            optionsByOfferGrid.OfferOption = itemRow["offeroption"].ToString();

                            timelineGridRow.OptionsByOffers.Add(optionsByOfferGrid);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            timelineGridRow.LostCompetitor = itemRow["Name"].ToString();
                            timelineGridRow.LostDescription = itemRow["Comments"].ToString();
                            timelineGridRow.LostReason = itemRow["Reason"].ToString();

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {
                                    if (itemRow["CommentLastUpdate"] != DBNull.Value)
                                    {
                                        timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["CommentLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                    }
                                }
                            }

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {

                                    if (itemRow["ActivityLastUpdate"] != DBNull.Value)
                                    {
                                        if (timelineGridRow.LastActivityDate == null)
                                        {
                                            timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                        else
                                        {
                                            int result = Nullable.Compare<DateTime>(Convert.ToDateTime(itemRow["ActivityLastUpdate"]), Convert.ToDateTime(timelineGridRow.LastActivityDate));
                                            if (result > 0)
                                                timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                    }

                                    //if (timelineGridRow.LastActivityDate == null)
                                    //{
                                    //    timelineGridRow.LastActivityDate =Convert.ToDateTime(timelineGridRow.QuoteSentDate).ToString("dd/MM/yyyy"); 
                                    //}
                                }
                            }

                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString()), Name = itemRow["ProductSubCategory"].ToString() }; });

                                if (itemRow["IdCategory"] != DBNull.Value)
                                {
                                    timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory.IdParent = Convert.ToInt64(itemRow["IdCategory"].ToString()); u.ProductCategory.Category = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdCategory"].ToString()), Name = itemRow["Category"].ToString() }; });
                                }
                            }




                        }
                    }
                }
            }

            return timelineGridRows;
        }


        public List<TimelineGrid> GetSelectedUsersTimelineGridDetails_V2031(TimelineParams timelineParams)
        {
            List<TimelineGrid> timelineGridRows = new List<TimelineGrid>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(timelineParams.connectSiteDetailParams.ConnectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offers_GetRestfulTimeData_V2031", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.CommandTimeout = 3000;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", timelineParams.idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", timelineParams.idsSelectedUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", timelineParams.accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", timelineParams.accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idEmdepSite", timelineParams.connectSiteDetailParams.idSite);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 21);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);

                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid offer = new TimelineGrid();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            if (itemRow["IdSite"] != DBNull.Value)
                            {
                                offer.IdSite = Convert.ToInt32(itemRow["IdSite"].ToString());
                            }

                            if (itemRow["IdOfferType"] != DBNull.Value)
                                offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());

                            if (itemRow["OfferStatusid"] != DBNull.Value)
                                offer.OfferStatusid = Convert.ToInt32(itemRow["OfferStatusid"].ToString());

                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.ConnectPlantId = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            offer.Group = itemRow["CustomerGroup"].ToString();
                            offer.Plant = itemRow["SiteName"].ToString();
                            offer.Country = itemRow["CustomerCountry"].ToString();
                            offer.Region = itemRow["CustomerZone"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                                offer.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                                offer.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());

                            offer.Status = itemRow["OfferStatus"].ToString();
                            offer.HtmlColor = itemRow["OfferStatusColor"].ToString();

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Amount = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            if (itemRow["IdSalesStatusType"] != DBNull.Value)
                                offer.IdSalesStatusType = Convert.ToInt32(itemRow["IdSalesStatusType"].ToString());

                            //  offer.Currency = itemRow["OfferCurrency"].ToString();
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.OfferConfidentialLevel = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                                offer.OfferCloseDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.OfferCloseDate = null;

                            if (itemRow["Rfq"] != DBNull.Value)
                                offer.Rfq = itemRow["Rfq"].ToString();

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RfqReceptionDate = Convert.ToDateTime(itemRow["RFQReception"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.RfqReceptionDate = null;

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.QuoteSentDate = Convert.ToDateTime(itemRow["SendIn"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.QuoteSentDate = null;

                            offer.Project = itemRow["CarProjectName"].ToString();
                            offer.Source = itemRow["Source"].ToString();
                            offer.BusinessUnit = itemRow["BusinessUnit"].ToString();
                            offer.Oem = itemRow["CarOEM"].ToString();

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                offer.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory = new ProductCategoryGrid();

                            }



                            offer.OptionsByOffers = new List<OptionsByOfferGrid>();
                            timelineGridRows.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            OptionsByOfferGrid optionsByOfferGrid = new OptionsByOfferGrid();
                            optionsByOfferGrid.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsByOfferGrid.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsByOfferGrid.IdOfferPlant = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsByOfferGrid.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsByOfferGrid.Quantity > 0)
                                    optionsByOfferGrid.IsSelected = true;
                                else
                                    optionsByOfferGrid.IsSelected = false;
                            }
                            else
                            {
                                optionsByOfferGrid.IsSelected = false;
                            }
                            optionsByOfferGrid.OfferOption = itemRow["offeroption"].ToString();

                            timelineGridRow.OptionsByOffers.Add(optionsByOfferGrid);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            timelineGridRow.LostCompetitor = itemRow["Name"].ToString();
                            timelineGridRow.LostDescription = itemRow["Comments"].ToString();
                            timelineGridRow.LostReason = itemRow["Reason"].ToString();

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {
                                    if (itemRow["CommentLastUpdate"] != DBNull.Value)
                                    {
                                        timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["CommentLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                    }
                                }
                            }

                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {

                                    if (itemRow["ActivityLastUpdate"] != DBNull.Value)
                                    {
                                        if (timelineGridRow.LastActivityDate == null)
                                        {
                                            timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                        else
                                        {
                                            int result = Nullable.Compare<DateTime>(Convert.ToDateTime(itemRow["ActivityLastUpdate"]), Convert.ToDateTime(timelineGridRow.LastActivityDate));
                                            if (result > 0)
                                                timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                    }

                                }
                            }

                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString()), Name = itemRow["ProductSubCategory"].ToString() }; });

                                if (itemRow["IdCategory"] != DBNull.Value)
                                {
                                    timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory.IdParent = Convert.ToInt64(itemRow["IdCategory"].ToString()); u.ProductCategory.Category = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdCategory"].ToString()), Name = itemRow["Category"].ToString() }; });
                                }
                            }

                        }
                    }
                }
            }

            return timelineGridRows;
        }


        public People AddContact_V2033(string mainServerConnectionString, People people)
        {
            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainServerConnectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("people_InsertContact_V2033", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdPersonType", people.IdPersonType);
                        mySqlCommand.Parameters.AddWithValue("_Name", people.Name);
                        mySqlCommand.Parameters.AddWithValue("_Surname", people.Surname);
                        mySqlCommand.Parameters.AddWithValue("_Email", people.Email);
                        mySqlCommand.Parameters.AddWithValue("_Phone", people.Phone);
                        mySqlCommand.Parameters.AddWithValue("_Observations", people.Observations);
                        mySqlCommand.Parameters.AddWithValue("_IdPersonGender", people.IdPersonGender);
                        mySqlCommand.Parameters.AddWithValue("_IdCompany", people.Company.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_IdCountry", people.Company.IdCountry);
                        mySqlCommand.Parameters.AddWithValue("_Address", people.Company.Address);
                        mySqlCommand.Parameters.AddWithValue("_Telephone", people.Company.Telephone);
                        mySqlCommand.Parameters.AddWithValue("_CompanyEmail", people.Company.Email);
                        mySqlCommand.Parameters.AddWithValue("_Region", people.Company.Region);
                        mySqlCommand.Parameters.AddWithValue("_City", people.Company.City);
                        mySqlCommand.Parameters.AddWithValue("_PostCode", people.Company.ZipCode);
                        mySqlCommand.Parameters.AddWithValue("_ModifiedBy", people.Company.ModifiedBy);
                        mySqlCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                        mySqlCommand.Parameters.AddWithValue("_IdCompanyDepartment", people.IdCompanyDepartment);
                        mySqlCommand.Parameters.AddWithValue("_JobTitle", people.JobTitle);
                        mySqlCommand.Parameters.AddWithValue("_Image", people.ImageText);
                        mySqlCommand.Parameters.AddWithValue("_IdContactInfluenceLevel", people.IdContactInfluenceLevel);
                        mySqlCommand.Parameters.AddWithValue("_IdContactEmdepAffinity", people.IdContactEmdepAffinity);
                        mySqlCommand.Parameters.AddWithValue("_IdContactProductInvolved", people.IdContactProductInvolved);
                        mySqlCommand.Parameters.AddWithValue("_IdCompetitor", people.IdCompetitor);
                        mySqlCommand.Parameters.AddWithValue("_IdCreator", people.IdCreator);

                        people.IdPerson = Convert.ToInt32(mySqlCommand.ExecuteScalar());
                        mySqlConnection.Close();
                    }

                    if (people.CommentsByContact != null && people.CommentsByContact.Count > 0)
                        AddUpdateDeleteCommentsByContact(people.IdPerson, people.CommentsByContact, mainServerConnectionString);

                    if (people.LogEntriesByContact != null && people.LogEntriesByContact.Count > 0)
                        AddLogEntriesByContact(people.IdPerson, people.LogEntriesByContact, mainServerConnectionString);

                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();

                throw;
            }

            return people;
        }




        public List<People> GetContactsByIdPermission_V2033(string connectionstring, Int32 idActiveUser, string idUser, string idSite, Int32 idPermission)
        {
            List<People> peoples = new List<People>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();
                MySqlCommand mySqlCommand = new MySqlCommand("people_GetContactsByIdPermission_V2033", mySqlConnection);

                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_idActiveUser", idActiveUser);
                mySqlCommand.Parameters.AddWithValue("_idUser", idUser);
                mySqlCommand.Parameters.AddWithValue("_idSite", idSite);
                mySqlCommand.Parameters.AddWithValue("_idPermission", idPermission);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        People people = new People();
                        people.IdPerson = Convert.ToInt32(reader["IdPerson"]);
                        people.Name = Convert.ToString(reader["FirstName"]);
                        people.Surname = Convert.ToString(reader["LastName"]);
                        people.Phone = Convert.ToString(reader["Telephone"]);
                        people.Email = Convert.ToString(reader["Email"]);

                        if (reader["IdPersonGender"] != DBNull.Value)
                        {
                            people.IdPersonGender = Convert.ToByte(reader["IdPersonGender"]);
                            if (people.IdPersonGender == 1)
                                people.UserGender = "Female";
                            else if (people.IdPersonGender == 2)
                                people.UserGender = "Male";
                        }

                        people.IdPersonType = Convert.ToByte(reader["IdPersonType"].ToString());
                        people.PeopleType = new PeopleType();
                        people.PeopleType.IdPersonType = Convert.ToByte(reader["IdPersonType"].ToString());
                        people.PeopleType.Name = Convert.ToString(reader["PersonTypeName"]);

                        if (reader["CreatedIn"] != DBNull.Value)
                            people.CreatedIn = Convert.ToDateTime(reader["CreatedIn"].ToString());

                        people.Company = new Company() { IdCompany = Convert.ToInt32(reader["IdCompany"].ToString()), Name = reader["CustomerPlant"].ToString().Trim(), Country = new Country { IdCountry = Convert.ToByte(reader["IdCountry"].ToString()), Name = reader["Country"].ToString(), Zone = new Zone { Name = reader["Zone"].ToString() } } };

                        if (idPermission == 21 || idPermission == 22)
                        {
                            if (reader["IdSalesResponsible"] != DBNull.Value)
                            {
                                people.Company.IdSalesResponsible = Convert.ToInt32(reader["IdSalesResponsible"]);
                                people.Company.People = new People();
                                people.Company.People.IdPerson = (Int32)people.Company.IdSalesResponsible;

                                if (reader["SalesResponsibleFirstName"] != DBNull.Value)
                                    people.Company.People.Name = Convert.ToString(reader["SalesResponsibleFirstName"]);

                                if (reader["SalesResponsibleLastName"] != DBNull.Value)
                                    people.Company.People.Surname = Convert.ToString(reader["SalesResponsibleLastName"]);
                            }

                            if (reader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            {
                                people.Company.IdSalesResponsibleAssemblyBU = Convert.ToInt32(reader["IdSalesResponsibleAssemblyBU"]);

                                people.Company.PeopleSalesResponsibleAssemblyBU = new People();
                                people.Company.PeopleSalesResponsibleAssemblyBU.IdPerson = (Int32)people.Company.IdSalesResponsibleAssemblyBU;

                                if (reader["SalesResponsibleBUFirstName"] != DBNull.Value)
                                    people.Company.PeopleSalesResponsibleAssemblyBU.Name = Convert.ToString(reader["SalesResponsibleBUFirstName"]);

                                if (reader["SalesResponsibleBULastName"] != DBNull.Value)
                                    people.Company.PeopleSalesResponsibleAssemblyBU.Surname = Convert.ToString(reader["SalesResponsibleBULastName"]);
                            }
                        }

                        people.Company.Address = Convert.ToString(reader["SiteAddress"]);
                        people.Observations = Convert.ToString(reader["Observations"]);
                        people.Company.City = Convert.ToString(reader["SiteCity"]);
                        people.Company.CIF = Convert.ToString(reader["SiteCIF"]);
                        people.Company.Telephone = Convert.ToString(reader["SiteTelephone"]);
                        people.Company.Fax = Convert.ToString(reader["SiteFax"]);
                        people.Company.PostCode = Convert.ToString(reader["SitePostCode"]);
                        people.Company.ZipCode = Convert.ToString(reader["SitePostCode"]);
                        people.Company.Region = Convert.ToString(reader["SiteRegion"]);
                        people.Company.RegisteredName = Convert.ToString(reader["SiteRegisteredName"]);
                        people.Company.Website = Convert.ToString(reader["SiteWebsite"]);
                        people.Company.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(reader["IdCustomer"].ToString()), CustomerName = reader["CustomerGroup"].ToString() } };

                        if (reader["IdCompanyDepartment"] != DBNull.Value)
                        {
                            people.IdCompanyDepartment = Convert.ToInt32(reader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment = new LookupValue();
                            people.CompanyDepartment.IdLookupValue = Convert.ToInt32(reader["IdCompanyDepartment"].ToString());
                            people.CompanyDepartment.Value = reader["Value"].ToString();

                            if (reader["IdImage"] != DBNull.Value)
                                people.CompanyDepartment.IdImage = Convert.ToInt64(reader["IdImage"].ToString());

                            //if (peoplereader["InUse"] != DBNull.Value)
                            //    people.CompanyDepartment.InUse = Convert.ToBoolean(peoplereader["InUse"].ToString());
                        }

                        people.JobTitle = reader["JobTitle"].ToString();
                        people.ImageText = reader["Image"].ToString();

                        if (reader["IdContactInfluenceLevel"] != DBNull.Value)
                        {
                            people.IdContactInfluenceLevel = Convert.ToInt32(reader["IdContactInfluenceLevel"].ToString());
                            people.InfluenceLevel = new LookupValue();
                            people.InfluenceLevel.IdLookupValue = Convert.ToInt32(reader["IdContactInfluenceLevel"].ToString());
                            people.InfluenceLevel.Value = reader["InfluenceLevel"].ToString();
                            people.InfluenceLevel.HtmlColor = reader["InfluenceLevelHtmlcolor"].ToString();

                            if (reader["InfluenceLevelIdImage"] != DBNull.Value)
                                people.InfluenceLevel.IdImage = Convert.ToInt64(reader["InfluenceLevelIdImage"].ToString());

                            //if (peoplereader["InfluenceLevelInUse"] != DBNull.Value)
                            //    people.InfluenceLevel.InUse = Convert.ToBoolean(peoplereader["InfluenceLevelInUse"].ToString());
                        }

                        if (reader["IdContactEmdepAffinity"] != DBNull.Value)
                        {
                            people.IdContactEmdepAffinity = Convert.ToInt32(reader["IdContactEmdepAffinity"].ToString());
                            people.EmdepAffinity = new LookupValue();
                            people.EmdepAffinity.IdLookupValue = Convert.ToInt32(reader["IdContactEmdepAffinity"].ToString());
                            people.EmdepAffinity.Value = reader["EmdepAffinity"].ToString();
                            people.EmdepAffinity.HtmlColor = reader["EmdepAffinityHtmlcolor"].ToString();

                            if (reader["EmdepAffinityIdImage"] != DBNull.Value)
                                people.EmdepAffinity.IdImage = Convert.ToInt64(reader["EmdepAffinityIdImage"].ToString());

                            //if (peoplereader["EmdepAffinityInUse"] != DBNull.Value)
                            //    people.EmdepAffinity.InUse = Convert.ToBoolean(peoplereader["EmdepAffinityInUse"].ToString());
                        }

                        if (reader["IdContactProductInvolved"] != DBNull.Value)
                        {
                            people.IdContactProductInvolved = Convert.ToInt32(reader["IdContactProductInvolved"].ToString());
                            people.ProductInvolved = new LookupValue();
                            people.ProductInvolved.IdLookupValue = Convert.ToInt32(reader["IdContactProductInvolved"].ToString());
                            people.ProductInvolved.Value = reader["ProductInvolved"].ToString();
                            people.ProductInvolved.HtmlColor = reader["ProductInvolvedLevelHtmlcolor"].ToString();

                            if (reader["ProductInvolvedLevelIdImage"] != DBNull.Value)
                                people.ProductInvolved.IdImage = Convert.ToInt64(reader["ProductInvolvedLevelIdImage"].ToString());

                            //if (peoplereader["ProductInvolvedInUse"] != DBNull.Value)
                            //    people.ProductInvolved.InUse..
                        }

                        if (reader["IdCompetitor"] != DBNull.Value)
                        {
                            people.IdCompetitor = Convert.ToInt32(reader["IdCompetitor"].ToString());
                            people.Competitor = new Competitor();
                            people.Competitor.IdCompetitor = Convert.ToInt32(reader["IdCompetitor"].ToString());
                            people.Competitor.Name = reader["Competitor"].ToString();
                        }


                        if (reader["IdCreator"] != DBNull.Value)
                        {
                            people.IdCreator = Convert.ToInt32(reader["IdCreator"].ToString());
                            people.Creator = new People();
                            people.Creator.IdPerson = Convert.ToInt32(reader["IdCreator"].ToString());
                            people.Creator.Name = Convert.ToString(reader["CreatedByFirstName"].ToString());
                            people.Creator.Surname = Convert.ToString(reader["CreatedByLastName"].ToString());
                        }

                        peoples.Add(people);
                    }
                }
            }
            return peoples;
        }



        private void InsertEngAnalysisInDotProject_V2033(string dotProjectConnectionString, string connectionString, MailServer mailServer, string workbenchConnectionString, Offer offer, Quotation quotation)
        {
            int idproject;
            int idtaskManagement;
            int idtaskAnalysis;
            bool isCustomerExist = false;
            //Check Customer and plant exist in dotproject database
            Company company = GetSiteCustomerDetails(connectionString, offer.IdCustomer);

            if (company != null)
                isCustomerExist = AddCustomerPlantInDotProject(dotProjectConnectionString, company);

            if (isCustomerExist)
            {
                TransactionScope transactionScope = null;

                try
                {
                    string projectName = GetNextProjectNameFromDotProject(dotProjectConnectionString);
                    EmdepSite site = GetEmdepSiteById(Convert.ToInt32(offer.Site.ConnectPlantId), connectionString);

                    using (transactionScope = new TransactionScope(TransactionScopeOption.Required, new TransactionOptions() { IsolationLevel = System.Transactions.IsolationLevel.RepeatableRead }))
                    {
                        UpdateNextProjectNumberOfDotproject(dotProjectConnectionString);

                        using (MySqlConnection connRddotProject = new MySqlConnection(dotProjectConnectionString))
                        {
                            connRddotProject.Open();

                            MySqlCommand MyCommand = new MySqlCommand("epc_InsertIntoProjects", connRddotProject);
                            MyCommand.CommandType = CommandType.StoredProcedure;

                            //MyCommand.CommandText = @"INSERT INTO projects (project_Internal_name, project_company, project_company_internal, project_department, 
                            //                                project_name, project_ot, project_short_name, project_owner, project_url, project_start_date, project_status, 
                            //                                project_color_identifier, project_description, project_creator,project_departments, project_category, 
                            //                                project_type, project_priority, project_plant, project_origin, project_requester, project_end_date) values(?PROJECTINTERNALNAME, ?PROJECTCOMPANY, 
                            //                                ?PROJECTCOMPANYINTERNAL, ?PROJECTDEPARTMENT, ?PROJECTNAME, ?PROJECTOT, ?PROJECTSHORTNAME, ?PROJECTOWNER, ?PROJECTURL, 
                            //                                ?PROJECTSTARTDATE, ?PROJECTSTATUS, ?PROJECTCOLORIDENTIFIER, ?PROJECTDESCRIPTION, ?PROJECTCREATOR, ?PROJECTDEPARTMENTS,
                            //                                ?PROJECTCATEGORY, ?PROJECTTYPE, ?PROJECTPRIORITY, ?PROJECTPLANT, ?PROJECTORIGIN, ?PROJECT_REQUESTER, ?PROJECTENDDATE)";

                            MyCommand.Parameters.AddWithValue("_projectInternalName", projectName);
                            MyCommand.Parameters.AddWithValue("_projectCompany", 260);
                            MyCommand.Parameters.AddWithValue("_projectCompanyInternal", 0);
                            MyCommand.Parameters.AddWithValue("_projectDepartment", 0);
                            MyCommand.Parameters.AddWithValue("_projectName", offer.Description);
                            MyCommand.Parameters.AddWithValue("_projectOt", offer.Code);

                            if (!string.IsNullOrEmpty(offer.Description))
                            {
                                if (offer.Description.Length >= 10)
                                    MyCommand.Parameters.AddWithValue("_projectShortname", offer.Description.Substring(0, 10));
                                else
                                    MyCommand.Parameters.AddWithValue("_projectShortname", offer.Description);
                            }
                            else
                            {
                                MyCommand.Parameters.AddWithValue("_projectShortname", string.Empty);
                            }

                            MyCommand.Parameters.AddWithValue("_projectOwner", 3);
                            MyCommand.Parameters.AddWithValue("_projectUrl", @"file://serveres03/rddotproject$/" + DateTime.Now.Year + @"/" + projectName);
                            MyCommand.Parameters.AddWithValue("_projectStartdate", DateTime.Now);
                            MyCommand.Parameters.AddWithValue("_projectStatus", 9);
                            MyCommand.Parameters.AddWithValue("_projectColorIdentifier", "FF000");
                            MyCommand.Parameters.AddWithValue("_projectDescription", offer.Description);

                            if (offer.CreatedBy > 0)
                                MyCommand.Parameters.AddWithValue("_projectCreator", offer.CreatedBy);          // GOM_v3.Properties.Settings.Default.LOGGED_USER.Id.ToString());
                            else
                                MyCommand.Parameters.AddWithValue("_projectCreator", offer.ModifiedBy);

                            MyCommand.Parameters.AddWithValue("_projectDepartments", string.Empty);

                            //If it is automation we keep it in dotproject as TAU (13)
                            if (offer.IdBusinessUnit == (uint)3)
                                MyCommand.Parameters.AddWithValue("?_projectCategory", 13);
                            else
                                MyCommand.Parameters.AddWithValue("_projectCategory", 1);

                            MyCommand.Parameters.AddWithValue("_projectType", 0);
                            MyCommand.Parameters.AddWithValue("_projectPriority", -1);
                            MyCommand.Parameters.AddWithValue("_projectPlant", offer.IdCustomer);                               //   o.Customer.Id.ToString());
                            MyCommand.Parameters.AddWithValue("_projectOrigin", Convert.ToInt32(offer.Site.ConnectPlantId));    // GOM_v3.Properties.Settings.Default.SITE.ToString());

                            if (offer.CreatedBy > 0)
                                MyCommand.Parameters.AddWithValue("_projectRequester", offer.CreatedBy);                            // GOM_v3.Properties.Settings.Default.LOGGED_USER.Id.ToString());
                            else
                                MyCommand.Parameters.AddWithValue("_projectRequester", offer.ModifiedBy);

                            MyCommand.Parameters.AddWithValue("_projectEnddate", null);

                            idproject = Convert.ToInt32(MyCommand.ExecuteScalar());
                            connRddotProject.Close();
                        }

                        //Task - 00. Management
                        using (MySqlConnection connRddotTask = new MySqlConnection(dotProjectConnectionString))
                        {
                            connRddotTask.Open();

                            MySqlCommand MyCommand = new MySqlCommand("epc_InsertIntoTasks", connRddotTask);
                            MyCommand.CommandType = CommandType.StoredProcedure;

                            //MyCommand.CommandText = @"INSERT INTO tasks (task_name,task_project,task_owner,task_start_date,task_description,task_creator, task_end_date, task_duration, task_type)
                            //                VALUES (?TASKNAME,?TASKPROJECT,?TASKOWNER,?TASKSTARTDATE,?TASKDESCRIPTION, ?TASKCREATOR, ?ENDDATE, ?TASKDURATION, ?TASKTYPE)";

                            MyCommand.Parameters.AddWithValue("_taskName", "00. Management");
                            MyCommand.Parameters.AddWithValue("_taskProject", idproject);
                            MyCommand.Parameters.AddWithValue("_taskOwner", 3);
                            MyCommand.Parameters.AddWithValue("_taskStartdate", DateTime.Now);
                            MyCommand.Parameters.AddWithValue("_taskDescription", "Management");

                            if (offer.CreatedBy > 0)
                                MyCommand.Parameters.AddWithValue("_taskCreator", offer.CreatedBy);         // GOM_v3.Properties.Settings.Default.LOGGED_USER.Id.ToString());
                            else
                                MyCommand.Parameters.AddWithValue("_taskCreator", offer.ModifiedBy);

                            MyCommand.Parameters.AddWithValue("_taskDuration", 1);
                            MyCommand.Parameters.AddWithValue("_taskType", 7);

                            if (quotation.Ots[0].DeliveryDate.Value != null)
                                MyCommand.Parameters.AddWithValue("_taskEnddate", quotation.Ots[0].DeliveryDate.Value.ToString("yyyy-MM-dd 00:00:00"));
                            else
                                MyCommand.Parameters.AddWithValue("_taskEnddate", null);

                            idtaskManagement = Convert.ToInt32(MyCommand.ExecuteScalar());
                            connRddotTask.Close();
                        }

                        //Task - 01.Analysis
                        using (MySqlConnection connRddotTask = new MySqlConnection(dotProjectConnectionString))
                        {
                            connRddotTask.Open();

                            MySqlCommand MyCommand = new MySqlCommand("epc_InsertIntoTasks", connRddotTask);
                            MyCommand.CommandType = CommandType.StoredProcedure;

                            //MyCommand.CommandText = @"INSERT INTO tasks (task_name,task_project,task_owner,task_start_date,task_description,task_creator, task_end_date, task_duration, task_type)
                            //                VALUES (?TASKNAME,?TASKPROJECT,?TASKOWNER,?TASKSTARTDATE,?TASKDESCRIPTION, ?TASKCREATOR, ?ENDDATE, ?TASKDURATION, ?TASKTYPE)";

                            MyCommand.Parameters.AddWithValue("_taskName", "01. Analysis");
                            MyCommand.Parameters.AddWithValue("_taskProject", idproject);
                            MyCommand.Parameters.AddWithValue("_taskOwner", 3);
                            MyCommand.Parameters.AddWithValue("_taskStartdate", DateTime.Now);
                            MyCommand.Parameters.AddWithValue("_taskDescription", "Analysis for the offer");

                            if (offer.CreatedBy > 0)
                                MyCommand.Parameters.AddWithValue("_taskCreator", offer.CreatedBy);         // GOM_v3.Properties.Settings.Default.LOGGED_USER.Id.ToString());
                            else
                                MyCommand.Parameters.AddWithValue("_taskCreator", offer.ModifiedBy);

                            MyCommand.Parameters.AddWithValue("_taskDuration", 1);
                            MyCommand.Parameters.AddWithValue("_taskEnddate", null);
                            MyCommand.Parameters.AddWithValue("_taskType", 5);

                            idtaskAnalysis = Convert.ToInt32(MyCommand.ExecuteScalar());
                            connRddotTask.Close();
                        }

                        //Insert custom field values.
                        using (MySqlConnection connRddotCustomField = new MySqlConnection(dotProjectConnectionString))
                        {
                            connRddotCustomField.Open();

                            MySqlCommand MyCommand = new MySqlCommand("epc_InsertIntoCustomFieldsValues", connRddotCustomField);
                            MyCommand.CommandType = CommandType.StoredProcedure;

                            //GOM_v3.Properties.Settings.Default.SITE);

                            //MyCommand.CommandText = @"INSERT INTO custom_fields_values (value_id, value_module, value_object_id,value_field_id,value_charvalue, value_intvalue)
                            //                VALUES ((SELECT id + 1 FROM custom_fields_values_id c),?MODULE, ?ID, ?FIELD_ID, ?CHARVALUE, ?INTVALUE)";

                            MyCommand.Parameters.AddWithValue("_Module", string.Empty);
                            MyCommand.Parameters.AddWithValue("_Id", idproject);
                            MyCommand.Parameters.AddWithValue("_FieldId", 8);
                            MyCommand.Parameters.AddWithValue("_CharValue", "file://" + site.FileServerIP + "/WorkingOrders$/" + offer.Year.ToString() + "/" + offer.Code);
                            MyCommand.Parameters.AddWithValue("_Intvalue", "0");

                            MyCommand.ExecuteNonQuery();

                            connRddotCustomField.Close();

                            //MyCommand.CommandText = @"UPDATE rddotproject.custom_fields_values_id set id=id+1;";
                            //MyCommand.ExecuteNonQuery();
                        }

                        //tasks
                        UpdateTaskParentInDotProject(dotProjectConnectionString, idtaskManagement);
                        UpdateTaskParentInDotProject(dotProjectConnectionString, idtaskAnalysis);

                        transactionScope.Complete();
                    }

                    // GOM_v3.Properties.Settings.Default.Email_New_Project_DotProject;
                    ApplicationManager applicationManager = new ApplicationManager();
                    GeosAppSetting geosAppSetting = GetGeosAppSettings(1, workbenchConnectionString);

                    applicationManager.SendNewRddotProjectMail(mailServer, geosAppSetting.DefaultValue, projectName, offer, quotation.Ots[0].DeliveryDate.Value.ToString("yyyy-MM-dd"));

                    //Email to people.
                    //string subject = string.Format("[GEOS notification] New Project {0}", offer.Code);
                    //string description = string.Format(@"{0} from Commercial department has created the following project: 
                    //                    - Description: {1} 
                    //                    - Working Order: {2} 
                    //                    - Internal ID: {3}
                    //                    - Customer: {4} 
                    //                    - Delivery date: {5}", "skhade", offer.Description, offer.Code, projectName, offer.Customer.FullName, quotation.Ots[0].DeliveryDate.Value.ToString("yyyy-MM-dd"));

                    /////GOM_v3.Properties.Settings.Default.LOGGED_USER.FullName replaced with skhade
                    //string to = ""; // GOM_v3.Properties.Settings.Default.Email_New_Project_DotProject;
                    //cm.SendMail(to, GOM_v3.Properties.Settings.Default.LOGGED_USER, string.Empty, subject, description, GOM_v3.Properties.Settings.Default.EMAIL_SERVER);
                    //Ho desactivem perqu els comercials no han de tenir perms a R&D
                    //CreateFoldersForDotproject(projectName, q);
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }
        }


        public void AddQuotations_V2033(Offer offer, string connectionstring, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {
            try
            {
                foreach (OptionsByOffer optionsByOffer in offer.OptionsByOffers)
                {
                    List<Template> selectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                    Template selectedOptiontemplate = GetDefaultArticleByIdOfferOption(optionsByOffer.IdOption, connectionstring);
                    if (selectedOptiontemplate != null)
                        selectedOptionTemplates.Add(selectedOptiontemplate);

                    using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                    {
                        conquotation.Open();

                        using (MySqlTransaction trans = conquotation.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand conquotationcommand = new MySqlCommand("optionsbyoffer_Insert", conquotation);
                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                conquotationcommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                conquotationcommand.Parameters.AddWithValue("_Quantity", optionsByOffer.Quantity);
                                conquotationcommand.Transaction = trans;
                                conquotationcommand.ExecuteNonQuery();

                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }

                    foreach (Template quotation in selectedOptionTemplates)
                    {
                        Int64 idQuotation = 0;
                        Quotation tempquotation = new Quotation();
                        tempquotation.Offer = new Offer();
                        tempquotation.Offer.IdOffer = offer.IdOffer;
                        tempquotation.Year = DateTime.Now.Year;
                        tempquotation.Number = offer.Number;
                        tempquotation.Code = offer.Code + quotation.Suffix;
                        tempquotation.CreatedIn = DateTime.Now;
                        tempquotation.Template = new Template();
                        tempquotation.Template = quotation;

                        if (quotation.IdTemplate != 0)
                        {
                            string quotationCode = offer.Code + quotation.Suffix;
                            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                            {
                                conquotation.Open();
                                using (MySqlTransaction trans = conquotation.BeginTransaction())
                                {
                                    try
                                    {
                                        MySqlCommand conquotationcommand = new MySqlCommand("quotations_Insert", conquotation);
                                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                                        conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                        conquotationcommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                        conquotationcommand.Parameters.AddWithValue("_Description", offer.Description);
                                        conquotationcommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                        conquotationcommand.Parameters.AddWithValue("_Number", offer.Number);
                                        conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                        conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                        conquotationcommand.Parameters.AddWithValue("_QuotQuantity", 0);
                                        conquotationcommand.Transaction = trans;
                                        idQuotation = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                                        if (idQuotation > 0)
                                        {
                                            bool isinsert = false;
                                            MySqlCommand conoffercommand = new MySqlCommand("revisions_GetrevisionsByIdQuotation", conquotation);
                                            conoffercommand.CommandType = CommandType.StoredProcedure;
                                            conoffercommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                            using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                                            {
                                                if (!offerreader.Read())
                                                {
                                                    isinsert = true;
                                                }
                                            }

                                            if (isinsert)
                                            {
                                                Revision r = new Revision();
                                                r.NumRevision = 0;
                                                //[001]
                                                if (offer.CreatedBy != null && offer.CreatedBy == 164)
                                                {
                                                    r.CreatedBy = 164;
                                                    r.ReviewedBy = 164;
                                                }
                                                else
                                                {
                                                    r.CreatedBy = offer.CreatedBy;
                                                    r.ReviewedBy = offer.CreatedBy;
                                                }
                                                r.CreatedIn = DateTime.Now;
                                                r.NumRevision = 0;
                                                r.Discount = 0;
                                                r.ExpireDate = DateTime.Now.AddDays(14);
                                                r.Comments = offer.Contact + "\r\n" + offer.Description;
                                                //r.Quotation = quotation;
                                                if (quotation.IdTemplate == 15 || quotation.IdTemplate == 16 || quotation.IdTemplate == 18)
                                                    r.ApprovedIn = DateTime.Now;
                                                else
                                                    r.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");

                                                conquotationcommand = new MySqlCommand("revisions_Insert", conquotation);
                                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                                                conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r.ReviewedBy);
                                                conquotationcommand.Parameters.AddWithValue("_NumRevision", r.NumRevision);
                                                conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.CreatedBy);
                                                conquotationcommand.Parameters.AddWithValue("_MadeBy", r.CreatedBy);
                                                conquotationcommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                                conquotationcommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                                conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                                                conquotationcommand.Parameters.AddWithValue("_CreationDate", r.CreatedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_Comments", r.Comments);
                                                conquotationcommand.Parameters.AddWithValue("_Closed", r.ApprovedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Transaction = trans;
                                                r.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                tempquotation.Revisions = new List<Revision>();
                                                tempquotation.Revisions.Add(r);

                                            }
                                        }

                                        trans.Commit();
                                    }
                                    catch (Exception ex)
                                    {
                                        trans.Rollback();
                                        throw;
                                    }
                                }
                            }
                        }

                        tempquotation.IdQuotation = idQuotation;
                        ///////////////////////////////////////////////////////
                        if (offer.IdOfferType != 10 && quotation.IdTemplate == 15)
                        {
                            List<OtItem> items = new List<OtItem>();

                            List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                            items.AddRange(temp);

                            if (items.Count != 0)
                                CreateQuotationWithItems(tempquotation, offer, items, connectionstring);
                        }
                        else if (offer.IdOfferType != 10 && quotation.IdTemplate == 23)
                        {
                            List<OtItem> items = new List<OtItem>();

                            List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                            items.AddRange(temp);
                            if (items.Count != 0)
                                CreateQuotationWithItems(tempquotation, offer, items, connectionstring);

                            //link EPC for eng analysis. 
                            if (!ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                InsertEngAnalysisInDotProject_V2033(dotProjectConnectionString, connectionstring, mailServer, workbenchConnectionString, offer, tempquotation);
                            else
                                UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, tempquotation, workbenchConnectionString, mailServer);

                            if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.IsCompleted &&
                                tempquotation != null && tempquotation.Ots != null && tempquotation.Ots.Count > 0
                                && tempquotation.Ots[0].Items != null && tempquotation.Ots[0].Items.Count > 0)
                            {
                                ApplicationManager app = new ApplicationManager();

                                //This property is for AssignedEngAnalysis from dotproject.
                                People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);
                                app.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.CreatedByUser, assignedEngAnalysisPerson, tempquotation.Ots[0].DeliveryDate);

                                LogEntryByOffer log = new LogEntryByOffer();
                                log.IdUser = offer.CreatedBy;
                                log.DateTime = DateTime.Now;
                                log.Comments = "The analysis of engineering department has been completed.";
                                log.IdLogEntryType = 2;
                                offer.LogEntryByOffers.Add(log);
                            }

                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }
        }



        private void UpdateQuotation_V2033(Offer offer, string connectionstring, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {
            List<Quotation> quotationByIdOffer = GetOfferQuotationByIdOffer(offer.IdOffer, connectionstring).ToList();
            List<byte> quotIdDetectionsTemplates = quotationByIdOffer.Select(fg => fg.IdDetectionsTemplate).ToList();

            //List<byte> quotIdDetectionsTemplates = GetOfferQuotationByIdOffer(offer.IdOffer, connectionstring).ToList().Select(fg => fg.IdDetectionsTemplate).ToList();

            List<byte> selectedOptionByOfferTemplates = GetTemplatesBySelectedOptionsByOffer(connectionstring, offer.OptionsByOffers.Where(op => op.IsSelected == true).ToList());


            foreach (OptionsByOffer optionsByOffer in offer.OptionsByOffers)
            {
                if (optionsByOffer.IsSelected == true && optionsByOffer.Quantity > 0)
                {
                    List<Template> selectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                    Template selectedOptiontemplate = GetDefaultArticleByIdOfferOption(optionsByOffer.IdOption, connectionstring);
                    if (selectedOptiontemplate != null)
                        selectedOptionTemplates.Add(selectedOptiontemplate);

                    using (MySqlConnection conoption = new MySqlConnection(connectionstring))
                    {
                        conoption.Open();
                        using (MySqlTransaction trans = conoption.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand conoptioncommand = new MySqlCommand("optionsbyoffer_Update", conoption);
                                conoptioncommand.CommandType = CommandType.StoredProcedure;
                                conoptioncommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                conoptioncommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                conoptioncommand.Parameters.AddWithValue("_Quantity", optionsByOffer.Quantity);
                                conoptioncommand.Transaction = trans;
                                conoptioncommand.ExecuteNonQuery();
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }


                    foreach (Template quotation in selectedOptionTemplates)
                    {
                        if (!quotIdDetectionsTemplates.Contains(quotation.IdTemplate))
                        {
                            bool isUpdate = false;
                            string quotationCode = offer.Code + quotation.Suffix;
                            Int64 idQuotation = 0;

                            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                            {
                                conquotation.Open();
                                MySqlCommand conquotationcommand = new MySqlCommand("quotations_GetquotationsByCode", conquotation);
                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                using (MySqlDataReader reader = conquotationcommand.ExecuteReader())
                                {
                                    if (reader.Read())
                                    {
                                        isUpdate = true;

                                        if (reader["IdQuotation"] != DBNull.Value)
                                        {
                                            idQuotation = Convert.ToInt64(reader["IdQuotation"]);
                                        }
                                    }
                                }
                            }

                            if (isUpdate)
                            {
                                using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                {
                                    conquotation.Open();
                                    using (MySqlTransaction trans = conquotation.BeginTransaction())
                                    {
                                        try
                                        {
                                            // string sqlQuery = "update quotations set IdOffer=" + offer.IdOffer + " where IdDetectionsTemplate = " + quotation.IdTemplate + " AND Code = '" + quotationCode + "';";
                                            MySqlCommand conquotationcommand = new MySqlCommand("quotations_UpdateByCode", conquotation);
                                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                                            conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                            conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                            conquotationcommand.Transaction = trans;
                                            conquotationcommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }

                                //Engineering analysis update code. Comment and date when added from unlinked to linked.
                                if (optionsByOffer.IdOption == 25)
                                {
                                    Quotation quot = new Quotation();
                                    quot.IdQuotation = idQuotation;

                                    if (quot != null)
                                    {
                                        Ots ot = GetOTByQuotationId(quot, connectionstring);
                                        List<OtItem> otitems = null;

                                        if (ot != null)
                                        {
                                            otitems = GetOtItemsByIdOT(ot, connectionstring);

                                            using (var transactionScope = new TransactionScope())
                                            {
                                                try
                                                {
                                                    UpdateOTByIdOT(offer, quot, ot, connectionstring);

                                                    foreach (var otItem in otitems)
                                                    {
                                                        UpdateOTitemByIdOtItem(offer, otItem, connectionstring);

                                                        //Get part number tracking and add update tracking
                                                        PartNumbersTracking partNumbersTracking = GetPartNumbersTrackingByIdOtItem(otItem, 23, connectionstring);

                                                        if (partNumbersTracking != null)
                                                        {
                                                            if (otItem.Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                                            {
                                                                partNumbersTracking.IdOperator = offer.ModifiedBy;
                                                                partNumbersTracking.EndDate = DateTime.Now;
                                                                partNumbersTracking.Paused = false;
                                                            }
                                                            else if (otItem.Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                            {
                                                                partNumbersTracking.IdOperator = null;
                                                                partNumbersTracking.EndDate = null;
                                                                partNumbersTracking.Paused = true;


                                                            }

                                                            UpdatePartNumbersTrackingByIdPartNumbersTracking(offer, partNumbersTracking, connectionstring);
                                                        }


                                                    }
                                                    transactionScope.Complete();
                                                }
                                                catch (Exception ex)
                                                {
                                                    if (Transaction.Current != null)
                                                        Transaction.Current.Rollback();

                                                    if (transactionScope != null)
                                                        transactionScope.Dispose();

                                                    throw;
                                                }
                                            }

                                            quot.Ots = new List<Ots>();
                                            quot.Ots.Add(ot);
                                            UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, quot, workbenchConnectionString, mailServer);

                                            if (otitems != null && otitems.Count > 0)
                                            {
                                                ApplicationManager applicationManager = new ApplicationManager();

                                                //This property is for AssignedEngAnalysis from dotproject.
                                                People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);

                                                // Send email when eng analysis is validated by 
                                                if (otitems[0].Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                                {
                                                    if (offer.EngineeringAnalysis != null)
                                                        applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                                    else
                                                        applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, ot.DeliveryDate);

                                                    LogEntryByOffer log = new LogEntryByOffer();
                                                    log.IdUser = offer.ModifiedBy;
                                                    log.DateTime = DateTime.Now;
                                                    log.Comments = "The analysis of engineering department has been completed.";
                                                    log.IdLogEntryType = 2;
                                                    offer.LogEntryByOffers.Add(log);
                                                }
                                                else if (otitems[0].Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                {
                                                    if (offer.EngineeringAnalysis != null)
                                                        applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                                    else
                                                        applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, ot.DeliveryDate);

                                                    LogEntryByOffer log = new LogEntryByOffer();
                                                    log.IdUser = offer.ModifiedBy;
                                                    log.DateTime = DateTime.Now;
                                                    log.Comments = "The analysis of engineering department has been re-opened.";
                                                    log.IdLogEntryType = 2;
                                                    offer.LogEntryByOffers.Add(log);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            else
                            {
                                //Int64 idQuotation = 0;
                                Quotation tempquotation = new Quotation();
                                tempquotation.Offer = new Offer();
                                tempquotation.Offer.IdOffer = offer.IdOffer;
                                tempquotation.Year = DateTime.Now.Year;
                                tempquotation.Number = offer.Number;
                                tempquotation.Code = offer.Code + quotation.Suffix;
                                tempquotation.CreatedIn = DateTime.Now;
                                tempquotation.Template = new Template();
                                tempquotation.Template = quotation;
                                if (quotation.IdTemplate != 0)
                                {
                                    // string quotationCode = offer.Code + quotation.Suffix;
                                    using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                    {
                                        conquotation.Open();
                                        using (MySqlTransaction trans = conquotation.BeginTransaction())
                                        {
                                            try
                                            {
                                                MySqlCommand conquotationcommand = new MySqlCommand("quotations_Insert", conquotation);
                                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                                conquotationcommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                                conquotationcommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                                conquotationcommand.Parameters.AddWithValue("_Number", offer.Number);
                                                conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                                conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                                conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                                conquotationcommand.Parameters.AddWithValue("_QuotQuantity", 0);
                                                conquotationcommand.Parameters.AddWithValue("_Description", offer.Description);
                                                conquotationcommand.Transaction = trans;
                                                idQuotation = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                if (idQuotation > 0)
                                                {
                                                    bool isinsert = false;
                                                    MySqlCommand conoffercommand = new MySqlCommand("revisions_GetrevisionsByIdQuotation", conquotation);
                                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                                    conoffercommand.Parameters.AddWithValue("_IdQuotation", idQuotation);

                                                    using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                                                    {
                                                        if (!offerreader.Read())
                                                        {
                                                            isinsert = true;
                                                        }
                                                    }

                                                    if (isinsert)
                                                    {
                                                        Revision r = new Revision();
                                                        r.NumRevision = 0;
                                                        //[001]
                                                        if (offer.ModifiedBy != null && offer.ModifiedBy == 164)
                                                        {
                                                            r.CreatedBy = 164;
                                                            r.ReviewedBy = 164;
                                                        }
                                                        else
                                                        {
                                                            r.CreatedBy = offer.ModifiedBy;
                                                            r.ReviewedBy = offer.ModifiedBy;
                                                        }
                                                        r.CreatedIn = DateTime.Now;
                                                        r.NumRevision = 0;
                                                        r.Discount = 0;
                                                        r.ExpireDate = DateTime.Now.AddDays(14);
                                                        r.Comments = offer.Contact + "\r\n" + offer.Description;
                                                        //r.Quotation = quotation;
                                                        if (quotation.IdTemplate == 15 || quotation.IdTemplate == 16 || quotation.IdTemplate == 18)
                                                            r.ApprovedIn = DateTime.Now;
                                                        else
                                                            r.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");

                                                        conquotationcommand = new MySqlCommand("revisions_Insert", conquotation);
                                                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                        conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                                                        conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r.ReviewedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_NumRevision", r.NumRevision);
                                                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_MadeBy", r.CreatedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                                        conquotationcommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                                        conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                                                        conquotationcommand.Parameters.AddWithValue("_CreationDate", r.CreatedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_Comments", r.Comments);
                                                        conquotationcommand.Parameters.AddWithValue("_Closed", r.ApprovedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Transaction = trans;
                                                        r.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                        tempquotation.Revisions = new List<Revision>();
                                                        tempquotation.Revisions.Add(r);
                                                    }
                                                }
                                                trans.Commit();
                                            }
                                            catch (Exception ex)
                                            {
                                                trans.Rollback();
                                                throw;
                                            }
                                        }
                                    }

                                    tempquotation.IdQuotation = idQuotation;

                                    ///////////////////////////////////////////////////////

                                    if (offer.IdOfferType != 10 && quotation.IdTemplate == 15) // || quotation.IdTemplate == 23))
                                    {
                                        List<OtItem> items = new List<OtItem>();

                                        List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                                        items.AddRange(temp);
                                        if (items.Count != 0)
                                            CreateQuotationWithItems(tempquotation, offer, items, connectionstring);
                                    }
                                    else if (offer.IdOfferType != 10 && quotation.IdTemplate == 23)
                                    {
                                        List<OtItem> items = new List<OtItem>();

                                        List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                                        items.AddRange(temp);
                                        if (items.Count != 0)
                                            CreateQuotationWithItems(tempquotation, offer, items, connectionstring);

                                        //link EPC for eng analysis. 
                                        if (!ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                            InsertEngAnalysisInDotProject_V2033(dotProjectConnectionString, connectionstring, mailServer, workbenchConnectionString, offer, tempquotation);
                                        else
                                            UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, tempquotation, workbenchConnectionString, mailServer);
                                        //GOM_v3.Properties.Settings.Default.Email_Delivery_Date_Changed

                                    }
                                }
                            }
                        }
                        else
                        {
                            //Update Quotation Codes when offer type is changed.
                            string quotationCode = offer.Code + quotation.Suffix;

                            Quotation quotationByOffer = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == quotation.IdTemplate);

                            if (quotation != null)
                                UpdateQuotationCodeIfTypeChanged(offer, quotationByOffer, quotation, connectionstring);

                            if (optionsByOffer.IdOption == 25) //Engineering analysis update code.
                            {
                                Quotation quot = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == 23);

                                if (quot != null)
                                {
                                    Ots ot = GetOTByQuotationId(quot, connectionstring);
                                    List<OtItem> otitems = null;

                                    if (ot != null)
                                    {
                                        otitems = GetOtItemsByIdOT(ot, connectionstring);

                                        using (var transactionScope = new TransactionScope())
                                        {
                                            try
                                            {
                                                UpdateOTByIdOT(offer, quot, ot, connectionstring);

                                                foreach (var otItem in otitems)
                                                {
                                                    UpdateOTitemByIdOtItem(offer, otItem, connectionstring);

                                                    //Get part number tracking and add update tracking
                                                    PartNumbersTracking partNumbersTracking = GetPartNumbersTrackingByIdOtItem(otItem, 23, connectionstring);

                                                    if (partNumbersTracking != null)
                                                    {
                                                        if (otItem.Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                                        {
                                                            partNumbersTracking.IdOperator = offer.ModifiedBy;
                                                            partNumbersTracking.EndDate = DateTime.Now;
                                                            partNumbersTracking.Paused = false;
                                                        }
                                                        else if (otItem.Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                        {
                                                            partNumbersTracking.IdOperator = null;
                                                            partNumbersTracking.EndDate = null;
                                                            partNumbersTracking.Paused = true;
                                                        }

                                                        UpdatePartNumbersTrackingByIdPartNumbersTracking(offer, partNumbersTracking, connectionstring);
                                                    }
                                                }

                                                transactionScope.Complete();
                                            }
                                            catch (Exception ex)
                                            {
                                                if (Transaction.Current != null)
                                                    Transaction.Current.Rollback();

                                                if (transactionScope != null)
                                                    transactionScope.Dispose();

                                                throw;
                                            }
                                        }
                                    }

                                    quot.Ots = new List<Ots>();
                                    quot.Ots.Add(ot);
                                    if (ot != null)
                                        UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, quotationByOffer, workbenchConnectionString, mailServer);

                                    if (otitems != null && otitems.Count > 0)
                                    {
                                        ApplicationManager applicationManager = new ApplicationManager();

                                        //This property is for AssignedEngAnalysis from dotproject.
                                        People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);

                                        // Send email when eng analysis is validated by 
                                        if (otitems[0].Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                        {
                                            if (offer.EngineeringAnalysis != null)
                                            {
                                                applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                            }
                                            else
                                            {
                                                applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, ot.DeliveryDate);
                                            }

                                            LogEntryByOffer log = new LogEntryByOffer();
                                            log.IdUser = offer.ModifiedBy;
                                            log.DateTime = DateTime.Now;
                                            log.Comments = "The analysis of engineering department has been completed.";
                                            log.IdLogEntryType = 2;
                                            offer.LogEntryByOffers.Add(log);
                                        }
                                        else if (otitems[0].Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                        {
                                            if (offer.EngineeringAnalysis != null)
                                            {
                                                applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                            }
                                            else
                                            {
                                                applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, ot.DeliveryDate);
                                            }

                                            LogEntryByOffer log = new LogEntryByOffer();
                                            log.IdUser = offer.ModifiedBy;
                                            log.DateTime = DateTime.Now;
                                            log.Comments = "The analysis of engineering department has been re-opened.";
                                            log.IdLogEntryType = 2;
                                            offer.LogEntryByOffers.Add(log);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                else
                {
                    if (optionsByOffer.IsSelected == false && optionsByOffer.Quantity == 0)
                    {
                        using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                        {
                            conquotation.Open();
                            using (MySqlTransaction trans = conquotation.BeginTransaction())
                            {
                                try
                                {
                                    //string sqlQuery = "DELETE FROM optionsbyoffer WHERE IdOffer = " + offer.IdOffer + " AND IdOption = " + optionsByOffer.IdOption + ";";
                                    MySqlCommand conquotationcommand = new MySqlCommand("optionsbyoffer_Delete", conquotation);
                                    conquotationcommand.CommandType = CommandType.StoredProcedure;
                                    conquotationcommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                    conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conquotationcommand.Transaction = trans;
                                    conquotationcommand.ExecuteNonQuery();

                                    if (optionsByOffer.IdOption == 25 && ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                        UpdateProjectStatusInDotProject(dotProjectConnectionString, offer, 7);

                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }

                        List<Template> unselectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                        Template unselectedOptionTemplate = GetDefaultArticleByIdOfferOption(optionsByOffer.IdOption, connectionstring);

                        if (unselectedOptionTemplate != null)
                            unselectedOptionTemplates.Add(unselectedOptionTemplate);

                        foreach (Template quotation in unselectedOptionTemplates)
                        {
                            if (!selectedOptionByOfferTemplates.Contains(quotation.IdTemplate))
                            {
                                using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                {
                                    conquotation.Open();
                                    using (MySqlTransaction trans = conquotation.BeginTransaction())
                                    {
                                        try
                                        {
                                            //string sqlQuery = "update quotations set IdOffer=null where IdDetectionsTemplate = " + quotation.IdTemplate + " AND IdOffer = " + offer.IdOffer + ";";
                                            MySqlCommand conquotationcommand = new MySqlCommand("quotations_UpdateByIdOfferANDTemplate", conquotation);
                                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                                            conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                            conquotationcommand.Transaction = trans;
                                            conquotationcommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }
                            }
                        }
                    }

                }
            }
        }


        public Offer AddOffer_V2033(Offer offer, string connectionString, string offerCodeConnectionString, Int32 idSite, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {

            Int64 offerId = 0;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
            {
                if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                    UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                else
                    offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
            }
            else
                UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);

            if (offerInsertedInGCM)
            {
                using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                {
                    conoffer.Open();
                    using (MySqlTransaction trans = conoffer.BeginTransaction())
                    {
                        try
                        {
                            // SP:- offers_Insert this sp is used till Sprint58
                            // MySqlCommand conoffercommand = new MySqlCommand("offers_Insert", conoffer);

                            // To Add RFQ changed SP:-offers_Insert_Sprint59 in Sprint59
                            MySqlCommand conoffercommand = new MySqlCommand("offers_Insert_Sprint59", conoffer);

                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                            conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                            conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                            conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                            conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                            conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                            conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                            conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                            conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                            conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                            conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                            conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                            conoffercommand.Parameters.AddWithValue("_CreatedBy", offer.CreatedBy);
                            conoffercommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                            conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                            conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                            conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                            conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                            conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                            conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                            conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                            conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                            conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                            conoffercommand.Transaction = trans;
                            offerId = Convert.ToInt64(conoffercommand.ExecuteScalar());
                            offer.IdOffer = offerId;
                            offer.Year = DateTime.Now.Year;

                            UpdateEngAnalysisStatus(dotProjectConnectionString, offer);

                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }

                    }
                }
            }
            if (offerInsertedInGCM && offer.IdOffer > 0)
            {
                AddQuotations_V2033(offer, offer.Site.ConnectPlantConstr, dotProjectConnectionString, mailServer, workbenchConnectionString);
                AddLogEntryByOffer(offer, offer.Site.ConnectPlantConstr, null);
                AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);

            }
            return offer;
        }


        public Offer AddOfferWithIdSourceOffer_V2033(Offer offer, string connectionString, string offerCodeConnectionString, Int32 idSite, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {
            Int64 offerId = 0;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
            {
                if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                    UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                else
                    offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
            }
            else
                UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);

            if (offerInsertedInGCM)
            {
                using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                {
                    conoffer.Open();
                    using (MySqlTransaction trans = conoffer.BeginTransaction())
                    {
                        try
                        {
                            //MySqlCommand conoffercommand = new MySqlCommand("offers_InsertWithIdSourceOffer", conoffer);
                            MySqlCommand conoffercommand = new MySqlCommand("offers_InsertWithIdSourceOffer_Sprint59", conoffer);
                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                            conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                            conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                            conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                            conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                            conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                            conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                            conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                            conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                            conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                            conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                            conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                            conoffercommand.Parameters.AddWithValue("_CreatedBy", offer.CreatedBy);
                            conoffercommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                            conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                            conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                            conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                            conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                            conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                            conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                            conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                            conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                            conoffercommand.Parameters.AddWithValue("_IdSourceOffer", offer.IdSourceOffer);
                            conoffercommand.Parameters.AddWithValue("_Rfq", offer.Rfq);
                            conoffercommand.Transaction = trans;
                            offerId = Convert.ToInt64(conoffercommand.ExecuteScalar());
                            offer.IdOffer = offerId;
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }

                    }
                }
            }
            if (offerInsertedInGCM && offer.IdOffer > 0)
            {

                AddQuotations_V2033(offer, offer.Site.ConnectPlantConstr, dotProjectConnectionString, mailServer, workbenchConnectionString);
                AddLogEntryByOffer(offer, offer.Site.ConnectPlantConstr, null);
                AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);

            }
            return offer;
        }


        public bool UpdateOffer_V2033(Offer offer, string connectionstring, string offerCodeConnectionString, Int32 idSite, Int32 idUser, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {
            bool isupdated = false;
            bool isupdatedLeadToOT = true;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            try
            {
                if (offer.IsUpdateLeadToOT)
                {
                    if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
                    {
                        if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                            UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                        else
                            offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
                    }
                    else
                        UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                }

                if (offerInsertedInGCM)
                {
                    MySqlDataAdapter daGCM;
                    DataTable dtGCM;

                    using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                    {
                        conoffer.Open();
                        string query = "select IdOffer from offers where Code= '" + offer.Code + "' and IdOffer =" + offer.IdOffer + " ;";

                        daGCM = new MySqlDataAdapter(query, conoffer);
                        dtGCM = new DataTable();
                        daGCM.Fill(dtGCM);

                        if (dtGCM.Rows.Count > 0)
                            isupdatedLeadToOT = false;
                    }
                    Int64? nullProductCategory = null;
                    if (offer.IdProductCategory > 0)
                    {
                        nullProductCategory = offer.IdProductCategory;
                    }
                    if (offer.IsUpdateLeadToOT)
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_LeadOTUpdate", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                    conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    trans.Commit();

                                    offer.Year = DateTime.Now.Year;
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                    else
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_Update", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                }

                if (isupdated)
                {
                    UpdateEngAnalysisStatus(dotProjectConnectionString, offer);

                    UpdateQuotation_V2033(offer, offer.Site.ConnectPlantConstr, dotProjectConnectionString, mailServer, workbenchConnectionString);

                    LostReasonsByOffer lostReasonsByOffer = UpdateLostReasonsByOffer(offer.LostReasonsByOffer, offer.Site.ConnectPlantConstr);
                    AddLogEntryByOffer(offer, connectionstring, offer.Site.ConnectPlantConstr);
                    AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);

                    if (offer.NewlyLinkedActivities != null && offer.NewlyLinkedActivities.Count > 0)
                    {
                        using (var transactionScope = new TransactionScope())
                        {
                            try
                            {
                                AddLinkExistingActivityToOffer_V2031(mainserverConnectionString, offer.NewlyLinkedActivities, offer.Site, offer.IdOffer);
                                transactionScope.Complete();
                            }
                            catch (Exception ex)
                            {
                                if (Transaction.Current != null)
                                    Transaction.Current.Rollback();

                                if (transactionScope != null)
                                    transactionScope.Dispose();

                                throw;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
                //isupdated = false;
            }

            return isupdated;
        }


        public bool UpdateOfferForParticularColumn_V2033(Offer offer, string connectionstring, string offerCodeConnectionString, Int32 idSite, Int32 idUser, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {
            bool isupdated = false;
            bool isupdatedLeadToOT = true;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            try
            {
                if (offer.IsUpdateLeadToOT)
                {
                    if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
                    {
                        if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                            UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                        else
                            offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
                    }
                    else
                        UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                }

                if (offerInsertedInGCM)
                {
                    MySqlDataAdapter daGCM;
                    DataTable dtGCM;

                    using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                    {
                        conoffer.Open();
                        string query = "select IdOffer from offers where Code= '" + offer.Code + "' and IdOffer =" + offer.IdOffer + " ;";

                        daGCM = new MySqlDataAdapter(query, conoffer);

                        dtGCM = new DataTable();
                        daGCM.Fill(dtGCM);

                        if (dtGCM.Rows.Count > 0)
                            isupdatedLeadToOT = false;

                    }

                    if (offer.IsUpdateLeadToOT)
                    {

                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_LeadOTUpdateParticularColumn", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    //conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                    conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    //conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    //conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    //conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                    else
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_UpdateParticularColumn", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    //conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    //conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    //conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    //conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    //conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);

                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                }

                if (isupdated)
                {
                    UpdateQuotation_V2033(offer, offer.Site.ConnectPlantConstr, dotProjectConnectionString, mailServer, workbenchConnectionString);

                    //LostReasonsByOffer lostReasonsByOffer = UpdateLostReasonsByOffer(offer.LostReasonsByOffer, offer.Site.ConnectPlantConstr);
                    AddLogEntryByOffer(offer, connectionstring, offer.Site.ConnectPlantConstr);
                    //AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);
                }

            }
            catch (Exception ex)
            {
                throw;
                //isupdated = false;
            }

            return isupdated;
        }

        public Company GetSiteCustomerDetails(string connectionstring, Int32 idSite)
        {

            Company company = new Company();

            using (MySqlConnection con = new MySqlConnection(connectionstring))
            {
                con.Open();

                MySqlCommand concommand = new MySqlCommand("CRM_GetSiteCustomerDetails", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdSite", idSite);
                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        if (reader["IdSite"] != DBNull.Value)
                        {
                            company.IdCompany = Convert.ToInt32(reader["IdSite"].ToString());
                            company.Name = Convert.ToString(reader["SiteName"].ToString());

                            if (reader["IdCustomer"] != DBNull.Value)
                            {
                                company.IdCustomer = Convert.ToInt32(reader["IdCustomer"].ToString());
                                company.Customer = new Customer();
                                company.Customer.IdCustomer = Convert.ToInt32(reader["IdCustomer"].ToString());
                                company.Customer.CustomerName = Convert.ToString(reader["Customer"].ToString());
                                if (reader["IdCustomerType"] != DBNull.Value)
                                    company.Customer.IdCustomerType = Convert.ToByte(reader["IdCustomerType"].ToString());

                            }

                            if (reader["ShortName"] != DBNull.Value)
                                company.ShortName = Convert.ToString(reader["ShortName"].ToString());

                            if (reader["IdCountry"] != DBNull.Value)
                            {
                                company.IdCountry = Convert.ToByte(reader["IdCountry"].ToString());
                            }
                        }

                    }
                }
            }

            return company;
        }

        public bool AddCustomerPlantInDotProject(string dotProjectConnectionString, Company company)
        {

            TransactionScope transactionScope = null;
            try
            {
                using (transactionScope = new TransactionScope())
                {
                    using (MySqlConnection mySqlConnection = new MySqlConnection(dotProjectConnectionString))
                    {
                        mySqlConnection.Open();

                        MySqlCommand mySqlCommand = new MySqlCommand("epc_InsertIntoCompaniesAndPlant", mySqlConnection);
                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                        mySqlCommand.Parameters.AddWithValue("_IdCompany", company.Customer.IdCustomer);
                        mySqlCommand.Parameters.AddWithValue("_CompanyName", company.Customer.CustomerName);
                        mySqlCommand.Parameters.AddWithValue("_CompanyDescription", company.Customer.CustomerName);
                        mySqlCommand.Parameters.AddWithValue("_CompanyType", company.Customer.IdCustomerType);
                        mySqlCommand.Parameters.AddWithValue("_PlantTown", company.Name);
                        mySqlCommand.Parameters.AddWithValue("_PlantShortName", company.ShortName);
                        mySqlCommand.Parameters.AddWithValue("_PlantId", company.IdCompany);
                        mySqlCommand.Parameters.AddWithValue("_CustomerId", company.IdCustomer);
                        mySqlCommand.Parameters.AddWithValue("_CountryId", company.IdCountry);


                        mySqlCommand.ExecuteNonQuery();
                        mySqlConnection.Close();
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception ex)
            {
                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScope != null)
                    transactionScope.Dispose();

                // throw;
            }

            return true;
        }


        public Offer GetOfferDetailsById_V2033(Int64 idOffer, Int32 idUser, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, Company company, string workingOrdersPath)
        {
            Offer offer = new Offer();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(company.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetOfferDetailsByIdDateWise_V2033", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_offerId", idOffer);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (offerreader.Read())
                    {
                        offer.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());

                        if (offerreader["IdSalesOwner"] != DBNull.Value)
                        {
                            offer.IdSalesOwner = Convert.ToInt32(offerreader["IdSalesOwner"].ToString());
                            offer.SalesOwner = new People { IdPerson = Convert.ToInt32(offerreader["IdSalesOwner"].ToString()), Name = offerreader["OfferSalesOwnerName"].ToString(), Surname = offerreader["OfferSalesOwnerSurName"].ToString(), Email = Convert.ToString(offerreader["OfferSalesOwnerEmail"]) };
                        }

                        offer.IdOfferType = Convert.ToByte(offerreader["idOfferType"].ToString());
                        offer.Code = offerreader["OfferCode"].ToString();
                        offer.Number = Convert.ToInt64(offerreader["number"].ToString());
                        offer.Year = Convert.ToInt64(offerreader["OfferYear"].ToString());
                        offer.IdCustomer = Convert.ToInt32(offerreader["IdSite"].ToString());
                        offer.IdStatus = Convert.ToByte(offerreader["IdStatus"].ToString());

                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToByte(offerreader["IdStatus"].ToString()), Name = offerreader["OfferStatus"].ToString() };

                        if (offerreader["IdSalesStatusType"] != DBNull.Value)
                        {
                            offer.GeosStatus.IdSalesStatusType = Convert.ToByte(offerreader["IdSalesStatusType"].ToString());

                            offer.GeosStatus.SalesStatusType = new SalesStatusType();
                            offer.GeosStatus.SalesStatusType.IdSalesStatusType = Convert.ToByte(offerreader["IdSalesStatusType"].ToString());
                            offer.GeosStatus.SalesStatusType.Name = offerreader["SalesStatus"].ToString();
                        }

                        offer.IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString());
                        offer.ModifiedBy = Convert.ToInt32(offerreader["ModifiedBy"].ToString());

                        if (offerreader["IdBusinessUnit"] != DBNull.Value)
                            offer.IdBusinessUnit = Convert.ToByte(offerreader["IdBusinessUnit"].ToString());

                        if (offerreader["IdSource"] != DBNull.Value)
                            offer.IdSource = Convert.ToByte(offerreader["IdSource"].ToString());

                        offer.Description = offerreader["OfferTitle"].ToString();
                        offer.Site = new Company() { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["SiteName"].ToString().Trim(), Country = new Country { Name = offerreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offerreader["CustomerZone"].ToString() } } };
                        offer.Site.ConnectPlantId = company.ConnectPlantId;
                        offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } };

                        if (offerreader["OfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["OfferAmount"].ToString());

                        if (offerreader["IdProject"] != DBNull.Value)
                            offer.IdProject = Convert.ToInt32(offerreader["IdProject"].ToString());

                        if (offerreader["IdCarProject"] != DBNull.Value)
                            offer.IdCarProject = Convert.ToInt32(offerreader["IdCarProject"].ToString());

                        if (offerreader["OfferConfidentialLevel"] != DBNull.Value)
                            offer.ProbabilityOfSuccess = Convert.ToSByte(offerreader["OfferConfidentialLevel"].ToString());

                        if (offerreader["OfferExpectedDate"] != DBNull.Value)
                            offer.OfferExpectedDate = Convert.ToDateTime(offerreader["OfferExpectedDate"].ToString());
                        else
                            offer.OfferExpectedDate = null;

                        if (offerreader["RFQReception"] != DBNull.Value)
                            offer.RFQReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        else
                            offer.RFQReception = null;

                        if (offerreader["sendIn"] != DBNull.Value)
                            offer.SendIn = Convert.ToDateTime(offerreader["sendIn"].ToString());
                        else
                            offer.SendIn = null;

                        if (offerreader["DeliveryDate"] != DBNull.Value)
                            offer.DeliveryDate = Convert.ToDateTime(offerreader["DeliveryDate"].ToString());
                        else
                            offer.DeliveryDate = null;

                        if (offerreader["otsDeliveryDate"] != DBNull.Value)
                            offer.OTSDeliveryDate = Convert.ToDateTime(offerreader["otsDeliveryDate"].ToString());
                        else
                            offer.OTSDeliveryDate = null;

                        if (offerreader["POReceivedInDate"] != DBNull.Value)
                            offer.POReceivedInDate = Convert.ToDateTime(offerreader["POReceivedInDate"].ToString());
                        else
                            offer.POReceivedInDate = null;

                        offer.Rfq = offerreader["Rfq"].ToString();
                        offer.Comments = offerreader["Comments"].ToString();
                        offer.Currency = new Currency { IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString()), Name = offerreader["CurrencyName"].ToString() };

                        if (offerreader["ModifiedIn"].ToString() == "01/01/1000 0:00:00")
                        {
                            offer.ModifiedIn = null;
                        }
                        else
                        {
                            offer.ModifiedIn = Convert.ToDateTime(offerreader["ModifiedIn"].ToString());
                        }

                        if (offerreader["CreatedIn"] != DBNull.Value)
                            offer.CreatedIn = Convert.ToDateTime(offerreader["CreatedIn"].ToString());

                        if (offerreader["IdCarOEM"] != DBNull.Value)
                            offer.IdCarOEM = Convert.ToInt32(offerreader["IdCarOEM"].ToString());

                        if (offerreader["OfferedBy"] != DBNull.Value)
                        {
                            offer.OfferedBy = Convert.ToInt32(offerreader["OfferedBy"]);
                            offer.OfferedByPerson = new People { IdPerson = Convert.ToInt32(offer.OfferedBy), Name = Convert.ToString(offerreader["OfferedByName"]), Surname = Convert.ToString(offerreader["OfferedBySurName"]), Email = Convert.ToString(offerreader["OfferedByEmail"]) };
                        }

                        if (offerreader["IsManualCategory"] != DBNull.Value)
                        {
                            offer.IsManualCategory = Convert.ToSByte(offerreader["IsManualCategory"]);
                        }

                        if (offerreader["IdProductCategory"] != DBNull.Value)
                        {
                            offer.IdProductCategory = Convert.ToInt64(offerreader["IdProductCategory"]);
                        }

                        if (offerreader["IdProductCategory"] != DBNull.Value)
                        {
                            offer.ProductCategory = new ProductCategory();

                            offer.ProductCategory.IdProductCategory = Convert.ToInt64(offerreader["IdProductCategory"]);
                            offer.ProductCategory.Name = offerreader["ProductSubCategory"].ToString();

                            if (offerreader["IdProductCategory"] != DBNull.Value)
                            {
                                offer.ProductCategory.Category = new ProductCategory();
                                if (offerreader["IdCategory"] != DBNull.Value)
                                    offer.ProductCategory.Category.IdProductCategory = Convert.ToInt64(offerreader["IdCategory"].ToString());
                                offer.ProductCategory.Category.Name = offerreader["ProductCategory"].ToString();
                            }
                        }

                        if (offerreader["AssignedTo"] != DBNull.Value)
                        {
                            offer.AssignedTo = Convert.ToInt32(offerreader["AssignedTo"]);
                            offer.AssignedToPerson = new People { IdPerson = Convert.ToInt32(offer.AssignedTo), Name = Convert.ToString(offerreader["AssignedName"]), Surname = Convert.ToString(offerreader["AssignedSurName"]), Email = Convert.ToString(offerreader["AssignedEmail"]) };
                        }

                        if (offerreader["OfferValue"] != DBNull.Value)
                            offer.OfferValue = Convert.ToDouble(offerreader["OfferValue"].ToString());

                        if (offerreader["IdOfferCurrency"] != DBNull.Value)
                            offer.IdOfferCurrency = Convert.ToByte(offerreader["IdOfferCurrency"].ToString());

                        if (offerreader["IsGoAheadProduction"] != DBNull.Value)
                            offer.IsGoAheadProduction = Convert.ToBoolean(offerreader["IsGoAheadProduction"]);

                        offer.OptionsByOffers = new List<OptionsByOffer>();
                        using (MySqlConnection conoptionsbyoffer = new MySqlConnection(company.ConnectPlantConstr))
                        {
                            conoptionsbyoffer.Open();
                            MySqlCommand conoptionsbyoffercommand = new MySqlCommand("optionsbyoffer_GetOptionsByOfferId", conoptionsbyoffer);
                            conoptionsbyoffercommand.CommandType = CommandType.StoredProcedure;
                            conoptionsbyoffercommand.Parameters.AddWithValue("_offerId", offer.IdOffer);
                            using (MySqlDataReader optionsbyofferreader = conoptionsbyoffercommand.ExecuteReader())
                            {
                                while (optionsbyofferreader.Read())
                                {

                                    OptionsByOffer optionsbyoffer = new OptionsByOffer();
                                    optionsbyoffer.IdOffer = Convert.ToInt64(optionsbyofferreader["IdOffer"].ToString());
                                    optionsbyoffer.IdOption = Convert.ToInt64(optionsbyofferreader["IdOption"].ToString());
                                    if (optionsbyofferreader["Quantity"] != DBNull.Value)
                                    {
                                        optionsbyoffer.Quantity = Convert.ToInt32(optionsbyofferreader["Quantity"].ToString());
                                        if (optionsbyoffer.Quantity > 0)
                                            optionsbyoffer.IsSelected = true;
                                        else
                                            optionsbyoffer.IsSelected = false;
                                    }
                                    else
                                    {
                                        optionsbyoffer.IsSelected = false;
                                    }
                                    optionsbyoffer.OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(optionsbyofferreader["IdOption"].ToString()), Name = optionsbyofferreader["offeroption"].ToString(), OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(optionsbyofferreader["IdOfferOptionType"].ToString()), Name = optionsbyofferreader["offeroptiontype"].ToString() } };

                                    if (offer.OptionsByOffers.Any(obo => obo.IdOffer == optionsbyoffer.IdOffer && obo.IdOption == optionsbyoffer.IdOption))
                                    {

                                    }
                                    else
                                    {
                                        offer.OptionsByOffers.Add(optionsbyoffer);
                                    }
                                }
                            }


                            if (offer.OptionsByOffers.Any(x => x.IdOption == 25))
                            {
                                List<Quotation> quotationByIdOffer = GetOfferQuotationByIdOffer(offer.IdOffer, company.ConnectPlantConstr).ToList();

                                Quotation quot = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == 23);

                                if (quot != null)
                                {
                                    EngineeringAnalysis engineeringAnalysis = new EngineeringAnalysis();
                                    Ots ot = GetOTByQuotationId(quot, company.ConnectPlantConstr);

                                    if (ot != null)
                                    {
                                        engineeringAnalysis.DueDate = ot.DeliveryDate.Value;

                                        List<OtItem> otitems = GetOtItemsByIdOT(ot, company.ConnectPlantConstr);
                                        if (otitems.Count > 0)
                                        {
                                            engineeringAnalysis.Comments = otitems[0].CustomerComment;

                                            //If Analysis status is shipped then iscompleted is true.
                                            if (otitems[0].Status.IdItemOtStatus == 10)
                                            {
                                                engineeringAnalysis.IsCompleted = true;
                                            }
                                        }
                                    }

                                    engineeringAnalysis.Attachments = new List<Attachment>();

                                    string path = workingOrdersPath + @"\" + offer.Year + @"\" + offer.Code + @"\01 Project Specifications\";
                                    if (Directory.Exists(path))
                                    {
                                        string[] files = Directory.GetFiles(path);

                                        foreach (string file in files)
                                        {
                                            Attachment attachment = new Attachment();
                                            attachment.OriginalFileName = Path.GetFileName(file);
                                            attachment.FilePath = Path.GetFullPath(file);
                                            engineeringAnalysis.Attachments.Add(attachment);
                                        }
                                    }

                                    offer.EngineeringAnalysis = engineeringAnalysis;
                                }
                            }
                        }

                        offer.OfferStatusTracking = new List<OfferStatusTracking>();
                        using (MySqlConnection conofferstatus = new MySqlConnection(company.ConnectPlantConstr))
                        {
                            conofferstatus.Open();
                            MySqlCommand conofferstatuscommand = new MySqlCommand("offerstatustracking_GetOfferStatusTrackingByIdOffer", conofferstatus);
                            conofferstatuscommand.CommandType = CommandType.StoredProcedure;
                            conofferstatuscommand.Parameters.AddWithValue("_idOffer", offer.IdOffer);
                            using (MySqlDataReader offerstatusreader = conofferstatuscommand.ExecuteReader())
                            {
                                while (offerstatusreader.Read())
                                {
                                    if (offer.OfferStatusTracking.Any(ofs => ofs.SalesStatusType.IdSalesStatusType == Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString())))
                                    {
                                        OfferStatusTracking offerStatusTrackingtemp = offer.OfferStatusTracking.Where(ofs => ofs.SalesStatusType.IdSalesStatusType == Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString())).FirstOrDefault();
                                        offerStatusTrackingtemp.IdOfferStatusTracking = Convert.ToInt64(offerstatusreader["IdOfferStatusTracking"].ToString());
                                        offerStatusTrackingtemp.IdOffer = Convert.ToInt64(offerstatusreader["IdOffer"].ToString());
                                        offerStatusTrackingtemp.IdOfferStatusType = Convert.ToInt64(offerstatusreader["IdOfferStatusType"].ToString());
                                        offerStatusTrackingtemp.SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString()), Name = offerstatusreader["Name"].ToString(), HtmlColor = offerstatusreader["HtmlColor"].ToString() };
                                        offerStatusTrackingtemp.StartDate = Convert.ToDateTime(offerstatusreader["StartDate"].ToString());

                                        if (offerstatusreader["EndDate"] != DBNull.Value)
                                        {
                                            offerStatusTrackingtemp.EndDate = offerstatusreader["EndDate"].ToString();
                                        }
                                        else
                                        {
                                            offerStatusTrackingtemp.EndDate = DateTime.Now.ToString();
                                        }

                                        try
                                        {
                                            offerStatusTrackingtemp.NoOfDays = offerStatusTrackingtemp.NoOfDays + (Convert.ToDateTime(Convert.ToDateTime(offerStatusTrackingtemp.EndDate).ToString("yyyy-MM-dd")) - Convert.ToDateTime(offerStatusTrackingtemp.StartDate.ToString("yyyy-MM-dd"))).TotalDays;
                                        }
                                        catch (Exception ex)
                                        {

                                        }
                                    }
                                    else
                                    {
                                        OfferStatusTracking offerStatusTracking = new OfferStatusTracking();
                                        offerStatusTracking.IdOfferStatusTracking = Convert.ToInt64(offerstatusreader["IdOfferStatusTracking"].ToString());
                                        offerStatusTracking.IdOffer = Convert.ToInt64(offerstatusreader["IdOffer"].ToString());
                                        offerStatusTracking.IdOfferStatusType = Convert.ToInt64(offerstatusreader["IdOfferStatusType"].ToString());
                                        offerStatusTracking.SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString()), Name = offerstatusreader["Name"].ToString(), HtmlColor = offerstatusreader["HtmlColor"].ToString() };
                                        offerStatusTracking.StartDate = Convert.ToDateTime(offerstatusreader["StartDate"].ToString());

                                        if (offerstatusreader["EndDate"] != DBNull.Value)
                                        {
                                            offerStatusTracking.EndDate = offerstatusreader["EndDate"].ToString();
                                        }
                                        else
                                        {
                                            offerStatusTracking.EndDate = DateTime.Now.ToString();
                                        }

                                        try
                                        {
                                            offerStatusTracking.NoOfDays = (Convert.ToDateTime(Convert.ToDateTime(offerStatusTracking.EndDate).ToString("yyyy-MM-dd")) - Convert.ToDateTime(offerStatusTracking.StartDate.ToString("yyyy-MM-dd"))).TotalDays;
                                        }
                                        catch (Exception ex)
                                        {

                                        }

                                        offer.OfferStatusTracking.Add(offerStatusTracking);
                                    }
                                }
                            }
                        }
                    }
                }
            }


            return offer;
        }


        public List<TimelineGrid> GetTimelineGridDetails_V2033(TimelineParams timelineParams)
        {
            List<TimelineGrid> timelineGridRows = new List<TimelineGrid>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(timelineParams.connectSiteDetailParams.ConnectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetRestfulTimelineData_V2033", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.CommandTimeout = 3000;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", timelineParams.idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", timelineParams.accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", timelineParams.accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", (timelineParams.Roles == RoleType.SalesAssistant) ? 20 : 22);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idEmdepSite", timelineParams.connectSiteDetailParams.idSite);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);


                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid offer = new TimelineGrid();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            if (itemRow["IdSite"] != DBNull.Value)
                            {
                                offer.IdSite = Convert.ToInt32(itemRow["IdSite"].ToString());
                            }

                            if (itemRow["IdOfferType"] != DBNull.Value)
                                offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());

                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.ConnectPlantId = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            offer.Group = itemRow["CustomerGroup"].ToString();
                            offer.Plant = itemRow["SiteName"].ToString().Trim();
                            offer.Country = itemRow["CustomerCountry"].ToString();
                            offer.Region = itemRow["CustomerZone"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                                offer.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                                offer.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());

                            offer.Status = itemRow["OfferStatus"].ToString();
                            offer.HtmlColor = itemRow["OfferStatusColor"].ToString();

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Amount = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            if (itemRow["IdSalesStatusType"] != DBNull.Value)
                                offer.IdSalesStatusType = Convert.ToInt32(itemRow["IdSalesStatusType"].ToString());

                            //  offer.Currency = itemRow["OfferCurrency"].ToString();
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.OfferConfidentialLevel = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                                offer.OfferCloseDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.OfferCloseDate = null;

                            if (itemRow["Rfq"] != DBNull.Value)
                                offer.Rfq = itemRow["Rfq"].ToString();

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RfqReceptionDate = Convert.ToDateTime(itemRow["RFQReception"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.RfqReceptionDate = null;

                            if (itemRow["OfferStatusid"] != DBNull.Value)
                                offer.OfferStatusid = Convert.ToInt32(itemRow["OfferStatusid"].ToString());

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.QuoteSentDate = Convert.ToDateTime(itemRow["SendIn"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.QuoteSentDate = null;


                            offer.Project = itemRow["CarProjectName"].ToString();
                            offer.Source = itemRow["Source"].ToString();
                            offer.BusinessUnit = itemRow["BusinessUnit"].ToString();
                            offer.Oem = itemRow["CarOEM"].ToString();

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                offer.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory = new ProductCategoryGrid();

                            }

                            if (itemRow["IdPOType"] != DBNull.Value)
                            {
                                offer.IdPOType = Convert.ToInt64(itemRow["IdPOType"].ToString());
                            }

                            offer.OptionsByOffers = new List<OptionsByOfferGrid>();
                            timelineGridRows.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            OptionsByOfferGrid optionsByOfferGrid = new OptionsByOfferGrid();
                            optionsByOfferGrid.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsByOfferGrid.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsByOfferGrid.IdOfferPlant = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsByOfferGrid.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsByOfferGrid.Quantity > 0)
                                    optionsByOfferGrid.IsSelected = true;
                                else
                                    optionsByOfferGrid.IsSelected = false;
                            }
                            else
                            {
                                optionsByOfferGrid.IsSelected = false;
                            }
                            optionsByOfferGrid.OfferOption = itemRow["offeroption"].ToString();

                            timelineGridRow.OptionsByOffers.Add(optionsByOfferGrid);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            timelineGridRow.LostCompetitor = itemRow["Name"].ToString();
                            timelineGridRow.LostDescription = itemRow["Comments"].ToString();
                            timelineGridRow.LostReason = itemRow["Reason"].ToString();

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {
                                    if (itemRow["CommentLastUpdate"] != DBNull.Value)
                                    {
                                        timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["CommentLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                    }
                                }
                            }

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {

                                    if (itemRow["ActivityLastUpdate"] != DBNull.Value)
                                    {
                                        if (timelineGridRow.LastActivityDate == null)
                                        {
                                            timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                        else
                                        {
                                            int result = Nullable.Compare<DateTime>(Convert.ToDateTime(itemRow["ActivityLastUpdate"]), Convert.ToDateTime(timelineGridRow.LastActivityDate));
                                            if (result > 0)
                                                timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                    }

                                    //if (timelineGridRow.LastActivityDate == null)
                                    //{
                                    //    timelineGridRow.LastActivityDate =Convert.ToDateTime(timelineGridRow.QuoteSentDate).ToString("dd/MM/yyyy"); 
                                    //}
                                }
                            }

                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString()), Name = itemRow["ProductSubCategory"].ToString() }; });

                                if (itemRow["IdCategory"] != DBNull.Value)
                                {
                                    timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory.IdParent = Convert.ToInt64(itemRow["IdCategory"].ToString()); u.ProductCategory.Category = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdCategory"].ToString()), Name = itemRow["Category"].ToString() }; });
                                }
                            }




                        }
                    }
                }
            }

            return timelineGridRows;
        }


        public List<TimelineGrid> GetSelectedUsersTimelineGridDetails_V2033(TimelineParams timelineParams)
        {
            List<TimelineGrid> timelineGridRows = new List<TimelineGrid>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(timelineParams.connectSiteDetailParams.ConnectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetRestfulTimelineData_V2033", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.CommandTimeout = 3000;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", timelineParams.idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", timelineParams.idsSelectedUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", timelineParams.accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", timelineParams.accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idEmdepSite", timelineParams.connectSiteDetailParams.idSite);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 21);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);

                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid offer = new TimelineGrid();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            if (itemRow["IdSite"] != DBNull.Value)
                            {
                                offer.IdSite = Convert.ToInt32(itemRow["IdSite"].ToString());
                            }

                            if (itemRow["IdOfferType"] != DBNull.Value)
                                offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());

                            if (itemRow["OfferStatusid"] != DBNull.Value)
                                offer.OfferStatusid = Convert.ToInt32(itemRow["OfferStatusid"].ToString());

                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.ConnectPlantId = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            offer.Group = itemRow["CustomerGroup"].ToString();
                            offer.Plant = itemRow["SiteName"].ToString();
                            offer.Country = itemRow["CustomerCountry"].ToString();
                            offer.Region = itemRow["CustomerZone"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                                offer.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                                offer.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());

                            offer.Status = itemRow["OfferStatus"].ToString();
                            offer.HtmlColor = itemRow["OfferStatusColor"].ToString();

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Amount = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            if (itemRow["IdSalesStatusType"] != DBNull.Value)
                                offer.IdSalesStatusType = Convert.ToInt32(itemRow["IdSalesStatusType"].ToString());

                            //  offer.Currency = itemRow["OfferCurrency"].ToString();
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.OfferConfidentialLevel = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                                offer.OfferCloseDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.OfferCloseDate = null;

                            if (itemRow["Rfq"] != DBNull.Value)
                                offer.Rfq = itemRow["Rfq"].ToString();

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RfqReceptionDate = Convert.ToDateTime(itemRow["RFQReception"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.RfqReceptionDate = null;

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.QuoteSentDate = Convert.ToDateTime(itemRow["SendIn"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.QuoteSentDate = null;

                            offer.Project = itemRow["CarProjectName"].ToString();
                            offer.Source = itemRow["Source"].ToString();
                            offer.BusinessUnit = itemRow["BusinessUnit"].ToString();
                            offer.Oem = itemRow["CarOEM"].ToString();

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                offer.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory = new ProductCategoryGrid();

                            }

                            if (itemRow["IdPOType"] != DBNull.Value)
                            {
                                offer.IdPOType = Convert.ToInt64(itemRow["IdPOType"].ToString());
                            }

                            offer.OptionsByOffers = new List<OptionsByOfferGrid>();
                            timelineGridRows.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            OptionsByOfferGrid optionsByOfferGrid = new OptionsByOfferGrid();
                            optionsByOfferGrid.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsByOfferGrid.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsByOfferGrid.IdOfferPlant = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsByOfferGrid.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsByOfferGrid.Quantity > 0)
                                    optionsByOfferGrid.IsSelected = true;
                                else
                                    optionsByOfferGrid.IsSelected = false;
                            }
                            else
                            {
                                optionsByOfferGrid.IsSelected = false;
                            }
                            optionsByOfferGrid.OfferOption = itemRow["offeroption"].ToString();

                            timelineGridRow.OptionsByOffers.Add(optionsByOfferGrid);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            timelineGridRow.LostCompetitor = itemRow["Name"].ToString();
                            timelineGridRow.LostDescription = itemRow["Comments"].ToString();
                            timelineGridRow.LostReason = itemRow["Reason"].ToString();

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {
                                    if (itemRow["CommentLastUpdate"] != DBNull.Value)
                                    {
                                        timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["CommentLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                    }
                                }
                            }

                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {

                                    if (itemRow["ActivityLastUpdate"] != DBNull.Value)
                                    {
                                        if (timelineGridRow.LastActivityDate == null)
                                        {
                                            timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                        else
                                        {
                                            int result = Nullable.Compare<DateTime>(Convert.ToDateTime(itemRow["ActivityLastUpdate"]), Convert.ToDateTime(timelineGridRow.LastActivityDate));
                                            if (result > 0)
                                                timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                    }

                                }
                            }

                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString()), Name = itemRow["ProductSubCategory"].ToString() }; });

                                if (itemRow["IdCategory"] != DBNull.Value)
                                {
                                    timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory.IdParent = Convert.ToInt64(itemRow["IdCategory"].ToString()); u.ProductCategory.Category = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdCategory"].ToString()), Name = itemRow["Category"].ToString() }; });
                                }
                            }

                        }
                    }
                }
            }

            return timelineGridRows;
        }

        public Offer AddQuotations_V2034(Offer offer, string connectionstring, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString, string WorkingOrdersPath)
        {
            try
            {
                foreach (OptionsByOffer optionsByOffer in offer.OptionsByOffers)
                {
                    List<Template> selectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                    Template selectedOptiontemplate = GetDefaultArticleByIdOfferOption(optionsByOffer.IdOption, connectionstring);
                    if (selectedOptiontemplate != null)
                        selectedOptionTemplates.Add(selectedOptiontemplate);

                    using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                    {
                        conquotation.Open();

                        using (MySqlTransaction trans = conquotation.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand conquotationcommand = new MySqlCommand("optionsbyoffer_Insert", conquotation);
                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                conquotationcommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                conquotationcommand.Parameters.AddWithValue("_Quantity", optionsByOffer.Quantity);
                                conquotationcommand.Transaction = trans;
                                conquotationcommand.ExecuteNonQuery();

                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }

                    foreach (Template quotation in selectedOptionTemplates)
                    {
                        Int64 idQuotation = 0;
                        Quotation tempquotation = new Quotation();
                        tempquotation.Offer = new Offer();
                        tempquotation.Offer.IdOffer = offer.IdOffer;
                        tempquotation.Year = DateTime.Now.Year;
                        tempquotation.Number = offer.Number;
                        tempquotation.Code = offer.Code + quotation.Suffix;
                        tempquotation.CreatedIn = DateTime.Now;
                        tempquotation.Template = new Template();
                        tempquotation.Template = quotation;

                        if (quotation.IdTemplate != 0)
                        {
                            string quotationCode = offer.Code + quotation.Suffix;
                            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                            {
                                conquotation.Open();
                                using (MySqlTransaction trans = conquotation.BeginTransaction())
                                {
                                    try
                                    {
                                        MySqlCommand conquotationcommand = new MySqlCommand("quotations_Insert", conquotation);
                                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                                        conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                        conquotationcommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                        conquotationcommand.Parameters.AddWithValue("_Description", offer.Description);
                                        conquotationcommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                        conquotationcommand.Parameters.AddWithValue("_Number", offer.Number);
                                        conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                        conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                        conquotationcommand.Parameters.AddWithValue("_QuotQuantity", 0);
                                        conquotationcommand.Transaction = trans;
                                        idQuotation = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                                        if (idQuotation > 0)
                                        {
                                            bool isinsert = false;
                                            MySqlCommand conoffercommand = new MySqlCommand("revisions_GetrevisionsByIdQuotation", conquotation);
                                            conoffercommand.CommandType = CommandType.StoredProcedure;
                                            conoffercommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                            using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                                            {
                                                if (!offerreader.Read())
                                                {
                                                    isinsert = true;
                                                }
                                            }

                                            if (isinsert)
                                            {
                                                Revision r = new Revision();
                                                r.NumRevision = 0;
                                                //[001]
                                                if (offer.CreatedBy != null && offer.CreatedBy == 164)
                                                {
                                                    r.CreatedBy = 164;
                                                    r.ReviewedBy = 164;
                                                }
                                                else
                                                {
                                                    r.CreatedBy = offer.CreatedBy;
                                                    r.ReviewedBy = offer.CreatedBy;
                                                }
                                                r.CreatedIn = DateTime.Now;
                                                r.NumRevision = 0;
                                                r.Discount = 0;
                                                r.ExpireDate = DateTime.Now.AddDays(14);
                                                r.Comments = offer.Contact + "\r\n" + offer.Description;
                                                //r.Quotation = quotation;
                                                if (quotation.IdTemplate == 15 || quotation.IdTemplate == 16 || quotation.IdTemplate == 18)
                                                    r.ApprovedIn = DateTime.Now;
                                                else
                                                    r.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");

                                                conquotationcommand = new MySqlCommand("revisions_Insert", conquotation);
                                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                                                conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r.ReviewedBy);
                                                conquotationcommand.Parameters.AddWithValue("_NumRevision", r.NumRevision);
                                                conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.CreatedBy);
                                                conquotationcommand.Parameters.AddWithValue("_MadeBy", r.CreatedBy);
                                                conquotationcommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                                conquotationcommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                                conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                                                conquotationcommand.Parameters.AddWithValue("_CreationDate", r.CreatedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_Comments", r.Comments);
                                                conquotationcommand.Parameters.AddWithValue("_Closed", r.ApprovedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Transaction = trans;
                                                r.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                tempquotation.Revisions = new List<Revision>();
                                                tempquotation.Revisions.Add(r);

                                            }
                                        }

                                        trans.Commit();
                                    }
                                    catch (Exception ex)
                                    {
                                        trans.Rollback();
                                        throw;
                                    }
                                }
                            }
                        }

                        tempquotation.IdQuotation = idQuotation;
                        ///////////////////////////////////////////////////////
                        if (offer.IdOfferType != 10 && quotation.IdTemplate == 15)
                        {
                            List<OtItem> items = new List<OtItem>();

                            List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                            items.AddRange(temp);

                            if (items.Count != 0)
                                CreateQuotationWithItems(tempquotation, offer, items, connectionstring);
                        }
                        else if (offer.IdOfferType != 10 && quotation.IdTemplate == 23)
                        {
                            List<OtItem> items = new List<OtItem>();

                            List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                            items.AddRange(temp);
                            if (items.Count != 0)
                                CreateQuotationWithItems(tempquotation, offer, items, connectionstring);

                            //link EPC for eng analysis. 
                            if (!ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                InsertEngAnalysisInDotProject_V2033(dotProjectConnectionString, connectionstring, mailServer, workbenchConnectionString, offer, tempquotation);
                            else
                                UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, tempquotation, workbenchConnectionString, mailServer);

                            if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.IsCompleted &&
                                tempquotation != null && tempquotation.Ots != null && tempquotation.Ots.Count > 0
                                && tempquotation.Ots[0].Items != null && tempquotation.Ots[0].Items.Count > 0)
                            {
                                ApplicationManager app = new ApplicationManager();

                                //This property is for AssignedEngAnalysis from dotproject.
                                People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);
                                app.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.CreatedByUser, assignedEngAnalysisPerson, tempquotation.Ots[0].DeliveryDate);

                                LogEntryByOffer log = new LogEntryByOffer();
                                log.IdUser = offer.CreatedBy;
                                log.DateTime = DateTime.Now;
                                log.Comments = "The analysis of engineering department has been completed.";
                                log.IdLogEntryType = 2;
                                offer.LogEntryByOffers.Add(log);
                            }

                        }
                    }


                }




            }
            catch (Exception ex)
            {
                throw;
            }
            return offer;
        }



        private Offer UpdateQuotation_V2034(Offer offer, string connectionstring, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString, string WorkingOrdersPath)
        {
            List<Quotation> quotationByIdOffer = GetOfferQuotationByIdOffer(offer.IdOffer, connectionstring).ToList();
            List<byte> quotIdDetectionsTemplates = quotationByIdOffer.Select(fg => fg.IdDetectionsTemplate).ToList();

            //List<byte> quotIdDetectionsTemplates = GetOfferQuotationByIdOffer(offer.IdOffer, connectionstring).ToList().Select(fg => fg.IdDetectionsTemplate).ToList();

            List<byte> selectedOptionByOfferTemplates = GetTemplatesBySelectedOptionsByOffer(connectionstring, offer.OptionsByOffers.Where(op => op.IsSelected == true).ToList());


            foreach (OptionsByOffer optionsByOffer in offer.OptionsByOffers)
            {
                if (optionsByOffer.IsSelected == true && optionsByOffer.Quantity > 0)
                {
                    List<Template> selectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                    Template selectedOptiontemplate = GetDefaultArticleByIdOfferOption_V2034(optionsByOffer.IdOption, connectionstring);
                    if (selectedOptiontemplate != null)
                        selectedOptionTemplates.Add(selectedOptiontemplate);

                    using (MySqlConnection conoption = new MySqlConnection(connectionstring))
                    {
                        conoption.Open();
                        using (MySqlTransaction trans = conoption.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand conoptioncommand = new MySqlCommand("optionsbyoffer_Update", conoption);
                                conoptioncommand.CommandType = CommandType.StoredProcedure;
                                conoptioncommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                conoptioncommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                conoptioncommand.Parameters.AddWithValue("_Quantity", optionsByOffer.Quantity);
                                conoptioncommand.Transaction = trans;
                                conoptioncommand.ExecuteNonQuery();
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }


                    foreach (Template quotation in selectedOptionTemplates)
                    {
                        if (!quotIdDetectionsTemplates.Contains(quotation.IdTemplate))
                        {
                            bool isUpdate = false;
                            string quotationCode = offer.Code + quotation.Suffix;
                            Int64 idQuotation = 0;

                            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                            {
                                conquotation.Open();
                                MySqlCommand conquotationcommand = new MySqlCommand("quotations_GetquotationsByCode", conquotation);
                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                using (MySqlDataReader reader = conquotationcommand.ExecuteReader())
                                {
                                    if (reader.Read())
                                    {
                                        isUpdate = true;

                                        if (reader["IdQuotation"] != DBNull.Value)
                                        {
                                            idQuotation = Convert.ToInt64(reader["IdQuotation"]);
                                        }
                                    }
                                }
                            }

                            if (isUpdate)
                            {
                                using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                {
                                    conquotation.Open();
                                    using (MySqlTransaction trans = conquotation.BeginTransaction())
                                    {
                                        try
                                        {
                                            // string sqlQuery = "update quotations set IdOffer=" + offer.IdOffer + " where IdDetectionsTemplate = " + quotation.IdTemplate + " AND Code = '" + quotationCode + "';";
                                            MySqlCommand conquotationcommand = new MySqlCommand("quotations_UpdateByCode", conquotation);
                                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                                            conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                            conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                            conquotationcommand.Transaction = trans;
                                            conquotationcommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }

                                //Engineering analysis update code. Comment and date when added from unlinked to linked.
                                if (optionsByOffer.IdOption == 25)
                                {
                                    Quotation quot = new Quotation();
                                    quot.IdQuotation = idQuotation;

                                    if (quot != null)
                                    {
                                        Ots ot = GetOTByQuotationId(quot, connectionstring);
                                        List<OtItem> otitems = null;

                                        if (ot != null)
                                        {
                                            otitems = GetOtItemsByIdOT(ot, connectionstring);

                                            using (var transactionScope = new TransactionScope())
                                            {
                                                try
                                                {
                                                    UpdateOTByIdOT(offer, quot, ot, connectionstring);

                                                    foreach (var otItem in otitems)
                                                    {
                                                        UpdateOTitemByIdOtItem(offer, otItem, connectionstring);

                                                        //Get part number tracking and add update tracking
                                                        PartNumbersTracking partNumbersTracking = GetPartNumbersTrackingByIdOtItem(otItem, 23, connectionstring);

                                                        if (partNumbersTracking != null)
                                                        {
                                                            if (otItem.Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                                            {
                                                                partNumbersTracking.IdOperator = offer.ModifiedBy;
                                                                partNumbersTracking.EndDate = DateTime.Now;
                                                                partNumbersTracking.Paused = false;
                                                            }
                                                            else if (otItem.Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                            {
                                                                partNumbersTracking.IdOperator = null;
                                                                partNumbersTracking.EndDate = null;
                                                                partNumbersTracking.Paused = true;


                                                            }

                                                            UpdatePartNumbersTrackingByIdPartNumbersTracking(offer, partNumbersTracking, connectionstring);
                                                        }


                                                    }
                                                    transactionScope.Complete();
                                                }
                                                catch (Exception ex)
                                                {
                                                    if (Transaction.Current != null)
                                                        Transaction.Current.Rollback();

                                                    if (transactionScope != null)
                                                        transactionScope.Dispose();

                                                    throw;
                                                }
                                            }

                                            quot.Ots = new List<Ots>();
                                            quot.Ots.Add(ot);
                                            UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, quot, workbenchConnectionString, mailServer);

                                            if (otitems != null && otitems.Count > 0)
                                            {
                                                ApplicationManager applicationManager = new ApplicationManager();

                                                //This property is for AssignedEngAnalysis from dotproject.
                                                People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);

                                                // Send email when eng analysis is validated by 
                                                if (otitems[0].Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                                {
                                                    if (offer.EngineeringAnalysis != null)
                                                        applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                                    else
                                                        applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, ot.DeliveryDate);

                                                    LogEntryByOffer log = new LogEntryByOffer();
                                                    log.IdUser = offer.ModifiedBy;
                                                    log.DateTime = DateTime.Now;
                                                    log.Comments = "The analysis of engineering department has been completed.";
                                                    log.IdLogEntryType = 2;
                                                    offer.LogEntryByOffers.Add(log);
                                                }
                                                else if (otitems[0].Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                {
                                                    if (offer.EngineeringAnalysis != null)
                                                        applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                                    else
                                                        applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, ot.DeliveryDate);

                                                    LogEntryByOffer log = new LogEntryByOffer();
                                                    log.IdUser = offer.ModifiedBy;
                                                    log.DateTime = DateTime.Now;
                                                    log.Comments = "The analysis of engineering department has been re-opened.";
                                                    log.IdLogEntryType = 2;
                                                    offer.LogEntryByOffers.Add(log);
                                                }
                                            }
                                        }
                                    }


                                }
                            }
                            else
                            {
                                //Int64 idQuotation = 0;
                                Quotation tempquotation = new Quotation();
                                tempquotation.Offer = new Offer();
                                tempquotation.Offer.IdOffer = offer.IdOffer;
                                tempquotation.Year = DateTime.Now.Year;
                                tempquotation.Number = offer.Number;
                                tempquotation.Code = offer.Code + quotation.Suffix;
                                tempquotation.CreatedIn = DateTime.Now;
                                tempquotation.Template = new Template();
                                tempquotation.Template = quotation;
                                if (quotation.IdTemplate != 0)
                                {
                                    // string quotationCode = offer.Code + quotation.Suffix;
                                    using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                    {
                                        conquotation.Open();
                                        using (MySqlTransaction trans = conquotation.BeginTransaction())
                                        {
                                            try
                                            {
                                                MySqlCommand conquotationcommand = new MySqlCommand("quotations_Insert", conquotation);
                                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                                conquotationcommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                                conquotationcommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                                conquotationcommand.Parameters.AddWithValue("_Number", offer.Number);
                                                conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                                conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                                conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                                conquotationcommand.Parameters.AddWithValue("_QuotQuantity", 0);
                                                conquotationcommand.Parameters.AddWithValue("_Description", offer.Description);
                                                conquotationcommand.Transaction = trans;
                                                idQuotation = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                if (idQuotation > 0)
                                                {
                                                    bool isinsert = false;
                                                    MySqlCommand conoffercommand = new MySqlCommand("revisions_GetrevisionsByIdQuotation", conquotation);
                                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                                    conoffercommand.Parameters.AddWithValue("_IdQuotation", idQuotation);

                                                    using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                                                    {
                                                        if (!offerreader.Read())
                                                        {
                                                            isinsert = true;
                                                        }
                                                    }

                                                    if (isinsert)
                                                    {
                                                        Revision r = new Revision();
                                                        r.NumRevision = 0;
                                                        //[001]
                                                        if (offer.ModifiedBy != null && offer.ModifiedBy == 164)
                                                        {
                                                            r.CreatedBy = 164;
                                                            r.ReviewedBy = 164;
                                                        }
                                                        else
                                                        {
                                                            r.CreatedBy = offer.ModifiedBy;
                                                            r.ReviewedBy = offer.ModifiedBy;
                                                        }
                                                        r.CreatedIn = DateTime.Now;
                                                        r.NumRevision = 0;
                                                        r.Discount = 0;
                                                        r.ExpireDate = DateTime.Now.AddDays(14);
                                                        r.Comments = offer.Contact + "\r\n" + offer.Description;
                                                        //r.Quotation = quotation;
                                                        if (quotation.IdTemplate == 15 || quotation.IdTemplate == 16 || quotation.IdTemplate == 18)
                                                            r.ApprovedIn = DateTime.Now;
                                                        else
                                                            r.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");

                                                        conquotationcommand = new MySqlCommand("revisions_Insert", conquotation);
                                                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                        conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                                                        conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r.ReviewedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_NumRevision", r.NumRevision);
                                                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_MadeBy", r.CreatedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                                        conquotationcommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                                        conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                                                        conquotationcommand.Parameters.AddWithValue("_CreationDate", r.CreatedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_Comments", r.Comments);
                                                        conquotationcommand.Parameters.AddWithValue("_Closed", r.ApprovedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Transaction = trans;
                                                        r.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                        tempquotation.Revisions = new List<Revision>();
                                                        tempquotation.Revisions.Add(r);
                                                    }
                                                }
                                                trans.Commit();
                                            }
                                            catch (Exception ex)
                                            {
                                                trans.Rollback();
                                                throw;
                                            }
                                        }
                                    }

                                    tempquotation.IdQuotation = idQuotation;

                                    ///////////////////////////////////////////////////////

                                    if (offer.IdOfferType != 10 && quotation.IdTemplate == 15) // || quotation.IdTemplate == 23))
                                    {
                                        List<OtItem> items = new List<OtItem>();

                                        List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                                        items.AddRange(temp);
                                        if (items.Count != 0)
                                            CreateQuotationWithItems(tempquotation, offer, items, connectionstring);
                                    }
                                    else if (offer.IdOfferType != 10 && quotation.IdTemplate == 23)
                                    {
                                        List<OtItem> items = new List<OtItem>();

                                        List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                                        items.AddRange(temp);
                                        if (items.Count != 0)
                                            CreateQuotationWithItems(tempquotation, offer, items, connectionstring);

                                        //link EPC for eng analysis. 
                                        if (!ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                            InsertEngAnalysisInDotProject_V2033(dotProjectConnectionString, connectionstring, mailServer, workbenchConnectionString, offer, tempquotation);
                                        else
                                            UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, tempquotation, workbenchConnectionString, mailServer);
                                        //GOM_v3.Properties.Settings.Default.Email_Delivery_Date_Changed


                                    }
                                }
                            }
                        }
                        else
                        {
                            //Update Quotation Codes when offer type is changed.
                            string quotationCode = offer.Code + quotation.Suffix;

                            Quotation quotationByOffer = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == quotation.IdTemplate);

                            if (quotation != null)
                                UpdateQuotationCodeIfTypeChanged(offer, quotationByOffer, quotation, connectionstring);

                            if (optionsByOffer.IdOption == 25) //Engineering analysis update code.
                            {
                                Quotation quot = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == 23);

                                if (quot != null)
                                {
                                    Ots ot = GetOTByQuotationId(quot, connectionstring);
                                    List<OtItem> otitems = null;

                                    if (ot != null)
                                    {
                                        otitems = GetOtItemsByIdOT(ot, connectionstring);

                                        using (var transactionScope = new TransactionScope())
                                        {
                                            try
                                            {
                                                UpdateOTByIdOT(offer, quot, ot, connectionstring);

                                                foreach (var otItem in otitems)
                                                {
                                                    UpdateOTitemByIdOtItem(offer, otItem, connectionstring);

                                                    //Get part number tracking and add update tracking
                                                    PartNumbersTracking partNumbersTracking = GetPartNumbersTrackingByIdOtItem(otItem, 23, connectionstring);

                                                    if (partNumbersTracking != null)
                                                    {
                                                        if (otItem.Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                                        {
                                                            partNumbersTracking.IdOperator = offer.ModifiedBy;
                                                            partNumbersTracking.EndDate = DateTime.Now;
                                                            partNumbersTracking.Paused = false;
                                                        }
                                                        else if (otItem.Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                        {
                                                            partNumbersTracking.IdOperator = null;
                                                            partNumbersTracking.EndDate = null;
                                                            partNumbersTracking.Paused = true;
                                                        }

                                                        UpdatePartNumbersTrackingByIdPartNumbersTracking(offer, partNumbersTracking, connectionstring);
                                                    }
                                                }

                                                transactionScope.Complete();
                                            }
                                            catch (Exception ex)
                                            {
                                                if (Transaction.Current != null)
                                                    Transaction.Current.Rollback();

                                                if (transactionScope != null)
                                                    transactionScope.Dispose();

                                                throw;
                                            }
                                        }
                                    }

                                    quot.Ots = new List<Ots>();
                                    quot.Ots.Add(ot);
                                    if (ot != null)
                                        UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, quotationByOffer, workbenchConnectionString, mailServer);

                                    if (otitems != null && otitems.Count > 0)
                                    {
                                        ApplicationManager applicationManager = new ApplicationManager();

                                        //This property is for AssignedEngAnalysis from dotproject.
                                        People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);

                                        // Send email when eng analysis is validated by 
                                        if (otitems[0].Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                        {
                                            if (offer.EngineeringAnalysis != null)
                                            {
                                                applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                            }
                                            else
                                            {
                                                applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, ot.DeliveryDate);
                                            }

                                            LogEntryByOffer log = new LogEntryByOffer();
                                            log.IdUser = offer.ModifiedBy;
                                            log.DateTime = DateTime.Now;
                                            log.Comments = "The analysis of engineering department has been completed.";
                                            log.IdLogEntryType = 2;
                                            offer.LogEntryByOffers.Add(log);
                                        }
                                        else if (otitems[0].Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                        {
                                            if (offer.EngineeringAnalysis != null)
                                            {
                                                applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                            }
                                            else
                                            {
                                                applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, ot.DeliveryDate);
                                            }

                                            LogEntryByOffer log = new LogEntryByOffer();
                                            log.IdUser = offer.ModifiedBy;
                                            log.DateTime = DateTime.Now;
                                            log.Comments = "The analysis of engineering department has been re-opened.";
                                            log.IdLogEntryType = 2;
                                            offer.LogEntryByOffers.Add(log);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                else
                {
                    if (optionsByOffer.IsSelected == false && optionsByOffer.Quantity == 0)
                    {
                        using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                        {
                            conquotation.Open();
                            using (MySqlTransaction trans = conquotation.BeginTransaction())
                            {
                                try
                                {
                                    //string sqlQuery = "DELETE FROM optionsbyoffer WHERE IdOffer = " + offer.IdOffer + " AND IdOption = " + optionsByOffer.IdOption + ";";
                                    MySqlCommand conquotationcommand = new MySqlCommand("optionsbyoffer_Delete", conquotation);
                                    conquotationcommand.CommandType = CommandType.StoredProcedure;
                                    conquotationcommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                    conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conquotationcommand.Transaction = trans;
                                    conquotationcommand.ExecuteNonQuery();

                                    if (optionsByOffer.IdOption == 25 && ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                        UpdateProjectStatusInDotProject(dotProjectConnectionString, offer, 7);

                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }

                        List<Template> unselectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                        Template unselectedOptionTemplate = GetDefaultArticleByIdOfferOption_V2034(optionsByOffer.IdOption, connectionstring);

                        if (unselectedOptionTemplate != null)
                            unselectedOptionTemplates.Add(unselectedOptionTemplate);

                        foreach (Template quotation in unselectedOptionTemplates)
                        {
                            if (!selectedOptionByOfferTemplates.Contains(quotation.IdTemplate))
                            {
                                using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                {
                                    conquotation.Open();
                                    using (MySqlTransaction trans = conquotation.BeginTransaction())
                                    {
                                        try
                                        {
                                            //string sqlQuery = "update quotations set IdOffer=null where IdDetectionsTemplate = " + quotation.IdTemplate + " AND IdOffer = " + offer.IdOffer + ";";
                                            MySqlCommand conquotationcommand = new MySqlCommand("quotations_UpdateByIdOfferANDTemplate", conquotation);
                                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                                            conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                            conquotationcommand.Transaction = trans;
                                            conquotationcommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }
                            }
                        }



                    }

                }

            }
            return offer;

        }


        public Offer AddOffer_V2034(Offer offer, string connectionString, string offerCodeConnectionString, Int32 idSite, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {


            Int64 offerId = 0;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
            {
                if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                    UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                else
                    offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
            }
            else
                UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);

            if (offerInsertedInGCM)
            {
                using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                {
                    conoffer.Open();
                    using (MySqlTransaction trans = conoffer.BeginTransaction())
                    {
                        try
                        {
                            // SP:- offers_Insert this sp is used till Sprint58
                            // MySqlCommand conoffercommand = new MySqlCommand("offers_Insert", conoffer);

                            // To Add RFQ changed SP:-offers_Insert_Sprint59 in Sprint59
                            MySqlCommand conoffercommand = new MySqlCommand("offers_Insert_Sprint59", conoffer);

                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                            conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                            conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                            conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                            conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                            conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                            conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                            conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                            conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                            conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                            conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                            conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                            conoffercommand.Parameters.AddWithValue("_CreatedBy", offer.CreatedBy);
                            conoffercommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                            conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                            conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                            conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                            conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                            conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                            conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                            conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                            conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                            conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                            conoffercommand.Transaction = trans;
                            offerId = Convert.ToInt64(conoffercommand.ExecuteScalar());
                            offer.IdOffer = offerId;
                            offer.Year = DateTime.Now.Year;

                            UpdateEngAnalysisStatus(dotProjectConnectionString, offer);

                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }

                    }
                }
            }
            if (offerInsertedInGCM && offer.IdOffer > 0)
            {


                offer = AddQuotations_V2034(offer, offer.Site.ConnectPlantConstr, dotProjectConnectionString, mailServer, workbenchConnectionString, workingOrdersPath);
                AddLogEntryByOffer(offer, offer.Site.ConnectPlantConstr, null);
                AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);


            }

            return offer;
        }

        public Offer UpdateOffer_V2034(Offer offer, string connectionstring, string offerCodeConnectionString, Int32 idSite, Int32 idUser, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {
            bool isupdated = false;
            bool isupdatedLeadToOT = true;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            try
            {
                if (offer.IsUpdateLeadToOT)
                {
                    if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
                    {
                        if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                            UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                        else
                            offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
                    }
                    else
                        UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                }

                if (offerInsertedInGCM)
                {
                    MySqlDataAdapter daGCM;
                    DataTable dtGCM;

                    using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                    {
                        conoffer.Open();
                        string query = "select IdOffer from offers where Code= '" + offer.Code + "' and IdOffer =" + offer.IdOffer + " ;";

                        daGCM = new MySqlDataAdapter(query, conoffer);
                        dtGCM = new DataTable();
                        daGCM.Fill(dtGCM);

                        if (dtGCM.Rows.Count > 0)
                            isupdatedLeadToOT = false;
                    }
                    Int64? nullProductCategory = null;
                    if (offer.IdProductCategory > 0)
                    {
                        nullProductCategory = offer.IdProductCategory;
                    }
                    if (offer.IsUpdateLeadToOT)
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_LeadOTUpdate", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                    conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    trans.Commit();

                                    offer.Year = DateTime.Now.Year;
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }


                    }
                    else
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_Update", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    offer.IsUpdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                }

                if (isupdated)
                {


                    UpdateEngAnalysisStatus(dotProjectConnectionString, offer);

                    offer = UpdateQuotation_V2034(offer, offer.Site.ConnectPlantConstr, dotProjectConnectionString, mailServer, workbenchConnectionString, workingOrdersPath);



                    LostReasonsByOffer lostReasonsByOffer = UpdateLostReasonsByOffer(offer.LostReasonsByOffer, offer.Site.ConnectPlantConstr);
                    AddLogEntryByOffer(offer, connectionstring, offer.Site.ConnectPlantConstr);
                    AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);

                    if (offer.NewlyLinkedActivities != null && offer.NewlyLinkedActivities.Count > 0)
                    {
                        using (var transactionScope = new TransactionScope())
                        {
                            try
                            {
                                AddLinkExistingActivityToOffer_V2031(mainserverConnectionString, offer.NewlyLinkedActivities, offer.Site, offer.IdOffer);
                                transactionScope.Complete();
                            }
                            catch (Exception ex)
                            {
                                if (Transaction.Current != null)
                                    Transaction.Current.Rollback();

                                if (transactionScope != null)
                                    transactionScope.Dispose();

                                throw;
                            }
                        }
                    }



                }
            }
            catch (Exception ex)
            {
                throw;
                offer.IsUpdated = false;
            }

            return offer;
        }


        public Offer UpdateOfferForParticularColumn_V2034(Offer offer, string connectionstring, string offerCodeConnectionString, Int32 idSite, Int32 idUser, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString, string jiraCredential)
        {
            bool isupdated = false;
            bool isupdatedLeadToOT = true;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            try
            {
                if (offer.IsUpdateLeadToOT)
                {
                    if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
                    {
                        if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                            UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                        else
                            offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
                    }
                    else
                        UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                }

                if (offerInsertedInGCM)
                {
                    MySqlDataAdapter daGCM;
                    DataTable dtGCM;

                    using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                    {
                        conoffer.Open();
                        string query = "select IdOffer from offers where Code= '" + offer.Code + "' and IdOffer =" + offer.IdOffer + " ;";

                        daGCM = new MySqlDataAdapter(query, conoffer);

                        dtGCM = new DataTable();
                        daGCM.Fill(dtGCM);

                        if (dtGCM.Rows.Count > 0)
                            isupdatedLeadToOT = false;

                    }

                    if (offer.IsUpdateLeadToOT)
                    {

                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_LeadOTUpdateParticularColumn", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    //conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                    conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    //conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    //conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    //conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }


                    }
                    else
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_UpdateParticularColumn", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    //conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    //conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    //conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    //conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    //conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);

                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }


                    }
                }

                if (isupdated)
                {
                    offer = UpdateQuotation_V2034(offer, offer.Site.ConnectPlantConstr, dotProjectConnectionString, mailServer, workbenchConnectionString, workingOrdersPath);
                    AddLogEntryByOffer(offer, connectionstring, offer.Site.ConnectPlantConstr);

                    //LostReasonsByOffer lostReasonsByOffer = UpdateLostReasonsByOffer(offer.LostReasonsByOffer, offer.Site.ConnectPlantConstr);

                    //AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);
                }

            }
            catch (Exception ex)
            {
                throw;
                //isupdated = false;
            }

            return offer;
        }


        public Offer AddOfferWithIdSourceOffer_V2034(Offer offer, string connectionString, string offerCodeConnectionString, Int32 idSite, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString, string jiraCredential)
        {
            Int64 offerId = 0;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
            {
                if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                    UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                else
                    offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
            }
            else
                UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);

            if (offerInsertedInGCM)
            {
                using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                {
                    conoffer.Open();
                    using (MySqlTransaction trans = conoffer.BeginTransaction())
                    {
                        try
                        {
                            //MySqlCommand conoffercommand = new MySqlCommand("offers_InsertWithIdSourceOffer", conoffer);
                            MySqlCommand conoffercommand = new MySqlCommand("offers_InsertWithIdSourceOffer_Sprint59", conoffer);
                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                            conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                            conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                            conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                            conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                            conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                            conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                            conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                            conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                            conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                            conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                            conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                            conoffercommand.Parameters.AddWithValue("_CreatedBy", offer.CreatedBy);
                            conoffercommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                            conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                            conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                            conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                            conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                            conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                            conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                            conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                            conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                            conoffercommand.Parameters.AddWithValue("_IdSourceOffer", offer.IdSourceOffer);
                            conoffercommand.Parameters.AddWithValue("_Rfq", offer.Rfq);
                            conoffercommand.Transaction = trans;
                            offerId = Convert.ToInt64(conoffercommand.ExecuteScalar());
                            offer.IdOffer = offerId;
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }

                    }
                }
            }
            if (offerInsertedInGCM && offer.IdOffer > 0)
            {

                AddQuotations_V2034(offer, offer.Site.ConnectPlantConstr, dotProjectConnectionString, mailServer, workbenchConnectionString, workingOrdersPath);
                AddLogEntryByOffer(offer, offer.Site.ConnectPlantConstr, null);
                AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);
                if (offer.IsCreateIssueInJira)
                {
                    if (offer.OfferIssueKey == null || offer.ErrorFromJira != null)
                    {
                        DeleteEngAnalysisFromOffer(offer, dotProjectConnectionString);
                    }
                }
            }

            return offer;
        }


        public List<Offer> GetSelectedOffersEngAnalysisDateWise_V2034(string idUser, byte idCurrency, Int32 idCurrentUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, string workbenchConnectionString)
        {
            List<Offer> offers = new List<Offer>();
            string jiraCredential = null;

            GeosAppSetting geosAppSetting = GetGeosAppSettings(29, workbenchConnectionString);
            if (geosAppSetting != null)
            {
                jiraCredential = geosAppSetting.DefaultValue;
            }

            using (MySqlConnection mySqlConnection = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                mySqlConnection.Open();
                MySqlCommand sqlCommand = new MySqlCommand("offers_GetSelectedOffersEngAnalysisDateWise", mySqlConnection);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.CommandTimeout = 3000;
                sqlCommand.Parameters.AddWithValue("_idUser", idUser);
                sqlCommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                sqlCommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                sqlCommand.Parameters.AddWithValue("_idZone", idZone);
                sqlCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                sqlCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);


                using (MySqlDataReader reader = sqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Offer offer = new Offer();
                        try
                        {
                            offer.IdOffer = Convert.ToInt64(reader["idoffer"]);

                            if (reader["IdSalesOwner"] != DBNull.Value)
                                offer.IdSalesOwner = Convert.ToInt32(reader["IdSalesOwner"]);

                            offer.IdOfferType = Convert.ToByte(reader["IdOfferType"]);
                            offer.Code = Convert.ToString(reader["OfferCode"]);
                            offer.Description = Convert.ToString(reader["OfferTitle"]);

                            offer.Site = new Company();
                            offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;

                            offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(reader["OfferStatusid"]), Name = Convert.ToString(reader["OfferStatus"]), HtmlColor = Convert.ToString(reader["OfferStatusColor"]), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(reader["IdSalesStatusType"]), Name = Convert.ToString(reader["SalesStatusType"]), HtmlColor = Convert.ToString(reader["SalesStatusTypeColor"]) } };

                            if (reader["DeliveryDate"] != DBNull.Value)
                                offer.DeliveryDate = Convert.ToDateTime(reader["OtDeliveryDate"]);

                            if (reader["IdBusinessUnit"] != DBNull.Value)
                            {
                                offer.IdBusinessUnit = Convert.ToByte(reader["IdBusinessUnit"]);
                                offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(reader["IdBusinessUnit"]), Value = Convert.ToString(reader["BusinessUnit"]) };
                            }

                            offer.PartNumber = new PartNumbers();
                            offer.PartNumber.IdPartNumber = Convert.ToInt32(reader["idPartNumber"]);
                            offer.PartNumber.Code = Convert.ToString(reader["PartNumberCode"]);

                            offer.PartNumber.PartNumbersTracking = new PartNumbersTracking();
                            if (reader["StartDate"] != DBNull.Value)
                                offer.PartNumber.PartNumbersTracking.StartDate = Convert.ToDateTime(reader["StartDate"]);

                            if (reader["EndDate"] != DBNull.Value)
                                offer.PartNumber.PartNumbersTracking.EndDate = Convert.ToDateTime(reader["EndDate"]);

                            offer.PartNumber.PartNumbersTracking.StageOperator = new People();
                            if (reader["IdOperator"] != DBNull.Value)
                            {
                                offer.PartNumber.PartNumbersTracking.StageOperator.IdPerson = Convert.ToInt32(reader["IdOperator"]);
                                offer.PartNumber.PartNumbersTracking.StageOperator.Name = Convert.ToString(reader["Name"]);
                                offer.PartNumber.PartNumbersTracking.StageOperator.Surname = Convert.ToString(reader["Surname"]);
                            }



                            offers.Add(offer);
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }
                    }
                }
            }

            return offers;
        }

        public List<Offer> GetOffersEngineeringAnalysisByPermission_V2034(byte idCurrency, Int32 idUser, Int32 idZone, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, Int32 idUserPermission, string workbenchConnectionString)
        {
            List<Offer> offers = new List<Offer>();
            string jiraCredential = null;

            GeosAppSetting geosAppSetting = GetGeosAppSettings(29, workbenchConnectionString);
            if (geosAppSetting != null)
            {
                jiraCredential = geosAppSetting.DefaultValue;
            }

            using (MySqlConnection mySqlConnection = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                mySqlConnection.Open();

                MySqlCommand sqlCommand = new MySqlCommand("offers_GetOffersEngAnalysisDateWiseAndpermission", mySqlConnection);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.CommandTimeout = 3000;
                sqlCommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                sqlCommand.Parameters.AddWithValue("_idUser", idUser);
                sqlCommand.Parameters.AddWithValue("_idZone", idZone);
                sqlCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                sqlCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                sqlCommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader reader = sqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Offer offer = new Offer();
                        try
                        {
                            offer.IdOffer = Convert.ToInt64(reader["idoffer"].ToString());

                            if (reader["IdSalesOwner"] != DBNull.Value)
                                offer.IdSalesOwner = Convert.ToInt32(reader["IdSalesOwner"]);

                            offer.IdOfferType = Convert.ToByte(reader["IdOfferType"]);
                            offer.Code = Convert.ToString(reader["OfferCode"]);
                            offer.Description = Convert.ToString(reader["OfferTitle"]);

                            offer.Site = new Company();
                            offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;

                            offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(reader["OfferStatusid"].ToString()), Name = reader["OfferStatus"].ToString(), HtmlColor = reader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(reader["IdSalesStatusType"].ToString()), Name = reader["SalesStatusType"].ToString(), HtmlColor = reader["SalesStatusTypeColor"].ToString() } };

                            if (reader["DeliveryDate"] != DBNull.Value)
                                offer.DeliveryDate = Convert.ToDateTime(reader["OtDeliveryDate"]);

                            if (reader["IdBusinessUnit"] != DBNull.Value)
                            {
                                offer.IdBusinessUnit = Convert.ToByte(reader["IdBusinessUnit"].ToString());
                                offer.BusinessUnit = new LookupValue { IdLookupValue = Convert.ToInt32(reader["IdBusinessUnit"].ToString()), Value = reader["BusinessUnit"].ToString() };
                            }

                            offer.PartNumber = new PartNumbers();
                            offer.PartNumber.IdPartNumber = Convert.ToInt32(reader["idPartNumber"].ToString());
                            offer.PartNumber.Code = Convert.ToString(reader["PartNumberCode"]);

                            offer.PartNumber.PartNumbersTracking = new PartNumbersTracking();
                            if (reader["StartDate"] != DBNull.Value)
                                offer.PartNumber.PartNumbersTracking.StartDate = Convert.ToDateTime(reader["StartDate"].ToString());

                            if (reader["EndDate"] != DBNull.Value)
                                offer.PartNumber.PartNumbersTracking.EndDate = Convert.ToDateTime(reader["EndDate"].ToString());

                            offer.PartNumber.PartNumbersTracking.StageOperator = new People();
                            if (reader["IdOperator"] != DBNull.Value)
                            {
                                offer.PartNumber.PartNumbersTracking.StageOperator.IdPerson = Convert.ToInt32(reader["IdOperator"].ToString());
                                offer.PartNumber.PartNumbersTracking.StageOperator.Name = Convert.ToString(reader["Name"]);
                                offer.PartNumber.PartNumbersTracking.StageOperator.Surname = Convert.ToString(reader["Surname"]);
                            }



                            offers.Add(offer);
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }
                    }
                }
            }

            return offers;
        }
        private bool DeleteEngAnalysisFromOffer(Offer offer, string dotProjectConnectionString)
        {
            bool isdeletedEngAnalysis = false;
            try
            {
                using (MySqlConnection conquotation = new MySqlConnection(offer.Site.ConnectPlantConstr))
                {
                    conquotation.Open();
                    using (MySqlTransaction trans = conquotation.BeginTransaction())
                    {
                        try
                        {
                            //string sqlQuery = "DELETE FROM optionsbyoffer WHERE IdOffer = " + offer.IdOffer + " AND IdOption = " + optionsByOffer.IdOption + ";";
                            MySqlCommand conquotationcommand = new MySqlCommand("optionsbyoffer_Delete", conquotation);
                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                            conquotationcommand.Parameters.AddWithValue("_IdOption", 25);
                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                            conquotationcommand.Transaction = trans;
                            conquotationcommand.ExecuteNonQuery();

                            if (ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                UpdateProjectStatusInDotProject(dotProjectConnectionString, offer, 7);

                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }

                List<Template> unselectedOptionTemplates = GetTemplatesByIdOfferOption(offer.Site.ConnectPlantConstr, 25);
                Template unselectedOptionTemplate = GetDefaultArticleByIdOfferOption(25, offer.Site.ConnectPlantConstr);

                if (unselectedOptionTemplate != null)
                    unselectedOptionTemplates.Add(unselectedOptionTemplate);

                foreach (Template quotation in unselectedOptionTemplates)
                {

                    using (MySqlConnection conquotation = new MySqlConnection(offer.Site.ConnectPlantConstr))
                    {
                        conquotation.Open();
                        using (MySqlTransaction trans = conquotation.BeginTransaction())
                        {
                            try
                            {
                                //string sqlQuery = "update quotations set IdOffer=null where IdDetectionsTemplate = " + quotation.IdTemplate + " AND IdOffer = " + offer.IdOffer + ";";
                                MySqlCommand conquotationcommand = new MySqlCommand("quotations_UpdateByIdOfferANDTemplate", conquotation);
                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                conquotationcommand.Transaction = trans;
                                conquotationcommand.ExecuteNonQuery();
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }

                    }
                }
                isdeletedEngAnalysis = true;
            }
            catch (Exception ex)
            {
                isdeletedEngAnalysis = false;
                throw;
            }
            return isdeletedEngAnalysis;


        }

        private Template GetDefaultArticleByIdOfferOption_V2034(Int64 idOfferOption, string connectionstring)
        {
            Template template = null;
            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
            {
                conquotation.Open();

                // string query = "SELECT * FROM defaultarticlesbyofferoption WHERE idOfferOption = " + idOfferOption + " AND idTemplate = 18;";
                MySqlCommand conoffercommand = new MySqlCommand("GetdefaultarticlesbyofferoptionByIdidOfferOption", conquotation);
                conoffercommand.CommandType = CommandType.StoredProcedure;
                conoffercommand.Parameters.AddWithValue("_IdOfferOption", idOfferOption);
                using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                {
                    if (offerreader.Read())
                    {
                        using (MySqlConnection contemplate = new MySqlConnection(connectionstring))
                        {
                            contemplate.Open();

                            //string templatequery = "SELECT * FROM templates WHERE IdTemplate = 18;";
                            MySqlCommand contemplatecommand = new MySqlCommand("templates_GetTemplateByIdTemplate", contemplate);
                            contemplatecommand.CommandType = CommandType.StoredProcedure;
                            contemplatecommand.Parameters.AddWithValue("_IdTemplate", 18);

                            using (MySqlDataReader templatereader = contemplatecommand.ExecuteReader())
                            {
                                if (templatereader.Read())
                                {
                                    template = new Template();
                                    template.Suffix = templatereader["Suffix"].ToString();
                                    template.Name = templatereader["Name"].ToString();
                                    template.IdTemplate = Convert.ToByte(templatereader["IdTemplate"].ToString());
                                    template.Type = Convert.ToByte(templatereader["Type"].ToString());
                                }
                            }
                        }
                    }
                }
            }
            return template;
        }

        public List<GeosAppSetting> GetSelectedGeosAppSettings(string connectionString, string IdAppSettings)
        {
            List<GeosAppSetting> geosAppSettings = new List<GeosAppSetting>();

            using (MySqlConnection MyConnection = new MySqlConnection(connectionString))
            {
                MyConnection.Open();
                MySqlCommand myCommand = new MySqlCommand("geosappsettings_GetSelectedGeosAppSettings", MyConnection);
                myCommand.CommandType = CommandType.StoredProcedure;
                myCommand.Parameters.AddWithValue("_IdAppSettings", IdAppSettings);

                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        GeosAppSetting geosAppSetting = new GeosAppSetting();
                        geosAppSetting.IdAppSetting = Convert.ToInt16(reader["IdAppSetting"]);

                        if (reader["AppSettingName"] != DBNull.Value)
                            geosAppSetting.AppSettingName = Convert.ToString(reader["AppSettingName"]);

                        if (reader["IsUserModify"] != DBNull.Value)
                            geosAppSetting.IsUserModify = Convert.ToByte(reader["IsUserModify"]);

                        if (reader["DefaultValue"] != DBNull.Value)
                            geosAppSetting.DefaultValue = Convert.ToString(reader["DefaultValue"]);

                        geosAppSettings.Add(geosAppSetting);
                    }

                    reader.Close();
                }

                myCommand.Dispose();
                MyConnection.Close();
            }

            return geosAppSettings;
        }

        public bool CreateAutomaticPlannedActivity_V2035(string connectionString, string mainConnectionString, DateTime startDate, DateTime endDate, Int32 idUser, List<ActivitiesRecurrence> LstActivitiesRecurrence)
        {

            List<ActivitiesRecurrence> activitiesRecurrences = new List<ActivitiesRecurrence>();
            activitiesRecurrences = GetActivitiesRecurrenceByGridFilter_V2031(connectionString, LstActivitiesRecurrence);
            foreach (var item in activitiesRecurrences)
            {
                if (item.Periodicity != null && item.Periodicity > 0)
                {
                    int peroidcity = 1;
                    for (DateTime date = startDate; date <= endDate; date = date.AddDays(peroidcity))
                    {
                        if (date.DayOfWeek.ToString() == item.WeekDay)
                        {

                            peroidcity = item.Periodicity.Value;

                            TransactionScope transactionScope = null;
                            try
                            {

                                using (transactionScope = new TransactionScope())
                                {
                                    using (MySqlConnection mySqlConnection = new MySqlConnection(mainConnectionString))
                                    {
                                        mySqlConnection.Open();

                                        MySqlCommand mySqlCommand = new MySqlCommand("CRM_activitiesAutomaticInsert_V2035", mySqlConnection);
                                        mySqlCommand.CommandType = CommandType.StoredProcedure;
                                        mySqlCommand.Parameters.AddWithValue("_ToDate", date);
                                        mySqlCommand.Parameters.AddWithValue("_Subject", item.Subject);
                                        mySqlCommand.Parameters.AddWithValue("_Location", item.Location);
                                        mySqlCommand.Parameters.AddWithValue("_IdOwner", item.IdSalesOwner);
                                        mySqlCommand.Parameters.AddWithValue("_IdActivityType", item.IdActivityType);
                                        mySqlCommand.Parameters.AddWithValue("_FromDate", date);
                                        mySqlCommand.Parameters.AddWithValue("_Description", item.Description);
                                        mySqlCommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                        mySqlCommand.Parameters.AddWithValue("_CreatedBy", idUser);
                                        mySqlCommand.Parameters.AddWithValue("_IdSite", item.IdSite);
                                        mySqlCommand.Parameters.AddWithValue("_Latitude", item.Latitude);
                                        mySqlCommand.Parameters.AddWithValue("_Longitude", item.Longitude);
                                        if (item.Periodicity == 7)
                                        {
                                            DayOfWeek day = date.DayOfWeek;
                                            int days = day - DayOfWeek.Monday;

                                            DateTime start = date.AddDays(-days);
                                            DateTime end = start.AddDays(6);

                                            mySqlCommand.Parameters.AddWithValue("_MinDueDate", start);
                                            mySqlCommand.Parameters.AddWithValue("_MaxDueDate", end);
                                        }
                                        else if (item.Periodicity == 14)
                                        {
                                            DayOfWeek day = date.DayOfWeek;
                                            int days = day - DayOfWeek.Monday;

                                            DateTime start = date.AddDays(-days);
                                            DateTime end = start.AddDays(13);

                                            mySqlCommand.Parameters.AddWithValue("_MinDueDate", start);
                                            mySqlCommand.Parameters.AddWithValue("_MaxDueDate", end);
                                        }
                                        else if (item.Periodicity == 30)
                                        {
                                            DateTime start = new DateTime(date.Year, date.Month, 1);
                                            DateTime end = start.AddMonths(1).AddDays(-1);


                                            mySqlCommand.Parameters.AddWithValue("_MinDueDate", start);
                                            mySqlCommand.Parameters.AddWithValue("_MaxDueDate", end);
                                        }
                                        else if (item.Periodicity == 60)
                                        {
                                            DateTime start = new DateTime(date.Year, date.Month, 1);
                                            DateTime end = start.AddMonths(2).AddDays(-1);

                                            mySqlCommand.Parameters.AddWithValue("_MinDueDate", start);
                                            mySqlCommand.Parameters.AddWithValue("_MaxDueDate", end);
                                        }
                                        else if (item.Periodicity == 90)
                                        {
                                            DateTime start = new DateTime(date.Year, date.Month, 1);
                                            DateTime end = start.AddMonths(3).AddDays(-1);

                                            mySqlCommand.Parameters.AddWithValue("_MinDueDate", start);
                                            mySqlCommand.Parameters.AddWithValue("_MaxDueDate", end);
                                        }
                                        else if (item.Periodicity == 120)
                                        {
                                            DayOfWeek day = date.DayOfWeek;
                                            int days = day - DayOfWeek.Monday;

                                            DateTime start = new DateTime(date.Year, date.Month, 1);
                                            DateTime end = start.AddMonths(4).AddDays(-1);

                                            mySqlCommand.Parameters.AddWithValue("_MinDueDate", start);
                                            mySqlCommand.Parameters.AddWithValue("_MaxDueDate", end);
                                        }

                                        int lastInsertedId = Convert.ToInt32(mySqlCommand.ExecuteScalar());
                                        mySqlConnection.Close();
                                    }

                                    transactionScope.Complete();
                                }
                            }
                            catch (Exception ex)
                            {
                                if (Transaction.Current != null)
                                    Transaction.Current.Rollback();

                                if (transactionScope != null)
                                    transactionScope.Dispose();

                                throw;
                            }

                        }


                        else
                        {
                            peroidcity = 1;
                        }
                    }

                }
            }
            return true;
        }


        public Activity GetActivityByIdActivity_V2035(Int64 idActivity, string connectionString)
        {
            Activity activity = new Activity();

            using (MySqlConnection connActivities = new MySqlConnection(connectionString))
            {
                connActivities.Open();
                MySqlCommand getActivitiesCommand = new MySqlCommand("CRM_GetActivityByIdActivity_V2035", connActivities);
                getActivitiesCommand.CommandType = CommandType.StoredProcedure;
                getActivitiesCommand.Parameters.AddWithValue("_IdActivity", idActivity);
                using (MySqlDataReader activityReader = getActivitiesCommand.ExecuteReader())
                {
                    while (activityReader.Read())
                    {
                        activity.Subject = activityReader["Subject"].ToString();

                        if (activityReader["IdActivityType"] != DBNull.Value)
                        {
                            activity.IdActivityType = Convert.ToInt32(activityReader["IdActivityType"].ToString());
                            activity.LookupValue = new LookupValue();
                            activity.LookupValue.IdLookupValue = Convert.ToInt32(activityReader["IdActivityType"].ToString());
                            activity.LookupValue.Value = activityReader["ActivityType"].ToString();
                            activity.LookupValue.HtmlColor = activityReader["ActivityTypeHtmlColor"].ToString();

                            if (activityReader["ActivityTypeImage"] != DBNull.Value)
                                activity.LookupValue.IdImage = Convert.ToInt64(activityReader["ActivityTypeImage"].ToString());

                            if (activityReader["ActivityTypePosition"] != DBNull.Value)
                                activity.LookupValue.Position = Convert.ToInt32(activityReader["ActivityTypePosition"].ToString());
                        }

                        activity.IdActivity = Convert.ToInt64(activityReader["IdActivity"].ToString());
                        if (activityReader["IdOwner"] != DBNull.Value)
                            activity.IdOwner = Convert.ToInt32(activityReader["IdOwner"].ToString());

                        if (activityReader["FromDate"] != DBNull.Value)
                        {
                            var ordinal = activityReader.GetOrdinal("FromDate");
                            activity.FromDate = Convert.ToDateTime(activityReader.GetMySqlDateTime(ordinal));
                        }

                        if (activityReader["ToDate"] != DBNull.Value)
                        {
                            var ordinal = activityReader.GetOrdinal("ToDate");
                            activity.ToDate = Convert.ToDateTime(activityReader.GetMySqlDateTime(ordinal));
                        }

                        //if (activityreader["FromDate"] != DBNull.Value)
                        //    activity.FromDate = Convert.ToDateTime(activityreader["FromDate"].ToString());
                        //if (activityreader["ToDate"] != DBNull.Value)
                        //    activity.ToDate = Convert.ToDateTime(activityreader["ToDate"].ToString());

                        activity.Description = activityReader["Description"].ToString();
                        activity.Location = activityReader["Location"].ToString();

                        if (activityReader["CreatedIn"] != DBNull.Value)
                            activity.CreatedIn = Convert.ToDateTime(activityReader["CreatedIn"].ToString());

                        if (activityReader["ModifiedIn"] != DBNull.Value)
                            activity.ModifiedIn = Convert.ToDateTime(activityReader["ModifiedIn"].ToString());

                        if (activityReader["CreatedBy"] != DBNull.Value)
                            activity.CreatedBy = Convert.ToInt32(activityReader["CreatedBy"].ToString());

                        if (activityReader["ModifiedBy"] != DBNull.Value)
                            activity.ModifiedBy = Convert.ToInt32(activityReader["ModifiedBy"].ToString());

                        if (activityReader["Latitude"] != DBNull.Value)
                        {
                            activity.Latitude = Convert.ToDouble(activityReader["Latitude"].ToString());
                            activity.BothLongitudeLatitude = activity.Latitude.ToString();
                        }

                        if (activityReader["Longitude"] != DBNull.Value)
                        {
                            activity.Longitude = Convert.ToDouble(activityReader["Longitude"].ToString());
                            activity.BothLongitudeLatitude = activity.BothLongitudeLatitude + activity.Longitude.ToString();
                        }

                        if (activityReader["IdPerson"] != DBNull.Value)
                        {
                            activity.People = new People();
                            activity.People.Name = activityReader["Name"].ToString();
                            activity.People.IdPerson = Convert.ToInt32(activityReader["IdPerson"].ToString());
                            activity.People.Surname = activityReader["Surname"].ToString();

                            if (activityReader["IdPersonGender"] != DBNull.Value)
                                activity.People.IdPersonGender = Convert.ToByte(activityReader["IdPersonGender"].ToString());
                        }

                        if (activityReader["IsCompleted"] != DBNull.Value)
                        {
                            activity.IsCompleted = Convert.ToByte(activityReader["IsCompleted"].ToString());

                            if (activityReader["CloseDate"] != DBNull.Value)
                                activity.CloseDate = Convert.ToDateTime(activityReader["CloseDate"].ToString());
                        }

                        if (activityReader["IsInternal"] != DBNull.Value)
                        {
                            activity.IsInternal = Convert.ToByte(activityReader["IsInternal"].ToString());
                        }

                        if (activityReader["IdActivityStatus"] != DBNull.Value)
                        {
                            activity.IdActivityStatus = Convert.ToInt32(activityReader["IdActivityStatus"].ToString());
                            activity.ActivityStatus = new LookupValue();
                            activity.ActivityStatus.IdLookupValue = Convert.ToInt32(activityReader["IdActivityStatus"].ToString());
                            activity.ActivityStatus.Value = activityReader["ActivityStatus"].ToString();
                            activity.ActivityStatus.HtmlColor = activityReader["ActivityStatusHtmlColor"].ToString();
                            if (activityReader["ActivityStatusImage"] != DBNull.Value)
                                activity.ActivityStatus.IdImage = Convert.ToInt64(activityReader["ActivityStatusImage"].ToString());
                            if (activityReader["ActivityStatusPosition"] != DBNull.Value)
                                activity.ActivityStatus.Position = Convert.ToInt32(activityReader["ActivityStatusPosition"].ToString());
                        }

                        if (activityReader["ReminderDateTime"] != DBNull.Value)
                            activity.ActivityReminderDateTime = Convert.ToDateTime(activityReader["ReminderDateTime"].ToString());

                        if (activityReader["IsSentMail"] != DBNull.Value)
                            activity.IsSentMail = Convert.ToByte(activityReader["IsSentMail"].ToString());

                        if (activityReader["MinDueDate"] != DBNull.Value)
                            activity.MinDueDate = Convert.ToDateTime(activityReader["MinDueDate"].ToString());

                        if (activityReader["MaxDueDate"] != DBNull.Value)
                            activity.MaxDueDate = Convert.ToDateTime(activityReader["MaxDueDate"].ToString());

                        activity.LogEntriesByActivity = new List<LogEntriesByActivity>();
                        activity.LogEntriesByActivity = GetlogEntriesByActivity(idActivity, 2, connectionString);

                        activity.CommentsByActivity = new List<LogEntriesByActivity>();
                        activity.CommentsByActivity = GetlogEntriesByActivity(idActivity, 1, connectionString);

                        activity.ActivityAttendees = new List<ActivityAttendees>();
                        activity.ActivityAttendees = GetActivityAttendeesByIdActivity(idActivity, connectionString);

                        activity.ActivityWatchers = GetActivityWatchersByIdActivity(idActivity, connectionString);

                        activity.ActivityLinkedItem = new List<ActivityLinkedItem>();
                        activity.ActivityLinkedItem = GetActivityLinkedItemsByIdActivity(idActivity, connectionString);

                        activity.ActivityAttachment = new List<ActivityAttachment>();
                        activity.ActivityAttachment = GetActivityAttachmentByIdActivity(idActivity, connectionString);

                        activity.ActivityTags = new List<ActivityTag>();
                        activity.ActivityTags = GetActivityTagsByIdActivity(idActivity, connectionString);
                        //listactivity.Add(activity);
                    }
                }
            }
            return activity;
        }


        public List<Offer> GetOffersByIdCustomerToLinkedWithActivities_V2035(byte idCurrency, Int32 idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company compdetails, Int32 idUserPermission, Int32 idCustomer)
        {
            List<Offer> offers = new List<Offer>();

            //DataSet ds = new DataSet();

            using (MySqlConnection connOffersByIdSiteForActivities = new MySqlConnection(compdetails.ConnectPlantConstr))
            {
                connOffersByIdSiteForActivities.Open();
                MySqlCommand offersCommand = new MySqlCommand("CRM_GetOffersByIdCustomerForActivitiesDatewise_V2035", connOffersByIdSiteForActivities);
                offersCommand.CommandType = CommandType.StoredProcedure;
                offersCommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                offersCommand.Parameters.AddWithValue("_idUser", idUser);
                offersCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                offersCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                offersCommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                offersCommand.Parameters.AddWithValue("_IdCustomer", idCustomer);

                //MySqlDataAdapter da = new MySqlDataAdapter(offersCommand);
                //DataSet ds = new DataSet();
                //da.Fill(ds);

                using (MySqlDataReader itemRow = offersCommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            Offer offer = new Offer();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());
                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString(), SiteNameWithoutCountry = itemRow["SiteWithCountryName"].ToString() };

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());
                            }

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            {
                                offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());
                            }

                            offer.Site.ConnectPlantId = compdetails.ConnectPlantId;
                            offer.Site.Alias = compdetails.ShortName;

                            offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };
                            offer.Site.Country = new Country { Name = itemRow["CustomerCountry"].ToString(), Zone = new Zone { Name = itemRow["CustomerZone"].ToString() } };
                            offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(itemRow["OfferStatusid"].ToString()), Name = itemRow["OfferStatus"].ToString(), HtmlColor = itemRow["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["SalesStatusType"].ToString(), HtmlColor = itemRow["SalesStatusTypeColor"].ToString() } };

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            offer.Currency = new Currency { IdCurrency = Convert.ToByte(itemRow["IdCurrency"].ToString()), Name = itemRow["OfferCurrency"].ToString() };
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());



                            offers.Add(offer);
                        }
                    }
                }
            }

            return offers;
        }

        public IList<Offer> GetOffersPipeline_V2035(byte idCurrency, string userids, Int32 idCurrentUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, Int32 idUserPermission)
        {
            IList<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetOfferPipelineDatewise_V2035", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", userids);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);


                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());
                        if (offerreader["IdSalesOwner"] != DBNull.Value)
                        {
                            offer.IdSalesOwner = Convert.ToInt32(offerreader["IdSalesOwner"].ToString());

                        }
                        if (offerreader["IdOfferType"] != DBNull.Value)
                            offer.IdOfferType = Convert.ToByte(offerreader["IdOfferType"].ToString());

                        offer.Code = offerreader["OfferCode"].ToString();
                        offer.Description = offerreader["OfferTitle"].ToString();
                        offer.Site = new Company { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["SiteName"].ToString() };
                        if (offerreader["IdSalesResponsible"] != DBNull.Value)
                        {
                            offer.Site.IdSalesResponsible = Convert.ToInt32(offerreader["IdSalesResponsible"].ToString());
                        }
                        if (offerreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                        {
                            offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(offerreader["IdSalesResponsibleAssemblyBU"].ToString());
                        }
                        offer.Site.ConnectPlantId = companyDetails.ConnectPlantId;
                        //offer.Site.ConnectPlantConstr = dictconnectstr.Value;

                        if (offerreader["IdCustomer"] != DBNull.Value)
                            offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } };

                        offer.Site.Country = new Country { Name = offerreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offerreader["CustomerZone"].ToString() } };
                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToInt64(offerreader["OfferStatusid"].ToString()), Name = offerreader["OfferStatus"].ToString(), HtmlColor = offerreader["OfferStatusColor"].ToString(), SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerreader["IdSalesStatusType"].ToString()), Name = offerreader["SalesStatusType"].ToString(), HtmlColor = offerreader["SalesStatusTypeColor"].ToString() } };

                        if (offerreader["OfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["OfferAmount"].ToString());

                        offer.Currency = new Currency { IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString()), Name = offerreader["OfferCurrency"].ToString() };
                        if (offerreader["OfferConfidentialLevel"] != DBNull.Value)
                            offer.ProbabilityOfSuccess = Convert.ToSByte(offerreader["OfferConfidentialLevel"].ToString());
                        if (offerreader["RFQReception"] != DBNull.Value)
                            offer.RFQReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        if (offerreader["sendIn"] != DBNull.Value)
                            offer.SendIn = Convert.ToDateTime(offerreader["sendIn"].ToString());
                        if (offerreader["OfferExpectedPODate"] != DBNull.Value)
                            offer.DeliveryDate = Convert.ToDateTime(offerreader["OfferExpectedPODate"].ToString());

                        offers.Add(offer);
                    }
                }
            }
            offers.Where(i => i.GeosStatus.IdOfferStatusType == 1).ToList().Count();
            return offers;
        }



        public IList<Customer> GetDashboard2Details_V2035(byte idCurrency, Int32 idCurrentUser, string idsUser, DateTime accountingYearFrom, DateTime accountingYearTo, Int32 customerLimit, Company companyDetails, Int32 idUserPermission)
        {

            IList<Customer> customers = new List<Customer>();
            List<Company> companiesSortLst = new List<Company>();
            List<CustomerSort> Lstsort = new List<CustomerSort>();
            Customer customer = new Customer();
            DataSet ds = new DataSet();

            using (MySqlConnection conoffertarget = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conoffertarget.Open();
                MySqlCommand concompaniescommand = new MySqlCommand("CRM_GetDashboard2Details_V2035", conoffertarget);
                concompaniescommand.CommandType = CommandType.StoredProcedure;
                concompaniescommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concompaniescommand.Parameters.AddWithValue("_idUser", idsUser);
                concompaniescommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                concompaniescommand.Parameters.AddWithValue("_customerLimit", customerLimit);
                concompaniescommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                concompaniescommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                concompaniescommand.Parameters.AddWithValue("_idPermission", idUserPermission);
                MySqlDataAdapter da = new MySqlDataAdapter(concompaniescommand);
                //DataSet ds = new DataSet();
                da.Fill(ds);
            }
            foreach (DataRow itemRow in ds.Tables[0].Rows)
            {
                if (customers.Any(cust => cust.IdCustomer == Convert.ToInt32(itemRow["idCustomer"].ToString())))
                {
                    Customer custold = new Customer();
                    custold = customers.Where(cust => cust.IdCustomer == Convert.ToInt32(itemRow["idCustomer"].ToString())).SingleOrDefault();
                    if (custold.Companies.Any(comp => comp.IdCompany == Convert.ToInt32(itemRow["IdSite"].ToString())))
                    {
                        Company compold = new Company();
                        compold = custold.Companies.Where(comp => comp.IdCompany == Convert.ToInt32(itemRow["IdSite"].ToString())).SingleOrDefault();
                        if (compold.SalesStatusTypes.Any(ss => ss.Name == itemRow["Name"].ToString()))
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType = compold.SalesStatusTypes.Where(ss => ss.Name == itemRow["Name"].ToString()).SingleOrDefault();
                            salesStatusType.TotalAmount = salesStatusType.TotalAmount + Convert.ToDouble(itemRow["Amount"].ToString());
                            if (salesStatusType.IdSalesStatusType == 4)
                            {
                                if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany))
                                {
                                    CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany).FirstOrDefault();
                                    custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                }
                                else
                                {
                                    CustomerSort custsort = new CustomerSort();
                                    custsort.IdCustomer = custold.IdCustomer;
                                    custsort.IdSite = compold.IdCompany;
                                    custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                    Lstsort.Add(custsort);
                                }

                            }
                        }
                        else
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                            salesStatusType.Name = itemRow["Name"].ToString();
                            salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());

                            compold.SalesStatusTypes.Add(salesStatusType);
                            if (salesStatusType.IdSalesStatusType == 4)
                            {
                                if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany))
                                {
                                    CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany).FirstOrDefault();
                                    custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                }
                                else
                                {
                                    CustomerSort custsort = new CustomerSort();
                                    custsort.IdCustomer = custold.IdCustomer;
                                    custsort.IdSite = compold.IdCompany;
                                    custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                    Lstsort.Add(custsort);
                                }
                            }
                        }

                    }
                    else
                    {
                        Company company = new Company();
                        company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                        company.Name = itemRow["CustomerPlant"].ToString();
                        company.SiteNameWithoutCountry = itemRow["SiteName"].ToString();
                        company.Country = new Country { Name = itemRow["Country"].ToString() };

                        company.SalesStatusTypes = new List<SalesStatusType>() { new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["Name"].ToString(), TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString()) } };
                        if (itemRow["IdSalesStatusType"].ToString() == "4")
                        {
                            if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == company.IdCompany))
                            {
                                CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == company.IdCompany).FirstOrDefault();
                                custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                            }
                            else
                            {
                                CustomerSort custsort = new CustomerSort();
                                custsort.IdCustomer = custold.IdCustomer;
                                custsort.IdSite = company.IdCompany;
                                custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                Lstsort.Add(custsort);
                            }
                        }
                        custold.Companies.Add(company);
                    }
                }
                else
                {
                    customer = new Customer();
                    customer.IdCustomer = Convert.ToInt32(itemRow["idCustomer"].ToString());
                    customer.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                    customer.CustomerName = itemRow["CustomerGroup"].ToString();
                    customer.Companies = new List<Company>();
                    Company company = new Company();
                    company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                    company.Name = itemRow["CustomerPlant"].ToString();
                    company.SiteNameWithoutCountry = itemRow["SiteName"].ToString();
                    company.Country = new Country { Name = itemRow["Country"].ToString() };

                    company.SalesStatusTypes = new List<SalesStatusType>() { new SalesStatusType { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["Name"].ToString(), TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString()) } };
                    if (itemRow["IdSalesStatusType"].ToString() == "4")
                    {
                        if (Lstsort.Any(ls => ls.IdCustomer == customer.IdCustomer && ls.IdSite == company.IdCompany))
                        {
                            CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == customer.IdCustomer && ls.IdSite == company.IdCompany).FirstOrDefault();
                            custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                        }
                        else
                        {
                            CustomerSort custsort = new CustomerSort();
                            custsort.IdCustomer = customer.IdCustomer;
                            custsort.IdSite = company.IdCompany;
                            custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                            Lstsort.Add(custsort);
                        }
                    }

                    customer.Companies.Add(company);
                    customers.Add(customer);
                }
            }


            if (customers.Count > 0)
            {
                customers[0].CustomerSorts = new List<CustomerSort>();
                customers[0].CustomerSorts.AddRange(Lstsort);
            }

            if (ds.Tables[1].Rows.Count > 0)
            {
                if (customers.Any(cust => cust.CustomerName == "OTHERS"))
                {
                    Customer custother = customers.Where(cust => cust.CustomerName == "OTHERS").FirstOrDefault();
                    foreach (DataRow itemRow in ds.Tables[1].Rows)
                    {
                        if (custother.Companies[0].SalesStatusTypes.Any(ss => ss.Name == itemRow["Name"].ToString()))
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType = custother.Companies[0].SalesStatusTypes.Where(ss => ss.Name == itemRow["Name"].ToString()).SingleOrDefault();
                            salesStatusType.TotalAmount = salesStatusType.TotalAmount + Convert.ToDouble(itemRow["Amount"].ToString());
                        }
                        else
                        {
                            SalesStatusType salesStatusType = new SalesStatusType();
                            salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                            salesStatusType.Name = itemRow["Name"].ToString();
                            salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());
                            custother.Companies[0].SalesStatusTypes.Add(salesStatusType);
                        }
                    }

                }
                else
                {
                    customer = new Customer();
                    customer.IdCustomer = 0;
                    customer.IdCompany = 0;
                    customer.CustomerName = "OTHERS";
                    customer.Companies = new List<Company>();
                    Company company = new Company();
                    company.IdCompany = 0;
                    company.Name = "";
                    company.SalesStatusTypes = new List<SalesStatusType>();
                    foreach (DataRow itemRow in ds.Tables[1].Rows)
                    {

                        SalesStatusType salesStatusType = new SalesStatusType();
                        salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                        salesStatusType.Name = itemRow["Name"].ToString();
                        salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());
                        company.SalesStatusTypes.Add(salesStatusType);
                    }
                    if (company.SalesStatusTypes.Count > 0)
                    {
                        customer.Companies.Add(company);
                        customers.Add(customer);
                    }
                }
            }

            return customers.ToList();
        }

        public IList<Offer> GetSalesStatus_V2035(byte idCurrency, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company companydetails, Int32 idCurrentUser, Int32 idUserPermission)
        {
            IList<Offer> offers = new List<Offer>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(companydetails.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetSalesStatusDateWise_V2035", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", idUserPermission);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        Offer offer = new Offer();
                        offer.IdStatus = Convert.ToInt64(offerreader["OfferStatusId"].ToString());
                        offer.Site = new Company();

                        offer.Site.ConnectPlantId = companydetails.ConnectPlantId;
                        offer.GeosStatus = new GeosStatus { Name = offerreader["OfferStatusName"].ToString(), SalesStatusType = new SalesStatusType { Name = offerreader["Status"].ToString(), IdImage = Convert.ToInt64(offerreader["StatusIdImage"].ToString()) } };
                        offer.NumberOfOffers = Convert.ToInt64(offerreader["NumberOfOffers"].ToString());
                        if (offerreader["TotalOfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["TotalOfferAmount"].ToString());
                        offer.Currency = new Currency { Name = offerreader["OfferCurrency"].ToString(), Symbol = offerreader["Symbol"].ToString() };
                        offer.Status = offerreader["Status"].ToString();

                        offers.Add(offer);
                    }
                }
            }
            IList<SalesTargetBySite> salesTargetBySites = GetSelectedUsersSalesStatusTargetDashboard(companydetails.ConnectPlantConstr, idCurrency, idUser, accountingYearFrom, accountingYearTo);
            Offer offertarget = new Offer();
            offertarget.Site = new Company();
            offertarget.Site.ConnectPlantId = companydetails.ConnectPlantId;
            offertarget.GeosStatus = new GeosStatus { SalesStatusType = new SalesStatusType { Name = "TARGET", IdImage = 0 } };
            offertarget.Status = "TARGET";
            offertarget.Value = Convert.ToDouble(salesTargetBySites[0].TargetAmount);
            offertarget.Currency = new Currency { Name = salesTargetBySites[0].CurrencyConversion.CurrencyFrom.Name, Symbol = salesTargetBySites[0].CurrencyConversion.CurrencyFrom.Symbol };
            offers.Add(offertarget);

            return offers;
        }

        public CustomerTargetDetail GetTop5CustomersDashboardDetails_V2035(byte idCurrency, Int32 idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Company companyDetails, string assignedPlant, bool isTarget = false)
        {
            CustomerTargetDetail customerTargetDetail = new CustomerTargetDetail();
            customerTargetDetail.CustomerDetail = new List<CustomerDetail>();
            List<CompanyDetail> companiesSortLst = new List<CompanyDetail>();
            List<CustomerSort> Lstsort = new List<CustomerSort>();
            CustomerDetail customer = new CustomerDetail();


            using (MySqlConnection conoffertarget = new MySqlConnection(companyDetails.ConnectPlantConstr))
            {
                conoffertarget.Open();
                MySqlCommand concompaniescommand = new MySqlCommand("CRM_GetTop5CustomersDashboardDetails_V2035", conoffertarget);
                concompaniescommand.CommandType = CommandType.StoredProcedure;
                concompaniescommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                concompaniescommand.Parameters.AddWithValue("_idCurrentUser", idUser);
                concompaniescommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                concompaniescommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                concompaniescommand.Parameters.AddWithValue("_isTarget", isTarget);
                concompaniescommand.Parameters.AddWithValue("_assignedPlant", assignedPlant);

                using (MySqlDataReader itemRow = concompaniescommand.ExecuteReader())
                {
                    while (itemRow.Read())
                    {
                        if (customerTargetDetail.CustomerDetail.Any(cust => cust.IdCustomer == Convert.ToInt32(itemRow["idCustomer"].ToString())))
                        {
                            CustomerDetail custold = new CustomerDetail();
                            custold = customerTargetDetail.CustomerDetail.Where(cust => cust.IdCustomer == Convert.ToInt32(itemRow["idCustomer"].ToString())).SingleOrDefault();
                            if (custold.Companies.Any(comp => comp.IdCompany == Convert.ToInt32(itemRow["IdSite"].ToString())))
                            {
                                CompanyDetail compold = new CompanyDetail();
                                compold = custold.Companies.Where(comp => comp.IdCompany == Convert.ToInt32(itemRow["IdSite"].ToString())).SingleOrDefault();
                                if (compold.SalesStatusTypeDetail.Any(ss => ss.Name == itemRow["Name"].ToString()))
                                {
                                    SalesStatusTypeDetail salesStatusType = new SalesStatusTypeDetail();
                                    salesStatusType = compold.SalesStatusTypeDetail.Where(ss => ss.Name == itemRow["Name"].ToString()).SingleOrDefault();
                                    salesStatusType.TotalAmount = salesStatusType.TotalAmount + Convert.ToDouble(itemRow["Amount"].ToString());
                                    if (salesStatusType.IdSalesStatusType == 4)
                                    {
                                        if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany))
                                        {
                                            CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany).FirstOrDefault();
                                            custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                        }
                                        else
                                        {
                                            CustomerSort custsort = new CustomerSort();
                                            custsort.IdCustomer = custold.IdCustomer;
                                            custsort.IdSite = compold.IdCompany;
                                            custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                            Lstsort.Add(custsort);
                                        }

                                    }
                                }
                                else
                                {
                                    SalesStatusTypeDetail salesStatusType = new SalesStatusTypeDetail();
                                    salesStatusType.IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString());
                                    salesStatusType.Name = itemRow["Name"].ToString();
                                    salesStatusType.TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString());

                                    compold.SalesStatusTypeDetail.Add(salesStatusType);
                                    if (salesStatusType.IdSalesStatusType == 4)
                                    {
                                        if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany))
                                        {
                                            CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == compold.IdCompany).FirstOrDefault();
                                            custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                        }
                                        else
                                        {
                                            CustomerSort custsort = new CustomerSort();
                                            custsort.IdCustomer = custold.IdCustomer;
                                            custsort.IdSite = compold.IdCompany;
                                            custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                            Lstsort.Add(custsort);
                                        }
                                    }
                                }

                            }
                            else
                            {
                                CompanyDetail company = new CompanyDetail();
                                company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                                company.Name = itemRow["CustomerPlant"].ToString();
                                company.SiteNameWithoutCountry = itemRow["SiteName"].ToString();
                                company.CountryName = itemRow["Country"].ToString();

                                company.SalesStatusTypeDetail = new List<SalesStatusTypeDetail>() { new SalesStatusTypeDetail { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["Name"].ToString(), TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString()) } };
                                if (itemRow["IdSalesStatusType"].ToString() == "4")
                                {
                                    if (Lstsort.Any(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == company.IdCompany))
                                    {
                                        CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == custold.IdCustomer && ls.IdSite == company.IdCompany).FirstOrDefault();
                                        custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                    }
                                    else
                                    {
                                        CustomerSort custsort = new CustomerSort();
                                        custsort.IdCustomer = custold.IdCustomer;
                                        custsort.IdSite = company.IdCompany;
                                        custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                        Lstsort.Add(custsort);
                                    }
                                }
                                custold.Companies.Add(company);
                            }
                        }
                        else
                        {
                            customer = new CustomerDetail();
                            customer.IdCustomer = Convert.ToInt32(itemRow["idCustomer"].ToString());
                            customer.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                            customer.CustomerName = itemRow["CustomerGroup"].ToString();
                            customer.Companies = new List<CompanyDetail>();
                            CompanyDetail company = new CompanyDetail();
                            company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                            company.Name = itemRow["CustomerPlant"].ToString();
                            company.SiteNameWithoutCountry = itemRow["SiteName"].ToString();
                            company.CountryName = itemRow["Country"].ToString();

                            company.SalesStatusTypeDetail = new List<SalesStatusTypeDetail>() { new SalesStatusTypeDetail { IdSalesStatusType = Convert.ToInt64(itemRow["IdSalesStatusType"].ToString()), Name = itemRow["Name"].ToString(), TotalAmount = Convert.ToDouble(itemRow["Amount"].ToString()) } };
                            if (itemRow["IdSalesStatusType"].ToString() == "4")
                            {
                                if (Lstsort.Any(ls => ls.IdCustomer == customer.IdCustomer && ls.IdSite == company.IdCompany))
                                {
                                    CustomerSort custsort = Lstsort.Where(ls => ls.IdCustomer == customer.IdCustomer && ls.IdSite == company.IdCompany).FirstOrDefault();
                                    custsort.Amount = custsort.Amount + Convert.ToDouble(itemRow["Amount"].ToString());
                                }
                                else
                                {
                                    CustomerSort custsort = new CustomerSort();
                                    custsort.IdCustomer = customer.IdCustomer;
                                    custsort.IdSite = company.IdCompany;
                                    custsort.Amount = Convert.ToDouble(itemRow["Amount"].ToString());
                                    Lstsort.Add(custsort);
                                }
                            }

                            customer.Companies.Add(company);
                            customerTargetDetail.CustomerDetail.Add(customer);
                        }
                    }

                    if (customerTargetDetail.CustomerDetail.Count > 0)
                    {
                        customerTargetDetail.CustomerDetail[0].CustomerSort = new List<CustomerSort>();
                        customerTargetDetail.CustomerDetail[0].CustomerSort.AddRange(Lstsort);
                    }

                    if (isTarget)
                    {

                        if (itemRow.NextResult())
                        {
                            customerTargetDetail.TargetDetail = new List<TargetDetail>();
                            while (itemRow.Read())
                            {
                                TargetDetail company = new TargetDetail();
                                company.IdSite = Convert.ToInt32(itemRow["IdSite"].ToString());
                                company.CustomerName = itemRow["CustomerName"].ToString();
                                company.CountryName = itemRow["CustomerCountry"].ToString();
                                company.CustomerGroup = itemRow["CustomerGroup"].ToString();

                                if (itemRow["TargetAmount"] != DBNull.Value)
                                    company.TargetAmount = Convert.ToDecimal(itemRow["TargetAmount"].ToString());

                                if (itemRow["TargetAmountWithExchangeRate"] != DBNull.Value)
                                    company.TargetAmountWithExchangeRate = Convert.ToDecimal(itemRow["TargetAmountWithExchangeRate"].ToString());

                                if (itemRow["TargetSalesIdCurrency"] != DBNull.Value)
                                    company.TargetIdCurrency = Convert.ToByte(itemRow["TargetSalesIdCurrency"].ToString());

                                company.CurrencyName = itemRow["TargetSalesCurrency"].ToString();
                                company.Symbol = itemRow["TargetSalesCurrencySymbol"].ToString();
                                if (itemRow["Year"] != DBNull.Value)
                                    company.Year = Convert.ToInt32(itemRow["Year"].ToString());


                                customerTargetDetail.TargetDetail.Add(company);
                            }
                        }
                    }
                }
            }

            return customerTargetDetail;
        }


        public List<SalesUserWon> GetAllSalesTeamUserWonDetail_V2035(Company company, byte idCurrency, string idUser, DateTime accountingYearFrom, DateTime accountingYearTo, Int32 idCurrentUser)
        {
            List<SalesUserWon> salesUserWons = new List<SalesUserWon>();

            using (MySqlConnection conSalesUser = new MySqlConnection(company.ConnectPlantConstr))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("CRM_GetAllSalesTeamUserWonDetail_V2035", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conSalesUsercommand.Parameters.AddWithValue("_idSalesUser", idUser);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conSalesUsercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                conSalesUsercommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);
                using (MySqlDataReader salesUserreader = conSalesUsercommand.ExecuteReader())
                {
                    while (salesUserreader.Read())
                    {
                        SalesUserWon salesUserWon = new SalesUserWon();
                        if (salesUserreader["Amount"] != DBNull.Value)
                            salesUserWon.Amount = Convert.ToDouble(salesUserreader["Amount"].ToString());

                        if (salesUserreader["OfferCurrency"] != DBNull.Value)
                            salesUserWon.Currency = salesUserreader["OfferCurrency"].ToString();

                        if (salesUserreader["idsalesresponsible"] != DBNull.Value)
                            salesUserWon.Idsalesresponsible = Convert.ToInt32(salesUserreader["idsalesresponsible"].ToString());

                        if (salesUserreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            salesUserWon.IdSalesResponsibleAssemblyBU = Convert.ToInt32(salesUserreader["IdSalesResponsibleAssemblyBU"].ToString());

                        if (salesUserreader["IdSalesOwner"] != DBNull.Value)
                            salesUserWon.IdSalesOwner = Convert.ToInt32(salesUserreader["IdSalesOwner"].ToString());

                        salesUserWons.Add(salesUserWon);
                    }
                }
            }

            return salesUserWons;
        }

        public BusinessUnitTargetDetail GetBusinessUnitStatusWithTarget_V2035(byte idCurrency, string assignedPlant, DateTime accountingYearFrom, DateTime accountingYearTo, Int32 idCurrentUser, Company company, bool isTarget = false)
        {
            BusinessUnitTargetDetail businessUnitTargetDetail = new BusinessUnitTargetDetail();
            businessUnitTargetDetail.BusinessUnitDetail = new List<BusinessUnitDetail>();
            try
            {
                using (MySqlConnection consite = new MySqlConnection(company.ConnectPlantConstr))
                {
                    consite.Open();
                    MySqlCommand consitecommand = new MySqlCommand("CRM_GetBusinessUnitStatusWithTarget_V2035", consite);
                    consitecommand.CommandType = CommandType.StoredProcedure;
                    consitecommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                    consitecommand.Parameters.AddWithValue("_assignedPlant", assignedPlant);
                    consitecommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                    consitecommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);
                    consitecommand.Parameters.AddWithValue("_isTarget", isTarget);
                    consitecommand.Parameters.AddWithValue("_idCurrentUser", idCurrentUser);

                    using (MySqlDataReader sitereader = consitecommand.ExecuteReader())
                    {
                        while (sitereader.Read())
                        {
                            if (sitereader["IdBusinessUnit"] != DBNull.Value)
                            {
                                if (businessUnitTargetDetail.BusinessUnitDetail.Any(lv => lv.IdLookupValue == Convert.ToInt32(sitereader["IdBusinessUnit"].ToString())))
                                {
                                    BusinessUnitDetail lookupValue = businessUnitTargetDetail.BusinessUnitDetail.Where(lv => lv.IdLookupValue == Convert.ToInt32(sitereader["IdBusinessUnit"].ToString())).FirstOrDefault();
                                    SalesStatusTypeDetail salesStatusType = new SalesStatusTypeDetail();
                                    if (sitereader["IdSalesStatusType"] != DBNull.Value)
                                        salesStatusType.IdSalesStatusType = Convert.ToInt64(sitereader["IdSalesStatusType"].ToString());
                                    if (sitereader["Status"] != DBNull.Value)
                                        salesStatusType.Name = sitereader["Status"].ToString();
                                    if (sitereader["Amount"] != DBNull.Value)
                                        salesStatusType.TotalAmount = Convert.ToDouble(sitereader["Amount"].ToString());
                                    if (sitereader["IdCurrency"] != DBNull.Value)
                                    {

                                        salesStatusType.IdCurrency = Convert.ToByte(sitereader["IdCurrency"].ToString());
                                        salesStatusType.Name = sitereader["Currency"].ToString();
                                    }
                                    lookupValue.SalesStatusTypeDetail.Add(salesStatusType);
                                }
                                else
                                {
                                    BusinessUnitDetail lookupValue = new BusinessUnitDetail();
                                    lookupValue.IdLookupValue = Convert.ToInt32(sitereader["IdBusinessUnit"].ToString());
                                    lookupValue.Value = sitereader["BusinessUnit"].ToString();
                                    lookupValue.SalesStatusTypeDetail = new List<SalesStatusTypeDetail>();
                                    SalesStatusTypeDetail salesStatusType = new SalesStatusTypeDetail();
                                    if (sitereader["IdSalesStatusType"] != DBNull.Value)
                                        salesStatusType.IdSalesStatusType = Convert.ToInt64(sitereader["IdSalesStatusType"].ToString());
                                    if (sitereader["Status"] != DBNull.Value)
                                        salesStatusType.Name = sitereader["Status"].ToString();
                                    if (sitereader["Amount"] != DBNull.Value)
                                        salesStatusType.TotalAmount = Convert.ToDouble(sitereader["Amount"].ToString());
                                    if (sitereader["IdCurrency"] != DBNull.Value)
                                    {
                                        salesStatusType.IdCurrency = Convert.ToByte(sitereader["IdCurrency"].ToString());
                                        salesStatusType.Name = sitereader["Currency"].ToString();
                                    }
                                    lookupValue.SalesStatusTypeDetail.Add(salesStatusType);
                                    businessUnitTargetDetail.BusinessUnitDetail.Add(lookupValue);
                                }
                            }
                        }
                        if (isTarget)
                        {
                            if (sitereader.NextResult())
                            {
                                businessUnitTargetDetail.TargetDetail = new List<BusinessUnitDetail>();
                                while (sitereader.Read())
                                {
                                    if (sitereader["IdBusinessUnit"] != DBNull.Value)
                                    {
                                        BusinessUnitDetail lookupValue = new BusinessUnitDetail();
                                        if (sitereader["IdBusinessUnit"] != DBNull.Value)
                                            lookupValue.IdLookupValue = Convert.ToInt32(sitereader["IdBusinessUnit"].ToString());
                                        if (sitereader["Value"] != DBNull.Value)
                                            lookupValue.Value = sitereader["Value"].ToString();
                                        if (sitereader["SalesQuotaAmount"] != DBNull.Value)
                                            lookupValue.Amount = Convert.ToDouble(sitereader["SalesQuotaAmount"].ToString());
                                        if (sitereader["IdSalesQuotaCurrency"] != DBNull.Value)
                                            lookupValue.IdCurrency = Convert.ToByte(sitereader["IdSalesQuotaCurrency"].ToString());
                                        businessUnitTargetDetail.TargetDetail.Add(lookupValue);
                                    }
                                }
                            }
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                throw;
            }
            return businessUnitTargetDetail;
        }


        public List<Offer> GetArticlesReportDetails_V2035(string connectionString, Int32 idActiveUser, Company company, DateTime fromDate, DateTime toDate, byte idCurrency, string idArticles)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection connOffersByIdSiteForActivities = new MySqlConnection(company.ConnectPlantConstr))
            {
                connOffersByIdSiteForActivities.Open();
                MySqlCommand offersCommand = new MySqlCommand("CRM_GetArticlesReportDetails_V2035", connOffersByIdSiteForActivities);
                offersCommand.CommandType = CommandType.StoredProcedure;

                offersCommand.Parameters.AddWithValue("_IdActiveUser", idActiveUser);
                offersCommand.Parameters.AddWithValue("_FromDate", fromDate);
                offersCommand.Parameters.AddWithValue("_ToDate", toDate);
                offersCommand.Parameters.AddWithValue("_IdCurrency", idCurrency);
                offersCommand.Parameters.AddWithValue("_IdArticles", idArticles);

                using (MySqlDataReader reader = offersCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            Offer offer = new Offer();

                            offer.IdOffer = Convert.ToInt64(reader["idoffer"]);
                            offer.Code = reader["OfferCode"].ToString();

                            offer.Site = new Company();
                            offer.Site.IdCompany = Convert.ToInt32(reader["IdSite"].ToString());
                            offer.Site.Name = Convert.ToString(reader["SiteName"]);
                            offer.Site.ConnectPlantId = company.ConnectPlantId;
                            offer.Site.Alias = company.Alias;
                            offer.Site.ShortName = company.ShortName;
                            offer.Site.Country = new Country { Zone = new Zone { Name = Convert.ToString(reader["CustomerZone"]) } };

                            offer.Site.Customer = new Customer();
                            offer.Site.Customer.IdCustomer = Convert.ToInt32(reader["IdCustomer"].ToString());
                            offer.Site.Customer.CustomerName = Convert.ToString(reader["CustomerName"]);

                            offer.Quotations = new List<Quotation>();
                            Quotation quot = new Quotation();
                            quot.IdQuotation = Convert.ToInt32(reader["IdQuotation"]);

                            quot.Template = new Template();
                            quot.Template.IdTemplate = Convert.ToByte(reader["IdDetectionsTemplate"]);
                            quot.Template.Name = Convert.ToString(reader["TemplateName"]);
                            quot.Template.Type = Convert.ToInt64(reader["TemplateType"]);

                            quot.Ots = new List<Ots>();
                            Ots ot = new Ots();
                            ot.Code = Convert.ToString(reader["OTCode"]);
                            ot.NumOT = Convert.ToByte(reader["NumOT"]);

                            ot.OtItems = new List<OtItem>();
                            OtItem otitem = new OtItem();
                            otitem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                            otitem.RevisionItem = new RevisionItem();
                            otitem.RevisionItem.IdRevisionItem = Convert.ToInt64(reader["IdRevisionItem"]);

                            otitem.RevisionItem.NumItem = Convert.ToString(reader["NumItem"]);

                            otitem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                            otitem.RevisionItem.WarehouseProduct.Article = new Article();

                            if (reader["IdArticle"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                            if (reader["IsObsolete"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.IsObsolete = Convert.ToSByte(reader["IsObsolete"]);

                            if (reader["Reference"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.Reference = Convert.ToString(reader["Reference"]);

                            if (reader["ArticleDescription"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.Description = Convert.ToString(reader["ArticleDescription"]);

                            if (reader["Quantity"] != DBNull.Value)
                                otitem.RevisionItem.Quantity = Convert.ToDecimal(reader["Quantity"]);

                            if (reader["DeliveryDate"] != DBNull.Value)
                                otitem.ShippingDate = Convert.ToDateTime(reader["DeliveryDate"]);

                            otitem.RevisionItem.WarehouseProduct.Article.ArticleBySupplier = new ArticleBySupplier();

                            if (reader["ConvertedCostPrice"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.ArticleBySupplier.CostPrice = Convert.ToDouble(reader["ConvertedCostPrice"]);

                            otitem.RevisionItem.WarehouseProduct.Article.ArticleBySupplier.ArticleSupplier = new ArticleSupplier();

                            if (reader["ArticleSupplierName"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.ArticleBySupplier.ArticleSupplier.Name = Convert.ToString(reader["ArticleSupplierName"]);

                            if (reader["ConvertedSellPrice"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.SellPrice = Convert.ToDouble(reader["ConvertedSellPrice"]);

                            ot.OtItems.Add(otitem);
                            quot.Ots.Add(ot);
                            offer.Quotations.Add(quot);
                            offers.Add(offer);
                        }
                    }
                }
            }

            return offers;
        }


        public List<Offer> GetAllOfferReportDetails_V2035(string idSalesOwner, DateTime fromDate, DateTime toDate, string idbusinessUnit, string idSite, byte idCurrency, Company company, string idContacts)
        {
            List<Offer> offers = new List<Offer>();
            DataSet ds = new DataSet();
            using (MySqlConnection conSalesUser = new MySqlConnection(company.ConnectPlantConstr))
            {
                conSalesUser.Open();
                MySqlCommand conSalesUsercommand = new MySqlCommand("CRM_GetOfferReportDetails_V2035", conSalesUser);
                conSalesUsercommand.CommandType = CommandType.StoredProcedure;
                conSalesUsercommand.Parameters.AddWithValue("_idSalesOwner", idSalesOwner);
                conSalesUsercommand.Parameters.AddWithValue("_fromDate", fromDate);
                conSalesUsercommand.Parameters.AddWithValue("_toDate", toDate);
                conSalesUsercommand.Parameters.AddWithValue("_idbusinessUnit", idbusinessUnit);
                conSalesUsercommand.Parameters.AddWithValue("_idSite", idSite);
                conSalesUsercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conSalesUsercommand.Parameters.AddWithValue("_idContacts", idContacts);

                MySqlDataAdapter da = new MySqlDataAdapter(conSalesUsercommand);
                da.Fill(ds);
            }

            foreach (DataRow itemRow in ds.Tables[0].Rows)
            {
                Offer offer = new Offer();
                if (itemRow["IdOffer"] != DBNull.Value)
                    offer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());

                offer.Code = itemRow["Code"].ToString();
                offer.Title = itemRow["OfferTitle"].ToString();
                offer.Description = itemRow["OfferTitle"].ToString();

                if (itemRow["IdSite"] != DBNull.Value)
                {
                    offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };
                    offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };
                }
                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                if (itemRow["PoReceptionDate"] != DBNull.Value)
                    offer.DeliveryDate = Convert.ToDateTime(itemRow["PoReceptionDate"].ToString());
                else
                    offer.DeliveryDate = null;

                if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                    offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());
                offer.ReportGroup = itemRow["ReportGroup"].ToString();
                offers.Add(offer);
            }

            foreach (DataRow itemRow in ds.Tables[1].Rows)
            {
                Offer offer = new Offer();
                if (itemRow["IdOffer"] != DBNull.Value)
                    offer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());

                offer.Code = itemRow["Code"].ToString();
                offer.Title = itemRow["OfferTitle"].ToString();
                offer.Description = itemRow["OfferTitle"].ToString();
                offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };
                offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };
                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                    offer.DeliveryDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString());
                else
                    offer.DeliveryDate = null;

                if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                    offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());
                offer.ReportGroup = itemRow["ReportGroup"].ToString();
                offers.Add(offer);
            }

            foreach (DataRow itemRow in ds.Tables[2].Rows)
            {
                Offer offer = new Offer();
                if (itemRow["IdOffer"] != DBNull.Value)
                    offer.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());

                offer.Code = itemRow["Code"].ToString();
                offer.Title = itemRow["OfferTitle"].ToString();
                offer.Description = itemRow["OfferTitle"].ToString();
                offer.Site = new Company { IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString()), Name = itemRow["SiteName"].ToString() };
                offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString()), CustomerName = itemRow["CustomerGroup"].ToString() } };
                offer.Value = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                    offer.DeliveryDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString());
                else
                    offer.DeliveryDate = null;

                if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                    offer.ProbabilityOfSuccess = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());
                offer.ReportGroup = itemRow["ReportGroup"].ToString();
                offers.Add(offer);
            }

            return offers;
        }


        public Offer GetOfferDetailsById_V2035(Int64 idOffer, Int32 idUser, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, Company company, string workingOrdersPath)
        {
            Offer offer = new Offer();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(company.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetOfferDetailsByIdDateWise_V2035", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_offerId", idOffer);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (offerreader.Read())
                    {
                        offer.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());

                        if (offerreader["IdSalesOwner"] != DBNull.Value)
                        {
                            offer.IdSalesOwner = Convert.ToInt32(offerreader["IdSalesOwner"].ToString());
                            offer.SalesOwner = new People { IdPerson = Convert.ToInt32(offerreader["IdSalesOwner"].ToString()), Name = offerreader["OfferSalesOwnerName"].ToString(), Surname = offerreader["OfferSalesOwnerSurName"].ToString(), Email = Convert.ToString(offerreader["OfferSalesOwnerEmail"]) };
                        }

                        offer.IdOfferType = Convert.ToByte(offerreader["idOfferType"].ToString());
                        offer.Code = offerreader["OfferCode"].ToString();
                        offer.Number = Convert.ToInt64(offerreader["number"].ToString());
                        offer.Year = Convert.ToInt64(offerreader["OfferYear"].ToString());
                        offer.IdCustomer = Convert.ToInt32(offerreader["IdSite"].ToString());
                        offer.IdStatus = Convert.ToByte(offerreader["IdStatus"].ToString());

                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToByte(offerreader["IdStatus"].ToString()), Name = offerreader["OfferStatus"].ToString() };

                        if (offerreader["IdSalesStatusType"] != DBNull.Value)
                        {
                            offer.GeosStatus.IdSalesStatusType = Convert.ToByte(offerreader["IdSalesStatusType"].ToString());

                            offer.GeosStatus.SalesStatusType = new SalesStatusType();
                            offer.GeosStatus.SalesStatusType.IdSalesStatusType = Convert.ToByte(offerreader["IdSalesStatusType"].ToString());
                            offer.GeosStatus.SalesStatusType.Name = offerreader["SalesStatus"].ToString();
                        }

                        offer.IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString());
                        offer.ModifiedBy = Convert.ToInt32(offerreader["ModifiedBy"].ToString());

                        if (offerreader["IdBusinessUnit"] != DBNull.Value)
                            offer.IdBusinessUnit = Convert.ToByte(offerreader["IdBusinessUnit"].ToString());

                        if (offerreader["IdSource"] != DBNull.Value)
                            offer.IdSource = Convert.ToByte(offerreader["IdSource"].ToString());

                        offer.Description = offerreader["OfferTitle"].ToString();
                        offer.Site = new Company() { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["SiteName"].ToString().Trim(), Country = new Country { Name = offerreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offerreader["CustomerZone"].ToString() } } };
                        offer.Site.ConnectPlantId = company.ConnectPlantId;
                        offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } };

                        if (offerreader["OfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["OfferAmount"].ToString());

                        if (offerreader["IdProject"] != DBNull.Value)
                            offer.IdProject = Convert.ToInt32(offerreader["IdProject"].ToString());

                        if (offerreader["IdCarProject"] != DBNull.Value)
                            offer.IdCarProject = Convert.ToInt32(offerreader["IdCarProject"].ToString());

                        if (offerreader["OfferConfidentialLevel"] != DBNull.Value)
                            offer.ProbabilityOfSuccess = Convert.ToSByte(offerreader["OfferConfidentialLevel"].ToString());

                        if (offerreader["OfferExpectedDate"] != DBNull.Value)
                            offer.OfferExpectedDate = Convert.ToDateTime(offerreader["OfferExpectedDate"].ToString());
                        else
                            offer.OfferExpectedDate = null;

                        if (offerreader["RFQReception"] != DBNull.Value)
                            offer.RFQReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        else
                            offer.RFQReception = null;

                        if (offerreader["sendIn"] != DBNull.Value)
                            offer.SendIn = Convert.ToDateTime(offerreader["sendIn"].ToString());
                        else
                            offer.SendIn = null;

                        if (offerreader["DeliveryDate"] != DBNull.Value)
                            offer.DeliveryDate = Convert.ToDateTime(offerreader["DeliveryDate"].ToString());
                        else
                            offer.DeliveryDate = null;

                        if (offerreader["otsDeliveryDate"] != DBNull.Value)
                            offer.OTSDeliveryDate = Convert.ToDateTime(offerreader["otsDeliveryDate"].ToString());
                        else
                            offer.OTSDeliveryDate = null;

                        if (offerreader["POReceivedInDate"] != DBNull.Value)
                            offer.POReceivedInDate = Convert.ToDateTime(offerreader["POReceivedInDate"].ToString());
                        else
                            offer.POReceivedInDate = null;

                        offer.Rfq = offerreader["Rfq"].ToString();
                        offer.Comments = offerreader["Comments"].ToString();
                        offer.Currency = new Currency { IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString()), Name = offerreader["CurrencyName"].ToString() };

                        if (offerreader["ModifiedIn"].ToString() == "01/01/1000 0:00:00")
                        {
                            offer.ModifiedIn = null;
                        }
                        else
                        {
                            offer.ModifiedIn = Convert.ToDateTime(offerreader["ModifiedIn"].ToString());
                        }

                        if (offerreader["CreatedIn"] != DBNull.Value)
                            offer.CreatedIn = Convert.ToDateTime(offerreader["CreatedIn"].ToString());

                        if (offerreader["IdCarOEM"] != DBNull.Value)
                            offer.IdCarOEM = Convert.ToInt32(offerreader["IdCarOEM"].ToString());

                        if (offerreader["OfferedBy"] != DBNull.Value)
                        {
                            offer.OfferedBy = Convert.ToInt32(offerreader["OfferedBy"]);
                            offer.OfferedByPerson = new People { IdPerson = Convert.ToInt32(offer.OfferedBy), Name = Convert.ToString(offerreader["OfferedByName"]), Surname = Convert.ToString(offerreader["OfferedBySurName"]), Email = Convert.ToString(offerreader["OfferedByEmail"]) };
                        }

                        if (offerreader["IsManualCategory"] != DBNull.Value)
                        {
                            offer.IsManualCategory = Convert.ToSByte(offerreader["IsManualCategory"]);
                        }

                        if (offerreader["IdProductCategory"] != DBNull.Value)
                        {
                            offer.IdProductCategory = Convert.ToInt64(offerreader["IdProductCategory"]);
                        }

                        if (offerreader["IdProductCategory"] != DBNull.Value)
                        {
                            offer.ProductCategory = new ProductCategory();

                            offer.ProductCategory.IdProductCategory = Convert.ToInt64(offerreader["IdProductCategory"]);
                            offer.ProductCategory.Name = offerreader["ProductSubCategory"].ToString();

                            if (offerreader["IdProductCategory"] != DBNull.Value)
                            {
                                offer.ProductCategory.Category = new ProductCategory();
                                if (offerreader["IdCategory"] != DBNull.Value)
                                    offer.ProductCategory.Category.IdProductCategory = Convert.ToInt64(offerreader["IdCategory"].ToString());
                                offer.ProductCategory.Category.Name = offerreader["ProductCategory"].ToString();
                            }
                        }

                        if (offerreader["AssignedTo"] != DBNull.Value)
                        {
                            offer.AssignedTo = Convert.ToInt32(offerreader["AssignedTo"]);
                            offer.AssignedToPerson = new People { IdPerson = Convert.ToInt32(offer.AssignedTo), Name = Convert.ToString(offerreader["AssignedName"]), Surname = Convert.ToString(offerreader["AssignedSurName"]), Email = Convert.ToString(offerreader["AssignedEmail"]) };
                        }

                        if (offerreader["OfferValue"] != DBNull.Value)
                            offer.OfferValue = Convert.ToDouble(offerreader["OfferValue"].ToString());

                        if (offerreader["IdOfferCurrency"] != DBNull.Value)
                            offer.IdOfferCurrency = Convert.ToByte(offerreader["IdOfferCurrency"].ToString());

                        if (offerreader["IsGoAheadProduction"] != DBNull.Value)
                            offer.IsGoAheadProduction = Convert.ToBoolean(offerreader["IsGoAheadProduction"]);

                        offer.OptionsByOffers = new List<OptionsByOffer>();
                        using (MySqlConnection conoptionsbyoffer = new MySqlConnection(company.ConnectPlantConstr))
                        {
                            conoptionsbyoffer.Open();
                            MySqlCommand conoptionsbyoffercommand = new MySqlCommand("optionsbyoffer_GetOptionsByOfferId", conoptionsbyoffer);
                            conoptionsbyoffercommand.CommandType = CommandType.StoredProcedure;
                            conoptionsbyoffercommand.Parameters.AddWithValue("_offerId", offer.IdOffer);
                            using (MySqlDataReader optionsbyofferreader = conoptionsbyoffercommand.ExecuteReader())
                            {
                                while (optionsbyofferreader.Read())
                                {

                                    OptionsByOffer optionsbyoffer = new OptionsByOffer();
                                    optionsbyoffer.IdOffer = Convert.ToInt64(optionsbyofferreader["IdOffer"].ToString());
                                    optionsbyoffer.IdOption = Convert.ToInt64(optionsbyofferreader["IdOption"].ToString());
                                    if (optionsbyofferreader["Quantity"] != DBNull.Value)
                                    {
                                        optionsbyoffer.Quantity = Convert.ToInt32(optionsbyofferreader["Quantity"].ToString());
                                        if (optionsbyoffer.Quantity > 0)
                                            optionsbyoffer.IsSelected = true;
                                        else
                                            optionsbyoffer.IsSelected = false;
                                    }
                                    else
                                    {
                                        optionsbyoffer.IsSelected = false;
                                    }
                                    optionsbyoffer.OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(optionsbyofferreader["IdOption"].ToString()), Name = optionsbyofferreader["offeroption"].ToString(), OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(optionsbyofferreader["IdOfferOptionType"].ToString()), Name = optionsbyofferreader["offeroptiontype"].ToString() } };

                                    if (offer.OptionsByOffers.Any(obo => obo.IdOffer == optionsbyoffer.IdOffer && obo.IdOption == optionsbyoffer.IdOption))
                                    {

                                    }
                                    else
                                    {
                                        offer.OptionsByOffers.Add(optionsbyoffer);
                                    }
                                }
                            }


                            if (offer.OptionsByOffers.Any(x => x.IdOption == 25))
                            {
                                List<Quotation> quotationByIdOffer = GetOfferQuotationByIdOffer(offer.IdOffer, company.ConnectPlantConstr).ToList();

                                Quotation quot = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == 23);

                                if (quot != null)
                                {
                                    EngineeringAnalysis engineeringAnalysis = new EngineeringAnalysis();
                                    Ots ot = GetOTByQuotationId(quot, company.ConnectPlantConstr);

                                    if (ot != null)
                                    {
                                        engineeringAnalysis.DueDate = ot.DeliveryDate.Value;

                                        List<OtItem> otitems = GetOtItemsByIdOT(ot, company.ConnectPlantConstr);
                                        if (otitems.Count > 0)
                                        {
                                            engineeringAnalysis.Comments = otitems[0].CustomerComment;

                                            //If Analysis status is shipped then iscompleted is true.
                                            if (otitems[0].Status.IdItemOtStatus == 10)
                                            {
                                                engineeringAnalysis.IsCompleted = true;
                                            }
                                        }
                                    }

                                    engineeringAnalysis.Attachments = new List<Attachment>();

                                    string path = workingOrdersPath + @"\" + offer.Year + @"\" + offer.Code + @"\01 Project Specifications\";
                                    if (Directory.Exists(path))
                                    {
                                        string[] files = Directory.GetFiles(path);

                                        foreach (string file in files)
                                        {
                                            Attachment attachment = new Attachment();
                                            attachment.OriginalFileName = Path.GetFileName(file);
                                            attachment.FilePath = Path.GetFullPath(file);
                                            engineeringAnalysis.Attachments.Add(attachment);
                                        }
                                    }

                                    offer.EngineeringAnalysis = engineeringAnalysis;
                                }
                            }
                        }

                        offer.OfferStatusTracking = new List<OfferStatusTracking>();
                        using (MySqlConnection conofferstatus = new MySqlConnection(company.ConnectPlantConstr))
                        {
                            conofferstatus.Open();
                            MySqlCommand conofferstatuscommand = new MySqlCommand("offerstatustracking_GetOfferStatusTrackingByIdOffer", conofferstatus);
                            conofferstatuscommand.CommandType = CommandType.StoredProcedure;
                            conofferstatuscommand.Parameters.AddWithValue("_idOffer", offer.IdOffer);
                            using (MySqlDataReader offerstatusreader = conofferstatuscommand.ExecuteReader())
                            {
                                while (offerstatusreader.Read())
                                {
                                    if (offer.OfferStatusTracking.Any(ofs => ofs.SalesStatusType.IdSalesStatusType == Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString())))
                                    {
                                        OfferStatusTracking offerStatusTrackingtemp = offer.OfferStatusTracking.Where(ofs => ofs.SalesStatusType.IdSalesStatusType == Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString())).FirstOrDefault();
                                        offerStatusTrackingtemp.IdOfferStatusTracking = Convert.ToInt64(offerstatusreader["IdOfferStatusTracking"].ToString());
                                        offerStatusTrackingtemp.IdOffer = Convert.ToInt64(offerstatusreader["IdOffer"].ToString());
                                        offerStatusTrackingtemp.IdOfferStatusType = Convert.ToInt64(offerstatusreader["IdOfferStatusType"].ToString());
                                        offerStatusTrackingtemp.SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString()), Name = offerstatusreader["Name"].ToString(), HtmlColor = offerstatusreader["HtmlColor"].ToString() };
                                        offerStatusTrackingtemp.StartDate = Convert.ToDateTime(offerstatusreader["StartDate"].ToString());

                                        if (offerstatusreader["EndDate"] != DBNull.Value)
                                        {
                                            offerStatusTrackingtemp.EndDate = offerstatusreader["EndDate"].ToString();
                                        }
                                        else
                                        {
                                            offerStatusTrackingtemp.EndDate = DateTime.Now.ToString();
                                        }

                                        try
                                        {
                                            offerStatusTrackingtemp.NoOfDays = offerStatusTrackingtemp.NoOfDays + (Convert.ToDateTime(Convert.ToDateTime(offerStatusTrackingtemp.EndDate).ToString("yyyy-MM-dd")) - Convert.ToDateTime(offerStatusTrackingtemp.StartDate.ToString("yyyy-MM-dd"))).TotalDays;
                                        }
                                        catch (Exception ex)
                                        {

                                        }
                                    }
                                    else
                                    {
                                        OfferStatusTracking offerStatusTracking = new OfferStatusTracking();
                                        offerStatusTracking.IdOfferStatusTracking = Convert.ToInt64(offerstatusreader["IdOfferStatusTracking"].ToString());
                                        offerStatusTracking.IdOffer = Convert.ToInt64(offerstatusreader["IdOffer"].ToString());
                                        offerStatusTracking.IdOfferStatusType = Convert.ToInt64(offerstatusreader["IdOfferStatusType"].ToString());
                                        offerStatusTracking.SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString()), Name = offerstatusreader["Name"].ToString(), HtmlColor = offerstatusreader["HtmlColor"].ToString() };
                                        offerStatusTracking.StartDate = Convert.ToDateTime(offerstatusreader["StartDate"].ToString());

                                        if (offerstatusreader["EndDate"] != DBNull.Value)
                                        {
                                            offerStatusTracking.EndDate = offerstatusreader["EndDate"].ToString();
                                        }
                                        else
                                        {
                                            offerStatusTracking.EndDate = DateTime.Now.ToString();
                                        }

                                        try
                                        {
                                            offerStatusTracking.NoOfDays = (Convert.ToDateTime(Convert.ToDateTime(offerStatusTracking.EndDate).ToString("yyyy-MM-dd")) - Convert.ToDateTime(offerStatusTracking.StartDate.ToString("yyyy-MM-dd"))).TotalDays;
                                        }
                                        catch (Exception ex)
                                        {

                                        }

                                        offer.OfferStatusTracking.Add(offerStatusTracking);
                                    }
                                }
                            }
                        }
                    }
                }
            }


            return offer;
        }


        public List<TimelineGrid> GetTimelineGridDetails_V2036(TimelineParams timelineParams)
        {
            List<TimelineGrid> timelineGridRows = new List<TimelineGrid>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(timelineParams.connectSiteDetailParams.ConnectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetRestfulTimeData_V2036", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.CommandTimeout = 3000;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", timelineParams.idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", timelineParams.accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", timelineParams.accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", (timelineParams.Roles == RoleType.SalesAssistant) ? 20 : 22);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idEmdepSite", timelineParams.connectSiteDetailParams.idSite);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);


                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid offer = new TimelineGrid();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            if (itemRow["IdSite"] != DBNull.Value)
                            {
                                offer.IdSite = Convert.ToInt32(itemRow["IdSite"].ToString());
                            }

                            if (itemRow["IdOfferType"] != DBNull.Value)
                                offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());

                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.ConnectPlantId = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            offer.Group = itemRow["CustomerGroup"].ToString();
                            offer.Plant = itemRow["SiteName"].ToString().Trim();
                            offer.Country = itemRow["CustomerCountry"].ToString();
                            offer.Region = itemRow["CustomerZone"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                                offer.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                                offer.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());

                            offer.Status = itemRow["OfferStatus"].ToString();
                            offer.HtmlColor = itemRow["OfferStatusColor"].ToString();

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Amount = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            if (itemRow["IdSalesStatusType"] != DBNull.Value)
                                offer.IdSalesStatusType = Convert.ToInt32(itemRow["IdSalesStatusType"].ToString());

                            //  offer.Currency = itemRow["OfferCurrency"].ToString();
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.OfferConfidentialLevel = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                                offer.OfferCloseDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.OfferCloseDate = null;

                            if (itemRow["Rfq"] != DBNull.Value)
                                offer.Rfq = itemRow["Rfq"].ToString();

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RfqReceptionDate = Convert.ToDateTime(itemRow["RFQReception"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.RfqReceptionDate = null;

                            if (itemRow["OfferStatusid"] != DBNull.Value)
                                offer.OfferStatusid = Convert.ToInt32(itemRow["OfferStatusid"].ToString());

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.QuoteSentDate = Convert.ToDateTime(itemRow["SendIn"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.QuoteSentDate = null;


                            offer.Project = itemRow["CarProjectName"].ToString();
                            offer.Source = itemRow["Source"].ToString();
                            offer.BusinessUnit = itemRow["BusinessUnit"].ToString();
                            offer.Oem = itemRow["CarOEM"].ToString();

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                offer.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory = new ProductCategoryGrid();

                            }


                            offer.OptionsByOffers = new List<OptionsByOfferGrid>();
                            timelineGridRows.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            OptionsByOfferGrid optionsByOfferGrid = new OptionsByOfferGrid();
                            optionsByOfferGrid.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsByOfferGrid.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsByOfferGrid.IdOfferPlant = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsByOfferGrid.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsByOfferGrid.Quantity > 0)
                                    optionsByOfferGrid.IsSelected = true;
                                else
                                    optionsByOfferGrid.IsSelected = false;
                            }
                            else
                            {
                                optionsByOfferGrid.IsSelected = false;
                            }
                            optionsByOfferGrid.OfferOption = itemRow["offeroption"].ToString();

                            timelineGridRow.OptionsByOffers.Add(optionsByOfferGrid);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            timelineGridRow.LostCompetitor = itemRow["Name"].ToString();
                            timelineGridRow.LostDescription = itemRow["Comments"].ToString();
                            timelineGridRow.LostReason = itemRow["Reason"].ToString();

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {
                                    if (itemRow["CommentLastUpdate"] != DBNull.Value)
                                    {
                                        timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["CommentLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                    }
                                }
                            }

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {

                                    if (itemRow["ActivityLastUpdate"] != DBNull.Value)
                                    {
                                        if (timelineGridRow.LastActivityDate == null)
                                        {
                                            timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                        else
                                        {
                                            int result = Nullable.Compare<DateTime>(Convert.ToDateTime(itemRow["ActivityLastUpdate"]), Convert.ToDateTime(timelineGridRow.LastActivityDate));
                                            if (result > 0)
                                                timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                    }

                                    //if (timelineGridRow.LastActivityDate == null)
                                    //{
                                    //    timelineGridRow.LastActivityDate =Convert.ToDateTime(timelineGridRow.QuoteSentDate).ToString("dd/MM/yyyy"); 
                                    //}
                                }
                            }

                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString()), Name = itemRow["ProductSubCategory"].ToString() }; });

                                if (itemRow["IdCategory"] != DBNull.Value)
                                {
                                    timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory.IdParent = Convert.ToInt64(itemRow["IdCategory"].ToString()); u.ProductCategory.Category = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdCategory"].ToString()), Name = itemRow["Category"].ToString() }; });
                                }
                            }




                        }
                    }
                }
            }

            return timelineGridRows;
        }


        public List<TimelineGrid> GetSelectedUsersTimelineGridDetails_V2036(TimelineParams timelineParams)
        {
            List<TimelineGrid> timelineGridRows = new List<TimelineGrid>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(timelineParams.connectSiteDetailParams.ConnectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetRestfulTimeData_V2036", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.CommandTimeout = 3000;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", timelineParams.idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", timelineParams.idsSelectedUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", timelineParams.accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", timelineParams.accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idEmdepSite", timelineParams.connectSiteDetailParams.idSite);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 21);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);

                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid offer = new TimelineGrid();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            if (itemRow["IdSite"] != DBNull.Value)
                            {
                                offer.IdSite = Convert.ToInt32(itemRow["IdSite"].ToString());
                            }

                            if (itemRow["IdOfferType"] != DBNull.Value)
                                offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());

                            if (itemRow["OfferStatusid"] != DBNull.Value)
                                offer.OfferStatusid = Convert.ToInt32(itemRow["OfferStatusid"].ToString());

                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.ConnectPlantId = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            offer.Group = itemRow["CustomerGroup"].ToString();
                            offer.Plant = itemRow["SiteName"].ToString();
                            offer.Country = itemRow["CustomerCountry"].ToString();
                            offer.Region = itemRow["CustomerZone"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                                offer.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                                offer.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());

                            offer.Status = itemRow["OfferStatus"].ToString();
                            offer.HtmlColor = itemRow["OfferStatusColor"].ToString();

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Amount = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            if (itemRow["IdSalesStatusType"] != DBNull.Value)
                                offer.IdSalesStatusType = Convert.ToInt32(itemRow["IdSalesStatusType"].ToString());

                            //  offer.Currency = itemRow["OfferCurrency"].ToString();
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.OfferConfidentialLevel = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                                offer.OfferCloseDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.OfferCloseDate = null;

                            if (itemRow["Rfq"] != DBNull.Value)
                                offer.Rfq = itemRow["Rfq"].ToString();

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RfqReceptionDate = Convert.ToDateTime(itemRow["RFQReception"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.RfqReceptionDate = null;

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.QuoteSentDate = Convert.ToDateTime(itemRow["SendIn"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.QuoteSentDate = null;

                            offer.Project = itemRow["CarProjectName"].ToString();
                            offer.Source = itemRow["Source"].ToString();
                            offer.BusinessUnit = itemRow["BusinessUnit"].ToString();
                            offer.Oem = itemRow["CarOEM"].ToString();

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                offer.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory = new ProductCategoryGrid();

                            }



                            offer.OptionsByOffers = new List<OptionsByOfferGrid>();
                            timelineGridRows.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            OptionsByOfferGrid optionsByOfferGrid = new OptionsByOfferGrid();
                            optionsByOfferGrid.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsByOfferGrid.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsByOfferGrid.IdOfferPlant = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsByOfferGrid.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsByOfferGrid.Quantity > 0)
                                    optionsByOfferGrid.IsSelected = true;
                                else
                                    optionsByOfferGrid.IsSelected = false;
                            }
                            else
                            {
                                optionsByOfferGrid.IsSelected = false;
                            }
                            optionsByOfferGrid.OfferOption = itemRow["offeroption"].ToString();

                            timelineGridRow.OptionsByOffers.Add(optionsByOfferGrid);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            timelineGridRow.LostCompetitor = itemRow["Name"].ToString();
                            timelineGridRow.LostDescription = itemRow["Comments"].ToString();
                            timelineGridRow.LostReason = itemRow["Reason"].ToString();

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {
                                    if (itemRow["CommentLastUpdate"] != DBNull.Value)
                                    {
                                        timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["CommentLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                    }
                                }
                            }

                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {

                                    if (itemRow["ActivityLastUpdate"] != DBNull.Value)
                                    {
                                        if (timelineGridRow.LastActivityDate == null)
                                        {
                                            timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                        else
                                        {
                                            int result = Nullable.Compare<DateTime>(Convert.ToDateTime(itemRow["ActivityLastUpdate"]), Convert.ToDateTime(timelineGridRow.LastActivityDate));
                                            if (result > 0)
                                                timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                    }

                                }
                            }

                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString()), Name = itemRow["ProductSubCategory"].ToString() }; });

                                if (itemRow["IdCategory"] != DBNull.Value)
                                {
                                    timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory.IdParent = Convert.ToInt64(itemRow["IdCategory"].ToString()); u.ProductCategory.Category = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdCategory"].ToString()), Name = itemRow["Category"].ToString() }; });
                                }
                            }

                        }
                    }
                }
            }

            return timelineGridRows;
        }


        public List<EngineeringAnalysisType> GetEngAnalysisArticles(string connectionString)
        {
            List<EngineeringAnalysisType> engineeringAnalysisTypes = new List<EngineeringAnalysisType>();

            using (MySqlConnection connOffers = new MySqlConnection(connectionString))
            {
                connOffers.Open();
                MySqlCommand offersCommand = new MySqlCommand("CRM_GetEngAnalysisArticles", connOffers);
                offersCommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader reader = offersCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            EngineeringAnalysisType engineeringAnalysisType = new EngineeringAnalysisType();
                            if (reader["IdArticle"] != DBNull.Value)
                                engineeringAnalysisType.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                            if (reader["Reference"] != DBNull.Value)
                                engineeringAnalysisType.Reference = reader["Reference"].ToString();

                            if (reader["Quantity"] != DBNull.Value)
                                engineeringAnalysisType.Quantity = reader["Quantity"].ToString();

                            engineeringAnalysisTypes.Add(engineeringAnalysisType);
                        }
                    }
                }
            }

            return engineeringAnalysisTypes;
        }

        public List<OtItem> GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis(Int64 idOfferOption, byte idTemplate, string connectionstring, List<EngineeringAnalysisType> engineeringAnalysisTypes)
        {
            List<OtItem> items = new List<OtItem>();

            using (MySqlConnection contemplate = new MySqlConnection(connectionstring))
            {
                contemplate.Open();

                //string templatequery = "SELECT * FROM templates WHERE IdTemplate = 18;";
                MySqlCommand contemplatecommand = new MySqlCommand("GetDefaultArticlesByOfferOptionAndTemplate", contemplate);
                contemplatecommand.CommandType = CommandType.StoredProcedure;
                contemplatecommand.Parameters.AddWithValue("_IdOfferOption", idOfferOption);
                contemplatecommand.Parameters.AddWithValue("_IdTemplate", idTemplate);
                using (MySqlDataReader reader = contemplatecommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        OtItem oi = new OtItem();
                        oi.RevisionItem = new RevisionItem();
                        oi.RevisionItem.WarehouseProduct = new WarehouseProduct();
                        oi.RevisionItem.WarehouseProduct.Article = new Article();
                        oi.Status = new ItemOTStatusType();

                        oi.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(reader["idArticle"]);
                        if (engineeringAnalysisTypes != null)
                        {
                            if (engineeringAnalysisTypes.Any(eat => eat.IdArticle == oi.RevisionItem.WarehouseProduct.Article.IdArticle && eat.IsSelected == true))
                            {
                                oi.RevisionItem.WarehouseProduct.Article.Quantity = Convert.ToDouble(reader["quantity"]);
                            }
                            else
                            {
                                oi.RevisionItem.WarehouseProduct.Article.Quantity = 0;
                            }
                        }
                        else
                        {
                            oi.RevisionItem.WarehouseProduct.Article.Quantity = Convert.ToDouble(reader["quantity"]);
                        }
                        oi.RevisionItem.WarehouseProduct.Article.Description = reader["description"].ToString();
                        oi.RevisionItem.WarehouseProduct.Article.Description_es = reader["description_es"].ToString();
                        oi.RevisionItem.WarehouseProduct.Article.Description_fr = reader["description_Fr"].ToString();
                        oi.Status.IdItemOtStatus = Convert.ToUInt16(reader["idDefaultItemOtStatus"]);
                        items.Add(oi);
                    }
                }
            }

            return items;
        }

        public List<OtItem> GetDefaultArticleNotInWarehouseProduct(Int64 idQuotation, string connectionstring, List<EngineeringAnalysisType> engineeringAnalysisTypes)
        {
            List<OtItem> items = new List<OtItem>();

            using (MySqlConnection contemplate = new MySqlConnection(connectionstring))
            {
                contemplate.Open();

                //string templatequery = "SELECT * FROM templates WHERE IdTemplate = 18;";
                MySqlCommand contemplatecommand = new MySqlCommand("CRM_GetDefaultArticleNotInWarehouseProduct", contemplate);
                contemplatecommand.CommandType = CommandType.StoredProcedure;
                contemplatecommand.Parameters.AddWithValue("_IdQuotation", idQuotation);

                using (MySqlDataReader reader = contemplatecommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        OtItem oi = new OtItem();
                        oi.RevisionItem = new RevisionItem();
                        oi.RevisionItem.WarehouseProduct = new WarehouseProduct();
                        oi.RevisionItem.WarehouseProduct.Article = new Article();
                        oi.Status = new ItemOTStatusType();

                        oi.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(reader["idArticle"]);
                        if (engineeringAnalysisTypes != null)
                        {
                            if (engineeringAnalysisTypes.Any(eat => eat.IdArticle == oi.RevisionItem.WarehouseProduct.Article.IdArticle && eat.IsSelected == true))
                            {
                                oi.RevisionItem.WarehouseProduct.Article.Quantity = Convert.ToDouble(reader["quantity"]);
                            }
                            else
                            {
                                oi.RevisionItem.WarehouseProduct.Article.Quantity = 0;
                            }
                        }
                        else
                        {
                            oi.RevisionItem.WarehouseProduct.Article.Quantity = Convert.ToDouble(reader["quantity"]);
                        }
                        oi.RevisionItem.WarehouseProduct.Article.Description = reader["description"].ToString();
                        oi.RevisionItem.WarehouseProduct.Article.Description_es = reader["description_es"].ToString();
                        oi.RevisionItem.WarehouseProduct.Article.Description_fr = reader["description_Fr"].ToString();
                        oi.Status.IdItemOtStatus = Convert.ToUInt16(reader["idDefaultItemOtStatus"]);
                        items.Add(oi);
                    }
                }
            }

            return items;
        }

        public Offer AddQuotations_V2037(Offer offer, string connectionstring, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString, string WorkingOrdersPath)
        {
            try
            {
                foreach (OptionsByOffer optionsByOffer in offer.OptionsByOffers)
                {
                    List<Template> selectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                    Template selectedOptiontemplate = GetDefaultArticleByIdOfferOption(optionsByOffer.IdOption, connectionstring);
                    if (selectedOptiontemplate != null)
                        selectedOptionTemplates.Add(selectedOptiontemplate);

                    using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                    {
                        conquotation.Open();

                        using (MySqlTransaction trans = conquotation.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand conquotationcommand = new MySqlCommand("optionsbyoffer_Insert", conquotation);
                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                conquotationcommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                conquotationcommand.Parameters.AddWithValue("_Quantity", optionsByOffer.Quantity);
                                conquotationcommand.Transaction = trans;
                                conquotationcommand.ExecuteNonQuery();

                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }

                    foreach (Template quotation in selectedOptionTemplates)
                    {
                        Int64 idQuotation = 0;
                        Quotation tempquotation = new Quotation();
                        tempquotation.Offer = new Offer();
                        tempquotation.Offer.IdOffer = offer.IdOffer;
                        tempquotation.Year = DateTime.Now.Year;
                        tempquotation.Number = offer.Number;
                        tempquotation.Code = offer.Code + quotation.Suffix;
                        tempquotation.CreatedIn = DateTime.Now;
                        tempquotation.Template = new Template();
                        tempquotation.Template = quotation;

                        if (quotation.IdTemplate != 0)
                        {
                            string quotationCode = offer.Code + quotation.Suffix;
                            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                            {
                                conquotation.Open();
                                using (MySqlTransaction trans = conquotation.BeginTransaction())
                                {
                                    try
                                    {
                                        MySqlCommand conquotationcommand = new MySqlCommand("quotations_Insert", conquotation);
                                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                                        conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                        conquotationcommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                        conquotationcommand.Parameters.AddWithValue("_Description", offer.Description);
                                        conquotationcommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                        conquotationcommand.Parameters.AddWithValue("_Number", offer.Number);
                                        conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                        conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                        conquotationcommand.Parameters.AddWithValue("_QuotQuantity", 0);
                                        conquotationcommand.Transaction = trans;
                                        idQuotation = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                                        if (idQuotation > 0)
                                        {
                                            bool isinsert = false;
                                            MySqlCommand conoffercommand = new MySqlCommand("revisions_GetrevisionsByIdQuotation", conquotation);
                                            conoffercommand.CommandType = CommandType.StoredProcedure;
                                            conoffercommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                            using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                                            {
                                                if (!offerreader.Read())
                                                {
                                                    isinsert = true;
                                                }
                                            }

                                            if (isinsert)
                                            {
                                                Revision r = new Revision();
                                                r.NumRevision = 0;
                                                //[001]
                                                if (offer.CreatedBy != null && offer.CreatedBy == 164)
                                                {
                                                    r.CreatedBy = 164;
                                                    r.ReviewedBy = 164;
                                                }
                                                else
                                                {
                                                    r.CreatedBy = offer.CreatedBy;
                                                    r.ReviewedBy = offer.CreatedBy;
                                                }
                                                r.CreatedIn = DateTime.Now;
                                                r.NumRevision = 0;
                                                r.Discount = 0;
                                                r.ExpireDate = DateTime.Now.AddDays(14);
                                                r.Comments = offer.Contact + "\r\n" + offer.Description;
                                                //r.Quotation = quotation;
                                                if (quotation.IdTemplate == 15 || quotation.IdTemplate == 16 || quotation.IdTemplate == 18)
                                                    r.ApprovedIn = DateTime.Now;
                                                else
                                                    r.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");

                                                conquotationcommand = new MySqlCommand("revisions_Insert", conquotation);
                                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                                                conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r.ReviewedBy);
                                                conquotationcommand.Parameters.AddWithValue("_NumRevision", r.NumRevision);
                                                conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.CreatedBy);
                                                conquotationcommand.Parameters.AddWithValue("_MadeBy", r.CreatedBy);
                                                conquotationcommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                                conquotationcommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                                conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                                                conquotationcommand.Parameters.AddWithValue("_CreationDate", r.CreatedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_Comments", r.Comments);
                                                conquotationcommand.Parameters.AddWithValue("_Closed", r.ApprovedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Transaction = trans;
                                                r.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                tempquotation.Revisions = new List<Revision>();
                                                tempquotation.Revisions.Add(r);

                                            }
                                        }

                                        trans.Commit();
                                    }
                                    catch (Exception ex)
                                    {
                                        trans.Rollback();
                                        throw;
                                    }
                                }
                            }
                        }

                        tempquotation.IdQuotation = idQuotation;
                        ///////////////////////////////////////////////////////
                        if (offer.IdOfferType != 10 && quotation.IdTemplate == 15)
                        {
                            List<OtItem> items = new List<OtItem>();

                            List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                            items.AddRange(temp);

                            if (items.Count != 0)
                                CreateQuotationWithItems(tempquotation, offer, items, connectionstring);
                        }
                        else if (offer.IdOfferType != 10 && quotation.IdTemplate == 23)
                        {
                            List<OtItem> items = new List<OtItem>();
                            List<OtItem> temp = new List<OtItem>();
                            if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                temp = GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring, offer.EngineeringAnalysis.EngineeringAnalysisTypes);
                            else
                                temp = GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring, null);


                            items.AddRange(temp);
                            if (items.Count != 0)
                                CreateQuotationWithItems(tempquotation, offer, items, connectionstring);

                            //link EPC for eng analysis. 
                            if (!ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                InsertEngAnalysisInDotProject_V2033(dotProjectConnectionString, connectionstring, mailServer, workbenchConnectionString, offer, tempquotation);
                            else
                                UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, tempquotation, workbenchConnectionString, mailServer);

                            if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.IsCompleted &&
                                tempquotation != null && tempquotation.Ots != null && tempquotation.Ots.Count > 0
                                && tempquotation.Ots[0].Items != null && tempquotation.Ots[0].Items.Count > 0)
                            {
                                ApplicationManager app = new ApplicationManager();

                                //This property is for AssignedEngAnalysis from dotproject.
                                People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);
                                app.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.CreatedByUser, assignedEngAnalysisPerson, tempquotation.Ots[0].DeliveryDate);

                                LogEntryByOffer log = new LogEntryByOffer();
                                log.IdUser = offer.CreatedBy;
                                log.DateTime = DateTime.Now;
                                log.Comments = "The analysis of engineering department has been completed.";
                                log.IdLogEntryType = 2;
                                offer.LogEntryByOffers.Add(log);
                            }

                        }
                    }


                }




            }
            catch (Exception ex)
            {
                throw;
            }
            return offer;
        }


        public Offer AddOffer_V2037(Offer offer, string connectionString, string offerCodeConnectionString, Int32 idSite, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {

            Int64 offerId = 0;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            if (offer.OfferedBy == 0)
            {
                offer.OfferedBy = null;
            }

            if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
            {
                if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                    UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                else
                    offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
            }
            else
                UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);

            if (offerInsertedInGCM)
            {
                using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                {
                    conoffer.Open();
                    using (MySqlTransaction trans = conoffer.BeginTransaction())
                    {
                        try
                        {
                            // SP:- offers_Insert this sp is used till Sprint58
                            // MySqlCommand conoffercommand = new MySqlCommand("offers_Insert", conoffer);

                            // To Add RFQ changed SP:-offers_Insert_Sprint59 in Sprint59
                            MySqlCommand conoffercommand = new MySqlCommand("CRM_AddOffer_V2037", conoffer);

                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                            conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                            conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                            conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                            conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                            conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                            conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                            conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                            conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                            conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                            conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                            conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                            conoffercommand.Parameters.AddWithValue("_CreatedBy", offer.CreatedBy);
                            conoffercommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                            conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                            conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                            conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                            conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                            conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                            conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                            conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                            conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                            conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                            conoffercommand.Parameters.AddWithValue("_OfferedBy", offer.OfferedBy);
                            conoffercommand.Transaction = trans;

                            offerId = Convert.ToInt64(conoffercommand.ExecuteScalar());
                            offer.IdOffer = offerId;
                            offer.Year = DateTime.Now.Year;

                            UpdateEngAnalysisStatus(dotProjectConnectionString, offer);

                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }

                    }
                }
            }
            if (offerInsertedInGCM && offer.IdOffer > 0)
            {


                offer = AddQuotations_V2037(offer, offer.Site.ConnectPlantConstr, dotProjectConnectionString, mailServer, workbenchConnectionString, workingOrdersPath);
                AddLogEntryByOffer(offer, offer.Site.ConnectPlantConstr, null);
                AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);


            }

            return offer;
        }

        private Offer UpdateQuotation_V2037(Offer offer, string connectionstring, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString, string WorkingOrdersPath)
        {
            List<Quotation> quotationByIdOffer = GetOfferQuotationByIdOffer(offer.IdOffer, connectionstring).ToList();
            List<byte> quotIdDetectionsTemplates = quotationByIdOffer.Select(fg => fg.IdDetectionsTemplate).ToList();

            //List<byte> quotIdDetectionsTemplates = GetOfferQuotationByIdOffer(offer.IdOffer, connectionstring).ToList().Select(fg => fg.IdDetectionsTemplate).ToList();

            List<byte> selectedOptionByOfferTemplates = GetTemplatesBySelectedOptionsByOffer(connectionstring, offer.OptionsByOffers.Where(op => op.IsSelected == true).ToList());


            foreach (OptionsByOffer optionsByOffer in offer.OptionsByOffers)
            {
                if (optionsByOffer.IsSelected == true && optionsByOffer.Quantity > 0)
                {
                    List<Template> selectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                    Template selectedOptiontemplate = GetDefaultArticleByIdOfferOption_V2034(optionsByOffer.IdOption, connectionstring);
                    if (selectedOptiontemplate != null)
                        selectedOptionTemplates.Add(selectedOptiontemplate);

                    using (MySqlConnection conoption = new MySqlConnection(connectionstring))
                    {
                        conoption.Open();
                        using (MySqlTransaction trans = conoption.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand conoptioncommand = new MySqlCommand("optionsbyoffer_Update", conoption);
                                conoptioncommand.CommandType = CommandType.StoredProcedure;
                                conoptioncommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                conoptioncommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                conoptioncommand.Parameters.AddWithValue("_Quantity", optionsByOffer.Quantity);
                                conoptioncommand.Transaction = trans;
                                conoptioncommand.ExecuteNonQuery();
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }


                    foreach (Template quotation in selectedOptionTemplates)
                    {
                        if (!quotIdDetectionsTemplates.Contains(quotation.IdTemplate))
                        {
                            bool isUpdate = false;
                            string quotationCode = offer.Code + quotation.Suffix;
                            Int64 idQuotation = 0;

                            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                            {
                                conquotation.Open();
                                MySqlCommand conquotationcommand = new MySqlCommand("quotations_GetquotationsByCode", conquotation);
                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                using (MySqlDataReader reader = conquotationcommand.ExecuteReader())
                                {
                                    if (reader.Read())
                                    {
                                        isUpdate = true;

                                        if (reader["IdQuotation"] != DBNull.Value)
                                        {
                                            idQuotation = Convert.ToInt64(reader["IdQuotation"]);
                                        }
                                    }
                                }
                            }

                            if (isUpdate)
                            {
                                using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                {
                                    conquotation.Open();
                                    using (MySqlTransaction trans = conquotation.BeginTransaction())
                                    {
                                        try
                                        {
                                            // string sqlQuery = "update quotations set IdOffer=" + offer.IdOffer + " where IdDetectionsTemplate = " + quotation.IdTemplate + " AND Code = '" + quotationCode + "';";
                                            MySqlCommand conquotationcommand = new MySqlCommand("quotations_UpdateByCode", conquotation);
                                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                                            conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                            conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                            conquotationcommand.Transaction = trans;
                                            conquotationcommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }

                                //Engineering analysis update code. Comment and date when added from unlinked to linked.
                                if (optionsByOffer.IdOption == 25)
                                {
                                    Quotation quot = new Quotation();
                                    quot.IdQuotation = idQuotation;
                                    quot.Code = quotationCode;
                                    if (quot != null)
                                    {
                                        if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                        {
                                            isUpdateEngAnalysisRevisionQuantity(quot, offer, offer.EngineeringAnalysis.EngineeringAnalysisTypes, connectionstring);
                                        }

                                        List<OtItem> defaultArticleNotInWarehouseProduct = new List<OtItem>();
                                        if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                        {
                                            defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct(quot.IdQuotation, connectionstring, offer.EngineeringAnalysis.EngineeringAnalysisTypes);
                                        }
                                        else
                                        {
                                            defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct(quot.IdQuotation, connectionstring, null);
                                        }
                                        if (defaultArticleNotInWarehouseProduct.Count > 0)
                                        {
                                            //Generate revisionitem in rev0 and rev1 and otitem for that revsion 1
                                            CreateDefaultArticlesNotExistItems(quot, offer, defaultArticleNotInWarehouseProduct, connectionstring);
                                        }


                                        List<OtItem> otitems = null;

                                        Ots ot = GetOTByQuotationId(quot, connectionstring);
                                        if (ot != null)
                                        {
                                            otitems = GetOtItemsByIdOT(ot, connectionstring);

                                            using (var transactionScope = new TransactionScope())
                                            {
                                                try
                                                {
                                                    UpdateOTByIdOT(offer, quot, ot, connectionstring);

                                                    foreach (var otItem in otitems)
                                                    {
                                                        UpdateOTitemByIdOtItem(offer, otItem, connectionstring);

                                                        //Get part number tracking and add update tracking
                                                        PartNumbersTracking partNumbersTracking = GetPartNumbersTrackingByIdOtItem(otItem, 23, connectionstring);

                                                        if (partNumbersTracking != null)
                                                        {
                                                            if (otItem.Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                                            {
                                                                partNumbersTracking.IdOperator = offer.ModifiedBy;
                                                                partNumbersTracking.EndDate = DateTime.Now;
                                                                partNumbersTracking.Paused = false;
                                                            }
                                                            else if (otItem.Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                            {
                                                                partNumbersTracking.IdOperator = null;
                                                                partNumbersTracking.EndDate = null;
                                                                partNumbersTracking.Paused = true;

                                                            }

                                                            UpdatePartNumbersTrackingByIdPartNumbersTracking(offer, partNumbersTracking, connectionstring);
                                                        }


                                                    }
                                                    transactionScope.Complete();
                                                }
                                                catch (Exception ex)
                                                {
                                                    if (Transaction.Current != null)
                                                        Transaction.Current.Rollback();

                                                    if (transactionScope != null)
                                                        transactionScope.Dispose();

                                                    throw;
                                                }
                                            }

                                            quot.Ots = new List<Ots>();
                                            quot.Ots.Add(ot);
                                            UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, quot, workbenchConnectionString, mailServer);

                                            if (otitems != null && otitems.Count > 0)
                                            {
                                                ApplicationManager applicationManager = new ApplicationManager();

                                                //This property is for AssignedEngAnalysis from dotproject.
                                                People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);

                                                // Send email when eng analysis is validated by 
                                                if (otitems[0].Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                                {
                                                    if (offer.EngineeringAnalysis != null)
                                                        applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                                    else
                                                        applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, ot.DeliveryDate);

                                                    LogEntryByOffer log = new LogEntryByOffer();
                                                    log.IdUser = offer.ModifiedBy;
                                                    log.DateTime = DateTime.Now;
                                                    log.Comments = "The analysis of engineering department has been completed.";
                                                    log.IdLogEntryType = 2;
                                                    offer.LogEntryByOffers.Add(log);
                                                }
                                                else if (otitems[0].Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                {
                                                    if (offer.EngineeringAnalysis != null)
                                                        applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                                    else
                                                        applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, ot.DeliveryDate);

                                                    LogEntryByOffer log = new LogEntryByOffer();
                                                    log.IdUser = offer.ModifiedBy;
                                                    log.DateTime = DateTime.Now;
                                                    log.Comments = "The analysis of engineering department has been re-opened.";
                                                    log.IdLogEntryType = 2;
                                                    offer.LogEntryByOffers.Add(log);
                                                }
                                            }
                                        }
                                    }


                                }
                            }
                            else
                            {
                                //Int64 idQuotation = 0;
                                Quotation tempquotation = new Quotation();
                                tempquotation.Offer = new Offer();
                                tempquotation.Offer.IdOffer = offer.IdOffer;
                                tempquotation.Year = DateTime.Now.Year;
                                tempquotation.Number = offer.Number;
                                tempquotation.Code = offer.Code + quotation.Suffix;
                                tempquotation.CreatedIn = DateTime.Now;
                                tempquotation.Template = new Template();
                                tempquotation.Template = quotation;
                                if (quotation.IdTemplate != 0)
                                {
                                    // string quotationCode = offer.Code + quotation.Suffix;
                                    using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                    {
                                        conquotation.Open();
                                        using (MySqlTransaction trans = conquotation.BeginTransaction())
                                        {
                                            try
                                            {
                                                MySqlCommand conquotationcommand = new MySqlCommand("quotations_Insert", conquotation);
                                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                                conquotationcommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                                conquotationcommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                                conquotationcommand.Parameters.AddWithValue("_Number", offer.Number);
                                                conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                                conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                                conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                                conquotationcommand.Parameters.AddWithValue("_QuotQuantity", 0);
                                                conquotationcommand.Parameters.AddWithValue("_Description", offer.Description);
                                                conquotationcommand.Transaction = trans;
                                                idQuotation = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                if (idQuotation > 0)
                                                {
                                                    bool isinsert = false;
                                                    MySqlCommand conoffercommand = new MySqlCommand("revisions_GetrevisionsByIdQuotation", conquotation);
                                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                                    conoffercommand.Parameters.AddWithValue("_IdQuotation", idQuotation);

                                                    using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                                                    {
                                                        if (!offerreader.Read())
                                                        {
                                                            isinsert = true;
                                                        }
                                                    }

                                                    if (isinsert)
                                                    {
                                                        Revision r = new Revision();
                                                        r.NumRevision = 0;
                                                        //[001]
                                                        if (offer.ModifiedBy != null && offer.ModifiedBy == 164)
                                                        {
                                                            r.CreatedBy = 164;
                                                            r.ReviewedBy = 164;
                                                        }
                                                        else
                                                        {
                                                            r.CreatedBy = offer.ModifiedBy;
                                                            r.ReviewedBy = offer.ModifiedBy;
                                                        }
                                                        r.CreatedIn = DateTime.Now;
                                                        r.NumRevision = 0;
                                                        r.Discount = 0;
                                                        r.ExpireDate = DateTime.Now.AddDays(14);
                                                        r.Comments = offer.Contact + "\r\n" + offer.Description;
                                                        //r.Quotation = quotation;
                                                        if (quotation.IdTemplate == 15 || quotation.IdTemplate == 16 || quotation.IdTemplate == 18)
                                                            r.ApprovedIn = DateTime.Now;
                                                        else
                                                            r.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");

                                                        conquotationcommand = new MySqlCommand("revisions_Insert", conquotation);
                                                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                        conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                                                        conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r.ReviewedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_NumRevision", r.NumRevision);
                                                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_MadeBy", r.CreatedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                                        conquotationcommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                                        conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                                                        conquotationcommand.Parameters.AddWithValue("_CreationDate", r.CreatedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_Comments", r.Comments);
                                                        conquotationcommand.Parameters.AddWithValue("_Closed", r.ApprovedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Transaction = trans;
                                                        r.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                        tempquotation.Revisions = new List<Revision>();
                                                        tempquotation.Revisions.Add(r);
                                                    }
                                                }
                                                trans.Commit();
                                            }
                                            catch (Exception ex)
                                            {
                                                trans.Rollback();
                                                throw;
                                            }
                                        }
                                    }

                                    tempquotation.IdQuotation = idQuotation;

                                    ///////////////////////////////////////////////////////

                                    if (offer.IdOfferType != 10 && quotation.IdTemplate == 15) // || quotation.IdTemplate == 23))
                                    {
                                        List<OtItem> items = new List<OtItem>();

                                        List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                                        items.AddRange(temp);
                                        if (items.Count != 0)
                                            CreateQuotationWithItems(tempquotation, offer, items, connectionstring);
                                    }
                                    else if (offer.IdOfferType != 10 && quotation.IdTemplate == 23)
                                    {
                                        List<OtItem> items = new List<OtItem>();
                                        List<OtItem> temp = new List<OtItem>();
                                        if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                            temp = GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring, offer.EngineeringAnalysis.EngineeringAnalysisTypes);
                                        else
                                            temp = GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring, null);

                                        items.AddRange(temp);
                                        if (items.Count != 0)
                                            CreateQuotationWithItems(tempquotation, offer, items, connectionstring);

                                        //link EPC for eng analysis. 
                                        if (!ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                            InsertEngAnalysisInDotProject_V2033(dotProjectConnectionString, connectionstring, mailServer, workbenchConnectionString, offer, tempquotation);
                                        else
                                            UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, tempquotation, workbenchConnectionString, mailServer);
                                        //GOM_v3.Properties.Settings.Default.Email_Delivery_Date_Changed


                                    }
                                }
                            }
                        }
                        else
                        {
                            //Update Quotation Codes when offer type is changed.
                            string quotationCode = offer.Code + quotation.Suffix;

                            Quotation quotationByOffer = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == quotation.IdTemplate);

                            if (quotation != null)
                                UpdateQuotationCodeIfTypeChanged(offer, quotationByOffer, quotation, connectionstring);

                            if (optionsByOffer.IdOption == 25) //Engineering analysis update code.
                            {
                                Quotation quot = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == 23);
                                quot.Code = quotationCode;
                                if (quot != null)
                                {
                                    if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                    {
                                        isUpdateEngAnalysisRevisionQuantity(quot, offer, offer.EngineeringAnalysis.EngineeringAnalysisTypes, connectionstring);
                                    }

                                    List<OtItem> defaultArticleNotInWarehouseProduct = new List<OtItem>();
                                    if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                    {
                                        defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct(quot.IdQuotation, connectionstring, offer.EngineeringAnalysis.EngineeringAnalysisTypes);
                                    }
                                    else
                                    {
                                        defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct(quot.IdQuotation, connectionstring, null);
                                    }
                                    if (defaultArticleNotInWarehouseProduct.Count > 0)
                                    {
                                        //Generate revisionitem in rev0 and rev1 and otitem for that revsion 1
                                        CreateDefaultArticlesNotExistItems(quot, offer, defaultArticleNotInWarehouseProduct, connectionstring);
                                    }

                                    Ots ot = GetOTByQuotationId(quot, connectionstring);
                                    List<OtItem> otitems = null;

                                    if (ot != null)
                                    {
                                        otitems = GetOtItemsByIdOT(ot, connectionstring);

                                        using (var transactionScope = new TransactionScope())
                                        {
                                            try
                                            {
                                                UpdateOTByIdOT(offer, quot, ot, connectionstring);

                                                foreach (var otItem in otitems)
                                                {
                                                    UpdateOTitemByIdOtItem(offer, otItem, connectionstring);

                                                    //Get part number tracking and add update tracking
                                                    PartNumbersTracking partNumbersTracking = GetPartNumbersTrackingByIdOtItem(otItem, 23, connectionstring);

                                                    if (partNumbersTracking != null)
                                                    {
                                                        if (otItem.Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                                        {
                                                            partNumbersTracking.IdOperator = offer.ModifiedBy;
                                                            partNumbersTracking.EndDate = DateTime.Now;
                                                            partNumbersTracking.Paused = false;
                                                        }
                                                        else if (otItem.Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                        {
                                                            partNumbersTracking.IdOperator = null;
                                                            partNumbersTracking.EndDate = null;
                                                            partNumbersTracking.Paused = true;
                                                        }

                                                        UpdatePartNumbersTrackingByIdPartNumbersTracking(offer, partNumbersTracking, connectionstring);
                                                    }
                                                }

                                                transactionScope.Complete();
                                            }
                                            catch (Exception ex)
                                            {
                                                if (Transaction.Current != null)
                                                    Transaction.Current.Rollback();

                                                if (transactionScope != null)
                                                    transactionScope.Dispose();

                                                throw;
                                            }
                                        }
                                    }

                                    quot.Ots = new List<Ots>();
                                    quot.Ots.Add(ot);
                                    if (ot != null)
                                        UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, quotationByOffer, workbenchConnectionString, mailServer);

                                    if (otitems != null && otitems.Count > 0)
                                    {
                                        ApplicationManager applicationManager = new ApplicationManager();

                                        //This property is for AssignedEngAnalysis from dotproject.
                                        People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);

                                        // Send email when eng analysis is validated by 
                                        if (otitems[0].Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                        {
                                            if (offer.EngineeringAnalysis != null)
                                            {
                                                applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                            }
                                            else
                                            {
                                                applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, ot.DeliveryDate);
                                            }

                                            LogEntryByOffer log = new LogEntryByOffer();
                                            log.IdUser = offer.ModifiedBy;
                                            log.DateTime = DateTime.Now;
                                            log.Comments = "The analysis of engineering department has been completed.";
                                            log.IdLogEntryType = 2;
                                            offer.LogEntryByOffers.Add(log);
                                        }
                                        else if (otitems[0].Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                        {
                                            if (offer.EngineeringAnalysis != null)
                                            {
                                                applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                            }
                                            else
                                            {
                                                applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, ot.DeliveryDate);
                                            }

                                            LogEntryByOffer log = new LogEntryByOffer();
                                            log.IdUser = offer.ModifiedBy;
                                            log.DateTime = DateTime.Now;
                                            log.Comments = "The analysis of engineering department has been re-opened.";
                                            log.IdLogEntryType = 2;
                                            offer.LogEntryByOffers.Add(log);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                else
                {
                    if (optionsByOffer.IsSelected == false && optionsByOffer.Quantity == 0)
                    {
                        if (optionsByOffer.IdOption == 25)
                        {
                            if (offer.IsEngAnalysisSetONToOFF)
                                UnlinkedEngAnalysisTypesFromOfferSetQuantity0(offer, connectionstring);

                        }


                        using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                        {
                            conquotation.Open();
                            using (MySqlTransaction trans = conquotation.BeginTransaction())
                            {
                                try
                                {
                                    //string sqlQuery = "DELETE FROM optionsbyoffer WHERE IdOffer = " + offer.IdOffer + " AND IdOption = " + optionsByOffer.IdOption + ";";
                                    MySqlCommand conquotationcommand = new MySqlCommand("optionsbyoffer_Delete", conquotation);
                                    conquotationcommand.CommandType = CommandType.StoredProcedure;
                                    conquotationcommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                    conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conquotationcommand.Transaction = trans;
                                    conquotationcommand.ExecuteNonQuery();

                                    if (optionsByOffer.IdOption == 25 && ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                        UpdateProjectStatusInDotProject(dotProjectConnectionString, offer, 7);

                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }

                        List<Template> unselectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                        Template unselectedOptionTemplate = GetDefaultArticleByIdOfferOption_V2034(optionsByOffer.IdOption, connectionstring);

                        if (unselectedOptionTemplate != null)
                            unselectedOptionTemplates.Add(unselectedOptionTemplate);

                        foreach (Template quotation in unselectedOptionTemplates)
                        {
                            if (!selectedOptionByOfferTemplates.Contains(quotation.IdTemplate))
                            {
                                using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                {
                                    conquotation.Open();
                                    using (MySqlTransaction trans = conquotation.BeginTransaction())
                                    {
                                        try
                                        {
                                            //string sqlQuery = "update quotations set IdOffer=null where IdDetectionsTemplate = " + quotation.IdTemplate + " AND IdOffer = " + offer.IdOffer + ";";
                                            MySqlCommand conquotationcommand = new MySqlCommand("quotations_UpdateByIdOfferANDTemplate", conquotation);
                                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                                            conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                            conquotationcommand.Transaction = trans;
                                            conquotationcommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }
                            }
                        }



                    }

                }

            }
            return offer;

        }

        private void isUpdateEngAnalysisRevisionQuantity(Quotation q, Offer of, List<EngineeringAnalysisType> engineeringAnalysisTypes, string connectionString)
        {
            if (engineeringAnalysisTypes != null)
            {
                foreach (EngineeringAnalysisType itemEngineeringAnalysisType in engineeringAnalysisTypes)
                {
                    UpdateRevisionItemQuatity(itemEngineeringAnalysisType, connectionString, q.IdQuotation, of.ModifiedBy);
                }
            }
        }

        private bool CreateDefaultArticlesNotExistItems(Quotation q, Offer of, List<OtItem> items, string connectionString)
        {
            bool isInserted = true;

            //Get Revsion and ots details to insert revisonitems in rev1 and rev2 and otitem for not exist default article
            Revision revNumItem0 = new Revision();


            Revision revNumItem1 = new Revision();
            revNumItem1.Items = new Dictionary<string, RevisionItem>();
            List<Revision> revisions = new List<Revision>();
            Ots ot = new Ots();



            using (MySqlConnection conquotation = new MySqlConnection(connectionString))
            {
                conquotation.Open();
                MySqlCommand concommand = new MySqlCommand("CRM_GetRevisionAndOTsDetail", conquotation);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdQuotation", q.IdQuotation);

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Revision revision = new Revision();
                        if (reader["IdQuotation"] != DBNull.Value)
                        {
                            revision.Quotation = new Quotation();
                            revision.Quotation.IdQuotation = Convert.ToInt64(reader["IdQuotation"].ToString());
                        }

                        if (reader["IdRevision"] != DBNull.Value)
                            revision.Id = Convert.ToInt64(reader["IdRevision"]);

                        if (reader["NumRevision"] != DBNull.Value)
                            revision.NumRevision = Convert.ToInt32(reader["NumRevision"]);

                        if (reader["MaxNumItem"] != DBNull.Value)
                            revision.MaxNumItem = Convert.ToInt32(reader["MaxNumItem"]);

                        //if (reader["ReviewedBy"] != DBNull.Value)
                        //    revision.CreatedBy = Convert.ToInt32(reader["ReviewedBy"]);

                        revisions.Add(revision);
                    }
                    if (reader.NextResult())
                    {
                        if (reader.Read())
                        {
                            if (reader["idOT"] != DBNull.Value)
                            {

                                ot.IdOT = Convert.ToInt64(reader["idOT"].ToString());
                            }

                        }
                    }
                }
                conquotation.Close();
            }

            if (revisions.Count > 0)
            {
                revNumItem0 = revisions[0];
                revNumItem0.Items = new Dictionary<string, RevisionItem>();
                if (revisions.Count > 1)
                {
                    revNumItem1 = revisions[1];
                    revNumItem1.Items = new Dictionary<string, RevisionItem>();


                    MySqlConnection conrevision;
                    conrevision = new MySqlConnection(connectionString);

                    conrevision.Open();
                    MySqlCommand conquotationcommand = conrevision.CreateCommand();
                    MySqlTransaction MyTransaction = conrevision.BeginTransaction();

                    conquotationcommand.Connection = conrevision;
                    conquotationcommand.Transaction = MyTransaction;

                    try
                    {

                        Int64 i = revNumItem0.MaxNumItem + 1;
                        foreach (OtItem oi in items)
                        {

                            string description = "";

                            description = oi.RevisionItem.WarehouseProduct.Article.Description;
                            WarehouseProduct ap = new WarehouseProduct();
                            ap.Article = oi.RevisionItem.WarehouseProduct.Article;
                            ap.Description = description;
                            ap.Parent = 0;
                            conquotationcommand = new MySqlCommand("products_Insert", conrevision);
                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                            conquotationcommand.Parameters.AddWithValue("_IdProductType", 2);

                            ap.IdWarehouseProduct = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                            conquotationcommand = new MySqlCommand("warehouseproduct_Insert", conrevision);
                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                            conquotationcommand.Parameters.AddWithValue("_IdWarehouseProduct", ap.IdWarehouseProduct);
                            conquotationcommand.Parameters.AddWithValue("_IdArticle", ap.Article.IdArticle);
                            conquotationcommand.Parameters.AddWithValue("_Description", ap.Description);
                            conquotationcommand.Parameters.AddWithValue("_Parent", ap.Parent);

                            conquotationcommand.ExecuteNonQuery();

                            RevisionItem ri = new RevisionItem();
                            ri.WarehouseProduct = ap;
                            ri.Revision = revNumItem0;
                            ri.NumItem = i.ToString();
                            ri.Quantity = Convert.ToInt64(oi.RevisionItem.WarehouseProduct.Article.Quantity);
                            ri.UnitPrice = 0;
                            ri.CustomerComment = "";

                            if (of.ModifiedBy != null && of.ModifiedBy == 164)
                            {
                                ri.CreatedBy = 164;

                            }
                            else
                            {
                                ri.CreatedBy = of.ModifiedBy;

                            }

                            conquotationcommand = new MySqlCommand("revisionitems_Insert", conrevision);
                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                            conquotationcommand.Parameters.AddWithValue("_IdRevision", ri.Revision.Id);
                            conquotationcommand.Parameters.AddWithValue("_NumItem", ri.NumItem);
                            conquotationcommand.Parameters.AddWithValue("_IdProduct", ri.WarehouseProduct.IdWarehouseProduct);
                            conquotationcommand.Parameters.AddWithValue("_Quantity", ri.Quantity);
                            conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri.UnitPrice);
                            conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                            conquotationcommand.Parameters.AddWithValue("_Validated", false);
                            conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri.CustomerComment);
                            conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri.CreatedBy);
                            conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri.CreatedBy);

                            ri.IdRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                            RevisionItem ri1 = new RevisionItem();
                            ri1.WarehouseProduct = ap;
                            ri1.Revision = revNumItem1;
                            ri1.CreatedBy = revNumItem1.CreatedBy;
                            ri1.ModifiedBy = revNumItem1.CreatedBy;
                            ri1.NumItem = i.ToString();
                            ri1.Quantity = Convert.ToUInt32(oi.RevisionItem.WarehouseProduct.Article.Quantity);
                            ri1.UnitPrice = 0;
                            ri1.CustomerComment = "";

                            if (of.ModifiedBy != null && of.ModifiedBy == 164)
                            {
                                ri1.CreatedBy = 164;

                            }
                            else
                            {
                                ri1.CreatedBy = of.ModifiedBy;

                            }

                            conquotationcommand = new MySqlCommand("revisionitems_Insert", conrevision);
                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                            conquotationcommand.Parameters.AddWithValue("_IdRevision", ri1.Revision.Id);
                            conquotationcommand.Parameters.AddWithValue("_NumItem", ri1.NumItem);
                            conquotationcommand.Parameters.AddWithValue("_IdProduct", ri1.WarehouseProduct.IdWarehouseProduct);
                            conquotationcommand.Parameters.AddWithValue("_Quantity", ri1.Quantity);
                            conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri1.UnitPrice);
                            conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                            conquotationcommand.Parameters.AddWithValue("_Validated", false);
                            conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri1.CustomerComment);
                            conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri1.CreatedBy);
                            conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri1.CreatedBy);

                            ri1.IdRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                            revNumItem0.Items.Add(ri.NumItem, ri);
                            revNumItem1.Items.Add(ri1.NumItem, ri1);

                            i++;
                        }



                        q.Revisions = new List<Revision>();
                        q.Revisions.Add(revNumItem1);
                        ot.Quotation = q;

                        MyTransaction.Commit();
                        conrevision.Close();
                        TransactionScope transactionScope = null;

                        using (transactionScope = new TransactionScope())
                        {
                            try
                            {
                                foreach (KeyValuePair<string, RevisionItem> ri in ot.Quotation.Revisions[0].Items)
                                {
                                    byte idItemOtStatus = 1;
                                    foreach (OtItem it in items)
                                    {
                                        if (it.RevisionItem.WarehouseProduct.Article.IdArticle == ri.Value.WarehouseProduct.Article.IdArticle)
                                        {
                                            idItemOtStatus = Convert.ToByte(it.Status.IdItemOtStatus);
                                            break;
                                        }
                                    }

                                    OtItem oi = InsertItemInOt(of, ri.Value, idItemOtStatus, ot, q, connectionString);
                                    ot.Items = new Dictionary<string, OtItem>();
                                    ot.Items.Add(oi.RevisionItem.NumItem, oi);
                                    InsertPartNumber(of, oi, connectionString);
                                }

                                transactionScope.Complete();
                                isInserted = true;
                            }
                            catch (Exception ex)
                            {
                                if (Transaction.Current != null)
                                    Transaction.Current.Rollback();

                                if (transactionScope != null)
                                    transactionScope.Dispose();
                                isInserted = false;
                                throw;
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        conrevision.Close();
                    }
                }
            }
            return isInserted;
        }

        public Offer UpdateOffer_V2037(Offer offer, string connectionstring, string offerCodeConnectionString, Int32 idSite, Int32 idUser, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {

            bool isupdatedLeadToOT = true;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            try
            {
                if (offer.IsUpdateLeadToOT)
                {
                    if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
                    {
                        if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                            UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                        else
                            offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
                    }
                    else
                        UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                }

                if (offerInsertedInGCM)
                {
                    MySqlDataAdapter daGCM;
                    DataTable dtGCM;

                    using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                    {
                        conoffer.Open();
                        string query = "select IdOffer from offers where Code= '" + offer.Code + "' and IdOffer =" + offer.IdOffer + " ;";

                        daGCM = new MySqlDataAdapter(query, conoffer);
                        dtGCM = new DataTable();
                        daGCM.Fill(dtGCM);

                        if (dtGCM.Rows.Count > 0)
                            isupdatedLeadToOT = false;
                    }
                    Int64? nullProductCategory = null;
                    if (offer.IdProductCategory > 0)
                    {
                        nullProductCategory = offer.IdProductCategory;
                    }
                    if (offer.IsUpdateLeadToOT)
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("CRM_offersLeadOTUpdate_V2037", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                    conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Parameters.AddWithValue("_OfferedBy", offer.OfferedBy);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();

                                    offer.IsUpdated = true;
                                    trans.Commit();

                                    offer.Year = DateTime.Now.Year;
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }


                    }
                    else
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(offer.Site.ConnectPlantConstr))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("CRM_UpdateOffer_V2037", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Parameters.AddWithValue("_OfferedBy", offer.OfferedBy);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();

                                    offer.IsUpdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                }

                if (offer.IsUpdated)
                {


                    UpdateEngAnalysisStatus(dotProjectConnectionString, offer);

                    offer = UpdateQuotation_V2037(offer, offer.Site.ConnectPlantConstr, dotProjectConnectionString, mailServer, workbenchConnectionString, workingOrdersPath);



                    LostReasonsByOffer lostReasonsByOffer = UpdateLostReasonsByOffer(offer.LostReasonsByOffer, offer.Site.ConnectPlantConstr);
                    AddLogEntryByOffer(offer, connectionstring, offer.Site.ConnectPlantConstr);
                    AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);

                    if (offer.NewlyLinkedActivities != null && offer.NewlyLinkedActivities.Count > 0)
                    {
                        using (var transactionScope = new TransactionScope())
                        {
                            try
                            {
                                AddLinkExistingActivityToOffer_V2031(mainserverConnectionString, offer.NewlyLinkedActivities, offer.Site, offer.IdOffer);
                                transactionScope.Complete();
                            }
                            catch (Exception ex)
                            {
                                if (Transaction.Current != null)
                                    Transaction.Current.Rollback();

                                if (transactionScope != null)
                                    transactionScope.Dispose();

                                throw;
                            }
                        }
                    }



                }
            }
            catch (Exception ex)
            {
                throw;
                offer.IsUpdated = false;
            }

            return offer;
        }

        private void UpdateRevisionItemQuatity(EngineeringAnalysisType engineeringAnalysisType, string connectionString, Int64 idQuotation, Int32 idModifiedBy)
        {

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                using (MySqlTransaction trans = con.BeginTransaction())
                {
                    try
                    {
                        MySqlCommand concommand = new MySqlCommand("CRM_UpdateRevisionItemQuantity", con);
                        concommand.CommandType = CommandType.StoredProcedure;

                        concommand.Parameters.AddWithValue("_IdArticle", engineeringAnalysisType.IdArticle);
                        concommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                        concommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        concommand.Parameters.AddWithValue("_ModifiedBy", idModifiedBy);
                        concommand.Parameters.AddWithValue("_IsDefaultArticleQuantityUpdate", engineeringAnalysisType.IsSelected);
                        concommand.ExecuteNonQuery();

                        trans.Commit();
                    }
                    catch (Exception ex)
                    {
                        trans.Rollback();
                        throw;
                    }
                }

            }
        }

        public Offer GetOfferDetailsById_V2037(Int64 idOffer, Int32 idUser, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, Company company, string workingOrdersPath)
        {
            Offer offer = new Offer();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(company.ConnectPlantConstr))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetOfferDetailsByIdDateWise_V2037", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_offerId", idOffer);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (offerreader.Read())
                    {
                        offer.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());

                        if (offerreader["IdSalesOwner"] != DBNull.Value)
                        {
                            offer.IdSalesOwner = Convert.ToInt32(offerreader["IdSalesOwner"].ToString());
                            offer.SalesOwner = new People { IdPerson = Convert.ToInt32(offerreader["IdSalesOwner"].ToString()), Name = offerreader["OfferSalesOwnerName"].ToString(), Surname = offerreader["OfferSalesOwnerSurName"].ToString(), Email = Convert.ToString(offerreader["OfferSalesOwnerEmail"]) };
                        }

                        offer.IdOfferType = Convert.ToByte(offerreader["idOfferType"].ToString());
                        offer.Code = offerreader["OfferCode"].ToString();
                        offer.Number = Convert.ToInt64(offerreader["number"].ToString());
                        offer.Year = Convert.ToInt64(offerreader["OfferYear"].ToString());
                        offer.IdCustomer = Convert.ToInt32(offerreader["IdSite"].ToString());
                        offer.IdStatus = Convert.ToByte(offerreader["IdStatus"].ToString());

                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToByte(offerreader["IdStatus"].ToString()), Name = offerreader["OfferStatus"].ToString() };

                        if (offerreader["IdSalesStatusType"] != DBNull.Value)
                        {
                            offer.GeosStatus.IdSalesStatusType = Convert.ToByte(offerreader["IdSalesStatusType"].ToString());

                            offer.GeosStatus.SalesStatusType = new SalesStatusType();
                            offer.GeosStatus.SalesStatusType.IdSalesStatusType = Convert.ToByte(offerreader["IdSalesStatusType"].ToString());
                            offer.GeosStatus.SalesStatusType.Name = offerreader["SalesStatus"].ToString();
                        }

                        offer.IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString());
                        offer.ModifiedBy = Convert.ToInt32(offerreader["ModifiedBy"].ToString());

                        if (offerreader["IdBusinessUnit"] != DBNull.Value)
                            offer.IdBusinessUnit = Convert.ToByte(offerreader["IdBusinessUnit"].ToString());

                        if (offerreader["IdSource"] != DBNull.Value)
                            offer.IdSource = Convert.ToByte(offerreader["IdSource"].ToString());

                        offer.Description = offerreader["OfferTitle"].ToString();
                        offer.Site = new Company() { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["SiteName"].ToString().Trim(), Country = new Country { Name = offerreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offerreader["CustomerZone"].ToString() } } };

                        if (offerreader["IdSalesResponsible"] != DBNull.Value)
                            offer.Site.IdSalesResponsible = Convert.ToInt32(offerreader["IdSalesResponsible"].ToString());

                        if (offerreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(offerreader["IdSalesResponsibleAssemblyBU"].ToString());

                        offer.Site.ConnectPlantId = company.ConnectPlantId;
                        offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } };

                        if (offerreader["OfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["OfferAmount"].ToString());

                        if (offerreader["IdProject"] != DBNull.Value)
                            offer.IdProject = Convert.ToInt32(offerreader["IdProject"].ToString());

                        if (offerreader["IdCarProject"] != DBNull.Value)
                            offer.IdCarProject = Convert.ToInt32(offerreader["IdCarProject"].ToString());

                        if (offerreader["OfferConfidentialLevel"] != DBNull.Value)
                            offer.ProbabilityOfSuccess = Convert.ToSByte(offerreader["OfferConfidentialLevel"].ToString());

                        if (offerreader["OfferExpectedDate"] != DBNull.Value)
                            offer.OfferExpectedDate = Convert.ToDateTime(offerreader["OfferExpectedDate"].ToString());
                        else
                            offer.OfferExpectedDate = null;

                        if (offerreader["RFQReception"] != DBNull.Value)
                            offer.RFQReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        else
                            offer.RFQReception = null;

                        if (offerreader["sendIn"] != DBNull.Value)
                            offer.SendIn = Convert.ToDateTime(offerreader["sendIn"].ToString());
                        else
                            offer.SendIn = null;

                        if (offerreader["DeliveryDate"] != DBNull.Value)
                            offer.DeliveryDate = Convert.ToDateTime(offerreader["DeliveryDate"].ToString());
                        else
                            offer.DeliveryDate = null;

                        if (offerreader["otsDeliveryDate"] != DBNull.Value)
                            offer.OTSDeliveryDate = Convert.ToDateTime(offerreader["otsDeliveryDate"].ToString());
                        else
                            offer.OTSDeliveryDate = null;

                        if (offerreader["POReceivedInDate"] != DBNull.Value)
                            offer.POReceivedInDate = Convert.ToDateTime(offerreader["POReceivedInDate"].ToString());
                        else
                            offer.POReceivedInDate = null;

                        offer.Rfq = offerreader["Rfq"].ToString();
                        offer.Comments = offerreader["Comments"].ToString();
                        offer.Currency = new Currency { IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString()), Name = offerreader["CurrencyName"].ToString() };

                        if (offerreader["ModifiedIn"].ToString() == "01/01/1000 0:00:00")
                        {
                            offer.ModifiedIn = null;
                        }
                        else
                        {
                            offer.ModifiedIn = Convert.ToDateTime(offerreader["ModifiedIn"].ToString());
                        }

                        if (offerreader["CreatedIn"] != DBNull.Value)
                            offer.CreatedIn = Convert.ToDateTime(offerreader["CreatedIn"].ToString());

                        if (offerreader["IdCarOEM"] != DBNull.Value)
                            offer.IdCarOEM = Convert.ToInt32(offerreader["IdCarOEM"].ToString());

                        if (offerreader["OfferedBy"] != DBNull.Value)
                        {
                            offer.OfferedBy = Convert.ToInt32(offerreader["OfferedBy"]);
                            offer.OfferedByPerson = new People { IdPerson = Convert.ToInt32(offer.OfferedBy), Name = Convert.ToString(offerreader["OfferedByName"]), Surname = Convert.ToString(offerreader["OfferedBySurName"]), Email = Convert.ToString(offerreader["OfferedByEmail"]) };
                        }

                        if (offerreader["IsManualCategory"] != DBNull.Value)
                        {
                            offer.IsManualCategory = Convert.ToSByte(offerreader["IsManualCategory"]);
                        }

                        if (offerreader["IdProductCategory"] != DBNull.Value)
                        {
                            offer.IdProductCategory = Convert.ToInt64(offerreader["IdProductCategory"]);
                        }

                        if (offerreader["IdProductCategory"] != DBNull.Value)
                        {
                            offer.ProductCategory = new ProductCategory();

                            offer.ProductCategory.IdProductCategory = Convert.ToInt64(offerreader["IdProductCategory"]);
                            offer.ProductCategory.Name = offerreader["ProductSubCategory"].ToString();

                            if (offerreader["IdProductCategory"] != DBNull.Value)
                            {
                                offer.ProductCategory.Category = new ProductCategory();
                                if (offerreader["IdCategory"] != DBNull.Value)
                                    offer.ProductCategory.Category.IdProductCategory = Convert.ToInt64(offerreader["IdCategory"].ToString());
                                offer.ProductCategory.Category.Name = offerreader["ProductCategory"].ToString();
                            }
                        }

                        if (offerreader["AssignedTo"] != DBNull.Value)
                        {
                            offer.AssignedTo = Convert.ToInt32(offerreader["AssignedTo"]);
                            offer.AssignedToPerson = new People { IdPerson = Convert.ToInt32(offer.AssignedTo), Name = Convert.ToString(offerreader["AssignedName"]), Surname = Convert.ToString(offerreader["AssignedSurName"]), Email = Convert.ToString(offerreader["AssignedEmail"]) };
                        }

                        if (offerreader["OfferValue"] != DBNull.Value)
                            offer.OfferValue = Convert.ToDouble(offerreader["OfferValue"].ToString());

                        if (offerreader["IdOfferCurrency"] != DBNull.Value)
                            offer.IdOfferCurrency = Convert.ToByte(offerreader["IdOfferCurrency"].ToString());

                        if (offerreader["IsGoAheadProduction"] != DBNull.Value)
                            offer.IsGoAheadProduction = Convert.ToBoolean(offerreader["IsGoAheadProduction"]);

                        offer.OptionsByOffers = new List<OptionsByOffer>();
                        using (MySqlConnection conoptionsbyoffer = new MySqlConnection(company.ConnectPlantConstr))
                        {
                            conoptionsbyoffer.Open();
                            MySqlCommand conoptionsbyoffercommand = new MySqlCommand("optionsbyoffer_GetOptionsByOfferId", conoptionsbyoffer);
                            conoptionsbyoffercommand.CommandType = CommandType.StoredProcedure;
                            conoptionsbyoffercommand.Parameters.AddWithValue("_offerId", offer.IdOffer);
                            using (MySqlDataReader optionsbyofferreader = conoptionsbyoffercommand.ExecuteReader())
                            {
                                while (optionsbyofferreader.Read())
                                {

                                    OptionsByOffer optionsbyoffer = new OptionsByOffer();
                                    optionsbyoffer.IdOffer = Convert.ToInt64(optionsbyofferreader["IdOffer"].ToString());
                                    optionsbyoffer.IdOption = Convert.ToInt64(optionsbyofferreader["IdOption"].ToString());
                                    if (optionsbyofferreader["Quantity"] != DBNull.Value)
                                    {
                                        optionsbyoffer.Quantity = Convert.ToInt32(optionsbyofferreader["Quantity"].ToString());
                                        if (optionsbyoffer.Quantity > 0)
                                            optionsbyoffer.IsSelected = true;
                                        else
                                            optionsbyoffer.IsSelected = false;
                                    }
                                    else
                                    {
                                        optionsbyoffer.IsSelected = false;
                                    }
                                    optionsbyoffer.OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(optionsbyofferreader["IdOption"].ToString()), Name = optionsbyofferreader["offeroption"].ToString(), OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(optionsbyofferreader["IdOfferOptionType"].ToString()), Name = optionsbyofferreader["offeroptiontype"].ToString() } };

                                    if (offer.OptionsByOffers.Any(obo => obo.IdOffer == optionsbyoffer.IdOffer && obo.IdOption == optionsbyoffer.IdOption))
                                    {

                                    }
                                    else
                                    {
                                        offer.OptionsByOffers.Add(optionsbyoffer);
                                    }
                                }
                            }


                            if (offer.OptionsByOffers.Any(x => x.IdOption == 25))
                            {
                                List<Quotation> quotationByIdOffer = GetOfferQuotationByIdOffer(offer.IdOffer, company.ConnectPlantConstr).ToList();

                                Quotation quot = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == 23);

                                if (quot != null)
                                {
                                    EngineeringAnalysis engineeringAnalysis = new EngineeringAnalysis();
                                    Ots ot = GetOTByQuotationId(quot, company.ConnectPlantConstr);

                                    if (ot != null)
                                    {
                                        engineeringAnalysis.EngineeringAnalysisTypes = GetEngineeringAnalysisTypesByQuotation(quot.IdQuotation, company.ConnectPlantConstr);
                                        engineeringAnalysis.DueDate = ot.DeliveryDate.Value;

                                        List<OtItem> otitems = GetOtItemsByIdOT(ot, company.ConnectPlantConstr);
                                        if (otitems.Count > 0)
                                        {
                                            engineeringAnalysis.Comments = otitems[0].CustomerComment;

                                            //If Analysis status is shipped then iscompleted is true.
                                            if (otitems[0].Status.IdItemOtStatus == 10)
                                            {
                                                engineeringAnalysis.IsCompleted = true;
                                            }
                                        }
                                    }

                                    engineeringAnalysis.Attachments = new List<Attachment>();

                                    string path = workingOrdersPath + @"\" + offer.Year + @"\" + offer.Code + @"\01 Project Specifications\";
                                    if (Directory.Exists(path))
                                    {
                                        string[] files = Directory.GetFiles(path);

                                        foreach (string file in files)
                                        {
                                            Attachment attachment = new Attachment();
                                            attachment.OriginalFileName = Path.GetFileName(file);
                                            attachment.FilePath = Path.GetFullPath(file);
                                            engineeringAnalysis.Attachments.Add(attachment);
                                        }
                                    }

                                    offer.EngineeringAnalysis = engineeringAnalysis;
                                }
                            }
                        }

                        offer.OfferStatusTracking = new List<OfferStatusTracking>();
                        using (MySqlConnection conofferstatus = new MySqlConnection(company.ConnectPlantConstr))
                        {
                            conofferstatus.Open();
                            MySqlCommand conofferstatuscommand = new MySqlCommand("offerstatustracking_GetOfferStatusTrackingByIdOffer", conofferstatus);
                            conofferstatuscommand.CommandType = CommandType.StoredProcedure;
                            conofferstatuscommand.Parameters.AddWithValue("_idOffer", offer.IdOffer);
                            using (MySqlDataReader offerstatusreader = conofferstatuscommand.ExecuteReader())
                            {
                                while (offerstatusreader.Read())
                                {
                                    if (offer.OfferStatusTracking.Any(ofs => ofs.SalesStatusType.IdSalesStatusType == Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString())))
                                    {
                                        OfferStatusTracking offerStatusTrackingtemp = offer.OfferStatusTracking.Where(ofs => ofs.SalesStatusType.IdSalesStatusType == Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString())).FirstOrDefault();
                                        offerStatusTrackingtemp.IdOfferStatusTracking = Convert.ToInt64(offerstatusreader["IdOfferStatusTracking"].ToString());
                                        offerStatusTrackingtemp.IdOffer = Convert.ToInt64(offerstatusreader["IdOffer"].ToString());
                                        offerStatusTrackingtemp.IdOfferStatusType = Convert.ToInt64(offerstatusreader["IdOfferStatusType"].ToString());
                                        offerStatusTrackingtemp.SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString()), Name = offerstatusreader["Name"].ToString(), HtmlColor = offerstatusreader["HtmlColor"].ToString() };
                                        offerStatusTrackingtemp.StartDate = Convert.ToDateTime(offerstatusreader["StartDate"].ToString());

                                        if (offerstatusreader["EndDate"] != DBNull.Value)
                                        {
                                            offerStatusTrackingtemp.EndDate = offerstatusreader["EndDate"].ToString();
                                        }
                                        else
                                        {
                                            offerStatusTrackingtemp.EndDate = DateTime.Now.ToString();
                                        }

                                        try
                                        {
                                            offerStatusTrackingtemp.NoOfDays = offerStatusTrackingtemp.NoOfDays + (Convert.ToDateTime(Convert.ToDateTime(offerStatusTrackingtemp.EndDate).ToString("yyyy-MM-dd")) - Convert.ToDateTime(offerStatusTrackingtemp.StartDate.ToString("yyyy-MM-dd"))).TotalDays;
                                        }
                                        catch (Exception ex)
                                        {

                                        }
                                    }
                                    else
                                    {
                                        OfferStatusTracking offerStatusTracking = new OfferStatusTracking();
                                        offerStatusTracking.IdOfferStatusTracking = Convert.ToInt64(offerstatusreader["IdOfferStatusTracking"].ToString());
                                        offerStatusTracking.IdOffer = Convert.ToInt64(offerstatusreader["IdOffer"].ToString());
                                        offerStatusTracking.IdOfferStatusType = Convert.ToInt64(offerstatusreader["IdOfferStatusType"].ToString());
                                        offerStatusTracking.SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString()), Name = offerstatusreader["Name"].ToString(), HtmlColor = offerstatusreader["HtmlColor"].ToString() };
                                        offerStatusTracking.StartDate = Convert.ToDateTime(offerstatusreader["StartDate"].ToString());

                                        if (offerstatusreader["EndDate"] != DBNull.Value)
                                        {
                                            offerStatusTracking.EndDate = offerstatusreader["EndDate"].ToString();
                                        }
                                        else
                                        {
                                            offerStatusTracking.EndDate = DateTime.Now.ToString();
                                        }

                                        try
                                        {
                                            offerStatusTracking.NoOfDays = (Convert.ToDateTime(Convert.ToDateTime(offerStatusTracking.EndDate).ToString("yyyy-MM-dd")) - Convert.ToDateTime(offerStatusTracking.StartDate.ToString("yyyy-MM-dd"))).TotalDays;
                                        }
                                        catch (Exception ex)
                                        {

                                        }

                                        offer.OfferStatusTracking.Add(offerStatusTracking);
                                    }
                                }
                            }
                        }
                    }
                }
            }


            return offer;
        }

        private List<EngineeringAnalysisType> GetEngineeringAnalysisTypesByQuotation(Int64 idQuotation, string connectionString)
        {
            List<EngineeringAnalysisType> engineeringAnalysisTypes = new List<EngineeringAnalysisType>();
            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("CRM_GetEngineeringAnalysisTypesByQuotation", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        EngineeringAnalysisType engineeringAnalysisType = new EngineeringAnalysisType();

                        if (reader["IdArticle"] != DBNull.Value)
                        {
                            engineeringAnalysisType.IdArticle = Convert.ToInt32(reader["IdArticle"].ToString());
                        }
                        if (reader["Quantity"] != DBNull.Value)
                        {
                            engineeringAnalysisType.Quantity = Convert.ToString(reader["Quantity"].ToString());
                        }
                        engineeringAnalysisTypes.Add(engineeringAnalysisType);
                    }
                }
            }
            return engineeringAnalysisTypes;
        }

        private List<EngineeringAnalysisType> GetEngineeringAnalysisTypesByQuotation_V2042(Int64 idQuotation, string connectionString)
        {
            List<EngineeringAnalysisType> engineeringAnalysisTypes = new List<EngineeringAnalysisType>();
            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("CRM_GetEngineeringAnalysisTypesByQuotation_V2042", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        EngineeringAnalysisType engineeringAnalysisType = new EngineeringAnalysisType();

                        if (reader["IdArticle"] != DBNull.Value)
                        {
                            engineeringAnalysisType.IdArticle = Convert.ToInt32(reader["IdArticle"].ToString());
                        }
                        if (reader["IdRevisionItemStatus"] != DBNull.Value)
                        {
                            engineeringAnalysisType.IdRevisionItemStatus = Convert.ToByte(reader["IdRevisionItemStatus"].ToString());

                            if(engineeringAnalysisType.IdRevisionItemStatus==10)
                            {
                                engineeringAnalysisType.IsArticleEnabled = false;
                            }
                            else
                            {
                                engineeringAnalysisType.IsArticleEnabled = true;
                            }
                        }
                        if (reader["Quantity"] != DBNull.Value)
                        {
                            engineeringAnalysisType.Quantity = Convert.ToString(reader["Quantity"].ToString());
                        }


                        engineeringAnalysisTypes.Add(engineeringAnalysisType);
                    }
                }
            }
            return engineeringAnalysisTypes;
        }


        public List<TimelineGrid> GetTimelineGridDetails_V2037(TimelineParams timelineParams)
        {
            List<TimelineGrid> timelineGridRows = new List<TimelineGrid>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(timelineParams.connectSiteDetailParams.ConnectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetRestfulTimeData_V2037", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.CommandTimeout = 8000;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", timelineParams.idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", timelineParams.idsSelectedUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", timelineParams.accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", timelineParams.accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idEmdepSite", timelineParams.connectSiteDetailParams.idSite);

                if (timelineParams.Roles == RoleType.SalesAssistant)
                    conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 20);
                else if (timelineParams.Roles == RoleType.SalesPlantManager)
                    conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 21);
                else if (timelineParams.Roles == RoleType.SalesGlobalManager)
                    conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 22);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);


                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid offer = new TimelineGrid();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            if (itemRow["IdSite"] != DBNull.Value)
                            {
                                offer.IdSite = Convert.ToInt32(itemRow["IdSite"].ToString());
                            }

                            if (itemRow["IdOfferType"] != DBNull.Value)
                                offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());

                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.ConnectPlantId = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            offer.Group = itemRow["CustomerGroup"].ToString();
                            offer.Plant = itemRow["SiteName"].ToString().Trim();
                            offer.Country = itemRow["CustomerCountry"].ToString();
                            offer.Region = itemRow["CustomerZone"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                                offer.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                                offer.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());

                            offer.Status = itemRow["OfferStatus"].ToString();
                            offer.HtmlColor = itemRow["OfferStatusColor"].ToString();

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Amount = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            if (itemRow["IdSalesStatusType"] != DBNull.Value)
                                offer.IdSalesStatusType = Convert.ToInt32(itemRow["IdSalesStatusType"].ToString());

                            //  offer.Currency = itemRow["OfferCurrency"].ToString();
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.OfferConfidentialLevel = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                                offer.OfferCloseDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.OfferCloseDate = null;

                            if (itemRow["Rfq"] != DBNull.Value)
                                offer.Rfq = itemRow["Rfq"].ToString();

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RfqReceptionDate = Convert.ToDateTime(itemRow["RFQReception"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.RfqReceptionDate = null;

                            if (itemRow["OfferStatusid"] != DBNull.Value)
                                offer.OfferStatusid = Convert.ToInt32(itemRow["OfferStatusid"].ToString());

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.QuoteSentDate = Convert.ToDateTime(itemRow["SendIn"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.QuoteSentDate = null;


                            offer.Project = itemRow["CarProjectName"].ToString();
                            offer.Source = itemRow["Source"].ToString();
                            offer.BusinessUnit = itemRow["BusinessUnit"].ToString();
                            offer.Oem = itemRow["CarOEM"].ToString();

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                offer.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory = new ProductCategoryGrid();

                            }
                            if (itemRow["OfferedBy"] != DBNull.Value)
                            {
                                offer.OfferedBy = Convert.ToInt32(itemRow["OfferedBy"].ToString());
                            }

                            offer.OptionsByOffers = new List<OptionsByOfferGrid>();
                            timelineGridRows.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            OptionsByOfferGrid optionsByOfferGrid = new OptionsByOfferGrid();
                            optionsByOfferGrid.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsByOfferGrid.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsByOfferGrid.IdOfferPlant = Convert.ToInt32(timelineParams.connectSiteDetailParams.idSite);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsByOfferGrid.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsByOfferGrid.Quantity > 0)
                                    optionsByOfferGrid.IsSelected = true;
                                else
                                    optionsByOfferGrid.IsSelected = false;
                            }
                            else
                            {
                                optionsByOfferGrid.IsSelected = false;
                            }
                            optionsByOfferGrid.OfferOption = itemRow["offeroption"].ToString();

                            timelineGridRow.OptionsByOffers.Add(optionsByOfferGrid);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            timelineGridRow.LostCompetitor = itemRow["Name"].ToString();
                            timelineGridRow.LostDescription = itemRow["Comments"].ToString();
                            timelineGridRow.LostReason = itemRow["Reason"].ToString();

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {
                                    if (itemRow["CommentLastUpdate"] != DBNull.Value)
                                    {
                                        timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["CommentLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                    }
                                }
                            }

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {

                                    if (itemRow["ActivityLastUpdate"] != DBNull.Value)
                                    {
                                        if (timelineGridRow.LastActivityDate == null)
                                        {
                                            timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                        else
                                        {
                                            int result = Nullable.Compare<DateTime>(Convert.ToDateTime(itemRow["ActivityLastUpdate"]), Convert.ToDateTime(timelineGridRow.LastActivityDate));
                                            if (result > 0)
                                                timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                    }

                                    //if (timelineGridRow.LastActivityDate == null)
                                    //{
                                    //    timelineGridRow.LastActivityDate =Convert.ToDateTime(timelineGridRow.QuoteSentDate).ToString("dd/MM/yyyy"); 
                                    //}
                                }
                            }

                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString()), Name = itemRow["ProductSubCategory"].ToString() }; });

                                if (itemRow["IdCategory"] != DBNull.Value)
                                {
                                    timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory.IdParent = Convert.ToInt64(itemRow["IdCategory"].ToString()); u.ProductCategory.Category = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdCategory"].ToString()), Name = itemRow["Category"].ToString() }; });
                                }
                            }
                        }
                    }

                    if (itemRow.NextResult())
                    {
                    }
                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdPerson"] != DBNull.Value)
                            {
                                timelineGridRows.Where(i => i.OfferedBy == Convert.ToInt32(itemRow["IdPerson"].ToString())).ToList().ForEach(u => { u.OfferOwner = itemRow["OfferOwner"].ToString(); });

                            }
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {

                            if (itemRow["idoffer"] != DBNull.Value)
                            {
                                timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["idoffer"].ToString())).ToList().ForEach(u => { u.OfferedTo = itemRow["OfferedTo"].ToString(); });

                            }
                        }
                    }
                }
            }

            return timelineGridRows;
        }


        public List<User> GetSalesAndCommericalUsers(string connectionString)
        {
            List<User> users = new List<User>();

            using (MySqlConnection MyConnection = new MySqlConnection(connectionString))
            {
                MyConnection.Open();
                MySqlCommand myCommand = new MySqlCommand("CRM_GetSalesAndCommericalUsers", MyConnection);
                myCommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader reader = myCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        User user = new User();

                        if (reader["IdUser"] != DBNull.Value)
                            user.IdUser = Convert.ToInt32(reader["IdUser"]);

                        if (reader["FirstName"] != DBNull.Value)
                            user.FirstName = Convert.ToString(reader["FirstName"]);

                        if (reader["LastName"] != DBNull.Value)
                            user.LastName = Convert.ToString(reader["LastName"]);

                        users.Add(user);
                    }

                    reader.Close();
                }

                myCommand.Dispose();
                MyConnection.Close();
            }

            return users;
        }


        public List<OfferContact> GetContactsOfCustomerGroupByOfferId(string connectionstring, Int32 idCustomer)
        {
            List<OfferContact> offerContacts = new List<OfferContact>();

            using (MySqlConnection conpeopleContact = new MySqlConnection(connectionstring))
            {
                conpeopleContact.Open();
                MySqlCommand peopleContactcommand = new MySqlCommand("CRM_GetContactsOfCustomerGroupByOfferId", conpeopleContact);
                peopleContactcommand.CommandType = CommandType.StoredProcedure;
                peopleContactcommand.Parameters.AddWithValue("_idCustomer", idCustomer);

                using (MySqlDataReader peopleContactreader = peopleContactcommand.ExecuteReader())
                {
                    while (peopleContactreader.Read())
                    {
                        OfferContact offerContact = new OfferContact();
                        offerContact.People = new People();
                        if (peopleContactreader["IdPerson"] != DBNull.Value)
                        {
                            offerContact.People.IdPerson = Convert.ToInt32(peopleContactreader["IdPerson"].ToString());
                            offerContact.IdContact = Convert.ToInt32(peopleContactreader["IdPerson"].ToString());
                        }
                        offerContact.People.Name = peopleContactreader["Name"].ToString();
                        offerContact.People.Surname = peopleContactreader["Surname"].ToString();
                        offerContact.People.Email = peopleContactreader["Email"].ToString();
                        offerContact.People.IsStillActive = Convert.ToByte(peopleContactreader["IsStillActive"].ToString());

                        if (peopleContactreader["IdSite"] != DBNull.Value)
                            offerContact.People.IdSite = Convert.ToInt32(peopleContactreader["IdSite"].ToString());
                        offerContact.People.Observations = peopleContactreader["Observations"].ToString();
                        if (peopleContactreader["CreatedIn"] != DBNull.Value)
                            offerContact.People.CreatedIn = Convert.ToDateTime(peopleContactreader["CreatedIn"].ToString());
                        if (peopleContactreader["DisabledIn"] != DBNull.Value)
                            offerContact.People.DisabledIn = Convert.ToDateTime(peopleContactreader["DisabledIn"].ToString());
                        if (peopleContactreader["IdPersonGender"] != DBNull.Value)
                            offerContact.People.IdPersonGender = Convert.ToByte(peopleContactreader["IdPersonGender"].ToString());
                        offerContact.People.Phone = peopleContactreader["Phone"].ToString();
                        offerContact.People.PeopleType = new PeopleType { IdPersonType = Convert.ToByte(peopleContactreader["IdPersonType"].ToString()), Name = peopleContactreader["Department"].ToString() };
                        if (peopleContactreader["IdCompanyDepartment"] != DBNull.Value)
                        {
                            offerContact.People.IdCompanyDepartment = Convert.ToInt32(peopleContactreader["IdCompanyDepartment"].ToString());
                            offerContact.People.CompanyDepartment = new LookupValue();
                            offerContact.People.CompanyDepartment.IdLookupValue = Convert.ToInt32(peopleContactreader["IdCompanyDepartment"].ToString());
                            offerContact.People.CompanyDepartment.Value = peopleContactreader["Value"].ToString();
                            if (peopleContactreader["IdImage"] != DBNull.Value)
                                offerContact.People.CompanyDepartment.IdImage = Convert.ToInt64(peopleContactreader["IdImage"].ToString());
                            //if (peopleContactreader["InUse"] != DBNull.Value)
                            //    people.CompanyDepartment.InUse = Convert.ToBoolean(peopleContactreader["InUse"].ToString());
                        }
                        offerContact.People.JobTitle = peopleContactreader["JobTitle"].ToString();
                        offerContact.People.ImageText = peopleContactreader["Image"].ToString();

                        offerContacts.Add(offerContact);
                    }
                }
            }

            return offerContacts;
        }


        public List<Offer> GetArticlesReportDetails_V2037(string connectionString, Int32 idActiveUser, Company company, DateTime fromDate, DateTime toDate, byte idCurrency, string idArticles)
        {
            List<Offer> offers = new List<Offer>();

            using (MySqlConnection connOffersByIdSiteForActivities = new MySqlConnection(company.ConnectPlantConstr))
            {
                connOffersByIdSiteForActivities.Open();
                MySqlCommand offersCommand = new MySqlCommand("CRM_GetArticlesReportDetails_V2037", connOffersByIdSiteForActivities);
                offersCommand.CommandType = CommandType.StoredProcedure;
                offersCommand.CommandTimeout = 8000;
                offersCommand.Parameters.AddWithValue("_IdActiveUser", idActiveUser);
                offersCommand.Parameters.AddWithValue("_FromDate", fromDate);
                offersCommand.Parameters.AddWithValue("_ToDate", toDate);
                offersCommand.Parameters.AddWithValue("_IdCurrency", idCurrency);
                offersCommand.Parameters.AddWithValue("_IdArticles", idArticles);

                using (MySqlDataReader reader = offersCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            Offer offer = new Offer();

                            offer.IdOffer = Convert.ToInt64(reader["idoffer"]);
                            offer.Code = reader["OfferCode"].ToString();

                            offer.Site = new Company();
                            offer.Site.IdCompany = Convert.ToInt32(reader["IdSite"].ToString());
                            offer.Site.Name = Convert.ToString(reader["SiteName"]);
                            offer.Site.ConnectPlantId = company.ConnectPlantId;
                            offer.Site.Alias = company.Alias;
                            offer.Site.ShortName = company.ShortName;
                            offer.Site.Country = new Country { Zone = new Zone { Name = Convert.ToString(reader["CustomerZone"]) } };

                            offer.Site.Customer = new Customer();
                            offer.Site.Customer.IdCustomer = Convert.ToInt32(reader["IdCustomer"].ToString());
                            offer.Site.Customer.CustomerName = Convert.ToString(reader["CustomerName"]);

                            offer.Quotations = new List<Quotation>();
                            Quotation quot = new Quotation();
                            quot.IdQuotation = Convert.ToInt32(reader["IdQuotation"]);

                            quot.Template = new Template();
                            quot.Template.IdTemplate = Convert.ToByte(reader["IdDetectionsTemplate"]);
                            quot.Template.Name = Convert.ToString(reader["TemplateName"]);
                            quot.Template.Type = Convert.ToInt64(reader["TemplateType"]);

                            quot.Ots = new List<Ots>();
                            Ots ot = new Ots();
                            ot.Code = Convert.ToString(reader["OTCode"]);
                            ot.NumOT = Convert.ToByte(reader["NumOT"]);

                            ot.OtItems = new List<OtItem>();
                            OtItem otitem = new OtItem();
                            otitem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                            otitem.RevisionItem = new RevisionItem();
                            otitem.RevisionItem.IdRevisionItem = Convert.ToInt64(reader["IdRevisionItem"]);

                            otitem.RevisionItem.NumItem = Convert.ToString(reader["NumItem"]);

                            otitem.RevisionItem.WarehouseProduct = new WarehouseProduct();
                            otitem.RevisionItem.WarehouseProduct.Article = new Article();

                            if (reader["IdArticle"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(reader["IdArticle"]);

                            if (reader["IsObsolete"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.IsObsolete = Convert.ToSByte(reader["IsObsolete"]);

                            if (reader["Reference"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.Reference = Convert.ToString(reader["Reference"]);

                            if (reader["ArticleDescription"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.Description = Convert.ToString(reader["ArticleDescription"]);

                            if (reader["Quantity"] != DBNull.Value)
                                otitem.RevisionItem.Quantity = Convert.ToDecimal(reader["Quantity"]);

                            if (reader["DeliveryDate"] != DBNull.Value)
                                otitem.ShippingDate = Convert.ToDateTime(reader["DeliveryDate"]);

                            otitem.RevisionItem.WarehouseProduct.Article.ArticleBySupplier = new ArticleBySupplier();

                            if (reader["ConvertedCostPrice"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.ArticleBySupplier.CostPrice = Convert.ToDouble(reader["ConvertedCostPrice"]);

                            otitem.RevisionItem.WarehouseProduct.Article.ArticleBySupplier.ArticleSupplier = new ArticleSupplier();

                            if (reader["ArticleSupplierName"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.ArticleBySupplier.ArticleSupplier.Name = Convert.ToString(reader["ArticleSupplierName"]);

                            if (reader["ConvertedSellPrice"] != DBNull.Value)
                                otitem.RevisionItem.WarehouseProduct.Article.SellPrice = Convert.ToDouble(reader["ConvertedSellPrice"]);

                            ot.OtItems.Add(otitem);
                            quot.Ots.Add(ot);
                            offer.Quotations.Add(quot);
                            offers.Add(offer);
                        }
                    }
                }
            }

            return offers;
        }


        private void UnlinkedEngAnalysisTypesFromOfferSetQuantity0(Offer offer, string connectionString)
        {

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                using (MySqlTransaction trans = con.BeginTransaction())
                {
                    try
                    {
                        MySqlCommand concommand = new MySqlCommand("CRM_UpdateQuantityToZeroWhenEngAnalysisOnToOff", con);
                        concommand.CommandType = CommandType.StoredProcedure;

                        concommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                        concommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        concommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);

                        concommand.ExecuteNonQuery();

                        trans.Commit();
                    }
                    catch (Exception ex)
                    {
                        trans.Rollback();
                        throw;
                    }
                }

            }
        }



        public bool UpdateOrderByIdOffer_V2037(Offer offer, string connectionString, string mainServerConnectionString)
        {
            TransactionScope transactionScopeGeos = null;
            TransactionScope transactionScopeEmdepGeos = null;
            bool isUpdated = false;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            if (offer.OfferedBy == 0)
            {
                offer.OfferedBy = null;
            }

            try
            {
                using (transactionScopeGeos = new TransactionScope())
                {
                    Int64? nullProductCategory = null;
                    if (offer.IdProductCategory > 0)
                    {
                        nullProductCategory = offer.IdProductCategory;
                    }

                    using (MySqlConnection connOrder = new MySqlConnection(offer.Site.ConnectPlantConstr))
                    {
                        connOrder.Open();

                        MySqlCommand orderCommand = new MySqlCommand("CRM_UpdateOrderParticularColumn_V2037", connOrder);

                        orderCommand.CommandType = CommandType.StoredProcedure;
                        orderCommand.Parameters.AddWithValue("_Code", offer.Code);
                        orderCommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                        orderCommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                        orderCommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                        orderCommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                        orderCommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                        orderCommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        orderCommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                        orderCommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                        orderCommand.Parameters.AddWithValue("_OfferedBy", offer.OfferedBy);
                        orderCommand.ExecuteNonQuery();
                        isUpdated = true;

                        connOrder.Close();

                        if (isUpdated)
                        {
                            if (offer.OfferContacts != null && offer.OfferContacts.Count > 0)
                                AddOrderContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);

                            if (offer.CommentsByOffers != null && offer.CommentsByOffers.Count > 0)     //Comments
                                AddLogEntryByOrder(offer.IdOffer, offer.CommentsByOffers, connectionString, offer.Site.ConnectPlantConstr);

                            if (offer.LogEntryByOffers != null && offer.LogEntryByOffers.Count > 0)     //Log entries.
                                AddLogEntryByOrder(offer.IdOffer, offer.LogEntryByOffers, connectionString, offer.Site.ConnectPlantConstr);


                        }
                    }

                    using (transactionScopeEmdepGeos = new TransactionScope(TransactionScopeOption.RequiresNew))
                    {
                        if (offer.NewlyLinkedActivities != null && offer.NewlyLinkedActivities.Count > 0)
                        {
                            AddLinkExistingActivityToOffer_V2031(mainServerConnectionString, offer.NewlyLinkedActivities, offer.Site, offer.IdOffer);
                            transactionScopeEmdepGeos.Complete();
                        }
                    }

                    transactionScopeGeos.Complete();
                }
            }
            catch (Exception ex)
            {
                isUpdated = false;

                if (Transaction.Current != null)
                    Transaction.Current.Rollback();

                if (transactionScopeGeos != null)
                    transactionScopeGeos.Dispose();

                if (transactionScopeEmdepGeos != null)
                    transactionScopeEmdepGeos.Dispose();

                throw;
            }

            return isUpdated;
        }


        public List<UserSiteGeosServiceProvider> GetAllCompaniesWithServiceProvider(Int32 idUser, string connectionString)
        {
            List<UserSiteGeosServiceProvider> companiesWithServiceProviders = new List<UserSiteGeosServiceProvider>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand command = new MySqlCommand("CRM_GetAllCompaniesWithServiceProvider", con);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idUser", idUser);

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        UserSiteGeosServiceProvider companiesWithServiceProvider = new UserSiteGeosServiceProvider();

                        if (reader["IdSite"] != DBNull.Value)
                            companiesWithServiceProvider.IdSite = Convert.ToInt32(reader["IdSite"].ToString());

                        if (reader["ShortName"] != DBNull.Value)
                            companiesWithServiceProvider.ShortName = Convert.ToString(reader["ShortName"].ToString());

                        if (reader["ServiceProviderUrl"] != DBNull.Value)
                            companiesWithServiceProvider.ServiceProviderUrl = Convert.ToString(reader["ServiceProviderUrl"].ToString());

                        companiesWithServiceProviders.Add(companiesWithServiceProvider);
                    }

                }
            }

            return companiesWithServiceProviders;
        }

        public Int64 GetNextNumberOfOfferFromCounters_V2040(byte? idOfferType, string mainserverconnectionString, Int32 idUser)
        {
            Int64 nextNumber = 1;

            using (MySqlConnection conoffer = new MySqlConnection(mainserverconnectionString))
            {
                conoffer.Open();
                MySqlCommand command = new MySqlCommand("CRM_GetNextNumberFromCounters", conoffer);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idOfferType", idOfferType);
                command.Parameters.AddWithValue("_year", DateTime.Now.Year);
                using (MySqlDataReader offerreader = command.ExecuteReader())
                {
                    if (offerreader.Read())
                        nextNumber = Convert.ToInt32(offerreader["NextNumber"].ToString());
                }
            }

            return nextNumber;
        }

        public string MakeOfferCode_V2040(byte? idOfferType, Int32 idCustomer, string connectionstring, string offerCodeConnectionString, string mainServerConnectionString, Int32 idUser, bool UseSQLCounter = true)
        {
            string code = "";

            if (idOfferType == 1)
            {
                if (!UseSQLCounter)
                    code = DateTime.Now.Year.ToString() + GetCodeForSite(idCustomer, connectionstring) + "-" + GetNextNumberOfOfferFromCounters_V2040(idOfferType, mainServerConnectionString, idUser).ToString().PadLeft(5, '0');
                else
                    code = DateTime.Now.Year.ToString() + GetCodeForSite(idCustomer, connectionstring) + "-" + GetNextNumberOfSuppliesFromGCM(idOfferType, offerCodeConnectionString).ToString().PadLeft(5, '0');
            }
            else if (idOfferType == 2)
                code = "IC" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfSuppliesFromGCM(idOfferType, offerCodeConnectionString).ToString().PadLeft(4, '0');
            else if (idOfferType == 3)
                code = "C" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfSuppliesFromGCM(idOfferType, offerCodeConnectionString).ToString().PadLeft(4, '0');
            else if (idOfferType == 4)
                code = "T" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + "-" + GetNextNumberOfSuppliesFromGCM(idOfferType, offerCodeConnectionString).ToString().PadLeft(3, '0');
            else if (idOfferType == 5)
                code = "IE" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfOfferFromCounters_V2040(idOfferType, mainServerConnectionString, idUser).ToString().PadLeft(3, '0');
            else if (idOfferType == 6)
                code = "RD" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfOfferFromCounters_V2040(idOfferType, mainServerConnectionString, idUser).ToString().PadLeft(3, '0');
            else if (idOfferType == 7)
                code = "IT" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfOfferFromCounters_V2040(idOfferType, mainServerConnectionString, idUser).ToString().PadLeft(3, '0');
            else if (idOfferType == 8)
                code = "IS" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfOfferFromCounters_V2040(idOfferType, mainServerConnectionString, idUser).ToString().PadLeft(3, '0');
            else if (idOfferType == 9)
                code = "IW" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfOfferFromCounters_V2040(idOfferType, mainServerConnectionString, idUser).ToString().PadLeft(3, '0');
            else if (idOfferType == 10)
                code = "OP" + DateTime.Now.Year.ToString().Substring(2, 2) + GetCodeForSite(idCustomer, connectionstring) + GetNextNumberOfOfferFromCounters_V2040(idOfferType, mainServerConnectionString, idUser).ToString().PadLeft(5, '0');
            else
                code = "";

            return code;
        }

        /// <summary>
        /// This method is to get companies detail(Added service provider url)
        /// [cpatil][GEOS2-2074][17-02-2020]CRM - OPPORTUNITIES - Timeline
        /// </summary>
        /// <param name="idUser">Get iduser</param>
        /// <param name="connectionString">Get connection string</param>
        /// <returns>List of company details</returns>
        public List<Company> GetAllCompaniesDetails_V2040(Int32 idUser, string connectionString)
        {
            List<Company> connectionstrings = new List<Company>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand command = new MySqlCommand("CRM_GetAllPlantsDetails_V2040", con);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("_idUser", idUser);
                List<string> strDatabaseIP = new List<string>();

                using (MySqlDataReader reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Company company = new Company();
                        //This will removed from code when we update everywhere logic to hit service through service provider url not from database connection string
                        string connstr = "Data Source = " + reader["DatabaseIP"].ToString() + "; Database = geos; User ID = GeosUsr; Password = GEOS;Convert Zero Datetime=True";
                        if (connectionstrings.Count == 0)
                        {
                            strDatabaseIP.Add(reader["DatabaseIP"].ToString());
                            company.IdCompany = Convert.ToInt32(reader["idSite"].ToString());
                            company.Alias = reader["ShortName"].ToString();
                            company.ShortName = reader["ShortName"].ToString();
                            company.Name = reader["Name"].ToString();
                            company.ConnectPlantId = reader["idSite"].ToString();
                            company.ConnectPlantConstr = connstr;
                            company.ServiceProviderUrl = reader["ServiceProviderUrl"].ToString();
                            company.Country = new Country();
                            company.Country.IdCountry = Convert.ToByte(reader["idCountry"].ToString());
                            company.Country.Name = reader["name"].ToString();
                            connectionstrings.Add(company);
                        }

                        if (strDatabaseIP.Exists(cs => cs.ToString() == reader["DatabaseIP"].ToString()))
                        {
                        }
                        else
                        {
                            strDatabaseIP.Add(reader["DatabaseIP"].ToString());
                            company.IdCompany = Convert.ToInt32(reader["idSite"].ToString());
                            company.Alias = reader["ShortName"].ToString();
                            company.ShortName = reader["ShortName"].ToString();
                            company.Name = reader["Name"].ToString();
                            company.Country = new Country();
                            company.Country.IdCountry = Convert.ToByte(reader["idCountry"].ToString());
                            company.Country.Name = reader["name"].ToString();
                            company.ConnectPlantId = reader["idSite"].ToString();
                            company.ConnectPlantConstr = connstr;
                            company.ServiceProviderUrl = reader["ServiceProviderUrl"].ToString();
                            connectionstrings.Add(company);
                        }

                    }

                }
            }

            return connectionstrings;
        }


        public List<TimelineGrid> GetTimelineGridDetails_V2040(TimelineParams timelineParams, string connectionString)
        {
            List<TimelineGrid> timelineGridRows = new List<TimelineGrid>();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetRestfulTimeData_V2037", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.CommandTimeout = 8000;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", timelineParams.idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", timelineParams.idsSelectedUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", timelineParams.accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", timelineParams.accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idEmdepSite", timelineParams.activeSite.IdSite);

                if (timelineParams.Roles == RoleType.SalesAssistant)
                    conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 20);
                else if (timelineParams.Roles == RoleType.SalesPlantManager)
                    conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 21);
                else if (timelineParams.Roles == RoleType.SalesGlobalManager)
                    conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 22);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);


                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid offer = new TimelineGrid();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());

                            if (itemRow["IdSalesOwner"] != DBNull.Value)
                            {
                                offer.IdSalesOwner = Convert.ToInt32(itemRow["IdSalesOwner"].ToString());
                            }

                            if (itemRow["IdSite"] != DBNull.Value)
                            {
                                offer.IdSite = Convert.ToInt32(itemRow["IdSite"].ToString());
                            }

                            if (itemRow["IdOfferType"] != DBNull.Value)
                                offer.IdOfferType = Convert.ToByte(itemRow["IdOfferType"].ToString());

                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.ConnectPlantId = Convert.ToInt32(timelineParams.activeSite.IdSite);
                            offer.ActiveSite = timelineParams.activeSite;
                            offer.Group = itemRow["CustomerGroup"].ToString();
                            offer.Plant = itemRow["SiteName"].ToString().Trim();
                            offer.Country = itemRow["CustomerCountry"].ToString();
                            offer.Region = itemRow["CustomerZone"].ToString();
                            offer.Description = itemRow["OfferTitle"].ToString();

                            if (itemRow["IdSalesResponsible"] != DBNull.Value)
                                offer.IdSalesResponsible = Convert.ToInt32(itemRow["IdSalesResponsible"].ToString());

                            if (itemRow["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                                offer.IdSalesResponsibleAssemblyBU = Convert.ToInt32(itemRow["IdSalesResponsibleAssemblyBU"].ToString());

                            offer.Status = itemRow["OfferStatus"].ToString();
                            offer.HtmlColor = itemRow["OfferStatusColor"].ToString();

                            if (itemRow["OfferAmount"] != DBNull.Value)
                                offer.Amount = Convert.ToDouble(itemRow["OfferAmount"].ToString());

                            if (itemRow["IdSalesStatusType"] != DBNull.Value)
                                offer.IdSalesStatusType = Convert.ToInt32(itemRow["IdSalesStatusType"].ToString());

                            //  offer.Currency = itemRow["OfferCurrency"].ToString();
                            if (itemRow["OfferConfidentialLevel"] != DBNull.Value)
                                offer.OfferConfidentialLevel = Convert.ToSByte(itemRow["OfferConfidentialLevel"].ToString());

                            if (itemRow["OfferExpectedPODate"] != DBNull.Value)
                                offer.OfferCloseDate = Convert.ToDateTime(itemRow["OfferExpectedPODate"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.OfferCloseDate = null;

                            if (itemRow["Rfq"] != DBNull.Value)
                                offer.Rfq = itemRow["Rfq"].ToString();

                            if (itemRow["RFQReception"] != DBNull.Value)
                                offer.RfqReceptionDate = Convert.ToDateTime(itemRow["RFQReception"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.RfqReceptionDate = null;

                            if (itemRow["OfferStatusid"] != DBNull.Value)
                                offer.OfferStatusid = Convert.ToInt32(itemRow["OfferStatusid"].ToString());

                            if (itemRow["SendIn"] != DBNull.Value)
                                offer.QuoteSentDate = Convert.ToDateTime(itemRow["SendIn"].ToString()).ToString("yyyy-MM-dd");
                            else
                                offer.QuoteSentDate = null;


                            offer.Project = itemRow["CarProjectName"].ToString();
                            offer.Source = itemRow["Source"].ToString();
                            offer.BusinessUnit = itemRow["BusinessUnit"].ToString();
                            offer.Oem = itemRow["CarOEM"].ToString();

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                offer.IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString());
                                offer.ProductCategory = new ProductCategoryGrid();

                            }
                            if (itemRow["OfferedBy"] != DBNull.Value)
                            {
                                offer.OfferedBy = Convert.ToInt32(itemRow["OfferedBy"].ToString());
                            }

                            offer.OptionsByOffers = new List<OptionsByOfferGrid>();
                            timelineGridRows.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            OptionsByOfferGrid optionsByOfferGrid = new OptionsByOfferGrid();
                            optionsByOfferGrid.IdOffer = Convert.ToInt64(itemRow["IdOffer"].ToString());
                            optionsByOfferGrid.IdOption = Convert.ToInt64(itemRow["IdOption"].ToString());
                            optionsByOfferGrid.IdOfferPlant = Convert.ToInt32(timelineParams.activeSite.IdSite);
                            if (itemRow["Quantity"] != DBNull.Value)
                            {
                                optionsByOfferGrid.Quantity = Convert.ToInt32(itemRow["Quantity"].ToString());
                                if (optionsByOfferGrid.Quantity > 0)
                                    optionsByOfferGrid.IsSelected = true;
                                else
                                    optionsByOfferGrid.IsSelected = false;
                            }
                            else
                            {
                                optionsByOfferGrid.IsSelected = false;
                            }
                            optionsByOfferGrid.OfferOption = itemRow["offeroption"].ToString();

                            timelineGridRow.OptionsByOffers.Add(optionsByOfferGrid);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid timelineGridRow = timelineGridRows.Where(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();

                            timelineGridRow.LostCompetitor = itemRow["Name"].ToString();
                            timelineGridRow.LostDescription = itemRow["Comments"].ToString();
                            timelineGridRow.LostReason = itemRow["Reason"].ToString();

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {
                                    if (itemRow["CommentLastUpdate"] != DBNull.Value)
                                    {
                                        timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["CommentLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                    }
                                }
                            }

                        }
                    }


                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdOffer"] != DBNull.Value)
                            {
                                TimelineGrid timelineGridRow = timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())).FirstOrDefault();
                                if (timelineGridRow.Status != null && timelineGridRow.OfferStatusid == 1)
                                {

                                    if (itemRow["ActivityLastUpdate"] != DBNull.Value)
                                    {
                                        if (timelineGridRow.LastActivityDate == null)
                                        {
                                            timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                        else
                                        {
                                            int result = Nullable.Compare<DateTime>(Convert.ToDateTime(itemRow["ActivityLastUpdate"]), Convert.ToDateTime(timelineGridRow.LastActivityDate));
                                            if (result > 0)
                                                timelineGridRow.LastActivityDate = Convert.ToDateTime(itemRow["ActivityLastUpdate"].ToString()).ToString("yyyy-MM-dd");
                                        }
                                    }

                                    //if (timelineGridRow.LastActivityDate == null)
                                    //{
                                    //    timelineGridRow.LastActivityDate =Convert.ToDateTime(timelineGridRow.QuoteSentDate).ToString("dd/MM/yyyy"); 
                                    //}
                                }
                            }

                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {

                            if (itemRow["IdProductSubCategory"] != DBNull.Value)
                            {
                                timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdProductSubCategory"].ToString()), Name = itemRow["ProductSubCategory"].ToString() }; });

                                if (itemRow["IdCategory"] != DBNull.Value)
                                {
                                    timelineGridRows.Where(i => i.IdProductCategory == Convert.ToInt64(itemRow["IdProductSubCategory"].ToString())).ToList().ForEach(u => { u.ProductCategory.IdParent = Convert.ToInt64(itemRow["IdCategory"].ToString()); u.ProductCategory.Category = new ProductCategoryGrid() { IdProductCategory = Convert.ToInt64(itemRow["IdCategory"].ToString()), Name = itemRow["Category"].ToString() }; });
                                }
                            }
                        }
                    }

                    if (itemRow.NextResult())
                    {
                    }
                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (itemRow["IdPerson"] != DBNull.Value)
                            {
                                timelineGridRows.Where(i => i.OfferedBy == Convert.ToInt32(itemRow["IdPerson"].ToString())).ToList().ForEach(u => { u.OfferOwner = itemRow["OfferOwner"].ToString(); });

                            }
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {

                            if (itemRow["idoffer"] != DBNull.Value)
                            {
                                timelineGridRows.Where(i => i.IdOffer == Convert.ToInt64(itemRow["idoffer"].ToString())).ToList().ForEach(u => { u.OfferedTo = itemRow["OfferedTo"].ToString(); });

                            }
                        }
                    }
                }
            }

            return timelineGridRows;
        }


        public Offer GetOfferDetailsById_V2040(Int64 idOffer, Int32 idUser, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, ActiveSite activeSite, string workingOrdersPath, string connectionString)
        {
            Offer offer = new Offer();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetOfferDetailsByIdDateWise_V2037", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_offerId", idOffer);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (offerreader.Read())
                    {
                        offer.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());

                        if (offerreader["IdSalesOwner"] != DBNull.Value)
                        {
                            offer.IdSalesOwner = Convert.ToInt32(offerreader["IdSalesOwner"].ToString());
                            offer.SalesOwner = new People { IdPerson = Convert.ToInt32(offerreader["IdSalesOwner"].ToString()), Name = offerreader["OfferSalesOwnerName"].ToString(), Surname = offerreader["OfferSalesOwnerSurName"].ToString(), Email = Convert.ToString(offerreader["OfferSalesOwnerEmail"]) };
                        }

                        offer.IdOfferType = Convert.ToByte(offerreader["idOfferType"].ToString());
                        offer.Code = offerreader["OfferCode"].ToString();
                        offer.Number = Convert.ToInt64(offerreader["number"].ToString());
                        offer.Year = Convert.ToInt64(offerreader["OfferYear"].ToString());
                        offer.IdCustomer = Convert.ToInt32(offerreader["IdSite"].ToString());
                        offer.IdStatus = Convert.ToByte(offerreader["IdStatus"].ToString());

                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToByte(offerreader["IdStatus"].ToString()), Name = offerreader["OfferStatus"].ToString() };

                        if (offerreader["IdSalesStatusType"] != DBNull.Value)
                        {
                            offer.GeosStatus.IdSalesStatusType = Convert.ToByte(offerreader["IdSalesStatusType"].ToString());

                            offer.GeosStatus.SalesStatusType = new SalesStatusType();
                            offer.GeosStatus.SalesStatusType.IdSalesStatusType = Convert.ToByte(offerreader["IdSalesStatusType"].ToString());
                            offer.GeosStatus.SalesStatusType.Name = offerreader["SalesStatus"].ToString();
                        }

                        offer.IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString());
                        offer.ModifiedBy = Convert.ToInt32(offerreader["ModifiedBy"].ToString());

                        if (offerreader["IdBusinessUnit"] != DBNull.Value)
                            offer.IdBusinessUnit = Convert.ToByte(offerreader["IdBusinessUnit"].ToString());

                        if (offerreader["IdSource"] != DBNull.Value)
                            offer.IdSource = Convert.ToByte(offerreader["IdSource"].ToString());

                        offer.Description = offerreader["OfferTitle"].ToString();
                        offer.Site = new Company() { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["SiteName"].ToString().Trim(), Country = new Country { Name = offerreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offerreader["CustomerZone"].ToString() } } };

                        if (offerreader["IdSalesResponsible"] != DBNull.Value)
                            offer.Site.IdSalesResponsible = Convert.ToInt32(offerreader["IdSalesResponsible"].ToString());

                        if (offerreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(offerreader["IdSalesResponsibleAssemblyBU"].ToString());

                        offer.Site.ConnectPlantId = activeSite.IdSite.ToString();
                        offer.Site.ShortName = activeSite.SiteAlias;
                        offer.OfferActiveSite = activeSite;

                        offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } };

                        if (offerreader["OfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["OfferAmount"].ToString());

                        if (offerreader["IdProject"] != DBNull.Value)
                            offer.IdProject = Convert.ToInt32(offerreader["IdProject"].ToString());

                        if (offerreader["IdCarProject"] != DBNull.Value)
                            offer.IdCarProject = Convert.ToInt32(offerreader["IdCarProject"].ToString());

                        if (offerreader["OfferConfidentialLevel"] != DBNull.Value)
                            offer.ProbabilityOfSuccess = Convert.ToSByte(offerreader["OfferConfidentialLevel"].ToString());

                        if (offerreader["OfferExpectedDate"] != DBNull.Value)
                            offer.OfferExpectedDate = Convert.ToDateTime(offerreader["OfferExpectedDate"].ToString());
                        else
                            offer.OfferExpectedDate = null;

                        if (offerreader["RFQReception"] != DBNull.Value)
                            offer.RFQReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        else
                            offer.RFQReception = null;

                        if (offerreader["sendIn"] != DBNull.Value)
                            offer.SendIn = Convert.ToDateTime(offerreader["sendIn"].ToString());
                        else
                            offer.SendIn = null;

                        if (offerreader["DeliveryDate"] != DBNull.Value)
                            offer.DeliveryDate = Convert.ToDateTime(offerreader["DeliveryDate"].ToString());
                        else
                            offer.DeliveryDate = null;

                        if (offerreader["otsDeliveryDate"] != DBNull.Value)
                            offer.OTSDeliveryDate = Convert.ToDateTime(offerreader["otsDeliveryDate"].ToString());
                        else
                            offer.OTSDeliveryDate = null;

                        if (offerreader["POReceivedInDate"] != DBNull.Value)
                            offer.POReceivedInDate = Convert.ToDateTime(offerreader["POReceivedInDate"].ToString());
                        else
                            offer.POReceivedInDate = null;

                        offer.Rfq = offerreader["Rfq"].ToString();
                        offer.Comments = offerreader["Comments"].ToString();
                        offer.Currency = new Currency { IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString()), Name = offerreader["CurrencyName"].ToString() };

                        if (offerreader["ModifiedIn"].ToString() == "01/01/1000 0:00:00")
                        {
                            offer.ModifiedIn = null;
                        }
                        else
                        {
                            offer.ModifiedIn = Convert.ToDateTime(offerreader["ModifiedIn"].ToString());
                        }

                        if (offerreader["CreatedIn"] != DBNull.Value)
                            offer.CreatedIn = Convert.ToDateTime(offerreader["CreatedIn"].ToString());

                        if (offerreader["IdCarOEM"] != DBNull.Value)
                            offer.IdCarOEM = Convert.ToInt32(offerreader["IdCarOEM"].ToString());

                        if (offerreader["OfferedBy"] != DBNull.Value)
                        {
                            offer.OfferedBy = Convert.ToInt32(offerreader["OfferedBy"]);
                            offer.OfferedByPerson = new People { IdPerson = Convert.ToInt32(offer.OfferedBy), Name = Convert.ToString(offerreader["OfferedByName"]), Surname = Convert.ToString(offerreader["OfferedBySurName"]), Email = Convert.ToString(offerreader["OfferedByEmail"]) };
                        }

                        if (offerreader["IsManualCategory"] != DBNull.Value)
                        {
                            offer.IsManualCategory = Convert.ToSByte(offerreader["IsManualCategory"]);
                        }

                        if (offerreader["IdProductCategory"] != DBNull.Value)
                        {
                            offer.IdProductCategory = Convert.ToInt64(offerreader["IdProductCategory"]);
                        }

                        if (offerreader["IdProductCategory"] != DBNull.Value)
                        {
                            offer.ProductCategory = new ProductCategory();

                            offer.ProductCategory.IdProductCategory = Convert.ToInt64(offerreader["IdProductCategory"]);
                            offer.ProductCategory.Name = offerreader["ProductSubCategory"].ToString();

                            if (offerreader["IdProductCategory"] != DBNull.Value)
                            {
                                offer.ProductCategory.Category = new ProductCategory();
                                if (offerreader["IdCategory"] != DBNull.Value)
                                    offer.ProductCategory.Category.IdProductCategory = Convert.ToInt64(offerreader["IdCategory"].ToString());
                                offer.ProductCategory.Category.Name = offerreader["ProductCategory"].ToString();
                            }
                        }

                        if (offerreader["AssignedTo"] != DBNull.Value)
                        {
                            offer.AssignedTo = Convert.ToInt32(offerreader["AssignedTo"]);
                            offer.AssignedToPerson = new People { IdPerson = Convert.ToInt32(offer.AssignedTo), Name = Convert.ToString(offerreader["AssignedName"]), Surname = Convert.ToString(offerreader["AssignedSurName"]), Email = Convert.ToString(offerreader["AssignedEmail"]) };
                        }

                        if (offerreader["OfferValue"] != DBNull.Value)
                            offer.OfferValue = Convert.ToDouble(offerreader["OfferValue"].ToString());

                        if (offerreader["IdOfferCurrency"] != DBNull.Value)
                            offer.IdOfferCurrency = Convert.ToByte(offerreader["IdOfferCurrency"].ToString());

                        if (offerreader["IsGoAheadProduction"] != DBNull.Value)
                            offer.IsGoAheadProduction = Convert.ToBoolean(offerreader["IsGoAheadProduction"]);

                        offer.OptionsByOffers = new List<OptionsByOffer>();
                        using (MySqlConnection conoptionsbyoffer = new MySqlConnection(connectionString))
                        {
                            conoptionsbyoffer.Open();
                            MySqlCommand conoptionsbyoffercommand = new MySqlCommand("optionsbyoffer_GetOptionsByOfferId", conoptionsbyoffer);
                            conoptionsbyoffercommand.CommandType = CommandType.StoredProcedure;
                            conoptionsbyoffercommand.Parameters.AddWithValue("_offerId", offer.IdOffer);
                            using (MySqlDataReader optionsbyofferreader = conoptionsbyoffercommand.ExecuteReader())
                            {
                                while (optionsbyofferreader.Read())
                                {

                                    OptionsByOffer optionsbyoffer = new OptionsByOffer();
                                    optionsbyoffer.IdOffer = Convert.ToInt64(optionsbyofferreader["IdOffer"].ToString());
                                    optionsbyoffer.IdOption = Convert.ToInt64(optionsbyofferreader["IdOption"].ToString());
                                    if (optionsbyofferreader["Quantity"] != DBNull.Value)
                                    {
                                        optionsbyoffer.Quantity = Convert.ToInt32(optionsbyofferreader["Quantity"].ToString());
                                        if (optionsbyoffer.Quantity > 0)
                                            optionsbyoffer.IsSelected = true;
                                        else
                                            optionsbyoffer.IsSelected = false;
                                    }
                                    else
                                    {
                                        optionsbyoffer.IsSelected = false;
                                    }
                                    optionsbyoffer.OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(optionsbyofferreader["IdOption"].ToString()), Name = optionsbyofferreader["offeroption"].ToString(), OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(optionsbyofferreader["IdOfferOptionType"].ToString()), Name = optionsbyofferreader["offeroptiontype"].ToString() } };

                                    if (offer.OptionsByOffers.Any(obo => obo.IdOffer == optionsbyoffer.IdOffer && obo.IdOption == optionsbyoffer.IdOption))
                                    {

                                    }
                                    else
                                    {
                                        offer.OptionsByOffers.Add(optionsbyoffer);
                                    }
                                }
                            }


                            if (offer.OptionsByOffers.Any(x => x.IdOption == 25))
                            {
                                List<Quotation> quotationByIdOffer = GetOfferQuotationByIdOffer(offer.IdOffer, connectionString).ToList();

                                Quotation quot = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == 23);

                                if (quot != null)
                                {
                                    EngineeringAnalysis engineeringAnalysis = new EngineeringAnalysis();
                                    Ots ot = GetOTByQuotationId(quot, connectionString);

                                    if (ot != null)
                                    {
                                        engineeringAnalysis.EngineeringAnalysisTypes = GetEngineeringAnalysisTypesByQuotation(quot.IdQuotation, connectionString);
                                        engineeringAnalysis.DueDate = ot.DeliveryDate.Value;

                                        List<OtItem> otitems = GetOtItemsByIdOT(ot, connectionString);
                                        if (otitems.Count > 0)
                                        {
                                            engineeringAnalysis.Comments = otitems[0].CustomerComment;

                                            //If Analysis status is shipped then iscompleted is true.
                                            if (otitems.Any(oti => oti.Status.IdItemOtStatus == 10))
                                            {
                                                engineeringAnalysis.IsCompleted = true;
                                            }
                                        }
                                    }

                                    engineeringAnalysis.Attachments = new List<Attachment>();

                                    string path = workingOrdersPath + @"\" + offer.Year + @"\" + offer.Code + @"\01 Project Specifications\";
                                    if (Directory.Exists(path))
                                    {
                                        string[] files = Directory.GetFiles(path);

                                        foreach (string file in files)
                                        {
                                            Attachment attachment = new Attachment();
                                            attachment.OriginalFileName = Path.GetFileName(file);
                                            attachment.FilePath = Path.GetFullPath(file);
                                            engineeringAnalysis.Attachments.Add(attachment);
                                        }
                                    }

                                    offer.EngineeringAnalysis = engineeringAnalysis;
                                }
                            }
                        }

                        offer.OfferStatusTracking = new List<OfferStatusTracking>();
                        using (MySqlConnection conofferstatus = new MySqlConnection(connectionString))
                        {
                            conofferstatus.Open();
                            MySqlCommand conofferstatuscommand = new MySqlCommand("offerstatustracking_GetOfferStatusTrackingByIdOffer", conofferstatus);
                            conofferstatuscommand.CommandType = CommandType.StoredProcedure;
                            conofferstatuscommand.Parameters.AddWithValue("_idOffer", offer.IdOffer);
                            using (MySqlDataReader offerstatusreader = conofferstatuscommand.ExecuteReader())
                            {
                                while (offerstatusreader.Read())
                                {
                                    if (offer.OfferStatusTracking.Any(ofs => ofs.SalesStatusType.IdSalesStatusType == Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString())))
                                    {
                                        OfferStatusTracking offerStatusTrackingtemp = offer.OfferStatusTracking.Where(ofs => ofs.SalesStatusType.IdSalesStatusType == Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString())).FirstOrDefault();
                                        offerStatusTrackingtemp.IdOfferStatusTracking = Convert.ToInt64(offerstatusreader["IdOfferStatusTracking"].ToString());
                                        offerStatusTrackingtemp.IdOffer = Convert.ToInt64(offerstatusreader["IdOffer"].ToString());
                                        offerStatusTrackingtemp.IdOfferStatusType = Convert.ToInt64(offerstatusreader["IdOfferStatusType"].ToString());
                                        offerStatusTrackingtemp.SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString()), Name = offerstatusreader["Name"].ToString(), HtmlColor = offerstatusreader["HtmlColor"].ToString() };
                                        offerStatusTrackingtemp.StartDate = Convert.ToDateTime(offerstatusreader["StartDate"].ToString());

                                        if (offerstatusreader["EndDate"] != DBNull.Value)
                                        {
                                            offerStatusTrackingtemp.EndDate = offerstatusreader["EndDate"].ToString();
                                        }
                                        else
                                        {
                                            offerStatusTrackingtemp.EndDate = DateTime.Now.ToString();
                                        }

                                        try
                                        {
                                            offerStatusTrackingtemp.NoOfDays = offerStatusTrackingtemp.NoOfDays + (Convert.ToDateTime(Convert.ToDateTime(offerStatusTrackingtemp.EndDate).ToString("yyyy-MM-dd")) - Convert.ToDateTime(offerStatusTrackingtemp.StartDate.ToString("yyyy-MM-dd"))).TotalDays;
                                        }
                                        catch (Exception ex)
                                        {

                                        }
                                    }
                                    else
                                    {
                                        OfferStatusTracking offerStatusTracking = new OfferStatusTracking();
                                        offerStatusTracking.IdOfferStatusTracking = Convert.ToInt64(offerstatusreader["IdOfferStatusTracking"].ToString());
                                        offerStatusTracking.IdOffer = Convert.ToInt64(offerstatusreader["IdOffer"].ToString());
                                        offerStatusTracking.IdOfferStatusType = Convert.ToInt64(offerstatusreader["IdOfferStatusType"].ToString());
                                        offerStatusTracking.SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString()), Name = offerstatusreader["Name"].ToString(), HtmlColor = offerstatusreader["HtmlColor"].ToString() };
                                        offerStatusTracking.StartDate = Convert.ToDateTime(offerstatusreader["StartDate"].ToString());

                                        if (offerstatusreader["EndDate"] != DBNull.Value)
                                        {
                                            offerStatusTracking.EndDate = offerstatusreader["EndDate"].ToString();
                                        }
                                        else
                                        {
                                            offerStatusTracking.EndDate = DateTime.Now.ToString();
                                        }

                                        try
                                        {
                                            offerStatusTracking.NoOfDays = (Convert.ToDateTime(Convert.ToDateTime(offerStatusTracking.EndDate).ToString("yyyy-MM-dd")) - Convert.ToDateTime(offerStatusTracking.StartDate.ToString("yyyy-MM-dd"))).TotalDays;
                                        }
                                        catch (Exception ex)
                                        {

                                        }

                                        offer.OfferStatusTracking.Add(offerStatusTracking);
                                    }
                                }
                            }
                        }
                    }
                }
            }


            return offer;
        }


        public LostReasonsByOffer GetLostReasonsByOffer_V2040(Int64 idOffer, string connectionstring)
        {
            LostReasonsByOffer lostReasonsByOffer = new LostReasonsByOffer();
            using (MySqlConnection conlostReasonsByOffers = new MySqlConnection(connectionstring))
            {
                conlostReasonsByOffers.Open();
                MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("GetlostReasonsByOffer", conlostReasonsByOffers);
                conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                conlostReasonsByOffercommand.Parameters.AddWithValue("_IdOffer", idOffer);
                using (MySqlDataReader lostReasonsByOfferreader = conlostReasonsByOffercommand.ExecuteReader())
                {
                    if (lostReasonsByOfferreader.Read())
                    {
                        lostReasonsByOffer.IdOffer = Convert.ToInt64(lostReasonsByOfferreader["Idoffer"].ToString());
                        lostReasonsByOffer.IdLostReasonList = lostReasonsByOfferreader["IdLostReasonList"].ToString();
                        if (lostReasonsByOfferreader["IdCompetitor"] != DBNull.Value)
                            lostReasonsByOffer.IdCompetitor = Convert.ToInt64(lostReasonsByOfferreader["IdCompetitor"].ToString());
                        lostReasonsByOffer.Comments = lostReasonsByOfferreader["Comments"].ToString();
                    }
                }
                return lostReasonsByOffer;
            }
        }


        public Offer UpdateOffer_V2040(Offer offer, string connectionstring, string offerCodeConnectionString, Int32 idSite, Int32 idUser, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {

            bool isupdatedLeadToOT = true;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            try
            {
                if (offer.IsUpdateLeadToOT)
                {
                    if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
                    {
                        if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                            UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                        else
                            offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
                    }
                    else
                        UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                }

                if (offerInsertedInGCM)
                {
                    MySqlDataAdapter daGCM;
                    DataTable dtGCM;

                    using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                    {
                        conoffer.Open();
                        string query = "select IdOffer from offers where Code= '" + offer.Code + "' and IdOffer =" + offer.IdOffer + " ;";

                        daGCM = new MySqlDataAdapter(query, conoffer);
                        dtGCM = new DataTable();
                        daGCM.Fill(dtGCM);

                        if (dtGCM.Rows.Count > 0)
                            isupdatedLeadToOT = false;
                    }
                    Int64? nullProductCategory = null;
                    if (offer.IdProductCategory > 0)
                    {
                        nullProductCategory = offer.IdProductCategory;
                    }
                    if (offer.IsUpdateLeadToOT)
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("CRM_offersLeadOTUpdate_V2037", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                    conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Parameters.AddWithValue("_OfferedBy", offer.OfferedBy);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();

                                    offer.IsUpdated = true;
                                    trans.Commit();

                                    offer.Year = DateTime.Now.Year;
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }


                    }
                    else
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("CRM_UpdateOffer_V2037", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Parameters.AddWithValue("_OfferedBy", offer.OfferedBy);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();

                                    offer.IsUpdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                }

                if (offer.IsUpdated)
                {


                    UpdateEngAnalysisStatus(dotProjectConnectionString, offer);

                    offer = UpdateQuotation_V2040(offer, connectionstring, dotProjectConnectionString, mailServer, workbenchConnectionString, workingOrdersPath);



                    LostReasonsByOffer lostReasonsByOffer = UpdateLostReasonsByOffer(offer.LostReasonsByOffer, connectionstring);
                    AddLogEntryByOffer_V2040(offer, connectionstring);
                    AddOfferContact(offer.OfferContacts, connectionstring, offer.IdOffer);

                    if (offer.NewlyLinkedActivities != null && offer.NewlyLinkedActivities.Count > 0)
                    {
                        using (var transactionScope = new TransactionScope())
                        {
                            try
                            {
                                AddLinkExistingActivityToOffer_V2031(mainserverConnectionString, offer.NewlyLinkedActivities, offer.Site, offer.IdOffer);
                                transactionScope.Complete();
                            }
                            catch (Exception ex)
                            {
                                if (Transaction.Current != null)
                                    Transaction.Current.Rollback();

                                if (transactionScope != null)
                                    transactionScope.Dispose();

                                throw;
                            }
                        }
                    }



                }
            }
            catch (Exception ex)
            {
                throw;
                offer.IsUpdated = false;
            }

            return offer;
        }

        public void AddLogEntryByOffer_V2040(Offer offer, string connectionstring)
        {
            try
            {


                if (offer.LogEntryByOffers != null)
                {
                    foreach (LogEntryByOffer logEntryByOffer in offer.LogEntryByOffers)
                    {
                        if (logEntryByOffer.IsUpdate)
                        {
                            if (logEntryByOffer.IdLogEntry > 0)
                            {
                                using (MySqlConnection conlogEntryByOffer = new MySqlConnection(connectionstring))
                                {
                                    conlogEntryByOffer.Open();
                                    using (MySqlTransaction trans = conlogEntryByOffer.BeginTransaction())
                                    {
                                        try
                                        {
                                            //string query = "update logentriesbyoffer set comments='" + logEntryByOffer.Comments + "', dateTime='" + DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss") + "'  where idLogEntry=" + logEntryByOffer.IdLogEntry + ";";
                                            MySqlCommand conlogEntryByOffercommand = new MySqlCommand("logEntryByOffer_Update", conlogEntryByOffer);
                                            conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                                            conlogEntryByOffercommand.Parameters.AddWithValue("_IdLogEntry", logEntryByOffer.IdLogEntry);
                                            conlogEntryByOffercommand.Parameters.AddWithValue("_Comment", logEntryByOffer.Comments);
                                            conlogEntryByOffercommand.Parameters.AddWithValue("_logDatetime", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                            conlogEntryByOffercommand.Parameters.AddWithValue("_IsRtfText", logEntryByOffer.IsRtfText);
                                            conlogEntryByOffercommand.Transaction = trans;
                                            conlogEntryByOffercommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }
                            }
                        }

                        else if (logEntryByOffer.IsDeleted)
                        {
                            if (logEntryByOffer.IdLogEntry > 0)
                            {
                                using (MySqlConnection conlogEntryByOffer = new MySqlConnection(connectionstring))
                                {
                                    conlogEntryByOffer.Open();
                                    using (MySqlTransaction trans = conlogEntryByOffer.BeginTransaction())
                                    {
                                        try
                                        {
                                            // string query = "delete from logentriesbyoffer where idLogEntry=" + logEntryByOffer.IdLogEntry + ";";
                                            MySqlCommand conlogEntryByOffercommand = new MySqlCommand("logEntryByOffer_Delete", conlogEntryByOffer);
                                            conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                                            conlogEntryByOffercommand.Parameters.AddWithValue("_IdLogEntry", logEntryByOffer.IdLogEntry);
                                            conlogEntryByOffercommand.Transaction = trans;
                                            conlogEntryByOffercommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            using (MySqlConnection conlogEntryByOffer = new MySqlConnection(connectionstring))
                            {
                                conlogEntryByOffer.Open();
                                using (MySqlTransaction trans = conlogEntryByOffer.BeginTransaction())
                                {
                                    try
                                    {
                                        MySqlCommand conlogEntryByOffercommand = new MySqlCommand("logEntryByOffer_Insert", conlogEntryByOffer);
                                        conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_IdUser", logEntryByOffer.IdUser);
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_Comments", logEntryByOffer.Comments);
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_IdLogEntryType", logEntryByOffer.IdLogEntryType);
                                        conlogEntryByOffercommand.Parameters.AddWithValue("_IsRtfText", logEntryByOffer.IsRtfText);
                                        conlogEntryByOffercommand.Transaction = trans;
                                        conlogEntryByOffercommand.ExecuteNonQuery();
                                        trans.Commit();
                                    }
                                    catch (Exception ex)
                                    {
                                        trans.Rollback();
                                        throw;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;

            }
        }


        public Offer AddOffer_V2040(Offer offer, string connectionString, string offerCodeConnectionString, Int32 idSite, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {

            Int64 offerId = 0;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            if (offer.OfferedBy == 0)
            {
                offer.OfferedBy = null;
            }

            if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
            {
                if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                    UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                else
                    offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
            }
            else
                UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);

            if (offerInsertedInGCM)
            {
                using (MySqlConnection conoffer = new MySqlConnection(connectionString))
                {
                    conoffer.Open();
                    using (MySqlTransaction trans = conoffer.BeginTransaction())
                    {
                        try
                        {
                            // SP:- offers_Insert this sp is used till Sprint58
                            // MySqlCommand conoffercommand = new MySqlCommand("offers_Insert", conoffer);

                            // To Add RFQ changed SP:-offers_Insert_Sprint59 in Sprint59
                            MySqlCommand conoffercommand = new MySqlCommand("CRM_AddOffer_V2037", conoffer);

                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                            conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                            conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                            conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                            conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                            conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                            conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                            conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                            conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                            conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                            conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                            conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                            conoffercommand.Parameters.AddWithValue("_CreatedBy", offer.CreatedBy);
                            conoffercommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                            conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                            conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                            conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                            conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                            conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                            conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                            conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                            conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                            conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                            conoffercommand.Parameters.AddWithValue("_OfferedBy", offer.OfferedBy);
                            conoffercommand.Transaction = trans;

                            offerId = Convert.ToInt64(conoffercommand.ExecuteScalar());
                            offer.IdOffer = offerId;
                            offer.Year = DateTime.Now.Year;

                            UpdateEngAnalysisStatus(dotProjectConnectionString, offer);

                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }

                    }
                }
            }
            if (offerInsertedInGCM && offer.IdOffer > 0)
            {


                offer = AddQuotations_V2040(offer, connectionString, dotProjectConnectionString, mailServer, workbenchConnectionString, workingOrdersPath);
                AddLogEntryByOffer_V2040(offer, connectionString);
                AddOfferContact(offer.OfferContacts, connectionString, offer.IdOffer);


            }

            return offer;
        }


        public Offer AddOfferWithIdSourceOffer_V2040(Offer offer, string connectionString, string offerCodeConnectionString, Int32 idSite, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {
            Int64 offerId = 0;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
            {
                if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                    UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                else
                    offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
            }
            else
                UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);

            if (offerInsertedInGCM)
            {
                using (MySqlConnection conoffer = new MySqlConnection(connectionString))
                {
                    conoffer.Open();
                    using (MySqlTransaction trans = conoffer.BeginTransaction())
                    {
                        try
                        {
                            //MySqlCommand conoffercommand = new MySqlCommand("offers_InsertWithIdSourceOffer", conoffer);
                            MySqlCommand conoffercommand = new MySqlCommand("offers_InsertWithIdSourceOffer_Sprint59", conoffer);
                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                            conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                            conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                            conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                            conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                            conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                            conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                            conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                            conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                            conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                            conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                            conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                            conoffercommand.Parameters.AddWithValue("_CreatedBy", offer.CreatedBy);
                            conoffercommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                            conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                            conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                            conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                            conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                            conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                            conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                            conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                            conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                            conoffercommand.Parameters.AddWithValue("_IdSourceOffer", offer.IdSourceOffer);
                            conoffercommand.Parameters.AddWithValue("_Rfq", offer.Rfq);
                            conoffercommand.Transaction = trans;
                            offerId = Convert.ToInt64(conoffercommand.ExecuteScalar());
                            offer.IdOffer = offerId;
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }

                    }
                }
            }
            if (offerInsertedInGCM && offer.IdOffer > 0)
            {

                AddQuotations_V2033(offer, connectionString, dotProjectConnectionString, mailServer, workbenchConnectionString);
                AddLogEntryByOffer_V2040(offer, connectionString);
                AddOfferContact(offer.OfferContacts, connectionString, offer.IdOffer);

            }
            return offer;
        }

        public bool AddLogEntryByOffer_V2040(LogEntryByOffer logEntryByOffer, string connectionString)
        {
            bool isInserted = false;
            try
            {

                using (MySqlConnection conlogEntryByOffer = new MySqlConnection(connectionString))
                {
                    conlogEntryByOffer.Open();
                    using (MySqlTransaction trans = conlogEntryByOffer.BeginTransaction())
                    {
                        try
                        {
                            MySqlCommand conlogEntryByOffercommand = new MySqlCommand("logEntryByOffer_Insert", conlogEntryByOffer);
                            conlogEntryByOffercommand.CommandType = CommandType.StoredProcedure;
                            conlogEntryByOffercommand.Parameters.AddWithValue("_IdOffer", logEntryByOffer.IdOffer);
                            conlogEntryByOffercommand.Parameters.AddWithValue("_IdUser", logEntryByOffer.IdUser);
                            conlogEntryByOffercommand.Parameters.AddWithValue("_Datetime", DateTime.Now);
                            conlogEntryByOffercommand.Parameters.AddWithValue("_Comments", logEntryByOffer.Comments);
                            conlogEntryByOffercommand.Parameters.AddWithValue("_IdLogEntryType", logEntryByOffer.IdLogEntryType);
                            conlogEntryByOffercommand.Parameters.AddWithValue("_IsRtfText", logEntryByOffer.IsRtfText);

                            conlogEntryByOffercommand.Transaction = trans;
                            conlogEntryByOffercommand.ExecuteNonQuery();
                            isInserted = true;
                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;

            }
            return isInserted;
        }

        public List<OfferContact> GetOfferContact_V2040(Int64 idOffer, string connectionstring)
        {

            List<OfferContact> offerContacts = new List<OfferContact>();
            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionstring))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("offercontacts_GetOfferContacts", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_IdOffer", idOffer);
                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    while (offerreader.Read())
                    {
                        OfferContact offerContact = new OfferContact();
                        offerContact.IdOfferContact = Convert.ToInt64(offerreader["IdOfferContact"].ToString());
                        offerContact.IdContact = Convert.ToInt32(offerreader["IdContact"].ToString());
                        offerContact.IdOffer = Convert.ToInt64(offerreader["IdOffer"].ToString());
                        if (offerreader["IsPrimaryOfferContact"] != DBNull.Value)
                            offerContact.IsPrimaryOfferContact = Convert.ToByte(offerreader["IsPrimaryOfferContact"].ToString());
                        offerContact.People = new People { IdPerson = Convert.ToInt32(offerreader["IdContact"].ToString()), Name = offerreader["Name"].ToString(), Surname = offerreader["Surname"].ToString(), Email = offerreader["Email"].ToString(), Phone = offerreader["Phone"].ToString(), Observations = offerreader["Observations"].ToString() };
                        if (offerreader["IdPersonGender"] != DBNull.Value)
                            offerContact.People.IdPersonGender = Convert.ToByte(offerreader["IdPersonGender"].ToString());

                        if (offerreader["IdCompanyDepartment"] != DBNull.Value)
                        {
                            offerContact.People.IdCompanyDepartment = Convert.ToInt32(offerreader["IdCompanyDepartment"].ToString());
                            offerContact.People.CompanyDepartment = new LookupValue();
                            offerContact.People.CompanyDepartment.IdLookupValue = Convert.ToInt32(offerreader["IdCompanyDepartment"].ToString());
                            offerContact.People.CompanyDepartment.Value = offerreader["Value"].ToString();
                            if (offerreader["IdImage"] != DBNull.Value)
                                offerContact.People.CompanyDepartment.IdImage = Convert.ToInt64(offerreader["IdImage"].ToString());
                            //if (peopleContactreader["InUse"] != DBNull.Value)
                            //    people.CompanyDepartment.InUse = Convert.ToBoolean(peopleContactreader["InUse"].ToString());
                        }
                        offerContact.People.JobTitle = offerreader["JobTitle"].ToString();
                        offerContact.People.ImageText = offerreader["Image"].ToString();

                        offerContacts.Add(offerContact);
                    }
                }
            }
            return offerContacts;
        }


        public bool UpdateOfferForParticularColumn_V2040(Offer offer, string connectionstring, string offerCodeConnectionString, Int32 idSite, Int32 idUser, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {
            bool isupdated = false;
            bool isupdatedLeadToOT = true;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            try
            {
                if (offer.IsUpdateLeadToOT)
                {
                    if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
                    {
                        if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                            UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                        else
                            offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
                    }
                    else
                        UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                }

                if (offerInsertedInGCM)
                {
                    MySqlDataAdapter daGCM;
                    DataTable dtGCM;

                    using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                    {
                        conoffer.Open();
                        string query = "select IdOffer from offers where Code= '" + offer.Code + "' and IdOffer =" + offer.IdOffer + " ;";

                        daGCM = new MySqlDataAdapter(query, conoffer);

                        dtGCM = new DataTable();
                        daGCM.Fill(dtGCM);

                        if (dtGCM.Rows.Count > 0)
                            isupdatedLeadToOT = false;

                    }

                    if (offer.IsUpdateLeadToOT)
                    {

                        using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_LeadOTUpdateParticularColumn", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    //conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                    conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    //conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    //conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    //conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                    else
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("offers_UpdateParticularColumn", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    //conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    //conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    //conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    //conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    //conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);

                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();
                                    isupdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                }

                if (isupdated)
                {
                    UpdateQuotation_V2033(offer, connectionstring, dotProjectConnectionString, mailServer, workbenchConnectionString);

                    //LostReasonsByOffer lostReasonsByOffer = UpdateLostReasonsByOffer(offer.LostReasonsByOffer, offer.Site.ConnectPlantConstr);
                    AddLogEntryByOffer_V2040(offer, connectionstring);
                    //AddOfferContact(offer.OfferContacts, offer.Site.ConnectPlantConstr, offer.IdOffer);
                }

            }
            catch (Exception ex)
            {
                throw;
                //isupdated = false;
            }

            return isupdated;
        }

        public List<Shipment> GetAllShipmentsByOfferId_V2040(string connectionString, Int64 idOffer)
        {

            List<Shipment> shipments = new List<Shipment>();

            using (MySqlConnection conShipment = new MySqlConnection(connectionString))
            {
                conShipment.Open();
                MySqlCommand conShipmentcommand = new MySqlCommand("shipments_GetAllShipmentsByIdOffer", conShipment);

                conShipmentcommand.CommandType = CommandType.StoredProcedure;
                conShipmentcommand.Parameters.AddWithValue("_idOffer", idOffer);

                using (MySqlDataReader shipmentreader = conShipmentcommand.ExecuteReader())
                {
                    while (shipmentreader.Read())
                    {
                        Shipment shipment = new Shipment();
                        shipment.IdShipment = Convert.ToInt64(shipmentreader["IdShipment"].ToString());
                        shipment.EmdepCode = shipmentreader["EmdepCode"].ToString();
                        shipment.DeliveryDate = Convert.ToDateTime(shipmentreader["DeliveryDate"].ToString());
                        shipment.IdTransportAgency = Convert.ToInt32(shipmentreader["IdTransportAgency"].ToString());
                        shipment.ShipmentNumber = shipmentreader["ShipmentNumber"].ToString();
                        if (shipmentreader["CreatedIn"] != DBNull.Value)
                        {
                            shipment.CreatedIn = Convert.ToDateTime(shipmentreader["CreatedIn"].ToString());
                        }
                        if (shipmentreader["IdTransportAgency"] != DBNull.Value)
                        {
                            shipment.TransportAgency = new TransportAgency();
                            shipment.TransportAgency.IdAgency = Convert.ToInt32(shipmentreader["IdTransportAgency"].ToString());
                            shipment.TransportAgency.Name = shipmentreader["TransportAgnecy"].ToString();
                        }
                        if (shipmentreader["CreatedBy"] != DBNull.Value)
                        {
                            shipment.People = new People();
                            shipment.People.IdPerson = Convert.ToInt32(shipmentreader["CreatedBy"].ToString());
                            shipment.People.Name = shipmentreader["Name"].ToString();
                            shipment.People.Surname = shipmentreader["Surname"].ToString();
                        }
                        shipments.Add(shipment);
                    }
                }
            }
            return shipments;
        }

        public List<PackingBox> GetAllPackingBoxesByShipmentId_V2040(string connectionString, Int64 idShipment)
        {

            List<PackingBox> packingBoxes = new List<PackingBox>();

            using (MySqlConnection conShipment = new MySqlConnection(connectionString))
            {
                conShipment.Open();
                MySqlCommand conShipmentcommand = new MySqlCommand("packingboxes_GetAllPackingBoxesByIdShipment", conShipment);

                conShipmentcommand.CommandType = CommandType.StoredProcedure;
                conShipmentcommand.Parameters.AddWithValue("_IdShipment", idShipment);

                using (MySqlDataReader shipmentreader = conShipmentcommand.ExecuteReader())
                {
                    while (shipmentreader.Read())
                    {
                        PackingBox packingBox = new PackingBox();
                        packingBox.IdShipment = Convert.ToInt64(shipmentreader["IdShipment"].ToString());
                        packingBox.Quantity = Convert.ToInt64(shipmentreader["Quantity"].ToString());
                        packingBox.IdPackingBox = Convert.ToInt64(shipmentreader["IdPackingBox"].ToString());
                        packingBox.IdSite = Convert.ToInt32(shipmentreader["IdSite"].ToString());
                        packingBox.BoxNumber = shipmentreader["BoxNumber"].ToString();
                        packingBox.Comments = shipmentreader["attComment"].ToString();
                        packingBox.Length = Convert.ToDouble(shipmentreader["Length"].ToString());
                        packingBox.Width = Convert.ToDouble(shipmentreader["Width"].ToString());
                        packingBox.Height = Convert.ToDouble(shipmentreader["Height"].ToString());
                        packingBox.SizeMeasurementUnit = shipmentreader["SizeMeasurementUnit"].ToString();
                        packingBox.WeightMeasurementUnit = shipmentreader["WeightMeasurementUnit"].ToString();
                        packingBox.NetWeight = Convert.ToDouble(shipmentreader["NetWeight"].ToString());
                        packingBox.GrossWeight = Convert.ToDouble(shipmentreader["GrossWeight"].ToString());
                        packingBox.Shipment = new Shipment();
                        packingBox.Shipment.IdShipment = Convert.ToInt64(shipmentreader["IdShipment"].ToString());
                        packingBox.Shipment.Comments = shipmentreader["comments"].ToString();
                        packingBox.Shipment.DeliveryDate = Convert.ToDateTime(shipmentreader["DeliveryDate"].ToString());
                        packingBoxes.Add(packingBox);
                    }
                }
            }
            return packingBoxes;
        }

        private void InsertEngAnalysisInDotProject_V2040(string dotProjectConnectionString, string connectionString, MailServer mailServer, string workbenchConnectionString, Offer offer, Quotation quotation)
        {
            int idproject;
            int idtaskManagement;
            int idtaskAnalysis;
            bool isCustomerExist = false;
            //Check Customer and plant exist in dotproject database
            Company company = GetSiteCustomerDetails(connectionString, offer.IdCustomer);

            if (company != null)
                isCustomerExist = AddCustomerPlantInDotProject(dotProjectConnectionString, company);

            if (isCustomerExist)
            {
                TransactionScope transactionScope = null;

                try
                {
                    string projectName = GetNextProjectNameFromDotProject(dotProjectConnectionString);
                    EmdepSite site = GetEmdepSiteById(Convert.ToInt32(offer.OfferActiveSite.IdSite), connectionString);

                    using (transactionScope = new TransactionScope(TransactionScopeOption.Required, new TransactionOptions() { IsolationLevel = System.Transactions.IsolationLevel.RepeatableRead }))
                    {
                        UpdateNextProjectNumberOfDotproject(dotProjectConnectionString);

                        using (MySqlConnection connRddotProject = new MySqlConnection(dotProjectConnectionString))
                        {
                            connRddotProject.Open();

                            MySqlCommand MyCommand = new MySqlCommand("epc_InsertIntoProjects", connRddotProject);
                            MyCommand.CommandType = CommandType.StoredProcedure;

                            //MyCommand.CommandText = @"INSERT INTO projects (project_Internal_name, project_company, project_company_internal, project_department, 
                            //                                project_name, project_ot, project_short_name, project_owner, project_url, project_start_date, project_status, 
                            //                                project_color_identifier, project_description, project_creator,project_departments, project_category, 
                            //                                project_type, project_priority, project_plant, project_origin, project_requester, project_end_date) values(?PROJECTINTERNALNAME, ?PROJECTCOMPANY, 
                            //                                ?PROJECTCOMPANYINTERNAL, ?PROJECTDEPARTMENT, ?PROJECTNAME, ?PROJECTOT, ?PROJECTSHORTNAME, ?PROJECTOWNER, ?PROJECTURL, 
                            //                                ?PROJECTSTARTDATE, ?PROJECTSTATUS, ?PROJECTCOLORIDENTIFIER, ?PROJECTDESCRIPTION, ?PROJECTCREATOR, ?PROJECTDEPARTMENTS,
                            //                                ?PROJECTCATEGORY, ?PROJECTTYPE, ?PROJECTPRIORITY, ?PROJECTPLANT, ?PROJECTORIGIN, ?PROJECT_REQUESTER, ?PROJECTENDDATE)";

                            MyCommand.Parameters.AddWithValue("_projectInternalName", projectName);
                            MyCommand.Parameters.AddWithValue("_projectCompany", 260);
                            MyCommand.Parameters.AddWithValue("_projectCompanyInternal", 0);
                            MyCommand.Parameters.AddWithValue("_projectDepartment", 0);
                            MyCommand.Parameters.AddWithValue("_projectName", offer.Description);
                            MyCommand.Parameters.AddWithValue("_projectOt", offer.Code);

                            if (!string.IsNullOrEmpty(offer.Description))
                            {
                                if (offer.Description.Length >= 10)
                                    MyCommand.Parameters.AddWithValue("_projectShortname", offer.Description.Substring(0, 10));
                                else
                                    MyCommand.Parameters.AddWithValue("_projectShortname", offer.Description);
                            }
                            else
                            {
                                MyCommand.Parameters.AddWithValue("_projectShortname", string.Empty);
                            }

                            MyCommand.Parameters.AddWithValue("_projectOwner", 3);
                            MyCommand.Parameters.AddWithValue("_projectUrl", @"file://serveres03/rddotproject$/" + DateTime.Now.Year + @"/" + projectName);
                            MyCommand.Parameters.AddWithValue("_projectStartdate", DateTime.Now);
                            MyCommand.Parameters.AddWithValue("_projectStatus", 9);
                            MyCommand.Parameters.AddWithValue("_projectColorIdentifier", "FF000");
                            MyCommand.Parameters.AddWithValue("_projectDescription", offer.Description);

                            if (offer.CreatedBy > 0)
                                MyCommand.Parameters.AddWithValue("_projectCreator", offer.CreatedBy);          // GOM_v3.Properties.Settings.Default.LOGGED_USER.Id.ToString());
                            else
                                MyCommand.Parameters.AddWithValue("_projectCreator", offer.ModifiedBy);

                            MyCommand.Parameters.AddWithValue("_projectDepartments", string.Empty);

                            //If it is automation we keep it in dotproject as TAU (13)
                            if (offer.IdBusinessUnit == (uint)3)
                                MyCommand.Parameters.AddWithValue("?_projectCategory", 13);
                            else
                                MyCommand.Parameters.AddWithValue("_projectCategory", 1);

                            MyCommand.Parameters.AddWithValue("_projectType", 0);
                            MyCommand.Parameters.AddWithValue("_projectPriority", -1);
                            MyCommand.Parameters.AddWithValue("_projectPlant", offer.IdCustomer);                               //   o.Customer.Id.ToString());
                            MyCommand.Parameters.AddWithValue("_projectOrigin", Convert.ToInt32(offer.Site.ConnectPlantId));    // GOM_v3.Properties.Settings.Default.SITE.ToString());

                            if (offer.CreatedBy > 0)
                                MyCommand.Parameters.AddWithValue("_projectRequester", offer.CreatedBy);                            // GOM_v3.Properties.Settings.Default.LOGGED_USER.Id.ToString());
                            else
                                MyCommand.Parameters.AddWithValue("_projectRequester", offer.ModifiedBy);

                            MyCommand.Parameters.AddWithValue("_projectEnddate", null);

                            idproject = Convert.ToInt32(MyCommand.ExecuteScalar());
                            connRddotProject.Close();
                        }

                        //Task - 00. Management
                        using (MySqlConnection connRddotTask = new MySqlConnection(dotProjectConnectionString))
                        {
                            connRddotTask.Open();

                            MySqlCommand MyCommand = new MySqlCommand("epc_InsertIntoTasks", connRddotTask);
                            MyCommand.CommandType = CommandType.StoredProcedure;

                            //MyCommand.CommandText = @"INSERT INTO tasks (task_name,task_project,task_owner,task_start_date,task_description,task_creator, task_end_date, task_duration, task_type)
                            //                VALUES (?TASKNAME,?TASKPROJECT,?TASKOWNER,?TASKSTARTDATE,?TASKDESCRIPTION, ?TASKCREATOR, ?ENDDATE, ?TASKDURATION, ?TASKTYPE)";

                            MyCommand.Parameters.AddWithValue("_taskName", "00. Management");
                            MyCommand.Parameters.AddWithValue("_taskProject", idproject);
                            MyCommand.Parameters.AddWithValue("_taskOwner", 3);
                            MyCommand.Parameters.AddWithValue("_taskStartdate", DateTime.Now);
                            MyCommand.Parameters.AddWithValue("_taskDescription", "Management");

                            if (offer.CreatedBy > 0)
                                MyCommand.Parameters.AddWithValue("_taskCreator", offer.CreatedBy);         // GOM_v3.Properties.Settings.Default.LOGGED_USER.Id.ToString());
                            else
                                MyCommand.Parameters.AddWithValue("_taskCreator", offer.ModifiedBy);

                            MyCommand.Parameters.AddWithValue("_taskDuration", 1);
                            MyCommand.Parameters.AddWithValue("_taskType", 7);

                            if (quotation.Ots[0].DeliveryDate.Value != null)
                                MyCommand.Parameters.AddWithValue("_taskEnddate", quotation.Ots[0].DeliveryDate.Value.ToString("yyyy-MM-dd 00:00:00"));
                            else
                                MyCommand.Parameters.AddWithValue("_taskEnddate", null);

                            idtaskManagement = Convert.ToInt32(MyCommand.ExecuteScalar());
                            connRddotTask.Close();
                        }

                        //Task - 01.Analysis
                        using (MySqlConnection connRddotTask = new MySqlConnection(dotProjectConnectionString))
                        {
                            connRddotTask.Open();

                            MySqlCommand MyCommand = new MySqlCommand("epc_InsertIntoTasks", connRddotTask);
                            MyCommand.CommandType = CommandType.StoredProcedure;

                            //MyCommand.CommandText = @"INSERT INTO tasks (task_name,task_project,task_owner,task_start_date,task_description,task_creator, task_end_date, task_duration, task_type)
                            //                VALUES (?TASKNAME,?TASKPROJECT,?TASKOWNER,?TASKSTARTDATE,?TASKDESCRIPTION, ?TASKCREATOR, ?ENDDATE, ?TASKDURATION, ?TASKTYPE)";

                            MyCommand.Parameters.AddWithValue("_taskName", "01. Analysis");
                            MyCommand.Parameters.AddWithValue("_taskProject", idproject);
                            MyCommand.Parameters.AddWithValue("_taskOwner", 3);
                            MyCommand.Parameters.AddWithValue("_taskStartdate", DateTime.Now);
                            MyCommand.Parameters.AddWithValue("_taskDescription", "Analysis for the offer");

                            if (offer.CreatedBy > 0)
                                MyCommand.Parameters.AddWithValue("_taskCreator", offer.CreatedBy);         // GOM_v3.Properties.Settings.Default.LOGGED_USER.Id.ToString());
                            else
                                MyCommand.Parameters.AddWithValue("_taskCreator", offer.ModifiedBy);

                            MyCommand.Parameters.AddWithValue("_taskDuration", 1);
                            MyCommand.Parameters.AddWithValue("_taskEnddate", null);
                            MyCommand.Parameters.AddWithValue("_taskType", 5);

                            idtaskAnalysis = Convert.ToInt32(MyCommand.ExecuteScalar());
                            connRddotTask.Close();
                        }

                        //Insert custom field values.
                        using (MySqlConnection connRddotCustomField = new MySqlConnection(dotProjectConnectionString))
                        {
                            connRddotCustomField.Open();

                            MySqlCommand MyCommand = new MySqlCommand("epc_InsertIntoCustomFieldsValues", connRddotCustomField);
                            MyCommand.CommandType = CommandType.StoredProcedure;

                            //GOM_v3.Properties.Settings.Default.SITE);

                            //MyCommand.CommandText = @"INSERT INTO custom_fields_values (value_id, value_module, value_object_id,value_field_id,value_charvalue, value_intvalue)
                            //                VALUES ((SELECT id + 1 FROM custom_fields_values_id c),?MODULE, ?ID, ?FIELD_ID, ?CHARVALUE, ?INTVALUE)";

                            MyCommand.Parameters.AddWithValue("_Module", string.Empty);
                            MyCommand.Parameters.AddWithValue("_Id", idproject);
                            MyCommand.Parameters.AddWithValue("_FieldId", 8);
                            MyCommand.Parameters.AddWithValue("_CharValue", "file://" + site.FileServerIP + "/WorkingOrders$/" + offer.Year.ToString() + "/" + offer.Code);
                            MyCommand.Parameters.AddWithValue("_Intvalue", "0");

                            MyCommand.ExecuteNonQuery();

                            connRddotCustomField.Close();

                            //MyCommand.CommandText = @"UPDATE rddotproject.custom_fields_values_id set id=id+1;";
                            //MyCommand.ExecuteNonQuery();
                        }

                        //tasks
                        UpdateTaskParentInDotProject(dotProjectConnectionString, idtaskManagement);
                        UpdateTaskParentInDotProject(dotProjectConnectionString, idtaskAnalysis);

                        transactionScope.Complete();
                    }

                    // GOM_v3.Properties.Settings.Default.Email_New_Project_DotProject;
                    ApplicationManager applicationManager = new ApplicationManager();
                    GeosAppSetting geosAppSetting = GetGeosAppSettings(1, workbenchConnectionString);

                    applicationManager.SendNewRddotProjectMail(mailServer, geosAppSetting.DefaultValue, projectName, offer, quotation.Ots[0].DeliveryDate.Value.ToString("yyyy-MM-dd"));

                    //Email to people.
                    //string subject = string.Format("[GEOS notification] New Project {0}", offer.Code);
                    //string description = string.Format(@"{0} from Commercial department has created the following project: 
                    //                    - Description: {1} 
                    //                    - Working Order: {2} 
                    //                    - Internal ID: {3}
                    //                    - Customer: {4} 
                    //                    - Delivery date: {5}", "skhade", offer.Description, offer.Code, projectName, offer.Customer.FullName, quotation.Ots[0].DeliveryDate.Value.ToString("yyyy-MM-dd"));

                    /////GOM_v3.Properties.Settings.Default.LOGGED_USER.FullName replaced with skhade
                    //string to = ""; // GOM_v3.Properties.Settings.Default.Email_New_Project_DotProject;
                    //cm.SendMail(to, GOM_v3.Properties.Settings.Default.LOGGED_USER, string.Empty, subject, description, GOM_v3.Properties.Settings.Default.EMAIL_SERVER);
                    //Ho desactivem perqu els comercials no han de tenir perms a R&D
                    //CreateFoldersForDotproject(projectName, q);
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }
        }

        public Offer AddQuotations_V2040(Offer offer, string connectionstring, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString, string WorkingOrdersPath)
        {
            try
            {
                foreach (OptionsByOffer optionsByOffer in offer.OptionsByOffers)
                {
                    List<Template> selectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                    Template selectedOptiontemplate = GetDefaultArticleByIdOfferOption(optionsByOffer.IdOption, connectionstring);
                    if (selectedOptiontemplate != null)
                        selectedOptionTemplates.Add(selectedOptiontemplate);

                    using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                    {
                        conquotation.Open();

                        using (MySqlTransaction trans = conquotation.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand conquotationcommand = new MySqlCommand("optionsbyoffer_Insert", conquotation);
                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                conquotationcommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                conquotationcommand.Parameters.AddWithValue("_Quantity", optionsByOffer.Quantity);
                                conquotationcommand.Transaction = trans;
                                conquotationcommand.ExecuteNonQuery();

                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }

                    foreach (Template quotation in selectedOptionTemplates)
                    {
                        Int64 idQuotation = 0;
                        Quotation tempquotation = new Quotation();
                        tempquotation.Offer = new Offer();
                        tempquotation.Offer.IdOffer = offer.IdOffer;
                        tempquotation.Year = DateTime.Now.Year;
                        tempquotation.Number = offer.Number;
                        tempquotation.Code = offer.Code + quotation.Suffix;
                        tempquotation.CreatedIn = DateTime.Now;
                        tempquotation.Template = new Template();
                        tempquotation.Template = quotation;

                        if (quotation.IdTemplate != 0)
                        {
                            string quotationCode = offer.Code + quotation.Suffix;
                            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                            {
                                conquotation.Open();
                                using (MySqlTransaction trans = conquotation.BeginTransaction())
                                {
                                    try
                                    {
                                        MySqlCommand conquotationcommand = new MySqlCommand("quotations_Insert", conquotation);
                                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                                        conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                        conquotationcommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                        conquotationcommand.Parameters.AddWithValue("_Description", offer.Description);
                                        conquotationcommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                        conquotationcommand.Parameters.AddWithValue("_Number", offer.Number);
                                        conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                        conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                        conquotationcommand.Parameters.AddWithValue("_QuotQuantity", 0);
                                        conquotationcommand.Transaction = trans;
                                        idQuotation = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                                        if (idQuotation > 0)
                                        {
                                            bool isinsert = false;
                                            MySqlCommand conoffercommand = new MySqlCommand("revisions_GetrevisionsByIdQuotation", conquotation);
                                            conoffercommand.CommandType = CommandType.StoredProcedure;
                                            conoffercommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                            using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                                            {
                                                if (!offerreader.Read())
                                                {
                                                    isinsert = true;
                                                }
                                            }

                                            if (isinsert)
                                            {
                                                Revision r = new Revision();
                                                r.NumRevision = 0;
                                                //[001]
                                                if (offer.CreatedBy != null && offer.CreatedBy == 164)
                                                {
                                                    r.CreatedBy = 164;
                                                    r.ReviewedBy = 164;
                                                }
                                                else
                                                {
                                                    r.CreatedBy = offer.CreatedBy;
                                                    r.ReviewedBy = offer.CreatedBy;
                                                }
                                                r.CreatedIn = DateTime.Now;
                                                r.NumRevision = 0;
                                                r.Discount = 0;
                                                r.ExpireDate = DateTime.Now.AddDays(14);
                                                r.Comments = offer.Contact + "\r\n" + offer.Description;
                                                //r.Quotation = quotation;
                                                if (quotation.IdTemplate == 15 || quotation.IdTemplate == 16 || quotation.IdTemplate == 18)
                                                    r.ApprovedIn = DateTime.Now;
                                                else
                                                    r.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");

                                                conquotationcommand = new MySqlCommand("revisions_Insert", conquotation);
                                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                                                conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r.ReviewedBy);
                                                conquotationcommand.Parameters.AddWithValue("_NumRevision", r.NumRevision);
                                                conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.CreatedBy);
                                                conquotationcommand.Parameters.AddWithValue("_MadeBy", r.CreatedBy);
                                                conquotationcommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                                conquotationcommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                                conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                                                conquotationcommand.Parameters.AddWithValue("_CreationDate", r.CreatedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_Comments", r.Comments);
                                                conquotationcommand.Parameters.AddWithValue("_Closed", r.ApprovedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Transaction = trans;
                                                r.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                tempquotation.Revisions = new List<Revision>();
                                                tempquotation.Revisions.Add(r);

                                            }
                                        }

                                        trans.Commit();
                                    }
                                    catch (Exception ex)
                                    {
                                        trans.Rollback();
                                        throw;
                                    }
                                }
                            }
                        }

                        tempquotation.IdQuotation = idQuotation;
                        ///////////////////////////////////////////////////////
                        if (offer.IdOfferType != 10 && quotation.IdTemplate == 15)
                        {
                            List<OtItem> items = new List<OtItem>();

                            List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                            items.AddRange(temp);

                            if (items.Count != 0)
                                CreateQuotationWithItems_V2040(tempquotation, offer, items, connectionstring);
                        }
                        else if (offer.IdOfferType != 10 && quotation.IdTemplate == 23)
                        {
                            List<OtItem> items = new List<OtItem>();
                            List<OtItem> temp = new List<OtItem>();
                            if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                temp = GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring, offer.EngineeringAnalysis.EngineeringAnalysisTypes);
                            else
                                temp = GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring, null);


                            items.AddRange(temp);
                            if (items.Count != 0)
                                CreateQuotationWithItems_V2040(tempquotation, offer, items, connectionstring);

                            //link EPC for eng analysis. 
                            if (!ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                InsertEngAnalysisInDotProject_V2040(dotProjectConnectionString, connectionstring, mailServer, workbenchConnectionString, offer, tempquotation);
                            else
                                UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, tempquotation, workbenchConnectionString, mailServer);

                            if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.IsCompleted &&
                                tempquotation != null && tempquotation.Ots != null && tempquotation.Ots.Count > 0
                                && tempquotation.Ots[0].Items != null && tempquotation.Ots[0].Items.Count > 0)
                            {
                                ApplicationManager app = new ApplicationManager();

                                //This property is for AssignedEngAnalysis from dotproject.
                                People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);
                                app.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.CreatedByUser, assignedEngAnalysisPerson, tempquotation.Ots[0].DeliveryDate);

                                LogEntryByOffer log = new LogEntryByOffer();
                                log.IdUser = offer.CreatedBy;
                                log.DateTime = DateTime.Now;
                                log.Comments = "The analysis of engineering department has been completed.";
                                log.IdLogEntryType = 2;
                                offer.LogEntryByOffers.Add(log);
                            }

                        }
                    }


                }




            }
            catch (Exception ex)
            {
                throw;
            }
            return offer;
        }

        private Offer UpdateQuotation_V2040(Offer offer, string connectionstring, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString, string WorkingOrdersPath)
        {
            List<Quotation> quotationByIdOffer = GetOfferQuotationByIdOffer(offer.IdOffer, connectionstring).ToList();
            List<byte> quotIdDetectionsTemplates = quotationByIdOffer.Select(fg => fg.IdDetectionsTemplate).ToList();

            //List<byte> quotIdDetectionsTemplates = GetOfferQuotationByIdOffer(offer.IdOffer, connectionstring).ToList().Select(fg => fg.IdDetectionsTemplate).ToList();

            List<byte> selectedOptionByOfferTemplates = GetTemplatesBySelectedOptionsByOffer(connectionstring, offer.OptionsByOffers.Where(op => op.IsSelected == true).ToList());


            foreach (OptionsByOffer optionsByOffer in offer.OptionsByOffers)
            {
                if (optionsByOffer.IsSelected == true && optionsByOffer.Quantity > 0)
                {
                    List<Template> selectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                    Template selectedOptiontemplate = GetDefaultArticleByIdOfferOption_V2034(optionsByOffer.IdOption, connectionstring);
                    if (selectedOptiontemplate != null)
                        selectedOptionTemplates.Add(selectedOptiontemplate);

                    using (MySqlConnection conoption = new MySqlConnection(connectionstring))
                    {
                        conoption.Open();
                        using (MySqlTransaction trans = conoption.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand conoptioncommand = new MySqlCommand("optionsbyoffer_Update", conoption);
                                conoptioncommand.CommandType = CommandType.StoredProcedure;
                                conoptioncommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                conoptioncommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                conoptioncommand.Parameters.AddWithValue("_Quantity", optionsByOffer.Quantity);
                                conoptioncommand.Transaction = trans;
                                conoptioncommand.ExecuteNonQuery();
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }


                    foreach (Template quotation in selectedOptionTemplates)
                    {
                        if (!quotIdDetectionsTemplates.Contains(quotation.IdTemplate))
                        {
                            bool isUpdate = false;
                            string quotationCode = offer.Code + quotation.Suffix;
                            Int64 idQuotation = 0;

                            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                            {
                                conquotation.Open();
                                MySqlCommand conquotationcommand = new MySqlCommand("quotations_GetquotationsByCode", conquotation);
                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                using (MySqlDataReader reader = conquotationcommand.ExecuteReader())
                                {
                                    if (reader.Read())
                                    {
                                        isUpdate = true;

                                        if (reader["IdQuotation"] != DBNull.Value)
                                        {
                                            idQuotation = Convert.ToInt64(reader["IdQuotation"]);
                                        }
                                    }
                                }
                            }

                            if (isUpdate)
                            {
                                using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                {
                                    conquotation.Open();
                                    using (MySqlTransaction trans = conquotation.BeginTransaction())
                                    {
                                        try
                                        {
                                            // string sqlQuery = "update quotations set IdOffer=" + offer.IdOffer + " where IdDetectionsTemplate = " + quotation.IdTemplate + " AND Code = '" + quotationCode + "';";
                                            MySqlCommand conquotationcommand = new MySqlCommand("quotations_UpdateByCode", conquotation);
                                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                                            conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                            conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                            conquotationcommand.Transaction = trans;
                                            conquotationcommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }

                                //Engineering analysis update code. Comment and date when added from unlinked to linked.
                                if (optionsByOffer.IdOption == 25)
                                {
                                    Quotation quot = new Quotation();
                                    quot.IdQuotation = idQuotation;
                                    quot.Code = quotationCode;
                                    if (quot != null)
                                    {
                                        if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                        {
                                            isUpdateEngAnalysisRevisionQuantity(quot, offer, offer.EngineeringAnalysis.EngineeringAnalysisTypes, connectionstring);
                                        }

                                        List<OtItem> defaultArticleNotInWarehouseProduct = new List<OtItem>();
                                        if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                        {
                                            defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct(quot.IdQuotation, connectionstring, offer.EngineeringAnalysis.EngineeringAnalysisTypes);
                                        }
                                        else
                                        {
                                            defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct(quot.IdQuotation, connectionstring, null);
                                        }
                                        if (defaultArticleNotInWarehouseProduct.Count > 0)
                                        {
                                            //Generate revisionitem in rev0 and rev1 and otitem for that revsion 1
                                            CreateDefaultArticlesNotExistItems_V2040(quot, offer, defaultArticleNotInWarehouseProduct, connectionstring);
                                        }


                                        List<OtItem> otitems = null;

                                        Ots ot = GetOTByQuotationId(quot, connectionstring);
                                        if (ot != null)
                                        {
                                            otitems = GetOtItemsByIdOT(ot, connectionstring);

                                            using (var transactionScope = new TransactionScope())
                                            {
                                                try
                                                {
                                                    UpdateOTByIdOT(offer, quot, ot, connectionstring);

                                                    foreach (var otItem in otitems)
                                                    {
                                                        UpdateOTitemByIdOtItem(offer, otItem, connectionstring);

                                                        //Get part number tracking and add update tracking
                                                        PartNumbersTracking partNumbersTracking = GetPartNumbersTrackingByIdOtItem(otItem, 23, connectionstring);

                                                        if (partNumbersTracking != null)
                                                        {
                                                            if (otItem.Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                                            {
                                                                partNumbersTracking.IdOperator = offer.ModifiedBy;
                                                                partNumbersTracking.EndDate = DateTime.Now;
                                                                partNumbersTracking.Paused = false;
                                                            }
                                                            else if (otItem.Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                            {
                                                                partNumbersTracking.IdOperator = null;
                                                                partNumbersTracking.EndDate = null;
                                                                partNumbersTracking.Paused = true;

                                                            }

                                                            UpdatePartNumbersTrackingByIdPartNumbersTracking(offer, partNumbersTracking, connectionstring);
                                                        }


                                                    }
                                                    transactionScope.Complete();
                                                }
                                                catch (Exception ex)
                                                {
                                                    if (Transaction.Current != null)
                                                        Transaction.Current.Rollback();

                                                    if (transactionScope != null)
                                                        transactionScope.Dispose();

                                                    throw;
                                                }
                                            }

                                            quot.Ots = new List<Ots>();
                                            quot.Ots.Add(ot);
                                            UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, quot, workbenchConnectionString, mailServer);

                                            if (otitems != null && otitems.Count > 0)
                                            {
                                                ApplicationManager applicationManager = new ApplicationManager();

                                                //This property is for AssignedEngAnalysis from dotproject.
                                                People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);

                                                // Send email when eng analysis is validated by 
                                                if (otitems[0].Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                                {
                                                    if (offer.EngineeringAnalysis != null)
                                                        applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                                    else
                                                        applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, ot.DeliveryDate);

                                                    LogEntryByOffer log = new LogEntryByOffer();
                                                    log.IdUser = offer.ModifiedBy;
                                                    log.DateTime = DateTime.Now;
                                                    log.Comments = "The analysis of engineering department has been completed.";
                                                    log.IdLogEntryType = 2;
                                                    offer.LogEntryByOffers.Add(log);
                                                }
                                                else if (otitems[0].Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                {
                                                    if (offer.EngineeringAnalysis != null)
                                                        applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                                    else
                                                        applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, ot.DeliveryDate);

                                                    LogEntryByOffer log = new LogEntryByOffer();
                                                    log.IdUser = offer.ModifiedBy;
                                                    log.DateTime = DateTime.Now;
                                                    log.Comments = "The analysis of engineering department has been re-opened.";
                                                    log.IdLogEntryType = 2;
                                                    offer.LogEntryByOffers.Add(log);
                                                }
                                            }
                                        }
                                    }


                                }
                            }
                            else
                            {
                                //Int64 idQuotation = 0;
                                Quotation tempquotation = new Quotation();
                                tempquotation.Offer = new Offer();
                                tempquotation.Offer.IdOffer = offer.IdOffer;
                                tempquotation.Year = DateTime.Now.Year;
                                tempquotation.Number = offer.Number;
                                tempquotation.Code = offer.Code + quotation.Suffix;
                                tempquotation.CreatedIn = DateTime.Now;
                                tempquotation.Template = new Template();
                                tempquotation.Template = quotation;
                                if (quotation.IdTemplate != 0)
                                {
                                    // string quotationCode = offer.Code + quotation.Suffix;
                                    using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                    {
                                        conquotation.Open();
                                        using (MySqlTransaction trans = conquotation.BeginTransaction())
                                        {
                                            try
                                            {
                                                MySqlCommand conquotationcommand = new MySqlCommand("quotations_Insert", conquotation);
                                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                                conquotationcommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                                conquotationcommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                                conquotationcommand.Parameters.AddWithValue("_Number", offer.Number);
                                                conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                                conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                                conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                                conquotationcommand.Parameters.AddWithValue("_QuotQuantity", 0);
                                                conquotationcommand.Parameters.AddWithValue("_Description", offer.Description);
                                                conquotationcommand.Transaction = trans;
                                                idQuotation = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                if (idQuotation > 0)
                                                {
                                                    bool isinsert = false;
                                                    MySqlCommand conoffercommand = new MySqlCommand("revisions_GetrevisionsByIdQuotation", conquotation);
                                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                                    conoffercommand.Parameters.AddWithValue("_IdQuotation", idQuotation);

                                                    using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                                                    {
                                                        if (!offerreader.Read())
                                                        {
                                                            isinsert = true;
                                                        }
                                                    }

                                                    if (isinsert)
                                                    {
                                                        Revision r = new Revision();
                                                        r.NumRevision = 0;
                                                        //[001]
                                                        if (offer.ModifiedBy != null && offer.ModifiedBy == 164)
                                                        {
                                                            r.CreatedBy = 164;
                                                            r.ReviewedBy = 164;
                                                        }
                                                        else
                                                        {
                                                            r.CreatedBy = offer.ModifiedBy;
                                                            r.ReviewedBy = offer.ModifiedBy;
                                                        }
                                                        r.CreatedIn = DateTime.Now;
                                                        r.NumRevision = 0;
                                                        r.Discount = 0;
                                                        r.ExpireDate = DateTime.Now.AddDays(14);
                                                        r.Comments = offer.Contact + "\r\n" + offer.Description;
                                                        //r.Quotation = quotation;
                                                        if (quotation.IdTemplate == 15 || quotation.IdTemplate == 16 || quotation.IdTemplate == 18)
                                                            r.ApprovedIn = DateTime.Now;
                                                        else
                                                            r.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");

                                                        conquotationcommand = new MySqlCommand("revisions_Insert", conquotation);
                                                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                        conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                                                        conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r.ReviewedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_NumRevision", r.NumRevision);
                                                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_MadeBy", r.CreatedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                                        conquotationcommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                                        conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                                                        conquotationcommand.Parameters.AddWithValue("_CreationDate", r.CreatedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_Comments", r.Comments);
                                                        conquotationcommand.Parameters.AddWithValue("_Closed", r.ApprovedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Transaction = trans;
                                                        r.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                        tempquotation.Revisions = new List<Revision>();
                                                        tempquotation.Revisions.Add(r);
                                                    }
                                                }
                                                trans.Commit();
                                            }
                                            catch (Exception ex)
                                            {
                                                trans.Rollback();
                                                throw;
                                            }
                                        }
                                    }

                                    tempquotation.IdQuotation = idQuotation;

                                    ///////////////////////////////////////////////////////

                                    if (offer.IdOfferType != 10 && quotation.IdTemplate == 15) // || quotation.IdTemplate == 23))
                                    {
                                        List<OtItem> items = new List<OtItem>();

                                        List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                                        items.AddRange(temp);
                                        if (items.Count != 0)
                                            CreateQuotationWithItems_V2040(tempquotation, offer, items, connectionstring);
                                    }
                                    else if (offer.IdOfferType != 10 && quotation.IdTemplate == 23)
                                    {
                                        List<OtItem> items = new List<OtItem>();
                                        List<OtItem> temp = new List<OtItem>();
                                        if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                            temp = GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring, offer.EngineeringAnalysis.EngineeringAnalysisTypes);
                                        else
                                            temp = GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring, null);

                                        items.AddRange(temp);
                                        if (items.Count != 0)
                                            CreateQuotationWithItems_V2040(tempquotation, offer, items, connectionstring);

                                        //link EPC for eng analysis. 
                                        if (!ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                            InsertEngAnalysisInDotProject_V2040(dotProjectConnectionString, connectionstring, mailServer, workbenchConnectionString, offer, tempquotation);
                                        else
                                            UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, tempquotation, workbenchConnectionString, mailServer);
                                        //GOM_v3.Properties.Settings.Default.Email_Delivery_Date_Changed


                                    }
                                }
                            }
                        }
                        else
                        {
                            //Update Quotation Codes when offer type is changed.
                            string quotationCode = offer.Code + quotation.Suffix;

                            Quotation quotationByOffer = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == quotation.IdTemplate);

                            if (quotation != null)
                                UpdateQuotationCodeIfTypeChanged(offer, quotationByOffer, quotation, connectionstring);

                            if (optionsByOffer.IdOption == 25) //Engineering analysis update code.
                            {
                                Quotation quot = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == 23);
                                quot.Code = quotationCode;
                                if (quot != null)
                                {
                                    if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                    {
                                        isUpdateEngAnalysisRevisionQuantity(quot, offer, offer.EngineeringAnalysis.EngineeringAnalysisTypes, connectionstring);
                                    }

                                    List<OtItem> defaultArticleNotInWarehouseProduct = new List<OtItem>();
                                    if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                    {
                                        defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct(quot.IdQuotation, connectionstring, offer.EngineeringAnalysis.EngineeringAnalysisTypes);
                                    }
                                    else
                                    {
                                        defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct(quot.IdQuotation, connectionstring, null);
                                    }
                                    if (defaultArticleNotInWarehouseProduct.Count > 0)
                                    {
                                        //Generate revisionitem in rev0 and rev1 and otitem for that revsion 1
                                        CreateDefaultArticlesNotExistItems_V2040(quot, offer, defaultArticleNotInWarehouseProduct, connectionstring);
                                    }

                                    Ots ot = GetOTByQuotationId(quot, connectionstring);
                                    List<OtItem> otitems = null;

                                    if (ot != null)
                                    {
                                        otitems = GetOtItemsByIdOT(ot, connectionstring);

                                        using (var transactionScope = new TransactionScope())
                                        {
                                            try
                                            {
                                                UpdateOTByIdOT(offer, quot, ot, connectionstring);

                                                foreach (var otItem in otitems)
                                                {
                                                    UpdateOTitemByIdOtItem(offer, otItem, connectionstring);

                                                    //Get part number tracking and add update tracking
                                                    PartNumbersTracking partNumbersTracking = GetPartNumbersTrackingByIdOtItem(otItem, 23, connectionstring);

                                                    if (partNumbersTracking != null)
                                                    {
                                                        if (otItem.Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                                        {
                                                            partNumbersTracking.IdOperator = offer.ModifiedBy;
                                                            partNumbersTracking.EndDate = DateTime.Now;
                                                            partNumbersTracking.Paused = false;
                                                        }
                                                        else if (otItem.Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                        {
                                                            partNumbersTracking.IdOperator = null;
                                                            partNumbersTracking.EndDate = null;
                                                            partNumbersTracking.Paused = true;
                                                        }

                                                        UpdatePartNumbersTrackingByIdPartNumbersTracking(offer, partNumbersTracking, connectionstring);
                                                    }
                                                }

                                                transactionScope.Complete();
                                            }
                                            catch (Exception ex)
                                            {
                                                if (Transaction.Current != null)
                                                    Transaction.Current.Rollback();

                                                if (transactionScope != null)
                                                    transactionScope.Dispose();

                                                throw;
                                            }
                                        }
                                    }

                                    quot.Ots = new List<Ots>();
                                    quot.Ots.Add(ot);
                                    if (ot != null)
                                        UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, quotationByOffer, workbenchConnectionString, mailServer);

                                    if (otitems != null && otitems.Count > 0)
                                    {
                                        ApplicationManager applicationManager = new ApplicationManager();

                                        //This property is for AssignedEngAnalysis from dotproject.
                                        People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);

                                        // Send email when eng analysis is validated by 
                                        if (otitems[0].Status.IdItemOtStatus != 10 && offer.EngineeringAnalysis.IsCompleted)
                                        {
                                            if (offer.EngineeringAnalysis != null)
                                            {
                                                applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                            }
                                            else
                                            {
                                                applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, ot.DeliveryDate);
                                            }

                                            LogEntryByOffer log = new LogEntryByOffer();
                                            log.IdUser = offer.ModifiedBy;
                                            log.DateTime = DateTime.Now;
                                            log.Comments = "The analysis of engineering department has been completed.";
                                            log.IdLogEntryType = 2;
                                            offer.LogEntryByOffers.Add(log);
                                        }
                                        else if (otitems[0].Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                        {
                                            if (offer.EngineeringAnalysis != null)
                                            {
                                                applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                            }
                                            else
                                            {
                                                applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, ot.DeliveryDate);
                                            }

                                            LogEntryByOffer log = new LogEntryByOffer();
                                            log.IdUser = offer.ModifiedBy;
                                            log.DateTime = DateTime.Now;
                                            log.Comments = "The analysis of engineering department has been re-opened.";
                                            log.IdLogEntryType = 2;
                                            offer.LogEntryByOffers.Add(log);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                else
                {
                    if (optionsByOffer.IsSelected == false && optionsByOffer.Quantity == 0)
                    {
                        if (optionsByOffer.IdOption == 25)
                        {
                            if (offer.IsEngAnalysisSetONToOFF)
                                UnlinkedEngAnalysisTypesFromOfferSetQuantity0(offer, connectionstring);

                        }


                        using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                        {
                            conquotation.Open();
                            using (MySqlTransaction trans = conquotation.BeginTransaction())
                            {
                                try
                                {
                                    //string sqlQuery = "DELETE FROM optionsbyoffer WHERE IdOffer = " + offer.IdOffer + " AND IdOption = " + optionsByOffer.IdOption + ";";
                                    MySqlCommand conquotationcommand = new MySqlCommand("optionsbyoffer_Delete", conquotation);
                                    conquotationcommand.CommandType = CommandType.StoredProcedure;
                                    conquotationcommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                    conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conquotationcommand.Transaction = trans;
                                    conquotationcommand.ExecuteNonQuery();

                                    if (optionsByOffer.IdOption == 25 && ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                        UpdateProjectStatusInDotProject(dotProjectConnectionString, offer, 7);

                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }

                        List<Template> unselectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                        Template unselectedOptionTemplate = GetDefaultArticleByIdOfferOption_V2034(optionsByOffer.IdOption, connectionstring);

                        if (unselectedOptionTemplate != null)
                            unselectedOptionTemplates.Add(unselectedOptionTemplate);

                        foreach (Template quotation in unselectedOptionTemplates)
                        {
                            if (!selectedOptionByOfferTemplates.Contains(quotation.IdTemplate))
                            {
                                using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                {
                                    conquotation.Open();
                                    using (MySqlTransaction trans = conquotation.BeginTransaction())
                                    {
                                        try
                                        {
                                            //string sqlQuery = "update quotations set IdOffer=null where IdDetectionsTemplate = " + quotation.IdTemplate + " AND IdOffer = " + offer.IdOffer + ";";
                                            MySqlCommand conquotationcommand = new MySqlCommand("quotations_UpdateByIdOfferANDTemplate", conquotation);
                                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                                            conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                            conquotationcommand.Transaction = trans;
                                            conquotationcommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }
                            }
                        }



                    }

                }

            }
            return offer;

        }

        private void InsertPartNumber_V2040(Offer offer, OtItem oi, string connectionString)
        {
            string barCode = GetBarCode(oi.Quotation.Code);

            for (int i = 1; i <= oi.RevisionItem.Quantity; i++)
            {
                string code = barCode + Convert.ToUInt32(oi.RevisionItem.NumItem).ToString("000") + i.ToString("000");
                uint idPartNumber = 0;

                using (MySqlConnection conrevision = new MySqlConnection(connectionString))
                {
                    conrevision.Open();

                    try
                    {
                        MySqlCommand conquotationcommand = new MySqlCommand("PartNumbers_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_CODE", code);
                        conquotationcommand.Parameters.AddWithValue("_OTITEM", oi.IdOTItem);
                        conquotationcommand.Parameters.AddWithValue("_IdPartNumberType", null);
                        conquotationcommand.Parameters.AddWithValue("_IdPackingBox", null);
                        conquotationcommand.Parameters.AddWithValue("_ID", null);

                        idPartNumber = Convert.ToUInt32(conquotationcommand.ExecuteScalar());
                    }
                    catch (Exception ex)
                    {
                        throw;
                    }
                }

                //busquem les etapes de l'article  i per cada etapa creem un tracking
                List<int> stages = new List<int>();

                using (MySqlConnection conrevision = new MySqlConnection(connectionString))
                {
                    conrevision.Open();

                    try
                    {
                        MySqlCommand conStagesArticlecommand = new MySqlCommand("Get_StagesByArticle", conrevision);
                        conStagesArticlecommand.CommandType = CommandType.StoredProcedure;
                        conStagesArticlecommand.Parameters.AddWithValue("_IdArticle", oi.RevisionItem.WarehouseProduct.Article.IdArticle);
                        conStagesArticlecommand.Parameters.AddWithValue("_IdSite", Convert.ToInt32(offer.OfferActiveSite.IdSite));
                        conStagesArticlecommand.Parameters.AddWithValue("_IdStage", null);
                        conStagesArticlecommand.Parameters.AddWithValue("_Sequence", null);

                        using (MySqlDataReader reader = conStagesArticlecommand.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                stages.Add(Convert.ToInt32(reader["idStage"]));
                            }
                        }

                        conrevision.Close();
                    }
                    catch (Exception ex)
                    {
                        throw;
                    }
                }

                //si l'etapa es COMERCIAL (1) la creem en l'usuari que hi ha logat, sin en l'usuari system
                //i sense endDate. l'startDate es modificar quan l'article arribi a cada etapa
                foreach (int stg in stages)
                {
                    using (MySqlConnection conrevision = new MySqlConnection(connectionString))
                    {
                        conrevision.Open();

                        try
                        {
                            MySqlCommand conPNTcommand = new MySqlCommand("PartNumbersTracking_Insert", conrevision);
                            conPNTcommand.CommandType = CommandType.StoredProcedure;
                            conPNTcommand.Parameters.AddWithValue("_IdPartNumber", idPartNumber);
                            conPNTcommand.Parameters.AddWithValue("_IdStage", stg);
                            conPNTcommand.Parameters.AddWithValue("_StartDate", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            conPNTcommand.Parameters.AddWithValue("_CurrentTime", Convert.ToInt32(0));
                            conPNTcommand.Parameters.AddWithValue("_Rework", false);

                            //Unused
                            conPNTcommand.Parameters.AddWithValue("_IdCause", null);
                            conPNTcommand.Parameters.AddWithValue("_Remarks", null);

                            if (stg == 1)
                            {
                                conPNTcommand.Parameters.AddWithValue("_EndDate", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                conPNTcommand.Parameters.AddWithValue("_IdOperator", oi.RevisionItem.CreatedBy);
                                conPNTcommand.Parameters.AddWithValue("_Paused", false);
                            }
                            else if (stg == 23 && offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.IsCompleted)
                            {
                                conPNTcommand.Parameters.AddWithValue("_EndDate", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                conPNTcommand.Parameters.AddWithValue("_IdOperator", oi.RevisionItem.CreatedBy);
                                conPNTcommand.Parameters.AddWithValue("_Paused", false);
                            }
                            else
                            {
                                conPNTcommand.Parameters.AddWithValue("_EndDate", null);
                                conPNTcommand.Parameters.AddWithValue("_IdOperator", null);
                                conPNTcommand.Parameters.AddWithValue("_Paused", true);
                            }

                            conPNTcommand.ExecuteNonQuery();
                            conrevision.Close();
                        }
                        catch (Exception ex)
                        {
                            throw;
                        }
                    }
                }
            }
        }

        private bool CreateDefaultArticlesNotExistItems_V2040(Quotation q, Offer of, List<OtItem> items, string connectionString)
        {
            bool isInserted = true;

            //Get Revsion and ots details to insert revisonitems in rev1 and rev2 and otitem for not exist default article
            Revision revNumItem0 = new Revision();


            Revision revNumItem1 = new Revision();
            revNumItem1.Items = new Dictionary<string, RevisionItem>();
            List<Revision> revisions = new List<Revision>();
            Ots ot = new Ots();



            using (MySqlConnection conquotation = new MySqlConnection(connectionString))
            {
                conquotation.Open();
                MySqlCommand concommand = new MySqlCommand("CRM_GetRevisionAndOTsDetail", conquotation);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdQuotation", q.IdQuotation);

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Revision revision = new Revision();
                        if (reader["IdQuotation"] != DBNull.Value)
                        {
                            revision.Quotation = new Quotation();
                            revision.Quotation.IdQuotation = Convert.ToInt64(reader["IdQuotation"].ToString());
                        }

                        if (reader["IdRevision"] != DBNull.Value)
                            revision.Id = Convert.ToInt64(reader["IdRevision"]);

                        if (reader["NumRevision"] != DBNull.Value)
                            revision.NumRevision = Convert.ToInt32(reader["NumRevision"]);

                        if (reader["MaxNumItem"] != DBNull.Value)
                            revision.MaxNumItem = Convert.ToInt32(reader["MaxNumItem"]);

                        //if (reader["ReviewedBy"] != DBNull.Value)
                        //    revision.CreatedBy = Convert.ToInt32(reader["ReviewedBy"]);

                        revisions.Add(revision);
                    }
                    if (reader.NextResult())
                    {
                        if (reader.Read())
                        {
                            if (reader["idOT"] != DBNull.Value)
                            {

                                ot.IdOT = Convert.ToInt64(reader["idOT"].ToString());
                            }

                        }
                    }
                }
                conquotation.Close();
            }

            if (revisions.Count > 0)
            {
                revNumItem0 = revisions[0];
                revNumItem0.Items = new Dictionary<string, RevisionItem>();
                if (revisions.Count > 1)
                {
                    revNumItem1 = revisions[1];
                    revNumItem1.Items = new Dictionary<string, RevisionItem>();


                    MySqlConnection conrevision;
                    conrevision = new MySqlConnection(connectionString);

                    conrevision.Open();
                    MySqlCommand conquotationcommand = conrevision.CreateCommand();
                    MySqlTransaction MyTransaction = conrevision.BeginTransaction();

                    conquotationcommand.Connection = conrevision;
                    conquotationcommand.Transaction = MyTransaction;

                    try
                    {

                        Int64 i = revNumItem0.MaxNumItem + 1;
                        foreach (OtItem oi in items)
                        {

                            string description = "";

                            description = oi.RevisionItem.WarehouseProduct.Article.Description;
                            WarehouseProduct ap = new WarehouseProduct();
                            ap.Article = oi.RevisionItem.WarehouseProduct.Article;
                            ap.Description = description;
                            ap.Parent = 0;
                            conquotationcommand = new MySqlCommand("products_Insert", conrevision);
                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                            conquotationcommand.Parameters.AddWithValue("_IdProductType", 2);

                            ap.IdWarehouseProduct = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                            conquotationcommand = new MySqlCommand("warehouseproduct_Insert", conrevision);
                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                            conquotationcommand.Parameters.AddWithValue("_IdWarehouseProduct", ap.IdWarehouseProduct);
                            conquotationcommand.Parameters.AddWithValue("_IdArticle", ap.Article.IdArticle);
                            conquotationcommand.Parameters.AddWithValue("_Description", ap.Description);
                            conquotationcommand.Parameters.AddWithValue("_Parent", ap.Parent);

                            conquotationcommand.ExecuteNonQuery();

                            RevisionItem ri = new RevisionItem();
                            ri.WarehouseProduct = ap;
                            ri.Revision = revNumItem0;
                            ri.NumItem = i.ToString();
                            ri.Quantity = Convert.ToInt64(oi.RevisionItem.WarehouseProduct.Article.Quantity);
                            ri.UnitPrice = 0;
                            ri.CustomerComment = "";

                            if (of.ModifiedBy != null && of.ModifiedBy == 164)
                            {
                                ri.CreatedBy = 164;

                            }
                            else
                            {
                                ri.CreatedBy = of.ModifiedBy;

                            }

                            conquotationcommand = new MySqlCommand("revisionitems_Insert", conrevision);
                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                            conquotationcommand.Parameters.AddWithValue("_IdRevision", ri.Revision.Id);
                            conquotationcommand.Parameters.AddWithValue("_NumItem", ri.NumItem);
                            conquotationcommand.Parameters.AddWithValue("_IdProduct", ri.WarehouseProduct.IdWarehouseProduct);
                            conquotationcommand.Parameters.AddWithValue("_Quantity", ri.Quantity);
                            conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri.UnitPrice);
                            conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                            conquotationcommand.Parameters.AddWithValue("_Validated", false);
                            conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri.CustomerComment);
                            conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri.CreatedBy);
                            conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri.CreatedBy);

                            ri.IdRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                            RevisionItem ri1 = new RevisionItem();
                            ri1.WarehouseProduct = ap;
                            ri1.Revision = revNumItem1;
                            ri1.CreatedBy = revNumItem1.CreatedBy;
                            ri1.ModifiedBy = revNumItem1.CreatedBy;
                            ri1.NumItem = i.ToString();
                            ri1.Quantity = Convert.ToUInt32(oi.RevisionItem.WarehouseProduct.Article.Quantity);
                            ri1.UnitPrice = 0;
                            ri1.CustomerComment = "";

                            if (of.ModifiedBy != null && of.ModifiedBy == 164)
                            {
                                ri1.CreatedBy = 164;

                            }
                            else
                            {
                                ri1.CreatedBy = of.ModifiedBy;

                            }

                            conquotationcommand = new MySqlCommand("revisionitems_Insert", conrevision);
                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                            conquotationcommand.Parameters.AddWithValue("_IdRevision", ri1.Revision.Id);
                            conquotationcommand.Parameters.AddWithValue("_NumItem", ri1.NumItem);
                            conquotationcommand.Parameters.AddWithValue("_IdProduct", ri1.WarehouseProduct.IdWarehouseProduct);
                            conquotationcommand.Parameters.AddWithValue("_Quantity", ri1.Quantity);
                            conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri1.UnitPrice);
                            conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                            conquotationcommand.Parameters.AddWithValue("_Validated", false);
                            conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri1.CustomerComment);
                            conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri1.CreatedBy);
                            conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri1.CreatedBy);

                            ri1.IdRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                            revNumItem0.Items.Add(ri.NumItem, ri);
                            revNumItem1.Items.Add(ri1.NumItem, ri1);

                            i++;
                        }



                        q.Revisions = new List<Revision>();
                        q.Revisions.Add(revNumItem1);
                        ot.Quotation = q;

                        MyTransaction.Commit();
                        conrevision.Close();
                        TransactionScope transactionScope = null;

                        using (transactionScope = new TransactionScope())
                        {
                            try
                            {
                                foreach (KeyValuePair<string, RevisionItem> ri in ot.Quotation.Revisions[0].Items)
                                {
                                    byte idItemOtStatus = 1;
                                    foreach (OtItem it in items)
                                    {
                                        if (it.RevisionItem.WarehouseProduct.Article.IdArticle == ri.Value.WarehouseProduct.Article.IdArticle)
                                        {
                                            idItemOtStatus = Convert.ToByte(it.Status.IdItemOtStatus);
                                            break;
                                        }
                                    }

                                    OtItem oi = InsertItemInOt(of, ri.Value, idItemOtStatus, ot, q, connectionString);
                                    ot.Items = new Dictionary<string, OtItem>();
                                    ot.Items.Add(oi.RevisionItem.NumItem, oi);
                                    InsertPartNumber_V2040(of, oi, connectionString);
                                }

                                transactionScope.Complete();
                                isInserted = true;
                            }
                            catch (Exception ex)
                            {
                                if (Transaction.Current != null)
                                    Transaction.Current.Rollback();

                                if (transactionScope != null)
                                    transactionScope.Dispose();
                                isInserted = false;
                                throw;
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        conrevision.Close();
                    }
                }
            }
            return isInserted;
        }


        private void CreateQuotationWithItems_V2040(Quotation q, Offer of, List<OtItem> items, string connectionString)
        {
            MySqlConnection conrevision;
            conrevision = new MySqlConnection(connectionString);

            conrevision.Open();
            MySqlCommand conquotationcommand = conrevision.CreateCommand();
            MySqlTransaction MyTransaction = conrevision.BeginTransaction();

            conquotationcommand.Connection = conrevision;
            conquotationcommand.Transaction = MyTransaction;

            try
            {

                Revision r = q.Revisions[0];
                r.Items = new Dictionary<string, RevisionItem>();

                //insertem la revisi 1
                Revision r1 = new Revision();
                r1.Quotation = q;
                r1.NumRevision = 1;
                r1.CreatedIn = r.CreatedIn;
                r1.CreatedBy = r.CreatedBy;
                r1.ReviewedBy = r.ReviewedBy;
                r1.CreatedIn = r.CreatedIn;
                r1.ExpireDate = r.ExpireDate;
                r1.Comments = r.Comments;
                r1.Items = new Dictionary<string, RevisionItem>();
                r1.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");


                conquotationcommand = new MySqlCommand("revisions_Insert", conrevision);
                conquotationcommand.CommandType = CommandType.StoredProcedure;
                conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r1.ReviewedBy);
                conquotationcommand.Parameters.AddWithValue("_NumRevision", r1.NumRevision);
                conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                conquotationcommand.Parameters.AddWithValue("_ModifiedBy", r1.CreatedBy);
                conquotationcommand.Parameters.AddWithValue("_MadeBy", r1.CreatedBy);
                conquotationcommand.Parameters.AddWithValue("_IdQuotation", r1.Quotation.IdQuotation);
                conquotationcommand.Parameters.AddWithValue("_IdCurrency", of.IdCurrency);
                conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r1.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                conquotationcommand.Parameters.AddWithValue("_CreationDate", r1.CreatedIn);
                conquotationcommand.Parameters.AddWithValue("_Comments", r1.Comments);
                conquotationcommand.Parameters.AddWithValue("_Closed", r1.ApprovedIn);

                r1.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                int i = 1;
                foreach (OtItem oi in items)
                {
                    bool insert = true;
                    //si la oferta es una IC o una CO
                    if (of.Code.StartsWith("C") || (of.Code.StartsWith("IC")))
                    {
                        //si l'article es el 9warranty i la cotitzaci es la de technical assistance l'afegirem
                        if ((oi.RevisionItem.WarehouseProduct.Article.IdArticle != 10590) && (q.Template.IdTemplate == 15))
                            insert = false;

                    }
                    else
                    {
                        //si l'article es el 9warranty i la cotitzaci es la de technical assistance no l'afegirem
                        if ((oi.RevisionItem.WarehouseProduct.Article.IdArticle == 10590) && (q.Template.IdTemplate == 15))
                            insert = false;
                    }

                    if (insert)
                    {
                        string description = "";

                        description = oi.RevisionItem.WarehouseProduct.Article.Description;
                        WarehouseProduct ap = new WarehouseProduct();
                        ap.Article = oi.RevisionItem.WarehouseProduct.Article;
                        ap.Description = description;
                        ap.Parent = 0;
                        conquotationcommand = new MySqlCommand("products_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdProductType", 2);

                        ap.IdWarehouseProduct = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                        conquotationcommand = new MySqlCommand("warehouseproduct_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdWarehouseProduct", ap.IdWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_IdArticle", ap.Article.IdArticle);
                        conquotationcommand.Parameters.AddWithValue("_Description", ap.Description);
                        conquotationcommand.Parameters.AddWithValue("_Parent", ap.Parent);

                        conquotationcommand.ExecuteNonQuery();

                        RevisionItem ri = new RevisionItem();
                        ri.WarehouseProduct = ap;
                        ri.Revision = r;
                        ri.NumItem = i.ToString();
                        ri.Quantity = Convert.ToInt64(oi.RevisionItem.WarehouseProduct.Article.Quantity);
                        ri.UnitPrice = 0;
                        ri.CustomerComment = "";

                        conquotationcommand = new MySqlCommand("revisionitems_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdRevision", ri.Revision.Id);
                        conquotationcommand.Parameters.AddWithValue("_NumItem", ri.NumItem);
                        conquotationcommand.Parameters.AddWithValue("_IdProduct", ri.WarehouseProduct.IdWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_Quantity", ri.Quantity);
                        conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri.UnitPrice);
                        conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                        conquotationcommand.Parameters.AddWithValue("_Validated", false);
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri.CustomerComment);
                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri.Revision.CreatedBy);
                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri.Revision.CreatedBy);

                        ri.IdRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                        RevisionItem ri1 = new RevisionItem();
                        ri1.WarehouseProduct = ap;
                        ri1.Revision = r1;
                        ri1.CreatedBy = r1.CreatedBy;
                        ri1.ModifiedBy = r1.CreatedBy;
                        ri1.NumItem = i.ToString();
                        ri1.Quantity = Convert.ToUInt32(oi.RevisionItem.WarehouseProduct.Article.Quantity);
                        ri1.UnitPrice = 0;
                        ri1.CustomerComment = "";

                        conquotationcommand = new MySqlCommand("revisionitems_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdRevision", ri1.Revision.Id);
                        conquotationcommand.Parameters.AddWithValue("_NumItem", ri1.NumItem);
                        conquotationcommand.Parameters.AddWithValue("_IdProduct", ri1.WarehouseProduct.IdWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_Quantity", ri1.Quantity);
                        conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri1.UnitPrice);
                        conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                        conquotationcommand.Parameters.AddWithValue("_Validated", false);
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri1.CustomerComment);
                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri1.Revision.CreatedBy);
                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri1.Revision.CreatedBy);

                        ri1.IdRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                        r.Items.Add(ri.NumItem, ri);
                        r1.Items.Add(ri1.NumItem, ri1);

                        i++;
                    }
                }

                q.Revisions.Add(r1);

                //insertem la ot
                Ots o = new Ots();
                o.NumOT = 1;
                o.CreationDate = r.CreatedIn;
                o.DeliveryDate = r.CreatedIn.AddDays(15);
                o.CreatedBy = r.CreatedBy;
                o.ReviewedBy = r.CreatedBy;
                o.Code = GetOTCode(Convert.ToInt32(of.OfferActiveSite.IdSite), q, connectionString);
                o.Year = Convert.ToInt32(q.Year);
                o.Number = Convert.ToInt32(q.Number);
                o.Quotation = q;
                o.Items = new Dictionary<string, OtItem>();

                if (o.IdShippingAddress != 0)
                    o.IdShippingAddress = o.IdShippingAddress;
                else if (of.IdShippingAddress != 0)
                    o.IdShippingAddress = of.IdShippingAddress.Value;
                else
                    o.IdShippingAddress = null;

                //si els tems estan enviats tanquem la OT
                if (items[0].IdItemOtStatus == 10)
                    o.IsClosed = 1;
                else
                    o.IsClosed = 0;

                conquotationcommand = new MySqlCommand("ots_Insert", conrevision);
                conquotationcommand.CommandType = CommandType.StoredProcedure;
                conquotationcommand.Parameters.AddWithValue("_NumOT", o.NumOT);
                conquotationcommand.Parameters.AddWithValue("_CreationDate", o.CreationDate);

                if (of.EngineeringAnalysis != null)
                {
                    conquotationcommand.Parameters.AddWithValue("_DeliveryDate", of.EngineeringAnalysis.DueDate);
                }
                else
                {
                    conquotationcommand.Parameters.AddWithValue("_DeliveryDate", o.DeliveryDate);
                }

                conquotationcommand.Parameters.AddWithValue("_IdSite", of.OfferActiveSite.IdSite);
                conquotationcommand.Parameters.AddWithValue("_CreatedBy", o.CreatedBy);
                conquotationcommand.Parameters.AddWithValue("_ReviewedBy", o.ReviewedBy);
                conquotationcommand.Parameters.AddWithValue("_Code", o.Code);
                conquotationcommand.Parameters.AddWithValue("_Year", o.Year);
                conquotationcommand.Parameters.AddWithValue("_Number", o.Number);
                conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                conquotationcommand.Parameters.AddWithValue("_ModifiedBy", o.CreatedBy);
                conquotationcommand.Parameters.AddWithValue("_IdAddress", o.IdShippingAddress);
                conquotationcommand.Parameters.AddWithValue("_IsClosed", o.IsClosed);
                conquotationcommand.Parameters.AddWithValue("_IdQuotation", o.Quotation.IdQuotation);

                o.IdOT = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                MyTransaction.Commit();
                conrevision.Close();

                TransactionScope transactionScope = null;

                using (transactionScope = new TransactionScope())
                {
                    try
                    {
                        foreach (KeyValuePair<string, RevisionItem> ri in o.Quotation.Revisions[1].Items)
                        {
                            byte idItemOtStatus = 1;
                            foreach (OtItem it in items)
                            {
                                if (it.RevisionItem.WarehouseProduct.Article.IdArticle == ri.Value.WarehouseProduct.Article.IdArticle)
                                {
                                    idItemOtStatus = Convert.ToByte(it.Status.IdItemOtStatus);
                                    break;
                                }
                            }

                            OtItem oi = InsertItemInOt(of, ri.Value, idItemOtStatus, o, q, connectionString);
                            o.Items.Add(oi.RevisionItem.NumItem, oi);
                            InsertPartNumber_V2040(of, oi, connectionString);
                        }

                        transactionScope.Complete();
                    }
                    catch (Exception ex)
                    {
                        if (Transaction.Current != null)
                            Transaction.Current.Rollback();

                        if (transactionScope != null)
                            transactionScope.Dispose();

                        throw;
                    }
                }

                q.Ots = new List<Ots>();
                q.Ots.Add(o);
            }
            catch (Exception ex)
            {
                conrevision.Close();
            }
        }

        private bool CreateDefaultArticlesNotExistItems_V2041(Quotation q, Offer of, List<OtItem> items, string connectionString)
        {
            bool isInserted = true;

            //Get Revsion and ots details to insert revisonitems in rev1 and rev2 and otitem for not exist default article
            Revision revNumItem0 = new Revision();


            Revision revNumItem1 = new Revision();
            revNumItem1.Items = new Dictionary<string, RevisionItem>();
            List<Revision> revisions = new List<Revision>();
            Ots ot = new Ots();



            using (MySqlConnection conquotation = new MySqlConnection(connectionString))
            {
                conquotation.Open();
                MySqlCommand concommand = new MySqlCommand("CRM_GetRevisionAndOTsDetail", conquotation);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdQuotation", q.IdQuotation);

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Revision revision = new Revision();
                        if (reader["IdQuotation"] != DBNull.Value)
                        {
                            revision.Quotation = new Quotation();
                            revision.Quotation.IdQuotation = Convert.ToInt64(reader["IdQuotation"].ToString());
                        }

                        if (reader["IdRevision"] != DBNull.Value)
                            revision.Id = Convert.ToInt64(reader["IdRevision"]);

                        if (reader["NumRevision"] != DBNull.Value)
                            revision.NumRevision = Convert.ToInt32(reader["NumRevision"]);

                        if (reader["MaxNumItem"] != DBNull.Value)
                            revision.MaxNumItem = Convert.ToInt32(reader["MaxNumItem"]);

                        //if (reader["ReviewedBy"] != DBNull.Value)
                        //    revision.CreatedBy = Convert.ToInt32(reader["ReviewedBy"]);

                        revisions.Add(revision);
                    }
                    if (reader.NextResult())
                    {
                        if (reader.Read())
                        {
                            if (reader["idOT"] != DBNull.Value)
                            {

                                ot.IdOT = Convert.ToInt64(reader["idOT"].ToString());
                            }

                        }
                    }
                }
                conquotation.Close();
            }

            if (revisions.Count > 0)
            {
                revNumItem0 = revisions[0];
                revNumItem0.Items = new Dictionary<string, RevisionItem>();
                if (revisions.Count > 1)
                {
                    revNumItem1 = revisions[1];
                    revNumItem1.Items = new Dictionary<string, RevisionItem>();


                    MySqlConnection conrevision;
                    conrevision = new MySqlConnection(connectionString);

                    conrevision.Open();
                    MySqlCommand conquotationcommand = conrevision.CreateCommand();
                    MySqlTransaction MyTransaction = conrevision.BeginTransaction();

                    conquotationcommand.Connection = conrevision;
                    conquotationcommand.Transaction = MyTransaction;

                    try
                    {

                        Int64 i = revNumItem0.MaxNumItem + 1;
                        foreach (OtItem oi in items)
                        {

                            string description = "";

                            description = oi.RevisionItem.WarehouseProduct.Article.Description;
                            WarehouseProduct ap = new WarehouseProduct();
                            ap.Article = oi.RevisionItem.WarehouseProduct.Article;
                            ap.Description = description;
                            ap.Parent = 0;
                            conquotationcommand = new MySqlCommand("products_Insert", conrevision);
                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                            conquotationcommand.Parameters.AddWithValue("_IdProductType", 2);

                            ap.IdWarehouseProduct = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                            conquotationcommand = new MySqlCommand("warehouseproduct_Insert", conrevision);
                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                            conquotationcommand.Parameters.AddWithValue("_IdWarehouseProduct", ap.IdWarehouseProduct);
                            conquotationcommand.Parameters.AddWithValue("_IdArticle", ap.Article.IdArticle);
                            conquotationcommand.Parameters.AddWithValue("_Description", ap.Description);
                            conquotationcommand.Parameters.AddWithValue("_Parent", ap.Parent);

                            conquotationcommand.ExecuteNonQuery();

                            RevisionItem ri = new RevisionItem();
                            ri.WarehouseProduct = ap;
                            ri.Revision = revNumItem0;
                            ri.NumItem = i.ToString();
                            ri.Quantity = Convert.ToInt64(oi.RevisionItem.WarehouseProduct.Article.Quantity);
                            ri.UnitPrice = 0;
                            ri.CustomerComment = "";

                            if (of.ModifiedBy != null && of.ModifiedBy == 164)
                            {
                                ri.CreatedBy = 164;

                            }
                            else
                            {
                                ri.CreatedBy = of.ModifiedBy;

                            }

                            conquotationcommand = new MySqlCommand("revisionitems_Insert", conrevision);
                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                            conquotationcommand.Parameters.AddWithValue("_IdRevision", ri.Revision.Id);
                            conquotationcommand.Parameters.AddWithValue("_NumItem", ri.NumItem);
                            conquotationcommand.Parameters.AddWithValue("_IdProduct", ri.WarehouseProduct.IdWarehouseProduct);
                            conquotationcommand.Parameters.AddWithValue("_Quantity", ri.Quantity);
                            conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri.UnitPrice);
                            conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                            conquotationcommand.Parameters.AddWithValue("_Validated", false);
                            conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri.CustomerComment);
                            conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri.CreatedBy);
                            conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri.CreatedBy);

                            ri.IdRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                            RevisionItem ri1 = new RevisionItem();
                            ri1.WarehouseProduct = ap;
                            ri1.Revision = revNumItem1;
                            ri1.CreatedBy = revNumItem1.CreatedBy;
                            ri1.ModifiedBy = revNumItem1.CreatedBy;
                            ri1.NumItem = i.ToString();
                            ri1.Quantity = Convert.ToUInt32(oi.RevisionItem.WarehouseProduct.Article.Quantity);
                            ri1.UnitPrice = 0;
                            ri1.CustomerComment = "";

                            if (of.ModifiedBy != null && of.ModifiedBy == 164)
                            {
                                ri1.CreatedBy = 164;

                            }
                            else
                            {
                                ri1.CreatedBy = of.ModifiedBy;

                            }

                            conquotationcommand = new MySqlCommand("revisionitems_Insert", conrevision);
                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                            conquotationcommand.Parameters.AddWithValue("_IdRevision", ri1.Revision.Id);
                            conquotationcommand.Parameters.AddWithValue("_NumItem", ri1.NumItem);
                            conquotationcommand.Parameters.AddWithValue("_IdProduct", ri1.WarehouseProduct.IdWarehouseProduct);
                            conquotationcommand.Parameters.AddWithValue("_Quantity", ri1.Quantity);
                            conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri1.UnitPrice);
                            conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                            conquotationcommand.Parameters.AddWithValue("_Validated", false);
                            conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri1.CustomerComment);
                            conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri1.CreatedBy);
                            conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                            conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri1.CreatedBy);

                            ri1.IdRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                            revNumItem0.Items.Add(ri.NumItem, ri);
                            revNumItem1.Items.Add(ri1.NumItem, ri1);

                            i++;
                        }



                        q.Revisions = new List<Revision>();
                        q.Revisions.Add(revNumItem1);
                        ot.Quotation = q;

                        MyTransaction.Commit();
                        conrevision.Close();
                        TransactionScope transactionScope = null;

                        using (transactionScope = new TransactionScope())
                        {
                            try
                            {
                                foreach (KeyValuePair<string, RevisionItem> ri in ot.Quotation.Revisions[0].Items)
                                {
                                    byte idItemOtStatus = 1;
                                    foreach (OtItem it in items)
                                    {
                                        if (it.RevisionItem.WarehouseProduct.Article.IdArticle == ri.Value.WarehouseProduct.Article.IdArticle)
                                        {
                                            idItemOtStatus = Convert.ToByte(it.Status.IdItemOtStatus);
                                            break;
                                        }
                                    }

                                    OtItem oi = InsertItemInOt_V2041(of, ri.Value, idItemOtStatus, ot, q, connectionString);
                                    ot.Items = new Dictionary<string, OtItem>();
                                    ot.Items.Add(oi.RevisionItem.NumItem, oi);
                                    InsertPartNumber_V2040(of, oi, connectionString);
                                }

                                transactionScope.Complete();
                                isInserted = true;
                            }
                            catch (Exception ex)
                            {
                                if (Transaction.Current != null)
                                    Transaction.Current.Rollback();

                                if (transactionScope != null)
                                    transactionScope.Dispose();
                                isInserted = false;
                                throw;
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        conrevision.Close();
                    }
                }
            }
            return isInserted;
        }

        private void CreateQuotationWithItems_V2041(Quotation q, Offer of, List<OtItem> items, string connectionString)
        {
            MySqlConnection conrevision;
            conrevision = new MySqlConnection(connectionString);

            conrevision.Open();
            MySqlCommand conquotationcommand = conrevision.CreateCommand();
            MySqlTransaction MyTransaction = conrevision.BeginTransaction();

            conquotationcommand.Connection = conrevision;
            conquotationcommand.Transaction = MyTransaction;

            try
            {

                Revision r = q.Revisions[0];
                r.Items = new Dictionary<string, RevisionItem>();

                //insertem la revisi 1
                Revision r1 = new Revision();
                r1.Quotation = q;
                r1.NumRevision = 1;
                r1.CreatedIn = r.CreatedIn;
                r1.CreatedBy = r.CreatedBy;
                r1.ReviewedBy = r.ReviewedBy;
                r1.CreatedIn = r.CreatedIn;
                r1.ExpireDate = r.ExpireDate;
                r1.Comments = r.Comments;
                r1.Items = new Dictionary<string, RevisionItem>();
                r1.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");


                conquotationcommand = new MySqlCommand("revisions_Insert", conrevision);
                conquotationcommand.CommandType = CommandType.StoredProcedure;
                conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r1.ReviewedBy);
                conquotationcommand.Parameters.AddWithValue("_NumRevision", r1.NumRevision);
                conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                conquotationcommand.Parameters.AddWithValue("_ModifiedBy", r1.CreatedBy);
                conquotationcommand.Parameters.AddWithValue("_MadeBy", r1.CreatedBy);
                conquotationcommand.Parameters.AddWithValue("_IdQuotation", r1.Quotation.IdQuotation);
                conquotationcommand.Parameters.AddWithValue("_IdCurrency", of.IdCurrency);
                conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r1.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                conquotationcommand.Parameters.AddWithValue("_CreationDate", r1.CreatedIn);
                conquotationcommand.Parameters.AddWithValue("_Comments", r1.Comments);
                conquotationcommand.Parameters.AddWithValue("_Closed", r1.ApprovedIn);

                r1.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                int i = 1;
                foreach (OtItem oi in items)
                {
                    bool insert = true;
                    //si la oferta es una IC o una CO
                    if (of.Code.StartsWith("C") || (of.Code.StartsWith("IC")))
                    {
                        //si l'article es el 9warranty i la cotitzaci es la de technical assistance l'afegirem
                        if ((oi.RevisionItem.WarehouseProduct.Article.IdArticle != 10590) && (q.Template.IdTemplate == 15))
                            insert = false;

                    }
                    else
                    {
                        //si l'article es el 9warranty i la cotitzaci es la de technical assistance no l'afegirem
                        if ((oi.RevisionItem.WarehouseProduct.Article.IdArticle == 10590) && (q.Template.IdTemplate == 15))
                            insert = false;
                    }

                    if (insert)
                    {
                        string description = "";

                        description = oi.RevisionItem.WarehouseProduct.Article.Description;
                        WarehouseProduct ap = new WarehouseProduct();
                        ap.Article = oi.RevisionItem.WarehouseProduct.Article;
                        ap.Description = description;
                        ap.Parent = 0;
                        conquotationcommand = new MySqlCommand("products_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdProductType", 2);

                        ap.IdWarehouseProduct = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                        conquotationcommand = new MySqlCommand("warehouseproduct_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdWarehouseProduct", ap.IdWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_IdArticle", ap.Article.IdArticle);
                        conquotationcommand.Parameters.AddWithValue("_Description", ap.Description);
                        conquotationcommand.Parameters.AddWithValue("_Parent", ap.Parent);

                        conquotationcommand.ExecuteNonQuery();

                        RevisionItem ri = new RevisionItem();
                        ri.WarehouseProduct = ap;
                        ri.Revision = r;
                        ri.NumItem = i.ToString();
                        ri.Quantity = Convert.ToInt64(oi.RevisionItem.WarehouseProduct.Article.Quantity);
                        ri.UnitPrice = 0;
                        ri.CustomerComment = "";

                        conquotationcommand = new MySqlCommand("revisionitems_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdRevision", ri.Revision.Id);
                        conquotationcommand.Parameters.AddWithValue("_NumItem", ri.NumItem);
                        conquotationcommand.Parameters.AddWithValue("_IdProduct", ri.WarehouseProduct.IdWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_Quantity", ri.Quantity);
                        conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri.UnitPrice);
                        conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                        conquotationcommand.Parameters.AddWithValue("_Validated", false);
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri.CustomerComment);
                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri.Revision.CreatedBy);
                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri.Revision.CreatedBy);

                        ri.IdRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                        RevisionItem ri1 = new RevisionItem();
                        ri1.WarehouseProduct = ap;
                        ri1.Revision = r1;
                        ri1.CreatedBy = r1.CreatedBy;
                        ri1.ModifiedBy = r1.CreatedBy;
                        ri1.NumItem = i.ToString();
                        ri1.Quantity = Convert.ToUInt32(oi.RevisionItem.WarehouseProduct.Article.Quantity);
                        ri1.UnitPrice = 0;
                        ri1.CustomerComment = "";

                        conquotationcommand = new MySqlCommand("revisionitems_Insert", conrevision);
                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                        conquotationcommand.Parameters.AddWithValue("_IdRevision", ri1.Revision.Id);
                        conquotationcommand.Parameters.AddWithValue("_NumItem", ri1.NumItem);
                        conquotationcommand.Parameters.AddWithValue("_IdProduct", ri1.WarehouseProduct.IdWarehouseProduct);
                        conquotationcommand.Parameters.AddWithValue("_Quantity", ri1.Quantity);
                        conquotationcommand.Parameters.AddWithValue("_UnitPrice", ri1.UnitPrice);
                        conquotationcommand.Parameters.AddWithValue("_ManualPrice", true);
                        conquotationcommand.Parameters.AddWithValue("_Validated", false);
                        conquotationcommand.Parameters.AddWithValue("_CustomerComment", ri1.CustomerComment);
                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_CreatedBy", ri1.Revision.CreatedBy);
                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", ri1.Revision.CreatedBy);

                        ri1.IdRevisionItem = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                        r.Items.Add(ri.NumItem, ri);
                        r1.Items.Add(ri1.NumItem, ri1);

                        i++;
                    }
                }

                q.Revisions.Add(r1);

                //insertem la ot
                Ots o = new Ots();
                o.NumOT = 1;
                o.CreationDate = r.CreatedIn;
                o.DeliveryDate = r.CreatedIn.AddDays(15);
                o.CreatedBy = r.CreatedBy;
                o.ReviewedBy = r.CreatedBy;
                o.Code = GetOTCode(Convert.ToInt32(of.OfferActiveSite.IdSite), q, connectionString);
                o.Year = Convert.ToInt32(q.Year);
                o.Number = Convert.ToInt32(q.Number);
                o.Quotation = q;
                o.Items = new Dictionary<string, OtItem>();

                if (o.IdShippingAddress != 0)
                    o.IdShippingAddress = o.IdShippingAddress;
                else if (of.IdShippingAddress != 0)
                    o.IdShippingAddress = of.IdShippingAddress.Value;
                else
                    o.IdShippingAddress = null;

                //si els tems estan enviats tanquem la OT
                if (items[0].IdItemOtStatus == 10)
                    o.IsClosed = 1;
                else
                    o.IsClosed = 0;

                conquotationcommand = new MySqlCommand("ots_Insert", conrevision);
                conquotationcommand.CommandType = CommandType.StoredProcedure;
                conquotationcommand.Parameters.AddWithValue("_NumOT", o.NumOT);
                conquotationcommand.Parameters.AddWithValue("_CreationDate", o.CreationDate);

                if (of.EngineeringAnalysis != null)
                {
                    conquotationcommand.Parameters.AddWithValue("_DeliveryDate", of.EngineeringAnalysis.DueDate);
                }
                else
                {
                    conquotationcommand.Parameters.AddWithValue("_DeliveryDate", o.DeliveryDate);
                }

                conquotationcommand.Parameters.AddWithValue("_IdSite", of.OfferActiveSite.IdSite);
                conquotationcommand.Parameters.AddWithValue("_CreatedBy", o.CreatedBy);
                conquotationcommand.Parameters.AddWithValue("_ReviewedBy", o.ReviewedBy);
                conquotationcommand.Parameters.AddWithValue("_Code", o.Code);
                conquotationcommand.Parameters.AddWithValue("_Year", o.Year);
                conquotationcommand.Parameters.AddWithValue("_Number", o.Number);
                conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                conquotationcommand.Parameters.AddWithValue("_ModifiedBy", o.CreatedBy);
                conquotationcommand.Parameters.AddWithValue("_IdAddress", o.IdShippingAddress);
                conquotationcommand.Parameters.AddWithValue("_IsClosed", o.IsClosed);
                conquotationcommand.Parameters.AddWithValue("_IdQuotation", o.Quotation.IdQuotation);

                o.IdOT = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                MyTransaction.Commit();
                conrevision.Close();

                TransactionScope transactionScope = null;

                using (transactionScope = new TransactionScope())
                {
                    try
                    {
                        foreach (KeyValuePair<string, RevisionItem> ri in o.Quotation.Revisions[1].Items)
                        {
                            byte idItemOtStatus = 1;
                            foreach (OtItem it in items)
                            {
                                if (it.RevisionItem.WarehouseProduct.Article.IdArticle == ri.Value.WarehouseProduct.Article.IdArticle)
                                {
                                    idItemOtStatus = Convert.ToByte(it.Status.IdItemOtStatus);
                                    break;
                                }
                            }

                            OtItem oi = InsertItemInOt_V2041(of, ri.Value, idItemOtStatus, o, q, connectionString);
                            o.Items.Add(oi.RevisionItem.NumItem, oi);
                            InsertPartNumber_V2040(of, oi, connectionString);
                        }

                        transactionScope.Complete();
                    }
                    catch (Exception ex)
                    {
                        if (Transaction.Current != null)
                            Transaction.Current.Rollback();

                        if (transactionScope != null)
                            transactionScope.Dispose();

                        throw;
                    }
                }

                q.Ots = new List<Ots>();
                q.Ots.Add(o);
            }
            catch (Exception ex)
            {
                conrevision.Close();
            }
        }

        public ActionPlan GetActionPlan(Int64 IdActionPlan, string connectionString)
        {
            ActionPlan actionPlan = null;

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("CRM_GetActionPlanById", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdActionPlan", IdActionPlan);

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        actionPlan = new ActionPlan();

                        if (reader["IdActionPlan"] != DBNull.Value)
                            actionPlan.IdActionPlan = Convert.ToInt64(reader["IdActionPlan"].ToString());

                        if (reader["Code"] != DBNull.Value)
                            actionPlan.Code = Convert.ToString(reader["Code"]);

                        if (reader["Name"] != DBNull.Value)
                            actionPlan.Name = Convert.ToString(reader["Name"]);

                        if (reader["LastMeetingDate"] != DBNull.Value)
                            actionPlan.LastMeetingDate = Convert.ToDateTime(reader["LastMeetingDate"]);

                        if (reader["NextMeetingDate"] != DBNull.Value)
                            actionPlan.NextMeetingDate = Convert.ToDateTime(reader["NextMeetingDate"]);

                        if (reader["CreationDate"] != DBNull.Value)
                            actionPlan.CreationDate = Convert.ToDateTime(reader["CreationDate"]);

                        if (reader["IdCreator"] != DBNull.Value)
                            actionPlan.IdCreator = Convert.ToInt32(reader["IdCreator"]);

                        if (reader["ModificationDate"] != DBNull.Value)
                            actionPlan.ModificationDate = Convert.ToDateTime(reader["ModificationDate"]);

                        if (reader["IdModifier"] != DBNull.Value)
                            actionPlan.IdModifier = Convert.ToInt32(reader["IdModifier"]);

                        if (reader["IsDeleted"] != DBNull.Value)
                            actionPlan.IsDeleted = Convert.ToByte(reader["IsDeleted"]);
                    }
                }
            }

            return actionPlan;
        }


        public List<ActionPlanItem> GetSalesActivityRegister(string idsSelectedUser, string idsSelectedPlant, Int32 idUser, Int32 idPermission, DateTime closedDate, string connectionString)
        {
            List<ActionPlanItem> actionPlanItems = new List<ActionPlanItem>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("CRM_GetSalesActivityRegister", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdsSelectedUser", idsSelectedUser);
                concommand.Parameters.AddWithValue("_IdsSelectedPlant", idsSelectedPlant);
                concommand.Parameters.AddWithValue("_IdUser", idUser);
                concommand.Parameters.AddWithValue("_IdPermission", idPermission);
                concommand.Parameters.AddWithValue("_ClosedDate", closedDate);

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ActionPlanItem actionPlanItem = new ActionPlanItem();
                        actionPlanItem.ActionPlan = new ActionPlan();
                        if (reader["IdActionPlan"] != DBNull.Value)
                        {

                            actionPlanItem.ActionPlan.IdActionPlan = Convert.ToInt64(reader["IdActionPlan"].ToString());
                            if (reader["Code"] != DBNull.Value)
                                actionPlanItem.ActionPlan.Code = Convert.ToString(reader["Code"].ToString());
                            if (reader["Name"] != DBNull.Value)
                                actionPlanItem.ActionPlan.Name = Convert.ToString(reader["Name"].ToString());

                            if (reader["LastMeetingDate"] != DBNull.Value)
                                actionPlanItem.ActionPlan.LastMeetingDate = Convert.ToDateTime(reader["LastMeetingDate"].ToString());
                            if (reader["NextMeetingDate"] != DBNull.Value)
                                actionPlanItem.ActionPlan.NextMeetingDate = Convert.ToDateTime(reader["NextMeetingDate"].ToString());
                            if (reader["CreationDate"] != DBNull.Value)
                                actionPlanItem.ActionPlan.CreationDate = Convert.ToDateTime(reader["CreationDate"].ToString());
                            if (reader["ModificationDate"] != DBNull.Value)
                                actionPlanItem.ActionPlan.ModificationDate = Convert.ToDateTime(reader["ModificationDate"].ToString());

                            if (reader["IdActionPlanItem"] != DBNull.Value)
                                actionPlanItem.IdActionPlanItem = Convert.ToInt64(reader["IdActionPlanItem"].ToString());
                            if (reader["IdScope"] != DBNull.Value)
                                actionPlanItem.IdScope = Convert.ToInt32(reader["IdScope"].ToString());
                            if (reader["Number"] != DBNull.Value)
                                actionPlanItem.Number = Convert.ToInt64(reader["Number"].ToString());
                            if (reader["IdSite"] != DBNull.Value)
                                actionPlanItem.IdSite = Convert.ToInt32(reader["IdSite"].ToString());
                            if (reader["IdCustomer"] != DBNull.Value)
                                actionPlanItem.IdGroup = Convert.ToInt32(reader["IdCustomer"].ToString());
                            if (reader["Title"] != DBNull.Value)
                                actionPlanItem.Title = Convert.ToString(reader["Title"].ToString());
                            if (reader["OpenDate"] != DBNull.Value)
                                actionPlanItem.OpenDate = Convert.ToDateTime(reader["OpenDate"].ToString());
                            if (reader["ExpectedDueDate"] != DBNull.Value)
                                actionPlanItem.ExpectedDueDate = Convert.ToDateTime(reader["ExpectedDueDate"].ToString());
                            if (reader["CurrentDueDate"] != DBNull.Value)
                                actionPlanItem.CurrentDueDate = Convert.ToDateTime(reader["CurrentDueDate"].ToString());
                            if (reader["DueDateChangeCount"] != DBNull.Value)
                                actionPlanItem.DueDateChangeCount = Convert.ToInt64(reader["DueDateChangeCount"].ToString());
                            if (reader["CloseDate"] != DBNull.Value)
                                actionPlanItem.CloseDate = Convert.ToDateTime(reader["CloseDate"].ToString());
                            if (reader["IdReporter"] != DBNull.Value)
                                actionPlanItem.IdReporter = Convert.ToInt32(reader["IdReporter"].ToString());
                            if (reader["IdAssignee"] != DBNull.Value)
                                actionPlanItem.IdAssignee = Convert.ToInt32(reader["IdAssignee"].ToString());
                            if (reader["IdStatus"] != DBNull.Value)
                                actionPlanItem.IdStatus = Convert.ToInt32(reader["IdStatus"].ToString());

                            if (reader["CreationDate"] != DBNull.Value)
                                actionPlanItem.CreationDate = Convert.ToDateTime(reader["CreationDate"].ToString());

                            if (reader["APIModificationDate"] != DBNull.Value)
                                actionPlanItem.ModificationDate = Convert.ToDateTime(reader["APIModificationDate"].ToString());

                            if (reader["Scope"] != DBNull.Value)
                                actionPlanItem.Scope = Convert.ToString(reader["Scope"].ToString());

                            if (reader["Reporter"] != DBNull.Value)
                                actionPlanItem.Reporter = Convert.ToString(reader["Reporter"].ToString());

                            if (reader["Assignee"] != DBNull.Value)
                                actionPlanItem.Assignee = Convert.ToString(reader["Assignee"].ToString());

                            if (reader["CustomerName"] != DBNull.Value)
                                actionPlanItem.Group = Convert.ToString(reader["CustomerName"].ToString());

                            if (reader["SiteName"] != DBNull.Value)
                                actionPlanItem.Plant = Convert.ToString(reader["SiteName"].ToString());

                            if (reader["Country"] != DBNull.Value)
                                actionPlanItem.Country = Convert.ToString(reader["Country"].ToString());

                            if (reader["IdStatus"] != DBNull.Value)
                            {
                                actionPlanItem.Status = new LookupValue();
                                actionPlanItem.IdStatus = Convert.ToInt32(reader["IdStatus"]);
                                actionPlanItem.Status.IdLookupValue = actionPlanItem.IdStatus;
                                actionPlanItem.Status.Value = Convert.ToString(reader["Status"].ToString());

                                if (reader["HtmlColor"] != DBNull.Value)
                                    actionPlanItem.Status.HtmlColor = Convert.ToString(reader["HtmlColor"]);
                            }
                            actionPlanItem.ActionPlan.Code = string.Format("{0} - {1}", actionPlanItem.ActionPlan.Code, actionPlanItem.Number);
                            actionPlanItems.Add(actionPlanItem);
                        }

                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {


                            if (reader["IdActionPlanItem"] != DBNull.Value)
                                if (actionPlanItems.Any(ap => ap.IdActionPlanItem == Convert.ToInt64(reader["IdActionPlanItem"].ToString())))
                                {
                                    ActionPlanItem actionPlanItem = actionPlanItems.Where(ap => ap.IdActionPlanItem == Convert.ToInt64(reader["IdActionPlanItem"].ToString())).FirstOrDefault();

                                    LogEntriesByActionItem logEntriesByActionItem = new LogEntriesByActionItem();

                                    if (reader["IdLogEntriesByActionItem"] != DBNull.Value)
                                        logEntriesByActionItem.IdLogEntryByActionItem = Convert.ToInt64(reader["IdLogEntriesByActionItem"].ToString());

                                    if (reader["IdActionPlanItem"] != DBNull.Value)
                                        logEntriesByActionItem.IdActionPlanItem = Convert.ToInt64(reader["IdActionPlanItem"].ToString());
                                    if (reader["Comments"] != DBNull.Value)
                                        logEntriesByActionItem.Comment = Convert.ToString(reader["Comments"].ToString());
                                    if (reader["CreationDate"] != DBNull.Value)
                                        logEntriesByActionItem.CreationDate = Convert.ToDateTime(reader["CreationDate"].ToString());
                                    if (reader["IdCreator"] != DBNull.Value)
                                        logEntriesByActionItem.IdCreator = Convert.ToInt32(reader["IdCreator"].ToString());
                                    if (reader["ModificationDate"] != DBNull.Value)
                                        logEntriesByActionItem.ModificationDate = Convert.ToDateTime(reader["ModificationDate"].ToString());
                                    if (reader["IdModifier"] != DBNull.Value)
                                        logEntriesByActionItem.IdModifier = Convert.ToInt32(reader["IdModifier"].ToString());

                                    if (reader["creatorName"] != DBNull.Value)
                                        logEntriesByActionItem.Creator = Convert.ToString(reader["creatorName"].ToString());
                                    if (reader["modifierName"] != DBNull.Value)
                                        logEntriesByActionItem.Modifier = Convert.ToString(reader["modifierName"].ToString());
                                    if (reader["IsRtfText"] != DBNull.Value)
                                        logEntriesByActionItem.IsRtfText = Convert.ToBoolean(reader["IsRtfText"].ToString());
                                    if (reader["IdLogEntryType"] != DBNull.Value)
                                    {
                                        logEntriesByActionItem.IdLogEntryType = Convert.ToInt32(reader["IdLogEntryType"].ToString());
                                    }
                                    if (actionPlanItem.LogEntriesByActionItems != null)
                                        actionPlanItem.LogEntriesByActionItems.Add(logEntriesByActionItem);
                                    else
                                    {
                                        actionPlanItem.LogEntriesByActionItems = new List<LogEntriesByActionItem>();
                                        actionPlanItem.LogEntriesByActionItems.Add(logEntriesByActionItem);
                                    }
                                }

                        }

                    }
                }

            }
            return actionPlanItems;
        }

        public ActionPlanItem GetActionPlanItem(Int64 IdActionPlanItem, string connectionString)
        {
            ActionPlanItem actionPlanItem = null;
            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("CRM_GetActionPlanItem", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdActionPlanItem", IdActionPlanItem);

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        actionPlanItem = new ActionPlanItem();

                        if (reader["IdActionPlan"] != DBNull.Value)
                        {
                            actionPlanItem.ActionPlan = new ActionPlan();

                            actionPlanItem.ActionPlan.IdActionPlan = Convert.ToInt64(reader["IdActionPlan"].ToString());

                            if (reader["Code"] != DBNull.Value)
                                actionPlanItem.ActionPlan.Code = Convert.ToString(reader["Code"].ToString());

                            if (reader["IdActionPlanItem"] != DBNull.Value)
                                actionPlanItem.IdActionPlanItem = Convert.ToInt64(reader["IdActionPlanItem"].ToString());

                            if (reader["IdScope"] != DBNull.Value)
                            {
                                actionPlanItem.IdScope = Convert.ToInt32(reader["IdScope"].ToString());

                                if (reader["Scope"] != DBNull.Value)
                                    actionPlanItem.Scope = Convert.ToString(reader["Scope"].ToString());
                            }

                            if (reader["Number"] != DBNull.Value)
                                actionPlanItem.Number = Convert.ToInt64(reader["Number"].ToString());

                            if (reader["IdSite"] != DBNull.Value)
                            {
                                actionPlanItem.IdSite = Convert.ToInt32(reader["IdSite"].ToString());

                                if (reader["SiteName"] != DBNull.Value)
                                    actionPlanItem.Plant = Convert.ToString(reader["SiteName"].ToString());
                            }

                            if (reader["IdCustomer"] != DBNull.Value)
                            {
                                actionPlanItem.IdGroup = Convert.ToInt32(reader["IdCustomer"].ToString());

                                if (reader["CustomerName"] != DBNull.Value)
                                    actionPlanItem.Group = Convert.ToString(reader["CustomerName"].ToString());
                            }

                            if (reader["Country"] != DBNull.Value)
                                actionPlanItem.Country = Convert.ToString(reader["Country"].ToString());

                            if (reader["Title"] != DBNull.Value)
                                actionPlanItem.Title = Convert.ToString(reader["Title"].ToString());

                            if (reader["OpenDate"] != DBNull.Value)
                                actionPlanItem.OpenDate = Convert.ToDateTime(reader["OpenDate"].ToString());

                            if (reader["ExpectedDueDate"] != DBNull.Value)
                                actionPlanItem.ExpectedDueDate = Convert.ToDateTime(reader["ExpectedDueDate"].ToString());

                            if (reader["CurrentDueDate"] != DBNull.Value)
                                actionPlanItem.CurrentDueDate = Convert.ToDateTime(reader["CurrentDueDate"].ToString());

                            if (reader["DueDateChangeCount"] != DBNull.Value)
                                actionPlanItem.DueDateChangeCount = Convert.ToInt64(reader["DueDateChangeCount"].ToString());

                            if (reader["CloseDate"] != DBNull.Value)
                                actionPlanItem.CloseDate = Convert.ToDateTime(reader["CloseDate"].ToString());

                            if (reader["IdReporter"] != DBNull.Value)
                            {
                                actionPlanItem.IdReporter = Convert.ToInt32(reader["IdReporter"].ToString());

                                if (reader["Reporter"] != DBNull.Value)
                                    actionPlanItem.Reporter = Convert.ToString(reader["Reporter"].ToString());
                            }

                            if (reader["IdAssignee"] != DBNull.Value)
                            {
                                actionPlanItem.IdAssignee = Convert.ToInt32(reader["IdAssignee"].ToString());

                                if (reader["Assignee"] != DBNull.Value)
                                    actionPlanItem.Assignee = Convert.ToString(reader["Assignee"].ToString());
                            }

                            if (reader["APICreationDate"] != DBNull.Value)
                                actionPlanItem.CreationDate = Convert.ToDateTime(reader["APICreationDate"].ToString());

                            if (reader["APIModificationDate"] != DBNull.Value)
                                actionPlanItem.ModificationDate = Convert.ToDateTime(reader["APIModificationDate"].ToString());


                            if (reader["IdStatus"] != DBNull.Value)
                            {
                                actionPlanItem.Status = new LookupValue();
                                actionPlanItem.IdStatus = Convert.ToInt32(reader["IdStatus"]);
                                actionPlanItem.Status.IdLookupValue = actionPlanItem.IdStatus;
                                actionPlanItem.Status.Value = Convert.ToString(reader["Status"].ToString());

                                //if (reader["HtmlColor"] != DBNull.Value)
                                //    actionPlanItem.Status.HtmlColor = Convert.ToString(reader["HtmlColor"]);
                            }

                            actionPlanItem.ActionPlan.Code = string.Format("{0} - {1}", actionPlanItem.ActionPlan.Code, actionPlanItem.Number);
                        }
                    }
                }

            }

            actionPlanItem.LogEntriesByActionItems = GetActionPlanItemLogEntries(IdActionPlanItem, connectionString);


            return actionPlanItem;
        }

        private List<LogEntriesByActionItem> GetActionPlanItemLogEntries(Int64 IdActionPlanItem, string connectionString)
        {
            List<LogEntriesByActionItem> logEntriesByActionItems = new List<LogEntriesByActionItem>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("CRM_GetActionPlanItemLogEntries", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdActionPlanItem", IdActionPlanItem);

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        LogEntriesByActionItem logEntriesByActionItem = new LogEntriesByActionItem();

                        if (reader["IdLogEntriesByActionItem"] != DBNull.Value)
                            logEntriesByActionItem.IdLogEntryByActionItem = Convert.ToInt64(reader["IdLogEntriesByActionItem"].ToString());

                        if (reader["IdActionPlanItem"] != DBNull.Value)
                            logEntriesByActionItem.IdActionPlanItem = Convert.ToInt64(reader["IdActionPlanItem"].ToString());

                        if (reader["Comments"] != DBNull.Value)
                            logEntriesByActionItem.Comment = Convert.ToString(reader["Comments"].ToString());

                        if (reader["CreationDate"] != DBNull.Value)
                            logEntriesByActionItem.CreationDate = Convert.ToDateTime(reader["CreationDate"].ToString());

                        if (reader["IdCreator"] != DBNull.Value)
                        {
                            logEntriesByActionItem.IdCreator = Convert.ToInt32(reader["IdCreator"].ToString());

                            if (reader["creatorName"] != DBNull.Value)
                                logEntriesByActionItem.Creator = Convert.ToString(reader["creatorName"].ToString());
                            logEntriesByActionItem.PeopleCreator = new People();
                            logEntriesByActionItem.PeopleCreator.IdPerson = Convert.ToInt32(reader["IdCreator"].ToString());
                            if (reader["CreatorLoginName"] != DBNull.Value)
                                logEntriesByActionItem.PeopleCreator.Login= Convert.ToString(reader["CreatorLoginName"].ToString());
                        }

                        if (reader["ModificationDate"] != DBNull.Value)
                            logEntriesByActionItem.ModificationDate = Convert.ToDateTime(reader["ModificationDate"].ToString());

                        if (reader["IdModifier"] != DBNull.Value)
                        {
                            logEntriesByActionItem.IdModifier = Convert.ToInt32(reader["IdModifier"].ToString());

                            if (reader["modifierName"] != DBNull.Value)
                                logEntriesByActionItem.Modifier = Convert.ToString(reader["modifierName"].ToString());
                        }

                        if (reader["IsRtfText"] != DBNull.Value)
                            logEntriesByActionItem.IsRtfText = Convert.ToBoolean(reader["IsRtfText"].ToString());

                        if (reader["IdLogEntryType"] != DBNull.Value)
                        {
                            logEntriesByActionItem.IdLogEntryType = Convert.ToInt32(reader["IdLogEntryType"].ToString());
                        }

                        logEntriesByActionItems.Add(logEntriesByActionItem);
                    }
                }
            }

            return logEntriesByActionItems;
        }

        public Int64 GetMaxNumberInScope(Int32 idScope, string connectionString)
        {
            Int64 number = 0;

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("CRM_GetMaxNumberInScope", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdScope", idScope);

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        if (reader["Number"] != DBNull.Value)
                            number = Convert.ToInt64(reader["Number"].ToString());
                    }
                }

            }
            return number;
        }

        public ActionPlanItem AddActionPlanItem(ActionPlanItem actionPlanItem, string mainServerConnectionString)
        {
            bool isInserted = false;
            TransactionScope transactionScope = null;

            using (transactionScope = new System.Transactions.TransactionScope())
            {
                try
                {
                    if (actionPlanItem.TransactionOperation == ModelBase.TransactionOperations.Add)
                    {
                        actionPlanItem.Number = GetMaxNumberInScope(actionPlanItem.IdScope, mainServerConnectionString);
                        using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                        {
                            conn.Open();

                            try
                            {
                                MySqlCommand conCommand = new MySqlCommand("CRM_AddActionPlanItem", conn);
                                conCommand.CommandType = CommandType.StoredProcedure;
                                conCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanItem.IdActionPlan);
                                conCommand.Parameters.AddWithValue("_IdScope", actionPlanItem.IdScope);
                                conCommand.Parameters.AddWithValue("_Number", actionPlanItem.Number);
                                conCommand.Parameters.AddWithValue("_IdSite", actionPlanItem.IdSite);
                                conCommand.Parameters.AddWithValue("_Title", actionPlanItem.Title);
                                // conCommand.Parameters.AddWithValue("_Action", item.Action);
                                conCommand.Parameters.AddWithValue("_OpenDate", actionPlanItem.OpenDate);
                                conCommand.Parameters.AddWithValue("_ExpectedDueDate", actionPlanItem.ExpectedDueDate);
                                conCommand.Parameters.AddWithValue("_CurrentDueDate", actionPlanItem.CurrentDueDate);
                                conCommand.Parameters.AddWithValue("_DueDateChangeCount", actionPlanItem.DueDateChangeCount);
                                conCommand.Parameters.AddWithValue("_CloseDate", actionPlanItem.CloseDate);
                                // conCommand.Parameters.AddWithValue("_IdSource", item.IdSource);
                                conCommand.Parameters.AddWithValue("_IdReporter", actionPlanItem.IdReporter);
                                conCommand.Parameters.AddWithValue("_IdAssignee", actionPlanItem.IdAssignee);
                                conCommand.Parameters.AddWithValue("_IdStatus", actionPlanItem.IdStatus);
                                conCommand.Parameters.AddWithValue("_CreationDate", DateTime.Now);
                                conCommand.Parameters.AddWithValue("_IdCreator", actionPlanItem.IdCreator);

                                actionPlanItem.IdActionPlanItem = Convert.ToInt32(conCommand.ExecuteScalar());

                                if (actionPlanItem.IdActionPlanItem > 0)
                                {
                                    isInserted = true;
                                }

                                conn.Close();
                            }
                            catch (Exception ex)
                            {
                                throw;
                            }
                        }
                    }

                    if (actionPlanItem.IdActionPlanItem > 0)
                    {
                        AddUpdateDeleteLogEntriesByActionItem(actionPlanItem.IdActionPlanItem, actionPlanItem.LogEntriesByActionItems, mainServerConnectionString);
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    isInserted = false;
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }

            }
            return actionPlanItem;
        }

        public bool UpdateActionPlanItem(ActionPlanItem actionPlanItem, string mainServerConnectionString)
        {
            bool isInserted = false;
            TransactionScope transactionScope = null;

            using (transactionScope = new System.Transactions.TransactionScope())
            {

                try
                {
                    if (actionPlanItem.TransactionOperation == ModelBase.TransactionOperations.Update)
                    {
                        using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                        {
                            conn.Open();

                            try
                            {
                                MySqlCommand conCommand = new MySqlCommand("CRM_UpdateActionPlanItem", conn);
                                conCommand.CommandType = CommandType.StoredProcedure;
                                conCommand.Parameters.AddWithValue("_IdActionPlanItem", actionPlanItem.IdActionPlanItem);
                                conCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanItem.IdActionPlan);
                                conCommand.Parameters.AddWithValue("_IdScope", actionPlanItem.IdScope);
                                conCommand.Parameters.AddWithValue("_Number", actionPlanItem.Number);
                                conCommand.Parameters.AddWithValue("_IdSite", actionPlanItem.IdSite);
                                conCommand.Parameters.AddWithValue("_Title", actionPlanItem.Title);
                                //conCommand.Parameters.AddWithValue("_Action", item.Action);
                                conCommand.Parameters.AddWithValue("_OpenDate", actionPlanItem.OpenDate);
                                conCommand.Parameters.AddWithValue("_ExpectedDueDate", actionPlanItem.ExpectedDueDate);
                                conCommand.Parameters.AddWithValue("_CurrentDueDate", actionPlanItem.CurrentDueDate);
                                conCommand.Parameters.AddWithValue("_DueDateChangeCount", actionPlanItem.DueDateChangeCount);
                                conCommand.Parameters.AddWithValue("_CloseDate", actionPlanItem.CloseDate);
                                //conCommand.Parameters.AddWithValue("_IdSource", item.IdSource);
                                conCommand.Parameters.AddWithValue("_IdReporter", actionPlanItem.IdReporter);
                                conCommand.Parameters.AddWithValue("_IdAssignee", actionPlanItem.IdAssignee);
                                conCommand.Parameters.AddWithValue("_IdStatus", actionPlanItem.IdStatus);
                                conCommand.Parameters.AddWithValue("_ModificationDate", DateTime.Now);
                                conCommand.Parameters.AddWithValue("_IdModifier", actionPlanItem.IdModifier);

                                conCommand.ExecuteNonQuery();

                                isInserted = true;

                                conn.Close();
                            }
                            catch (Exception ex)
                            {
                                throw;
                            }
                        }
                    }

                    if (actionPlanItem.IdActionPlanItem > 0)
                    {
                        AddUpdateDeleteLogEntriesByActionItem(actionPlanItem.IdActionPlanItem, actionPlanItem.LogEntriesByActionItems, mainServerConnectionString);
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    isInserted = false;
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }

            }
            return isInserted;
        }

        public bool DeleteActionPlanItem(ActionPlanItem actionPlanItem, string mainServerConnectionString)
        {
            bool isInserted = false;
            TransactionScope transactionScope = null;

            using (transactionScope = new System.Transactions.TransactionScope())
            {
                try
                {
                    if (actionPlanItem.TransactionOperation == ModelBase.TransactionOperations.Delete)
                    {
                        using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                        {
                            conn.Open();

                            try
                            {
                                MySqlCommand conCommand = new MySqlCommand("CRM_DeleteActionPlanItem", conn);
                                conCommand.CommandType = CommandType.StoredProcedure;
                                conCommand.Parameters.AddWithValue("_IdActionPlanItem", actionPlanItem.IdActionPlanItem);
                                conCommand.Parameters.AddWithValue("_IsDeleted", actionPlanItem.IsDeleted);

                                conCommand.ExecuteNonQuery();

                                isInserted = true;

                                conn.Close();
                            }
                            catch (Exception ex)
                            {
                                throw;
                            }
                        }
                    }
                    if (actionPlanItem.IdActionPlanItem > 0)
                    {
                        AddUpdateDeleteLogEntriesByActionItem(actionPlanItem.IdActionPlanItem, actionPlanItem.LogEntriesByActionItems, mainServerConnectionString);
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    isInserted = false;
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }

            }
            return isInserted;
        }

        //public bool AddUpdateDeleteLogEntriesByActionItem(Int64 idActionPlanItem, List<LogEntriesByActionItem> logEntriesByActionItems, string mainServerConnectionString)
        public List<LogEntriesByActionItem> AddUpdateDeleteLogEntriesByActionItem(Int64 idActionPlanItem, List<LogEntriesByActionItem> logEntriesByActionItems, string mainServerConnectionString)
        {
            //bool isactionPerformed = false;
            //if (logEntriesByActionItems == null || logEntriesByActionItems.Count == 0)
            //{
            //    isactionPerformed = true;
            //}

            if (logEntriesByActionItems != null)
            {
                try
                {
                    foreach (LogEntriesByActionItem item in logEntriesByActionItems.OrderBy(i=>i.IsEnabled).ToList())
                    {
                        if (item.TransactionOperation == ModelBase.TransactionOperations.Add)
                        {
                            using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                            {
                                conn.Open();

                                try
                                {
                                    MySqlCommand conCommand = new MySqlCommand("CRM_AddLogEntriesByActionItem", conn);
                                    conCommand.CommandType = CommandType.StoredProcedure;
                                    conCommand.Parameters.AddWithValue("_IdActionPlanItem", idActionPlanItem);
                                    conCommand.Parameters.AddWithValue("_Comments", item.Comment);
                                    conCommand.Parameters.AddWithValue("_CreationDate", item.CreationDate);
                                    conCommand.Parameters.AddWithValue("_IdCreator", item.IdCreator);
                                    conCommand.Parameters.AddWithValue("_IdLogEntryType", item.IdLogEntryType);
                                    conCommand.Parameters.AddWithValue("_IsRtfText", item.IsRtfText);

                                    item.IdLogEntryByActionItem = Convert.ToInt32(conCommand.ExecuteScalar());

                                    //if (item.IdLogEntriesByActionItem > 0)
                                    //{
                                    //    isactionPerformed = true;
                                    //}

                                    conn.Close();
                                }
                                catch (Exception ex)
                                {
                                    throw;
                                }

                            }
                        }
                        else if (item.TransactionOperation == ModelBase.TransactionOperations.Update)
                        {
                            using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                            {
                                conn.Open();

                                try
                                {
                                    MySqlCommand conCommand = new MySqlCommand("CRM_UpdateLogEntriesByActionItem", conn);
                                    conCommand.CommandType = CommandType.StoredProcedure;
                                    conCommand.Parameters.AddWithValue("_IdLogEntriesByActionItem", item.IdLogEntryByActionItem);
                                    conCommand.Parameters.AddWithValue("_IdActionPlanItem", item.IdActionPlanItem);
                                    conCommand.Parameters.AddWithValue("_Comments", item.Comment);
                                    conCommand.Parameters.AddWithValue("_ModificationDate", item.CreationDate);
                                    conCommand.Parameters.AddWithValue("_IdModifier", item.IdCreator);
                                    conCommand.Parameters.AddWithValue("_IdLogEntryType", item.IdLogEntryType);
                                    conCommand.Parameters.AddWithValue("_IsRtfText", item.IsRtfText);

                                    conCommand.ExecuteNonQuery();

                                    //isactionPerformed = true;

                                    conn.Close();
                                }
                                catch (Exception ex)
                                {
                                    throw;
                                }

                            }
                        }
                        else if (item.TransactionOperation == ModelBase.TransactionOperations.Delete)
                        {
                            using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                            {
                                conn.Open();

                                try
                                {
                                    MySqlCommand conCommand = new MySqlCommand("CRM_DeleteLogEntriesByActionItem", conn);
                                    conCommand.CommandType = CommandType.StoredProcedure;
                                    conCommand.Parameters.AddWithValue("_IdLogEntriesByActionItem", item.IdLogEntryByActionItem);

                                    conCommand.ExecuteNonQuery();

                                    //isactionPerformed = true;

                                    conn.Close();
                                }
                                catch (Exception ex)
                                {
                                    throw;
                                }

                            }
                        }
                    }

                }
                catch (Exception ex)
                {
                    throw;
                }
            }


            return logEntriesByActionItems;
        }

        public List<People> GetActionPlanItemResponsible(string connectionstring, Int32 idSite)
        {
            List<People> listPeople = new List<People>();

            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("CRM_GetActionPlanItemResponsible", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdSite", idSite);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        People people = new People();
                        if (reader["IdUser"] != DBNull.Value)
                            people.IdPerson = Convert.ToInt32(reader["IdUser"].ToString());
                        if (reader["FirstName"] != DBNull.Value)
                            people.Name = Convert.ToString(reader["FirstName"].ToString());
                        if (reader["LastName"] != DBNull.Value)
                            people.Surname = Convert.ToString(reader["LastName"].ToString());
                        if (reader["CompanyEmail"] != DBNull.Value)
                            people.Email = Convert.ToString(reader["CompanyEmail"].ToString());
                        if (reader["IdUserGender"] != DBNull.Value)
                            people.IdPersonGender = Convert.ToByte(reader["IdUserGender"].ToString());

                        listPeople.Add(people);
                    }
                }
            }

            return listPeople;
        }


        public bool UpdateParticluarColumnActionPlanItem(ActionPlanItem actionPlanItem, string mainServerConnectionString)
        {
            bool isInserted = false;
            TransactionScope transactionScope = null;
            using (transactionScope = new System.Transactions.TransactionScope())
            {
                try
                {
                    using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                    {
                        conn.Open();

                        try
                        {
                            MySqlCommand conCommand = new MySqlCommand("CRM_UpdateParticluarColumnActionPlanItem", conn);
                            conCommand.CommandType = CommandType.StoredProcedure;
                            conCommand.Parameters.AddWithValue("_IdActionPlanItem", actionPlanItem.IdActionPlanItem);
                            conCommand.Parameters.AddWithValue("_Title", actionPlanItem.Title);
                            conCommand.Parameters.AddWithValue("_ExpectedDueDate", actionPlanItem.ExpectedDueDate);
                            conCommand.Parameters.AddWithValue("_CurrentDueDate", actionPlanItem.CurrentDueDate);
                            conCommand.Parameters.AddWithValue("_DueDateChangeCount", actionPlanItem.DueDateChangeCount);
                            conCommand.Parameters.AddWithValue("_IdAssignee", actionPlanItem.IdAssignee);
                            conCommand.Parameters.AddWithValue("_IdStatus", actionPlanItem.IdStatus);
                            conCommand.Parameters.AddWithValue("_ModificationDate", actionPlanItem.ModificationDate);
                            conCommand.Parameters.AddWithValue("_IdModifier", actionPlanItem.IdModifier);

                            conCommand.ExecuteNonQuery();

                            isInserted = true;

                            conn.Close();

                        }
                        catch (Exception ex)
                        {
                            throw;
                        }
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    isInserted = false;
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return isInserted;
        }


        public IList<LookupValue> GetActionsCountOfStatus(string connectionstring, string idsSelectedUser, string idsSelectedPlant, Int32 idUser, Int32 idPermission, DateTime accountingYearFrom, DateTime accountingYearTo)
        {
            IList<LookupValue> statusCounts = new List<LookupValue>();
            statusCounts = GetLookupValues(48);
            using (MySqlConnection mySqlConnection = new MySqlConnection(connectionstring))
            {
                mySqlConnection.Open();

                MySqlCommand mySqlCommand = new MySqlCommand("CRM_GetActionsCountOfStatus", mySqlConnection);
                mySqlCommand.CommandType = CommandType.StoredProcedure;
                mySqlCommand.Parameters.AddWithValue("_IdsSelectedUser", idsSelectedUser);
                mySqlCommand.Parameters.AddWithValue("_IdsSelectedPlant", idsSelectedPlant);
                mySqlCommand.Parameters.AddWithValue("_IdUser", idUser);
                mySqlCommand.Parameters.AddWithValue("_IdPermission", idPermission);
                mySqlCommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                mySqlCommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);

                using (MySqlDataReader reader = mySqlCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        if (reader["IdStatus"] != DBNull.Value)
                            if (reader["NumberOfActions"] != DBNull.Value)
                            {
                                if (statusCounts.Any(sc => sc.IdLookupValue == Convert.ToInt32(reader["IdStatus"])))
                                {
                                    LookupValue lvAction = statusCounts.Where(sc => sc.IdLookupValue == Convert.ToInt32(reader["IdStatus"])).FirstOrDefault();
                                    lvAction.Count = Convert.ToUInt64(reader["NumberOfActions"].ToString());
                                }
                            }

                    }
                }
            }

            return statusCounts;
        }

        public List<TimelineGrid> GetOfferAndOrderDetailsByOfferCode(string offerCode, TimelineParams timelineParams, string connectionString)
        {
            List<TimelineGrid> timelineGridRows = new List<TimelineGrid>();
            if (string.IsNullOrEmpty(offerCode.Trim()))
                offerCode = "";

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetOfferAndOrderDetailsByOfferCode", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.CommandTimeout = 8000;

                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", timelineParams.idsSelectedUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", timelineParams.accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", timelineParams.accountingYearTo);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_offerCode", offerCode);

                if (timelineParams.Roles == RoleType.SalesAssistant)
                    conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 20);
                else if (timelineParams.Roles == RoleType.SalesPlantManager)
                    conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 21);
                else if (timelineParams.Roles == RoleType.SalesGlobalManager)
                    conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 22);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);


                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid offer = new TimelineGrid();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());
                            offer.Code = itemRow["OfferCode"].ToString();
                            offer.ConnectPlantId = Convert.ToInt32(timelineParams.activeSite.IdSite);
                            offer.ActiveSite = timelineParams.activeSite;
                            offer.Group = itemRow["CustomerGroup"].ToString();
                            offer.Plant = itemRow["SiteName"].ToString().Trim();

                            timelineGridRows.Add(offer);
                        }
                    }

                    if (itemRow.NextResult())
                    {
                        while (itemRow.Read())
                        {
                            if (!timelineGridRows.Any(t => t.IdOffer == Convert.ToInt64(itemRow["IdOffer"].ToString())))
                            {
                                TimelineGrid offer = new TimelineGrid();
                                offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());
                                offer.Code = itemRow["OfferCode"].ToString();
                                offer.ConnectPlantId = Convert.ToInt32(timelineParams.activeSite.IdSite);
                                offer.ActiveSite = timelineParams.activeSite;
                                offer.Group = itemRow["CustomerGroup"].ToString();
                                offer.Plant = itemRow["SiteName"].ToString().Trim();

                                timelineGridRows.Add(offer);
                            }
                        }
                    }


                }
            }

            return timelineGridRows;
        }

        public Offer AddOffer_V2041(Offer offer, string connectionString, string offerCodeConnectionString, Int32 idSite, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {

            Int64 offerId = 0;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            if (offer.OfferedBy == 0)
            {
                offer.OfferedBy = null;
            }

            if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
            {
                if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                    UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                else
                    offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
            }
            else
                UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);

            if (offerInsertedInGCM)
            {
                using (MySqlConnection conoffer = new MySqlConnection(connectionString))
                {
                    conoffer.Open();
                    using (MySqlTransaction trans = conoffer.BeginTransaction())
                    {
                        try
                        {
                            // SP:- offers_Insert this sp is used till Sprint58
                            // MySqlCommand conoffercommand = new MySqlCommand("offers_Insert", conoffer);

                            // To Add RFQ changed SP:-offers_Insert_Sprint59 in Sprint59
                            MySqlCommand conoffercommand = new MySqlCommand("CRM_AddOffer_V2037", conoffer);

                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                            conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                            conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                            conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                            conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                            conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                            conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                            conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                            conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                            conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                            conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                            conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                            conoffercommand.Parameters.AddWithValue("_CreatedBy", offer.CreatedBy);
                            conoffercommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                            conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                            conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                            conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                            conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                            conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                            conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                            conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                            conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                            conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                            conoffercommand.Parameters.AddWithValue("_OfferedBy", offer.OfferedBy);
                            conoffercommand.Transaction = trans;

                            offerId = Convert.ToInt64(conoffercommand.ExecuteScalar());
                            offer.IdOffer = offerId;
                            offer.Year = DateTime.Now.Year;

                            UpdateEngAnalysisStatus(dotProjectConnectionString, offer);

                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }

                    }
                }
            }
            if (offerInsertedInGCM && offer.IdOffer > 0)
            {


                offer = AddQuotations_V2041(offer, connectionString, dotProjectConnectionString, mailServer, workbenchConnectionString, workingOrdersPath);
                AddLogEntryByOffer_V2040(offer, connectionString);
                AddOfferContact(offer.OfferContacts, connectionString, offer.IdOffer);


            }

            return offer;
        }

        public Offer AddQuotations_V2041(Offer offer, string connectionstring, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString, string WorkingOrdersPath)
        {
            try
            {
                foreach (OptionsByOffer optionsByOffer in offer.OptionsByOffers)
                {
                    List<Template> selectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                    Template selectedOptiontemplate = GetDefaultArticleByIdOfferOption(optionsByOffer.IdOption, connectionstring);
                    if (selectedOptiontemplate != null)
                        selectedOptionTemplates.Add(selectedOptiontemplate);

                    using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                    {
                        conquotation.Open();

                        using (MySqlTransaction trans = conquotation.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand conquotationcommand = new MySqlCommand("optionsbyoffer_Insert", conquotation);
                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                conquotationcommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                conquotationcommand.Parameters.AddWithValue("_Quantity", optionsByOffer.Quantity);
                                conquotationcommand.Transaction = trans;
                                conquotationcommand.ExecuteNonQuery();

                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }

                    foreach (Template quotation in selectedOptionTemplates)
                    {
                        Int64 idQuotation = 0;
                        Quotation tempquotation = new Quotation();
                        tempquotation.Offer = new Offer();
                        tempquotation.Offer.IdOffer = offer.IdOffer;
                        tempquotation.Year = DateTime.Now.Year;
                        tempquotation.Number = offer.Number;
                        tempquotation.Code = offer.Code + quotation.Suffix;
                        tempquotation.CreatedIn = DateTime.Now;
                        tempquotation.Template = new Template();
                        tempquotation.Template = quotation;

                        if (quotation.IdTemplate != 0)
                        {
                            string quotationCode = offer.Code + quotation.Suffix;
                            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                            {
                                conquotation.Open();
                                using (MySqlTransaction trans = conquotation.BeginTransaction())
                                {
                                    try
                                    {
                                        MySqlCommand conquotationcommand = new MySqlCommand("quotations_Insert", conquotation);
                                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                                        conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                        conquotationcommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                        conquotationcommand.Parameters.AddWithValue("_Description", offer.Description);
                                        conquotationcommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                        conquotationcommand.Parameters.AddWithValue("_Number", offer.Number);
                                        conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                        conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                        conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                        conquotationcommand.Parameters.AddWithValue("_QuotQuantity", 0);
                                        conquotationcommand.Transaction = trans;
                                        idQuotation = Convert.ToInt64(conquotationcommand.ExecuteScalar());

                                        if (idQuotation > 0)
                                        {
                                            bool isinsert = false;
                                            MySqlCommand conoffercommand = new MySqlCommand("revisions_GetrevisionsByIdQuotation", conquotation);
                                            conoffercommand.CommandType = CommandType.StoredProcedure;
                                            conoffercommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                            using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                                            {
                                                if (!offerreader.Read())
                                                {
                                                    isinsert = true;
                                                }
                                            }

                                            if (isinsert)
                                            {
                                                Revision r = new Revision();
                                                r.NumRevision = 0;
                                                //[001]
                                                if (offer.CreatedBy != null && offer.CreatedBy == 164)
                                                {
                                                    r.CreatedBy = 164;
                                                    r.ReviewedBy = 164;
                                                }
                                                else
                                                {
                                                    r.CreatedBy = offer.CreatedBy;
                                                    r.ReviewedBy = offer.CreatedBy;
                                                }
                                                r.CreatedIn = DateTime.Now;
                                                r.NumRevision = 0;
                                                r.Discount = 0;
                                                r.ExpireDate = DateTime.Now.AddDays(14);
                                                r.Comments = offer.Contact + "\r\n" + offer.Description;
                                                //r.Quotation = quotation;
                                                if (quotation.IdTemplate == 15 || quotation.IdTemplate == 16 || quotation.IdTemplate == 18)
                                                    r.ApprovedIn = DateTime.Now;
                                                else
                                                    r.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");

                                                conquotationcommand = new MySqlCommand("revisions_Insert", conquotation);
                                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                                                conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r.ReviewedBy);
                                                conquotationcommand.Parameters.AddWithValue("_NumRevision", r.NumRevision);
                                                conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.CreatedBy);
                                                conquotationcommand.Parameters.AddWithValue("_MadeBy", r.CreatedBy);
                                                conquotationcommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                                conquotationcommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                                conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                                                conquotationcommand.Parameters.AddWithValue("_CreationDate", r.CreatedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Parameters.AddWithValue("_Comments", r.Comments);
                                                conquotationcommand.Parameters.AddWithValue("_Closed", r.ApprovedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                conquotationcommand.Transaction = trans;
                                                r.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                tempquotation.Revisions = new List<Revision>();
                                                tempquotation.Revisions.Add(r);

                                            }
                                        }

                                        trans.Commit();
                                    }
                                    catch (Exception ex)
                                    {
                                        trans.Rollback();
                                        throw;
                                    }
                                }
                            }
                        }

                        tempquotation.IdQuotation = idQuotation;
                        ///////////////////////////////////////////////////////
                        if (offer.IdOfferType != 10 && quotation.IdTemplate == 15)
                        {
                            List<OtItem> items = new List<OtItem>();

                            List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                            items.AddRange(temp);

                            if (items.Count != 0)
                                CreateQuotationWithItems_V2041(tempquotation, offer, items, connectionstring);
                        }
                        else if (offer.IdOfferType != 10 && quotation.IdTemplate == 23)
                        {
                            List<OtItem> items = new List<OtItem>();
                            List<OtItem> temp = new List<OtItem>();
                            if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                temp = GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis_V2041(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring, offer.EngineeringAnalysis.EngineeringAnalysisTypes);
                            else
                                temp = GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis_V2041(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring, null);


                            items.AddRange(temp);
                            if (items.Count != 0)
                                CreateQuotationWithItems_V2041(tempquotation, offer, items, connectionstring);

                            //link EPC for eng analysis. 
                            if (!ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                InsertEngAnalysisInDotProject_V2040(dotProjectConnectionString, connectionstring, mailServer, workbenchConnectionString, offer, tempquotation);
                            else
                                UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, tempquotation, workbenchConnectionString, mailServer);

                            if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.IsCompleted &&
                                tempquotation != null && tempquotation.Ots != null && tempquotation.Ots.Count > 0
                                && tempquotation.Ots[0].Items != null && tempquotation.Ots[0].Items.Count > 0)
                            {
                                ApplicationManager app = new ApplicationManager();

                                //This property is for AssignedEngAnalysis from dotproject.
                                People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);
                                app.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.CreatedByUser, assignedEngAnalysisPerson, tempquotation.Ots[0].DeliveryDate);

                                LogEntryByOffer log = new LogEntryByOffer();
                                log.IdUser = offer.CreatedBy;
                                log.DateTime = DateTime.Now;
                                log.Comments = "The analysis of engineering department has been completed.";
                                log.IdLogEntryType = 2;
                                offer.LogEntryByOffers.Add(log);
                            }

                        }
                    }


                }




            }
            catch (Exception ex)
            {
                throw;
            }
            return offer;
        }

        public List<OtItem> GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis_V2041(Int64 idOfferOption, byte idTemplate, string connectionstring, List<EngineeringAnalysisType> engineeringAnalysisTypes)
        {
            List<OtItem> items = new List<OtItem>();

            string selectedArticleids = null;
            if (engineeringAnalysisTypes != null)
            {
                selectedArticleids = string.Join(",", engineeringAnalysisTypes.Where(eat => eat.IsSelected == true).ToList().Select(eat => eat.IdArticle).ToList());
            }

            using (MySqlConnection contemplate = new MySqlConnection(connectionstring))
            {
                contemplate.Open();

                //string templatequery = "SELECT * FROM templates WHERE IdTemplate = 18;";
                MySqlCommand contemplatecommand = new MySqlCommand("GetDefaultArticlesByOfferOptionAndTemplate_V2041", contemplate);
                contemplatecommand.CommandType = CommandType.StoredProcedure;
                contemplatecommand.Parameters.AddWithValue("_IdOfferOption", idOfferOption);
                contemplatecommand.Parameters.AddWithValue("_IdTemplate", idTemplate);
                contemplatecommand.Parameters.AddWithValue("_SelectedArticleids", selectedArticleids);

                using (MySqlDataReader reader = contemplatecommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        OtItem oi = new OtItem();
                        oi.RevisionItem = new RevisionItem();
                        oi.RevisionItem.WarehouseProduct = new WarehouseProduct();
                        oi.RevisionItem.WarehouseProduct.Article = new Article();
                        oi.Status = new ItemOTStatusType();

                        oi.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(reader["idArticle"]);
                        if (engineeringAnalysisTypes != null)
                        {
                            if (engineeringAnalysisTypes.Any(eat => eat.IdArticle == oi.RevisionItem.WarehouseProduct.Article.IdArticle && eat.IsSelected == true))
                            {
                                oi.RevisionItem.WarehouseProduct.Article.Quantity = Convert.ToDouble(reader["quantity"]);

                            }
                            else
                            {
                                oi.RevisionItem.WarehouseProduct.Article.Quantity = 0;
                            }
                        }
                        else
                        {
                            oi.RevisionItem.WarehouseProduct.Article.Quantity = 0;

                        }
                        oi.RevisionItem.WarehouseProduct.Article.Description = reader["description"].ToString();
                        oi.RevisionItem.WarehouseProduct.Article.Description_es = reader["description_es"].ToString();
                        oi.RevisionItem.WarehouseProduct.Article.Description_fr = reader["description_Fr"].ToString();
                        oi.Status.IdItemOtStatus = Convert.ToUInt16(reader["idDefaultItemOtStatus"]);
                        items.Add(oi);
                    }
                }
            }

            return items;
        }

        public Offer UpdateOffer_V2041(Offer offer, string connectionstring, string offerCodeConnectionString, Int32 idSite, Int32 idUser, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {

            bool isupdatedLeadToOT = true;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            try
            {
                if (offer.IsUpdateLeadToOT)
                {
                    if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
                    {
                        if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                            UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                        else
                            offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
                    }
                    else
                        UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                }

                if (offerInsertedInGCM)
                {
                    MySqlDataAdapter daGCM;
                    DataTable dtGCM;

                    using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                    {
                        conoffer.Open();
                        string query = "select IdOffer from offers where Code= '" + offer.Code + "' and IdOffer =" + offer.IdOffer + " ;";

                        daGCM = new MySqlDataAdapter(query, conoffer);
                        dtGCM = new DataTable();
                        daGCM.Fill(dtGCM);

                        if (dtGCM.Rows.Count > 0)
                            isupdatedLeadToOT = false;
                    }
                    Int64? nullProductCategory = null;
                    if (offer.IdProductCategory > 0)
                    {
                        nullProductCategory = offer.IdProductCategory;
                    }
                    if (offer.IsUpdateLeadToOT)
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("CRM_offersLeadOTUpdate_V2037", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                    conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Parameters.AddWithValue("_OfferedBy", offer.OfferedBy);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();

                                    offer.IsUpdated = true;
                                    trans.Commit();

                                    offer.Year = DateTime.Now.Year;
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }


                    }
                    else
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("CRM_UpdateOffer_V2037", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Parameters.AddWithValue("_OfferedBy", offer.OfferedBy);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();

                                    offer.IsUpdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                }

                if (offer.IsUpdated)
                {


                    UpdateEngAnalysisStatus(dotProjectConnectionString, offer);

                    offer = UpdateQuotation_V2041(offer, connectionstring, dotProjectConnectionString, mailServer, workbenchConnectionString, workingOrdersPath);



                    LostReasonsByOffer lostReasonsByOffer = UpdateLostReasonsByOffer(offer.LostReasonsByOffer, connectionstring);
                    AddLogEntryByOffer_V2040(offer, connectionstring);
                    AddOfferContact(offer.OfferContacts, connectionstring, offer.IdOffer);

                    if (offer.NewlyLinkedActivities != null && offer.NewlyLinkedActivities.Count > 0)
                    {
                        using (var transactionScope = new TransactionScope())
                        {
                            try
                            {
                                AddLinkExistingActivityToOffer_V2031(mainserverConnectionString, offer.NewlyLinkedActivities, offer.Site, offer.IdOffer);
                                transactionScope.Complete();
                            }
                            catch (Exception ex)
                            {
                                if (Transaction.Current != null)
                                    Transaction.Current.Rollback();

                                if (transactionScope != null)
                                    transactionScope.Dispose();

                                throw;
                            }
                        }
                    }



                }
            }
            catch (Exception ex)
            {
                throw;
                offer.IsUpdated = false;
            }

            return offer;
        }


        private Offer UpdateQuotation_V2041(Offer offer, string connectionstring, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString, string WorkingOrdersPath)
        {
            List<Quotation> quotationByIdOffer = GetOfferQuotationByIdOffer(offer.IdOffer, connectionstring).ToList();
            List<byte> quotIdDetectionsTemplates = quotationByIdOffer.Select(fg => fg.IdDetectionsTemplate).ToList();

            //List<byte> quotIdDetectionsTemplates = GetOfferQuotationByIdOffer(offer.IdOffer, connectionstring).ToList().Select(fg => fg.IdDetectionsTemplate).ToList();

            List<byte> selectedOptionByOfferTemplates = GetTemplatesBySelectedOptionsByOffer(connectionstring, offer.OptionsByOffers.Where(op => op.IsSelected == true).ToList());


            foreach (OptionsByOffer optionsByOffer in offer.OptionsByOffers)
            {
                if (optionsByOffer.IsSelected == true && optionsByOffer.Quantity > 0)
                {
                    List<Template> selectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                    Template selectedOptiontemplate = GetDefaultArticleByIdOfferOption_V2034(optionsByOffer.IdOption, connectionstring);
                    if (selectedOptiontemplate != null)
                        selectedOptionTemplates.Add(selectedOptiontemplate);

                    using (MySqlConnection conoption = new MySqlConnection(connectionstring))
                    {
                        conoption.Open();
                        using (MySqlTransaction trans = conoption.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand conoptioncommand = new MySqlCommand("optionsbyoffer_Update", conoption);
                                conoptioncommand.CommandType = CommandType.StoredProcedure;
                                conoptioncommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                conoptioncommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                conoptioncommand.Parameters.AddWithValue("_Quantity", optionsByOffer.Quantity);
                                conoptioncommand.Transaction = trans;
                                conoptioncommand.ExecuteNonQuery();
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }


                    foreach (Template quotation in selectedOptionTemplates)
                    {
                        if (!quotIdDetectionsTemplates.Contains(quotation.IdTemplate))
                        {
                            bool isUpdate = false;
                            string quotationCode = offer.Code + quotation.Suffix;
                            Int64 idQuotation = 0;

                            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                            {
                                conquotation.Open();
                                MySqlCommand conquotationcommand = new MySqlCommand("quotations_GetquotationsByCode", conquotation);
                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                using (MySqlDataReader reader = conquotationcommand.ExecuteReader())
                                {
                                    if (reader.Read())
                                    {
                                        isUpdate = true;

                                        if (reader["IdQuotation"] != DBNull.Value)
                                        {
                                            idQuotation = Convert.ToInt64(reader["IdQuotation"]);
                                        }
                                    }
                                }
                            }

                            if (isUpdate)
                            {
                                using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                {
                                    conquotation.Open();
                                    using (MySqlTransaction trans = conquotation.BeginTransaction())
                                    {
                                        try
                                        {
                                            // string sqlQuery = "update quotations set IdOffer=" + offer.IdOffer + " where IdDetectionsTemplate = " + quotation.IdTemplate + " AND Code = '" + quotationCode + "';";
                                            MySqlCommand conquotationcommand = new MySqlCommand("quotations_UpdateByCode", conquotation);
                                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                                            conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                            conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                            conquotationcommand.Transaction = trans;
                                            conquotationcommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }

                                //Engineering analysis update code. Comment and date when added from unlinked to linked.
                                if (optionsByOffer.IdOption == 25)
                                {
                                    Quotation quot = new Quotation();
                                    quot.IdQuotation = idQuotation;
                                    quot.Code = quotationCode;
                                    if (quot != null)
                                    {
                                        if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                        {
                                            isUpdateEngAnalysisRevisionQuantity_V2041(quot, offer, offer.EngineeringAnalysis.EngineeringAnalysisTypes, connectionstring);
                                        }

                                        List<OtItem> defaultArticleNotInWarehouseProduct = new List<OtItem>();
                                        if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                        {
                                            defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct_V2041(quot.IdQuotation, connectionstring, offer.EngineeringAnalysis.EngineeringAnalysisTypes);
                                        }
                                        else
                                        {
                                            defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct_V2041(quot.IdQuotation, connectionstring, null);
                                        }
                                        if (defaultArticleNotInWarehouseProduct.Count > 0)
                                        {
                                            //Generate revisionitem in rev0 and rev1 and otitem for that revsion 1
                                            CreateDefaultArticlesNotExistItems_V2041(quot, offer, defaultArticleNotInWarehouseProduct, connectionstring);
                                        }


                                        List<OtItem> otitems = null;

                                        Ots ot = GetOTByQuotationId(quot, connectionstring);
                                        if (ot != null)
                                        {
                                            otitems = GetOtItemsByIdOT_V2041(ot, connectionstring);

                                            using (var transactionScope = new TransactionScope())
                                            {
                                                try
                                                {
                                                    UpdateOTByIdOT(offer, quot, ot, connectionstring);

                                                    foreach (var otItem in otitems)
                                                    {
                                                        UpdateOTitemByIdOtItem_V2041(offer, otItem, connectionstring);


                                                        //Get part number tracking and add update tracking
                                                        PartNumbersTracking partNumbersTracking = GetPartNumbersTrackingByIdOtItem(otItem, 23, connectionstring);

                                                        if (partNumbersTracking != null)
                                                        {
                                                            if (otItem.Status.IdItemOtStatus != 10 && otItem.RevisionItem.Quantity > 0 && offer.EngineeringAnalysis.IsCompleted)
                                                            {
                                                                partNumbersTracking.IdOperator = offer.ModifiedBy;
                                                                partNumbersTracking.EndDate = DateTime.Now;
                                                                partNumbersTracking.Paused = false;
                                                            }
                                                            else if (otItem.Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                            {
                                                                partNumbersTracking.IdOperator = null;
                                                                partNumbersTracking.EndDate = null;
                                                                partNumbersTracking.Paused = true;

                                                            }

                                                            UpdatePartNumbersTrackingByIdPartNumbersTracking(offer, partNumbersTracking, connectionstring);
                                                        }


                                                    }
                                                    transactionScope.Complete();
                                                }
                                                catch (Exception ex)
                                                {
                                                    if (Transaction.Current != null)
                                                        Transaction.Current.Rollback();

                                                    if (transactionScope != null)
                                                        transactionScope.Dispose();

                                                    throw;
                                                }
                                            }

                                            quot.Ots = new List<Ots>();
                                            quot.Ots.Add(ot);
                                            UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, quot, workbenchConnectionString, mailServer);

                                            if (otitems != null && otitems.Count > 0)
                                            {
                                                ApplicationManager applicationManager = new ApplicationManager();

                                                //This property is for AssignedEngAnalysis from dotproject.
                                                People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);

                                                // Send email when eng analysis is validated by 
                                                if ((!otitems.Any(oti => oti.Status.IdItemOtStatus == 10)) && offer.EngineeringAnalysis.IsCompleted)
                                                {
                                                    if (offer.EngineeringAnalysis != null)
                                                        applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                                    else
                                                        applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, ot.DeliveryDate);

                                                    LogEntryByOffer log = new LogEntryByOffer();
                                                    log.IdUser = offer.ModifiedBy;
                                                    log.DateTime = DateTime.Now;
                                                    log.Comments = "The analysis of engineering department has been completed.";
                                                    log.IdLogEntryType = 2;
                                                    offer.LogEntryByOffers.Add(log);
                                                }
                                                else if ((otitems.Any(oti => oti.Status.IdItemOtStatus == 10)) && !offer.EngineeringAnalysis.IsCompleted)
                                                {
                                                    if (offer.EngineeringAnalysis != null)
                                                        applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                                    else
                                                        applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, ot.DeliveryDate);

                                                    LogEntryByOffer log = new LogEntryByOffer();
                                                    log.IdUser = offer.ModifiedBy;
                                                    log.DateTime = DateTime.Now;
                                                    log.Comments = "The analysis of engineering department has been re-opened.";
                                                    log.IdLogEntryType = 2;
                                                    offer.LogEntryByOffers.Add(log);
                                                }
                                            }
                                        }
                                    }


                                }
                            }
                            else
                            {
                                //Int64 idQuotation = 0;
                                Quotation tempquotation = new Quotation();
                                tempquotation.Offer = new Offer();
                                tempquotation.Offer.IdOffer = offer.IdOffer;
                                tempquotation.Year = DateTime.Now.Year;
                                tempquotation.Number = offer.Number;
                                tempquotation.Code = offer.Code + quotation.Suffix;
                                tempquotation.CreatedIn = DateTime.Now;
                                tempquotation.Template = new Template();
                                tempquotation.Template = quotation;
                                if (quotation.IdTemplate != 0)
                                {
                                    // string quotationCode = offer.Code + quotation.Suffix;
                                    using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                    {
                                        conquotation.Open();
                                        using (MySqlTransaction trans = conquotation.BeginTransaction())
                                        {
                                            try
                                            {
                                                MySqlCommand conquotationcommand = new MySqlCommand("quotations_Insert", conquotation);
                                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                                conquotationcommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                                conquotationcommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                                conquotationcommand.Parameters.AddWithValue("_Number", offer.Number);
                                                conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                                conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                                conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                                conquotationcommand.Parameters.AddWithValue("_QuotQuantity", 0);
                                                conquotationcommand.Parameters.AddWithValue("_Description", offer.Description);
                                                conquotationcommand.Transaction = trans;
                                                idQuotation = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                if (idQuotation > 0)
                                                {
                                                    bool isinsert = false;
                                                    MySqlCommand conoffercommand = new MySqlCommand("revisions_GetrevisionsByIdQuotation", conquotation);
                                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                                    conoffercommand.Parameters.AddWithValue("_IdQuotation", idQuotation);

                                                    using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                                                    {
                                                        if (!offerreader.Read())
                                                        {
                                                            isinsert = true;
                                                        }
                                                    }

                                                    if (isinsert)
                                                    {
                                                        Revision r = new Revision();
                                                        r.NumRevision = 0;
                                                        //[001]
                                                        if (offer.ModifiedBy != null && offer.ModifiedBy == 164)
                                                        {
                                                            r.CreatedBy = 164;
                                                            r.ReviewedBy = 164;
                                                        }
                                                        else
                                                        {
                                                            r.CreatedBy = offer.ModifiedBy;
                                                            r.ReviewedBy = offer.ModifiedBy;
                                                        }
                                                        r.CreatedIn = DateTime.Now;
                                                        r.NumRevision = 0;
                                                        r.Discount = 0;
                                                        r.ExpireDate = DateTime.Now.AddDays(14);
                                                        r.Comments = offer.Contact + "\r\n" + offer.Description;
                                                        //r.Quotation = quotation;
                                                        if (quotation.IdTemplate == 15 || quotation.IdTemplate == 16 || quotation.IdTemplate == 18)
                                                            r.ApprovedIn = DateTime.Now;
                                                        else
                                                            r.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");

                                                        conquotationcommand = new MySqlCommand("revisions_Insert", conquotation);
                                                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                        conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                                                        conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r.ReviewedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_NumRevision", r.NumRevision);
                                                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_MadeBy", r.CreatedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                                        conquotationcommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                                        conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                                                        conquotationcommand.Parameters.AddWithValue("_CreationDate", r.CreatedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_Comments", r.Comments);
                                                        conquotationcommand.Parameters.AddWithValue("_Closed", r.ApprovedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Transaction = trans;
                                                        r.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                        tempquotation.Revisions = new List<Revision>();
                                                        tempquotation.Revisions.Add(r);
                                                    }
                                                }
                                                trans.Commit();
                                            }
                                            catch (Exception ex)
                                            {
                                                trans.Rollback();
                                                throw;
                                            }
                                        }
                                    }

                                    tempquotation.IdQuotation = idQuotation;

                                    ///////////////////////////////////////////////////////

                                    if (offer.IdOfferType != 10 && quotation.IdTemplate == 15) // || quotation.IdTemplate == 23))
                                    {
                                        List<OtItem> items = new List<OtItem>();

                                        List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                                        items.AddRange(temp);
                                        if (items.Count != 0)
                                            CreateQuotationWithItems_V2041(tempquotation, offer, items, connectionstring);
                                    }
                                    else if (offer.IdOfferType != 10 && quotation.IdTemplate == 23)
                                    {
                                        List<OtItem> items = new List<OtItem>();
                                        List<OtItem> temp = new List<OtItem>();
                                        if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                            temp = GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis_V2041(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring, offer.EngineeringAnalysis.EngineeringAnalysisTypes);
                                        else
                                            temp = GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis_V2041(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring, null);

                                        items.AddRange(temp);
                                        if (items.Count != 0)
                                            CreateQuotationWithItems_V2041(tempquotation, offer, items, connectionstring);

                                        //link EPC for eng analysis. 
                                        if (!ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                            InsertEngAnalysisInDotProject_V2040(dotProjectConnectionString, connectionstring, mailServer, workbenchConnectionString, offer, tempquotation);
                                        else
                                            UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, tempquotation, workbenchConnectionString, mailServer);
                                        //GOM_v3.Properties.Settings.Default.Email_Delivery_Date_Changed


                                    }
                                }
                            }
                        }
                        else
                        {
                            //Update Quotation Codes when offer type is changed.
                            string quotationCode = offer.Code + quotation.Suffix;

                            Quotation quotationByOffer = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == quotation.IdTemplate);

                            if (quotation != null)
                                UpdateQuotationCodeIfTypeChanged(offer, quotationByOffer, quotation, connectionstring);

                            if (optionsByOffer.IdOption == 25) //Engineering analysis update code.
                            {
                                Quotation quot = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == 23);
                                quot.Code = quotationCode;
                                if (quot != null)
                                {
                                    if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                    {
                                        isUpdateEngAnalysisRevisionQuantity_V2041(quot, offer, offer.EngineeringAnalysis.EngineeringAnalysisTypes, connectionstring);
                                    }

                                    List<OtItem> defaultArticleNotInWarehouseProduct = new List<OtItem>();
                                    if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                    {
                                        defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct_V2041(quot.IdQuotation, connectionstring, offer.EngineeringAnalysis.EngineeringAnalysisTypes);
                                    }
                                    else
                                    {
                                        defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct_V2041(quot.IdQuotation, connectionstring, null);
                                    }
                                    if (defaultArticleNotInWarehouseProduct.Count > 0)
                                    {
                                        //Generate revisionitem in rev0 and rev1 and otitem for that revsion 1
                                        CreateDefaultArticlesNotExistItems_V2041(quot, offer, defaultArticleNotInWarehouseProduct, connectionstring);
                                    }

                                    Ots ot = GetOTByQuotationId(quot, connectionstring);
                                    List<OtItem> otitems = null;

                                    if (ot != null)
                                    {
                                        otitems = GetOtItemsByIdOT_V2041(ot, connectionstring);

                                        using (var transactionScope = new TransactionScope())
                                        {
                                            try
                                            {
                                                UpdateOTByIdOT(offer, quot, ot, connectionstring);

                                                foreach (var otItem in otitems)
                                                {
                                                    UpdateOTitemByIdOtItem_V2041(offer, otItem, connectionstring);

                                                    //Get part number tracking and add update tracking
                                                    PartNumbersTracking partNumbersTracking = GetPartNumbersTrackingByIdOtItem(otItem, 23, connectionstring);

                                                    if (partNumbersTracking != null)
                                                    {
                                                        if (otItem.Status.IdItemOtStatus != 10 && otItem.RevisionItem.Quantity > 0 && offer.EngineeringAnalysis.IsCompleted)
                                                        {
                                                            partNumbersTracking.IdOperator = offer.ModifiedBy;
                                                            partNumbersTracking.EndDate = DateTime.Now;
                                                            partNumbersTracking.Paused = false;
                                                        }
                                                        else if (otItem.Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                        {
                                                            partNumbersTracking.IdOperator = null;
                                                            partNumbersTracking.EndDate = null;
                                                            partNumbersTracking.Paused = true;
                                                        }

                                                        UpdatePartNumbersTrackingByIdPartNumbersTracking(offer, partNumbersTracking, connectionstring);
                                                    }
                                                }

                                                transactionScope.Complete();
                                            }
                                            catch (Exception ex)
                                            {
                                                if (Transaction.Current != null)
                                                    Transaction.Current.Rollback();

                                                if (transactionScope != null)
                                                    transactionScope.Dispose();

                                                throw;
                                            }
                                        }
                                    }

                                    quot.Ots = new List<Ots>();
                                    quot.Ots.Add(ot);
                                    if (ot != null)
                                        UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, quotationByOffer, workbenchConnectionString, mailServer);

                                    if (otitems != null && otitems.Count > 0)
                                    {
                                        ApplicationManager applicationManager = new ApplicationManager();

                                        //This property is for AssignedEngAnalysis from dotproject.
                                        People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);

                                        // Send email when eng analysis is validated by 
                                        if ((!otitems.Any(oti => oti.Status.IdItemOtStatus == 10)) && offer.EngineeringAnalysis.IsCompleted)
                                        {
                                            if (offer.EngineeringAnalysis != null)
                                            {
                                                applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                            }
                                            else
                                            {
                                                applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, ot.DeliveryDate);
                                            }

                                            LogEntryByOffer log = new LogEntryByOffer();
                                            log.IdUser = offer.ModifiedBy;
                                            log.DateTime = DateTime.Now;
                                            log.Comments = "The analysis of engineering department has been completed.";
                                            log.IdLogEntryType = 2;
                                            offer.LogEntryByOffers.Add(log);
                                        }
                                        else if ((otitems.Any(oti => oti.Status.IdItemOtStatus == 10)) && !offer.EngineeringAnalysis.IsCompleted)
                                        {
                                            if (offer.EngineeringAnalysis != null)
                                            {
                                                applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                            }
                                            else
                                            {
                                                applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, ot.DeliveryDate);
                                            }

                                            LogEntryByOffer log = new LogEntryByOffer();
                                            log.IdUser = offer.ModifiedBy;
                                            log.DateTime = DateTime.Now;
                                            log.Comments = "The analysis of engineering department has been re-opened.";
                                            log.IdLogEntryType = 2;
                                            offer.LogEntryByOffers.Add(log);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                else
                {
                    if (optionsByOffer.IsSelected == false && optionsByOffer.Quantity == 0)
                    {
                        if (optionsByOffer.IdOption == 25)
                        {
                            if (offer.IsEngAnalysisSetONToOFF)
                                UnlinkedEngAnalysisTypesFromOfferSetQuantity0(offer, connectionstring);

                        }


                        using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                        {
                            conquotation.Open();
                            using (MySqlTransaction trans = conquotation.BeginTransaction())
                            {
                                try
                                {
                                    //string sqlQuery = "DELETE FROM optionsbyoffer WHERE IdOffer = " + offer.IdOffer + " AND IdOption = " + optionsByOffer.IdOption + ";";
                                    MySqlCommand conquotationcommand = new MySqlCommand("optionsbyoffer_Delete", conquotation);
                                    conquotationcommand.CommandType = CommandType.StoredProcedure;
                                    conquotationcommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                    conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conquotationcommand.Transaction = trans;
                                    conquotationcommand.ExecuteNonQuery();

                                    if (optionsByOffer.IdOption == 25 && ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                        UpdateProjectStatusInDotProject(dotProjectConnectionString, offer, 7);

                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }

                        List<Template> unselectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                        Template unselectedOptionTemplate = GetDefaultArticleByIdOfferOption_V2034(optionsByOffer.IdOption, connectionstring);

                        if (unselectedOptionTemplate != null)
                            unselectedOptionTemplates.Add(unselectedOptionTemplate);

                        foreach (Template quotation in unselectedOptionTemplates)
                        {
                            if (!selectedOptionByOfferTemplates.Contains(quotation.IdTemplate))
                            {
                                using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                {
                                    conquotation.Open();
                                    using (MySqlTransaction trans = conquotation.BeginTransaction())
                                    {
                                        try
                                        {
                                            //string sqlQuery = "update quotations set IdOffer=null where IdDetectionsTemplate = " + quotation.IdTemplate + " AND IdOffer = " + offer.IdOffer + ";";
                                            MySqlCommand conquotationcommand = new MySqlCommand("quotations_UpdateByIdOfferANDTemplate", conquotation);
                                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                                            conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                            conquotationcommand.Transaction = trans;
                                            conquotationcommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }
                            }
                        }



                    }

                }

            }
            return offer;

        }

        private List<OtItem> GetOtItemsByIdOT_V2041(Ots ot, string connectionstring)
        {
            List<OtItem> otitems = new List<OtItem>();

            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
            {
                conquotation.Open();
                MySqlCommand conquotationcommand = new MySqlCommand("CRM_GetOtItemsByIdOT_V2041", conquotation);
                conquotationcommand.CommandType = CommandType.StoredProcedure;
                conquotationcommand.Parameters.AddWithValue("_IdOT", ot.IdOT);

                using (MySqlDataReader reader = conquotationcommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        OtItem otitem = new OtItem();

                        otitem.IdOT = ot.IdOT;

                        if (reader["IsBatch"] != DBNull.Value)
                            otitem.IsBatch = Convert.ToByte(reader["IsBatch"].ToString());

                        if (reader["NumItem"] != DBNull.Value)
                        {
                            otitem.RevisionItem = new RevisionItem();
                            otitem.RevisionItem.NumItem = Convert.ToString(reader["NumItem"]);
                            if (reader["Quantity"] != DBNull.Value)
                            {
                                otitem.RevisionItem.Quantity = Convert.ToDecimal(reader["Quantity"]);
                            }
                        }

                        if (reader["IdOTItem"] != DBNull.Value)
                            otitem.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                        if (reader["IdItemOtStatus"] != DBNull.Value)
                        {
                            otitem.Status = new ItemOTStatusType();
                            otitem.Status.IdItemOtStatus = Convert.ToInt32(reader["IdItemOtStatus"]);
                            
                            otitem.Status.Name = Convert.ToString(reader["Status"]);
                        }

                        if (reader["Rework"] != DBNull.Value)
                            otitem.Rework = Convert.ToByte(reader["Rework"]);

                        if (reader["CustomerComment"] != DBNull.Value)
                            otitem.CustomerComment = Convert.ToString(reader["CustomerComment"]);

                        if (reader["AttachedFiles"] != DBNull.Value)
                            otitem.AttachedFiles = Convert.ToString(reader["AttachedFiles"]);

                        if (reader["AssignedTo"] != DBNull.Value)
                        {
                            otitem.AssignedTo = Convert.ToInt32(reader["AssignedTo"]);
                            otitem.AssignedToUser = new People();
                            otitem.AssignedToUser.IdPerson = Convert.ToInt32(reader["AssignedTo"]);
                            otitem.AssignedToUser.Name = Convert.ToString(reader["Name"]);
                            otitem.AssignedToUser.Surname = Convert.ToString(reader["Surname"]);
                            otitem.AssignedToUser.Email = Convert.ToString(reader["Email"]);
                        }

                        otitems.Add(otitem);
                    }
                }
            }

            return otitems;
        }

        private void UpdateRevisionItemQuatity_V2041(Offer offer, EngineeringAnalysisType engineeringAnalysisType, string connectionString, Int64 idQuotation, Int32 idModifiedBy)
        {


            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                using (MySqlTransaction trans = con.BeginTransaction())
                {
                    try
                    {
                        MySqlCommand concommand = new MySqlCommand("CRM_UpdateRevisionItemQuantity_V2041", con);
                        concommand.CommandType = CommandType.StoredProcedure;

                        concommand.Parameters.AddWithValue("_IdArticle", engineeringAnalysisType.IdArticle);
                        concommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                        concommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        concommand.Parameters.AddWithValue("_ModifiedBy", idModifiedBy);
                        concommand.Parameters.AddWithValue("_IsDefaultArticleQuantityUpdate", engineeringAnalysisType.IsSelected);
                        // concommand.Parameters.AddWithValue("_IdItemOTStatus", idItemStatus);
                        concommand.ExecuteNonQuery();

                        trans.Commit();
                    }
                    catch (Exception ex)
                    {
                        trans.Rollback();
                        throw;
                    }
                }
                List<OtItem> otitemsAdd = GetPartnumberAndTrackingDependOnQuantity(connectionString, idQuotation);
                foreach (OtItem item in otitemsAdd)
                {
                    InsertPartNumber_V2040(offer, item, connectionString);
                }
                // List<OtItem> otitemsDelete = GetPartnumberAndTrackingDependOnQuantityZero(connectionString, idQuotation);
                //foreach (OtItem item in otitemsDelete)
                // {
                //      DeletePartNumberAndTracking(item.IdOTItem, connectionString);
                //  }

            }
        }

        private void UpdateRevisionItemQuatity_V2042(Offer offer, EngineeringAnalysisType engineeringAnalysisType, string connectionString, Int64 idQuotation, Int32 idModifiedBy)
        {


            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                using (MySqlTransaction trans = con.BeginTransaction())
                {
                    try
                    {
                        MySqlCommand concommand = new MySqlCommand("CRM_UpdateRevisionItemQuantity_V2042", con);
                        concommand.CommandType = CommandType.StoredProcedure;

                        concommand.Parameters.AddWithValue("_IdArticle", engineeringAnalysisType.IdArticle);
                        concommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                        concommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        concommand.Parameters.AddWithValue("_ModifiedBy", idModifiedBy);
                        concommand.Parameters.AddWithValue("_IsDefaultArticleQuantityUpdate", engineeringAnalysisType.IsSelected);
                        // concommand.Parameters.AddWithValue("_IdItemOTStatus", idItemStatus);
                        concommand.ExecuteNonQuery();

                        trans.Commit();
                    }
                    catch (Exception ex)
                    {
                        trans.Rollback();
                        throw;
                    }
                }

                if (engineeringAnalysisType.IsSelected = true)
                {
                    List<OtItem> otitemsAdd = GetPartnumberAndTrackingDependOnQuantity(connectionString, idQuotation);
                    foreach (OtItem item in otitemsAdd)
                    {
                        InsertPartNumber_V2040(offer, item, connectionString);
                    }
                }
                // List<OtItem> otitemsDelete = GetPartnumberAndTrackingDependOnQuantityZero(connectionString, idQuotation);
                //foreach (OtItem item in otitemsDelete)
                // {
                //      DeletePartNumberAndTracking(item.IdOTItem, connectionString);
                //  }

            }
        }

        private void isUpdateEngAnalysisRevisionQuantity_V2041(Quotation q, Offer of, List<EngineeringAnalysisType> engineeringAnalysisTypes, string connectionString)
        {
            if (engineeringAnalysisTypes != null)
            {
                foreach (EngineeringAnalysisType itemEngineeringAnalysisType in engineeringAnalysisTypes)
                {
                    UpdateRevisionItemQuatity_V2041(of, itemEngineeringAnalysisType, connectionString, q.IdQuotation, of.ModifiedBy);
                }
            }
        }
        private void isUpdateEngAnalysisRevisionQuantity_V2042(Quotation q, Offer of, List<EngineeringAnalysisType> engineeringAnalysisTypes, string connectionString)
        {
            if (engineeringAnalysisTypes != null)
            {
                foreach (EngineeringAnalysisType itemEngineeringAnalysisType in engineeringAnalysisTypes)
                {
                    UpdateRevisionItemQuatity_V2042(of, itemEngineeringAnalysisType, connectionString, q.IdQuotation, of.ModifiedBy);
                }
            }
        }

        public List<OtItem> GetDefaultArticleNotInWarehouseProduct_V2041(Int64 idQuotation, string connectionstring, List<EngineeringAnalysisType> engineeringAnalysisTypes)
        {
            List<OtItem> items = new List<OtItem>();
            string selectedArticleids = null;
            if (engineeringAnalysisTypes != null)
            {
                selectedArticleids = string.Join(",", engineeringAnalysisTypes.Where(eat => eat.IsSelected == true));
            }

            using (MySqlConnection contemplate = new MySqlConnection(connectionstring))
            {
                contemplate.Open();

                //string templatequery = "SELECT * FROM templates WHERE IdTemplate = 18;";
                MySqlCommand contemplatecommand = new MySqlCommand("CRM_GetDefaultArticleNotInWarehouseProduct_V2041", contemplate);
                contemplatecommand.CommandType = CommandType.StoredProcedure;
                contemplatecommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                contemplatecommand.Parameters.AddWithValue("_SelectedArticleids", selectedArticleids);

                using (MySqlDataReader reader = contemplatecommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        OtItem oi = new OtItem();
                        oi.RevisionItem = new RevisionItem();
                        oi.RevisionItem.WarehouseProduct = new WarehouseProduct();
                        oi.RevisionItem.WarehouseProduct.Article = new Article();
                        oi.Status = new ItemOTStatusType();

                        oi.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(reader["idArticle"]);
                        if (engineeringAnalysisTypes != null)
                        {
                            if (engineeringAnalysisTypes.Any(eat => eat.IdArticle == oi.RevisionItem.WarehouseProduct.Article.IdArticle && eat.IsSelected == true))
                            {
                                oi.RevisionItem.WarehouseProduct.Article.Quantity = Convert.ToDouble(reader["quantity"]);

                            }
                            else
                            {
                                oi.RevisionItem.WarehouseProduct.Article.Quantity = 0;
                            }
                        }
                        else
                        {
                            oi.RevisionItem.WarehouseProduct.Article.Quantity = 0;

                        }
                        oi.RevisionItem.WarehouseProduct.Article.Description = reader["description"].ToString();
                        oi.RevisionItem.WarehouseProduct.Article.Description_es = reader["description_es"].ToString();
                        oi.RevisionItem.WarehouseProduct.Article.Description_fr = reader["description_Fr"].ToString();
                        oi.Status.IdItemOtStatus = Convert.ToUInt16(reader["idDefaultItemOtStatus"]);
                        items.Add(oi);
                    }
                }
            }

            return items;
        }


        public List<EngineeringAnalysisType> GetEngAnalysisArticles_V2041(string connectionString)
        {
            List<EngineeringAnalysisType> engineeringAnalysisTypes = new List<EngineeringAnalysisType>();

            using (MySqlConnection connOffers = new MySqlConnection(connectionString))
            {
                connOffers.Open();
                MySqlCommand offersCommand = new MySqlCommand("CRM_GetEngAnalysisArticles_V2041", connOffers);
                offersCommand.CommandType = CommandType.StoredProcedure;

                using (MySqlDataReader reader = offersCommand.ExecuteReader())
                {
                    if (reader.HasRows)
                    {
                        while (reader.Read())
                        {
                            EngineeringAnalysisType engineeringAnalysisType = new EngineeringAnalysisType();
                            if (reader["IdArticle"] != DBNull.Value)
                                engineeringAnalysisType.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                            if (reader["Reference"] != DBNull.Value)
                                engineeringAnalysisType.Reference = reader["Reference"].ToString();

                            if (reader["Quantity"] != DBNull.Value)
                                engineeringAnalysisType.Quantity = reader["Quantity"].ToString();

                            engineeringAnalysisType.IsArticleEnabled = true;

                            engineeringAnalysisTypes.Add(engineeringAnalysisType);
                        }
                    }
                }
            }

            return engineeringAnalysisTypes;
        }

        private List<OtItem> GetPartnumberAndTrackingDependOnQuantity(string connectionString, Int64 idQuotation)
        {
            List<OtItem> otitems = new List<OtItem>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();

                    MySqlCommand concommand = new MySqlCommand("CRM_GetOTItemsWithRevQuantityNotExistPartNumber", con);
                    concommand.CommandType = CommandType.StoredProcedure;
                    concommand.Parameters.AddWithValue("_IdQuotation", idQuotation);

                    using (MySqlDataReader reader = concommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            OtItem oi = new OtItem();
                            if (reader["IdOTItem"] != DBNull.Value)
                                oi.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);
                            oi.RevisionItem = new RevisionItem();
                            if (reader["Quantity"] != DBNull.Value)
                                oi.RevisionItem.Quantity = Convert.ToInt64(reader["Quantity"]);
                            if (reader["CreatedBy"] != DBNull.Value)
                                oi.RevisionItem.CreatedBy = Convert.ToInt32(reader["CreatedBy"]);
                            if (reader["ModifiedBy"] != DBNull.Value)
                                oi.RevisionItem.ModifiedBy = Convert.ToInt32(reader["ModifiedBy"]);
                            if (reader["NumItem"] != DBNull.Value)
                                oi.RevisionItem.NumItem = Convert.ToString(reader["NumItem"]);
                            oi.Quotation = new Quotation();
                            if (reader["IdQuotation"] != DBNull.Value)
                                oi.Quotation.IdQuotation = Convert.ToInt64(reader["IdQuotation"]);

                            if (reader["Code"] != DBNull.Value)
                                oi.Quotation.Code = Convert.ToString(reader["Code"]);

                            oi.RevisionItem.WarehouseProduct = new WarehouseProduct();
                            oi.RevisionItem.WarehouseProduct.Article = new Article();

                            if (reader["IdArticle"] != DBNull.Value)
                                oi.RevisionItem.WarehouseProduct.Article.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                            otitems.Add(oi);
                        }
                    }
                }
            }
            catch (Exception ex)
            {

                throw;
            }
            return otitems;
        }


        private List<OtItem> GetPartnumberAndTrackingDependOnQuantityZero(string connectionString, Int64 idQuotation)
        {
            List<OtItem> otitems = new List<OtItem>();
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionString))
                {
                    con.Open();

                    MySqlCommand concommand = new MySqlCommand("CRM_GetOTItemsWithZeroRevQuantityExistPartNumber", con);
                    concommand.CommandType = CommandType.StoredProcedure;
                    concommand.Parameters.AddWithValue("_IdQuotation", idQuotation);

                    using (MySqlDataReader reader = concommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            OtItem oi = new OtItem();
                            if (reader["IdOTItem"] != DBNull.Value)
                                oi.IdOTItem = Convert.ToInt64(reader["IdOTItem"]);

                            otitems.Add(oi);
                        }
                    }
                }
            }
            catch (Exception ex)
            {

                throw;
            }
            return otitems;
        }


        private void DeletePartNumberAndTracking(Int64 idotitem, string connectionString)
        {
            using (MySqlConnection conrevision = new MySqlConnection(connectionString))
            {
                conrevision.Open();

                try
                {
                    MySqlCommand conquotationcommand = new MySqlCommand("CRM_DeletePartNumberAndTracking", conrevision);
                    conquotationcommand.CommandType = CommandType.StoredProcedure;
                    conquotationcommand.Parameters.AddWithValue("_idOtitem", idotitem);

                    conquotationcommand.ExecuteNonQuery();
                }
                catch (Exception ex)
                {
                    throw;
                }
            }

        }


        public bool SaveCopyOfEMail(Offer offer, FileDetail emailFileDetail,string CommercialRfqPath)
        {
            bool isSaved = false;
            if (emailFileDetail.FileByte != null)
            {
                try
                {
                    CommercialRfqPath = CommercialRfqPath.Replace("{0}", offer.Year.ToString());
                    CommercialRfqPath = CommercialRfqPath.Replace("{1}", offer.Site.Name.ToString());
                    CommercialRfqPath = CommercialRfqPath.Replace("{2}", offer.Code.ToString());
                    string CommercialQuotationPath = CommercialRfqPath.Replace(@"\RFQ", "");
                    if (Directory.Exists(CommercialQuotationPath))
                    {
                        if (!Directory.Exists(Path.Combine(CommercialQuotationPath, "RFQ")))
                        {
                            Directory.CreateDirectory(Path.Combine(CommercialQuotationPath, "RFQ"));
                        }
                        File.WriteAllBytes(Path.Combine(CommercialQuotationPath, @"RFQ\", emailFileDetail.FileName), emailFileDetail.FileByte);
                        isSaved = true;
                    }
                    else
                    {
                        isSaved = false;
                        Directory.GetDirectories(CommercialQuotationPath);
                    }

                
                }
                catch (DirectoryNotFoundException directoryNotFoundException)
                {
                    isSaved = false;
                    throw;
                }
                catch (Exception ex)
                {
                    isSaved = false;
                    throw;
                }
            }
            return isSaved;
        }


        public List<ActivityGrid> GetActivitiesDetail(string connectionString, ActivityParams objActivityParams)
        {

            List<ActivityGrid> listActivity = new List<ActivityGrid>();

            using (MySqlConnection connActivities = new MySqlConnection(connectionString))
            {
                connActivities.Open();

                MySqlCommand activitiesCommand = new MySqlCommand("CRM_GetActivities", connActivities);
                activitiesCommand.CommandType = CommandType.StoredProcedure;
                activitiesCommand.Parameters.AddWithValue("_IdAciveUser", objActivityParams.idActiveUser);
                activitiesCommand.Parameters.AddWithValue("_IdOwner", objActivityParams.idOwner);
                activitiesCommand.Parameters.AddWithValue("_IdPermission", objActivityParams.idPermission);
                activitiesCommand.Parameters.AddWithValue("_IdPlant", objActivityParams.idPlant);
                activitiesCommand.Parameters.AddWithValue("_accountingYearFrom", objActivityParams.accountingYearFrom);
                activitiesCommand.Parameters.AddWithValue("_accountingYearTo", objActivityParams.accountingYearTo);
                activitiesCommand.CommandTimeout = 2000;
                using (MySqlDataReader activityReader = activitiesCommand.ExecuteReader())
                {
                    while (activityReader.Read())
                    {
                        ActivityGrid activity = new ActivityGrid();
                        try
                        {
                            activity.IdActivity = Convert.ToInt64(activityReader["IdActivity"].ToString());
                            
                            activity.Subject = activityReader["Subject"].ToString();
                            activity.Description = activityReader["Description"].ToString();
                           
                            if (activityReader["CloseDate"] != DBNull.Value)
                                activity.CloseDate = Convert.ToDateTime(activityReader["CloseDate"].ToString());

                            if (activityReader["ActivityType"] != DBNull.Value)
                            {
                               activity.ActivityType = activityReader["ActivityType"].ToString();
                            }
                            if (activityReader["FromDate"] != DBNull.Value)
                                activity.FromDate = Convert.ToDateTime(activityReader["FromDate"].ToString());

                            if (activityReader["ToDate"] != DBNull.Value)
                                activity.ToDate = Convert.ToDateTime(activityReader["ToDate"].ToString());
                                                   

                            listActivity.Add(activity);
                        }
                        catch (Exception ex)
                        {
                            throw ex;
                        }
                    }


                    if (activityReader.NextResult())
                    {
                        while (activityReader.Read())
                        {
                            if (activityReader["IdActivity"] != DBNull.Value)
                            {
                                ActivityGrid activity = listActivity.Where(i => i.IdActivity == Convert.ToInt64(activityReader["IdActivity"].ToString())).FirstOrDefault();
                                activity.CustomerName = activityReader["Group"].ToString();
                                if (activityReader["IdSite"] != DBNull.Value)
                                {
                                    activity.IdSite = Convert.ToInt32(activityReader["IdSite"].ToString());
                                    activity.CompanyName = activityReader["Plant"].ToString();
                                    activity.SiteNameWithoutCountry = activityReader["PlantNameWithcountry"].ToString();
                                }

                            }
                        }
                    }
                

                }
            }

            return listActivity;
        }

        public List<TimelineGrid> GetOpportunities(TimelineParams timelineParams, string connectionString)
        {
            List<TimelineGrid> timelineGridRows = new List<TimelineGrid>();
          
            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetOpportunities", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.CommandTimeout = 8000;

                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idUser", timelineParams.idsSelectedUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idCurrentUser", timelineParams.idUser);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", timelineParams.accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", timelineParams.accountingYearTo);
               

                if (timelineParams.Roles == RoleType.SalesAssistant)
                    conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 20);
                else if (timelineParams.Roles == RoleType.SalesPlantManager)
                    conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 21);
                else if (timelineParams.Roles == RoleType.SalesGlobalManager)
                    conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idPermission", 22);

                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);


                using (MySqlDataReader itemRow = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        while (itemRow.Read())
                        {
                            TimelineGrid offer = new TimelineGrid();

                            offer.IdOffer = Convert.ToInt64(itemRow["idoffer"].ToString());
                            offer.Code = itemRow["OfferCode"].ToString();
                            if (itemRow["OfferYear"] != DBNull.Value)
                                offer.Year = Convert.ToInt64(itemRow["OfferYear"].ToString());
                            offer.ConnectPlantId = Convert.ToInt32(timelineParams.activeSite.IdSite);
                            offer.ActiveSite = timelineParams.activeSite;
                            offer.Group = itemRow["CustomerGroup"].ToString();
                            offer.Plant = itemRow["SiteName"].ToString().Trim();

                            timelineGridRows.Add(offer);
                        }
                    }
                }
            }

            return timelineGridRows;
        }

        public PeopleDetails GetGroupPlantByMailId(string connectionString,string mailId)
        {
            PeopleDetails peopleDetails = null;

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("CRM_GetGroupPlant", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_mailId", mailId);
              

                MySqlDataAdapter da = new MySqlDataAdapter(concommand);


                using (MySqlDataReader itemRow = concommand.ExecuteReader())
                {
                    if (itemRow.HasRows)
                    {
                        if (itemRow.Read())
                        {
                            peopleDetails = new PeopleDetails();
                            if (itemRow["IdPerson"] != DBNull.Value)
                                peopleDetails.IdPerson = Convert.ToInt32(itemRow["IdPerson"].ToString());
                            peopleDetails.Name = Convert.ToString(itemRow["Name"].ToString());
                            peopleDetails.Surname = Convert.ToString(itemRow["Surname"].ToString());
                            peopleDetails.Email = Convert.ToString(itemRow["Email"].ToString());
                            if (itemRow["IdSite"] != DBNull.Value)
                                peopleDetails.IdSite = Convert.ToInt32(itemRow["IdSite"].ToString());
                            if (itemRow["IdCustomer"] != DBNull.Value)
                                peopleDetails.IdCustomer = Convert.ToInt32(itemRow["IdCustomer"].ToString());

                          
                        }
                    }
                }
            }

            return peopleDetails;
        }


        public Offer GetOfferDetailsById_V2042(Int64 idOffer, Int32 idUser, byte idCurrency, DateTime accountingYearFrom, DateTime accountingYearTo, ActiveSite activeSite, string workingOrdersPath, string connectionString)
        {
            Offer offer = new Offer();

            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetOfferDetailsByIdDateWise_V2037", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_offerId", idOffer);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearFrom", accountingYearFrom);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingYearTo", accountingYearTo);

                using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                {
                    if (offerreader.Read())
                    {
                        offer.IdOffer = Convert.ToInt64(offerreader["idoffer"].ToString());

                        if (offerreader["IdSalesOwner"] != DBNull.Value)
                        {
                            offer.IdSalesOwner = Convert.ToInt32(offerreader["IdSalesOwner"].ToString());
                            offer.SalesOwner = new People { IdPerson = Convert.ToInt32(offerreader["IdSalesOwner"].ToString()), Name = offerreader["OfferSalesOwnerName"].ToString(), Surname = offerreader["OfferSalesOwnerSurName"].ToString(), Email = Convert.ToString(offerreader["OfferSalesOwnerEmail"]) };
                        }

                        offer.IdOfferType = Convert.ToByte(offerreader["idOfferType"].ToString());
                        offer.Code = offerreader["OfferCode"].ToString();
                        offer.Number = Convert.ToInt64(offerreader["number"].ToString());
                        offer.Year = Convert.ToInt64(offerreader["OfferYear"].ToString());
                        offer.IdCustomer = Convert.ToInt32(offerreader["IdSite"].ToString());
                        offer.IdStatus = Convert.ToByte(offerreader["IdStatus"].ToString());

                        offer.GeosStatus = new GeosStatus { IdOfferStatusType = Convert.ToByte(offerreader["IdStatus"].ToString()), Name = offerreader["OfferStatus"].ToString() };

                        if (offerreader["IdSalesStatusType"] != DBNull.Value)
                        {
                            offer.GeosStatus.IdSalesStatusType = Convert.ToByte(offerreader["IdSalesStatusType"].ToString());

                            offer.GeosStatus.SalesStatusType = new SalesStatusType();
                            offer.GeosStatus.SalesStatusType.IdSalesStatusType = Convert.ToByte(offerreader["IdSalesStatusType"].ToString());
                            offer.GeosStatus.SalesStatusType.Name = offerreader["SalesStatus"].ToString();
                        }

                        offer.IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString());
                        offer.ModifiedBy = Convert.ToInt32(offerreader["ModifiedBy"].ToString());

                        if (offerreader["IdBusinessUnit"] != DBNull.Value)
                            offer.IdBusinessUnit = Convert.ToByte(offerreader["IdBusinessUnit"].ToString());

                        if (offerreader["IdSource"] != DBNull.Value)
                            offer.IdSource = Convert.ToByte(offerreader["IdSource"].ToString());

                        offer.Description = offerreader["OfferTitle"].ToString();
                        offer.Site = new Company() { IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString()), Name = offerreader["SiteName"].ToString().Trim(), Country = new Country { Name = offerreader["CustomerCountry"].ToString(), Zone = new Zone { Name = offerreader["CustomerZone"].ToString() } } };

                        if (offerreader["IdSalesResponsible"] != DBNull.Value)
                            offer.Site.IdSalesResponsible = Convert.ToInt32(offerreader["IdSalesResponsible"].ToString());

                        if (offerreader["IdSalesResponsibleAssemblyBU"] != DBNull.Value)
                            offer.Site.IdSalesResponsibleAssemblyBU = Convert.ToInt32(offerreader["IdSalesResponsibleAssemblyBU"].ToString());

                        offer.Site.ConnectPlantId = activeSite.IdSite.ToString();
                        offer.Site.ShortName = activeSite.SiteAlias;
                        offer.OfferActiveSite = activeSite;

                        offer.Site.Customers = new List<Customer> { new Customer { IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString()), CustomerName = offerreader["CustomerGroup"].ToString() } };

                        if (offerreader["OfferAmount"] != DBNull.Value)
                            offer.Value = Convert.ToDouble(offerreader["OfferAmount"].ToString());

                        if (offerreader["IdProject"] != DBNull.Value)
                            offer.IdProject = Convert.ToInt32(offerreader["IdProject"].ToString());

                        if (offerreader["IdCarProject"] != DBNull.Value)
                            offer.IdCarProject = Convert.ToInt32(offerreader["IdCarProject"].ToString());

                        if (offerreader["OfferConfidentialLevel"] != DBNull.Value)
                            offer.ProbabilityOfSuccess = Convert.ToSByte(offerreader["OfferConfidentialLevel"].ToString());

                        if (offerreader["OfferExpectedDate"] != DBNull.Value)
                            offer.OfferExpectedDate = Convert.ToDateTime(offerreader["OfferExpectedDate"].ToString());
                        else
                            offer.OfferExpectedDate = null;

                        if (offerreader["RFQReception"] != DBNull.Value)
                            offer.RFQReception = Convert.ToDateTime(offerreader["RFQReception"].ToString());
                        else
                            offer.RFQReception = null;

                        if (offerreader["sendIn"] != DBNull.Value)
                            offer.SendIn = Convert.ToDateTime(offerreader["sendIn"].ToString());
                        else
                            offer.SendIn = null;

                        if (offerreader["DeliveryDate"] != DBNull.Value)
                            offer.DeliveryDate = Convert.ToDateTime(offerreader["DeliveryDate"].ToString());
                        else
                            offer.DeliveryDate = null;

                        if (offerreader["otsDeliveryDate"] != DBNull.Value)
                            offer.OTSDeliveryDate = Convert.ToDateTime(offerreader["otsDeliveryDate"].ToString());
                        else
                            offer.OTSDeliveryDate = null;

                        if (offerreader["POReceivedInDate"] != DBNull.Value)
                            offer.POReceivedInDate = Convert.ToDateTime(offerreader["POReceivedInDate"].ToString());
                        else
                            offer.POReceivedInDate = null;

                        offer.Rfq = offerreader["Rfq"].ToString();
                        offer.Comments = offerreader["Comments"].ToString();
                        offer.Currency = new Currency { IdCurrency = Convert.ToByte(offerreader["IdCurrency"].ToString()), Name = offerreader["CurrencyName"].ToString() };

                        if (offerreader["ModifiedIn"].ToString() == "01/01/1000 0:00:00")
                        {
                            offer.ModifiedIn = null;
                        }
                        else
                        {
                            offer.ModifiedIn = Convert.ToDateTime(offerreader["ModifiedIn"].ToString());
                        }

                        if (offerreader["CreatedIn"] != DBNull.Value)
                            offer.CreatedIn = Convert.ToDateTime(offerreader["CreatedIn"].ToString());

                        if (offerreader["IdCarOEM"] != DBNull.Value)
                            offer.IdCarOEM = Convert.ToInt32(offerreader["IdCarOEM"].ToString());

                        if (offerreader["OfferedBy"] != DBNull.Value)
                        {
                            offer.OfferedBy = Convert.ToInt32(offerreader["OfferedBy"]);
                            offer.OfferedByPerson = new People { IdPerson = Convert.ToInt32(offer.OfferedBy), Name = Convert.ToString(offerreader["OfferedByName"]), Surname = Convert.ToString(offerreader["OfferedBySurName"]), Email = Convert.ToString(offerreader["OfferedByEmail"]) };
                        }

                        if (offerreader["IsManualCategory"] != DBNull.Value)
                        {
                            offer.IsManualCategory = Convert.ToSByte(offerreader["IsManualCategory"]);
                        }

                        if (offerreader["IdProductCategory"] != DBNull.Value)
                        {
                            offer.IdProductCategory = Convert.ToInt64(offerreader["IdProductCategory"]);
                        }

                        if (offerreader["IdProductCategory"] != DBNull.Value)
                        {
                            offer.ProductCategory = new ProductCategory();

                            offer.ProductCategory.IdProductCategory = Convert.ToInt64(offerreader["IdProductCategory"]);
                            offer.ProductCategory.Name = offerreader["ProductSubCategory"].ToString();

                            if (offerreader["IdProductCategory"] != DBNull.Value)
                            {
                                offer.ProductCategory.Category = new ProductCategory();
                                if (offerreader["IdCategory"] != DBNull.Value)
                                    offer.ProductCategory.Category.IdProductCategory = Convert.ToInt64(offerreader["IdCategory"].ToString());
                                offer.ProductCategory.Category.Name = offerreader["ProductCategory"].ToString();
                            }
                        }

                        if (offerreader["AssignedTo"] != DBNull.Value)
                        {
                            offer.AssignedTo = Convert.ToInt32(offerreader["AssignedTo"]);
                            offer.AssignedToPerson = new People { IdPerson = Convert.ToInt32(offer.AssignedTo), Name = Convert.ToString(offerreader["AssignedName"]), Surname = Convert.ToString(offerreader["AssignedSurName"]), Email = Convert.ToString(offerreader["AssignedEmail"]) };
                        }

                        if (offerreader["OfferValue"] != DBNull.Value)
                            offer.OfferValue = Convert.ToDouble(offerreader["OfferValue"].ToString());

                        if (offerreader["IdOfferCurrency"] != DBNull.Value)
                            offer.IdOfferCurrency = Convert.ToByte(offerreader["IdOfferCurrency"].ToString());

                        if (offerreader["IsGoAheadProduction"] != DBNull.Value)
                            offer.IsGoAheadProduction = Convert.ToBoolean(offerreader["IsGoAheadProduction"]);

                        offer.OptionsByOffers = new List<OptionsByOffer>();
                        using (MySqlConnection conoptionsbyoffer = new MySqlConnection(connectionString))
                        {
                            conoptionsbyoffer.Open();
                            MySqlCommand conoptionsbyoffercommand = new MySqlCommand("optionsbyoffer_GetOptionsByOfferId", conoptionsbyoffer);
                            conoptionsbyoffercommand.CommandType = CommandType.StoredProcedure;
                            conoptionsbyoffercommand.Parameters.AddWithValue("_offerId", offer.IdOffer);
                            using (MySqlDataReader optionsbyofferreader = conoptionsbyoffercommand.ExecuteReader())
                            {
                                while (optionsbyofferreader.Read())
                                {

                                    OptionsByOffer optionsbyoffer = new OptionsByOffer();
                                    optionsbyoffer.IdOffer = Convert.ToInt64(optionsbyofferreader["IdOffer"].ToString());
                                    optionsbyoffer.IdOption = Convert.ToInt64(optionsbyofferreader["IdOption"].ToString());
                                    if (optionsbyofferreader["Quantity"] != DBNull.Value)
                                    {
                                        optionsbyoffer.Quantity = Convert.ToInt32(optionsbyofferreader["Quantity"].ToString());
                                        if (optionsbyoffer.Quantity > 0)
                                            optionsbyoffer.IsSelected = true;
                                        else
                                            optionsbyoffer.IsSelected = false;
                                    }
                                    else
                                    {
                                        optionsbyoffer.IsSelected = false;
                                    }
                                    optionsbyoffer.OfferOption = new OfferOption { IdOfferOption = Convert.ToInt64(optionsbyofferreader["IdOption"].ToString()), Name = optionsbyofferreader["offeroption"].ToString(), OfferOptionType = new OfferOptionType { IdOfferOptionType = Convert.ToInt32(optionsbyofferreader["IdOfferOptionType"].ToString()), Name = optionsbyofferreader["offeroptiontype"].ToString() } };

                                    if (offer.OptionsByOffers.Any(obo => obo.IdOffer == optionsbyoffer.IdOffer && obo.IdOption == optionsbyoffer.IdOption))
                                    {

                                    }
                                    else
                                    {
                                        offer.OptionsByOffers.Add(optionsbyoffer);
                                    }
                                }
                            }


                            if (offer.OptionsByOffers.Any(x => x.IdOption == 25))
                            {
                                List<Quotation> quotationByIdOffer = GetOfferQuotationByIdOffer(offer.IdOffer, connectionString).ToList();

                                Quotation quot = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == 23);
                                //if (quot == null)
                                //{

                                //    quot = GetQuotationIdByCode(offer.Code, connectionString);
                                //    if (quot != null)
                                //    {
                                //        offer.IsEngAnalysisUnlink = true;
                                //    }
                                //}
                                //else
                                //{
                                //    offer.IsEngAnalysisUnlink = false;
                                //}
                                if (quot != null)
                                {
                                    EngineeringAnalysis engineeringAnalysis = new EngineeringAnalysis();
                                    Ots ot = GetOTByQuotationId(quot, connectionString);

                                    if (ot != null)
                                    {
                                        engineeringAnalysis.EngineeringAnalysisTypes = GetEngineeringAnalysisTypesByQuotation_V2042(quot.IdQuotation, connectionString);
                                        engineeringAnalysis.DueDate = ot.DeliveryDate.Value;

                                        List<OtItem> otitems = GetOtItemsByIdOT(ot, connectionString);
                                        if (otitems.Count > 0)
                                        {
                                            engineeringAnalysis.Comments = otitems[0].CustomerComment;

                                            //If Analysis status is shipped then iscompleted is true.
                                            if (otitems.All(oti => oti.Status.IdItemOtStatus == 10))
                                            {
                                                engineeringAnalysis.IsCompleted = true;
                                            }
                                            else
                                            {
                                                engineeringAnalysis.IsCompleted = false;
                                            }
                                        }
                                    }

                                    engineeringAnalysis.Attachments = new List<Attachment>();

                                    string path = workingOrdersPath + @"\" + offer.Year + @"\" + offer.Code + @"\01 Project Specifications\";
                                    if (Directory.Exists(path))
                                    {
                                        string[] files = Directory.GetFiles(path);

                                        foreach (string file in files)
                                        {
                                            Attachment attachment = new Attachment();
                                            attachment.OriginalFileName = Path.GetFileName(file);
                                            attachment.FilePath = Path.GetFullPath(file);
                                            engineeringAnalysis.Attachments.Add(attachment);
                                        }
                                    }

                                    offer.EngineeringAnalysis = engineeringAnalysis;
                                }
                            }
                        }

                        offer.OfferStatusTracking = new List<OfferStatusTracking>();
                        using (MySqlConnection conofferstatus = new MySqlConnection(connectionString))
                        {
                            conofferstatus.Open();
                            MySqlCommand conofferstatuscommand = new MySqlCommand("offerstatustracking_GetOfferStatusTrackingByIdOffer", conofferstatus);
                            conofferstatuscommand.CommandType = CommandType.StoredProcedure;
                            conofferstatuscommand.Parameters.AddWithValue("_idOffer", offer.IdOffer);
                            using (MySqlDataReader offerstatusreader = conofferstatuscommand.ExecuteReader())
                            {
                                while (offerstatusreader.Read())
                                {
                                    if (offer.OfferStatusTracking.Any(ofs => ofs.SalesStatusType.IdSalesStatusType == Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString())))
                                    {
                                        OfferStatusTracking offerStatusTrackingtemp = offer.OfferStatusTracking.Where(ofs => ofs.SalesStatusType.IdSalesStatusType == Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString())).FirstOrDefault();
                                        offerStatusTrackingtemp.IdOfferStatusTracking = Convert.ToInt64(offerstatusreader["IdOfferStatusTracking"].ToString());
                                        offerStatusTrackingtemp.IdOffer = Convert.ToInt64(offerstatusreader["IdOffer"].ToString());
                                        offerStatusTrackingtemp.IdOfferStatusType = Convert.ToInt64(offerstatusreader["IdOfferStatusType"].ToString());
                                        offerStatusTrackingtemp.SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString()), Name = offerstatusreader["Name"].ToString(), HtmlColor = offerstatusreader["HtmlColor"].ToString() };
                                        offerStatusTrackingtemp.StartDate = Convert.ToDateTime(offerstatusreader["StartDate"].ToString());

                                        if (offerstatusreader["EndDate"] != DBNull.Value)
                                        {
                                            offerStatusTrackingtemp.EndDate = offerstatusreader["EndDate"].ToString();
                                        }
                                        else
                                        {
                                            offerStatusTrackingtemp.EndDate = DateTime.Now.ToString();
                                        }

                                        try
                                        {
                                            offerStatusTrackingtemp.NoOfDays = offerStatusTrackingtemp.NoOfDays + (Convert.ToDateTime(Convert.ToDateTime(offerStatusTrackingtemp.EndDate).ToString("yyyy-MM-dd")) - Convert.ToDateTime(offerStatusTrackingtemp.StartDate.ToString("yyyy-MM-dd"))).TotalDays;
                                        }
                                        catch (Exception ex)
                                        {

                                        }
                                    }
                                    else
                                    {
                                        OfferStatusTracking offerStatusTracking = new OfferStatusTracking();
                                        offerStatusTracking.IdOfferStatusTracking = Convert.ToInt64(offerstatusreader["IdOfferStatusTracking"].ToString());
                                        offerStatusTracking.IdOffer = Convert.ToInt64(offerstatusreader["IdOffer"].ToString());
                                        offerStatusTracking.IdOfferStatusType = Convert.ToInt64(offerstatusreader["IdOfferStatusType"].ToString());
                                        offerStatusTracking.SalesStatusType = new SalesStatusType { IdSalesStatusType = Convert.ToInt64(offerstatusreader["IdSalesStatusType"].ToString()), Name = offerstatusreader["Name"].ToString(), HtmlColor = offerstatusreader["HtmlColor"].ToString() };
                                        offerStatusTracking.StartDate = Convert.ToDateTime(offerstatusreader["StartDate"].ToString());

                                        if (offerstatusreader["EndDate"] != DBNull.Value)
                                        {
                                            offerStatusTracking.EndDate = offerstatusreader["EndDate"].ToString();
                                        }
                                        else
                                        {
                                            offerStatusTracking.EndDate = DateTime.Now.ToString();
                                        }

                                        try
                                        {
                                            offerStatusTracking.NoOfDays = (Convert.ToDateTime(Convert.ToDateTime(offerStatusTracking.EndDate).ToString("yyyy-MM-dd")) - Convert.ToDateTime(offerStatusTracking.StartDate.ToString("yyyy-MM-dd"))).TotalDays;
                                        }
                                        catch (Exception ex)
                                        {

                                        }

                                        offer.OfferStatusTracking.Add(offerStatusTracking);
                                    }
                                }
                            }
                        }
                    }
                }
            }


            return offer;
        }

        public EngineeringAnalysis GetEngAnalysisByOfferCode(Offer offer, string connectionString,string workingOrdersPath)
        {
            EngineeringAnalysis engineeringAnalysis = null;
            Quotation quot = GetQuotationIdByCode(offer.Code, connectionString);
            if (quot != null)
            {
                 engineeringAnalysis = new EngineeringAnalysis();
                Ots ot = GetOTByQuotationId(quot, connectionString);

                if (ot != null)
                {
                    engineeringAnalysis.EngineeringAnalysisTypes = GetEngineeringAnalysisTypesByQuotation_V2042(quot.IdQuotation, connectionString);
                    engineeringAnalysis.DueDate = ot.DeliveryDate.Value;

                    List<OtItem> otitems = GetOtItemsByIdOT(ot, connectionString);
                    if (otitems.Count > 0)
                    {
                        engineeringAnalysis.Comments = otitems[0].CustomerComment;

                        //If Analysis status is shipped then iscompleted is true.
                        if (otitems.All(oti => oti.Status.IdItemOtStatus == 10))
                        {
                            engineeringAnalysis.IsCompleted = true;
                        }
                        else
                        {
                            engineeringAnalysis.IsCompleted = false;
                        }
                    }
                }

                engineeringAnalysis.Attachments = new List<Attachment>();

                string path = workingOrdersPath + @"\" + offer.Year + @"\" + offer.Code + @"\01 Project Specifications\";
                if (Directory.Exists(path))
                {
                    string[] files = Directory.GetFiles(path);

                    foreach (string file in files)
                    {
                        Attachment attachment = new Attachment();
                        attachment.OriginalFileName = Path.GetFileName(file);
                        attachment.FilePath = Path.GetFullPath(file);
                        engineeringAnalysis.Attachments.Add(attachment);
                    }
                }
            }
            return engineeringAnalysis;
        }

        public Offer UpdateOffer_V2042(Offer offer, string connectionstring, string offerCodeConnectionString, Int32 idSite, Int32 idUser, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {

            bool isupdatedLeadToOT = true;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            try
            {
                if (offer.IsUpdateLeadToOT)
                {
                    if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
                    {
                        if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                            UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                        else
                            offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
                    }
                    else
                        UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                }

                if (offerInsertedInGCM)
                {
                    MySqlDataAdapter daGCM;
                    DataTable dtGCM;

                    using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                    {
                        conoffer.Open();
                        string query = "select IdOffer from offers where Code= '" + offer.Code + "' and IdOffer =" + offer.IdOffer + " ;";

                        daGCM = new MySqlDataAdapter(query, conoffer);
                        dtGCM = new DataTable();
                        daGCM.Fill(dtGCM);

                        if (dtGCM.Rows.Count > 0)
                            isupdatedLeadToOT = false;
                    }
                    Int64? nullProductCategory = null;
                    if (offer.IdProductCategory > 0)
                    {
                        nullProductCategory = offer.IdProductCategory;
                    }
                    if (offer.IsUpdateLeadToOT)
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("CRM_offersLeadOTUpdate_V2037", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                    conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Parameters.AddWithValue("_OfferedBy", offer.OfferedBy);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();

                                    offer.IsUpdated = true;
                                    trans.Commit();

                                    offer.Year = DateTime.Now.Year;
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }


                    }
                    else
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(connectionstring))
                        {
                            conoffer.Open();
                            using (MySqlTransaction trans = conoffer.BeginTransaction())
                            {
                                try
                                {
                                    MySqlCommand conoffercommand = new MySqlCommand("CRM_UpdateOffer_V2037", conoffer);

                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                    conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                                    conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                    conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                                    conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                                    conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                                    conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                                    conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                                    conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                                    conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                    conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                                    conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                                    conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                                    conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                                    conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                                    conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                                    conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                                    conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                                    conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                                    conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                                    conoffercommand.Parameters.AddWithValue("_IdProductCategory", nullProductCategory);
                                    conoffercommand.Parameters.AddWithValue("_IsManualCategory", offer.IsManualCategory);
                                    conoffercommand.Parameters.AddWithValue("_OfferedBy", offer.OfferedBy);
                                    conoffercommand.Transaction = trans;
                                    conoffercommand.ExecuteNonQuery();

                                    offer.IsUpdated = true;
                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }
                    }
                }

                if (offer.IsUpdated)
                {


                    UpdateEngAnalysisStatus(dotProjectConnectionString, offer);

                    offer = UpdateQuotation_V2042(offer, connectionstring, dotProjectConnectionString, mailServer, workbenchConnectionString, workingOrdersPath);



                    LostReasonsByOffer lostReasonsByOffer = UpdateLostReasonsByOffer(offer.LostReasonsByOffer, connectionstring);
                    AddLogEntryByOffer_V2040(offer, connectionstring);
                    AddOfferContact(offer.OfferContacts, connectionstring, offer.IdOffer);

                    if (offer.NewlyLinkedActivities != null && offer.NewlyLinkedActivities.Count > 0)
                    {
                        using (var transactionScope = new TransactionScope())
                        {
                            try
                            {
                                AddLinkExistingActivityToOffer_V2031(mainserverConnectionString, offer.NewlyLinkedActivities, offer.Site, offer.IdOffer);
                                transactionScope.Complete();
                            }
                            catch (Exception ex)
                            {
                                if (Transaction.Current != null)
                                    Transaction.Current.Rollback();

                                if (transactionScope != null)
                                    transactionScope.Dispose();

                                throw;
                            }
                        }
                    }



                }
            }
            catch (Exception ex)
            {
                throw;
                offer.IsUpdated = false;
            }

            return offer;
        }

        private Offer UpdateQuotation_V2042(Offer offer, string connectionstring, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString, string WorkingOrdersPath)
        {
            List<Quotation> quotationByIdOffer = GetOfferQuotationByIdOffer(offer.IdOffer, connectionstring).ToList();
            List<byte> quotIdDetectionsTemplates = quotationByIdOffer.Select(fg => fg.IdDetectionsTemplate).ToList();

            //List<byte> quotIdDetectionsTemplates = GetOfferQuotationByIdOffer(offer.IdOffer, connectionstring).ToList().Select(fg => fg.IdDetectionsTemplate).ToList();

            List<byte> selectedOptionByOfferTemplates = GetTemplatesBySelectedOptionsByOffer(connectionstring, offer.OptionsByOffers.Where(op => op.IsSelected == true).ToList());


            foreach (OptionsByOffer optionsByOffer in offer.OptionsByOffers)
            {
                if (optionsByOffer.IsSelected == true && optionsByOffer.Quantity > 0)
                {
                    List<Template> selectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                    Template selectedOptiontemplate = GetDefaultArticleByIdOfferOption_V2034(optionsByOffer.IdOption, connectionstring);
                    if (selectedOptiontemplate != null)
                        selectedOptionTemplates.Add(selectedOptiontemplate);

                    using (MySqlConnection conoption = new MySqlConnection(connectionstring))
                    {
                        conoption.Open();
                        using (MySqlTransaction trans = conoption.BeginTransaction())
                        {
                            try
                            {
                                MySqlCommand conoptioncommand = new MySqlCommand("optionsbyoffer_Update", conoption);
                                conoptioncommand.CommandType = CommandType.StoredProcedure;
                                conoptioncommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                conoptioncommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                conoptioncommand.Parameters.AddWithValue("_Quantity", optionsByOffer.Quantity);
                                conoptioncommand.Transaction = trans;
                                conoptioncommand.ExecuteNonQuery();
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                trans.Rollback();
                                throw;
                            }
                        }
                    }


                    foreach (Template quotation in selectedOptionTemplates)
                    {
                        if (!quotIdDetectionsTemplates.Contains(quotation.IdTemplate))
                        {
                            bool isUpdate = false;
                            string quotationCode = offer.Code + quotation.Suffix;
                            Int64 idQuotation = 0;

                            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                            {
                                conquotation.Open();
                                MySqlCommand conquotationcommand = new MySqlCommand("quotations_GetquotationsByCode", conquotation);
                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                using (MySqlDataReader reader = conquotationcommand.ExecuteReader())
                                {
                                    if (reader.Read())
                                    {
                                        isUpdate = true;

                                        if (reader["IdQuotation"] != DBNull.Value)
                                        {
                                            idQuotation = Convert.ToInt64(reader["IdQuotation"]);
                                        }
                                    }
                                }
                            }

                            if (isUpdate)
                            {
                                using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                {
                                    conquotation.Open();
                                    using (MySqlTransaction trans = conquotation.BeginTransaction())
                                    {
                                        try
                                        {
                                            // string sqlQuery = "update quotations set IdOffer=" + offer.IdOffer + " where IdDetectionsTemplate = " + quotation.IdTemplate + " AND Code = '" + quotationCode + "';";
                                            MySqlCommand conquotationcommand = new MySqlCommand("quotations_UpdateByCode", conquotation);
                                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                                            conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                            conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                            conquotationcommand.Transaction = trans;
                                            conquotationcommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }

                                //Engineering analysis update code. Comment and date when added from unlinked to linked.
                                if (optionsByOffer.IdOption == 25)
                                {
                                    Quotation quot = new Quotation();
                                    quot.IdQuotation = idQuotation;
                                    quot.Code = quotationCode;
                                    if (quot != null)
                                    {
                                        if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                        {
                                            isUpdateEngAnalysisRevisionQuantity_V2041(quot, offer, offer.EngineeringAnalysis.EngineeringAnalysisTypes, connectionstring);
                                        }

                                        List<OtItem> defaultArticleNotInWarehouseProduct = new List<OtItem>();
                                        if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                        {
                                            defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct_V2041(quot.IdQuotation, connectionstring, offer.EngineeringAnalysis.EngineeringAnalysisTypes);
                                        }
                                        else
                                        {
                                            defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct_V2041(quot.IdQuotation, connectionstring, null);
                                        }
                                        if (defaultArticleNotInWarehouseProduct.Count > 0)
                                        {
                                            //Generate revisionitem in rev0 and rev1 and otitem for that revsion 1
                                            CreateDefaultArticlesNotExistItems_V2041(quot, offer, defaultArticleNotInWarehouseProduct, connectionstring);
                                        }


                                        List<OtItem> otitems = null;

                                        Ots ot = GetOTByQuotationId(quot, connectionstring);
                                        if (ot != null)
                                        {
                                            otitems = GetOtItemsByIdOT_V2041(ot, connectionstring);
                                            if(otitems!=null)
                                            using (var transactionScope = new TransactionScope())
                                            {
                                                try
                                                {
                                                    UpdateOTByIdOT(offer, quot, ot, connectionstring);

                                                    foreach (var otItem in otitems.Where(oi=>oi.Status.IdItemOtStatus!=10).ToList())
                                                    {
                                                        UpdateOTitemByIdOtItem_V2042(offer, otItem, connectionstring);


                                                        //Get part number tracking and add update tracking
                                                        PartNumbersTracking partNumbersTracking = GetPartNumbersTrackingByIdOtItem(otItem, 23, connectionstring);

                                                        if (partNumbersTracking != null)
                                                        {
                                                            if (otItem.Status.IdItemOtStatus != 10 && otItem.RevisionItem.Quantity > 0 && offer.EngineeringAnalysis.IsCompleted)
                                                            {
                                                                partNumbersTracking.IdOperator = offer.ModifiedBy;
                                                                partNumbersTracking.EndDate = DateTime.Now;
                                                                partNumbersTracking.Paused = false;
                                                            }
                                                            else if (otItem.Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                            {
                                                                partNumbersTracking.IdOperator = null;
                                                                partNumbersTracking.EndDate = null;
                                                                partNumbersTracking.Paused = true;

                                                            }

                                                            UpdatePartNumbersTrackingByIdPartNumbersTracking(offer, partNumbersTracking, connectionstring);
                                                        }


                                                    }
                                                    transactionScope.Complete();
                                                }
                                                catch (Exception ex)
                                                {
                                                    if (Transaction.Current != null)
                                                        Transaction.Current.Rollback();

                                                    if (transactionScope != null)
                                                        transactionScope.Dispose();

                                                    throw;
                                                }
                                            }

                                            quot.Ots = new List<Ots>();
                                            quot.Ots.Add(ot);
                                            UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, quot, workbenchConnectionString, mailServer);

                                            if (otitems != null && otitems.Count > 0)
                                            {
                                                ApplicationManager applicationManager = new ApplicationManager();

                                                //This property is for AssignedEngAnalysis from dotproject.
                                                People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);

                                                // Send email when eng analysis is validated by 
                                                if ((!otitems.Any(oti => oti.Status.IdItemOtStatus == 10)) && offer.EngineeringAnalysis.IsCompleted)
                                                {
                                                    if (offer.EngineeringAnalysis != null)
                                                        applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                                    else
                                                        applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, ot.DeliveryDate);

                                                    LogEntryByOffer log = new LogEntryByOffer();
                                                    log.IdUser = offer.ModifiedBy;
                                                    log.DateTime = DateTime.Now;
                                                    log.Comments = "The analysis of engineering department has been completed.";
                                                    log.IdLogEntryType = 2;
                                                    offer.LogEntryByOffers.Add(log);
                                                }
                                                else if ((otitems.Any(oti => oti.Status.IdItemOtStatus == 10)) && !offer.EngineeringAnalysis.IsCompleted)
                                                {
                                                    if (offer.EngineeringAnalysis != null)
                                                        applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                                    else
                                                        applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, ot.DeliveryDate);

                                                    LogEntryByOffer log = new LogEntryByOffer();
                                                    log.IdUser = offer.ModifiedBy;
                                                    log.DateTime = DateTime.Now;
                                                    log.Comments = "The analysis of engineering department has been re-opened.";
                                                    log.IdLogEntryType = 2;
                                                    offer.LogEntryByOffers.Add(log);
                                                }
                                            }
                                        }
                                    }


                                }
                            }
                            else
                            {
                                //Int64 idQuotation = 0;
                                Quotation tempquotation = new Quotation();
                                tempquotation.Offer = new Offer();
                                tempquotation.Offer.IdOffer = offer.IdOffer;
                                tempquotation.Year = DateTime.Now.Year;
                                tempquotation.Number = offer.Number;
                                tempquotation.Code = offer.Code + quotation.Suffix;
                                tempquotation.CreatedIn = DateTime.Now;
                                tempquotation.Template = new Template();
                                tempquotation.Template = quotation;
                                if (quotation.IdTemplate != 0)
                                {
                                    // string quotationCode = offer.Code + quotation.Suffix;
                                    using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                    {
                                        conquotation.Open();
                                        using (MySqlTransaction trans = conquotation.BeginTransaction())
                                        {
                                            try
                                            {
                                                MySqlCommand conquotationcommand = new MySqlCommand("quotations_Insert", conquotation);
                                                conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                                conquotationcommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                                                conquotationcommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                                                conquotationcommand.Parameters.AddWithValue("_Number", offer.Number);
                                                conquotationcommand.Parameters.AddWithValue("_Code", quotationCode);
                                                conquotationcommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                                conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                                conquotationcommand.Parameters.AddWithValue("_QuotQuantity", 0);
                                                conquotationcommand.Parameters.AddWithValue("_Description", offer.Description);
                                                conquotationcommand.Transaction = trans;
                                                idQuotation = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                if (idQuotation > 0)
                                                {
                                                    bool isinsert = false;
                                                    MySqlCommand conoffercommand = new MySqlCommand("revisions_GetrevisionsByIdQuotation", conquotation);
                                                    conoffercommand.CommandType = CommandType.StoredProcedure;
                                                    conoffercommand.Parameters.AddWithValue("_IdQuotation", idQuotation);

                                                    using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                                                    {
                                                        if (!offerreader.Read())
                                                        {
                                                            isinsert = true;
                                                        }
                                                    }

                                                    if (isinsert)
                                                    {
                                                        Revision r = new Revision();
                                                        r.NumRevision = 0;
                                                        //[001]
                                                        if (offer.ModifiedBy != null && offer.ModifiedBy == 164)
                                                        {
                                                            r.CreatedBy = 164;
                                                            r.ReviewedBy = 164;
                                                        }
                                                        else
                                                        {
                                                            r.CreatedBy = offer.ModifiedBy;
                                                            r.ReviewedBy = offer.ModifiedBy;
                                                        }
                                                        r.CreatedIn = DateTime.Now;
                                                        r.NumRevision = 0;
                                                        r.Discount = 0;
                                                        r.ExpireDate = DateTime.Now.AddDays(14);
                                                        r.Comments = offer.Contact + "\r\n" + offer.Description;
                                                        //r.Quotation = quotation;
                                                        if (quotation.IdTemplate == 15 || quotation.IdTemplate == 16 || quotation.IdTemplate == 18)
                                                            r.ApprovedIn = DateTime.Now;
                                                        else
                                                            r.ApprovedIn = Convert.ToDateTime("0001-01-01 00:00:00");

                                                        conquotationcommand = new MySqlCommand("revisions_Insert", conquotation);
                                                        conquotationcommand.CommandType = CommandType.StoredProcedure;
                                                        conquotationcommand.Parameters.AddWithValue("_SentTo", string.Empty);
                                                        conquotationcommand.Parameters.AddWithValue("_ReviewedBy", r.ReviewedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_NumRevision", r.NumRevision);
                                                        conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_MadeBy", r.CreatedBy);
                                                        conquotationcommand.Parameters.AddWithValue("_IdQuotation", idQuotation);
                                                        conquotationcommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                                                        conquotationcommand.Parameters.AddWithValue("_ExpiryDate", r.ExpireDate.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_Discount", 0);
                                                        conquotationcommand.Parameters.AddWithValue("_CreationDate", r.CreatedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Parameters.AddWithValue("_Comments", r.Comments);
                                                        conquotationcommand.Parameters.AddWithValue("_Closed", r.ApprovedIn.ToString("yyyy/MM/dd HH:mm:ss"));
                                                        conquotationcommand.Transaction = trans;
                                                        r.Id = Convert.ToInt64(conquotationcommand.ExecuteScalar());
                                                        tempquotation.Revisions = new List<Revision>();
                                                        tempquotation.Revisions.Add(r);
                                                    }
                                                }
                                                trans.Commit();
                                            }
                                            catch (Exception ex)
                                            {
                                                trans.Rollback();
                                                throw;
                                            }
                                        }
                                    }

                                    tempquotation.IdQuotation = idQuotation;

                                    ///////////////////////////////////////////////////////

                                    if (offer.IdOfferType != 10 && quotation.IdTemplate == 15) // || quotation.IdTemplate == 23))
                                    {
                                        List<OtItem> items = new List<OtItem>();

                                        List<OtItem> temp = GetDefaultArticlesByOfferOptionAndTemplate(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring);
                                        items.AddRange(temp);
                                        if (items.Count != 0)
                                            CreateQuotationWithItems_V2041(tempquotation, offer, items, connectionstring);
                                    }
                                    else if (offer.IdOfferType != 10 && quotation.IdTemplate == 23)
                                    {
                                        List<OtItem> items = new List<OtItem>();
                                        List<OtItem> temp = new List<OtItem>();
                                        if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                            temp = GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis_V2041(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring, offer.EngineeringAnalysis.EngineeringAnalysisTypes);
                                        else
                                            temp = GetDefaultArticlesByOfferOptionAndTemplateForEngAnalysis_V2041(optionsByOffer.IdOption, quotation.IdTemplate, connectionstring, null);

                                        items.AddRange(temp);
                                        if (items.Count != 0)
                                            CreateQuotationWithItems_V2041(tempquotation, offer, items, connectionstring);

                                        //link EPC for eng analysis. 
                                        if (!ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                            InsertEngAnalysisInDotProject_V2040(dotProjectConnectionString, connectionstring, mailServer, workbenchConnectionString, offer, tempquotation);
                                        else
                                            UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, tempquotation, workbenchConnectionString, mailServer);
                                        //GOM_v3.Properties.Settings.Default.Email_Delivery_Date_Changed


                                    }
                                }
                            }
                        }
                        else
                        {
                            //Update Quotation Codes when offer type is changed.
                            string quotationCode = offer.Code + quotation.Suffix;

                            Quotation quotationByOffer = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == quotation.IdTemplate);

                            if (quotation != null)
                                UpdateQuotationCodeIfTypeChanged(offer, quotationByOffer, quotation, connectionstring);

                            if (optionsByOffer.IdOption == 25) //Engineering analysis update code.
                            {
                                Quotation quot = quotationByIdOffer.FirstOrDefault(x => x.IdDetectionsTemplate == 23);
                                quot.Code = quotationCode;
                                if (quot != null)
                                {
                                    if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                    {
                                        isUpdateEngAnalysisRevisionQuantity_V2042(quot, offer, offer.EngineeringAnalysis.EngineeringAnalysisTypes, connectionstring);
                                    }

                                    List<OtItem> defaultArticleNotInWarehouseProduct = new List<OtItem>();
                                    if (offer.EngineeringAnalysis != null && offer.EngineeringAnalysis.EngineeringAnalysisTypes != null)
                                    {
                                        defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct_V2041(quot.IdQuotation, connectionstring, offer.EngineeringAnalysis.EngineeringAnalysisTypes);
                                    }
                                    else
                                    {
                                        defaultArticleNotInWarehouseProduct = GetDefaultArticleNotInWarehouseProduct_V2041(quot.IdQuotation, connectionstring, null);
                                    }
                                    if (defaultArticleNotInWarehouseProduct.Count > 0)
                                    {
                                        //Generate revisionitem in rev0 and rev1 and otitem for that revsion 1
                                        CreateDefaultArticlesNotExistItems_V2041(quot, offer, defaultArticleNotInWarehouseProduct, connectionstring);
                                    }

                                    Ots ot = GetOTByQuotationId(quot, connectionstring);
                                    List<OtItem> otitems = null;

                                    if (ot != null)
                                    {
                                        otitems = GetOtItemsByIdOT_V2041(ot, connectionstring);
                                        if(otitems!= null)
                                        using (var transactionScope = new TransactionScope())
                                        {
                                            try
                                            {
                                                UpdateOTByIdOT(offer, quot, ot, connectionstring);

                                                foreach (var otItem in otitems.Where(oi => oi.Status.IdItemOtStatus != 10).ToList())
                                                {
                                                    UpdateOTitemByIdOtItem_V2042(offer, otItem, connectionstring);

                                                    //Get part number tracking and add update tracking
                                                    PartNumbersTracking partNumbersTracking = GetPartNumbersTrackingByIdOtItem(otItem, 23, connectionstring);

                                                    if (partNumbersTracking != null)
                                                    {
                                                        if (otItem.Status.IdItemOtStatus != 10 && otItem.RevisionItem.Quantity > 0 && offer.EngineeringAnalysis.IsCompleted)
                                                        {
                                                            partNumbersTracking.IdOperator = offer.ModifiedBy;
                                                            partNumbersTracking.EndDate = DateTime.Now;
                                                            partNumbersTracking.Paused = false;
                                                        }
                                                        else if (otItem.Status.IdItemOtStatus == 10 && !offer.EngineeringAnalysis.IsCompleted)
                                                        {
                                                            partNumbersTracking.IdOperator = null;
                                                            partNumbersTracking.EndDate = null;
                                                            partNumbersTracking.Paused = true;
                                                        }

                                                        UpdatePartNumbersTrackingByIdPartNumbersTracking(offer, partNumbersTracking, connectionstring);
                                                    }
                                                }

                                                transactionScope.Complete();
                                            }
                                            catch (Exception ex)
                                            {
                                                if (Transaction.Current != null)
                                                    Transaction.Current.Rollback();

                                                if (transactionScope != null)
                                                    transactionScope.Dispose();

                                                throw;
                                            }
                                        }
                                    }

                                    quot.Ots = new List<Ots>();
                                    quot.Ots.Add(ot);
                                    if (ot != null)
                                        UpdateEndDateEngAnalysis(dotProjectConnectionString, connectionstring, offer, quotationByOffer, workbenchConnectionString, mailServer);

                                    if (otitems != null && otitems.Count > 0)
                                    {
                                        ApplicationManager applicationManager = new ApplicationManager();

                                        //This property is for AssignedEngAnalysis from dotproject.
                                        People assignedEngAnalysisPerson = GetTaskOwnerOfProjectByOfferCode(offer.Code, dotProjectConnectionString);

                                        // Send email when eng analysis is validated by 
                                        if ((!otitems.Any(oti => oti.Status.IdItemOtStatus == 10)) && offer.EngineeringAnalysis.IsCompleted)
                                        {
                                            if (offer.EngineeringAnalysis != null)
                                            {
                                                applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                            }
                                            else
                                            {
                                                applicationManager.SendEngineeringAnalysisReadyMail(mailServer, offer, offer.ModifiedByUser, assignedEngAnalysisPerson, ot.DeliveryDate);
                                            }

                                            LogEntryByOffer log = new LogEntryByOffer();
                                            log.IdUser = offer.ModifiedBy;
                                            log.DateTime = DateTime.Now;
                                            log.Comments = "The analysis of engineering department has been completed.";
                                            log.IdLogEntryType = 2;
                                            offer.LogEntryByOffers.Add(log);
                                        }
                                        else if ((otitems.Any(oti => oti.Status.IdItemOtStatus == 10)) && !offer.EngineeringAnalysis.IsCompleted)
                                        {
                                            if (offer.EngineeringAnalysis != null)
                                            {
                                                applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, offer.EngineeringAnalysis.DueDate);
                                            }
                                            else
                                            {
                                                applicationManager.SendEngineeringAnalysisReopenedMail(mailServer, offer, assignedEngAnalysisPerson, ot.DeliveryDate);
                                            }

                                            LogEntryByOffer log = new LogEntryByOffer();
                                            log.IdUser = offer.ModifiedBy;
                                            log.DateTime = DateTime.Now;
                                            log.Comments = "The analysis of engineering department has been re-opened.";
                                            log.IdLogEntryType = 2;
                                            offer.LogEntryByOffers.Add(log);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                else
                {
                    if (optionsByOffer.IsSelected == false && optionsByOffer.Quantity == 0)
                    {
                        //if (optionsByOffer.IdOption == 25)
                        //{
                        //    if (offer.IsEngAnalysisSetONToOFF)
                        //        UnlinkedEngAnalysisTypesFromOfferSetQuantity0(offer, connectionstring);

                        //}


                        using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                        {
                            conquotation.Open();
                            using (MySqlTransaction trans = conquotation.BeginTransaction())
                            {
                                try
                                {
                                    //string sqlQuery = "DELETE FROM optionsbyoffer WHERE IdOffer = " + offer.IdOffer + " AND IdOption = " + optionsByOffer.IdOption + ";";
                                    MySqlCommand conquotationcommand = new MySqlCommand("optionsbyoffer_Delete", conquotation);
                                    conquotationcommand.CommandType = CommandType.StoredProcedure;
                                    conquotationcommand.Parameters.AddWithValue("_IdOption", optionsByOffer.IdOption);
                                    conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                    conquotationcommand.Transaction = trans;
                                    conquotationcommand.ExecuteNonQuery();

                                    if (optionsByOffer.IdOption == 25 && ExistProjectInDotProject(dotProjectConnectionString, offer.Code))
                                        UpdateProjectStatusInDotProject(dotProjectConnectionString, offer, 7);

                                    trans.Commit();
                                }
                                catch (Exception ex)
                                {
                                    trans.Rollback();
                                    throw;
                                }
                            }
                        }

                        List<Template> unselectedOptionTemplates = GetTemplatesByIdOfferOption(connectionstring, optionsByOffer.IdOption);
                        Template unselectedOptionTemplate = GetDefaultArticleByIdOfferOption_V2034(optionsByOffer.IdOption, connectionstring);

                        if (unselectedOptionTemplate != null)
                            unselectedOptionTemplates.Add(unselectedOptionTemplate);

                        foreach (Template quotation in unselectedOptionTemplates)
                        {
                            if (!selectedOptionByOfferTemplates.Contains(quotation.IdTemplate))
                            {
                                using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
                                {
                                    conquotation.Open();
                                    using (MySqlTransaction trans = conquotation.BeginTransaction())
                                    {
                                        try
                                        {
                                            //string sqlQuery = "update quotations set IdOffer=null where IdDetectionsTemplate = " + quotation.IdTemplate + " AND IdOffer = " + offer.IdOffer + ";";
                                            MySqlCommand conquotationcommand = new MySqlCommand("quotations_UpdateByIdOfferANDTemplate", conquotation);
                                            conquotationcommand.CommandType = CommandType.StoredProcedure;
                                            conquotationcommand.Parameters.AddWithValue("_IdDetectionsTemplate", quotation.IdTemplate);
                                            conquotationcommand.Parameters.AddWithValue("_IdOffer", offer.IdOffer);
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
                                            conquotationcommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                                            conquotationcommand.Transaction = trans;
                                            conquotationcommand.ExecuteNonQuery();
                                            trans.Commit();
                                        }
                                        catch (Exception ex)
                                        {
                                            trans.Rollback();
                                            throw;
                                        }
                                    }
                                }
                            }
                        }



                    }

                }

            }
            return offer;

        }

       
        public List<EngineeringAnalysisArticleDetail> GetEngineeringAnalysisArticleDetail(string  offerCode, string connectionstring)
        {
            List<EngineeringAnalysisArticleDetail> engineeringAnalysisArticleDetails = new List<EngineeringAnalysisArticleDetail>();

           
            using (MySqlConnection con = new MySqlConnection(connectionstring))
            {
                con.Open();
                               
                MySqlCommand concommand = new MySqlCommand("CRM_GetEngAnalysisArticleStatus", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_offerCode", offerCode);
               

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        EngineeringAnalysisArticleDetail engineeringAnalysisArticleDetail = new EngineeringAnalysisArticleDetail();
                        if (reader["IdArticle"] != DBNull.Value)
                            engineeringAnalysisArticleDetail.IdArticle = Convert.ToInt32(reader["IdArticle"]);
                        if (reader["Code"] != DBNull.Value)
                            engineeringAnalysisArticleDetail.QuotationCode = Convert.ToString(reader["Code"]);
                        if (reader["IdItemOtStatus"] != DBNull.Value)
                        {
                            engineeringAnalysisArticleDetail.IdItemOtStatus = Convert.ToByte(reader["IdItemOtStatus"]);
                            if(engineeringAnalysisArticleDetail.IdItemOtStatus==10)
                            {
                                engineeringAnalysisArticleDetail.IsArticleEnabled = false;
                            }
                            else
                            {
                                engineeringAnalysisArticleDetail.IsArticleEnabled = true;
                            }

                        }
                            
                        if (reader["Quantity"] != DBNull.Value)
                            engineeringAnalysisArticleDetail.Quantity = Convert.ToInt64(reader["Quantity"]);
                        if (reader["IsUnLinkQuotation"] != DBNull.Value)
                            engineeringAnalysisArticleDetail.IsUnLinkQuotation = Convert.ToSByte(reader["IsUnLinkQuotation"]);

                        engineeringAnalysisArticleDetails.Add(engineeringAnalysisArticleDetail);
                    }
                }
            }

            return engineeringAnalysisArticleDetails;
        }

        public bool UpdateAttachActivity(Activity activity, string mainServerConnectionString, string activityAttachmentPath)
        {

            bool isUpdated = false;

            TransactionScope transactionScope = null;

            try
            {
                using (transactionScope = new System.Transactions.TransactionScope())
                {
                    AddLogEntriesByActivity(activity.IdActivity, activity.LogEntriesByActivity, mainServerConnectionString);
                    UpdateCommentsByActivity(activity.CommentsByActivity, mainServerConnectionString);

                    if (activity.ActivityAttachment != null && activity.ActivityAttachment.Count > 0)
                        AddActivityAttachment(activity, activity.ActivityAttachment, mainServerConnectionString, activityAttachmentPath);
                    
                    transactionScope.Complete();
                    isUpdated = true;
                }
            }
            catch (Exception ex)
            {
                isUpdated = false;
                transactionScope.Dispose();
                throw;
            }

            return isUpdated;


        }

        private Quotation GetQuotationIdByCode(string offerCode, string connectionstring)
        {
            Quotation quotation = null;
            using (MySqlConnection conquotation = new MySqlConnection(connectionstring))
            {
                conquotation.Open();
                MySqlCommand conquotationcommand = new MySqlCommand("CRM_GetQuotationIdByCode", conquotation);
                conquotationcommand.CommandType = CommandType.StoredProcedure;
                conquotationcommand.Parameters.AddWithValue("_offerCode", offerCode);
                using (MySqlDataReader quotationreader = conquotationcommand.ExecuteReader())
                {
                    while (quotationreader.Read())
                    {
                        quotation = new Quotation();
                        if (quotationreader["IdQuotation"] != DBNull.Value)
                            quotation.IdQuotation = Convert.ToInt64(quotationreader["IdQuotation"].ToString());
                    }
                }
            }
            return quotation;
        }

        public bool UpdateAttachOffer(Offer offer, string connectionstring,string workingOrdersPath)
        {
            bool isUpdated = false;

            try
            {              
                AddLogEntryByOffer_V2040(offer, connectionstring);

                if (offer.OutLookMailCopy.FileByte != null)
                {
                    try
                    {

                        string path = Path.Combine(workingOrdersPath, offer.Year.ToString() , offer.Code);
                        if (Directory.Exists(path))
                        {
                            if (!Directory.Exists(Path.Combine(path, "00  Outlook Attachments")))
                            {
                                Directory.CreateDirectory(Path.Combine(path, "00  Outlook Attachments"));
                            }
                            File.WriteAllBytes(Path.Combine(path, "00  Outlook Attachments", offer.OutLookMailCopy.FileName), offer.OutLookMailCopy.FileByte);
                            isUpdated = true;
                        }
                        else
                        {
                            isUpdated = false;
                            Directory.GetDirectories(path);
                        }


                    }
                    catch (DirectoryNotFoundException directoryNotFoundException)
                    {
                        isUpdated = false;
                        throw;
                    }
                    catch (Exception ex)
                    {
                        isUpdated = false;
                        throw;
                    }
                }
                isUpdated = true;
            }
            catch (Exception ex)
            {
                throw;
                isUpdated = false;
            }

            return isUpdated;
        }

        public List<ActionPlanItem> GetSalesActivityRegister_V2043(string idsSelectedUser, string idsSelectedPlant, Int32 idUser, Int32 idPermission, DateTime closedDate, string connectionString)
        {
            List<ActionPlanItem> actionPlanItems = new List<ActionPlanItem>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("CRM_GetSalesActivityRegister_V2043", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdsSelectedUser", idsSelectedUser);
                concommand.Parameters.AddWithValue("_IdsSelectedPlant", idsSelectedPlant);
                concommand.Parameters.AddWithValue("_IdUser", idUser);
                concommand.Parameters.AddWithValue("_IdPermission", idPermission);
                concommand.Parameters.AddWithValue("_ClosedDate", closedDate);

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ActionPlanItem actionPlanItem = new ActionPlanItem();
                        actionPlanItem.ActionPlan = new ActionPlan();
                        if (reader["IdActionPlan"] != DBNull.Value)
                        {

                            actionPlanItem.ActionPlan.IdActionPlan = Convert.ToInt64(reader["IdActionPlan"].ToString());
                            if (reader["Code"] != DBNull.Value)
                                actionPlanItem.ActionPlan.Code = Convert.ToString(reader["Code"].ToString());
                            if (reader["Name"] != DBNull.Value)
                                actionPlanItem.ActionPlan.Name = Convert.ToString(reader["Name"].ToString());

                            if (reader["LastMeetingDate"] != DBNull.Value)
                                actionPlanItem.ActionPlan.LastMeetingDate = Convert.ToDateTime(reader["LastMeetingDate"].ToString());
                            if (reader["NextMeetingDate"] != DBNull.Value)
                                actionPlanItem.ActionPlan.NextMeetingDate = Convert.ToDateTime(reader["NextMeetingDate"].ToString());
                            if (reader["CreationDate"] != DBNull.Value)
                                actionPlanItem.ActionPlan.CreationDate = Convert.ToDateTime(reader["CreationDate"].ToString());
                            if (reader["ModificationDate"] != DBNull.Value)
                                actionPlanItem.ActionPlan.ModificationDate = Convert.ToDateTime(reader["ModificationDate"].ToString());

                            if (reader["IdActionPlanItem"] != DBNull.Value)
                                actionPlanItem.IdActionPlanItem = Convert.ToInt64(reader["IdActionPlanItem"].ToString());

                            if (reader["IdSalesActivityType"] != DBNull.Value)
                            {
                                actionPlanItem.IdSalesActivityType = Convert.ToInt32(reader["IdSalesActivityType"].ToString());
                                actionPlanItem.SalesActivityType=new LookupValue();
                                actionPlanItem.SalesActivityType.IdLookupValue = Convert.ToInt32(reader["IdSalesActivityType"].ToString());
                                actionPlanItem.SalesActivityType.Value = Convert.ToString(reader["SalesActivityType"].ToString());
                                actionPlanItem.SalesActivityType.HtmlColor = Convert.ToString(reader["SalesActivityTypeColor"].ToString());
                            }
                              
                            if (reader["IdScope"] != DBNull.Value)
                                actionPlanItem.IdScope = Convert.ToInt32(reader["IdScope"].ToString());
                            if (reader["Number"] != DBNull.Value)
                                actionPlanItem.Number = Convert.ToInt64(reader["Number"].ToString());
                            if (reader["IdSite"] != DBNull.Value)
                                actionPlanItem.IdSite = Convert.ToInt32(reader["IdSite"].ToString());
                            if (reader["IdCustomer"] != DBNull.Value)
                                actionPlanItem.IdGroup = Convert.ToInt32(reader["IdCustomer"].ToString());
                            if (reader["Title"] != DBNull.Value)
                                actionPlanItem.Title = Convert.ToString(reader["Title"].ToString());
                            if (reader["OpenDate"] != DBNull.Value)
                                actionPlanItem.OpenDate = Convert.ToDateTime(reader["OpenDate"].ToString());
                            if (reader["ExpectedDueDate"] != DBNull.Value)
                                actionPlanItem.ExpectedDueDate = Convert.ToDateTime(reader["ExpectedDueDate"].ToString());
                            if (reader["CurrentDueDate"] != DBNull.Value)
                                actionPlanItem.CurrentDueDate = Convert.ToDateTime(reader["CurrentDueDate"].ToString());
                            if (reader["DueDateChangeCount"] != DBNull.Value)
                                actionPlanItem.DueDateChangeCount = Convert.ToInt64(reader["DueDateChangeCount"].ToString());
                            if (reader["CloseDate"] != DBNull.Value)
                                actionPlanItem.CloseDate = Convert.ToDateTime(reader["CloseDate"].ToString());
                            if (reader["IdReporter"] != DBNull.Value)
                                actionPlanItem.IdReporter = Convert.ToInt32(reader["IdReporter"].ToString());
                            if (reader["IdAssignee"] != DBNull.Value)
                                actionPlanItem.IdAssignee = Convert.ToInt32(reader["IdAssignee"].ToString());
                            if (reader["IdStatus"] != DBNull.Value)
                                actionPlanItem.IdStatus = Convert.ToInt32(reader["IdStatus"].ToString());

                            if (reader["CreationDate"] != DBNull.Value)
                                actionPlanItem.CreationDate = Convert.ToDateTime(reader["CreationDate"].ToString());

                            if (reader["APIModificationDate"] != DBNull.Value)
                                actionPlanItem.ModificationDate = Convert.ToDateTime(reader["APIModificationDate"].ToString());

                            if (reader["Scope"] != DBNull.Value)
                                actionPlanItem.Scope = Convert.ToString(reader["Scope"].ToString());

                            if (reader["Reporter"] != DBNull.Value)
                                actionPlanItem.Reporter = Convert.ToString(reader["Reporter"].ToString());

                            if (reader["Assignee"] != DBNull.Value)
                                actionPlanItem.Assignee = Convert.ToString(reader["Assignee"].ToString());

                            if (reader["CustomerName"] != DBNull.Value)
                                actionPlanItem.Group = Convert.ToString(reader["CustomerName"].ToString());

                            if (reader["SiteName"] != DBNull.Value)
                                actionPlanItem.Plant = Convert.ToString(reader["SiteName"].ToString());

                            if (reader["Country"] != DBNull.Value)
                                actionPlanItem.Country = Convert.ToString(reader["Country"].ToString());

                            if (reader["IdStatus"] != DBNull.Value)
                            {
                                actionPlanItem.Status = new LookupValue();
                                actionPlanItem.IdStatus = Convert.ToInt32(reader["IdStatus"]);
                                actionPlanItem.Status.IdLookupValue = actionPlanItem.IdStatus;
                                actionPlanItem.Status.Value = Convert.ToString(reader["Status"].ToString());

                                if (reader["HtmlColor"] != DBNull.Value)
                                    actionPlanItem.Status.HtmlColor = Convert.ToString(reader["HtmlColor"]);
                            }
                            actionPlanItem.ActionPlan.Code = string.Format("{0} - {1}", actionPlanItem.ActionPlan.Code, actionPlanItem.Number);
                            actionPlanItems.Add(actionPlanItem);
                        }

                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {


                            if (reader["IdActionPlanItem"] != DBNull.Value)
                                if (actionPlanItems.Any(ap => ap.IdActionPlanItem == Convert.ToInt64(reader["IdActionPlanItem"].ToString())))
                                {
                                    ActionPlanItem actionPlanItem = actionPlanItems.Where(ap => ap.IdActionPlanItem == Convert.ToInt64(reader["IdActionPlanItem"].ToString())).FirstOrDefault();

                                    LogEntriesByActionItem logEntriesByActionItem = new LogEntriesByActionItem();

                                    if (reader["IdLogEntriesByActionItem"] != DBNull.Value)
                                        logEntriesByActionItem.IdLogEntryByActionItem = Convert.ToInt64(reader["IdLogEntriesByActionItem"].ToString());

                                    if (reader["IdActionPlanItem"] != DBNull.Value)
                                        logEntriesByActionItem.IdActionPlanItem = Convert.ToInt64(reader["IdActionPlanItem"].ToString());
                                    if (reader["Comments"] != DBNull.Value)
                                        logEntriesByActionItem.Comment = Convert.ToString(reader["Comments"].ToString());
                                    if (reader["CreationDate"] != DBNull.Value)
                                        logEntriesByActionItem.CreationDate = Convert.ToDateTime(reader["CreationDate"].ToString());
                                    if (reader["IdCreator"] != DBNull.Value)
                                        logEntriesByActionItem.IdCreator = Convert.ToInt32(reader["IdCreator"].ToString());
                                    if (reader["ModificationDate"] != DBNull.Value)
                                        logEntriesByActionItem.ModificationDate = Convert.ToDateTime(reader["ModificationDate"].ToString());
                                    if (reader["IdModifier"] != DBNull.Value)
                                        logEntriesByActionItem.IdModifier = Convert.ToInt32(reader["IdModifier"].ToString());

                                    if (reader["creatorName"] != DBNull.Value)
                                        logEntriesByActionItem.Creator = Convert.ToString(reader["creatorName"].ToString());
                                    if (reader["modifierName"] != DBNull.Value)
                                        logEntriesByActionItem.Modifier = Convert.ToString(reader["modifierName"].ToString());
                                    if (reader["IsRtfText"] != DBNull.Value)
                                        logEntriesByActionItem.IsRtfText = Convert.ToBoolean(reader["IsRtfText"].ToString());
                                    if (reader["IdLogEntryType"] != DBNull.Value)
                                    {
                                        logEntriesByActionItem.IdLogEntryType = Convert.ToInt32(reader["IdLogEntryType"].ToString());
                                    }
                                    if (actionPlanItem.LogEntriesByActionItems != null)
                                        actionPlanItem.LogEntriesByActionItems.Add(logEntriesByActionItem);
                                    else
                                    {
                                        actionPlanItem.LogEntriesByActionItems = new List<LogEntriesByActionItem>();
                                        actionPlanItem.LogEntriesByActionItems.Add(logEntriesByActionItem);
                                    }
                                }

                        }

                    }
                }

            }
            return actionPlanItems;
        }

        public ActionPlanItem GetActionPlanItem_V2043(Int64 IdActionPlanItem, string connectionString)
        {
            ActionPlanItem actionPlanItem = null;
            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("CRM_GetActionPlanItem_V2043", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdActionPlanItem", IdActionPlanItem);

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        actionPlanItem = new ActionPlanItem();

                        if (reader["IdActionPlan"] != DBNull.Value)
                        {
                            actionPlanItem.ActionPlan = new ActionPlan();

                            actionPlanItem.ActionPlan.IdActionPlan = Convert.ToInt64(reader["IdActionPlan"].ToString());

                            if (reader["Code"] != DBNull.Value)
                                actionPlanItem.ActionPlan.Code = Convert.ToString(reader["Code"].ToString());

                            if (reader["IdActionPlanItem"] != DBNull.Value)
                                actionPlanItem.IdActionPlanItem = Convert.ToInt64(reader["IdActionPlanItem"].ToString());

                            if (reader["IdSalesActivityType"] != DBNull.Value)
                            {
                                actionPlanItem.IdSalesActivityType = Convert.ToInt32(reader["IdSalesActivityType"].ToString());

                                actionPlanItem.SalesActivityType = new LookupValue();
                                actionPlanItem.SalesActivityType.IdLookupValue = Convert.ToInt32(reader["IdSalesActivityType"].ToString());
                                actionPlanItem.SalesActivityType.Value = Convert.ToString(reader["SalesActivityType"].ToString());
                            }
                                

                            if (reader["IdScope"] != DBNull.Value)
                            {
                                actionPlanItem.IdScope = Convert.ToInt32(reader["IdScope"].ToString());

                                if (reader["Scope"] != DBNull.Value)
                                    actionPlanItem.Scope = Convert.ToString(reader["Scope"].ToString());
                            }

                            if (reader["Number"] != DBNull.Value)
                                actionPlanItem.Number = Convert.ToInt64(reader["Number"].ToString());

                            if (reader["IdSite"] != DBNull.Value)
                            {
                                actionPlanItem.IdSite = Convert.ToInt32(reader["IdSite"].ToString());

                                if (reader["SiteName"] != DBNull.Value)
                                    actionPlanItem.Plant = Convert.ToString(reader["SiteName"].ToString());
                            }

                            if (reader["IdCustomer"] != DBNull.Value)
                            {
                                actionPlanItem.IdGroup = Convert.ToInt32(reader["IdCustomer"].ToString());

                                if (reader["CustomerName"] != DBNull.Value)
                                    actionPlanItem.Group = Convert.ToString(reader["CustomerName"].ToString());
                            }

                            if (reader["Country"] != DBNull.Value)
                                actionPlanItem.Country = Convert.ToString(reader["Country"].ToString());

                            if (reader["Title"] != DBNull.Value)
                                actionPlanItem.Title = Convert.ToString(reader["Title"].ToString());

                            if (reader["OpenDate"] != DBNull.Value)
                                actionPlanItem.OpenDate = Convert.ToDateTime(reader["OpenDate"].ToString());

                            if (reader["ExpectedDueDate"] != DBNull.Value)
                                actionPlanItem.ExpectedDueDate = Convert.ToDateTime(reader["ExpectedDueDate"].ToString());

                            if (reader["CurrentDueDate"] != DBNull.Value)
                                actionPlanItem.CurrentDueDate = Convert.ToDateTime(reader["CurrentDueDate"].ToString());

                            if (reader["DueDateChangeCount"] != DBNull.Value)
                                actionPlanItem.DueDateChangeCount = Convert.ToInt64(reader["DueDateChangeCount"].ToString());

                            if (reader["CloseDate"] != DBNull.Value)
                                actionPlanItem.CloseDate = Convert.ToDateTime(reader["CloseDate"].ToString());

                            if (reader["IdReporter"] != DBNull.Value)
                            {
                                actionPlanItem.IdReporter = Convert.ToInt32(reader["IdReporter"].ToString());

                                if (reader["Reporter"] != DBNull.Value)
                                    actionPlanItem.Reporter = Convert.ToString(reader["Reporter"].ToString());
                            }

                            if (reader["IdAssignee"] != DBNull.Value)
                            {
                                actionPlanItem.IdAssignee = Convert.ToInt32(reader["IdAssignee"].ToString());

                                if (reader["Assignee"] != DBNull.Value)
                                    actionPlanItem.Assignee = Convert.ToString(reader["Assignee"].ToString());
                            }

                            if (reader["APICreationDate"] != DBNull.Value)
                                actionPlanItem.CreationDate = Convert.ToDateTime(reader["APICreationDate"].ToString());

                            if (reader["APIModificationDate"] != DBNull.Value)
                                actionPlanItem.ModificationDate = Convert.ToDateTime(reader["APIModificationDate"].ToString());


                            if (reader["IdStatus"] != DBNull.Value)
                            {
                                actionPlanItem.Status = new LookupValue();
                                actionPlanItem.IdStatus = Convert.ToInt32(reader["IdStatus"]);
                                actionPlanItem.Status.IdLookupValue = actionPlanItem.IdStatus;
                                actionPlanItem.Status.Value = Convert.ToString(reader["Status"].ToString());

                                //if (reader["HtmlColor"] != DBNull.Value)
                                //    actionPlanItem.Status.HtmlColor = Convert.ToString(reader["HtmlColor"]);
                            }

                            actionPlanItem.ActionPlan.Code = string.Format("{0} - {1}", actionPlanItem.ActionPlan.Code, actionPlanItem.Number);
                        }
                    }
                }

            }

            actionPlanItem.LogEntriesByActionItems = GetActionPlanItemLogEntries(IdActionPlanItem, connectionString);


            return actionPlanItem;
        }

        public ActionPlanItem AddActionPlanItem_V2043(ActionPlanItem actionPlanItem, string mainServerConnectionString)
        {
            bool isInserted = false;
            TransactionScope transactionScope = null;

            using (transactionScope = new System.Transactions.TransactionScope())
            {
                try
                {
                    if (actionPlanItem.TransactionOperation == ModelBase.TransactionOperations.Add)
                    {
                        actionPlanItem.Number = GetMaxNumberInScope(actionPlanItem.IdScope, mainServerConnectionString);
                        using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                        {
                            conn.Open();

                            try
                            {
                                MySqlCommand conCommand = new MySqlCommand("CRM_AddActionPlanItem_V2043", conn);
                                conCommand.CommandType = CommandType.StoredProcedure;
                                conCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanItem.IdActionPlan);
                                conCommand.Parameters.AddWithValue("_IdScope", actionPlanItem.IdScope);
                                conCommand.Parameters.AddWithValue("_Number", actionPlanItem.Number);
                                conCommand.Parameters.AddWithValue("_IdSite", actionPlanItem.IdSite);
                                conCommand.Parameters.AddWithValue("_Title", actionPlanItem.Title);
                                // conCommand.Parameters.AddWithValue("_Action", item.Action);
                                conCommand.Parameters.AddWithValue("_OpenDate", actionPlanItem.OpenDate);
                                conCommand.Parameters.AddWithValue("_ExpectedDueDate", actionPlanItem.ExpectedDueDate);
                                conCommand.Parameters.AddWithValue("_CurrentDueDate", actionPlanItem.CurrentDueDate);
                                conCommand.Parameters.AddWithValue("_DueDateChangeCount", actionPlanItem.DueDateChangeCount);
                                conCommand.Parameters.AddWithValue("_CloseDate", actionPlanItem.CloseDate);
                                // conCommand.Parameters.AddWithValue("_IdSource", item.IdSource);
                                conCommand.Parameters.AddWithValue("_IdReporter", actionPlanItem.IdReporter);
                                conCommand.Parameters.AddWithValue("_IdAssignee", actionPlanItem.IdAssignee);
                                conCommand.Parameters.AddWithValue("_IdStatus", actionPlanItem.IdStatus);
                                conCommand.Parameters.AddWithValue("_CreationDate", DateTime.Now);
                                conCommand.Parameters.AddWithValue("_IdCreator", actionPlanItem.IdCreator);
                                conCommand.Parameters.AddWithValue("_IdSalesActivityType", actionPlanItem.IdSalesActivityType);

                                actionPlanItem.IdActionPlanItem = Convert.ToInt32(conCommand.ExecuteScalar());

                                if (actionPlanItem.IdActionPlanItem > 0)
                                {
                                    isInserted = true;
                                }

                                conn.Close();
                            }
                            catch (Exception ex)
                            {
                                throw;
                            }
                        }
                    }

                    if (actionPlanItem.IdActionPlanItem > 0)
                    {
                        AddUpdateDeleteLogEntriesByActionItem(actionPlanItem.IdActionPlanItem, actionPlanItem.LogEntriesByActionItems, mainServerConnectionString);
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    isInserted = false;
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }

            }
            return actionPlanItem;
        }

        public bool UpdateActionPlanItem_V2043(ActionPlanItem actionPlanItem, string mainServerConnectionString)
        {
            bool isInserted = false;
            TransactionScope transactionScope = null;

            using (transactionScope = new System.Transactions.TransactionScope())
            {

                try
                {
                    if (actionPlanItem.TransactionOperation == ModelBase.TransactionOperations.Update)
                    {
                        using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                        {
                            conn.Open();

                            try
                            {
                                MySqlCommand conCommand = new MySqlCommand("CRM_UpdateActionPlanItem_V2043", conn);
                                conCommand.CommandType = CommandType.StoredProcedure;
                                conCommand.Parameters.AddWithValue("_IdActionPlanItem", actionPlanItem.IdActionPlanItem);
                                conCommand.Parameters.AddWithValue("_IdActionPlan", actionPlanItem.IdActionPlan);
                                conCommand.Parameters.AddWithValue("_IdScope", actionPlanItem.IdScope);
                                conCommand.Parameters.AddWithValue("_Number", actionPlanItem.Number);
                                conCommand.Parameters.AddWithValue("_IdSite", actionPlanItem.IdSite);
                                conCommand.Parameters.AddWithValue("_Title", actionPlanItem.Title);
                                //conCommand.Parameters.AddWithValue("_Action", item.Action);
                                conCommand.Parameters.AddWithValue("_OpenDate", actionPlanItem.OpenDate);
                                conCommand.Parameters.AddWithValue("_ExpectedDueDate", actionPlanItem.ExpectedDueDate);
                                conCommand.Parameters.AddWithValue("_CurrentDueDate", actionPlanItem.CurrentDueDate);
                                conCommand.Parameters.AddWithValue("_DueDateChangeCount", actionPlanItem.DueDateChangeCount);
                                conCommand.Parameters.AddWithValue("_CloseDate", actionPlanItem.CloseDate);
                                //conCommand.Parameters.AddWithValue("_IdSource", item.IdSource);
                                conCommand.Parameters.AddWithValue("_IdReporter", actionPlanItem.IdReporter);
                                conCommand.Parameters.AddWithValue("_IdAssignee", actionPlanItem.IdAssignee);
                                conCommand.Parameters.AddWithValue("_IdStatus", actionPlanItem.IdStatus);
                                conCommand.Parameters.AddWithValue("_ModificationDate", DateTime.Now);
                                conCommand.Parameters.AddWithValue("_IdModifier", actionPlanItem.IdModifier);
                                conCommand.Parameters.AddWithValue("_IdSalesActivityType", actionPlanItem.IdSalesActivityType);

                                conCommand.ExecuteNonQuery();

                                isInserted = true;

                                conn.Close();
                            }
                            catch (Exception ex)
                            {
                                throw;
                            }
                        }
                    }

                    if (actionPlanItem.IdActionPlanItem > 0)
                    {
                        AddUpdateDeleteLogEntriesByActionItem(actionPlanItem.IdActionPlanItem, actionPlanItem.LogEntriesByActionItems, mainServerConnectionString);
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    isInserted = false;
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }

            }
            return isInserted;
        }

        public bool UpdateActionPlanItemForGrid(ActionPlanItem actionPlanItem, string mainServerConnectionString)
        {
            bool isInserted = false;
            TransactionScope transactionScope = null;

            using (transactionScope = new System.Transactions.TransactionScope())
            {

                try
                {
                    if (actionPlanItem.TransactionOperation == ModelBase.TransactionOperations.Update)
                    {
                        using (MySqlConnection conn = new MySqlConnection(mainServerConnectionString))
                        {
                            conn.Open();

                            try
                            {
                                MySqlCommand conCommand = new MySqlCommand("CRM_UpdateActionPlanItemForGrid", conn);
                                conCommand.CommandType = CommandType.StoredProcedure;
                                conCommand.Parameters.AddWithValue("_IdActionPlanItem", actionPlanItem.IdActionPlanItem);
                                conCommand.Parameters.AddWithValue("_Title", actionPlanItem.Title);
                                conCommand.Parameters.AddWithValue("_ExpectedDueDate", actionPlanItem.ExpectedDueDate);
                                conCommand.Parameters.AddWithValue("_CurrentDueDate", actionPlanItem.CurrentDueDate);
                                conCommand.Parameters.AddWithValue("_DueDateChangeCount", actionPlanItem.DueDateChangeCount);
                                conCommand.Parameters.AddWithValue("_IdAssignee", actionPlanItem.IdAssignee);
                                conCommand.Parameters.AddWithValue("_IdStatus", actionPlanItem.IdStatus);
                                conCommand.Parameters.AddWithValue("_ModificationDate", DateTime.Now);
                                conCommand.Parameters.AddWithValue("_IdModifier", actionPlanItem.IdModifier);
                                conCommand.ExecuteNonQuery();

                                isInserted = true;

                                conn.Close();
                            }
                            catch (Exception ex)
                            {
                                throw;
                            }
                        }
                    }

                    if (actionPlanItem.IdActionPlanItem > 0)
                    {
                        AddUpdateDeleteLogEntriesByActionItem(actionPlanItem.IdActionPlanItem, actionPlanItem.LogEntriesByActionItems, mainServerConnectionString);
                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    isInserted = false;
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }

            }
            return isInserted;
        }

        public List<ActionPlanItem> GetAppointmentActivities(string connectionString, ActivityParams objActivityParams)
        {

            List<ActionPlanItem> listactionPlanItem = new List<ActionPlanItem>();

            using (MySqlConnection connActivities = new MySqlConnection(connectionString))
            {
                connActivities.Open();

                MySqlCommand activitiesCommand = new MySqlCommand("CRM_GetAppointmentActivities", connActivities);
                activitiesCommand.CommandType = CommandType.StoredProcedure;
                activitiesCommand.Parameters.AddWithValue("_IdAciveUser", objActivityParams.idActiveUser);
                activitiesCommand.Parameters.AddWithValue("_IdOwner", objActivityParams.idOwner);
                activitiesCommand.Parameters.AddWithValue("_IdPermission", objActivityParams.idPermission);
                activitiesCommand.Parameters.AddWithValue("_IdPlant", objActivityParams.idPlant);
                activitiesCommand.Parameters.AddWithValue("_accountingYearFrom", objActivityParams.accountingYearFrom);
                activitiesCommand.Parameters.AddWithValue("_accountingYearTo", objActivityParams.accountingYearTo);

                using (MySqlDataReader reader = activitiesCommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ActionPlanItem actionPlanItem = new ActionPlanItem();

                        if (reader["IdActivity"] != DBNull.Value)
                        {
                            actionPlanItem.IdActionPlanItem = Convert.ToInt64(reader["IdActivity"].ToString());
                            actionPlanItem.ActionPlan = new ActionPlan();
                            actionPlanItem.ActionPlan.Code= Convert.ToString(reader["IdActivity"].ToString());

                        }

                        if (reader["IdScope"] != DBNull.Value)
                        {
                            actionPlanItem.IdScope   = Convert.ToInt32(reader["IdScope"].ToString());
                            actionPlanItem.Scope = Convert.ToString(reader["ScopeName"].ToString());
                        }

                        if (reader["IdType"] != DBNull.Value)
                        {
                            actionPlanItem.IdSalesActivityType = Convert.ToInt32(reader["IdType"].ToString());
                            actionPlanItem.SalesActivityType = new LookupValue();
                            actionPlanItem.SalesActivityType.IdLookupValue = Convert.ToInt32(reader["IdType"].ToString());
                            actionPlanItem.SalesActivityType.Value = Convert.ToString(reader["TypeName"].ToString());
                            actionPlanItem.SalesActivityType.HtmlColor = Convert.ToString(reader["TypeHtmlColor"].ToString());
                        }

                       
                        if (reader["Subject"] != DBNull.Value)
                            actionPlanItem.Title = Convert.ToString(reader["Subject"].ToString());
                        if (reader["Responsible"] != DBNull.Value)
                            actionPlanItem.Assignee = Convert.ToString(reader["Responsible"].ToString());
                        if (reader["Reporter"] != DBNull.Value)
                            actionPlanItem.Reporter = Convert.ToString(reader["Reporter"].ToString());
                       
                        if (reader["CreationDate"] != DBNull.Value)
                            actionPlanItem.CreationDate = Convert.ToDateTime(reader["CreationDate"].ToString());

                        if (reader["DueDate"] != DBNull.Value)
                            actionPlanItem.CurrentDueDate = Convert.ToDateTime(reader["DueDate"].ToString());

                        if (reader["CloseDate"] != DBNull.Value)
                            actionPlanItem.CloseDate = Convert.ToDateTime(reader["CloseDate"].ToString());

                        if (reader["ReviewDate"] != DBNull.Value)
                            actionPlanItem.ModificationDate = Convert.ToDateTime(reader["ReviewDate"].ToString());

                        if (reader["IdActivityStatus"] != DBNull.Value)
                        {
                            actionPlanItem.Status = new LookupValue();
                            actionPlanItem.IdStatus = Convert.ToInt32(reader["IdActivityStatus"]);
                            actionPlanItem.Status.IdLookupValue = actionPlanItem.IdStatus;
                            actionPlanItem.Status.Value = Convert.ToString(reader["ActivityStatus"].ToString());

                            if (reader["ActivityStatusHtmlColor"] != DBNull.Value)
                                actionPlanItem.Status.HtmlColor = Convert.ToString(reader["ActivityStatusHtmlColor"]);
                        }

                        listactionPlanItem.Add(actionPlanItem);
                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {
                            if (reader["IdActivity"] != DBNull.Value)
                            {
                                ActionPlanItem actionPlanItem = listactionPlanItem.Where(i => i.IdActionPlanItem == Convert.ToInt64(reader["IdActivity"].ToString())).FirstOrDefault();
                               
                                if (reader["Group"] != DBNull.Value)
                                    actionPlanItem.Group = Convert.ToString(reader["Group"].ToString());

                                if (reader["Plant"] != DBNull.Value)
                                    actionPlanItem.Plant = Convert.ToString(reader["Plant"].ToString());

                                if (reader["CountryName"] != DBNull.Value)
                                    actionPlanItem.Country = Convert.ToString(reader["CountryName"].ToString());

                            }
                        }
                    }

                    if (reader.NextResult())
                {
                    while (reader.Read())
                    {


                        if (reader["IdActivity"] != DBNull.Value)
                            if (listactionPlanItem.Any(ap => ap.IdActionPlanItem == Convert.ToInt64(reader["IdActivity"].ToString())))
                            {
                                ActionPlanItem actionPlanItem = listactionPlanItem.Where(ap => ap.IdActionPlanItem == Convert.ToInt64(reader["IdActivity"].ToString())).FirstOrDefault();

                                LogEntriesByActionItem logEntriesByActionItem = new LogEntriesByActionItem();

                                if (reader["IdLogEntryByActivity"] != DBNull.Value)
                                    logEntriesByActionItem.IdLogEntryByActionItem = Convert.ToInt64(reader["IdLogEntryByActivity"].ToString());

                                if (reader["IdActivity"] != DBNull.Value)
                                    logEntriesByActionItem.IdActionPlanItem = Convert.ToInt64(reader["IdActivity"].ToString());
                                if (reader["Comments"] != DBNull.Value)
                                    logEntriesByActionItem.Comment = Convert.ToString(reader["Comments"].ToString());
                                if (reader["Datetime"] != DBNull.Value)
                                    logEntriesByActionItem.CreationDate = Convert.ToDateTime(reader["Datetime"].ToString());
                                if (reader["IdUser"] != DBNull.Value)
                                    logEntriesByActionItem.IdCreator = Convert.ToInt32(reader["IdUser"].ToString());
                                if (reader["Datetime"] != DBNull.Value)
                                    logEntriesByActionItem.ModificationDate = Convert.ToDateTime(reader["Datetime"].ToString());
                                if (reader["IdUser"] != DBNull.Value)
                                    logEntriesByActionItem.IdModifier = Convert.ToInt32(reader["IdUser"].ToString());

                                if (reader["UserName"] != DBNull.Value)
                                    logEntriesByActionItem.Creator = Convert.ToString(reader["UserName"].ToString());
                                if (reader["UserName"] != DBNull.Value)
                                    logEntriesByActionItem.Modifier = Convert.ToString(reader["UserName"].ToString());
                                if (reader["IsRtfText"] != DBNull.Value)
                                    logEntriesByActionItem.IsRtfText = Convert.ToBoolean(reader["IsRtfText"].ToString());
                                if (reader["IdLogEntryType"] != DBNull.Value)
                                {
                                    logEntriesByActionItem.IdLogEntryType = Convert.ToInt32(reader["IdLogEntryType"].ToString());
                                }
                                if (actionPlanItem.LogEntriesByActionItems != null)
                                    actionPlanItem.LogEntriesByActionItems.Add(logEntriesByActionItem);
                                else
                                {
                                    actionPlanItem.LogEntriesByActionItems = new List<LogEntriesByActionItem>();
                                    actionPlanItem.LogEntriesByActionItems.Add(logEntriesByActionItem);
                                }
                            }

                    }

                }
            }
        }

            return listactionPlanItem;
        }

        public Company AddCompany_V2043(Company company, string mainServerConnectionString, string crmConnectionString, Company emdepSite = null)
        {
            //Int32 companyId = 0;
            bool IsAccountExists = false;

            string sitename = company.Name + " (" + company.Country.Name + ")";
            sitename = sitename.ToString().Replace("'", "\"");

            using (TransactionScope transactionScope = new System.Transactions.TransactionScope())
            {
                try
                {
                    using (MySqlConnection connExistSite = new MySqlConnection(mainServerConnectionString))
                    {
                        connExistSite.Open();

                        MySqlCommand conoffercommand = new MySqlCommand("sites_GetSiteNameCustomerIdExist", connExistSite);
                        conoffercommand.CommandType = CommandType.StoredProcedure;
                        conoffercommand.Parameters.AddWithValue("_SiteName", sitename);
                        conoffercommand.Parameters.AddWithValue("_IdCustomer", company.IdCustomer);

                        using (MySqlDataReader siteReader = conoffercommand.ExecuteReader())
                        {
                            if (siteReader.Read())
                            {
                                company.IdCompany = -1;
                                IsAccountExists = true;
                            }
                        }

                        connExistSite.Close();
                    }

                    if (!IsAccountExists)
                    {
                        using (MySqlConnection connCompany = new MySqlConnection(mainServerConnectionString))
                        {
                            connCompany.Open();

                            //MySqlCommand concompanycommand = new MySqlCommand("sites_Insert", connCompany);

                            using (MySqlCommand concompanycommand = new MySqlCommand("sites_Insert_V2043", connCompany))
                            {
                                concompanycommand.CommandType = CommandType.StoredProcedure;
                                concompanycommand.Parameters.AddWithValue("_IdCustomer", company.IdCustomer);
                                concompanycommand.Parameters.AddWithValue("_Name", company.Name);
                                concompanycommand.Parameters.AddWithValue("_IdCountry", company.IdCountry);
                                concompanycommand.Parameters.AddWithValue("_Address", company.Address);
                                concompanycommand.Parameters.AddWithValue("_Telephone", company.Telephone);
                                concompanycommand.Parameters.AddWithValue("_Email", company.Email);
                                concompanycommand.Parameters.AddWithValue("_Region", company.Region);
                                concompanycommand.Parameters.AddWithValue("_Fax", company.Fax);
                                concompanycommand.Parameters.AddWithValue("_IdBusinessCenter", company.IdBusinessCenter);
                                concompanycommand.Parameters.AddWithValue("_IdBusinessField", company.IdBusinessField);
                                concompanycommand.Parameters.AddWithValue("_Size", company.Size);
                                concompanycommand.Parameters.AddWithValue("_CuttingMachines", company.CuttingMachines);
                                concompanycommand.Parameters.AddWithValue("_NumberOfEmployees", company.NumberOfEmployees);
                                concompanycommand.Parameters.AddWithValue("_Line", company.Line);
                                concompanycommand.Parameters.AddWithValue("_Website", company.Website);
                                concompanycommand.Parameters.AddWithValue("_City", company.City);
                                concompanycommand.Parameters.AddWithValue("_PostCode", company.ZipCode);
                                concompanycommand.Parameters.AddWithValue("_CreatedBy", company.CreatedBy);
                                concompanycommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                                concompanycommand.Parameters.AddWithValue("_IdBusinessType", company.IdBusinessType);
                                concompanycommand.Parameters.AddWithValue("_Latitude", company.Latitude);
                                concompanycommand.Parameters.AddWithValue("_Longitude", company.Longitude);
                                concompanycommand.Parameters.AddWithValue("_ShortName", company.ShortName);
                                concompanycommand.Parameters.AddWithValue("_IdSalesResponsible", company.IdSalesResponsible);
                                concompanycommand.Parameters.AddWithValue("_IdSalesResponsibleAssemblyBU", company.IdSalesResponsibleAssemblyBU);
                                concompanycommand.Parameters.AddWithValue("_RegisteredName", company.RegisteredName);
                                company.IdCompany = Convert.ToInt32(concompanycommand.ExecuteScalar());
                            }

                            //[CRM-M024-15] Add default emdep plant when creating a new account.
                            if (emdepSite != null)
                            {
                                using (MySqlCommand concompanycommand = new MySqlCommand("sites_CustomerSitesByEmdepSiteInsert", connCompany))
                                {
                                    concompanycommand.CommandType = CommandType.StoredProcedure;
                                    concompanycommand.Parameters.AddWithValue("_IdCustomerSite", company.IdCompany);
                                    concompanycommand.Parameters.AddWithValue("_IdEmdepSite", emdepSite.IdCompany);
                                    concompanycommand.Parameters.AddWithValue("_AccountingCode", null);
                                    concompanycommand.ExecuteNonQuery();
                                }
                            }

                            connCompany.Close();
                        }

                        if (company.IdCompany > 0)
                        {
                            AddSiteByBusinessProduct(company, mainServerConnectionString);
                            AddLogEntryBySite(company, mainServerConnectionString);
                            AddSitesByCpType(company.IdCustomer, company.IdCountry, company.IdCompany, mainServerConnectionString);
                        }

                        transactionScope.Complete();
                    }
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return company;
        }

        public void AddSitesByCpType(Int32 idCustomer,byte? idCountry,Int32 idSite, string connectionstring)
        {
            try
            {
                using (MySqlConnection con = new MySqlConnection(connectionstring))
                {
                    con.Open();
                    MySqlCommand concommand = new MySqlCommand("CRM_InsertSitesByCpType", con);
                    concommand.CommandType = CommandType.StoredProcedure;

                    concommand.Parameters.AddWithValue("_IdCustomer", idCustomer);
                    concommand.Parameters.AddWithValue("_IdCountry", idCountry);
                    concommand.Parameters.AddWithValue("_IdSite", idSite);
                     concommand.ExecuteNonQuery();
                   
                }
            }
            catch (Exception ex)
            {
                throw;
            }
        }

        public Company UpdateCompany_V2043(Company company, string mainconnectionstring, string crmconnectionstring)
        {
            Company addedcompany = new Company();
            company.IsUpdate = false;
            company.IsExist = false;
            try
            {
                using (MySqlConnection conoffer = new MySqlConnection(mainconnectionstring))
                {
                    conoffer.Open();
                    //string query = "select IdSite,Name,IdCustomer,IdCountry from sites where IdSite=" + company.IdCompany + ";";
                    MySqlCommand conoffercommand = new MySqlCommand("sites_GetSitesById", conoffer);
                    conoffercommand.CommandType = CommandType.StoredProcedure;
                    conoffercommand.Parameters.AddWithValue("_IdSite", company.IdCompany);

                    using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                    {
                        if (offerreader.Read())
                        {
                            addedcompany.IdCompany = Convert.ToInt32(offerreader["IdSite"].ToString());
                            addedcompany.IdCustomer = Convert.ToInt32(offerreader["IdCustomer"].ToString());
                            addedcompany.IdCountry = Convert.ToByte(offerreader["IdCountry"].ToString());
                            addedcompany.Name = offerreader["Name"].ToString();
                        }
                    }
                }
                string sitename = company.Name.Trim() + " (" + company.Country.Name + ")";
                sitename = sitename.ToString().Replace("'", "\"");
                if (addedcompany.Name.ToUpper() == sitename.ToUpper())
                {
                    if (addedcompany.IdCustomer == company.IdCustomer)
                    {
                        company = updateCompany_V2043(company, mainconnectionstring, crmconnectionstring);
                    }
                    else
                    {
                        using (MySqlConnection conoffer = new MySqlConnection(mainconnectionstring))
                        {
                            conoffer.Open();
                            //string query = "select * from sites where name='" + sitename + "' and IdCustomer=" + company.IdCustomer + " ;";
                            //MySqlCommand conoffercommand = new MySqlCommand(query, conoffer);
                            //conoffercommand.Connection = conoffer;
                            MySqlCommand conoffercommand = new MySqlCommand("sites_GetSiteNameCustomerIdExist", conoffer);
                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_SiteName", sitename);
                            conoffercommand.Parameters.AddWithValue("_IdCustomer", company.IdCustomer);
                            using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                            {
                                if (offerreader.Read())
                                {
                                    company.IsExist = true;

                                }
                                else
                                {
                                    company = updateCompany_V2043(company, mainconnectionstring, crmconnectionstring);
                                }
                            }
                        }
                    }
                }
                else
                {
                    using (MySqlConnection conoffer = new MySqlConnection(mainconnectionstring))
                    {
                        conoffer.Open();
                        MySqlCommand conoffercommand = new MySqlCommand("sites_GetSiteNameCustomerIdExist", conoffer);
                        conoffercommand.CommandType = CommandType.StoredProcedure;
                        conoffercommand.Parameters.AddWithValue("_SiteName", sitename);
                        conoffercommand.Parameters.AddWithValue("_IdCustomer", company.IdCustomer);

                        using (MySqlDataReader offerreader = conoffercommand.ExecuteReader())
                        {
                            if (offerreader.Read())
                            {
                                company.IsExist = true;

                            }
                            else
                            {
                                company = updateCompany_V2043(company, mainconnectionstring, crmconnectionstring);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw;

            }
            return company;
        }


        private Company updateCompany_V2043(Company company, string mainServerConnectionString, string crmConnectionString)
        {
            company.IsUpdate = false;

            using (TransactionScope transactionScope = new TransactionScope())
            {
                try
                {
                    using (MySqlConnection concompany = new MySqlConnection(mainServerConnectionString))
                    {
                        concompany.Open();

                        MySqlCommand concompanycommand = new MySqlCommand("sites_Update_V2043", concompany);
                        concompanycommand.CommandType = CommandType.StoredProcedure;
                        concompanycommand.Parameters.AddWithValue("_IdSite", company.IdCompany);
                        concompanycommand.Parameters.AddWithValue("_IdCustomer", company.IdCustomer);
                        concompanycommand.Parameters.AddWithValue("_Name", company.Name);
                        concompanycommand.Parameters.AddWithValue("_IdCountry", company.IdCountry);
                        concompanycommand.Parameters.AddWithValue("_Address", company.Address);
                        concompanycommand.Parameters.AddWithValue("_Telephone", company.Telephone);
                        concompanycommand.Parameters.AddWithValue("_Email", company.Email);
                        concompanycommand.Parameters.AddWithValue("_Region", company.Region);
                        concompanycommand.Parameters.AddWithValue("_Fax", company.Fax);
                        concompanycommand.Parameters.AddWithValue("_IdBusinessCenter", company.IdBusinessCenter);
                        concompanycommand.Parameters.AddWithValue("_IdBusinessField", company.IdBusinessField);
                        concompanycommand.Parameters.AddWithValue("_Size", company.Size);
                        concompanycommand.Parameters.AddWithValue("_CuttingMachines", company.CuttingMachines);
                        concompanycommand.Parameters.AddWithValue("_NumberOfEmployee", company.NumberOfEmployees);
                        concompanycommand.Parameters.AddWithValue("_Line", company.Line);
                        concompanycommand.Parameters.AddWithValue("_Website", company.Website);
                        concompanycommand.Parameters.AddWithValue("_City", company.City);
                        concompanycommand.Parameters.AddWithValue("_PostCode", company.ZipCode);
                        concompanycommand.Parameters.AddWithValue("_ModifiedBy", company.ModifiedBy);
                        concompanycommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                        concompanycommand.Parameters.AddWithValue("_IdBusinessType", company.IdBusinessType);
                        concompanycommand.Parameters.AddWithValue("_Latitude", company.Latitude);
                        concompanycommand.Parameters.AddWithValue("_Longitude", company.Longitude);
                        concompanycommand.Parameters.AddWithValue("_ShortName", company.ShortName);
                        concompanycommand.Parameters.AddWithValue("_IdSalesResponsible", company.IdSalesResponsible);
                        concompanycommand.Parameters.AddWithValue("_IdSalesResponsibleAssemblyBU", company.IdSalesResponsibleAssemblyBU);
                        concompanycommand.Parameters.AddWithValue("_RegisteredName", company.RegisteredName);

                        concompanycommand.ExecuteNonQuery();
                        company.IsUpdate = true;
                    }

                    if (company.IsUpdate)
                    {
                        AddSiteByBusinessProduct(company, mainServerConnectionString);
                        AddLogEntryBySite(company, mainServerConnectionString);
                    }

                    transactionScope.Complete();
                }
                catch (Exception ex)
                {
                    if (Transaction.Current != null)
                        Transaction.Current.Rollback();

                    if (transactionScope != null)
                        transactionScope.Dispose();

                    throw;
                }
            }

            return company;


          
        }

        public List<SalesUser> GetAllSalesUserQuotaPeopleDetails_V2045(byte idCurrency, string connectionString, string connectionWorkbenchString, Int32 accountingFromYear, Int32 accountingToYear)
        {
            List<SalesUser> salesUsers = new List<SalesUser>();
            DataTable dtsalesUser = new DataTable();
            using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionString))
            {
                conofferwithoutpurchaseorder.Open();
                MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("CRM_GetAllSalesUserQuotaPeopleDetails_V2045", conofferwithoutpurchaseorder);
                conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_idcurrency", idCurrency);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingFromYear", accountingFromYear);
                conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_accountingToYear", accountingToYear);
                MySqlDataAdapter da = new MySqlDataAdapter(conofferwithoutpurchaseordercommand);

                da.Fill(dtsalesUser);
            }
            foreach (DataRow itemRow in dtsalesUser.Rows)
            {
                if (!salesUsers.Any(su => su.IdSalesUser == Convert.ToInt32(itemRow["IdSalesUser"].ToString())))
                {
                    SalesUser salesUser = new SalesUser();
                    if (itemRow["IdSalesTeam"] != DBNull.Value)
                        salesUser.IdSalesTeam = Convert.ToInt32(itemRow["IdSalesTeam"].ToString());

                    if (itemRow["IdSalesUser"] != DBNull.Value)
                        salesUser.IdSalesUser = Convert.ToInt32(itemRow["IdSalesUser"].ToString());

                    //if (itemRow["IdSalesQuotaCurrency"] != DBNull.Value)
                    //    salesUser.IdSalesQuotaCurrency = Convert.ToByte(itemRow["IdSalesQuotaCurrency"].ToString());

                    //if (itemRow["SalesQuotaAmount"] != DBNull.Value)
                    //    salesUser.SalesQuotaAmount = Convert.ToDouble(itemRow["SalesQuotaAmount"].ToString());

                    //if (itemRow["ExchangeRateDate"] != DBNull.Value)
                    //    salesUser.ExchangeRateDate = Convert.ToDateTime(itemRow["ExchangeRateDate"].ToString());

                    if (itemRow["IdSalesPlant"] != DBNull.Value)
                    {
                        salesUser.IdSalesPlant = Convert.ToInt32(itemRow["IdSalesPlant"].ToString());
                        salesUser.Company = new Company();
                        salesUser.Company.IdCompany = Convert.ToInt32(itemRow["IdSalesPlant"].ToString());
                        salesUser.Company.ShortName = itemRow["Plant"].ToString();
                    }

                    salesUser.LookupValue = new LookupValue();
                    salesUser.LookupValue.IdLookupValue = Convert.ToInt32(itemRow["IdSalesTeam"].ToString());
                    salesUser.LookupValue.Value = itemRow["TeamUser"].ToString();
                    if (itemRow["IdPerson"] != DBNull.Value)
                    {
                        salesUser.People = new People();
                        salesUser.People.IdPerson = Convert.ToInt32(itemRow["IdPerson"].ToString());
                        salesUser.People.Name = itemRow["Name"].ToString();
                        salesUser.People.Surname = itemRow["Surname"].ToString();
                        salesUser.People.Email = itemRow["Email"].ToString();
                        salesUser.People.IsStillActive = Convert.ToByte(itemRow["IsStillActive"]);
                        salesUser.People.Phone = itemRow["Phone"].ToString();
                        if (itemRow["IdPersonGender"] != DBNull.Value)
                        {
                            salesUser.People.IdPersonGender = Convert.ToByte(itemRow["IdPersonGender"].ToString());
                            if (salesUser.People.IdPersonGender == 1)
                                salesUser.People.UserGender = "Female";
                            else if (salesUser.People.IdPersonGender == 2)
                                salesUser.People.UserGender = "Male";
                        }
                        salesUser.People.Company = new Company();
                        salesUser.People.Company.IdCompany = Convert.ToInt32(itemRow["IdSite"].ToString());
                        salesUser.People.Company.ShortName = itemRow["Office"].ToString();
                        salesUser.People.Company.Country = new Country();
                        salesUser.People.Company.Country.IdCountry = Convert.ToByte(itemRow["IdCountry"].ToString());
                        salesUser.People.Company.Country.Name = itemRow["Country"].ToString();
                        salesUser.People.Company.Country.Zone = new Zone();
                        salesUser.People.Company.Country.Zone.IdZone = Convert.ToInt32(itemRow["IdZone"].ToString());
                        salesUser.People.Company.Country.Zone.Name = itemRow["Region"].ToString();
                    }

                    salesUser.SalesUserQuotas = new List<SalesUserQuota>();
                    SalesUserQuota salesUserQuota = new SalesUserQuota();

                    if (itemRow["IdSalesUser"] != DBNull.Value)
                        salesUserQuota.IdSalesUser = Convert.ToInt32(itemRow["IdSalesUser"].ToString());
                   

                    if (itemRow["IdSalesQuotaCurrency"] != DBNull.Value)
                        salesUserQuota.IdSalesQuotaCurrency = Convert.ToByte(itemRow["IdSalesQuotaCurrency"].ToString());
                   

                    if (itemRow["SalesQuotaAmount"] != DBNull.Value)
                        salesUserQuota.SalesQuotaAmount = Convert.ToDouble(itemRow["SalesQuotaAmount"].ToString());
                   

                    if (itemRow["SalesQuotaAmountWithExchangeRate"] != DBNull.Value)
                        salesUserQuota.SalesQuotaAmountWithExchangeRate = Convert.ToDouble(itemRow["SalesQuotaAmountWithExchangeRate"].ToString());
                   

                    if (itemRow["ExchangeRateDate"] != DBNull.Value)
                        salesUserQuota.ExchangeRateDate = Convert.ToDateTime(itemRow["ExchangeRateDate"].ToString());
                    

                    if (itemRow["Year"] != DBNull.Value)
                        salesUserQuota.Year = Convert.ToInt32(itemRow["Year"].ToString());
                   

                       salesUser.SalesUserQuotas.Add(salesUserQuota);

                    salesUser.UserPermission = new List<UserPermission>();
                    if (itemRow["IdSalesUser"] != DBNull.Value)
                    {
                        using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionWorkbenchString))
                        {
                            conofferwithoutpurchaseorder.Open();
                            //MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("select up.IdUser, up.IdPermission,p.PermissionName from user_permissions up inner join permissions p on up.IdPermission=p.IdPermission where IdUser = " + salesUser.IdSalesUser + "  group by up.IdUser, up.IdPermission;", conofferwithoutpurchaseorder);
                            //conofferwithoutpurchaseordercommand.CommandType = CommandType.Text;

                            MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("users_GetUserPermission", conofferwithoutpurchaseorder);
                            conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                            conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_IdUser", salesUser.IdSalesUser);
                            using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                            {
                                while (offerreader.Read())
                                {
                                    UserPermission userPermission = new UserPermission();
                                    if (offerreader["IdUser"] != DBNull.Value)
                                        userPermission.IdUser = Convert.ToInt32(offerreader["IdUser"].ToString());
                                    if (offerreader["IdPermission"] != DBNull.Value)
                                    {
                                        userPermission.IdPermission = Convert.ToInt32(offerreader["IdPermission"].ToString());
                                        userPermission.Permission = new Permission();
                                        userPermission.Permission.IdPermission = Convert.ToInt32(offerreader["IdPermission"].ToString());
                                        userPermission.Permission.PermissionName = offerreader["PermissionName"].ToString();
                                    }
                                    salesUser.UserPermission.Add(userPermission);
                                }
                            }
                        }
                    }
                    salesUser.SiteUserPermission = new List<SiteUserPermission>();
                    if (itemRow["IdSalesUser"] != DBNull.Value)
                    {
                        using (MySqlConnection conofferwithoutpurchaseorder = new MySqlConnection(connectionWorkbenchString))
                        {
                            conofferwithoutpurchaseorder.Open();
                            MySqlCommand conofferwithoutpurchaseordercommand = new MySqlCommand("users_GetSiteUserPermission", conofferwithoutpurchaseorder);
                            conofferwithoutpurchaseordercommand.CommandType = CommandType.StoredProcedure;
                            conofferwithoutpurchaseordercommand.Parameters.AddWithValue("_IdUser", salesUser.IdSalesUser);
                            using (MySqlDataReader offerreader = conofferwithoutpurchaseordercommand.ExecuteReader())
                            {
                                while (offerreader.Read())
                                {
                                    SiteUserPermission siteUserPermission = new SiteUserPermission();
                                    if (offerreader["IdUser"] != DBNull.Value)
                                        siteUserPermission.IdUser = Convert.ToInt32(offerreader["IdUser"].ToString());
                                    if (offerreader["IdCompany"] != DBNull.Value)
                                    {
                                        siteUserPermission.IdCompany = Convert.ToInt32(offerreader["IdCompany"].ToString());
                                        siteUserPermission.Company = new Company();
                                        siteUserPermission.Company.IdCompany = Convert.ToInt32(offerreader["IdCompany"].ToString());
                                        siteUserPermission.Company.ShortName = offerreader["ShortName"].ToString();
                                    }
                                    salesUser.SiteUserPermission.Add(siteUserPermission);
                                }
                            }
                        }
                    }
                    salesUsers.Add(salesUser);
                }
                else
                {
                    SalesUser salesUser = salesUsers.Where(i => i.IdSalesUser == Convert.ToInt32(itemRow["IdSalesUser"].ToString())).FirstOrDefault();
                    if (salesUser != null)
                    {
                        SalesUserQuota salesUserQuota = new SalesUserQuota();

                        if (itemRow["IdSalesUser"] != DBNull.Value)
                            salesUserQuota.IdSalesUser = Convert.ToInt32(itemRow["IdSalesUser"].ToString());

                        if (itemRow["IdSalesQuotaCurrency"] != DBNull.Value)
                            salesUserQuota.IdSalesQuotaCurrency = Convert.ToByte(itemRow["IdSalesQuotaCurrency"].ToString());

                        if (itemRow["SalesQuotaAmount"] != DBNull.Value)
                            salesUserQuota.SalesQuotaAmount = Convert.ToDouble(itemRow["SalesQuotaAmount"].ToString());

                        if (itemRow["SalesQuotaAmountWithExchangeRate"] != DBNull.Value)
                            salesUserQuota.SalesQuotaAmountWithExchangeRate = Convert.ToDouble(itemRow["SalesQuotaAmountWithExchangeRate"].ToString());

                        if (itemRow["ExchangeRateDate"] != DBNull.Value)
                            salesUserQuota.ExchangeRateDate = Convert.ToDateTime(itemRow["ExchangeRateDate"].ToString());

                        if (itemRow["Year"] != DBNull.Value)
                            salesUserQuota.Year = Convert.ToInt32(itemRow["Year"].ToString());

                        salesUser.SalesUserQuotas.Add(salesUserQuota);
                    }

                }

            }
            return salesUsers;
        }

        public Offer AddOffer_V2045(Offer offer, string connectionString, string offerCodeConnectionString, Int32 idSite, string commericalPath, string workingOrdersPath, string mainserverConnectionString, bool UseSQLCounter, string dotProjectConnectionString, MailServer mailServer, string workbenchConnectionString)
        {

            Int64 offerId = 0;
            bool offerInsertedInGCM = true;

            if (offer.IdBusinessUnit == 0)
            {
                offer.IdBusinessUnit = null;
            }

            if (offer.IdCarProject == 0)
            {
                offer.IdCarProject = null;
            }

            if (offer.IdSource == 0)
            {
                offer.IdSource = null;
            }

            if (offer.IdCarOEM == 0)
            {
                offer.IdCarOEM = null;
            }

            if (offer.IdSalesOwner == 0)
            {
                offer.IdSalesOwner = null;
            }

            if (offer.OfferedBy == 0)
            {
                offer.OfferedBy = null;
            }

            if (offer.IdOfferType == 1 || offer.IdOfferType == 2 || offer.IdOfferType == 3 || offer.IdOfferType == 4)
            {
                if (offer.IdOfferType == 1 && !UseSQLCounter)    // OT=1 - UseSQLCounter - Next number from geos.counters table.
                    UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);
                else
                    offerInsertedInGCM = InsertOfferToGCM(offer, offerCodeConnectionString, idSite);
            }
            else
                UpdateNextOfferNumberToCounters(offer.IdOfferType, mainserverConnectionString);

            if (offerInsertedInGCM)
            {
                using (MySqlConnection conoffer = new MySqlConnection(connectionString))
                {
                    conoffer.Open();
                    using (MySqlTransaction trans = conoffer.BeginTransaction())
                    {
                        try
                        {
                            // SP:- offers_Insert this sp is used till Sprint58
                            // MySqlCommand conoffercommand = new MySqlCommand("offers_Insert", conoffer);

                            // To Add RFQ changed SP:-offers_Insert_Sprint59 in Sprint59
                            MySqlCommand conoffercommand = new MySqlCommand("CRM_AddOffer_V2037", conoffer);

                            conoffercommand.CommandType = CommandType.StoredProcedure;
                            conoffercommand.Parameters.AddWithValue("_Code", offer.Code);
                            conoffercommand.Parameters.AddWithValue("_IdOfferType", offer.IdOfferType);
                            conoffercommand.Parameters.AddWithValue("_IdCustomer", offer.IdCustomer);
                            conoffercommand.Parameters.AddWithValue("_IdProject", offer.IdProject);
                            conoffercommand.Parameters.AddWithValue("_Description", offer.Description);
                            conoffercommand.Parameters.AddWithValue("_IdStatus", offer.IdStatus);
                            conoffercommand.Parameters.AddWithValue("_Amount", offer.Value);
                            conoffercommand.Parameters.AddWithValue("_ProbabilityOfSuccess", offer.ProbabilityOfSuccess);
                            conoffercommand.Parameters.AddWithValue("_OfferExpectedDate", offer.OfferExpectedDate);
                            conoffercommand.Parameters.AddWithValue("_IdCurrency", offer.IdCurrency);
                            conoffercommand.Parameters.AddWithValue("_Year", DateTime.Now.Year);
                            conoffercommand.Parameters.AddWithValue("_Number", offer.Number);
                            conoffercommand.Parameters.AddWithValue("_CreatedBy", offer.CreatedBy);
                            conoffercommand.Parameters.AddWithValue("_CreatedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_ModifiedBy", offer.ModifiedBy);
                            conoffercommand.Parameters.AddWithValue("_ModifiedIn", DateTime.Now);
                            conoffercommand.Parameters.AddWithValue("_DeliveryDate", offer.DeliveryDate);
                            conoffercommand.Parameters.AddWithValue("_IdBusinessUnit", offer.IdBusinessUnit);
                            conoffercommand.Parameters.AddWithValue("_IdSalesOwner", offer.IdSalesOwner);
                            conoffercommand.Parameters.AddWithValue("_IdCarOEM", offer.IdCarOEM);
                            conoffercommand.Parameters.AddWithValue("_IdSource", offer.IdSource);
                            conoffercommand.Parameters.AddWithValue("_RFQReception", offer.RFQReception);
                            conoffercommand.Parameters.AddWithValue("_SendIn", offer.SendIn);
                            conoffercommand.Parameters.AddWithValue("_IdCarProject", offer.IdCarProject);
                            conoffercommand.Parameters.AddWithValue("_RFQ", offer.Rfq);
                            conoffercommand.Parameters.AddWithValue("_OfferedBy", offer.OfferedBy);
                            conoffercommand.Transaction = trans;

                            offerId = Convert.ToInt64(conoffercommand.ExecuteScalar());
                            offer.IdOffer = offerId;
                            offer.Year = DateTime.Now.Year;

                            UpdateEngAnalysisStatus(dotProjectConnectionString, offer);

                            trans.Commit();
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }

                    }
                }
            }
            if (offerInsertedInGCM && offer.IdOffer > 0)
            {


                offer = AddQuotations_V2041(offer, connectionString, dotProjectConnectionString, mailServer, workbenchConnectionString, workingOrdersPath);
                AddLogEntryByOffer_V2040(offer, connectionString);
                AddOfferContact(offer.OfferContacts, connectionString, offer.IdOffer);
                AddLostReasonsByOffer(offer.LostReasonsByOffer, offer.IdOffer, connectionString);

            }

            return offer;
        }

        public bool AddLostReasonsByOffer(LostReasonsByOffer lostReasonsByOffer, Int64 IdOffer, string connectionstring)
        {
            bool isAdded = false;
            if (lostReasonsByOffer != null)
            {
                using (MySqlConnection conlostReasonsByOffer = new MySqlConnection(connectionstring))
                {
                    conlostReasonsByOffer.Open();
                    using (MySqlTransaction trans = conlostReasonsByOffer.BeginTransaction())
                    {
                        try
                        {
                            MySqlCommand conlostReasonsByOffercommand = new MySqlCommand("lostReasonsByOffer_Insert", conlostReasonsByOffer);
                            conlostReasonsByOffercommand.CommandType = CommandType.StoredProcedure;
                            conlostReasonsByOffercommand.Parameters.AddWithValue("_IdOffer", IdOffer);
                            conlostReasonsByOffercommand.Parameters.AddWithValue("_IdLostReasonList", lostReasonsByOffer.IdLostReasonList);
                            conlostReasonsByOffercommand.Parameters.AddWithValue("_IdCompetitor", lostReasonsByOffer.IdCompetitor);
                            conlostReasonsByOffercommand.Parameters.AddWithValue("_Comments", lostReasonsByOffer.Comments);
                            conlostReasonsByOffercommand.Transaction = trans;
                            conlostReasonsByOffercommand.ExecuteNonQuery();
                            trans.Commit();
                            isAdded = true;
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw;
                        }
                    }
                }
            }
            return isAdded;
        }

        public List<ActionPlanItem> GetSalesActivityRegister_V2051(string idsSelectedUser, string idsSelectedPlant, Int32 idUser, Int32 idPermission, DateTime closedDate, string connectionString)
        {
            List<ActionPlanItem> actionPlanItems = new List<ActionPlanItem>();

            using (MySqlConnection con = new MySqlConnection(connectionString))
            {
                con.Open();
                MySqlCommand concommand = new MySqlCommand("CRM_GetSalesActivityRegister_V2051", con);
                concommand.CommandType = CommandType.StoredProcedure;
                concommand.Parameters.AddWithValue("_IdsSelectedUser", idsSelectedUser);
                concommand.Parameters.AddWithValue("_IdsSelectedPlant", idsSelectedPlant);
                concommand.Parameters.AddWithValue("_IdUser", idUser);
                concommand.Parameters.AddWithValue("_IdPermission", idPermission);
                concommand.Parameters.AddWithValue("_ClosedDate", closedDate);

                using (MySqlDataReader reader = concommand.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        ActionPlanItem actionPlanItem = new ActionPlanItem();
                        actionPlanItem.ActionPlan = new ActionPlan();
                        if (reader["IdActionPlan"] != DBNull.Value)
                        {

                            actionPlanItem.ActionPlan.IdActionPlan = Convert.ToInt64(reader["IdActionPlan"].ToString());
                            if (reader["Code"] != DBNull.Value)
                                actionPlanItem.ActionPlan.Code = Convert.ToString(reader["Code"].ToString());
                            if (reader["Name"] != DBNull.Value)
                                actionPlanItem.ActionPlan.Name = Convert.ToString(reader["Name"].ToString());

                            if (reader["LastMeetingDate"] != DBNull.Value)
                                actionPlanItem.ActionPlan.LastMeetingDate = Convert.ToDateTime(reader["LastMeetingDate"].ToString());
                            if (reader["NextMeetingDate"] != DBNull.Value)
                                actionPlanItem.ActionPlan.NextMeetingDate = Convert.ToDateTime(reader["NextMeetingDate"].ToString());
                            if (reader["CreationDate"] != DBNull.Value)
                                actionPlanItem.ActionPlan.CreationDate = Convert.ToDateTime(reader["CreationDate"].ToString());
                            if (reader["ModificationDate"] != DBNull.Value)
                                actionPlanItem.ActionPlan.ModificationDate = Convert.ToDateTime(reader["ModificationDate"].ToString());

                            if (reader["IdActionPlanItem"] != DBNull.Value)
                                actionPlanItem.IdActionPlanItem = Convert.ToInt64(reader["IdActionPlanItem"].ToString());

                            if (reader["IdSalesActivityType"] != DBNull.Value)
                            {
                                actionPlanItem.IdSalesActivityType = Convert.ToInt32(reader["IdSalesActivityType"].ToString());
                                actionPlanItem.SalesActivityType = new LookupValue();
                                actionPlanItem.SalesActivityType.IdLookupValue = Convert.ToInt32(reader["IdSalesActivityType"].ToString());
                                actionPlanItem.SalesActivityType.Value = Convert.ToString(reader["SalesActivityType"].ToString());
                                actionPlanItem.SalesActivityType.HtmlColor = Convert.ToString(reader["SalesActivityTypeColor"].ToString());
                            }

                            if (reader["IdScope"] != DBNull.Value)
                                actionPlanItem.IdScope = Convert.ToInt32(reader["IdScope"].ToString());
                            if (reader["Number"] != DBNull.Value)
                                actionPlanItem.Number = Convert.ToInt64(reader["Number"].ToString());
                            if (reader["IdSite"] != DBNull.Value)
                                actionPlanItem.IdSite = Convert.ToInt32(reader["IdSite"].ToString());
                            if (reader["IdCustomer"] != DBNull.Value)
                                actionPlanItem.IdGroup = Convert.ToInt32(reader["IdCustomer"].ToString());
                            if (reader["Title"] != DBNull.Value)
                                actionPlanItem.Title = Convert.ToString(reader["Title"].ToString());
                            if (reader["OpenDate"] != DBNull.Value)
                                actionPlanItem.OpenDate = Convert.ToDateTime(reader["OpenDate"].ToString());
                            if (reader["ExpectedDueDate"] != DBNull.Value)
                                actionPlanItem.ExpectedDueDate = Convert.ToDateTime(reader["ExpectedDueDate"].ToString());
                            if (reader["CurrentDueDate"] != DBNull.Value)
                                actionPlanItem.CurrentDueDate = Convert.ToDateTime(reader["CurrentDueDate"].ToString());
                            if (reader["DueDateChangeCount"] != DBNull.Value)
                                actionPlanItem.DueDateChangeCount = Convert.ToInt64(reader["DueDateChangeCount"].ToString());
                            if (reader["CloseDate"] != DBNull.Value)
                                actionPlanItem.CloseDate = Convert.ToDateTime(reader["CloseDate"].ToString());
                            if (reader["IdReporter"] != DBNull.Value)
                                actionPlanItem.IdReporter = Convert.ToInt32(reader["IdReporter"].ToString());
                            if (reader["IdAssignee"] != DBNull.Value)
                                actionPlanItem.IdAssignee = Convert.ToInt32(reader["IdAssignee"].ToString());
                            if (reader["IdStatus"] != DBNull.Value)
                                actionPlanItem.IdStatus = Convert.ToInt32(reader["IdStatus"].ToString());

                            if (reader["CreationDate"] != DBNull.Value)
                                actionPlanItem.CreationDate = Convert.ToDateTime(reader["CreationDate"].ToString());

                            if (reader["APIModificationDate"] != DBNull.Value)
                                actionPlanItem.ModificationDate = Convert.ToDateTime(reader["APIModificationDate"].ToString());

                            if (reader["Scope"] != DBNull.Value)
                                actionPlanItem.Scope = Convert.ToString(reader["Scope"].ToString());

                            if (reader["Reporter"] != DBNull.Value)
                                actionPlanItem.Reporter = Convert.ToString(reader["Reporter"].ToString());

                            if (reader["Assignee"] != DBNull.Value)
                                actionPlanItem.Assignee = Convert.ToString(reader["Assignee"].ToString());

                            if (reader["CustomerName"] != DBNull.Value)
                                actionPlanItem.Group = Convert.ToString(reader["CustomerName"].ToString());

                            if (reader["SiteName"] != DBNull.Value)
                                actionPlanItem.Plant = Convert.ToString(reader["SiteName"].ToString());

                            if (reader["Country"] != DBNull.Value)
                                actionPlanItem.Country = Convert.ToString(reader["Country"].ToString());

                            if (reader["IdStatus"] != DBNull.Value)
                            {
                                actionPlanItem.Status = new LookupValue();
                                actionPlanItem.IdStatus = Convert.ToInt32(reader["IdStatus"]);
                                actionPlanItem.Status.IdLookupValue = actionPlanItem.IdStatus;
                                actionPlanItem.Status.Value = Convert.ToString(reader["Status"].ToString());

                                if (reader["HtmlColor"] != DBNull.Value)
                                    actionPlanItem.Status.HtmlColor = Convert.ToString(reader["HtmlColor"]);
                            }

                            if (reader["creatorName"] != DBNull.Value)
                                actionPlanItem.Creator = Convert.ToString(reader["creatorName"].ToString());
                            if (reader["modifierName"] != DBNull.Value)
                                actionPlanItem.Modifier = Convert.ToString(reader["modifierName"].ToString());

                            actionPlanItem.ActionPlan.Code = string.Format("{0} - {1}", actionPlanItem.ActionPlan.Code, actionPlanItem.Number);
                            actionPlanItems.Add(actionPlanItem);
                        }

                    }

                    if (reader.NextResult())
                    {
                        while (reader.Read())
                        {


                            if (reader["IdActionPlanItem"] != DBNull.Value)
                                if (actionPlanItems.Any(ap => ap.IdActionPlanItem == Convert.ToInt64(reader["IdActionPlanItem"].ToString())))
                                {
                                    ActionPlanItem actionPlanItem = actionPlanItems.Where(ap => ap.IdActionPlanItem == Convert.ToInt64(reader["IdActionPlanItem"].ToString())).FirstOrDefault();

                                    LogEntriesByActionItem logEntriesByActionItem = new LogEntriesByActionItem();

                                    if (reader["IdLogEntriesByActionItem"] != DBNull.Value)
                                        logEntriesByActionItem.IdLogEntryByActionItem = Convert.ToInt64(reader["IdLogEntriesByActionItem"].ToString());

                                    if (reader["IdActionPlanItem"] != DBNull.Value)
                                        logEntriesByActionItem.IdActionPlanItem = Convert.ToInt64(reader["IdActionPlanItem"].ToString());
                                    if (reader["Comments"] != DBNull.Value)
                                        logEntriesByActionItem.Comment = Convert.ToString(reader["Comments"].ToString());
                                    if (reader["CreationDate"] != DBNull.Value)
                                        logEntriesByActionItem.CreationDate = Convert.ToDateTime(reader["CreationDate"].ToString());
                                    if (reader["IdCreator"] != DBNull.Value)
                                        logEntriesByActionItem.IdCreator = Convert.ToInt32(reader["IdCreator"].ToString());
                                    if (reader["ModificationDate"] != DBNull.Value)
                                        logEntriesByActionItem.ModificationDate = Convert.ToDateTime(reader["ModificationDate"].ToString());
                                    if (reader["IdModifier"] != DBNull.Value)
                                        logEntriesByActionItem.IdModifier = Convert.ToInt32(reader["IdModifier"].ToString());

                                    if (reader["creatorName"] != DBNull.Value)
                                        logEntriesByActionItem.Creator = Convert.ToString(reader["creatorName"].ToString());
                                    if (reader["modifierName"] != DBNull.Value)
                                        logEntriesByActionItem.Modifier = Convert.ToString(reader["modifierName"].ToString());
                                    if (reader["IsRtfText"] != DBNull.Value)
                                        logEntriesByActionItem.IsRtfText = Convert.ToBoolean(reader["IsRtfText"].ToString());
                                    if (reader["IdLogEntryType"] != DBNull.Value)
                                    {
                                        logEntriesByActionItem.IdLogEntryType = Convert.ToInt32(reader["IdLogEntryType"].ToString());
                                    }
                                    if (actionPlanItem.LogEntriesByActionItems != null)
                                        actionPlanItem.LogEntriesByActionItems.Add(logEntriesByActionItem);
                                    else
                                    {
                                        actionPlanItem.LogEntriesByActionItems = new List<LogEntriesByActionItem>();
                                        actionPlanItem.LogEntriesByActionItems.Add(logEntriesByActionItem);
                                    }
                                }

                        }

                    }
                }

            }
            return actionPlanItems;
        }

    }
}




